<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام إدارة المرضى - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- EmailJS for sending emails -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <style>
    :root {
      --primary-color: #0066CC;
      --primary-hover: #004499;
      --secondary-color: #00A8E8;
      --accent-color: #00C9A7;
      --danger-color: #FF6B6B;
      --warning-color: #FFD93D;
      --success-color: #6BCF7F;
      --dark-color: #2C3E50;
      --light-bg: #F0F8FF;
      --card-bg: #FFFFFF;
      --text-primary: #2C3E50;
      --text-secondary: #6C757D;
      --border-color: #E1E8ED;
      --shadow-sm: 0 2px 4px rgba(0, 102, 204, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 102, 204, 0.12);
      --shadow-lg: 0 8px 24px rgba(0, 102, 204, 0.16);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Cairo', sans-serif; 
      background: linear-gradient(135deg, #F0F8FF 0%, #E6F4F9 100%);
      min-height: 100vh;
      color: var(--text-primary);
    }
    
    /* Header Styles */
    .medical-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .medical-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,133.3C960,128,1056,96,1152,90.7C1248,85,1344,107,1392,117.3L1440,128L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path></svg>') no-repeat;
      background-size: cover;
      opacity: 0.3;
    }
    
    .logo-container {
      position: relative;
      z-index: 1;
    }
    
    .logo-badge {
      background: white;
      border-radius: 50%;
      padding: 3px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Card Styles */
    .medical-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    
    .medical-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .medical-card:hover::before {
      opacity: 1;
    }
    
    .medical-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Invoice Preview Styles */
    .invoice-preview {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px dashed #0066CC;
    }
    
    .invoice-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .status-paid {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    /* Stat Cards */
    .stat-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0,102,204,0.05) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .stat-card:hover::after {
      opacity: 1;
    }
    
    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-md);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }
    
    /* Buttons */
    .btn-medical {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-medical:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--primary-hover), var(--secondary-color));
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }
    
    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #4CAF50);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, #4CAF50, var(--success-color));
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #FF5252);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, #FF5252, var(--danger-color));
    }
    
    .btn-warning {
      background: linear-gradient(135deg, var(--warning-color), #FFC107);
      color: white;
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, #FFC107, var(--warning-color));
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
    }
    
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230066CC'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 12px center;
      background-size: 20px;
      padding-left: 40px;
    }
    
    /* Patient Cards */
    .patient-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .patient-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      border-radius: 4px 0 0 4px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .patient-card:hover::before {
      opacity: 1;
    }
    
    .patient-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }
    
    .patient-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
    }
    
    .patient-info {
      flex: 1;
    }
    
    .patient-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .patient-details {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .detail-item i {
      color: var(--primary-color);
    }
    
    /* Action Buttons */
    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      margin: 0 4px;
    }
    
    .action-btn:hover {
      transform: scale(1.1);
    }
    
    .btn-edit {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
    }
    
    .btn-edit:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-delete {
      background: rgba(255, 107, 107, 0.1);
      color: var(--danger-color);
    }
    
    .btn-delete:hover {
      background: var(--danger-color);
      color: white;
    }
    
    .btn-view {
      background: rgba(0, 201, 167, 0.1);
      color: var(--accent-color);
    }
    
    .btn-view:hover {
      background: var(--accent-color);
      color: white;
    }
    
    .btn-book {
      background: rgba(76, 175, 80, 0.1);
      color: var(--success-color);
    }
    
    .btn-book:hover {
      background: var(--success-color);
      color: white;
    }
    
    .btn-discharge {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    .btn-discharge:hover {
      background: var(--warning-color);
      color: white;
    }
    
    .btn-invoice {
      background: rgba(156, 39, 176, 0.1);
      color: #9C27B0;
    }
    
    .btn-invoice:hover {
      background: #9C27B0;
      color: white;
    }
    
    /* Search Box */
    .search-container {
      position: relative;
    }
    
    .search-input {
      padding-right: 44px;
      padding-left: 16px;
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Chart Container */
    .chart-wrapper {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-title i {
      color: var(--primary-color);
    }
    
    /* Department Badge */
    .dept-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .dept-emergency {
      background: rgba(255, 107, 107, 0.1);
      color: var(--danger-color);
    }
    
    .dept-icu {
      background: rgba(139, 92, 246, 0.1);
      color: #8B5CF6;
    }
    
    .dept-surgery {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
    }
    
    .dept-radiology {
      background: rgba(14, 165, 233, 0.1);
      color: #0EA5E9;
    }
    
    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .status-discharged {
      background: rgba(108, 117, 125, 0.1);
      color: var(--text-secondary);
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    /* Availability Badge */
    .availability-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .available {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .busy {
      background: rgba(255, 217, 61, 0.1);
      color: var(--warning-color);
    }
    
    .off-duty {
      background: rgba(108, 117, 125, 0.1);
      color: var(--text-secondary);
    }
    
    /* Tabs */
    .tabs-container {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
      overflow-x: auto;
    }
    
    .tab-btn {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-btn:hover {
      color: var(--primary-color);
    }
    
    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Time Slots */
    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    
    .time-slot {
      padding: 8px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .time-slot:hover {
      border-color: var(--primary-color);
      background: rgba(0, 102, 204, 0.05);
    }
    
    .time-slot.selected {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }
    
    .time-slot.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f5f5f5;
    }
    
    /* Current Time Display */
    .current-time {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .current-time h3 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    
    .current-time .time {
      font-size: 24px;
      font-weight: bold;
    }
    
    /* Doctor Availability Info */
    .doctor-availability-info {
      background: rgba(0, 102, 204, 0.05);
      border: 1px solid rgba(0, 102, 204, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .no-doctors-warning {
      background: rgba(255, 107, 107, 0.05);
      border: 1px solid rgba(255, 107, 107, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      text-align: center;
      color: var(--danger-color);
      font-size: 13px;
    }
    
    /* Invoice Table */
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }
    
    .invoice-table th,
    .invoice-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid var(--border-color);
    }
    
    .invoice-table th {
      background: rgba(0, 102, 204, 0.05);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .invoice-table tr:hover {
      background: rgba(0, 102, 204, 0.02);
    }
    
    /* Invoice Summary */
    .invoice-summary {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.05), rgba(0, 168, 232, 0.05));
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .summary-row:last-child {
      margin-bottom: 0;
      padding-top: 12px;
      border-top: 2px solid var(--primary-color);
      font-weight: bold;
      font-size: 18px;
    }
    
    /* Payment Methods */
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    
    .payment-method {
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .payment-method:hover {
      border-color: var(--primary-color);
      background: rgba(0, 102, 204, 0.05);
    }
    
    .payment-method.selected {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }
    
    .payment-method i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    /* Service Item */
    .service-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(0, 102, 204, 0.02);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }
    
    .service-item:hover {
      background: rgba(0, 102, 204, 0.05);
    }
    
    .service-info {
      flex: 1;
    }
    
    .service-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .service-details {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .service-price {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }
    
    .service-quantity {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 16px;
    }
    
    .quantity-btn {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .quantity-input {
      width: 40px;
      text-align: center;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 4px;
    }
    
    /* QR Code Container */
    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: white;
      border-radius: 12px;
      border: 2px dashed var(--border-color);
      margin: 16px 0;
    }
    
    .qr-container canvas {
      border: 4px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Payment History */
    .payment-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(0, 102, 204, 0.02);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .payment-amount {
      font-weight: bold;
      color: var(--success-color);
    }
    
    .payment-date {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    /* Installment Plan */
    .installment-plan {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.05), rgba(0, 168, 232, 0.05));
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
    }
    
    .installment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .installment-item:last-child {
      border-bottom: none;
    }
    
    .installment-status {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .installment-paid {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .installment-pending {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    /* Insurance Verification */
    .insurance-verification {
      background: rgba(0, 102, 204, 0.05);
      border: 1px solid rgba(0, 102, 204, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .insurance-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .insurance-valid {
      color: var(--success-color);
    }
    
    .insurance-invalid {
      color: var(--danger-color);
    }
    
    /* Financial Report */
    .report-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .report-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      text-align: center;
    }
    
    .report-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .report-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .stat-card {
        margin-bottom: 16px;
      }
      
      .patient-details {
        flex-direction: column;
        gap: 8px;
      }
      
      .tabs-container {
        overflow-x: scroll;
      }
      
      .time-slots {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
      
      .payment-methods {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Pulse Animation for New Items */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(0, 102, 204, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(0, 102, 204, 0);
      }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay hidden">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-lg font-semibold text-gray-700">جاري تحميل البيانات...</p>
    </div>
  </div>

  <!-- Medical Header -->
  <header class="medical-header text-white p-6">
    <div class="container mx-auto">
      <div class="flex justify-between items-center">
        <div class="logo-container flex items-center gap-4">
          <div class="logo-badge">
            <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" 
                 class="w-14 h-14 rounded-full" alt="شعار المستشفى">
          </div>
          <div>
            <h1 class="text-2xl font-bold">مستشفى الحياة الذكية</h1>
            <p class="text-sm opacity-90">نظام إدارة المرضى المتقدم</p>
          </div>
        </div>
        <div class="text-right">
          <div id="currentDate" class="text-sm opacity-90"></div>
          <div class="flex items-center gap-2 mt-2">
            <i class="fas fa-user-md"></i>
            <span class="text-sm">نظام الاستقبال</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Statistics Dashboard -->
    <section class="mb-8 fade-in">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(0, 102, 204, 0.1); color: var(--primary-color);">
            <i class="fas fa-users"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">إجمالي المرضى</h3>
          <div id="totalPatients" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-arrow-up text-green-500"></i> هذا الشهر
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(107, 207, 127, 0.1); color: var(--success-color);">
            <i class="fas fa-user-plus"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">المسجلين اليوم</h3>
          <div id="todayPatients" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-clock text-blue-500"></i> حتى الآن
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(255, 107, 107, 0.1); color: var(--danger-color);">
            <i class="fas fa-ambulance"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">حالات الطوارئ</h3>
          <div id="emergencyPatients" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-exclamation-triangle text-yellow-500"></i> نشط
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6;">
            <i class="fas fa-user-md"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">الأطباء المتاحون</h3>
          <div id="availableDoctors" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-clock text-blue-500"></i> الآن
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning-color);">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">إيرادات اليوم</h3>
          <div id="dailyRevenue" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-arrow-up text-green-500"></i> ج.م
          </div>
        </div>
      </div>
    </section>

    <!-- Charts Section -->
    <section class="mb-8 fade-in">
      <div class="chart-wrapper">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-chart-line text-blue-600"></i>
            التحليلات والإحصائيات الطبية
          </h2>
          <div class="flex gap-3 mt-4 lg:mt-0">
            <button id="printReportBtn" class="btn-medical">
              <i class="fas fa-print"></i>
              طباعة التقرير
            </button>
            <button id="exportPdfBtn" class="btn-medical btn-outline">
              <i class="fas fa-file-pdf"></i>
              تصدير PDF
            </button>
            <button id="financialReportBtn" class="btn-medical">
              <i class="fas fa-chart-pie"></i>
              تقرير مالي
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h3 class="chart-title">
              <i class="fas fa-hospital"></i>
              توزيع المرضى حسب الأقسام
            </h3>
            <div style="height: 250px;">
              <canvas id="departmentChart"></canvas>
            </div>
          </div>
          <div>
            <h3 class="chart-title">
              <i class="fas fa-calendar-day"></i>
              معدل التسجيل اليومي
            </h3>
            <div style="height: 250px;">
              <canvas id="dailyChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="mt-6">
          <h3 class="chart-title">
            <i class="fas fa-tint"></i>
            توزيع فصائل الدم
          </h3>
          <div style="height: 250px;">
            <canvas id="bloodTypeChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabs Navigation -->
    <div class="tabs-container mb-6">
      <button class="tab-btn active" data-tab="patients">
        <i class="fas fa-users"></i>
        المرضى
      </button>
      <button class="tab-btn" data-tab="appointments">
        <i class="fas fa-calendar-alt"></i>
        المواعيد
      </button>
      <button class="tab-btn" data-tab="doctors">
        <i class="fas fa-user-md"></i>
        الأطباء
      </button>
      <button class="tab-btn" data-tab="billing">
        <i class="fas fa-file-invoice-dollar"></i>
        الفواتير
      </button>
      <button class="tab-btn" data-tab="services">
        <i class="fas fa-concierge-bell"></i>
        الخدمات
      </button>
    </div>

    <!-- Tab Contents -->
    <div id="patientsTab" class="tab-content active">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Patient Registration Form -->
        <div class="lg:col-span-1 fade-in">
          <div class="medical-card p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center text-white">
                <i class="fas fa-user-plus"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">تسجيل مريض جديد</h2>
            </div>
            
            <form id="patientForm" class="space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user ml-1"></i>
                  اسم المريض الكامل
                </label>
                <input type="text" id="name" class="form-input" placeholder="أدخل اسم المريض" required />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-birthday-cake ml-1"></i>
                    العمر
                  </label>
                  <input type="number" id="age" min="0" max="120" class="form-input" placeholder="العمر" required />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-id-card ml-1"></i>
                    الرقم القومي
                  </label>
                  <input type="text" id="nid" maxlength="14" class="form-input" placeholder="14 رقم" required />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-venus-mars ml-1"></i>
                    الجنس
                  </label>
                  <select id="gender" class="form-input form-select" required>
                    <option value="">اختر</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tint ml-1"></i>
                    فصيلة الدم
                  </label>
                  <select id="bloodType" class="form-input form-select" required>
                    <option value="">اختر</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-phone ml-1"></i>
                  رقم الهاتف
                </label>
                <input type="tel" id="phone" class="form-input" placeholder="رقم الهاتف" />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-map-marker-alt ml-1"></i>
                  العنوان
                </label>
                <input type="text" id="address" class="form-input" placeholder="العنوان الكامل" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-notes-medical ml-1"></i>
                  الأمراض المزمنة / ملاحظات
                </label>
                <textarea id="diseases" rows="3" class="form-input" placeholder="أي أمراض مزمنة أو ملاحظات هامة"></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-hospital ml-1"></i>
                  القسم الطبي
                </label>
                <select id="department" class="form-input form-select" required>
                  <option value="">-- اختر القسم --</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="radiology">الأشعة</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="operations">العمليات</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user-md ml-1"></i>
                  الطبيب المعالج (المتاحين الآن)
                </label>
                <select id="doctorSelect" class="form-input form-select">
                  <option value="">-- اختر الطبيب --</option>
                </select>
                <div id="doctorAvailabilityInfo" class="doctor-availability-info">
                  <i class="fas fa-info-circle"></i>
                  يتم عرض الأطباء المتاحين في الوقت الحالي فقط
                </div>
                <div id="noDoctorsWarning" class="no-doctors-warning hidden">
                  <i class="fas fa-exclamation-triangle"></i>
                  لا يوجد أطباء متاحين حالياً. يمكنك ترك الحقل فارغاً أو المحاولة لاحقاً.
                </div>
              </div>

              <button type="submit" class="btn-medical w-full">
                <i class="fas fa-save"></i>
                تسجيل المريض
              </button>
            </form>
          </div>
        </div>

        <!-- Patients List -->
        <div class="lg:col-span-2 fade-in">
          <div class="medical-card p-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-list-ul text-blue-600"></i>
                قائمة المرضى المسجلين
              </h2>
              <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 lg:mt-0">
                <select id="filterDepartment" class="form-input form-select">
                  <option value="all">جميع الأقسام</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="surgery">العمليات</option>
                  <option value="care">الرعاية</option>
                  <option value="admin">الإدارة</option>
                  <option value="radiology">الأشعة</option>
                </select>
                <select id="filterStatus" class="form-input form-select">
                  <option value="all">جميع الحالات</option>
                  <option value="active">تحت العلاج</option>
                  <option value="discharged">تم الخروج</option>
                  <option value="pending">في انتظار الدفع</option>
                </select>
                <div class="search-container">
                  <input type="text" id="searchPatient" placeholder="بحث عن مريض..." class="form-input search-input" />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
            </div>
            
            <div id="patientsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Patients will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="appointmentsTab" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Appointment Booking Form -->
        <div class="lg:col-span-1 fade-in">
          <div class="medical-card p-6">
            <div class="current-time">
              <h3>الوقت الحالي</h3>
              <div class="time" id="currentTime">--:--:--</div>
            </div>
            
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-teal-500 flex items-center justify-center text-white">
                <i class="fas fa-calendar-plus"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">حجز موعد جديد</h2>
            </div>
            
            <form id="appointmentForm" class="space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user ml-1"></i>
                  اختر المريض
                </label>
                <select id="appointmentPatient" class="form-input form-select" required>
                  <option value="">-- اختر المريض --</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user-md ml-1"></i>
                  اختر الطبيب (المتاحين الآن)
                </label>
                <select id="appointmentDoctor" class="form-input form-select" required>
                  <option value="">-- اختر الطبيب --</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-calendar-day ml-1"></i>
                  التاريخ
                </label>
                <input type="date" id="appointmentDate" class="form-input" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-clock ml-1"></i>
                  اختر الوقت
                </label>
                <div class="time-slots" id="timeSlots">
                  <!-- Time slots will be generated dynamically -->
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-notes-medical ml-1"></i>
                  سبب الزيارة
                </label>
                <textarea id="appointmentReason" rows="3" class="form-input" placeholder="سبب الزيارة أو الأعراض"></textarea>
              </div>

              <button type="submit" class="btn-success w-full">
                <i class="fas fa-calendar-check"></i>
                حجز الموعد
              </button>
            </form>
          </div>
        </div>

        <!-- Available Doctors List -->
        <div class="lg:col-span-2 fade-in">
          <div class="medical-card p-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-user-md text-green-600"></i>
                الأطباء المتاحون الآن
              </h2>
              <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 lg:mt-0">
                <select id="filterDoctorSpecialization" class="form-input form-select">
                  <option value="all">جميع التخصصات</option>
                  <option value="طب الطوارئ">طب الطوارئ</option>
                  <option value="العناية المركزة">العناية المركزة</option>
                  <option value="جراحة عامة">جراحة عامة</option>
                  <option value="الأشعة التشخيصية">الأشعة التشخيصية</option>
                  <option value="طب القلب">طب القلب</option>
                  <option value="طب الأطفال">طب الأطفال</option>
                  <option value="النساء والتوليد">النساء والتوليد</option>
                </select>
                <div class="search-container">
                  <input type="text" id="searchDoctor" placeholder="بحث عن طبيب..." class="form-input search-input" />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
            </div>
            
            <div id="availableDoctorsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Available doctors will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="doctorsTab" class="tab-content">
      <div class="medical-card p-6">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-user-md text-blue-600"></i>
            قائمة الأطباء
          </h2>
          <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 lg:mt-0">
            <select id="filterDoctorDepartment" class="form-input form-select">
              <option value="all">جميع الأقسام</option>
              <option value="emergency">الطوارئ</option>
              <option value="icu">العناية المركزة</option>
              <option value="surgery">العمليات</option>
              <option value="care">الرعاية</option>
              <option value="admin">الإدارة</option>
              <option value="radiology">الأشعة</option>
            </select>
            <div class="search-container">
              <input type="text" id="searchDoctorAll" placeholder="بحث عن طبيب..." class="form-input search-input" />
              <i class="fas fa-search search-icon"></i>
            </div>
          </div>
        </div>
        
        <div id="doctorsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
          <!-- Doctors will be loaded here -->
        </div>
      </div>
    </div>

    <div id="billingTab" class="tab-content">
      <div class="medical-card p-6">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-file-invoice-dollar text-purple-600"></i>
            الفواتير والمحاسبة
          </h2>
          <div class="flex gap-3 mt-4 lg:mt-0">
            <button id="generateInvoiceBtn" class="btn-medical">
              <i class="fas fa-plus"></i>
              إنشاء فاتورة جديدة
            </button>
            <button id="printAllInvoicesBtn" class="btn-medical btn-outline">
              <i class="fas fa-print"></i>
              طباعة جميع الفواتير
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-purple-600" id="totalInvoices">0</div>
            <div class="text-sm text-gray-600">إجمالي الفواتير</div>
          </div>
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-green-600" id="paidInvoices">0</div>
            <div class="text-sm text-gray-600">الفواتير المدفوعة</div>
          </div>
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-orange-600" id="pendingInvoices">0</div>
            <div class="text-sm text-gray-600">الفواتير المعلقة</div>
          </div>
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-blue-600" id="totalRevenue">0</div>
            <div class="text-sm text-gray-600">إجمالي الإيرادات (ج.م)</div>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="invoice-table">
            <thead>
              <tr>
                <th>رقم الفاتورة</th>
                <th>اسم المريض</th>
                <th>التاريخ</th>
                <th>المبلغ الإجمالي</th>
                <th>المدفوع</th>
                <th>المتبقي</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody">
              <!-- Invoices will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="servicesTab" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Services Management -->
        <div class="lg:col-span-1 fade-in">
          <div class="medical-card p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white">
                <i class="fas fa-concierge-bell"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">إدارة الخدمات</h2>
            </div>
            
            <form id="serviceForm" class="space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tag ml-1"></i>
                  اسم الخدمة
                </label>
                <input type="text" id="serviceName" class="form-input" placeholder="أدخل اسم الخدمة" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-list ml-1"></i>
                  نوع الخدمة
                </label>
                <select id="serviceType" class="form-input form-select" required>
                  <option value="">-- اختر النوع --</option>
                  <option value="consultation">كشف طبي</option>
                  <option value="xray">أشعة</option>
                  <option value="lab">تحاليل</option>
                  <option value="ecg">موجات صوتية</option>
                  <option value="ultrasound">سونار</option>
                  <option value="surgery">عملية جراحية</option>
                  <option value="medication">أدوية</option>
                  <option value="other">أخرى</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-hospital ml-1"></i>
                  القسم
                </label>
                <select id="serviceDepartment" class="form-input form-select" required>
                  <option value="">-- اختر القسم --</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="radiology">الأشعة</option>
                  <option value="lab">المختبر</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="operations">العمليات</option>
                  <option value="cardiology">القلب</option>
                  <option value="general">داخلي</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-money-bill-wave ml-1"></i>
                  السعر (ج.م)
                </label>
                <input type="number" id="servicePrice" class="form-input" placeholder="أدخل السعر" min="0" step="0.01" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-info-circle ml-1"></i>
                  وصف الخدمة
                </label>
                <textarea id="serviceDescription" rows="3" class="form-input" placeholder="وصف تفصيلي للخدمة"></textarea>
              </div>

              <button type="submit" class="btn-medical w-full">
                <i class="fas fa-save"></i>
                إضافة الخدمة
              </button>
            </form>
          </div>
        </div>

        <!-- Services List -->
        <div class="lg:col-span-2 fade-in">
          <div class="medical-card p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-list text-purple-600"></i>
                قائمة الخدمات
              </h2>
              <div class="flex gap-3">
                <select id="filterServiceType" class="form-input form-select">
                  <option value="all">جميع الأنواع</option>
                  <option value="consultation">كشف طبي</option>
                  <option value="xray">أشعة</option>
                  <option value="lab">تحاليل</option>
                  <option value="ecg">موجات صوتية</option>
                  <option value="ultrasound">سونار</option>
                  <option value="surgery">عملية جراحية</option>
                  <option value="medication">أدوية</option>
                  <option value="other">أخرى</option>
                </select>
                <div class="search-container">
                  <input type="text" id="searchService" placeholder="بحث عن خدمة..." class="form-input search-input" />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
            </div>
            
            <div id="servicesList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Services will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
      <div class="modal-header bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">إنشاء فاتورة جديدة</h2>
          <button id="closeInvoiceModal" class="text-white hover:bg-white/20 p-2 rounded-full transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left Column - Patient & Basic Info -->
          <div class="lg:col-span-1 space-y-4">
            <!-- Patient Selection -->
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-user ml-1"></i>
                اختر المريض
              </label>
              <select id="invoicePatient" class="form-input form-select" required>
                <option value="">-- اختر المريض --</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-calendar ml-1"></i>
                تاريخ الفاتورة
              </label>
              <input type="date" id="invoiceDate" class="form-input" required />
            </div>

            <!-- Patient Type for Discount -->
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-user-tag ml-1"></i>
                نوع المريض
              </label>
              <select id="patientType" class="form-input form-select">
                <option value="returning">مريض عائد</option>
                <option value="new">مريض جديد</option>
                <option value="vip">VIP</option>
              </select>
            </div>

            <!-- Payment Method -->
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-credit-card ml-1"></i>
                طريقة الدفع
              </label>
              <div class="payment-methods">
                <div class="payment-method" data-method="cash">
                  <i class="fas fa-money-bill-wave"></i>
                  <span>نقدي</span>
                </div>
                <div class="payment-method" data-method="card">
                  <i class="fas fa-credit-card"></i>
                  <span>بطاقة</span>
                </div>
                <div class="payment-method" data-method="insurance">
                  <i class="fas fa-shield-alt"></i>
                  <span>تأمين</span>
                </div>
                <div class="payment-method" data-method="installment">
                  <i class="fas fa-calendar-alt"></i>
                  <span>تقسيط</span>
                </div>
              </div>
            </div>

            <!-- Insurance Details -->
            <div id="insuranceDetails" class="hidden space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-building ml-1"></i>
                  شركة التأمين
                </label>
                <select id="insuranceCompany" class="form-input form-select">
                  <option value="">-- اختر الشركة --</option>
                  <option value="مصر للتأمين">مصر للتأمين</option>
                  <option value="الأهلي">الأهلي</option>
                  <option value="التأمين الأهلي">التأمين الأهلي</option>
                  <option value="مصر للتأمين على الحياة">مصر للتأمين على الحياة</option>
                  <option value="أخرى">أخرى</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-id-card ml-1"></i>
                  رقم التأمين
                </label>
                <input type="text" id="insuranceNumber" class="form-input" placeholder="رقم بوليصة التأمين" />
              </div>
              
              <button type="button" id="verifyInsuranceBtn" class="btn-medical w-full">
                <i class="fas fa-check-circle"></i>
                تحقق من التأمين
              </button>
              
              <div id="insuranceVerification" class="insurance-verification hidden">
                <div class="insurance-status">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span>جاري التحقق...</span>
                </div>
              </div>
            </div>

            <!-- Installment Options -->
            <div id="installmentOptions" class="hidden space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-calendar-alt ml-1"></i>
                  خيارات التقسيط
                </label>
                <select id="installmentCount" class="form-input form-select">
                  <option value="3">3 أشهر</option>
                  <option value="6">6 أشهر</option>
                  <option value="12">12 شهر</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-percentage ml-1"></i>
                  نسبة الفائدة (%)
                </label>
                <input type="number" id="interestRate" class="form-input" value="10" min="0" max="50" />
              </div>
              
              <div class="installment-plan">
                <h4 class="font-semibold mb-2">خطة التقسيط:</h4>
                <div id="installmentPlanDetails">
                  <!-- Will be populated dynamically -->
                </div>
              </div>
            </div>
          </div>

          <!-- Middle Column - Services -->
          <div class="lg:col-span-1 space-y-4">
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-concierge-bell ml-1"></i>
                اختر الخدمات
              </label>
              <div id="servicesSelection" class="space-y-2 max-h-60 overflow-y-auto border rounded-lg p-4">
                <!-- Services will be loaded here -->
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-shopping-cart ml-1"></i>
                الخدمات المختارة
              </label>
              <div id="selectedServices" class="space-y-2 max-h-40 overflow-y-auto border rounded-lg p-4">
                <!-- Selected services will appear here -->
              </div>
            </div>

            <!-- Discount Information -->
            <div id="discountInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
              <h4 class="font-semibold text-blue-800 mb-2">
                <i class="fas fa-percentage"></i>
                الخصم التلقائي
              </h4>
              <div id="discountDetails" class="text-sm text-blue-700">
                <!-- Discount details will appear here -->
              </div>
            </div>
          </div>

          <!-- Right Column - Summary & Actions -->
          <div class="lg:col-span-1 space-y-4">
            <!-- Invoice Summary -->
            <div class="invoice-summary">
              <h4 class="font-semibold mb-4">ملخص الفاتورة</h4>
              <div class="summary-row">
                <span>المجموع الفرعي:</span>
                <span id="subtotal">0 ج.م</span>
              </div>
              <div class="summary-row" id="discountRow" style="display: none;">
                <span>الخصم:</span>
                <span id="discount" class="text-green-600">0 ج.م</span>
              </div>
              <div class="summary-row" id="coverageRow" style="display: none;">
                <span>تغطية التأمين:</span>
                <span id="coverage" class="text-blue-600">0 ج.م</span>
              </div>
              <div class="summary-row" id="interestRow" style="display: none;">
                <span>الفائدة:</span>
                <span id="interest" class="text-orange-600">0 ج.م</span>
              </div>
              <div class="summary-row font-bold text-lg border-t pt-2">
                <span>المبلغ الإجمالي:</span>
                <span id="totalAmount">0 ج.م</span>
              </div>
            </div>

            <!-- QR Code -->
            <div id="qrCodeContainer" class="qr-container hidden">
              <h4 class="font-semibold mb-2">رمز QR للفاتورة</h4>
              <div id="qrcode"></div>
              <button type="button" id="downloadQR" class="btn-medical mt-2">
                <i class="fas fa-download"></i>
                تحميل QR
              </button>
            </div>

            <!-- Payment History -->
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-receipt ml-1"></i>
                سجل المدفوعات
              </label>
              <div id="paymentHistory" class="space-y-2 max-h-40 overflow-y-auto border rounded-lg p-4">
                <p class="text-gray-500 text-center">لا توجد مدفوعات مسجلة</p>
              </div>
              <button type="button" id="addPaymentBtn" class="btn-medical mt-2 hidden">
                <i class="fas fa-plus"></i>
                إضافة دفعة
              </button>
            </div>

            <!-- Notes -->
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-sticky-note ml-1"></i>
                ملاحظات
              </label>
              <textarea id="invoiceNotes" rows="3" class="form-input" placeholder="أي ملاحظات إضافية"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-2">
              <button type="submit" id="saveInvoiceBtn" class="btn-success w-full">
                <i class="fas fa-save"></i>
                حفظ الفاتورة
              </button>
              <div class="grid grid-cols-2 gap-2">
                <button type="button" id="printInvoice" class="btn-outline">
                  <i class="fas fa-print"></i>
                  طباعة
                </button>
                <button type="button" id="emailInvoiceBtn" class="btn-outline">
                  <i class="fas fa-envelope"></i>
                  إرسال
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Discharge Modal -->
  <div id="dischargeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <div class="modal-header bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">تسجيل خروج المريض</h2>
          <button id="closeDischargeModal" class="text-white hover:bg-white/20 p-2 rounded-full transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <div id="dischargePatientInfo" class="mb-6 p-4 bg-gray-50 rounded-lg">
          <!-- Patient info will be loaded here -->
        </div>
        
        <form id="dischargeForm" class="space-y-6">
          <!-- Services for Discharge -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-concierge-bell ml-1"></i>
              الخدمات المستخدمة
            </label>
            <div id="dischargeServices" class="space-y-2 max-h-60 overflow-y-auto border rounded-lg p-4">
              <!-- Services will be loaded here -->
            </div>
          </div>
          
          <!-- Discharge Summary -->
          <div class="invoice-summary">
            <div class="summary-row">
              <span>المجموع الفرعي:</span>
              <span id="dischargeSubtotal">0 ج.م</span>
            </div>
            <div class="summary-row">
              <span>المبلغ الإجمالي:</span>
              <span id="dischargeTotal">0 ج.م</span>
            </div>
          </div>
          
          <!-- Discharge Notes -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-sticky-note ml-1"></i>
              ملاحظات الخروج
            </label>
            <textarea id="dischargeNotes" rows="3" class="form-input" placeholder="ملاحظات حول حالة المريض عند الخروج"></textarea>
          </div>
          
          <div class="flex gap-4">
            <button type="submit" class="btn-warning flex-1">
              <i class="fas fa-sign-out-alt"></i>
              تسجيل الخروج
            </button>
            <button type="button" id="createInvoiceFromDischarge" class="btn-success flex-1">
              <i class="fas fa-file-invoice"></i>
              إنشاء فاتورة
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Financial Report Modal -->
  <div id="financialReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
      <div class="modal-header bg-gradient-to-r from-green-600 to-teal-600 text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">التقرير المالي</h2>
          <button id="closeFinancialReport" class="text-white hover:bg-white/20 p-2 rounded-full transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <div class="mb-6">
          <label class="form-label">
            <i class="fas fa-calendar-alt ml-1"></i>
            اختر الفترة
          </label>
          <select id="reportPeriod" class="form-input form-select">
            <option value="1">آخر شهر</option>
            <option value="3">آخر 3 أشهر</option>
            <option value="6">آخر 6 أشهر</option>
            <option value="12">آخر سنة</option>
          </select>
        </div>

        <div id="financialReportContent">
          <!-- Report content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB4glqZb0hz1uvERtq0pSZZzeBy3_grAnQ",
      authDomain: "smart-life-hospital-ef64c.firebaseapp.com",
      databaseURL: "https://smart-life-hospital-ef64c-default-rtdb.firebaseio.com",
      projectId: "smart-life-hospital-ef64c",
      storageBucket: "smart-life-hospital-ef64c.firebasestorage.app",
      messagingSenderId: "851045891087",
      appId: "1:851045891087:web:8e0f6e42f8c7fed17bf77a",
      measurementId: "G-QE5BL3MTY7"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Initialize EmailJS
    (function() {
      emailjs.init("YOUR_PUBLIC_KEY"); // Replace with your EmailJS public key
    })();
    
    // DOM Elements
    const loadingElement = document.getElementById('loading');
    const currentDateElement = document.getElementById('currentDate');
    const currentTimeElement = document.getElementById('currentTime');
    const patientForm = document.getElementById('patientForm');
    const appointmentForm = document.getElementById('appointmentForm');
    const serviceForm = document.getElementById('serviceForm');
    const invoiceForm = document.getElementById('invoiceForm');
    const dischargeForm = document.getElementById('dischargeForm');
    const patientsList = document.getElementById('patientsList');
    const doctorsList = document.getElementById('doctorsList');
    const availableDoctorsList = document.getElementById('availableDoctorsList');
    const servicesList = document.getElementById('servicesList');
    const invoicesTableBody = document.getElementById('invoicesTableBody');
    const filterDepartment = document.getElementById('filterDepartment');
    const filterStatus = document.getElementById('filterStatus');
    const filterDoctorDepartment = document.getElementById('filterDoctorDepartment');
    const filterDoctorSpecialization = document.getElementById('filterDoctorSpecialization');
    const filterServiceType = document.getElementById('filterServiceType');
    const searchPatient = document.getElementById('searchPatient');
    const searchDoctor = document.getElementById('searchDoctor');
    const searchDoctorAll = document.getElementById('searchDoctorAll');
    const searchService = document.getElementById('searchService');
    const totalPatientsElement = document.getElementById('totalPatients');
    const todayPatientsElement = document.getElementById('todayPatients');
    const emergencyPatientsElement = document.getElementById('emergencyPatients');
    const availableDoctorsElement = document.getElementById('availableDoctors');
    const dailyRevenueElement = document.getElementById('dailyRevenue');
    const totalInvoicesElement = document.getElementById('totalInvoices');
    const paidInvoicesElement = document.getElementById('paidInvoices');
    const pendingInvoicesElement = document.getElementById('pendingInvoices');
    const totalRevenueElement = document.getElementById('totalRevenue');
    const printReportBtn = document.getElementById('printReportBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const financialReportBtn = document.getElementById('financialReportBtn');
    const doctorSelect = document.getElementById('doctorSelect');
    const appointmentDoctor = document.getElementById('appointmentDoctor');
    const appointmentPatient = document.getElementById('appointmentPatient');
    const appointmentDate = document.getElementById('appointmentDate');
    const timeSlots = document.getElementById('timeSlots');
    const doctorAvailabilityInfo = document.getElementById('doctorAvailabilityInfo');
    const noDoctorsWarning = document.getElementById('noDoctorsWarning');
    
    // Modal Elements
    const invoiceModal = document.getElementById('invoiceModal');
    const dischargeModal = document.getElementById('dischargeModal');
    const financialReportModal = document.getElementById('financialReportModal');
    const closeInvoiceModal = document.getElementById('closeInvoiceModal');
    const closeDischargeModal = document.getElementById('closeDischargeModal');
    const closeFinancialReport = document.getElementById('closeFinancialReport');
    const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');
    const printAllInvoicesBtn = document.getElementById('printAllInvoicesBtn');
    const printInvoice = document.getElementById('printInvoice');
    const emailInvoiceBtn = document.getElementById('emailInvoiceBtn');
    const createInvoiceFromDischarge = document.getElementById('createInvoiceFromDischarge');
    const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
    const verifyInsuranceBtn = document.getElementById('verifyInsuranceBtn');
    const addPaymentBtn = document.getElementById('addPaymentBtn');
    const downloadQR = document.getElementById('downloadQR');
    
    // Global Variables
    let currentPatientForDischarge = null;
    let currentPatientForInvoice = null;
    let selectedServices = new Map();
    let selectedPaymentMethod = null;
    let currentInvoiceData = null;
    let qrCodeInstance = null;
    let verifiedInsurance = null;
    
    // Display current date
    const today = new Date();
    currentDateElement.textContent = today.toLocaleDateString("ar-EG", {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
    
    // Update current time
    function updateCurrentTime() {
      const now = new Date();
      currentTimeElement.textContent = now.toLocaleTimeString("ar-EG", {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
    
    // Set minimum date for appointment to today
    appointmentDate.min = today.toISOString().split('T')[0];
    appointmentDate.value = today.toISOString().split('T')[0];
    
    // Show loading overlay
    function showLoading() {
      loadingElement.classList.remove('hidden');
    }
    
    // Hide loading overlay
    function hideLoading() {
      loadingElement.classList.add('hidden');
    }
    
    // Format date for display
    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString("ar-EG", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }
    
    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ar-EG', {
        style: 'currency',
        currency: 'EGP',
        minimumFractionDigits: 2
      }).format(amount);
    }
    
    // Generate invoice number
    function generateInvoiceNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `INV-${year}-${month}-${random}`;
    }
    
    // Check if doctor is available at current time
    function isDoctorAvailableNow(doctor) {
      if (!doctor.workFrom || !doctor.workTo) return false;
      
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      const workFrom = doctor.workFrom.split(':');
      const workTo = doctor.workTo.split(':');
      const workFromMinutes = parseInt(workFrom[0]) * 60 + parseInt(workFrom[1]);
      const workToMinutes = parseInt(workTo[0]) * 60 + parseInt(workTo[1]);
      
      return currentTime >= workFromMinutes && currentTime <= workToMinutes;
    }
    
    // Get doctor availability status
    function getDoctorAvailabilityStatus(doctor) {
      if (isDoctorAvailableNow(doctor)) {
        return { class: 'available', text: 'متاح الآن', icon: 'fa-check-circle' };
      } else if (doctor.workFrom && doctor.workTo) {
        return { class: 'off-duty', text: 'خارج الدوام', icon: 'fa-moon' };
      } else {
        return { class: 'busy', text: 'مشغول', icon: 'fa-clock' };
      }
    }
    
    // Calculate automatic discount
    function calculateDiscount(subtotal, patientType, services) {
      let discountPercentage = 0;
      let discountReasons = [];
      
      // Discount for new patients
      if (patientType === 'new') {
        discountPercentage += 5;
        discountReasons.push('خصم مريض جديد 5%');
      }
      
      // VIP patient discount
      if (patientType === 'vip') {
        discountPercentage += 10;
        discountReasons.push('خصم VIP 10%');
      }
      
      // Discount for large invoices
      if (subtotal > 1000) {
        discountPercentage += 5;
        discountReasons.push('خصم الفواتير الكبيرة 5%');
      }
      if (subtotal > 5000) {
        discountPercentage += 5;
        discountReasons.push('خصم الفواتير الكبيرة جداً 5%');
      }
      
      // Discount for special services
      const hasSurgery = services.some(s => s.type === 'surgery');
      if (hasSurgery) {
        discountPercentage += 3;
        discountReasons.push('خصم العمليات الجراحية 3%');
      }
      
      // Seasonal discounts (example: Ramadan discount)
      const ramadanStart = new Date('2024-03-11');
      const ramadanEnd = new Date('2024-04-09');
      const now = new Date();
      if (now >= ramadanStart && now <= ramadanEnd) {
        discountPercentage += 2;
        discountReasons.push('خصم رمضان 2%');
      }
      
      return {
        percentage: Math.min(discountPercentage, 30), // Max 30% discount
        amount: (subtotal * Math.min(discountPercentage, 30)) / 100,
        reasons: discountReasons
      };
    }
    
    // Generate QR Code for invoice
    function generateQRCode(invoiceData) {
      const qrContainer = document.getElementById('qrcode');
      qrContainer.innerHTML = '';
      
      const qrData = {
        invoiceNumber: invoiceData.invoiceNumber,
        patientName: invoiceData.patientName,
        totalAmount: invoiceData.totalAmount,
        date: invoiceData.date,
        paymentUrl: `https://your-payment-gateway.com/pay/${invoiceData.invoiceNumber}`
      };
      
      qrCodeInstance = new QRCode(qrContainer, {
        text: JSON.stringify(qrData),
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      document.getElementById('qrCodeContainer').classList.remove('hidden');
    }
    
    // Download QR Code
    downloadQR.addEventListener('click', () => {
      if (qrCodeInstance) {
        const canvas = document.querySelector('#qrcode canvas');
        const link = document.createElement('a');
        link.download = `QR-${currentInvoiceData.invoiceNumber}.png`;
        link.href = canvas.toDataURL();
        link.click();
      }
    });
    
    // Verify insurance
    verifyInsuranceBtn.addEventListener('click', async () => {
      const insuranceNumber = document.getElementById('insuranceNumber').value;
      const insuranceCompany = document.getElementById('insuranceCompany').value;
      
      if (!insuranceNumber || !insuranceCompany) {
        Swal.fire({
          icon: 'warning',
          title: 'بيانات ناقصة',
          text: 'يرجى إدخال رقم التأمين واختيار الشركة'
        });
        return;
      }
      
      const verificationDiv = document.getElementById('insuranceVerification');
      verificationDiv.classList.remove('hidden');
      verificationDiv.innerHTML = `
        <div class="insurance-status">
          <i class="fas fa-spinner fa-spin"></i>
          <span>جاري التحقق...</span>
        </div>
      `;
      
      // Simulate insurance verification
      setTimeout(() => {
        // Mock verification result
        const verificationResult = {
          valid: true,
          coveragePercentage: 80,
          maxCoverage: 10000,
          usedCoverage: 2000,
          remainingCoverage: 8000
        };
        
        verifiedInsurance = verificationResult;
        
        verificationDiv.innerHTML = `
          <div class="insurance-status insurance-valid">
            <i class="fas fa-check-circle"></i>
            <span>التأمين صالح</span>
          </div>
          <div class="mt-2 text-sm">
            <div>نسبة التغطية: ${verificationResult.coveragePercentage}%</div>
            <div>الحد الأقصى للتغطية: ${formatCurrency(verificationResult.maxCoverage)}</div>
            <div>المتبقي من التغطية: ${formatCurrency(verificationResult.remainingCoverage)}</div>
          </div>
        `;
        
        updateInvoiceSummary();
      }, 2000);
    });
    
    // Calculate installment plan
    function calculateInstallmentPlan(totalAmount, months, interestRate) {
      const monthlyInterest = interestRate / 100 / 12;
      const monthlyPayment = (totalAmount * monthlyInterest * Math.pow(1 + monthlyInterest, months)) / 
                            (Math.pow(1 + monthlyInterest, months) - 1);
      
      const plan = [];
      let remainingBalance = totalAmount;
      
      for (let i = 1; i <= months; i++) {
        const interestPayment = remainingBalance * monthlyInterest;
        const principalPayment = monthlyPayment - interestPayment;
        remainingBalance -= principalPayment;
        
        plan.push({
          month: i,
          payment: monthlyPayment,
          principal: principalPayment,
          interest: interestPayment,
          balance: Math.max(0, remainingBalance),
          dueDate: new Date(Date.now() + i * 30 * 24 * 60 * 60 * 1000)
        });
      }
      
      return plan;
    }
    
    // Update installment plan display
    function updateInstallmentPlan() {
      const installmentCount = parseInt(document.getElementById('installmentCount').value);
      const interestRate = parseFloat(document.getElementById('interestRate').value);
      const subtotal = Array.from(selectedServices.values()).reduce((sum, service) => 
        sum + (service.price * service.quantity), 0
      );
      
      const plan = calculateInstallmentPlan(subtotal, installmentCount, interestRate);
      const planDetails = document.getElementById('installmentPlanDetails');
      
      planDetails.innerHTML = plan.map(installment => `
        <div class="installment-item">
          <div>
            <div class="font-semibold">القسط ${installment.month}</div>
            <div class="text-xs text-gray-500">${formatDate(installment.dueDate)}</div>
          </div>
          <div class="text-left">
            <div class="font-semibold">${formatCurrency(installment.payment)}</div>
            <div class="text-xs text-gray-500">${installment.principal.toFixed(2)} + ${installment.interest.toFixed(2)}</div>
          </div>
        </div>
      `).join('');
    }
    
    // Send invoice via email
    function sendInvoiceViaEmail(invoiceData, patientEmail) {
      // This is a placeholder - you need to configure EmailJS
      emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
        to_email: patientEmail,
        invoice_number: invoiceData.invoiceNumber,
        patient_name: invoiceData.patientName,
        total_amount: formatCurrency(invoiceData.totalAmount),
        due_date: formatDate(invoiceData.date)
      }).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'تم الإرسال',
          text: 'تم إرسال الفاتورة عبر البريد الإلكتروني',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
      }).catch(() => {
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: 'فشل إرسال البريد الإلكتروني'
        });
      });
    }
    
    // Send invoice via WhatsApp
    function sendInvoiceViaWhatsApp(invoiceData, patientPhone) {
      const message = `فاتورة مستشفى الحياة الذكية\nرقم: ${invoiceData.invoiceNumber}\nالمريض: ${invoiceData.patientName}\nالمبلغ: ${formatCurrency(invoiceData.totalAmount)}\nالتاريخ: ${formatDate(invoiceData.date)}`;
      const whatsappUrl = `https://wa.me/2${patientPhone.replace(/^0+/, '')}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }
    
    // Generate financial report
    function generateFinancialReport(period) {
      const startDate = new Date();
      startDate.setMonth(startDate.getMonth() - period);
      
      showLoading();
      
      database.ref('invoices').orderByChild('date').startAt(startDate.toISOString()).once('value')
        .then((snapshot) => {
          const invoices = snapshot.val() || {};
          
          // Calculate statistics
          const totalRevenue = Object.values(invoices)
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
          
          const pendingRevenue = Object.values(invoices)
            .filter(inv => inv.status === 'pending')
            .reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
          
          const totalInvoices = Object.keys(invoices).length;
          const paidInvoices = Object.values(invoices).filter(inv => inv.status === 'paid').length;
          const pendingInvoices = Object.values(invoices).filter(inv => inv.status === 'pending').length;
          
          // Service statistics
          const serviceStats = {};
          Object.values(invoices).forEach(invoice => {
            if (invoice.services) {
              invoice.services.forEach(service => {
                if (!serviceStats[service.name]) {
                  serviceStats[service.name] = { count: 0, revenue: 0 };
                }
                serviceStats[service.name].count += service.quantity;
                serviceStats[service.name].revenue += service.price * service.quantity;
              });
            }
          });
          
          // Display report
          const reportContent = document.getElementById('financialReportContent');
          reportContent.innerHTML = `
            <div class="report-summary">
              <div class="report-card">
                <div class="report-value">${formatCurrency(totalRevenue)}</div>
                <div class="report-label">إجمالي الإيرادات</div>
              </div>
              <div class="report-card">
                <div class="report-value">${formatCurrency(pendingRevenue)}</div>
                <div class="report-label">الإيرادات المعلقة</div>
              </div>
              <div class="report-card">
                <div class="report-value">${totalInvoices}</div>
                <div class="report-label">إجمالي الفواتير</div>
              </div>
              <div class="report-card">
                <div class="report-value">${paidInvoices}</div>
                <div class="report-label">الفواتير المدفوعة</div>
              </div>
            </div>
            
            <div class="mt-6">
              <h3 class="text-lg font-semibold mb-4">أكثر الخدمات طلباً</h3>
              <div class="overflow-x-auto">
                <table class="invoice-table">
                  <thead>
                    <tr>
                      <th>الخدمة</th>
                      <th>عدد المرات</th>
                      <th>الإيرادات</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(serviceStats)
                      .sort((a, b) => b[1].revenue - a[1].revenue)
                      .slice(0, 10)
                      .map(([name, stats]) => `
                        <tr>
                          <td>${name}</td>
                          <td>${stats.count}</td>
                          <td>${formatCurrency(stats.revenue)}</td>
                        </tr>
                      `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
          
          hideLoading();
        });
    }
    
    // Load available doctors for patient form
    function loadAvailableDoctorsForPatientForm() {
      const doctorsRef = database.ref("doctors");
      
      doctorsRef.on('value', (snapshot) => {
        const doctors = snapshot.val() || {};
        
        doctorSelect.innerHTML = '<option value="">-- اختر الطبيب --</option>';
        
        const availableDoctors = Object.entries(doctors).filter(([_, doctor]) => 
          isDoctorAvailableNow(doctor)
        );
        
        if (availableDoctors.length === 0) {
          noDoctorsWarning.classList.remove('hidden');
          doctorAvailabilityInfo.style.display = 'none';
        } else {
          noDoctorsWarning.classList.add('hidden');
          doctorAvailabilityInfo.style.display = 'block';
          
          availableDoctors.forEach(([id, doctor]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `${doctor.name} - ${doctor.specialization}`;
            doctorSelect.appendChild(option);
          });
        }
      });
    }
    
    // Load doctors for appointment form
    function loadDoctorsForAppointmentForm() {
      const doctorsRef = database.ref("doctors");
      
      doctorsRef.on('value', (snapshot) => {
        const doctors = snapshot.val() || {};
        
        appointmentDoctor.innerHTML = '<option value="">-- اختر الطبيب --</option>';
        
        const availableDoctors = Object.entries(doctors).filter(([_, doctor]) => 
          isDoctorAvailableNow(doctor)
        );
        
        availableDoctors.forEach(([id, doctor]) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = `${doctor.name} - ${doctor.specialization}`;
          appointmentDoctor.appendChild(option);
        });
      });
    }
    
    // Load patients for forms
    function loadPatientsForForms() {
      const patientsRef = database.ref("patients");
      
      patientsRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        let allPatients = {};
        
        Object.entries(data).forEach(([dept, patients]) => {
          Object.entries(patients).forEach(([id, patient]) => {
            if (!allPatients[id]) {
              allPatients[id] = { ...patient, department: dept };
            }
          });
        });
        
        // Update appointment patient select
        appointmentPatient.innerHTML = '<option value="">-- اختر المريض --</option>';
        Object.entries(allPatients).forEach(([id, patient]) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = `${patient.name} - ${getDepartmentName(patient.department)}`;
          appointmentPatient.appendChild(option);
        });
        
        // Update invoice patient select
        const invoicePatient = document.getElementById('invoicePatient');
        if (invoicePatient) {
          invoicePatient.innerHTML = '<option value="">-- اختر المريض --</option>';
          Object.entries(allPatients).forEach(([id, patient]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `${patient.name} - ${patient.nid}`;
            invoicePatient.appendChild(option);
          });
        }
      });
    }
    
    // Load services
    function loadServices() {
      const servicesRef = database.ref("services");
      
      servicesRef.on('value', (snapshot) => {
        const services = snapshot.val() || {};
        
        if (Object.keys(services).length === 0) {
          addDefaultServices();
          return;
        }
        
        renderServices(services);
        loadServicesForSelection(services);
      });
    }
    
    // Add default services
    function addDefaultServices() {
      const defaultServices = [
        { name: "كشف طبيب عام", type: "consultation", department: "general", price: 150, description: "فحص عام وتشخيص" },
        { name: "أشعة صدرية", type: "xray", department: "radiology", price: 250, description: "أشعة على الصدر" },
        { name: "تحليل دم شامل", type: "lab", department: "lab", price: 200, description: "تحليل دم كامل" },
        { name: "موجات صوتية قلب", type: "ecg", department: "cardiology", price: 180, description: "تخطيط القلب الكهربائي" },
        { name: "سونار بطن", type: "ultrasound", department: "radiology", price: 300, description: "أشعة فوق صوتية على البطن" },
        { name: "عملية استئصال الزائدة الدودية", type: "surgery", department: "operations", price: 5000, description: "جراحة استئصال الزائدة الدودية" },
        { name: "مضادات حيوية", type: "medication", department: "general", price: 80, description: "مضادات حيوية واسعة الطيف" }
      ];
      
      defaultServices.forEach(service => {
        database.ref('services').push(service);
      });
    }
    
    // Render services list
    function renderServices(services, filter = 'all', searchTerm = '') {
      servicesList.innerHTML = '';
      
      let filteredServices = Object.entries(services);
      
      if (filter !== 'all') {
        filteredServices = filteredServices.filter(([_, service]) => service.type === filter);
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredServices = filteredServices.filter(([_, service]) => 
          service.name.toLowerCase().includes(term) || 
          service.description.toLowerCase().includes(term)
        );
      }
      
      if (filteredServices.length === 0) {
        servicesList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا توجد خدمات مطابقة</p>
          </div>
        `;
        return;
      }
      
      filteredServices.forEach(([id, service]) => {
        const serviceCard = createServiceCard(service, id);
        servicesList.appendChild(serviceCard);
      });
    }
    
    // Create service card
    function createServiceCard(service, id) {
      const card = document.createElement('div');
      card.className = 'service-item';
      
      const typeIcons = {
        consultation: 'fa-stethoscope',
        xray: 'fa-x-ray',
        lab: 'fa-vial',
        ecg: 'fa-heartbeat',
        ultrasound: 'fa-ultrasound',
        surgery: 'fa-procedures',
        medication: 'fa-pills',
        other: 'fa-medkit'
      };
      
      card.innerHTML = `
        <div class="service-info">
          <div class="service-name">${service.name}</div>
          <div class="service-details">${service.description}</div>
        </div>
        <div class="service-price">${formatCurrency(service.price)}</div>
        <div class="flex gap-2">
          <button class="action-btn btn-edit" onclick="editService('${id}', ${JSON.stringify(service).replace(/"/g, '&quot;')})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn btn-delete" onclick="deleteService('${id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      
      return card;
    }
    
    // Load services for selection in invoice
    function loadServicesForSelection(services) {
      const container = document.getElementById('servicesSelection');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(services).forEach(([id, service]) => {
        const serviceItem = document.createElement('div');
        serviceItem.className = 'flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50';
        
        serviceItem.innerHTML = `
          <div class="flex items-center gap-3">
            <input type="checkbox" id="service-${id}" value="${id}" class="w-4 h-4 text-blue-600">
            <label for="service-${id}" class="cursor-pointer">
              <div class="font-semibold">${service.name}</div>
              <div class="text-sm text-gray-500">${service.description}</div>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-blue-600">${formatCurrency(service.price)}</span>
            <input type="number" id="quantity-${id}" min="1" value="1" class="w-16 text-center border rounded px-2 py-1">
          </div>
        `;
        
        container.appendChild(serviceItem);
        
        // Add event listeners
        const checkbox = serviceItem.querySelector(`#service-${id}`);
        const quantityInput = serviceItem.querySelector(`#quantity-${id}`);
        
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedServices.set(id, {
              ...service,
              quantity: parseInt(quantityInput.value)
            });
            updateSelectedServices();
          } else {
            selectedServices.delete(id);
            updateSelectedServices();
          }
        });
        
        quantityInput.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedServices.set(id, {
              ...service,
              quantity: parseInt(quantityInput.value)
            });
            updateSelectedServices();
          }
        });
      });
    }
    
    // Update selected services display
    function updateSelectedServices() {
      const container = document.getElementById('selectedServices');
      if (!container) return;
      
      if (selectedServices.size === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">لم يتم اختيار أي خدمات بعد</p>';
        updateInvoiceSummary();
        return;
      }
      
      container.innerHTML = '';
      let subtotal = 0;
      
      selectedServices.forEach((service, id) => {
        const serviceItem = document.createElement('div');
        serviceItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        
        const total = service.price * service.quantity;
        subtotal += total;
        
        serviceItem.innerHTML = `
          <div>
            <div class="font-semibold">${service.name}</div>
            <div class="text-sm text-gray-500">${formatCurrency(service.price)} × ${service.quantity}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold">${formatCurrency(total)}</span>
            <button class="action-btn btn-delete" onclick="removeService('${id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        
        container.appendChild(serviceItem);
      });
      
      updateInvoiceSummary(subtotal);
    }
    
    // Remove service from selection
    function removeService(serviceId) {
      selectedServices.delete(serviceId);
      
      // Uncheck the checkbox
      const checkbox = document.getElementById(`service-${serviceId}`);
      if (checkbox) checkbox.checked = false;
      
      updateSelectedServices();
    }
    
    // Update invoice summary
    function updateInvoiceSummary(customSubtotal = null) {
      const subtotal = customSubtotal || Array.from(selectedServices.values()).reduce((sum, service) => 
        sum + (service.price * service.quantity), 0
      );
      
      const patientType = document.getElementById('patientType').value;
      const servicesArray = Array.from(selectedServices.values());
      
      // Calculate discount
      const discount = calculateDiscount(subtotal, patientType, servicesArray);
      
      // Calculate insurance coverage
      let coverage = 0;
      if (selectedPaymentMethod === 'insurance' && verifiedInsurance) {
        coverage = (subtotal * verifiedInsurance.coveragePercentage) / 100;
      }
      
      // Calculate installment interest
      let interest = 0;
      if (selectedPaymentMethod === 'installment') {
        const months = parseInt(document.getElementById('installmentCount').value);
        const interestRate = parseFloat(document.getElementById('interestRate').value);
        interest = (subtotal * interestRate * months) / 100 / 12;
      }
      
      const totalAmount = subtotal - discount.amount - coverage + interest;
      
      // Update display
      document.getElementById('subtotal').textContent = formatCurrency(subtotal);
      
      if (discount.amount > 0) {
        document.getElementById('discountRow').style.display = 'flex';
        document.getElementById('discount').textContent = formatCurrency(discount.amount);
        
        // Show discount info
        const discountInfo = document.getElementById('discountInfo');
        const discountDetails = document.getElementById('discountDetails');
        discountInfo.classList.remove('hidden');
        discountDetails.innerHTML = `
          <div>نسبة الخصم: ${discount.percentage}%</div>
          <div>مبلغ الخصم: ${formatCurrency(discount.amount)}</div>
          <div class="mt-2">الأسباب:</div>
          <ul class="list-disc list-inside">
            ${discount.reasons.map(reason => `<li>${reason}</li>`).join('')}
          </ul>
        `;
      } else {
        document.getElementById('discountRow').style.display = 'none';
        document.getElementById('discountInfo').classList.add('hidden');
      }
      
      if (coverage > 0) {
        document.getElementById('coverageRow').style.display = 'flex';
        document.getElementById('coverage').textContent = formatCurrency(coverage);
      } else {
        document.getElementById('coverageRow').style.display = 'none';
      }
      
      if (interest > 0) {
        document.getElementById('interestRow').style.display = 'flex';
        document.getElementById('interest').textContent = formatCurrency(interest);
      } else {
        document.getElementById('interestRow').style.display = 'none';
      }
      
      document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
      
      // Generate QR code
      if (currentInvoiceData) {
        currentInvoiceData.totalAmount = totalAmount;
        generateQRCode(currentInvoiceData);
      }
    }
    
    // Load invoices
    function loadInvoices() {
      const invoicesRef = database.ref("invoices");
      
      invoicesRef.on('value', (snapshot) => {
        const invoices = snapshot.val() || {};
        renderInvoices(invoices);
        updateInvoiceStats(invoices);
      });
    }
    
    // Render invoices table
    function renderInvoices(invoices) {
      invoicesTableBody.innerHTML = '';
      
      if (Object.keys(invoices).length === 0) {
        invoicesTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-8 text-gray-500">
              <i class="fas fa-file-invoice text-4xl mb-2 block"></i>
              لا توجد فواتير مسجلة
            </td>
          </tr>
        `;
        return;
      }
      
      Object.entries(invoices).forEach(([id, invoice]) => {
        const row = document.createElement('tr');
        
        const statusClass = invoice.status === 'paid' ? 'status-active' : 
                           invoice.status === 'pending' ? 'status-pending' : 'status-discharged';
        
        const statusText = invoice.status === 'paid' ? 'مدفوعة' : 
                          invoice.status === 'pending' ? 'معلقة' : 'ملغاة';
        
        row.innerHTML = `
          <td class="font-semibold">${invoice.invoiceNumber}</td>
          <td>${invoice.patientName}</td>
          <td>${formatDate(invoice.date)}</td>
          <td class="font-semibold">${formatCurrency(invoice.totalAmount)}</td>
          <td class="text-green-600">${formatCurrency(invoice.paidAmount || 0)}</td>
          <td class="text-orange-600">${formatCurrency((invoice.totalAmount || 0) - (invoice.paidAmount || 0))}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>
            <div class="flex gap-2">
              <button class="action-btn btn-view" onclick="viewInvoice('${id}', ${JSON.stringify(invoice).replace(/"/g, '&quot;')})">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn btn-invoice" onclick="printInvoiceById('${id}')">
                <i class="fas fa-print"></i>
              </button>
              ${invoice.status === 'pending' ? `
              <button class="action-btn btn-success" onclick="markAsPaid('${id}')">
                <i class="fas fa-check"></i>
              </button>
              ` : ''}
            </div>
          </td>
        `;
        
        invoicesTableBody.appendChild(row);
      });
    }
    
    // Update invoice statistics
    function updateInvoiceStats(invoices) {
      const invoicesArray = Object.values(invoices);
      
      const totalInvoices = invoicesArray.length;
      const paidInvoices = invoicesArray.filter(inv => inv.status === 'paid').length;
      const pendingInvoices = invoicesArray.filter(inv => inv.status === 'pending').length;
      const totalRevenue = invoicesArray
        .filter(inv => inv.status === 'paid')
        .reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
      
      const todayRevenue = invoicesArray
        .filter(inv => inv.status === 'paid' && new Date(inv.date).toDateString() === today.toDateString())
        .reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
      
      totalInvoicesElement.textContent = totalInvoices;
      paidInvoicesElement.textContent = paidInvoices;
      pendingInvoicesElement.textContent = pendingInvoices;
      totalRevenueElement.textContent = formatCurrency(totalRevenue);
      dailyRevenueElement.textContent = formatCurrency(todayRevenue);
    }
    
    // Generate time slots for appointment
    function generateTimeSlots(doctorId, date) {
      timeSlots.innerHTML = '';
      
      if (!doctorId || !date) return;
      
      database.ref(`doctors/${doctorId}`).once('value').then((snapshot) => {
        const doctor = snapshot.val();
        if (!doctor) return;
        
        const workFrom = doctor.workFrom || "09:00";
        const workTo = doctor.workTo || "17:00";
        
        const [fromHour, fromMinute] = workFrom.split(':').map(Number);
        const [toHour, toMinute] = workTo.split(':').map(Number);
        
        const startTime = new Date();
        startTime.setHours(fromHour, fromMinute, 0, 0);
        
        const endTime = new Date();
        endTime.setHours(toHour, toMinute, 0, 0);
        
        while (startTime < endTime) {
          const timeString = startTime.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          });
          
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          slot.textContent = timeString;
          slot.dataset.time = timeString;
          
          checkSlotAvailability(doctorId, date, timeString).then(isAvailable => {
            if (!isAvailable) {
              slot.classList.add('disabled');
            } else {
              slot.addEventListener('click', selectTimeSlot);
            }
          });
          
          timeSlots.appendChild(slot);
          startTime.setMinutes(startTime.getMinutes() + 30);
        }
      });
    }
    
    // Check if a time slot is available
    async function checkSlotAvailability(doctorId, date, time) {
      const snapshot = await database.ref('appointments').once('value');
      const appointments = snapshot.val() || {};
      
      for (const appointment of Object.values(appointments)) {
        if (appointment.doctorId === doctorId && 
            appointment.date === date && 
            appointment.time === time && 
            appointment.status !== 'cancelled') {
          return false;
        }
      }
      
      return true;
    }
    
    // Select time slot
    function selectTimeSlot(e) {
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
      });
      e.target.classList.add('selected');
    }
    
    // Create patient card
    function createPatientCard(patient, id, department) {
      const card = document.createElement('div');
      card.className = 'patient-card';
      
      const genderText = patient.gender === 'male' ? 'ذكر' : 'أنثى';
      const genderIcon = patient.gender === 'male' ? 'fa-mars' : 'fa-venus';
      const deptClass = `dept-${department}`;
      
      let doctorInfo = '';
      if (patient.doctorId) {
        doctorInfo = `
          <div class="detail-item">
            <i class="fas fa-user-md"></i>
            <span>الطبيب: ${patient.doctorName || 'غير محدد'}</span>
          </div>
        `;
      }
      
      let statusBadge = '';
      if (patient.status === 'discharged') {
        statusBadge = '<span class="status-badge status-discharged"><i class="fas fa-sign-out-alt"></i> تم الخروج</span>';
      } else if (patient.status === 'pending') {
        statusBadge = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> في انتظار الدفع</span>';
      } else {
        statusBadge = '<span class="status-badge status-active"><i class="fas fa-procedures"></i> تحت العلاج</span>';
      }
      
      card.innerHTML = `
        <div class="flex items-start gap-4">
          <div class="patient-avatar">
            ${patient.name.charAt(0).toUpperCase()}
          </div>
          <div class="patient-info flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="patient-name">${patient.name}</h3>
              <div class="flex gap-2">
                ${statusBadge}
                <span class="dept-badge ${deptClass}">
                  ${getDepartmentIcon(department)}
                  ${getDepartmentName(department)}
                </span>
              </div>
            </div>
            
            <div class="patient-details">
              <div class="detail-item">
                <i class="fas fa-id-card"></i>
                <span>${patient.nid}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-${genderIcon}"></i>
                <span>${genderText}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-birthday-cake"></i>
                <span>${patient.age} سنة</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-tint"></i>
                <span>${patient.bloodType}</span>
              </div>
              ${patient.phone ? `
              <div class="detail-item">
                <i class="fas fa-phone"></i>
                <span>${patient.phone}</span>
              </div>
              ` : ''}
              ${doctorInfo}
            </div>
            
            ${patient.diseases ? `
            <div class="mt-3 p-3 bg-gray-50 rounded-lg">
              <div class="detail-item mb-1">
                <i class="fas fa-notes-medical"></i>
                <span class="font-semibold">ملاحظات طبية:</span>
              </div>
              <p class="text-sm text-gray-600 pr-6">${patient.diseases}</p>
            </div>
            ` : ''}
            
            <div class="flex items-center justify-between mt-3">
              <div class="detail-item text-xs">
                <i class="fas fa-clock"></i>
                <span>${formatDate(patient.timestamp)}</span>
              </div>
              <div class="flex gap-2">
                <button class="action-btn btn-view" onclick="viewPatient('${id}', '${department}', ${JSON.stringify(patient).replace(/"/g, '&quot;')})">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn btn-edit" onclick="editPatient('${id}', '${department}', ${JSON.stringify(patient).replace(/"/g, '&quot;')})">
                  <i class="fas fa-edit"></i>
                </button>
                ${patient.status === 'active' ? `
                <button class="action-btn btn-discharge" onclick="dischargePatient('${id}', '${department}', ${JSON.stringify(patient).replace(/"/g, '&quot;')})">
                  <i class="fas fa-sign-out-alt"></i>
                </button>
                ` : ''}
                <button class="action-btn btn-delete" onclick="deletePatient('${id}', '${department}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }
    
    // Create doctor card
    function createDoctorCard(doctor, id, showAvailability = false) {
      const card = document.createElement('div');
      card.className = 'patient-card';
      
      const deptClass = `dept-${doctor.department}`;
      
      let availabilityBadge = '';
      if (showAvailability) {
        const status = getDoctorAvailabilityStatus(doctor);
        availabilityBadge = `
          <span class="availability-badge ${status.class}">
            <i class="fas ${status.icon}"></i>
            ${status.text}
          </span>
        `;
      }
      
      card.innerHTML = `
        <div class="flex items-start gap-4">
          <div class="patient-avatar">
            <i class="fas fa-user-md"></i>
          </div>
          <div class="patient-info flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="patient-name">د. ${doctor.name}</h3>
              <div class="flex gap-2">
                <span class="dept-badge ${deptClass}">
                  ${getDepartmentIcon(doctor.department)}
                  ${getDepartmentName(doctor.department)}
                </span>
                ${availabilityBadge}
              </div>
            </div>
            
            <div class="patient-details">
              <div class="detail-item">
                <i class="fas fa-stethoscope"></i>
                <span>${doctor.specialization}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>${doctor.workFrom || '--'} - ${doctor.workTo || '--'}</span>
              </div>
            </div>
            
            <div class="flex items-center justify-between mt-3">
              <div class="detail-item text-xs">
                <i class="fas fa-clock"></i>
                <span>${formatDate(doctor.timestamp)}</span>
              </div>
              <div class="flex gap-2">
                ${showAvailability && isDoctorAvailableNow(doctor) ? `
                <button class="action-btn btn-book" onclick="quickBookAppointment('${id}', '${doctor.name}')">
                  <i class="fas fa-calendar-plus"></i>
                </button>
                ` : ''}
                <button class="action-btn btn-edit" onclick="editDoctor('${id}', ${JSON.stringify(doctor).replace(/"/g, '&quot;')})">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn btn-delete" onclick="deleteDoctor('${id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }
    
    // Get department name
    function getDepartmentName(department) {
      const departments = {
        emergency: 'الطوارئ',
        icu: 'العناية المركزة',
        surgery: 'العمليات',
        care: 'الرعاية',
        admin: 'الإدارة',
        radiology: 'الأشعة',
        operations: 'العمليات'
      };
      return departments[department] || department;
    }
    
    // Get department icon
    function getDepartmentIcon(department) {
      const icons = {
        emergency: '<i class="fas fa-ambulance"></i>',
        icu: '<i class="fas fa-procedures"></i>',
        surgery: '<i class="fas fa-user-md"></i>',
        care: '<i class="fas fa-hand-holding-heart"></i>',
        admin: '<i class="fas fa-building"></i>',
        radiology: '<i class="fas fa-x-ray"></i>',
        operations: '<i class="fas fa-user-md"></i>'
      };
      return icons[department] || '<i class="fas fa-hospital"></i>';
    }
    
    // Render patients list
    function renderPatients(patients, filter = 'all', statusFilter = 'all', searchTerm = '') {
      patientsList.innerHTML = '';
      
      if (!patients) {
        patientsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-user-slash text-6xl text-gray-300 mb-4"></i>
            <p class="text
