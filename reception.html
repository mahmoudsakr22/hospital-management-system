
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة استقبال المرضى - مستشفى الحياة الذكية</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
body { font-family: 'Tajawal', sans-serif; }
.patient-card { transition: all 0.3s ease; }
.patient-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);}
</style>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-5xl">
<!-- نموذج تسجيل مريض جديد -->
<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-600 mb-8">
<h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-clipboard-list text-blue-600"></i> تسجيل مريض جديد</h2>
<form id="patientForm" class="space-y-4">
<div class="space-y-3">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">اسم المريض</label>
<input type="text" id="name" class="w-full border border-gray-300 rounded-md p-2" required />
</div>
<div class="grid grid-cols-2 gap-3">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">العمر</label>
<input type="number" id="age" min="0" max="120" class="w-full border border-gray-300 rounded-md p-2" required />
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">الرقم القومي</label>
<input type="text" id="nid" maxlength="14" class="w-full border border-gray-300 rounded-md p-2" required />
</div>
</div>
<div class="grid grid-cols-2 gap-3">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">الجنس</label>
<select id="gender" class="w-full border border-gray-300 rounded-md p-2" required>
<option value="">اختر الجنس</option>
<option value="male">ذكر</option>
<option value="female">أنثى</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">فصيلة الدم</label>
<select id="bloodType" class="w-full border border-gray-300 rounded-md p-2" required>
<option value="">اختر الفصيلة</option>
<option value="A+">A+</option>
<option value="A-">A-</option>
<option value="B+">B+</option>
<option value="B-">B-</option>
<option value="AB+">AB+</option>
<option value="AB-">AB-</option>
<option value="O+">O+</option>
<option value="O-">O-</option>
</select>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">العنوان</label>
<input type="text" id="address" class="w-full border border-gray-300 rounded-md p-2" required />
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">الأمراض المزمنة / ملاحظات</label>
<textarea id="diseases" rows="3" class="w-full border border-gray-300 rounded-md p-2"></textarea>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">القسم</label>
<select id="department" class="w-full border border-gray-300 rounded-md p-2" required>
<option value="">اختر القسم</option>
<option value="emergency">الطوارئ</option>
<option value="icu">العناية المركزة</option>
<option value="surgery">العمليات</option>
<option value="care">الرعاية</option>
<option value="admin">الإدارة</option>
<option value="radiology">الأشعة</option>
</select>
</div>
<!-- اختيار الطبيب سيضاف هنا ديناميكياً -->
</div>
<button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-md p-3 flex items-center justify-center gap-2">
<i class="fas fa-save"></i> تسجيل المريض
</button>
</form>
</div>

<!-- قائمة المرضى -->
<div id="patientsList" class="space-y-4"></div>
</div>

<script type="module">
// Firebase إعدادات
const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// عنصر اختيار الطبيب
const doctorSelectDiv = document.createElement('div');
doctorSelectDiv.id = "doctorSelectDiv";
doctorSelectDiv.className = "mt-2";
doctorSelectDiv.innerHTML = `
  <label class="block text-sm font-medium text-gray-700 mb-1">اختر الطبيب المناوب</label>
  <select id="doctorSelect" class="w-full border border-gray-300 rounded-md p-2" required>
    <option value="">اختر الطبيب</option>
  </select>
`;

// جلب الأطباء من قاعدة البيانات حسب القسم
async function fetchDoctorsByDepartment(department) {
  const doctorsRef = ref(db, "doctors");
  const snapshot = await get(doctorsRef);
  let filteredDoctors = [];
  if (snapshot.exists()) {
    const data = snapshot.val();
    Object.entries(data).forEach(([id, doc]) => {
      if (doc.department && doc.department.toLowerCase() === department.toLowerCase()) {
        filteredDoctors.push({ id, ...doc });
      }
    });
  }
  return filteredDoctors;
}

// تصفية الأطباء المتاحين الآن (بتوقيت القاهرة)
function getAvailableDoctorsNow(doctorsList) {
  const now = new Date();
  const cairoTime = new Date(now.toLocaleString('en-US', { timeZone: 'Africa/Cairo' }));
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const today = days[cairoTime.getDay()];
  const currentTime = cairoTime.toTimeString().slice(0,5); // "HH:MM"
  return doctorsList.filter(doc => {
    if (doc.manualStatus !== "online") return false;
    if (!doc.workDays || !doc.workDays.includes(today)) return false;
    if (doc.startTime === "00:00" && doc.endTime === "08:00") {
      return (currentTime >= "00:00" && currentTime < "08:00");
    }
    if (doc.startTime === "16:00" && doc.endTime === "00:00") {
      return (currentTime >= "16:00" && currentTime <= "23:59");
    }
    if (doc.startTime === "08:00" && doc.endTime === "16:00") {
      return (currentTime >= "08:00" && currentTime < "16:00");
    }
    return false;
  });
}

// تحديث قائمة الأطباء في الفورم
function updateDoctorSelect(availableDoctors) {
  const doctorSelect = doctorSelectDiv.querySelector("#doctorSelect");
  doctorSelect.innerHTML = `<option value="">اختر الطبيب</option>`;
  availableDoctors.forEach(doc => {
    doctorSelect.innerHTML += `<option value="${doc.name}">${doc.name} (${doc.shift})</option>`;
  });
  doctorSelect.required = true;
}

// إظهار أو إخفاء اختيار الطبيب حسب القسم
const departmentSelect = document.getElementById("department");
departmentSelect.addEventListener("change", async function() {
  const selectedDept = this.value;
  if (!selectedDept) {
    doctorSelectDiv.style.display = "none";
    if (document.getElementById("doctorSelectDiv")) {
      document.getElementById("doctorSelectDiv").remove();
    }
    return;
  }
  const doctorsList = await fetchDoctorsByDepartment(selectedDept);
  const availableDoctors = getAvailableDoctorsNow(doctorsList);
  if (availableDoctors.length > 0) {
    updateDoctorSelect(availableDoctors);
    if (!document.getElementById("doctorSelectDiv")) {
      this.parentNode.appendChild(doctorSelectDiv);
    }
    doctorSelectDiv.style.display = "block";
  } else {
    doctorSelectDiv.style.display = "none";
    if (document.getElementById("doctorSelectDiv")) {
      document.getElementById("doctorSelectDiv").remove();
    }
  }
});

// إرسال بيانات المريض
const patientForm = document.getElementById('patientForm');
patientForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = {
    name: document.getElementById("name").value.trim(),
    age: document.getElementById("age").value.trim(),
    nid: document.getElementById("nid").value.trim(),
    gender: document.getElementById("gender").value,
    address: document.getElementById("address").value.trim(),
    bloodType: document.getElementById("bloodType").value,
    diseases: document.getElementById("diseases").value.trim(),
    department: document.getElementById("department").value,
    doctor: (document.getElementById("doctorSelectDiv") && document.getElementById("doctorSelect") && document.getElementById("doctorSelect").value)
      ? document.getElementById("doctorSelect").value
      : "",
    timestamp: new Date().toISOString()
  };
  const patientsRef = ref(db, `patients/${formData.department}`);
  await push(patientsRef, formData);
  Swal.fire({icon: 'success', title: 'تم تسجيل المريض', timer: 1500, showConfirmButton: false});
  patientForm.reset();
  doctorSelectDiv.style.display = "none";
  if (document.getElementById("doctorSelectDiv")) {
    document.getElementById("doctorSelectDiv").remove();
  }
});

// عرض المرضى
const patientsList = document.getElementById('patientsList');
import { onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
onValue(ref(db, "patients"), (snapshot) => {
  const data = snapshot.val() || {};
  patientsList.innerHTML = '';
  Object.entries(data).forEach(([dept, patients]) => {
    Object.entries(patients).forEach(([id, patient]) => {
      patientsList.appendChild(createPatientCard(patient, id, dept));
    });
  });
});

// كارت المريض مع اسم الطبيب
function createPatientCard(patient, id, department) {
  const card = document.createElement('div');
  card.className = 'patient-card bg-white border rounded-lg shadow-sm p-4 mb-2';
  card.innerHTML = `
    <div class="flex flex-col md:flex-row md:items-between">
      <div class="flex-1">
        <h3 class="font-bold text-lg text-blue-800 mb-1">${patient.name}</h3>
        <div class="text-sm text-gray-600 mb-1"><i class="fas fa-hospital mr-1"></i> ${department}</div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mb-1">
          <div><i class="fas fa-birthday-cake text-gray-500 mr-1"></i>${patient.age} سنة</div>
          <div><i class="fas fa-id-card text-gray-500 mr-1"></i>${patient.nid}</div>
          <div><i class="fas fa-tint text-gray-500 mr-1"></i>${patient.bloodType}</div>
          <div><i class="fas fa-map-marker-alt text-gray-500 mr-1"></i>${patient.address}</div>
        </div>
        ${patient.doctor ? `<div class="mt-2 text-sm text-blue-700"><i class="fas fa-user-md mr-1"></i> الطبيب المناوب: <span class="font-bold">${patient.doctor}</span></div>` : ''}
        ${patient.diseases ? `<div class="mt-2 text-sm"><i class="fas fa-notes-medical mr-1"></i> ملاحظات: <span>${patient.diseases}</span></div>` : ''}
        <div class="mt-2 text-xs text-gray-500"><i class="fas fa-clock mr-1"></i> سجل في: ${new Date(patient.timestamp).toLocaleString("ar-EG")}</div>
      </div>
    </div>
  `;
  return card;
}
</script>
</body>
</html>
