<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
    body { font-family: 'Tajawal', sans-serif; }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
    }
    .stat-card {
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3 space-x-reverse">
        <div class="bg-white rounded-full p-1">
          <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" class="w-12 h-12 rounded-full" alt="شعار المستشفى">
        </div>
        <div>
          <h1 class="text-xl font-bold">مستشفى الحياة الذكية</h1>
          <p class="text-xs opacity-80">SMART HAYAT HOSPITAL</p>
        </div>
      </div>
      <div id="currentDate" class="text-sm"></div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- Stats Section -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow p-4 text-center stat-card">
        <i class="fas fa-users text-3xl text-blue-500 mb-2"></i>
        <h3 class="text-gray-500 text-sm">إجمالي المرضى</h3>
        <p id="totalPatients" class="text-2xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center stat-card">
        <i class="fas fa-user-plus text-3xl text-green-500 mb-2"></i>
        <h3 class="text-gray-500 text-sm">المسجلين اليوم</h3>
        <p id="todayPatients" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center stat-card">
        <i class="fas fa-ambulance text-3xl text-red-500 mb-2"></i>
        <h3 class="text-gray-500 text-sm">مرضى الطوارئ</h3>
        <p id="emergencyPatients" class="text-2xl font-bold text-red-600">0</p>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center stat-card">
        <i class="fas fa-procedures text-3xl text-purple-500 mb-2"></i>
        <h3 class="text-gray-500 text-sm">مرضى العمليات</h3>
        <p id="surgeryPatients" class="text-2xl font-bold text-purple-600">0</p>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Patient Form -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-lg p-5 card-hover">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-user-plus text-blue-500 ml-2"></i>
            تسجيل مريض جديد
          </h2>
          <form id="patientForm" class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">اسم المريض</label>
              <input type="text" id="name" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">العمر</label>
                <input type="number" id="age" min="0" max="120" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">الرقم القومي</label>
                <input type="text" id="nid" maxlength="14" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">الجنس</label>
                <select id="gender" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                  <option value="">اختر</option>
                  <option value="male">ذكر</option>
                  <option value="female">أنثى</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">فصيلة الدم</label>
                <select id="bloodType" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                  <option value="">اختر</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">العنوان</label>
              <input type="text" id="address" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">القسم</label>
              <select id="department" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <option value="">اختر القسم</option>
                <option value="emergency">الطوارئ</option>
                <option value="radiology">الأشعة</option>
                <option value="icu">العناية المركزة</option>
                <option value="surgery">العمليات</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات</label>
              <textarea id="diseases" rows="2" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
              <i class="fas fa-save ml-2"></i> حفظ البيانات
            </button>
          </form>
        </div>
      </div>

      <!-- Patients List & Charts -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Patients List -->
        <div class="bg-white rounded-xl shadow-lg p-5 card-hover">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold flex items-center">
              <i class="fas fa-list text-blue-500 ml-2"></i>
              قائمة المرضى
            </h2>
            <div class="flex space-x-2 space-x-reverse">
              <select id="filterDepartment" class="border rounded-lg p-2 text-sm">
                <option value="all">جميع الأقسام</option>
                <option value="emergency">الطوارئ</option>
                <option value="icu">العناية المركزة</option>
                <option value="surgery">العمليات</option>
                <option value="radiology">الأشعة</option>
              </select>
              <div class="relative">
                <input type="text" id="searchPatient" placeholder="بحث..." class="border rounded-lg p-2 pl-8 text-sm">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
            </div>
          </div>
          <div id="patientsList" class="max-h-96 overflow-y-auto">
            <!-- Patients will be loaded here -->
          </div>
        </div>

        <!-- Charts -->
        <div class="bg-white rounded-xl shadow-lg p-5 card-hover">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-chart-bar text-blue-500 ml-2"></i>
            الإحصائيات
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="h-64">
              <canvas id="departmentChart"></canvas>
            </div>
            <div class="h-64">
              <canvas id="bloodTypeChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCww7pM0clGr_Nk7Xe3pCnBUJtSaw6nS-k",
      authDomain: "smart-life-hospital.firebaseapp.com",
      databaseURL: "https://smart-life-hospital-default-rtdb.firebaseio.com",
      projectId: "smart-life-hospital",
      storageBucket: "smart-life-hospital.firebasestorage.app",
      messagingSenderId: "988240466536",
      appId: "1:988240466536:web:93e9f945b255cd164361dd",
      measurementId: "G-GEJF0F0ZJ7"
    };

    // Initialize Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, update, get, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const currentDateElement = document.getElementById('currentDate');
    const patientForm = document.getElementById('patientForm');
    const patientsList = document.getElementById('patientsList');
    const filterDepartment = document.getElementById('filterDepartment');
    const searchPatient = document.getElementById('searchPatient');
    const totalPatientsElement = document.getElementById('totalPatients');
    const todayPatientsElement = document.getElementById('todayPatients');
    const emergencyPatientsElement = document.getElementById('emergencyPatients');
    const surgeryPatientsElement = document.getElementById('surgeryPatients');

    // Display current date
    const today = new Date();
    currentDateElement.textContent = today.toLocaleDateString("ar-EG", {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    // Format date for display
    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString("ar-EG", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    // Generate sequential patient ID
    async function generatePatientID(department) {
      const counterRef = ref(db, `counters/${department}`);
      let newID;
      
      try {
        await runTransaction(db, async (transaction) => {
          const snapshot = await transaction.get(counterRef);
          let currentCount = 0;
          if (snapshot.exists()) {
            currentCount = snapshot.val().count;
          }
          const newCount = currentCount + 1;
          // Update counter
          transaction.set(counterRef, { count: newCount });
          // Format the new ID
          const formattedNumber = String(newCount).padStart(4, '0');
          newID = `PAT-${department.toUpperCase()}-${formattedNumber}`;
        });
      } catch (error) {
        console.error("Error generating patient ID:", error);
        throw error;
      }
      
      return newID;
    }

    // Create patient card
    function createPatientCard(patient, id, department) {
      const card = document.createElement('div');
      card.className = 'bg-gray-50 rounded-lg p-4 mb-3 border border-gray-200 hover:border-blue-300 transition-colors';
      
      const genderText = patient.gender === 'male' ? 'ذكر' : 'أنثى';
      const genderIcon = patient.gender === 'male' ? 'fa-mars' : 'fa-venus';
      
      const departmentInfo = getDepartmentInfo(department);
      
      card.innerHTML = `
        <div class="flex justify-between">
          <div class="flex-1">
            <div class="flex items-center mb-2">
              <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 ml-3">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <h3 class="font-bold text-lg">${patient.name}</h3>
                <div class="flex items-center text-sm text-gray-600">
                  <span class="ml-3"><i class="fas fa-id-card ml-1"></i> ${patient.patientID || id}</span>
                  <span><i class="fas fa-hospital ml-1"></i> ${departmentInfo.name}</span>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
              <div class="flex items-center">
                <i class="fas fa-birthday-cake text-gray-500 ml-1"></i>
                <span>${patient.age} سنة</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-${genderIcon} text-gray-500 ml-1"></i>
                <span>${genderText}</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-tint text-gray-500 ml-1"></i>
                <span>${patient.bloodType}</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-map-marker-alt text-gray-500 ml-1"></i>
                <span class="truncate">${patient.address}</span>
              </div>
            </div>
            
            ${patient.diseases ? `
            <div class="mt-2 text-sm">
              <div class="font-medium text-gray-700 mb-1">
                <i class="fas fa-notes-medical ml-1"></i> ملاحظات:
              </div>
              <p class="text-gray-600 bg-gray-100 p-2 rounded">${patient.diseases}</p>
            </div>
            ` : ''}
            
            <div class="mt-2 text-xs text-gray-500">
              <i class="fas fa-clock ml-1"></i> ${formatDate(patient.timestamp)}
            </div>
          </div>
          
          <div class="flex space-x-2 space-x-reverse">
            <button class="edit-btn bg-blue-100 text-blue-600 p-2 rounded-lg hover:bg-blue-200" data-id="${id}" data-dept="${department}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-btn bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200" data-id="${id}" data-dept="${department}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      // Add event listeners
      card.querySelector('.delete-btn').addEventListener('click', () => {
        deletePatient(id, department);
      });
      
      card.querySelector('.edit-btn').addEventListener('click', () => {
        editPatient(id, department, patient);
      });
      
      return card;
    }

    // Get department information
    function getDepartmentInfo(department) {
      const departments = {
        emergency: { name: 'الطوارئ', icon: 'fa-ambulance', color: 'red' },
        icu: { name: 'العناية المركزة', icon: 'fa-procedures', color: 'purple' },
        surgery: { name: 'العمليات', icon: 'fa-user-md', color: 'blue' },
        radiology: { name: 'الأشعة', icon: 'fa-x-ray', color: 'teal' }
      };
      
      return departments[department] || { name: department, icon: 'fa-hospital', color: 'blue' };
    }

    // Render patients list
    function renderPatients(patients, filter = 'all', searchTerm = '') {
      patientsList.innerHTML = '';
      
      if (!patients) {
        patientsList.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-user-slash text-4xl mb-3"></i>
            <p>لا يوجد مرضى</p>
          </div>
        `;
        return;
      }
      
      let filteredPatients = Object.entries(patients);
      
      // Apply department filter
      if (filter !== 'all') {
        filteredPatients = filteredPatients.filter(([_, patient]) => patient.department === filter);
      }
      
      // Apply search filter
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredPatients = filteredPatients.filter(([_, patient]) => 
          patient.name.toLowerCase().includes(term) || 
          patient.nid.includes(term) || 
          patient.address.toLowerCase().includes(term) ||
          (patient.patientID && patient.patientID.toLowerCase().includes(term))
        );
      }
      
      if (filteredPatients.length === 0) {
        patientsList.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-search text-4xl mb-3"></i>
            <p>لا يوجد مرضى يطابقون البحث</p>
          </div>
        `;
        return;
      }
      
      filteredPatients.forEach(([id, patient]) => {
        const department = patient.department || 'غير محدد';
        const card = createPatientCard(patient, id, department);
        patientsList.appendChild(card);
      });
    }

    // Delete patient
    function deletePatient(id, department) {
      Swal.fire({
        title: 'هل أنت متأكد؟',
        text: "لن تتمكن من استعادة هذا المريض بعد الحذف!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، احذفه!',
        cancelButtonText: 'إلغاء'
      }).then((result) => {
        if (result.isConfirmed) {
          const patientRef = ref(db, `patients/${department}/${id}`);
          remove(patientRef).then(() => {
            Swal.fire({
              icon: 'success',
              title: 'تم الحذف',
              text: 'تم حذف المريض بنجاح',
              timer: 1500,
              showConfirmButton: false
            });
          }).catch(() => {
            Swal.fire({
              icon: 'error',
              title: 'خطأ',
              text: 'حدث خطأ أثناء الحذف'
            });
          });
        }
      });
    }

    // Edit patient
    function editPatient(id, department, patient) {
      const editForm = document.createElement('form');
      editForm.className = 'space-y-4';
      
      editForm.innerHTML = `
        <h3 class="text-lg font-bold mb-2">تعديل بيانات المريض: ${patient.name}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">الاسم</label>
            <input type="text" id="edit-name" value="${patient.name}" class="w-full border border-gray-300 rounded-md p-2" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">العمر</label>
            <input type="number" id="edit-age" value="${patient.age}" class="w-full border border-gray-300 rounded-md p-2" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">الرقم القومي</label>
            <input type="text" id="edit-nid" value="${patient.nid}" class="w-full border border-gray-300 rounded-md p-2" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">الجنس</label>
            <select id="edit-gender" class="w-full border border-gray-300 rounded-md p-2" required>
              <option value="male" ${patient.gender === 'male' ? 'selected' : ''}>ذكر</option>
              <option value="female" ${patient.gender === 'female' ? 'selected' : ''}>أنثى</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">العنوان</label>
            <input type="text" id="edit-address" value="${patient.address}" class="w-full border border-gray-300 rounded-md p-2" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">فصيلة الدم</label>
            <select id="edit-bloodType" class="w-full border border-gray-300 rounded-md p-2" required>
              <option value="A+" ${patient.bloodType === 'A+' ? 'selected' : ''}>A+</option>
              <option value="A-" ${patient.bloodType === 'A-' ? 'selected' : ''}>A-</option>
              <option value="B+" ${patient.bloodType === 'B+' ? 'selected' : ''}>B+</option>
              <option value="B-" ${patient.bloodType === 'B-' ? 'selected' : ''}>B-</option>
              <option value="AB+" ${patient.bloodType === 'AB+' ? 'selected' : ''}>AB+</option>
              <option value="AB-" ${patient.bloodType === 'AB-' ? 'selected' : ''}>AB-</option>
              <option value="O+" ${patient.bloodType === 'O+' ? 'selected' : ''}>O+</option>
              <option value="O-" ${patient.bloodType === 'O-' ? 'selected' : ''}>O-</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات</label>
          <textarea id="edit-diseases" rows="3" class="w-full border border-gray-300 rounded-md p-2">${patient.diseases || ''}</textarea>
        </div>
      `;
      
      Swal.fire({
        title: 'تعديل بيانات المريض',
        html: editForm,
        showCancelButton: true,
        confirmButtonText: 'حفظ التعديلات',
        cancelButtonText: 'إلغاء',
        preConfirm: () => {
          const name = document.getElementById('edit-name').value.trim();
          const age = document.getElementById('edit-age').value.trim();
          const nid = document.getElementById('edit-nid').value.trim();
          const gender = document.getElementById('edit-gender').value;
          const address = document.getElementById('edit-address').value.trim();
          const bloodType = document.getElementById('edit-bloodType').value;
          
          if (!name || !age || !nid || !gender || !address || !bloodType) {
            Swal.showValidationMessage('يرجى ملء جميع الحقول الإلزامية');
            return false;
          }
          
          return {
            name, age, nid, gender, address, bloodType,
            diseases: document.getElementById('edit-diseases').value.trim()
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const updatedData = result.value;
          const patientRef = ref(db, `patients/${department}/${id}`);
          update(patientRef, {
            ...updatedData,
            timestamp: new Date().toISOString()
          }).then(() => {
            Swal.fire({
              icon: 'success',
              title: 'تم التحديث',
              text: 'تم تحديث بيانات المريض بنجاح',
              timer: 1500,
              showConfirmButton: false
            });
          }).catch(() => {
            Swal.fire({
              icon: 'error',
              title: 'خطأ',
              text: 'حدث خطأ أثناء التحديث'
            });
          });
        }
      });
    }

    // Update statistics
    function updateStats() {
      const todayDate = new Date().toDateString();
      let total = 0, today = 0, emergency = 0, surgery = 0;
      
      onValue(ref(db, "patients"), (snapshot) => {
        const data = snapshot.val() || {};
        
        Object.values(data).forEach(dept => {
          Object.values(dept).forEach(patient => {
            total++;
            if (new Date(patient.timestamp).toDateString() === todayDate) today++;
            if (patient.department === 'emergency') emergency++;
            if (patient.department === 'surgery') surgery++;
          });
        });
        
        totalPatientsElement.textContent = total;
        todayPatientsElement.textContent = today;
        emergencyPatientsElement.textContent = emergency;
        surgeryPatientsElement.textContent = surgery;
      });
    }

    // Initialize charts
    function initializeCharts() {
      // Department distribution chart
      const deptCtx = document.getElementById('departmentChart').getContext('2d');
      const deptChart = new Chart(deptCtx, {
        type: 'bar',
        data: {
          labels: ['الطوارئ', 'العناية المركزة', 'العمليات', 'الأشعة'],
          datasets: [{
            label: 'عدد المرضى',
            data: [0, 0, 0, 0],
            backgroundColor: [
              'rgba(239, 68, 68, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(59, 130, 246, 0.7)',
              'rgba(14, 165, 233, 0.7)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'توزيع المرضى حسب الأقسام'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Blood type distribution chart
      const bloodCtx = document.getElementById('bloodTypeChart').getContext('2d');
      const bloodChart = new Chart(bloodCtx, {
        type: 'doughnut',
        data: {
          labels: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'],
          datasets: [{
            data: [0, 0, 0, 0, 0, 0, 0, 0],
            backgroundColor: [
              'rgba(239, 68, 68, 0.7)',
              'rgba(239, 68, 68, 0.5)',
              'rgba(59, 130, 246, 0.7)',
              'rgba(59, 130, 246, 0.5)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(139, 92, 246, 0.5)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(16, 185, 129, 0.5)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            },
            title: {
              display: true,
              text: 'فصائل الدم'
            }
          }
        }
      });
      
      // Update charts with real data
      onValue(ref(db, "patients"), (snapshot) => {
        const data = snapshot.val() || {};
        const deptCounts = [0, 0, 0, 0]; // emergency, icu, surgery, radiology
        const bloodCounts = [0, 0, 0, 0, 0, 0, 0, 0]; // A+, A-, B+, B-, AB+, AB-, O+, O-
        
        Object.values(data).forEach(dept => {
          Object.values(dept).forEach(patient => {
            // Update department counts
            if (patient.department === 'emergency') deptCounts[0]++;
            else if (patient.department === 'icu') deptCounts[1]++;
            else if (patient.department === 'surgery') deptCounts[2]++;
            else if (patient.department === 'radiology') deptCounts[3]++;
            
            // Update blood type counts
            const bloodIndex = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'].indexOf(patient.bloodType);
            if (bloodIndex !== -1) bloodCounts[bloodIndex]++;
          });
        });
        
        // Update charts
        deptChart.data.datasets[0].data = deptCounts;
        deptChart.update();
        
        bloodChart.data.datasets[0].data = bloodCounts;
        bloodChart.update();
      });
    }

    // Form submission
    patientForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const formData = {
        name: document.getElementById("name").value.trim(),
        age: document.getElementById("age").value.trim(),
        nid: document.getElementById("nid").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        bloodType: document.getElementById("bloodType").value,
        diseases: document.getElementById("diseases").value.trim(),
        department: document.getElementById("department").value,
        timestamp: new Date().toISOString()
      };
      
      // Validation
      if (!formData.name || !formData.age || !formData.nid || !formData.gender || 
          !formData.address || !formData.bloodType || !formData.department) {
        Swal.fire({
          icon: 'warning',
          title: 'بيانات ناقصة',
          text: 'يرجى ملء جميع الحقول الإلزامية'
        });
        return;
      }
      
      try {
        // Generate sequential patient ID
        const patientID = await generatePatientID(formData.department);
        formData.patientID = patientID; // Add patient ID to form data
        
        // Save patient data with custom ID
        const patientRef = ref(db, `patients/${formData.department}/${patientID}`);
        await set(patientRef, formData);
        
        Swal.fire({
          icon: 'success',
          title: 'تم التسجيل',
          text: `تم تسجيل المريض ${formData.name} بنجاح`,
          timer: 1500,
          showConfirmButton: false
        });
        
        patientForm.reset();
      } catch (error) {
        console.error("Error registering patient:", error);
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: 'حدث خطأ أثناء التسجيل'
        });
      }
    });

    // Real-time data listeners
    function setupDataListeners() {
      // Patients list listener
      onValue(ref(db, "patients"), (snapshot) => {
        const data = snapshot.val() || {};
        const filter = filterDepartment.value;
        const searchTerm = searchPatient.value;
        
        let allPatients = {};
        Object.entries(data).forEach(([dept, patients]) => {
          Object.entries(patients).forEach(([id, patient]) => {
            if (!allPatients[id]) {
              allPatients[id] = { ...patient, department: dept };
            }
          });
        });
        
        renderPatients(allPatients, filter, searchTerm);
      });
      
      // Stats listener
      updateStats();
    }

    // Filter and search listeners
    filterDepartment.addEventListener('change', () => {
      const filter = filterDepartment.value;
      const searchTerm = searchPatient.value;
      
      onValue(ref(db, "patients"), (snapshot) => {
        const data = snapshot.val() || {};
        let allPatients = {};
        
        Object.entries(data).forEach(([dept, patients]) => {
          Object.entries(patients).forEach(([id, patient]) => {
            if (!allPatients[id]) {
              allPatients[id] = { ...patient, department: dept };
            }
          });
        });
        
        renderPatients(allPatients, filter, searchTerm);
      });
    });
    
    searchPatient.addEventListener('input', () => {
      const filter = filterDepartment.value;
      const searchTerm = searchPatient.value;
      
      onValue(ref(db, "patients"), (snapshot) => {
        const data = snapshot.val() || {};
        let allPatients = {};
        
        Object.entries(data).forEach(([dept, patients]) => {
          Object.entries(patients).forEach(([id, patient]) => {
            if (!allPatients[id]) {
              allPatients[id] = { ...patient, department: dept };
            }
          });
        });
        
        renderPatients(allPatients, filter, searchTerm);
      });
    });

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
      setupDataListeners();
      initializeCharts();
    });
  </script>
</body>
</html>
