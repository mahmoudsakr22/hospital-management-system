<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام إدارة المرضى - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0066CC;
      --primary-hover: #004499;
      --secondary-color: #00A8E8;
      --accent-color: #00C9A7;
      --danger-color: #FF6B6B;
      --warning-color: #FFD93D;
      --success-color: #6BCF7F;
      --dark-color: #2C3E50;
      --light-bg: #F0F8FF;
      --card-bg: #FFFFFF;
      --text-primary: #2C3E50;
      --text-secondary: #6C757D;
      --border-color: #E1E8ED;
      --shadow-sm: 0 2px 4px rgba(0, 102, 204, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 102, 204, 0.12);
      --shadow-lg: 0 8px 24px rgba(0, 102, 204, 0.16);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Cairo', sans-serif; 
      background: linear-gradient(135deg, #F0F8FF 0%, #E6F4F9 100%);
      min-height: 100vh;
      color: var(--text-primary);
    }
    
    /* Header Styles */
    .medical-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .medical-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,133.3C960,128,1056,96,1152,90.7C1248,85,1344,107,1392,117.3L1440,128L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path></svg>') no-repeat;
      background-size: cover;
      opacity: 0.3;
    }
    
    .logo-container {
      position: relative;
      z-index: 1;
    }
    
    .logo-badge {
      background: white;
      border-radius: 50%;
      padding: 3px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Card Styles */
    .medical-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    
    .medical-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .medical-card:hover::before {
      opacity: 1;
    }
    
    .medical-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Stat Cards */
    .stat-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0,102,204,0.05) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .stat-card:hover::after {
      opacity: 1;
    }
    
    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-md);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }
    
    /* Buttons */
    .btn-medical {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-medical:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--primary-hover), var(--secondary-color));
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }
    
    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #4CAF50);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, #4CAF50, var(--success-color));
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #FF5252);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, #FF5252, var(--danger-color));
    }
    
    .btn-warning {
      background: linear-gradient(135deg, var(--warning-color), #FFC107);
      color: white;
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, #FFC107, var(--warning-color));
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
    }
    
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230066CC'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 12px center;
      background-size: 20px;
      padding-left: 40px;
    }
    
    /* Patient Cards */
    .patient-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .patient-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      border-radius: 4px 0 0 4px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .patient-card:hover::before {
      opacity: 1;
    }
    
    .patient-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }
    
    .patient-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
    }
    
    .patient-info {
      flex: 1;
    }
    
    .patient-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .patient-details {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .detail-item i {
      color: var(--primary-color);
    }
    
    /* Action Buttons */
    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      margin: 0 4px;
    }
    
    .action-btn:hover {
      transform: scale(1.1);
    }
    
    .btn-edit {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
    }
    
    .btn-edit:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-delete {
      background: rgba(255, 107, 107, 0.1);
      color: var(--danger-color);
    }
    
    .btn-delete:hover {
      background: var(--danger-color);
      color: white;
    }
    
    .btn-view {
      background: rgba(0, 201, 167, 0.1);
      color: var(--accent-color);
    }
    
    .btn-view:hover {
      background: var(--accent-color);
      color: white;
    }
    
    .btn-book {
      background: rgba(76, 175, 80, 0.1);
      color: var(--success-color);
    }
    
    .btn-book:hover {
      background: var(--success-color);
      color: white;
    }
    
    .btn-discharge {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    .btn-discharge:hover {
      background: var(--warning-color);
      color: white;
    }
    
    .btn-invoice {
      background: rgba(156, 39, 176, 0.1);
      color: #9C27B0;
    }
    
    .btn-invoice:hover {
      background: #9C27B0;
      color: white;
    }
    
    /* Search Box */
    .search-container {
      position: relative;
    }
    
    .search-input {
      padding-right: 44px;
      padding-left: 16px;
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Connection Status */
    .connection-status {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      z-index: 1000;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
    }
    
    .connection-status.connected {
      background: linear-gradient(135deg, var(--success-color), #4CAF50);
      color: white;
    }
    
    .connection-status.disconnected {
      background: linear-gradient(135deg, var(--danger-color), #FF5252);
      color: white;
    }
    
    .connection-status.connecting {
      background: linear-gradient(135deg, var(--warning-color), #FFC107);
      color: white;
    }
    
    /* Chart Container */
    .chart-wrapper {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-title i {
      color: var(--primary-color);
    }
    
    /* Department Badge */
    .dept-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .dept-emergency {
      background: rgba(255, 107, 107, 0.1);
      color: var(--danger-color);
    }
    
    .dept-icu {
      background: rgba(139, 92, 246, 0.1);
      color: #8B5CF6;
    }
    
    .dept-surgery {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
    }
    
    .dept-radiology {
      background: rgba(14, 165, 233, 0.1);
      color: #0EA5E9;
    }
    
    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .status-discharged {
      background: rgba(108, 117, 125, 0.1);
      color: var(--text-secondary);
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    /* Availability Badge */
    .availability-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .available {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .busy {
      background: rgba(255, 217, 61, 0.1);
      color: var(--warning-color);
    }
    
    .off-duty {
      background: rgba(108, 117, 125, 0.1);
      color: var(--text-secondary);
    }
    
    /* Tabs */
    .tabs-container {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
      overflow-x: auto;
    }
    
    .tab-btn {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-btn:hover {
      color: var(--primary-color);
    }
    
    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Time Slots */
    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    
    .time-slot {
      padding: 8px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .time-slot:hover {
      border-color: var(--primary-color);
      background: rgba(0, 102, 204, 0.05);
    }
    
    .time-slot.selected {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }
    
    .time-slot.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f5f5f5;
    }
    
    /* Current Time Display */
    .current-time {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .current-time h3 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    
    .current-time .time {
      font-size: 24px;
      font-weight: bold;
    }
    
    /* Doctor Availability Info */
    .doctor-availability-info {
      background: rgba(0, 102, 204, 0.05);
      border: 1px solid rgba(0, 102, 204, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .no-doctors-warning {
      background: rgba(255, 107, 107, 0.05);
      border: 1px solid rgba(255, 107, 107, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      text-align: center;
      color: var(--danger-color);
      font-size: 13px;
    }
    
    /* Invoice Table */
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }
    
    .invoice-table th,
    .invoice-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid var(--border-color);
    }
    
    .invoice-table th {
      background: rgba(0, 102, 204, 0.05);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .invoice-table tr:hover {
      background: rgba(0, 102, 204, 0.02);
    }
    
    /* Invoice Summary */
    .invoice-summary {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.05), rgba(0, 168, 232, 0.05));
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .summary-row:last-child {
      margin-bottom: 0;
      padding-top: 12px;
      border-top: 2px solid var(--primary-color);
      font-weight: bold;
      font-size: 18px;
    }
    
    /* Payment Methods */
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    
    .payment-method {
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .payment-method:hover {
      border-color: var(--primary-color);
      background: rgba(0, 102, 204, 0.05);
    }
    
    .payment-method.selected {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }
    
    .payment-method i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    /* Service Item */
    .service-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(0, 102, 204, 0.02);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }
    
    .service-item:hover {
      background: rgba(0, 102, 204, 0.05);
    }
    
    .service-info {
      flex: 1;
    }
    
    .service-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .service-details {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .service-price {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }
    
    .service-quantity {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 16px;
    }
    
    .quantity-btn {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .quantity-input {
      width: 40px;
      text-align: center;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 4px;
    }
    
    /* Invoice Preview Styles */
    .invoice-preview {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px dashed #0066CC;
    }
    
    .invoice-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .status-paid {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    /* QR Code Container */
    .qr-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .qr-code {
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Installment Options */
    .installment-plan {
      background: rgba(0, 102, 204, 0.05);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .installment-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    
    .installment-item {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .installment-title {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 8px;
    }
    
    /* Payment History */
    .payment-history {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .payment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .payment-item:last-child {
      border-bottom: none;
    }
    
    .payment-date {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .payment-amount {
      font-weight: 600;
      color: var(--success-color);
    }
    
    /* Insurance Coverage Bar */
    .insurance-coverage {
      margin: 16px 0;
    }
    
    .coverage-bar {
      height: 24px;
      background: #e9ecef;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .coverage-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--success-color), #4CAF50);
      border-radius: 12px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }
    
    .coverage-info {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 14px;
    }
    
    /* Financial Report */
    .financial-report {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-md);
      margin-top: 24px;
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .report-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .report-period {
      display: flex;
      gap: 8px;
    }
    
    .period-btn {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .period-btn:hover {
      border-color: var(--primary-color);
      background: rgba(0, 102, 204, 0.05);
    }
    
    .period-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .report-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-item {
      background: rgba(0, 102, 204, 0.05);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .report-chart {
      height: 300px;
      margin-bottom: 24px;
    }
    
    .report-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    /* Modal Styles */
    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 24px;
      border-radius: 16px 16px 0 0;
    }
    
    .modal-header h2 {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .stat-card {
        margin-bottom: 16px;
      }
      
      .patient-details {
        flex-direction: column;
        gap: 8px;
      }
      
      .tabs-container {
        overflow-x: scroll;
      }
      
      .time-slots {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
      
      .payment-methods {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .invoice-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .installment-details {
        grid-template-columns: 1fr;
      }
      
      .connection-status {
        font-size: 12px;
        padding: 8px 16px;
      }
    }
    
    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Pulse Animation for New Items */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(0, 102, 204, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(0, 102, 204, 0);
      }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* Error Toast */
    .error-toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--danger-color), #FF5252);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Success Toast */
    .success-toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--success-color), #4CAF50);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <!-- Connection Status Indicator -->
  <div id="connectionStatus" class="connection-status connecting">
    <i class="fas fa-wifi"></i>
    <span id="connectionText">جاري الاتصال بقاعدة البيانات...</span>
  </div>

  <!-- Error Toast -->
  <div id="errorToast" class="error-toast">
    <i class="fas fa-exclamation-circle"></i>
    <span id="errorText"></span>
  </div>

  <!-- Success Toast -->
  <div id="successToast" class="success-toast">
    <i class="fas fa-check-circle"></i>
    <span id="successText"></span>
  </div>

  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay hidden">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-lg font-semibold text-gray-700">جاري تحميل البيانات...</p>
    </div>
  </div>

  <!-- Medical Header -->
  <header class="medical-header text-white p-6">
    <div class="container mx-auto">
      <div class="flex justify-between items-center">
        <div class="logo-container flex items-center gap-4">
          <div class="logo-badge">
            <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" 
                 class="w-14 h-14 rounded-full" alt="شعار المستشفى">
          </div>
          <div>
            <h1 class="text-2xl font-bold">مستشفى الحياة الذكية</h1>
            <p class="text-sm opacity-90">نظام إدارة المرضى المتقدم</p>
          </div>
        </div>
        <div class="text-right">
          <div id="currentDate" class="text-sm opacity-90"></div>
          <div class="flex items-center gap-2 mt-2">
            <i class="fas fa-user-md"></i>
            <span class="text-sm">نظام الاستقبال</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Statistics Dashboard -->
    <section class="mb-8 fade-in">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(0, 102, 204, 0.1); color: var(--primary-color);">
            <i class="fas fa-users"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">إجمالي المرضى</h3>
          <div id="totalPatients" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-arrow-up text-green-500"></i> هذا الشهر
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(107, 207, 127, 0.1); color: var(--success-color);">
            <i class="fas fa-user-plus"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">المسجلين اليوم</h3>
          <div id="todayPatients" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-clock text-blue-500"></i> حتى الآن
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(255, 107, 107, 0.1); color: var(--danger-color);">
            <i class="fas fa-ambulance"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">حالات الطوارئ</h3>
          <div id="emergencyPatients" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-exclamation-triangle text-yellow-500"></i> نشط
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6;">
            <i class="fas fa-user-md"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">الأطباء المتاحون</h3>
          <div id="availableDoctors" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-clock text-blue-500"></i> الآن
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning-color);">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">إيرادات اليوم</h3>
          <div id="dailyRevenue" class="text-3xl font-bold text-gray-800">0</div>
          <div class="text-xs text-gray-500 mt-2">
            <i class="fas fa-arrow-up text-green-500"></i> ج.م
          </div>
        </div>
      </div>
    </section>

    <!-- Charts Section -->
    <section class="mb-8 fade-in">
      <div class="chart-wrapper">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-chart-line text-blue-600"></i>
            التحليلات والإحصائيات الطبية
          </h2>
          <div class="flex gap-3 mt-4 lg:mt-0">
            <button id="printReportBtn" class="btn-medical">
              <i class="fas fa-print"></i>
              طباعة التقرير
            </button>
            <button id="exportPdfBtn" class="btn-medical btn-outline">
              <i class="fas fa-file-pdf"></i>
              تصدير PDF
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h3 class="chart-title">
              <i class="fas fa-hospital"></i>
              توزيع المرضى حسب الأقسام
            </h3>
            <div style="height: 250px;">
              <canvas id="departmentChart"></canvas>
            </div>
          </div>
          <div>
            <h3 class="chart-title">
              <i class="fas fa-calendar-day"></i>
              معدل التسجيل اليومي
            </h3>
            <div style="height: 250px;">
              <canvas id="dailyChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="mt-6">
          <h3 class="chart-title">
            <i class="fas fa-tint"></i>
            توزيع فصائل الدم
          </h3>
          <div style="height: 250px;">
            <canvas id="bloodTypeChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabs Navigation -->
    <div class="tabs-container mb-6">
      <button class="tab-btn active" data-tab="patients">
        <i class="fas fa-users"></i>
        المرضى
      </button>
      <button class="tab-btn" data-tab="appointments">
        <i class="fas fa-calendar-alt"></i>
        المواعيد
      </button>
      <button class="tab-btn" data-tab="doctors">
        <i class="fas fa-user-md"></i>
        الأطباء
      </button>
      <button class="tab-btn" data-tab="billing">
        <i class="fas fa-file-invoice-dollar"></i>
        الفواتير
      </button>
      <button class="tab-btn" data-tab="services">
        <i class="fas fa-concierge-bell"></i>
        الخدمات
      </button>
    </div>

    <!-- Tab Contents -->
    <div id="patientsTab" class="tab-content active">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Patient Registration Form -->
        <div class="lg:col-span-1 fade-in">
          <div class="medical-card p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center text-white">
                <i class="fas fa-user-plus"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">تسجيل مريض جديد</h2>
            </div>
            
            <form id="patientForm" class="space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user ml-1"></i>
                  اسم المريض الكامل
                </label>
                <input type="text" id="name" class="form-input" placeholder="أدخل اسم المريض" required />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-birthday-cake ml-1"></i>
                    العمر
                  </label>
                  <input type="number" id="age" min="0" max="120" class="form-input" placeholder="العمر" required />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-id-card ml-1"></i>
                    الرقم القومي
                  </label>
                  <input type="text" id="nid" maxlength="14" class="form-input" placeholder="14 رقم" required />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-venus-mars ml-1"></i>
                    الجنس
                  </label>
                  <select id="gender" class="form-input form-select" required>
                    <option value="">اختر</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tint ml-1"></i>
                    فصيلة الدم
                  </label>
                  <select id="bloodType" class="form-input form-select" required>
                    <option value="">اختر</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-phone ml-1"></i>
                    رقم الهاتف
                  </label>
                  <input type="tel" id="phone" class="form-input" placeholder="رقم الهاتف" required />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <i class="fab fa-whatsapp ml-1"></i>
                    رقم الواتساب
                  </label>
                  <input type="tel" id="whatsapp" class="form-input" placeholder="رقم الواتساب" />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-envelope ml-1"></i>
                  البريد الإلكتروني
                </label>
                <input type="email" id="email" class="form-input" placeholder="البريد الإلكتروني" />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-map-marker-alt ml-1"></i>
                  العنوان
                </label>
                <input type="text" id="address" class="form-input" placeholder="العنوان الكامل" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user-tag ml-1"></i>
                  نوع المريض
                </label>
                <select id="patientCategory" class="form-input form-select" required>
                  <option value="">-- اختر النوع --</option>
                  <option value="outpatient">مريض خارجي</option>
                  <option value="inpatient">مريض داخلي</option>
                  <option value="emergency">حالة طارئة</option>
                  <option value="daycare">علاج نهاري</option>
                  <option value="referred">محول من مستشفى آخر</option>
                  <option value="vip">مريض VIP</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-notes-medical ml-1"></i>
                  الأمراض المزمنة / ملاحظات
                </label>
                <textarea id="diseases" rows="3" class="form-input" placeholder="أي أمراض مزمنة أو ملاحظات هامة"></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-hospital ml-1"></i>
                  القسم الطبي
                </label>
                <select id="department" class="form-input form-select" required>
                  <option value="">-- اختر القسم --</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="radiology">الأشعة</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="operations">العمليات</option>
                  <option value="cardiology">القلب</option>
                  <option value="neurology">الأعصاب</option>
                  <option value="pediatrics">الأطفال</option>
                  <option value="obstetrics">النساء والتوليد</option>
                  <option value="orthopedics">العظام</option>
                  <option value="internal">الباطنة</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user-md ml-1"></i>
                  الطبيب المعالج (المتاحين الآن)
                </label>
                <select id="doctorSelect" class="form-input form-select">
                  <option value="">-- اختر الطبيب --</option>
                </select>
                <div id="doctorAvailabilityInfo" class="doctor-availability-info">
                  <i class="fas fa-info-circle"></i>
                  يتم عرض الأطباء المتاحين في الوقت الحالي فقط
                </div>
                <div id="noDoctorsWarning" class="no-doctors-warning hidden">
                  <i class="fas fa-exclamation-triangle"></i>
                  لا يوجد أطباء متاحين حالياً. يمكنك ترك الحقل فارغاً أو المحاولة لاحقاً.
                </div>
              </div>

              <button type="submit" class="btn-medical w-full">
                <i class="fas fa-save"></i>
                تسجيل المريض
              </button>
            </form>
          </div>
        </div>

        <!-- Patients List -->
        <div class="lg:col-span-2 fade-in">
          <div class="medical-card p-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-list-ul text-blue-600"></i>
                قائمة المرضى المسجلين
              </h2>
              <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 lg:mt-0">
                <select id="filterDepartment" class="form-input form-select">
                  <option value="all">جميع الأقسام</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="surgery">العمليات</option>
                  <option value="care">الرعاية</option>
                  <option value="admin">الإدارة</option>
                  <option value="radiology">الأشعة</option>
                </select>
                <select id="filterStatus" class="form-input form-select">
                  <option value="all">جميع الحالات</option>
                  <option value="active">تحت العلاج</option>
                  <option value="discharged">تم الخروج</option>
                  <option value="pending">في انتظار الدفع</option>
                </select>
                <div class="search-container">
                  <input type="text" id="searchPatient" placeholder="بحث عن مريض..." class="form-input search-input" />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
            </div>
            
            <div id="patientsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Patients will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="appointmentsTab" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Appointment Booking Form -->
        <div class="lg:col-span-1 fade-in">
          <div class="medical-card p-6">
            <div class="current-time">
              <h3>الوقت الحالي</h3>
              <div class="time" id="currentTime">--:--:--</div>
            </div>
            
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-teal-500 flex items-center justify-center text-white">
                <i class="fas fa-calendar-plus"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">حجز موعد جديد</h2>
            </div>
            
            <form id="appointmentForm" class="space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user ml-1"></i>
                  اختر المريض
                </label>
                <select id="appointmentPatient" class="form-input form-select" required>
                  <option value="">-- اختر المريض --</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user-md ml-1"></i>
                  اختر الطبيب (المتاحين الآن)
                </label>
                <select id="appointmentDoctor" class="form-input form-select" required>
                  <option value="">-- اختر الطبيب --</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-calendar-day ml-1"></i>
                  التاريخ
                </label>
                <input type="date" id="appointmentDate" class="form-input" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-clock ml-1"></i>
                  اختر الوقت
                </label>
                <div class="time-slots" id="timeSlots">
                  <!-- Time slots will be generated dynamically -->
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-notes-medical ml-1"></i>
                  سبب الزيارة
                </label>
                <textarea id="appointmentReason" rows="3" class="form-input" placeholder="سبب الزيارة أو الأعراض"></textarea>
              </div>

              <button type="submit" class="btn-success w-full">
                <i class="fas fa-calendar-check"></i>
                حجز الموعد
              </button>
            </form>
          </div>
        </div>

        <!-- Available Doctors List -->
        <div class="lg:col-span-2 fade-in">
          <div class="medical-card p-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-user-md text-green-600"></i>
                الأطباء المتاحون الآن
              </h2>
              <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 lg:mt-0">
                <select id="filterDoctorSpecialization" class="form-input form-select">
                  <option value="all">جميع التخصصات</option>
                  <option value="طب الطوارئ">طب الطوارئ</option>
                  <option value="العناية المركزة">العناية المركزة</option>
                  <option value="جراحة عامة">جراحة عامة</option>
                  <option value="الأشعة التشخيصية">الأشعة التشخيصية</option>
                  <option value="طب القلب">طب القلب</option>
                  <option value="طب الأطفال">طب الأطفال</option>
                  <option value="النساء والتوليد">النساء والتوليد</option>
                </select>
                <div class="search-container">
                  <input type="text" id="searchDoctor" placeholder="بحث عن طبيب..." class="form-input search-input" />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
            </div>
            
            <div id="availableDoctorsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Available doctors will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="doctorsTab" class="tab-content">
      <div class="medical-card p-6">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-user-md text-blue-600"></i>
            قائمة الأطباء
          </h2>
          <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 lg:mt-0">
            <select id="filterDoctorDepartment" class="form-input form-select">
              <option value="all">جميع الأقسام</option>
              <option value="emergency">الطوارئ</option>
              <option value="icu">العناية المركزة</option>
              <option value="surgery">العمليات</option>
              <option value="care">الرعاية</option>
              <option value="admin">الإدارة</option>
              <option value="radiology">الأشعة</option>
            </select>
            <div class="search-container">
              <input type="text" id="searchDoctorAll" placeholder="بحث عن طبيب..." class="form-input search-input" />
              <i class="fas fa-search search-icon"></i>
            </div>
          </div>
        </div>
        
        <div id="doctorsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
          <!-- Doctors will be loaded here -->
        </div>
      </div>
    </div>

    <div id="billingTab" class="tab-content">
      <div class="medical-card p-6">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-file-invoice-dollar text-purple-600"></i>
            الفواتير والمحاسبة
          </h2>
          <div class="flex gap-3 mt-4 lg:mt-0">
            <button id="generateInvoiceBtn" class="btn-medical">
              <i class="fas fa-plus"></i>
              إنشاء فاتورة جديدة
            </button>
            <button id="financialReportBtn" class="btn-medical">
              <i class="fas fa-chart-pie"></i>
              التقارير المالية
            </button>
            <button id="printAllInvoicesBtn" class="btn-medical btn-outline">
              <i class="fas fa-print"></i>
              طباعة جميع الفواتير
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-purple-600" id="totalInvoices">0</div>
            <div class="text-sm text-gray-600">إجمالي الفواتير</div>
          </div>
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-green-600" id="paidInvoices">0</div>
            <div class="text-sm text-gray-600">الفواتير المدفوعة</div>
          </div>
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-orange-600" id="pendingInvoices">0</div>
            <div class="text-sm text-gray-600">الفواتير المعلقة</div>
          </div>
          <div class="medical-card p-4 text-center">
            <div class="text-3xl font-bold text-blue-600" id="totalRevenue">0</div>
            <div class="text-sm text-gray-600">إجمالي الإيرادات (ج.م)</div>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="invoice-table">
            <thead>
              <tr>
                <th>رقم الفاتورة</th>
                <th>اسم المريض</th>
                <th>التاريخ</th>
                <th>المبلغ الإجمالي</th>
                <th>المدفوع</th>
                <th>المتبقي</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody">
              <!-- Invoices will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="servicesTab" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Services Management -->
        <div class="lg:col-span-1 fade-in">
          <div class="medical-card p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white">
                <i class="fas fa-concierge-bell"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">إدارة الخدمات</h2>
            </div>
            
            <form id="serviceForm" class="space-y-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tag ml-1"></i>
                  اسم الخدمة
                </label>
                <input type="text" id="serviceName" class="form-input" placeholder="أدخل اسم الخدمة" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-list ml-1"></i>
                  نوع الخدمة
                </label>
                <select id="serviceType" class="form-input form-select" required>
                  <option value="">-- اختر النوع --</option>
                  <option value="consultation">كشف طبي</option>
                  <option value="xray">أشعة</option>
                  <option value="lab">تحاليل</option>
                  <option value="ecg">موجات صوتية</option>
                  <option value="ultrasound">سونار</option>
                  <option value="ct">أشعة مقطعية</option>
                  <option value="mri">رنين مغناطيسي</option>
                  <option value="surgery">عملية جراحية</option>
                  <option value="medication">أدوية</option>
                  <option value="therapy">علاج طبيعي</option>
                  <option value="vaccination">تطعيمات</option>
                  <option value="checkup">فحص شامل</option>
                  <option value="other">أخرى</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-hospital ml-1"></i>
                  القسم
                </label>
                <select id="serviceDepartment" class="form-input form-select" required>
                  <option value="">-- اختر القسم --</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="radiology">الأشعة</option>
                  <option value="lab">المختبر</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="operations">العمليات</option>
                  <option value="cardiology">القلب</option>
                  <option value="neurology">الأعصاب</option>
                  <option value="pediatrics">الأطفال</option>
                  <option value="obstetrics">النساء والتوليد</option>
                  <option value="orthopedics">العظام</option>
                  <option value="internal">الباطنة</option>
                  <option value="ent">الأذن والأنف والحنجرة</option>
                  <option value="ophthalmology">العيون</option>
                  <option value="dermatology">الجلدية</option>
                  <option value="psychiatry">الطب النفسي</option>
                  <option value="physiotherapy">العلاج الطبيعي</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-money-bill-wave ml-1"></i>
                  السعر (ج.م)
                </label>
                <input type="number" id="servicePrice" class="form-input" placeholder="أدخل السعر" min="0" step="0.01" required />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-info-circle ml-1"></i>
                  وصف الخدمة
                </label>
                <textarea id="serviceDescription" rows="3" class="form-input" placeholder="وصف تفصيلي للخدمة"></textarea>
              </div>

              <button type="submit" class="btn-medical w-full">
                <i class="fas fa-save"></i>
                إضافة الخدمة
              </button>
            </form>
          </div>
        </div>

        <!-- Services List -->
        <div class="lg:col-span-2 fade-in">
          <div class="medical-card p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-list text-purple-600"></i>
                قائمة الخدمات
              </h2>
              <div class="flex gap-3">
                <select id="filterServiceType" class="form-input form-select">
                  <option value="all">جميع الأنواع</option>
                  <option value="consultation">كشف طبي</option>
                  <option value="xray">أشعة</option>
                  <option value="lab">تحاليل</option>
                  <option value="ecg">موجات صوتية</option>
                  <option value="ultrasound">سونار</option>
                  <option value="ct">أشعة مقطعية</option>
                  <option value="mri">رنين مغناطيسي</option>
                  <option value="surgery">عملية جراحية</option>
                  <option value="medication">أدوية</option>
                  <option value="therapy">علاج طبيعي</option>
                  <option value="vaccination">تطعيمات</option>
                  <option value="checkup">فحص شامل</option>
                  <option value="other">أخرى</option>
                </select>
                <div class="search-container">
                  <input type="text" id="searchService" placeholder="بحث عن خدمة..." class="form-input search-input" />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
            </div>
            
            <div id="servicesList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Services will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB4glqZb0hz1uvERtq0pSZZzeBy3_grAnQ",
      authDomain: "smart-life-hospital-ef64c.firebaseapp.com",
      databaseURL: "https://smart-life-hospital-ef64c-default-rtdb.firebaseio.com",
      projectId: "smart-life-hospital-ef64c",
      storageBucket: "smart-life-hospital-ef64c.firebasestorage.app",
      messagingSenderId: "851045891087",
      appId: "1:851045891087:web:8e0f6e42f8c7fed17bf77a",
      measurementId: "G-QE5BL3MTY7"
    };
    
    // Initialize Firebase
    let database;
    let connectionStatus = 'disconnected';
    
    try {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      console.log('✅ Firebase initialized successfully');
      
      // Test connection to Firebase
      testFirebaseConnection();
      
    } catch (error) {
      console.error('❌ Firebase initialization error:', error);
      showErrorToast('فشل في تهيئة Firebase: ' + error.message);
      updateConnectionStatus('disconnected', 'فشل الاتصال بقاعدة البيانات');
    }
    
    // Test Firebase connection
    function testFirebaseConnection() {
      updateConnectionStatus('connecting', 'جاري الاتصال بقاعدة البيانات...');
      
      // Test basic connectivity
      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          console.log('✅ Connected to Firebase Database');
          updateConnectionStatus('connected', 'متصل بقاعدة البيانات');
          connectionStatus = 'connected';
          
          // Test write permission
          testWritePermission();
          
        } else {
          console.log('❌ Disconnected from Firebase Database');
          updateConnectionStatus('disconnected', 'غير متصل بقاعدة البيانات');
          connectionStatus = 'disconnected';
        }
      });
      
      // Test read permission
      database.ref('test').once('value')
        .then(() => {
          console.log('✅ Read permission confirmed');
        })
        .catch((error) => {
          console.error('❌ Read permission error:', error);
          showErrorToast('خطأ في صلاحيات القراءة: ' + error.message);
        });
    }
    
    // Test write permission
    function testWritePermission() {
      const testData = {
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        test: true
      };
      
      database.ref('test_connection').set(testData)
        .then(() => {
          console.log('✅ Write permission confirmed');
          showSuccessToast('تم الاتصال بقاعدة البيانات بنجاح');
          
          // Clean up test data
          setTimeout(() => {
            database.ref('test_connection').remove();
          }, 2000);
        })
        .catch((error) => {
          console.error('❌ Write permission error:', error);
          showErrorToast('خطأ في صلاحيات الكتابة: ' + error.message);
        });
    }
    
    // Update connection status indicator
    function updateConnectionStatus(status, message) {
      const statusElement = document.getElementById('connectionStatus');
      const textElement = document.getElementById('connectionText');
      
      statusElement.className = `connection-status ${status}`;
      textElement.textContent = message;
      
      // Auto-hide success message after 3 seconds
      if (status === 'connected') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 3000);
      } else {
        statusElement.style.display = 'flex';
      }
    }
    
    // Show error toast
    function showErrorToast(message) {
      const toast = document.getElementById('errorToast');
      const textElement = document.getElementById('errorText');
      
      textElement.textContent = message;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 5000);
    }
    
    // Show success toast
    function showSuccessToast(message) {
      const toast = document.getElementById('successToast');
      const textElement = document.getElementById('successText');
      
      textElement.textContent = message;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
    
    // Enhanced database operations with error handling
    function safeDatabaseOperation(operation, path, data = null) {
      return new Promise((resolve, reject) => {
        if (connectionStatus !== 'connected') {
          reject(new Error('غير متصل بقاعدة البيانات'));
          return;
        }
        
        let ref = database.ref(path);
        
        switch (operation) {
          case 'set':
            ref.set(data)
              .then(() => resolve())
              .catch((error) => {
                console.error(`❌ Set operation failed at ${path}:`, error);
                reject(error);
              });
            break;
            
          case 'push':
            ref.push(data)
              .then((result) => resolve(result))
              .catch((error) => {
                console.error(`❌ Push operation failed at ${path}:`, error);
                reject(error);
              });
            break;
            
          case 'update':
            ref.update(data)
              .then(() => resolve())
              .catch((error) => {
                console.error(`❌ Update operation failed at ${path}:`, error);
                reject(error);
              });
            break;
            
          case 'remove':
            ref.remove()
              .then(() => resolve())
              .catch((error) => {
                console.error(`❌ Remove operation failed at ${path}:`, error);
                reject(error);
              });
            break;
            
          case 'once':
            ref.once('value')
              .then((snapshot) => resolve(snapshot))
              .catch((error) => {
                console.error(`❌ Once operation failed at ${path}:`, error);
                reject(error);
              });
            break;
            
          default:
            reject(new Error('Unknown operation'));
        }
      });
    }
    
    // DOM Elements
    const loadingElement = document.getElementById('loading');
    const currentDateElement = document.getElementById('currentDate');
    const currentTimeElement = document.getElementById('currentTime');
    const patientForm = document.getElementById('patientForm');
    const appointmentForm = document.getElementById('appointmentForm');
    const serviceForm = document.getElementById('serviceForm');
    const patientsList = document.getElementById('patientsList');
    const doctorsList = document.getElementById('doctorsList');
    const availableDoctorsList = document.getElementById('availableDoctorsList');
    const servicesList = document.getElementById('servicesList');
    const invoicesTableBody = document.getElementById('invoicesTableBody');
    const filterDepartment = document.getElementById('filterDepartment');
    const filterStatus = document.getElementById('filterStatus');
    const filterDoctorDepartment = document.getElementById('filterDoctorDepartment');
    const filterDoctorSpecialization = document.getElementById('filterDoctorSpecialization');
    const filterServiceType = document.getElementById('filterServiceType');
    const searchPatient = document.getElementById('searchPatient');
    const searchDoctor = document.getElementById('searchDoctor');
    const searchDoctorAll = document.getElementById('searchDoctorAll');
    const searchService = document.getElementById('searchService');
    const totalPatientsElement = document.getElementById('totalPatients');
    const todayPatientsElement = document.getElementById('todayPatients');
    const emergencyPatientsElement = document.getElementById('emergencyPatients');
    const availableDoctorsElement = document.getElementById('availableDoctors');
    const dailyRevenueElement = document.getElementById('dailyRevenue');
    const totalInvoicesElement = document.getElementById('totalInvoices');
    const paidInvoicesElement = document.getElementById('paidInvoices');
    const pendingInvoicesElement = document.getElementById('pendingInvoices');
    const totalRevenueElement = document.getElementById('totalRevenue');
    const printReportBtn = document.getElementById('printReportBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const doctorSelect = document.getElementById('doctorSelect');
    const appointmentDoctor = document.getElementById('appointmentDoctor');
    const appointmentPatient = document.getElementById('appointmentPatient');
    const appointmentDate = document.getElementById('appointmentDate');
    const timeSlots = document.getElementById('timeSlots');
    const doctorAvailabilityInfo = document.getElementById('doctorAvailabilityInfo');
    const noDoctorsWarning = document.getElementById('noDoctorsWarning');
    
    // Modal Elements
    const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');
    const financialReportBtn = document.getElementById('financialReportBtn');
    const printAllInvoicesBtn = document.getElementById('printAllInvoicesBtn');
    
    // Global Variables
    let currentPatientForDischarge = null;
    let currentPatientForInvoice = null;
    let selectedServices = new Map();
    let selectedPaymentMethod = null;
    let qrCodeInstance = null;
    let paymentHistory = [];
    let revenueChart = null;
    let paymentMethodsChart = null;
    
    // Display current date
    const today = new Date();
    currentDateElement.textContent = today.toLocaleDateString("ar-EG", {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
    
    // Update current time
    function updateCurrentTime() {
      const now = new Date();
      currentTimeElement.textContent = now.toLocaleTimeString("ar-EG", {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
    
    // Set minimum date for appointment to today
    appointmentDate.min = today.toISOString().split('T')[0];
    appointmentDate.value = today.toISOString().split('T')[0];
    
    // Show loading overlay
    function showLoading() {
      loadingElement.classList.remove('hidden');
    }
    
    // Hide loading overlay
    function hideLoading() {
      loadingElement.classList.add('hidden');
    }
    
    // Format date for display
    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString("ar-EG", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }
    
    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ar-EG', {
        style: 'currency',
        currency: 'EGP',
        minimumFractionDigits: 2
      }).format(amount);
    }
    
    // Generate invoice number
    function generateInvoiceNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `INV-${year}-${month}-${random}`;
    }
    
    // Check if doctor is available at current time
    function isDoctorAvailableNow(doctor) {
      if (!doctor.workFrom || !doctor.workTo) return false;
      
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      const workFrom = doctor.workFrom.split(':');
      const workTo = doctor.workTo.split(':');
      const workFromMinutes = parseInt(workFrom[0]) * 60 + parseInt(workFrom[1]);
      const workToMinutes = parseInt(workTo[0]) * 60 + parseInt(workTo[1]);
      
      return currentTime >= workFromMinutes && currentTime <= workToMinutes;
    }
    
    // Get doctor availability status
    function getDoctorAvailabilityStatus(doctor) {
      if (isDoctorAvailableNow(doctor)) {
        return { class: 'available', text: 'متاح الآن', icon: 'fa-check-circle' };
      } else if (doctor.workFrom && doctor.workTo) {
        return { class: 'off-duty', text: 'خارج الدوام', icon: 'fa-moon' };
      } else {
        return { class: 'busy', text: 'مشغول', icon: 'fa-clock' };
      }
    }
    
    // Load available doctors for patient form
    function loadAvailableDoctorsForPatientForm() {
      if (connectionStatus !== 'connected') {
        console.warn('Cannot load doctors: not connected to database');
        return;
      }
      
      safeDatabaseOperation('once', 'doctors')
        .then((snapshot) => {
          const doctors = snapshot.val() || {};
          
          doctorSelect.innerHTML = '<option value="">-- اختر الطبيب --</option>';
          
          const availableDoctors = Object.entries(doctors).filter(([_, doctor]) => 
            isDoctorAvailableNow(doctor)
          );
          
          if (availableDoctors.length === 0) {
            noDoctorsWarning.classList.remove('hidden');
            doctorAvailabilityInfo.style.display = 'none';
          } else {
            noDoctorsWarning.classList.add('hidden');
            doctorAvailabilityInfo.style.display = 'block';
            
            availableDoctors.forEach(([id, doctor]) => {
              const option = document.createElement("option");
              option.value = id;
              option.textContent = `${doctor.name} - ${doctor.specialization}`;
              doctorSelect.appendChild(option);
            });
          }
        })
        .catch((error) => {
          console.error('Error loading doctors:', error);
          showErrorToast('فشل في تحميل قائمة الأطباء');
        });
    }
    
    // Load doctors for appointment form
    function loadDoctorsForAppointmentForm() {
      if (connectionStatus !== 'connected') {
        console.warn('Cannot load doctors: not connected to database');
        return;
      }
      
      safeDatabaseOperation('once', 'doctors')
        .then((snapshot) => {
          const doctors = snapshot.val() || {};
          
          appointmentDoctor.innerHTML = '<option value="">-- اختر الطبيب --</option>';
          
          const availableDoctors = Object.entries(doctors).filter(([_, doctor]) => 
            isDoctorAvailableNow(doctor)
          );
          
          availableDoctors.forEach(([id, doctor]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `${doctor.name} - ${doctor.specialization}`;
            appointmentDoctor.appendChild(option);
          });
        })
        .catch((error) => {
          console.error('Error loading doctors:', error);
          showErrorToast('فشل في تحميل قائمة الأطباء');
        });
    }
    
    // Load patients for forms
    function loadPatientsForForms() {
      if (connectionStatus !== 'connected') {
        console.warn('Cannot load patients: not connected to database');
        return;
      }
      
      safeDatabaseOperation('once', 'patients')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          let allPatients = {};
          
          Object.entries(data).forEach(([dept, patients]) => {
            Object.entries(patients).forEach(([id, patient]) => {
              if (!allPatients[id]) {
                allPatients[id] = { ...patient, department: dept };
              }
            });
          });
          
          // Update appointment patient select
          appointmentPatient.innerHTML = '<option value="">-- اختر المريض --</option>';
          Object.entries(allPatients).forEach(([id, patient]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `${patient.name} - ${getDepartmentName(patient.department)}`;
            appointmentPatient.appendChild(option);
          });
        })
        .catch((error) => {
          console.error('Error loading patients:', error);
          showErrorToast('فشل في تحميل قائمة المرضى');
        });
    }
    
    // Load services
    function loadServices() {
      if (connectionStatus !== 'connected') {
        console.warn('Cannot load services: not connected to database');
        return;
      }
      
      safeDatabaseOperation('once', 'services')
        .then((snapshot) => {
          const services = snapshot.val() || {};
          
          if (Object.keys(services).length === 0) {
            addDefaultServices();
            return;
          }
          
          renderServices(services);
          loadServicesForSelection(services);
        })
        .catch((error) => {
          console.error('Error loading services:', error);
          showErrorToast('فشل في تحميل الخدمات');
        });
    }
    
    // Add default services
    function addDefaultServices() {
      const defaultServices = [
        // الكشوف الطبية
        { name: "كشف طبيب عام", type: "consultation", department: "internal", price: 150, description: "فحص عام وتشخيص" },
        { name: "كشف طبيب أطفال", type: "consultation", department: "pediatrics", price: 200, description: "فحص أطفال عام" },
        { name: "كشف طبيب قلب", type: "consultation", department: "cardiology", price: 300, description: "فحص قلب وأوعية دموية" },
        { name: "كشف طبيب أعصاب", type: "consultation", department: "neurology", price: 350, description: "فحص أعصاب" },
        { name: "كشف طبيب نساء وتوليد", type: "consultation", department: "obstetrics", price: 250, description: "فحص نساء وتوليد" },
        { name: "كشف طبيب عظام", type: "consultation", department: "orthopedics", price: 280, description: "فحص عظام ومفاصل" },
        { name: "كشف طبيب جلدية", type: "consultation", department: "dermatology", price: 200, description: "فحص جلدية" },
        { name: "كشف طبيب عيون", type: "consultation", department: "ophthalmology", price: 250, description: "فحص عيون" },
        { name: "كشف طبيب أنف وأذن وحنجرة", type: "consultation", department: "ent", price: 220, description: "فحص أنف وأذن وحنجرة" },
        { name: "كشف طبيب نفسي", type: "consultation", department: "psychiatry", price: 400, description: "استشارة نفسية" },
        
        // الأشعة والتشخيص
        { name: "أشعة صدرية (Chest X-ray)", type: "xray", department: "radiology", price: 250, description: "أشعة على الصدر" },
        { name: "أشعة على البطن", type: "xray", department: "radiology", price: 300, description: "أشعة على البطن" },
        { name: "أشعة على الأطراف", type: "xray", department: "radiology", price: 200, description: "أشعة على الذراع أو الساق" },
        { name: "أشعة على العمود الفقري", type: "xray", department: "radiology", price: 350, description: "أشعة على العمود الفقري" },
        { name: "أشعة مقطعية (CT Scan)", type: "ct", department: "radiology", price: 1500, description: "أشعة مقطعية على الرأس" },
        { name: "أشعة مقطعية على البطن", type: "ct", department: "radiology", price: 2000, description: "أشعة مقطعية على البطن" },
        { name: "رنين مغناطيسي (MRI)", type: "mri", department: "radiology", price: 3000, description: "رنين مغناطيسي على الرأس" },
        { name: "رنين مغناطيسي على العمود الفقري", type: "mri", department: "radiology", price: 3500, description: "رنين مغناطيسي على العمود الفقري" },
        { name: "سونار على البطن", type: "ultrasound", department: "radiology", price: 400, description: "أشعة فوق صوتية على البطن" },
        { name: "سونار على الحوض", type: "ultrasound", department: "radiology", price: 450, description: "أشعة فوق صوتية على الحوض" },
        { name: "سونار للقلب", type: "ultrasound", department: "cardiology", price: 600, description: "إيكو للقلب" },
        { name: "دوبلر دوبلر للأوعية", type: "ultrasound", department: "radiology", price: 500, description: "دوبلر دوبلر" },
        { name: "ماموجرام", type: "xray", department: "radiology", price: 800, description: "أشعة على الثدي" },
        
        // التحاليل الطبية
        { name: "تحليل دم شامل (CBC)", type: "lab", department: "lab", price: 150, description: "تحليل دم كامل" },
        { name: "تحليل كيمياء حيوية", type: "lab", department: "lab", price: 200, description: "وظائف الكبد والكلى" },
        { name: "تحليل سكر صائم", type: "lab", department: "lab", price: 50, description: "تحليل سكر صائم" },
        { name: "تحليل سكر عشوائي", type: "lab", department: "lab", price: 40, description: "تحليل سكر عشوائي" },
        { name: "تحليل الهيموجلوبين السكري", type: "lab", department: "lab", price: 80, description: "HbA1c" },
        { name: "تحليل الكوليسترول", type: "lab", department: "lab", price: 100, description: "بروفيل دهون" },
        { name: "تحليل وظائف الكلى", type: "lab", department: "lab", price: 120, description: "يوريا وكرياتينين" },
        { name: "تحليل وظائف الكبد", type: "lab", department: "lab", price: 150, description: "إنزيمات الكبد" },
        { name: "تحليل هرمونات الغدة الدرقية", type: "lab", department: "lab", price: 200, description: "T3, T4, TSH" },
        { name: "تحليل البروستاتا (PSA)", type: "lab", department: "lab", price: 180, description: "مستضاد البروستاتا" },
        { name: "تحليل فيتامين د", type: "lab", department: "lab", price: 150, description: "فيتامين D" },
        { name: "تحليل فيتامين ب12", type: "lab", department: "lab", price: 120, description: "فيتامين B12" },
        { name: "تحليل حديد", type: "lab", department: "lab", price: 100, description: "حديد، قدرة ارتباط، فيريتين" },
        { name: "تحليل بول", type: "lab", department: "lab", price: 50, description: "تحليل بول كامل" },
        { name: "مزرعة بول", type: "lab", department: "lab", price: 100, description: "مزرعة بول" },
        { name: "مزرعة براز", type: "lab", department: "lab", price: 120, description: "مزرعة براز" },
        { name: "تحليل الحساسية", type: "lab", department: "lab", price: 300, description: "تحليل حساسية شامل" },
        
        // الفحوصات والتشخيصات
        { name: "تخطيط القلب الكهربائي (ECG)", type: "ecg", department: "cardiology", price: 150, description: "تخطيط القلب الكهربائي" },
        { name: "تخطيط القلب بالمجهود", type: "ecg", department: "cardiology", price: 400, description: "تخطيط القلب بالمجهود" },
        { name: "هولتر 24 ساعة", type: "ecg", department: "cardiology", price: 800, description: "تسجيل قلب 24 ساعة" },
        { name: "قياس ضغط الدم 24 ساعة", type: "ecg", department: "cardiology", price: 600, description: "ABPM" },
        { name: "فحص الجهاز التنفسي", type: "checkup", department: "internal", price: 200, description: "فحص رئة" },
        { name: "فحص الجهاز الهضمي", type: "checkup", department: "internal", price: 250, description: "فحص جهاز هضمي" },
        { name: "فحص النساء", type: "checkup", department: "obstetrics", price: 500, description: "فحص نساء شامل" },
        { name: "فحص ما قبل الزواج", type: "checkup", department: "lab", price: 800, description: "فحص ما قبل الزواج" },
        { name: "فحص الشركات", type: "checkup", department: "internal", price: 1000, description: "فحص طبي للشركات" },
        { name: "فحص كبار السن", type: "checkup", department: "internal", price: 600, description: "فحص لكبار السن" },
        
        // العمليات الجراحية
        { name: "عملية استئصال الزائدة الدودية", type: "surgery", department: "operations", price: 5000, description: "جراحة استئصال الزائدة الدودية" },
        { name: "عملية استئصال المرارة", type: "surgery", department: "operations", price: 8000, description: "جراحة استئصال المرارة" },
        { name: "عملية فتق", type: "surgery", department: "operations", price: 6000, description: "جراحة إصلاح فتق" },
        { name: "عملية غدة البروستاتا", type: "surgery", department: "operations", price: 15000, description: "جراحة البروستاتا" },
        { name: "عملية قلب مفتوح", type: "surgery", department: "operations", price: 50000, description: "جراحة قلب مفتوح" },
        { name: "عملية استبدال مفصل الركبة", type: "surgery", department: "orthopedics", price: 25000, description: "جراحة استبدال مفصل الركبة" },
        { name: "عملية استبدال مفصل الورك", type: "surgery", department: "orthopedics", price: 30000, description: "جراحة استبدال مفصل الورك" },
        { name: "عملية ولادة قيصرية", type: "surgery", department: "obstetrics", price: 8000, description: "ولادة قيصرية" },
        { name: "عملية ولادة طبيعية", type: "surgery", department: "obstetrics", price: 5000, description: "ولادة طبيعية" },
        { name: "عملية تجميل الأنف", type: "surgery", department: "ent", price: 10000, description: "جراحة تجميل الأنف" },
        { name: "عملية استئصال اللوزتين", type: "surgery", department: "ent", price: 4000, description: "جراحة استئصال اللوزتين" },
        { name: "عملية ساد", type: "surgery", department: "ophthalmology", price: 8000, description: "جراحة الساد" },
        { name: "عملية الليزك", type: "surgery", department: "ophthalmology", price: 15000, description: "جراحة الليزك" },
        
        // العلاج الطبيعي والتأهيل
        { name: "جلسة علاج طبيعي", type: "therapy", department: "physiotherapy", price: 200, description: "جلسة علاج طبيعي واحدة" },
        { name: "باقة علاج طبيعي (10 جلسات)", type: "therapy", department: "physiotherapy", price: 1500, description: "10 جلسات علاج طبيعي" },
        { name: "علاج طبيعي بعد العمليات", type: "therapy", department: "physiotherapy", price: 250, description: "علاج طبيعي بعد العمليات" },
        { name: "علاج طبيعي للعمود الفقري", type: "therapy", department: "physiotherapy", price: 300, description: "علاج طبيعي للعمود الفقري" },
        { name: "علاج طبيعي للمفاصل", type: "therapy", department: "physiotherapy", price: 250, description: "علاج طبيعي للمفاصل" },
        { name: "علاج طبيعي للرياضيين", type: "therapy", department: "physiotherapy", price: 350, description: "علاج طبيعي للرياضيين" },
        
        // التطعيمات والمناعة
        { name: "تطعيم كوفيد-19", type: "vaccination", department: "internal", price: 100, description: "تطعيم كوفيد-19" },
        { name: "تطعيم الإنفلونزا", type: "vaccination", department: "internal", price: 150, description: "تطعيم الإنفلونزا الموسمي" },
        { name: "تطعيم التهاب الكبد B", type: "vaccination", department: "internal", price: 200, description: "تطعيم التهاب الكبد B" },
        { name: "تطعيم التيتانوس", type: "vaccination", department: "internal", price: 100, description: "تطعيم التيتانوس" },
        { name: "تطعيم شلل الأطفال", type: "vaccination", department: "pediatrics", price: 50, description: "تطعيم شلل الأطفال" },
        { name: "تطعيم الثلاثي", type: "vaccination", department: "pediatrics", price: 80, description: "تطعيم DTP" },
        { name: "تطعيم الحصبة", type: "vaccination", department: "pediatrics", price: 60, description: "تطعيم الحصبة" },
        { name: "تطعيم النكاف", type: "vaccination", department: "pediatrics", price: 70, description: "تطعيم النكاف" },
        
        // الأدوية والمستلزمات الطبية
        { name: "حقنة فيتامين د", type: "medication", department: "internal", price: 50, description: "حقنة فيتامين د" },
        { name: "حقنة فيتامين ب12", type: "medication", department: "internal", price: 40, description: "حقنة فيتامين ب12" },
        { name: "حقنة كورتيزون", type: "medication", department: "internal", price: 60, description: "حقنة كورتيزون" },
        { name: "مضادات حيوية (حقنة)", type: "medication", department: "internal", price: 80, description: "مضاد حيوي حقن" },
        { name: "مضادات حيوية (أقراص)", type: "medication", department: "internal", price: 120, description: "مضاد حيوي أقراص" },
        { name: "مسكنات (حقنة)", type: "medication", department: "internal", price: 30, description: "مسكن قوي" },
        { name: "مضادات الالتهاب", type: "medication", department: "internal", price: 100, description: "مضادات الالتهاب" },
        { name: "أدوية الضغط", type: "medication", department: "cardiology", price: 150, description: "أدوية ضغط الدم" },
        { name: "أدوية السكر", type: "medication", department: "internal", price: 200, description: "أدوية السكري" },
        { name: "أدوية الكوليسترول", type: "medication", department: "cardiology", price: 180, description: "أدوية خفض الكوليسترول" },
        
        // الخدمات الأخرى
        { name: "غسيل كلوي", type: "other", department: "internal", price: 500, description: "جلسة غسيل كلوي" },
        { name: "العلاج بالأكسجين", type: "other", department: "internal", price: 200, description: "جلسة علاج بالأكسجين" },
        { name: "العلاج بالأشعة", type: "other", department: "radiology", price: 2000, description: "جلسة علاج بالأشعة" },
        { name: "العلاج الكيميائي", type: "other", department: "internal", price: 1500, description: "جلسة علاج كيميائي" },
        { name: "تنويم مغناطيسي", type: "other", department: "radiology", price: 800, description: "جلسة تنويم مغناطيسي" },
        { name: "العلاج بالموجات فوق الصوتية", type: "other", department: "physiotherapy", price: 300, description: "علاج بالموجات فوق الصوتية" },
        { name: "العلاج بالليزر", type: "other", department: "physiotherapy", price: 400, description: "علاج بالليزر" },
        { name: "العلاج بالحرارة", type: "other", department: "physiotherapy", price: 250, description: "علاج بالحرارة" },
        { name: "العلاج بالكهرباء", type: "other", department: "physiotherapy", price: 200, description: "علاج بالكهرباء" },
        { name: "العلاج بالمياه", type: "other", department: "physiotherapy", price: 350, description: "علاج بالمياه" }
      ];
      
      const promises = defaultServices.map(service => 
        safeDatabaseOperation('push', 'services', service)
      );
      
      Promise.all(promises)
        .then(() => {
          console.log('✅ Default services added successfully');
          showSuccessToast('تم إضافة الخدمات الافتراضية بنجاح');
          loadServices(); // Reload services after adding
        })
        .catch((error) => {
          console.error('❌ Error adding default services:', error);
          showErrorToast('فشل في إضافة الخدمات الافتراضية');
        });
    }
    
    // Render services list
    function renderServices(services, filter = 'all', searchTerm = '') {
      servicesList.innerHTML = '';
      
      let filteredServices = Object.entries(services);
      
      if (filter !== 'all') {
        filteredServices = filteredServices.filter(([_, service]) => service.type === filter);
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredServices = filteredServices.filter(([_, service]) => 
          service.name.toLowerCase().includes(term) || 
          service.description.toLowerCase().includes(term)
        );
      }
      
      if (filteredServices.length === 0) {
        servicesList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا توجد خدمات مطابقة</p>
          </div>
        `;
        return;
      }
      
      filteredServices.forEach(([id, service]) => {
        const serviceCard = createServiceCard(service, id);
        servicesList.appendChild(serviceCard);
      });
    }
    
    // Create service card
    function createServiceCard(service, id) {
      const card = document.createElement('div');
      card.className = 'service-item';
      
      const typeIcons = {
        consultation: 'fa-stethoscope',
        xray: 'fa-x-ray',
        lab: 'fa-vial',
        ecg: 'fa-heartbeat',
        ultrasound: 'fa-ultrasound',
        ct: 'fa-x-ray',
        mri: 'fa-magnet',
        surgery: 'fa-procedures',
        medication: 'fa-pills',
        therapy: 'fa-dumbbell',
        vaccination: 'fa-syringe',
        checkup: 'fa-clipboard-check',
        other: 'fa-medkit'
      };
      
      card.innerHTML = `
        <div class="service-info">
          <div class="service-name">${service.name}</div>
          <div class="service-details">${service.description}</div>
        </div>
        <div class="service-price">${formatCurrency(service.price)}</div>
        <div class="flex gap-2">
          <button class="action-btn btn-edit" onclick="editService('${id}', ${JSON.stringify(service).replace(/"/g, '&quot;')})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn btn-delete" onclick="deleteService('${id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      
      return card;
    }
    
    // Load services for selection in invoice
    function loadServicesForSelection(services) {
      const container = document.getElementById('servicesSelection');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(services).forEach(([id, service]) => {
        const serviceItem = document.createElement('div');
        serviceItem.className = 'flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50';
        
        serviceItem.innerHTML = `
          <div class="flex items-center gap-3">
            <input type="checkbox" id="service-${id}" value="${id}" class="w-4 h-4 text-blue-600">
            <label for="service-${id}" class="cursor-pointer">
              <div class="font-semibold">${service.name}</div>
              <div class="text-sm text-gray-500">${service.description}</div>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-blue-600">${formatCurrency(service.price)}</span>
            <input type="number" id="quantity-${id}" min="1" value="1" class="w-16 text-center border rounded px-2 py-1">
          </div>
        `;
        
        container.appendChild(serviceItem);
        
        // Add event listeners
        const checkbox = serviceItem.querySelector(`#service-${id}`);
        const quantityInput = serviceItem.querySelector(`#quantity-${id}`);
        
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedServices.set(id, {
              ...service,
              quantity: parseInt(quantityInput.value)
            });
            updateSelectedServices();
          } else {
            selectedServices.delete(id);
            updateSelectedServices();
          }
        });
        
        quantityInput.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedServices.set(id, {
              ...service,
              quantity: parseInt(quantityInput.value)
            });
            updateSelectedServices();
          }
        });
      });
    }
    
    // Update selected services display
    function updateSelectedServices() {
      const container = document.getElementById('selectedServices');
      if (!container) return;
      
      if (selectedServices.size === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">لم يتم اختيار أي خدمات بعد</p>';
        updateInvoiceSummary();
        return;
      }
      
      container.innerHTML = '';
      let subtotal = 0;
      
      selectedServices.forEach((service, id) => {
        const serviceItem = document.createElement('div');
        serviceItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        
        const total = service.price * service.quantity;
        subtotal += total;
        
        serviceItem.innerHTML = `
          <div>
            <div class="font-semibold">${service.name}</div>
            <div class="text-sm text-gray-500">${formatCurrency(service.price)} × ${service.quantity}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold">${formatCurrency(total)}</span>
            <button class="action-btn btn-delete" onclick="removeService('${id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        
        container.appendChild(serviceItem);
      });
      
      updateInvoiceSummary(subtotal);
    }
    
    // Remove service from selection
    function removeService(serviceId) {
      selectedServices.delete(serviceId);
      
      // Uncheck the checkbox
      const checkbox = document.getElementById(`service-${serviceId}`);
      if (checkbox) checkbox.checked = false;
      
      updateSelectedServices();
    }
    
    // Calculate discount based on patient type and invoice size
    function calculateDiscount(subtotal, patientType, services) {
      let discountPercentage = 0;
      let discountBreakdown = [];
      
      // Discount for new patients
      if (patientType === 'new') {
        discountPercentage += 5;
        discountBreakdown.push('خصم المريض الجديد: 5%');
      }
      
      // Discount for VIP patients
      if (patientType === 'vip') {
        discountPercentage += 10;
        discountBreakdown.push('خصم المريض VIP: 10%');
      }
      
      // Discount for large invoices
      if (subtotal > 1000) {
        discountPercentage += 5;
        discountBreakdown.push('خصم الفواتير فوق 1000 ج.م: 5%');
      }
      
      if (subtotal > 5000) {
        discountPercentage += 10;
        discountBreakdown.push('خصم الفواتير فوق 5000 ج.م: 10%');
      }
      
      // Discount for surgeries
      const hasSpecialService = services.some(s => s.type === 'surgery');
      if (hasSpecialService) {
        discountPercentage += 3;
        discountBreakdown.push('خصم الجراحات: 3%');
      }
      
      const discountAmount = (subtotal * discountPercentage) / 100;
      
      return {
        percentage: discountPercentage,
        amount: discountAmount,
        breakdown: discountBreakdown
      };
    }
    
    // Update invoice summary
    function updateInvoiceSummary(customSubtotal = null) {
      const subtotal = customSubtotal || Array.from(selectedServices.values()).reduce((sum, service) => 
        sum + (service.price * service.quantity), 0
      );
      
      const patientType = document.getElementById('patientType').value;
      const servicesArray = Array.from(selectedServices.values());
      
      // Calculate discount
      const discount = calculateDiscount(subtotal, patientType, servicesArray);
      
      // Update discount display
      document.getElementById('totalDiscountAmount').textContent = formatCurrency(discount.amount);
      document.getElementById('discountBreakdown').textContent = discount.breakdown.join(', ');
      
      // Calculate total after discount
      let totalAfterDiscount = subtotal - discount.amount;
      
      // Calculate insurance coverage if applicable
      let coverage = 0;
      if (selectedPaymentMethod === 'insurance') {
        const coveragePercentage = parseInt(document.getElementById('coveragePercentage').value) || 0;
        coverage = (totalAfterDiscount * coveragePercentage) / 100;
      }
      
      const totalAmount = totalAfterDiscount - coverage;
      
      // Update UI elements
      const subtotalElement = document.getElementById('subtotal');
      const discountElement = document.getElementById('discount');
      const coverageElement = document.getElementById('coverage');
      const totalAmountElement = document.getElementById('totalAmount');
      const discountRow = document.getElementById('discountRow');
      const coverageRow = document.getElementById('coverageRow');
      
      if (subtotalElement) subtotalElement.textContent = formatCurrency(subtotal);
      
      if (discount.amount > 0) {
        if (discountElement) discountElement.textContent = formatCurrency(discount.amount);
        if (discountRow) discountRow.style.display = 'flex';
      } else {
        if (discountRow) discountRow.style.display = 'none';
      }
      
      if (coverage > 0) {
        if (coverageElement) coverageElement.textContent = formatCurrency(coverage);
        if (coverageRow) coverageRow.style.display = 'flex';
      } else {
        if (coverageRow) coverageRow.style.display = 'none';
      }
      
      if (totalAmountElement) totalAmountElement.textContent = formatCurrency(totalAmount);
      
      // Update installment options if total is large enough
      updateInstallmentOptions(totalAmount);
      
      // Update insurance coverage display
      if (selectedPaymentMethod === 'insurance') {
        updateInsuranceCoverage(totalAfterDiscount);
      }
    }
    
    // Update installment options based on total amount
    function updateInstallmentOptions(totalAmount) {
      const installmentOptions = document.getElementById('installmentOptions');
      const installmentCount = document.getElementById('installmentCount');
      const firstInstallment = document.getElementById('firstInstallment');
      
      // Show installment options for amounts over 1000
      if (totalAmount > 1000) {
        installmentOptions.style.display = 'block';
        
        // Calculate first installment based on selected plan
        const calculateFirstInstallment = () => {
          const count = parseInt(installmentCount.value) || 0;
          if (count > 0) {
            const installmentAmount = totalAmount / count;
            firstInstallment.value = installmentAmount.toFixed(2);
            
            // Generate installment plan
            generateInstallmentPlan(totalAmount, count);
          } else {
            firstInstallment.value = '';
            document.getElementById('installmentPlan').style.display = 'none';
          }
        };
        
        installmentCount.addEventListener('change', calculateFirstInstallment);
        calculateFirstInstallment();
      } else {
        installmentOptions.style.display = 'none';
      }
    }
    
    // Generate installment plan
    function generateInstallmentPlan(totalAmount, count) {
      const installmentPlan = document.getElementById('installmentPlan');
      const installmentDetails = document.getElementById('installmentDetails');
      
      if (count > 0) {
        installmentPlan.style.display = 'block';
        installmentDetails.innerHTML = '';
        
        const installmentAmount = totalAmount / count;
        const today = new Date();
        
        for (let i = 1; i <= count; i++) {
          const dueDate = new Date(today);
          dueDate.setMonth(today.getMonth() + i);
          
          const installmentItem = document.createElement('div');
          installmentItem.className = 'installment-item';
          
          installmentItem.innerHTML = `
            <div class="installment-title">القسط ${i}</div>
            <div>المبلغ: ${formatCurrency(installmentAmount)}</div>
            <div>تاريخ الاستحقاق: ${dueDate.toLocaleDateString('ar-EG')}</div>
          `;
          
          installmentDetails.appendChild(installmentItem);
        }
      } else {
        installmentPlan.style.display = 'none';
      }
    }
    
    // Update insurance coverage display
    function updateInsuranceCoverage(totalAmount) {
      const coveragePercentage = parseInt(document.getElementById('coveragePercentage').value) || 0;
      const coverageAmount = (totalAmount * coveragePercentage) / 100;
      const remainingAmount = totalAmount - coverageAmount;
      
      // Update coverage progress bar
      const coverageProgress = document.getElementById('coverageProgress');
      if (coverageProgress) {
        coverageProgress.style.width = `${coveragePercentage}%`;
        coverageProgress.textContent = `${coveragePercentage}%`;
      }
      
      // Update coverage amounts
      const coveredAmountElement = document.getElementById('coveredAmount');
      const remainingAmountElement = document.getElementById('remainingAmount');
      
      if (coveredAmountElement) coveredAmountElement.textContent = formatCurrency(coverageAmount);
      if (remainingAmountElement) remainingAmountElement.textContent = formatCurrency(remainingAmount);
    }
    
    // Generate QR code for invoice
    function generateQRCode(invoiceData) {
      const qrContainer = document.getElementById('qrcode');
      
      // Clear previous QR code if exists
      qrContainer.innerHTML = '';
      
      // Generate new QR code
      qrCodeInstance = new QRCode(qrContainer, {
        text: JSON.stringify(invoiceData),
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      return qrContainer;
    }
    
    // Add payment to history
    function addPaymentToHistory(amount, date, method) {
      const payment = {
        amount,
        date: date || new Date().toISOString(),
        method
      };
      
      paymentHistory.push(payment);
      updatePaymentHistoryDisplay();
    }
    
    // Update payment history display
    function updatePaymentHistoryDisplay() {
      const paymentHistoryContainer = document.getElementById('paymentHistory');
      
      if (paymentHistory.length === 0) {
        paymentHistoryContainer.innerHTML = '<p class="text-gray-500 text-center py-4">لا توجد مدفوعات مسجلة</p>';
        return;
      }
      
      paymentHistoryContainer.innerHTML = '';
      
      paymentHistory.forEach((payment, index) => {
        const paymentItem = document.createElement('div');
        paymentItem.className = 'payment-item';
        
        const paymentDate = new Date(payment.date);
        const formattedDate = paymentDate.toLocaleDateString('ar-EG');
        
        paymentItem.innerHTML = `
          <div>
            <div class="font-semibold">${formatCurrency(payment.amount)}</div>
            <div class="payment-date">${formattedDate} - ${getPaymentMethodText(payment.method)}</div>
          </div>
          <button class="action-btn btn-delete" onclick="removePayment(${index})">
            <i class="fas fa-trash"></i>
          </button>
        `;
        
        paymentHistoryContainer.appendChild(paymentItem);
      });
    }
    
    // Remove payment from history
    function removePayment(index) {
      paymentHistory.splice(index, 1);
      updatePaymentHistoryDisplay();
    }
    
    // Preview invoice
    function previewInvoice() {
      const invoicePreview = document.getElementById('invoicePreview');
      const patientId = document.getElementById('invoicePatient').value;
      const patientOption = document.getElementById('invoicePatient').options[document.getElementById('invoicePatient').selectedIndex];
      const patientName = patientOption ? patientOption.textContent.split(' - ')[0] : '';
      const invoiceDate = document.getElementById('invoiceDate').value;
      const invoiceNumber = generateInvoiceNumber();
      
      // Calculate totals
      const subtotal = Array.from(selectedServices.values()).reduce((sum, service) => 
        sum + (service.price * service.quantity), 0
      );
      
      const patientType = document.getElementById('patientType').value;
      const servicesArray = Array.from(selectedServices.values());
      const discount = calculateDiscount(subtotal, patientType, servicesArray);
      
      let totalAfterDiscount = subtotal - discount.amount;
      let coverage = 0;
      
      if (selectedPaymentMethod === 'insurance') {
        const coveragePercentage = parseInt(document.getElementById('coveragePercentage').value) || 0;
        coverage = (totalAfterDiscount * coveragePercentage) / 100;
      }
      
      const totalAmount = totalAfterDiscount - coverage;
      
      // Update preview elements
      document.getElementById('previewInvoiceNumber').textContent = invoiceNumber;
      document.getElementById('previewPatientName').textContent = patientName;
      document.getElementById('previewDate').textContent = invoiceDate;
      document.getElementById('previewPaymentMethod').textContent = getPaymentMethodText(selectedPaymentMethod);
      document.getElementById('previewSubtotal').textContent = formatCurrency(subtotal);
      document.getElementById('previewTotal').textContent = formatCurrency(totalAmount);
      
      // Update discount row
      const previewDiscountRow = document.getElementById('previewDiscountRow');
      if (discount.amount > 0) {
        document.getElementById('previewDiscount').textContent = formatCurrency(discount.amount);
        previewDiscountRow.style.display = 'flex';
      } else {
        previewDiscountRow.style.display = 'none';
      }
      
      // Update coverage row
      const previewCoverageRow = document.getElementById('previewCoverageRow');
      if (coverage > 0) {
        document.getElementById('previewCoverage').textContent = formatCurrency(coverage);
        previewCoverageRow.style.display = 'flex';
      } else {
        previewCoverageRow.style.display = 'none';
      }
      
      // Update services list
      const previewServices = document.getElementById('previewServices');
      previewServices.innerHTML = '';
      
      servicesArray.forEach(service => {
        const serviceItem = document.createElement('div');
        serviceItem.className = 'flex justify-between py-1';
        
        serviceItem.innerHTML = `
          <span>${service.name} × ${service.quantity}</span>
          <span>${formatCurrency(service.price * service.quantity)}</span>
        `;
        
        previewServices.appendChild(serviceItem);
      });
      
      // Generate QR code
      const invoiceData = {
        invoiceNumber,
        patientName,
        date: invoiceDate,
        totalAmount,
        paymentMethod: selectedPaymentMethod
      };
      
      generateQRCode(invoiceData);
      
      // Show preview
      invoicePreview.style.display = 'block';
    }
    
    // Send invoice via email
    function sendInvoiceViaEmail(invoiceData, patientEmail) {
      // In a real implementation, you would use a service like EmailJS or a backend API
      // For this demo, we'll just show a success message
      
      showSuccessToast(`تم إرسال الفاتورة إلى ${patientEmail}`);
    }
    
    // Send invoice via WhatsApp
    function sendInvoiceViaWhatsApp(invoiceData, patientPhone) {
      const message = `فاتورة مستشفى الحياة الذكية\nرقم: ${invoiceData.invoiceNumber}\nالمبلغ: ${formatCurrency(invoiceData.totalAmount)}`;
      const whatsappUrl = `https://wa.me/${patientPhone}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }
    
    // Generate time slots for appointment
    function generateTimeSlots(doctorId, date) {
      timeSlots.innerHTML = '';
      
      if (!doctorId || !date) return;
      
      safeDatabaseOperation('once', `doctors/${doctorId}`)
        .then((snapshot) => {
          const doctor = snapshot.val();
          if (!doctor) return;
          
          const workFrom = doctor.workFrom || "09:00";
          const workTo = doctor.workTo || "17:00";
          
          const [fromHour, fromMinute] = workFrom.split(':').map(Number);
          const [toHour, toMinute] = workTo.split(':').map(Number);
          
          const startTime = new Date();
          startTime.setHours(fromHour, fromMinute, 0, 0);
          
          const endTime = new Date();
          endTime.setHours(toHour, toMinute, 0, 0);
          
          while (startTime < endTime) {
            const timeString = startTime.toLocaleTimeString('en-US', { 
              hour: '2-digit', 
              minute: '2-digit',
              hour12: false 
            });
            
            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.textContent = timeString;
            slot.dataset.time = timeString;
            
            checkSlotAvailability(doctorId, date, timeString).then(isAvailable => {
              if (!isAvailable) {
                slot.classList.add('disabled');
              } else {
                slot.addEventListener('click', selectTimeSlot);
              }
            });
            
            timeSlots.appendChild(slot);
            startTime.setMinutes(startTime.getMinutes() + 30);
          }
        })
        .catch((error) => {
          console.error('Error generating time slots:', error);
          showErrorToast('فشل في تحميل أوقات المواعيد');
        });
    }
    
    // Check if a time slot is available
    async function checkSlotAvailability(doctorId, date, time) {
      try {
        const snapshot = await safeDatabaseOperation('once', 'appointments');
        const appointments = snapshot.val() || {};
        
        for (const appointment of Object.values(appointments)) {
          if (appointment.doctorId === doctorId && 
              appointment.date === date && 
              appointment.time === time && 
              appointment.status !== 'cancelled') {
            return false;
          }
        }
        
        return true;
      } catch (error) {
        console.error('Error checking slot availability:', error);
        return false;
      }
    }
    
    // Select time slot
    function selectTimeSlot(e) {
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
      });
      e.target.classList.add('selected');
    }
    
    // Create patient card
    function createPatientCard(patient, id, department) {
      const card = document.createElement('div');
      card.className = 'patient-card';
      
      const genderText = patient.gender === 'male' ? 'ذكر' : 'أنثى';
      const genderIcon = patient.gender === 'male' ? 'fa-mars' : 'fa-venus';
      const deptClass = `dept-${department}`;
      
      let doctorInfo = '';
      if (patient.doctorId) {
        doctorInfo = `
          <div class="detail-item">
            <i class="fas fa-user-md"></i>
            <span>الطبيب: ${patient.doctorName || 'غير محدد'}</span>
          </div>
        `;
      }
      
      let statusBadge = '';
      if (patient.status === 'discharged') {
        statusBadge = '<span class="status-badge status-discharged"><i class="fas fa-sign-out-alt"></i> تم الخروج</span>';
      } else if (patient.status === 'pending') {
        statusBadge = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> في انتظار الدفع</span>';
      } else {
        statusBadge = '<span class="status-badge status-active"><i class="fas fa-procedures"></i> تحت العلاج</span>';
      }
      
      // Patient category badge
      const categoryColors = {
        outpatient: 'bg-blue-100 text-blue-800',
        inpatient: 'bg-green-100 text-green-800',
        emergency: 'bg-red-100 text-red-800',
        daycare: 'bg-yellow-100 text-yellow-800',
        referred: 'bg-purple-100 text-purple-800',
        vip: 'bg-indigo-100 text-indigo-800'
      };
      
      const categoryNames = {
        outpatient: 'مريض خارجي',
        inpatient: 'مريض داخلي',
        emergency: 'حالة طارئة',
        daycare: 'علاج نهاري',
        referred: 'محول',
        vip: 'VIP'
      };
      
      const categoryClass = categoryColors[patient.patientCategory] || 'bg-gray-100 text-gray-800';
      const categoryName = categoryNames[patient.patientCategory] || 'غير محدد';
      
      card.innerHTML = `
        <div class="flex items-start gap-4">
          <div class="patient-avatar">
            ${patient.name.charAt(0).toUpperCase()}
          </div>
          <div class="patient-info flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="patient-name">${patient.name}</h3>
              <div class="flex gap-2">
                ${statusBadge}
                <span class="dept-badge ${deptClass}">
                  ${getDepartmentIcon(department)}
                  ${getDepartmentName(department)}
                </span>
                <span class="px-2 py-1 rounded-full text-xs font-medium ${categoryClass}">
                  ${categoryName}
                </span>
              </div>
            </div>
            
            <div class="patient-details">
              <div class="detail-item">
                <i class="fas fa-id-card"></i>
                <span>${patient.nid}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-${genderIcon}"></i>
                <span>${genderText}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-birthday-cake"></i>
                <span>${patient.age} سنة</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-tint"></i>
                <span>${patient.bloodType}</span>
              </div>
              ${patient.phone ? `
              <div class="detail-item">
                <i class="fas fa-phone"></i>
                <span>${patient.phone}</span>
              </div>
              ` : ''}
              ${patient.whatsapp ? `
              <div class="detail-item">
                <i class="fab fa-whatsapp"></i>
                <span>${patient.whatsapp}</span>
              </div>
              ` : ''}
              ${patient.email ? `
              <div class="detail-item">
                <i class="fas fa-envelope"></i>
                <span>${patient.email}</span>
              </div>
              ` : ''}
              ${doctorInfo}
            </div>
            
            ${patient.diseases ? `
            <div class="mt-3 p-3 bg-gray-50 rounded-lg">
              <div class="detail-item mb-1">
                <i class="fas fa-notes-medical"></i>
                <span class="font-semibold">ملاحظات طبية:</span>
              </div>
              <p class="text-sm text-gray-600 pr-6">${patient.diseases}</p>
            </div>
            ` : ''}
            
            <div class="flex items-center justify-between mt-3">
              <div class="detail-item text-xs">
                <i class="fas fa-clock"></i>
                <span>${formatDate(patient.timestamp)}</span>
              </div>
              <div class="flex gap-2">
                <button class="action-btn btn-view" onclick="viewPatient('${id}', '${department}', ${JSON.stringify(patient).replace(/"/g, '&quot;')})">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn btn-edit" onclick="editPatient('${id}', '${department}', ${JSON.stringify(patient).replace(/"/g, '&quot;')})">
                  <i class="fas fa-edit"></i>
                </button>
                ${patient.status === 'active' ? `
                <button class="action-btn btn-discharge" onclick="dischargePatient('${id}', '${department}', ${JSON.stringify(patient).replace(/"/g, '&quot;')})">
                  <i class="fas fa-sign-out-alt"></i>
                </button>
                ` : ''}
                <button class="action-btn btn-delete" onclick="deletePatient('${id}', '${department}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }
    
    // Create doctor card
    function createDoctorCard(doctor, id, showAvailability = false) {
      const card = document.createElement('div');
      card.className = 'patient-card';
      
      const deptClass = `dept-${doctor.department}`;
      
      let availabilityBadge = '';
      if (showAvailability) {
        const status = getDoctorAvailabilityStatus(doctor);
        availabilityBadge = `
          <span class="availability-badge ${status.class}">
            <i class="fas ${status.icon}"></i>
            ${status.text}
          </span>
        `;
      }
      
      card.innerHTML = `
        <div class="flex items-start gap-4">
          <div class="patient-avatar">
            <i class="fas fa-user-md"></i>
          </div>
          <div class="patient-info flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="patient-name">د. ${doctor.name}</h3>
              <div class="flex gap-2">
                <span class="dept-badge ${deptClass}">
                  ${getDepartmentIcon(doctor.department)}
                  ${getDepartmentName(doctor.department)}
                </span>
                ${availabilityBadge}
              </div>
            </div>
            
            <div class="patient-details">
              <div class="detail-item">
                <i class="fas fa-stethoscope"></i>
                <span>${doctor.specialization}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>${doctor.workFrom || '--'} - ${doctor.workTo || '--'}</span>
              </div>
            </div>
            
            <div class="flex items-center justify-between mt-3">
              <div class="detail-item text-xs">
                <i class="fas fa-clock"></i>
                <span>${formatDate(doctor.timestamp)}</span>
              </div>
              <div class="flex gap-2">
                ${showAvailability && isDoctorAvailableNow(doctor) ? `
                <button class="action-btn btn-book" onclick="quickBookAppointment('${id}', '${doctor.name}')">
                  <i class="fas fa-calendar-plus"></i>
                </button>
                ` : ''}
                <button class="action-btn btn-edit" onclick="editDoctor('${id}', ${JSON.stringify(doctor).replace(/"/g, '&quot;')})">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn btn-delete" onclick="deleteDoctor('${id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }
    
    // Get department name
    function getDepartmentName(department) {
      const departments = {
        emergency: 'الطوارئ',
        icu: 'العناية المركزة',
        surgery: 'العمليات',
        care: 'الرعاية',
        admin: 'الإدارة',
        radiology: 'الأشعة',
        operations: 'العمليات',
        cardiology: 'القلب',
        neurology: 'الأعصاب',
        pediatrics: 'الأطفال',
        obstetrics: 'النساء والتوليد',
        orthopedics: 'العظام',
        internal: 'الباطنة',
        ent: 'الأذن والأنف والحنجرة',
        ophthalmology: 'العيون',
        dermatology: 'الجلدية',
        psychiatry: 'الطب النفسي',
        physiotherapy: 'العلاج الطبيعي'
      };
      return departments[department] || department;
    }
    
    // Get department icon
    function getDepartmentIcon(department) {
      const icons = {
        emergency: '<i class="fas fa-ambulance"></i>',
        icu: '<i class="fas fa-procedures"></i>',
        surgery: '<i class="fas fa-user-md"></i>',
        care: '<i class="fas fa-hand-holding-heart"></i>',
        admin: '<i class="fas fa-building"></i>',
        radiology: '<i class="fas fa-x-ray"></i>',
        operations: '<i class="fas fa-user-md"></i>',
        cardiology: '<i class="fas fa-heartbeat"></i>',
        neurology: '<i class="fas fa-brain"></i>',
        pediatrics: '<i class="fas fa-baby"></i>',
        obstetrics: '<i class="fas fa-female"></i>',
        orthopedics: '<i class="fas fa-bone"></i>',
        internal: '<i class="fas fa-stethoscope"></i>',
        ent: '<i class="fas fa-head-side"></i>',
        ophthalmology: '<i class="fas fa-eye"></i>',
        dermatology: '<i class="fas fa-skin"></i>',
        psychiatry: '<i class="fas fa-brain"></i>',
        physiotherapy: '<i class="fas fa-dumbbell"></i>'
      };
      return icons[department] || '<i class="fas fa-hospital"></i>';
    }
    
    // Render patients list
    function renderPatients(patients, filter = 'all', statusFilter = 'all', searchTerm = '') {
      patientsList.innerHTML = '';
      
      if (!patients) {
        patientsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-user-slash text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا يوجد مرضى مسجلين</p>
            <p class="text-gray-400 text-sm mt-2">قم بتسجيل أول مريض للبدء</p>
          </div>
        `;
        return;
      }
      
      let filteredPatients = Object.entries(patients);
      
      if (filter !== 'all') {
        filteredPatients = filteredPatients.filter(([_, patient]) => patient.department === filter);
      }
      
      if (statusFilter !== 'all') {
        filteredPatients = filteredPatients.filter(([_, patient]) => patient.status === statusFilter);
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredPatients = filteredPatients.filter(([_, patient]) => 
          patient.name.toLowerCase().includes(term) || 
          patient.nid.includes(term) || 
          (patient.address && patient.address.toLowerCase().includes(term)) ||
          (patient.phone && patient.phone.includes(term)) ||
          (patient.email && patient.email.toLowerCase().includes(term))
        );
      }
      
      if (filteredPatients.length === 0) {
        patientsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا توجد نتائج للبحث</p>
            <p class="text-gray-400 text-sm mt-2">جرب تغيير معايير البحث</p>
          </div>
        `;
        return;
      }
      
      filteredPatients.forEach(([id, patient]) => {
        const department = patient.department || 'غير محدد';
        const card = createPatientCard(patient, id, department);
        patientsList.appendChild(card);
      });
    }
    
    // Render doctors list
    function renderDoctors(doctors, filter = 'all', searchTerm = '') {
      doctorsList.innerHTML = '';
      
      if (!doctors || Object.keys(doctors).length === 0) {
        doctorsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-user-md text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا يوجد أطباء مسجلين</p>
            <p class="text-gray-400 text-sm mt-2">سيتم إضافة أطباء افتراضيين</p>
          </div>
        `;
        addDefaultDoctors();
        return;
      }
      
      let filteredDoctors = Object.entries(doctors);
      
      if (filter !== 'all') {
        filteredDoctors = filteredDoctors.filter(([_, doctor]) => doctor.department === filter);
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredDoctors = filteredDoctors.filter(([_, doctor]) => 
          doctor.name.toLowerCase().includes(term) || 
          doctor.specialization.toLowerCase().includes(term)
        );
      }
      
      if (filteredDoctors.length === 0) {
        doctorsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا توجد نتائج للبحث</p>
            <p class="text-gray-400 text-sm mt-2">جرب تغيير معايير البحث</p>
          </div>
        `;
        return;
      }
      
      filteredDoctors.forEach(([id, doctor]) => {
        const card = createDoctorCard(doctor, id, false);
        doctorsList.appendChild(card);
      });
    }
    
    // Render available doctors list
    function renderAvailableDoctors(doctors, specializationFilter = 'all', searchTerm = '') {
      availableDoctorsList.innerHTML = '';
      
      if (!doctors || Object.keys(doctors).length === 0) {
        availableDoctorsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-user-md text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا يوجد أطباء متاحين حالياً</p>
            <p class="text-gray-400 text-sm mt-2">جرب التحقق لاحقاً</p>
          </div>
        `;
        return;
      }
      
      let availableDoctors = Object.entries(doctors).filter(([_, doctor]) => 
        isDoctorAvailableNow(doctor)
      );
      
      if (specializationFilter !== 'all') {
        availableDoctors = availableDoctors.filter(([_, doctor]) => 
          doctor.specialization === specializationFilter
        );
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        availableDoctors = availableDoctors.filter(([_, doctor]) => 
          doctor.name.toLowerCase().includes(term) || 
          doctor.specialization.toLowerCase().includes(term)
        );
      }
      
      if (availableDoctors.length === 0) {
        availableDoctorsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-user-clock text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا يوجد أطباء متاحين بهذه المواصفات</p>
            <p class="text-gray-400 text-sm mt-2">جرب تغيير معايير البحث أو التوقيت</p>
          </div>
        `;
        return;
      }
      
      availableDoctors.forEach(([id, doctor]) => {
        const card = createDoctorCard(doctor, id, true);
        availableDoctorsList.appendChild(card);
      });
    }
    
    // Update available doctors count
    function updateAvailableDoctorsCount(doctors) {
      if (!doctors) {
        availableDoctorsElement.textContent = '0';
        return;
      }
      
      const availableCount = Object.values(doctors).filter(doctor => 
        isDoctorAvailableNow(doctor)
      ).length;
      
      availableDoctorsElement.textContent = availableCount;
    }
    
    // Add default doctors
    function addDefaultDoctors() {
      const defaultDoctors = [
        { 
          name: "د. أحمد محمد علي", 
          specialization: "طب الطوارئ", 
          department: "emergency", 
          workFrom: "08:00", 
          workTo: "20:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. فاطمة أحمد حسن", 
          specialization: "العناية المركزة", 
          department: "icu", 
          workFrom: "08:00", 
          workTo: "20:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. محمد خالد عبدالله", 
          specialization: "جراحة عامة", 
          department: "operations", 
          workFrom: "08:00", 
          workTo: "20:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. نورة سعيد محمود", 
          specialization: "الأشعة التشخيصية", 
          department: "radiology", 
          workFrom: "08:00", 
          workTo: "20:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. يوسف عمر إبراهيم", 
          specialization: "طب القلب", 
          department: "cardiology", 
          workFrom: "09:00", 
          workTo: "17:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. مريم حسن عبدالرحمن", 
          specialization: "طب الأطفال", 
          department: "pediatrics", 
          workFrom: "10:00", 
          workTo: "18:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. خالد أحمد محمد", 
          specialization: "النساء والتوليد", 
          department: "obstetrics", 
          workFrom: "08:00", 
          workTo: "16:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. سامي محمود عبداللطيف", 
          specialization: "طب الأعصاب", 
          department: "neurology", 
          workFrom: "09:00", 
          workTo: "17:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. ليلى حسين علي", 
          specialization: "العظام", 
          department: "orthopedics", 
          workFrom: "08:00", 
          workTo: "16:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. عمر خالد محمود", 
          specialization: "الباطنة", 
          department: "internal", 
          workFrom: "09:00", 
          workTo: "17:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. رنا أحمد سالم", 
          specialization: "الأذن والأنف والحنجرة", 
          department: "ent", 
          workFrom: "10:00", 
          workTo: "18:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. كريم محمود إبراهيم", 
          specialization: "العيون", 
          department: "ophthalmology", 
          workFrom: "09:00", 
          workTo: "17:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. سارة محمد علي", 
          specialization: "الجلدية", 
          department: "dermatology", 
          workFrom: "10:00", 
          workTo: "18:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. أحمد حسن محمود", 
          specialization: "الطب النفسي", 
          department: "psychiatry", 
          workFrom: "14:00", 
          workTo: "20:00", 
          timestamp: new Date().toISOString() 
        },
        { 
          name: "د. منى محمود عبدالله", 
          specialization: "العلاج الطبيعي", 
          department: "physiotherapy", 
          workFrom: "08:00", 
          workTo: "20:00", 
          timestamp: new Date().toISOString() 
        }
      ];
      
      const promises = defaultDoctors.map(doctor => 
        safeDatabaseOperation('push', 'doctors', doctor)
      );
      
      Promise.all(promises)
        .then(() => {
          console.log('✅ Default doctors added successfully');
          showSuccessToast('تم إضافة الأطباء الافتراضيين بنجاح');
        })
        .catch((error) => {
          console.error('❌ Error adding default doctors:', error);
          showErrorToast('فشل في إضافة الأطباء الافتراضيين');
        });
    }
    
    // Discharge patient
    window.dischargePatient = function(id, department, patient) {
      currentPatientForDischarge = { id, department, ...patient };
      
      // Update patient info in modal
      const infoDiv = document.getElementById('dischargePatientInfo');
      infoDiv.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
          <div>
            <strong>الاسم:</strong> ${patient.name}<br>
            <strong>الرقم القومي:</strong> ${patient.nid}<br>
            <strong>تاريخ الدخول:</strong> ${formatDate(patient.timestamp)}
          </div>
          <div>
            <strong>القسم:</strong> ${getDepartmentName(department)}<br>
            <strong>الطبيب المعالج:</strong> ${patient.doctorName || '---'}<br>
            <strong>الحالة الحالية:</strong> ${patient.status === 'active' ? 'تحت العلاج' : 'أخرى'}
          </div>
        </div>
      `;
      
      // Load services for discharge
      loadServicesForDischarge();
      
      // Show modal
      dischargeModal.classList.remove('hidden');
    };
    
    // Load services for discharge
    function loadServicesForDischarge() {
      safeDatabaseOperation('once', 'services')
        .then((snapshot) => {
          const services = snapshot.val() || {};
          const container = document.getElementById('dischargeServices');
          
          container.innerHTML = '';
          
          Object.entries(services).forEach(([id, service]) => {
            const serviceItem = document.createElement('div');
            serviceItem.className = 'flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50';
            
            serviceItem.innerHTML = `
              <div class="flex items-center gap-3">
                <input type="checkbox" id="discharge-service-${id}" value="${id}" class="w-4 h-4 text-blue-600">
                <label for="discharge-service-${id}" class="cursor-pointer">
                  <div class="font-semibold">${service.name}</div>
                  <div class="text-sm text-gray-500">${service.description}</div>
                </label>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-bold text-blue-600">${formatCurrency(service.price)}</span>
                <input type="number" id="discharge-quantity-${id}" min="1" value="1" class="w-16 text-center border rounded px-2 py-1">
              </div>
            </div>
            `;
            
            container.appendChild(serviceItem);
            
            // Add event listeners
            const checkbox = serviceItem.querySelector(`#discharge-service-${id}`);
            const quantityInput = serviceItem.querySelector(`#discharge-quantity-${id}`);
            
            checkbox.addEventListener('change', () => {
              updateDischargeSummary();
            });
            
            quantityInput.addEventListener('change', () => {
              if (checkbox.checked) {
                updateDischargeSummary();
              }
            });
          });
        })
        .catch((error) => {
          console.error('Error loading services for discharge:', error);
          showErrorToast('فشل في تحميل الخدمات');
        });
    }
    
    // Update discharge summary
    function updateDischargeSummary() {
      safeDatabaseOperation('once', 'services')
        .then((snapshot) => {
          const services = snapshot.val() || {};
          let subtotal = 0;
          
          document.querySelectorAll('#dischargeServices input[type="checkbox"]:checked').forEach(checkbox => {
            const serviceId = checkbox.value;
            const service = services[serviceId];
            const quantity = parseInt(document.getElementById(`discharge-quantity-${serviceId}`).value) || 1;
            
            if (service) {
              subtotal += service.price * quantity;
            }
          });
          
          document.getElementById('dischargeSubtotal').textContent = formatCurrency(subtotal);
          document.getElementById('dischargeTotal').textContent = formatCurrency(subtotal);
        })
        .catch((error) => {
          console.error('Error updating discharge summary:', error);
        });
    }
    
    // View invoice
    window.viewInvoice = function(id, invoice) {
      Swal.fire({
        title: `تفاصيل الفاتورة ${invoice.invoiceNumber}`,
        html: `
          <div class="text-right">
            <div class="mb-4">
              <strong>المريض:</strong> ${invoice.patientName}<br>
              <strong>التاريخ:</strong> ${formatDate(invoice.date)}<br>
              <strong>طريقة الدفع:</strong> ${getPaymentMethodText(invoice.paymentMethod)}<br>
              <strong>الحالة:</strong> ${invoice.status === 'paid' ? 'مدفوعة' : invoice.status === 'pending' ? 'معلقة' : 'ملغاة'}
            </div>
            <div class="border-t pt-4">
              <strong>الخدمات:</strong><br>
              ${invoice.services ? invoice.services.map(s => `• ${s.name}: ${formatCurrency(s.price)} × ${s.quantity}`).join('<br>') : '---'}
            </div>
            <div class="border-t pt-4 mt-4">
              <div class="flex justify-between mb-2">
                <span>المجموع الفرعي:</span>
                <span>${formatCurrency(invoice.subtotal || 0)}</span>
              </div>
              ${invoice.discount ? `
              <div class="flex justify-between mb-2">
                <span>الخصم:</span>
                <span>${formatCurrency(invoice.discount)}</span>
              </div>
              ` : ''}
              ${invoice.coverage ? `
              <div class="flex justify-between mb-2">
                <span>تغطية التأمين:</span>
                <span>${formatCurrency(invoice.coverage)}</span>
              </div>
              ` : ''}
              <div class="flex justify-between font-bold text-lg">
                <span>المبلغ الإجمالي:</span>
                <span>${formatCurrency(invoice.totalAmount)}</span>
              </div>
              <div class="flex justify-between">
                <span>المدفوع:</span>
                <span class="text-green-600">${formatCurrency(invoice.paidAmount || 0)}</span>
              </div>
              <div class="flex justify-between">
                <span>المتبقي:</span>
                <span class="text-orange-600">${formatCurrency((invoice.totalAmount || 0) - (invoice.paidAmount || 0))}</span>
              </div>
            </div>
            ${invoice.notes ? `
            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
              <strong>ملاحظات:</strong><br>
              ${invoice.notes}
            </div>
            ` : ''}
          </div>
        `,
        confirmButtonText: 'إغلاق',
        customClass: {
          popup: 'medical-card'
        }
      });
    };
    
    // Print invoice by ID
    window.printInvoiceById = function(id) {
      safeDatabaseOperation('once', `invoices/${id}`)
        .then((snapshot) => {
          const invoice = snapshot.val();
          if (invoice) {
            printInvoiceData(invoice);
          }
        })
        .catch((error) => {
          console.error('Error printing invoice:', error);
          showErrorToast('فشل في طباعة الفاتورة');
        });
    };
    
    // Print invoice data
    function printInvoiceData(invoice) {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html dir="rtl">
        <head>
          <title>فاتورة - ${invoice.invoiceNumber}</title>
          <style>
            body { font-family: 'Cairo', sans-serif; padding: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .services { margin: 20px 0; }
            .service-item { padding: 10px; border-bottom: 1px solid #ddd; }
            .summary { margin-top: 20px; }
            .summary-row { display: flex; justify-content: space-between; margin: 5px 0; }
            .total { font-weight: bold; font-size: 18px; border-top: 2px solid #000; padding-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>مستشفى الحياة الذكية</h1>
            <h2>فاتورة رقم: ${invoice.invoiceNumber}</h2>
            <p>التاريخ: ${formatDate(invoice.date)}</p>
          </div>
          
          <div class="info">
            <p><strong>المريض:</strong> ${invoice.patientName}</p>
            <p><strong>طريقة الدفع:</strong> ${getPaymentMethodText(invoice.paymentMethod)}</p>
            <p><strong>الحالة:</strong> ${invoice.status === 'paid' ? 'مدفوعة' : invoice.status === 'pending' ? 'معلقة' : 'ملغاة'}</p>
          </div>
          
          <div class="services">
            <h3>الخدمات:</h3>
            ${invoice.services ? invoice.services.map(s => `
              <div class="service-item">
                ${s.name} - ${formatCurrency(s.price)} × ${s.quantity} = ${formatCurrency(s.price * s.quantity)}
              </div>
            `).join('') : ''}
          </div>
          
          <div class="summary">
            <div class="summary-row">
              <span>المجموع الفرعي:</span>
              <span>${formatCurrency(invoice.subtotal || 0)}</span>
            </div>
            ${invoice.discount ? `
            <div class="summary-row">
              <span>الخصم:</span>
              <span>${formatCurrency(invoice.discount)}</span>
            </div>
            ` : ''}
            ${invoice.coverage ? `
            <div class="summary-row">
              <span>تغطية التأمين:</span>
              <span>${formatCurrency(invoice.coverage)}</span>
            </div>
            ` : ''}
            <div class="total">
              <span>المبلغ الإجمالي:</span>
              <span>${formatCurrency(invoice.totalAmount)}</span>
            </div>
            <div class="summary-row">
              <span>المدفوع:</span>
              <span>${formatCurrency(invoice.paidAmount || 0)}</span>
            </div>
            <div class="summary-row">
              <span>المتبقي:</span>
              <span>${formatCurrency((invoice.totalAmount || 0) - (invoice.paidAmount || 0))}</span>
            </div>
          </div>
          
          ${invoice.notes ? `
          <div class="info">
            <strong>ملاحظات:</strong><br>
            ${invoice.notes}
          </div>
          ` : ''}
        </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    }
    
    // Mark invoice as paid
    window.markAsPaid = function(id) {
      Swal.fire({
        title: 'تأكيد الدفع',
        text: "هل أنت متأكد من أن هذه الفاتورة تم دفعها بالكامل؟",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#6BCF7F',
        cancelButtonColor: '#6C757D',
        confirmButtonText: 'نعم، تم الدفع',
        cancelButtonText: 'إلغاء'
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading();
          safeDatabaseOperation('update', `invoices/${id}`, {
            status: 'paid',
            paidAmount: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }).then(() => {
            hideLoading();
            showSuccessToast('تم تحديث حالة الفاتورة إلى مدفوعة');
          }).catch((error) => {
            hideLoading();
            console.error('Error updating invoice:', error);
            showErrorToast('فشل في تحديث حالة الفاتورة');
          });
        }
      });
    };
    
    // Delete patient
    window.deletePatient = function(id, department) {
      Swal.fire({
        title: 'تأكيد الحذف',
        text: "هل أنت متأكد من حذف بيانات هذا المريض؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#FF6B6B',
        cancelButtonColor: '#6C757D',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
        customClass: {
          popup: 'medical-card'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading();
          safeDatabaseOperation('remove', `patients/${department}/${id}`)
            .then(() => {
              hideLoading();
              showSuccessToast('تم حذف بيانات المريض');
            })
            .catch((error) => {
              hideLoading();
              console.error('Error deleting patient:', error);
              showErrorToast('فشل في حذف بيانات المريض');
            });
        }
      });
    }
    
    // Delete doctor
    window.deleteDoctor = function(id) {
      Swal.fire({
        title: 'تأكيد الحذف',
        text: "هل أنت متأكد من حذف بيانات هذا الطبيب؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#FF6B6B',
        cancelButtonColor: '#6C757D',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
        customClass: {
          popup: 'medical-card'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading();
          safeDatabaseOperation('remove', `doctors/${id}`)
            .then(() => {
              hideLoading();
              showSuccessToast('تم حذف بيانات الطبيب');
            })
            .catch((error) => {
              hideLoading();
              console.error('Error deleting doctor:', error);
              showErrorToast('فشل في حذف بيانات الطبيب');
            });
        }
      });
    }
    
    // Delete service
    window.deleteService = function(id) {
      Swal.fire({
        title: 'تأكيد الحذف',
        text: "هل أنت متأكد من حذف هذه الخدمة؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#FF6B6B',
        cancelButtonColor: '#6C757D',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
        customClass: {
          popup: 'medical-card'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading();
          safeDatabaseOperation('remove', `services/${id}`)
            .then(() => {
              hideLoading();
              showSuccessToast('تم حذف الخدمة');
            })
            .catch((error) => {
              hideLoading();
              console.error('Error deleting service:', error);
              showErrorToast('فشل في حذف الخدمة');
            });
        }
      });
    }
    
    // Edit service
    window.editService = function(id, service) {
      const editForm = document.createElement('form');
      editForm.className = 'space-y-4';
      
      editForm.innerHTML = `
        <h3 class="text-lg font-bold mb-4 text-gray-800">تعديل الخدمة</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">اسم الخدمة</label>
            <input type="text" id="edit-service-name" value="${service.name}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">السعر</label>
            <input type="number" id="edit-service-price" value="${service.price}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">النوع</label>
            <select id="edit-service-type" class="form-input form-select" required>
              <option value="consultation" ${service.type === 'consultation' ? 'selected' : ''}>كشف طبي</option>
              <option value="xray" ${service.type === 'xray' ? 'selected' : ''}>أشعة</option>
              <option value="lab" ${service.type === 'lab' ? 'selected' : ''}>تحاليل</option>
              <option value="ecg" ${service.type === 'ecg' ? 'selected' : ''}>موجات صوتية</option>
              <option value="ultrasound" ${service.type === 'ultrasound' ? 'selected' : ''}>سونار</option>
              <option value="ct" ${service.type === 'ct' ? 'selected' : ''}>أشعة مقطعية</option>
              <option value="mri" ${service.type === 'mri' ? 'selected' : ''}>رنين مغناطيسي</option>
              <option value="surgery" ${service.type === 'surgery' ? 'selected' : ''}>عملية جراحية</option>
              <option value="medication" ${service.type === 'medication' ? 'selected' : ''}>أدوية</option>
              <option value="therapy" ${service.type === 'therapy' ? 'selected' : ''}>علاج طبيعي</option>
              <option value="vaccination" ${service.type === 'vaccination' ? 'selected' : ''}>تطعيمات</option>
              <option value="checkup" ${service.type === 'checkup' ? 'selected' : ''}>فحص شامل</option>
              <option value="other" ${service.type === 'other' ? 'selected' : ''}>أخرى</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">القسم</label>
            <select id="edit-service-department" class="form-input form-select" required>
              <option value="emergency" ${service.department === 'emergency' ? 'selected' : ''}>الطوارئ</option>
              <option value="radiology" ${service.department === 'radiology' ? 'selected' : ''}>الأشعة</option>
              <option value="lab" ${service.department === 'lab' ? 'selected' : ''}>المختبر</option>
              <option value="icu" ${service.department === 'icu' ? 'selected' : ''}>العناية المركزة</option>
              <option value="operations" ${service.department === 'operations' ? 'selected' : ''}>العمليات</option>
              <option value="cardiology" ${service.department === 'cardiology' ? 'selected' : ''}>القلب</option>
              <option value="neurology" ${service.department === 'neurology' ? 'selected' : ''}>الأعصاب</option>
              <option value="pediatrics" ${service.department === 'pediatrics' ? 'selected' : ''}>الأطفال</option>
              <option value="obstetrics" ${service.department === 'obstetrics' ? 'selected' : ''}>النساء والتوليد</option>
              <option value="orthopedics" ${service.department === 'orthopedics' ? 'selected' : ''}>العظام</option>
              <option value="internal" ${service.department === 'internal' ? 'selected' : ''}>داخلي</option>
              <option value="ent" ${service.department === 'ent' ? 'selected' : ''}>الأذن والأنف والحنجرة</option>
              <option value="ophthalmology" ${service.department === 'ophthalmology' ? 'selected' : ''}>العيون</option>
              <option value="dermatology" ${service.department === 'dermatology' ? 'selected' : ''}>الجلدية</option>
              <option value="psychiatry" ${service.department === 'psychiatry' ? 'selected' : ''}>الطب النفسي</option>
              <option value="physiotherapy" ${service.department === 'physiotherapy' ? 'selected' : ''}>العلاج الطبيعي</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">الوصف</label>
          <textarea id="edit-service-description" rows="3" class="form-input">${service.description || ''}</textarea>
        </div>
      `;
      
      Swal.fire({
        title: '',
        html: editForm,
        showCancelButton: true,
        confirmButtonText: 'حفظ التعديلات',
        cancelButtonText: 'إلغاء',
        preConfirm: () => {
          const name = document.getElementById('edit-service-name').value.trim();
          const price = document.getElementById('edit-service-price').value;
          const type = document.getElementById('edit-service-type').value;
          const department = document.getElementById('edit-service-department').value;
          const description = document.getElementById('edit-service-description').value.trim();
          
          if (!name || !price || !type || !department) {
            Swal.showValidationMessage('يرجى ملء جميع الحقول الإلزامية');
            return false;
          }
          
          return { name, price, type, department, description };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const updatedData = result.value;
          
          showLoading();
          safeDatabaseOperation('update', `services/${id}`, {
            ...updatedData,
            updatedAt: new Date().toISOString()
          }).then(() => {
            hideLoading();
            showSuccessToast('تم تحديث بيانات الخدمة بنجاح');
          }).catch((error) => {
            hideLoading();
            console.error('Error updating service:', error);
            showErrorToast('فشل في تحديث بيانات الخدمة');
          });
        }
      });
    }
    
    // View patient details
    window.viewPatient = function(id, department, patient) {
      const categoryNames = {
        outpatient: 'مريض خارجي',
        inpatient: 'مريض داخلي',
        emergency: 'حالة طارئة',
        daycare: 'علاج نهاري',
        referred: 'محول من مستشفى آخر',
        vip: 'مريض VIP'
      };
      
      const categoryName = categoryNames[patient.patientCategory] || 'غير محدد';
      
      Swal.fire({
        title: 'تفاصيل المريض',
        html: `
          <div class="text-right">
            <div class="mb-4">
              <strong>الاسم:</strong> ${patient.name}<br>
              <strong>العمر:</strong> ${patient.age} سنة<br>
              <strong>الجنس:</strong> ${patient.gender === 'male' ? 'ذكر' : 'أنثى'}<br>
              <strong>فصيلة الدم:</strong> ${patient.bloodType}<br>
              <strong>الرقم القومي:</strong> ${patient.nid}<br>
              <strong>الهاتف:</strong> ${patient.phone || '---'}<br>
              <strong>الواتساب:</strong> ${patient.whatsapp || '---'}<br>
              <strong>البريد الإلكتروني:</strong> ${patient.email || '---'}<br>
              <strong>العنوان:</strong> ${patient.address}<br>
              <strong>نوع المريض:</strong> ${categoryName}<br>
              <strong>القسم:</strong> ${getDepartmentName(department)}<br>
              <strong>الطبيب:</strong> ${patient.doctorName || '---'}<br>
              <strong>الحالة:</strong> ${patient.status === 'discharged' ? 'تم الخروج' : patient.status === 'pending' ? 'في انتظار الدفع' : 'تحت العلاج'}<br>
              <strong>تاريخ التسجيل:</strong> ${formatDate(patient.timestamp)}<br>
              ${patient.dischargeDate ? `<strong>تاريخ الخروج:</strong> ${formatDate(patient.dischargeDate)}<br>` : ''}
              ${patient.diseases ? `<strong>ملاحظات:</strong> ${patient.diseases}` : ''}
            </div>
          </div>
        `,
        confirmButtonText: 'إغلاق',
        customClass: {
          popup: 'medical-card'
        }
      });
    }
    
    // Edit patient
    window.editPatient = function(id, department, patient) {
      const editForm = document.createElement('form');
      editForm.className = 'space-y-4';
      
      editForm.innerHTML = `
        <h3 class="text-lg font-bold mb-4 text-gray-800">تعديل بيانات المريض</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">الاسم</label>
            <input type="text" id="edit-name" value="${patient.name}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">العمر</label>
            <input type="number" id="edit-age" value="${patient.age}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">الرقم القومي</label>
            <input type="text" id="edit-nid" value="${patient.nid}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">الجنس</label>
            <select id="edit-gender" class="form-input form-select" required>
              <option value="male" ${patient.gender === 'male' ? 'selected' : ''}>ذكر</option>
              <option value="female" ${patient.gender === 'female' ? 'selected' : ''}>أنثى</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">رقم الهاتف</label>
            <input type="tel" id="edit-phone" value="${patient.phone || ''}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">رقم الواتساب</label>
            <input type="tel" id="edit-whatsapp" value="${patient.whatsapp || ''}" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" id="edit-email" value="${patient.email || ''}" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">العنوان</label>
            <input type="text" id="edit-address" value="${patient.address}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">فصيلة الدم</label>
            <select id="edit-bloodType" class="form-input form-select" required>
              <option value="A+" ${patient.bloodType === 'A+' ? 'selected' : ''}>A+</option>
              <option value="A-" ${patient.bloodType === 'A-' ? 'selected' : ''}>A-</option>
              <option value="B+" ${patient.bloodType === 'B+' ? 'selected' : ''}>B+</option>
              <option value="B-" ${patient.bloodType === 'B-' ? 'selected' : ''}>B-</option>
              <option value="AB+" ${patient.bloodType === 'AB+' ? 'selected' : ''}>AB+</option>
              <option value="AB-" ${patient.bloodType === 'AB-' ? 'selected' : ''}>AB-</option>
              <option value="O+" ${patient.bloodType === 'O+' ? 'selected' : ''}>O+</option>
              <option value="O-" ${patient.bloodType === 'O-' ? 'selected' : ''}>O-</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">نوع المريض</label>
            <select id="edit-patientCategory" class="form-input form-select" required>
              <option value="outpatient" ${patient.patientCategory === 'outpatient' ? 'selected' : ''}>مريض خارجي</option>
              <option value="inpatient" ${patient.patientCategory === 'inpatient' ? 'selected' : ''}>مريض داخلي</option>
              <option value="emergency" ${patient.patientCategory === 'emergency' ? 'selected' : ''}>حالة طارئة</option>
              <option value="daycare" ${patient.patientCategory === 'daycare' ? 'selected' : ''}>علاج نهاري</option>
              <option value="referred" ${patient.patientCategory === 'referred' ? 'selected' : ''}>محول من مستشفى آخر</option>
              <option value="vip" ${patient.patientCategory === 'vip' ? 'selected' : ''}>مريض VIP</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ملاحظات طبية</label>
          <textarea id="edit-diseases" rows="3" class="form-input">${patient.diseases || ''}</textarea>
        </div>
      `;
      
      Swal.fire({
        title: '',
        html: editForm,
        showCancelButton: true,
        confirmButtonText: 'حفظ التعديلات',
        cancelButtonText: 'إلغاء',
        preConfirm: () => {
          const name = document.getElementById('edit-name').value.trim();
          const age = document.getElementById('edit-age').value.trim();
          const nid = document.getElementById('edit-nid').value.trim();
          const gender = document.getElementById('edit-gender').value;
          const phone = document.getElementById('edit-phone').value.trim();
          const whatsapp = document.getElementById('edit-whatsapp').value.trim();
          const email = document.getElementById('edit-email').value.trim();
          const address = document.getElementById('edit-address').value.trim();
          const bloodType = document.getElementById('edit-bloodType').value;
          const patientCategory = document.getElementById('edit-patientCategory').value;
          
          if (!name || !age || !nid || !gender || !phone || !address || !bloodType || !patientCategory) {
            Swal.showValidationMessage('يرجى ملء جميع الحقول الإلزامية');
            return false;
          }
          
          return {
            name, age, nid, gender, phone, whatsapp, email, address, bloodType, patientCategory,
            diseases: document.getElementById('edit-diseases').value.trim()
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const updatedData = result.value;
          
          showLoading();
          safeDatabaseOperation('update', `patients/${department}/${id}`, {
            ...updatedData,
            timestamp: new Date().toISOString()
          }).then(() => {
            hideLoading();
            showSuccessToast('تم تحديث بيانات المريض بنجاح');
          }).catch((error) => {
            hideLoading();
            console.error('Error updating patient:', error);
            showErrorToast('فشل في تحديث بيانات المريض');
          });
        }
      });
    }
    
    // Edit doctor
    window.editDoctor = function(id, doctor) {
      const editForm = document.createElement('form');
      editForm.className = 'space-y-4';
      
      editForm.innerHTML = `
        <h3 class="text-lg font-bold mb-4 text-gray-800">تعديل بيانات الطبيب</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">الاسم</label>
            <input type="text" id="edit-doctor-name" value="${doctor.name}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">التخصص</label>
            <input type="text" id="edit-doctor-specialization" value="${doctor.specialization}" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">القسم</label>
            <select id="edit-doctor-department" class="form-input form-select" required>
              <option value="emergency" ${doctor.department === 'emergency' ? 'selected' : ''}>الطوارئ</option>
              <option value="radiology" ${doctor.department === 'radiology' ? 'selected' : ''}>الأشعة</option>
              <option value="icu" ${doctor.department === 'icu' ? 'selected' : ''}>العناية المركزة</option>
              <option value="operations" ${doctor.department === 'operations' ? 'selected' : ''}>العمليات</option>
              <option value="cardiology" ${doctor.department === 'cardiology' ? 'selected' : ''}>القلب</option>
              <option value="neurology" ${doctor.department === 'neurology' ? 'selected' : ''}>الأعصاب</option>
              <option value="pediatrics" ${doctor.department === 'pediatrics' ? 'selected' : ''}>الأطفال</option>
              <option value="obstetrics" ${doctor.department === 'obstetrics' ? 'selected' : ''}>النساء والتوليد</option>
              <option value="orthopedics" ${doctor.department === 'orthopedics' ? 'selected' : ''}>العظام</option>
              <option value="internal" ${doctor.department === 'internal' ? 'selected' : ''}>الباطنة</option>
              <option value="ent" ${doctor.department === 'ent' ? 'selected' : ''}>الأذن والأنف والحنجرة</option>
              <option value="ophthalmology" ${doctor.department === 'ophthalmology' ? 'selected' : ''}>العيون</option>
              <option value="dermatology" ${doctor.department === 'dermatology' ? 'selected' : ''}>الجلدية</option>
              <option value="psychiatry" ${doctor.department === 'psychiatry' ? 'selected' : ''}>الطب النفسي</option>
              <option value="physiotherapy" ${doctor.department === 'physiotherapy' ? 'selected' : ''}>العلاج الطبيعي</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ساعات العمل</label>
            <div class="grid grid-cols-2 gap-2">
              <input type="time" id="edit-work-from" value="${doctor.workFrom || ''}" class="form-input" required />
              <input type="time" id="edit-work-to" value="${doctor.workTo || ''}" class="form-input" required />
            </div>
          </div>
        </div>
      `;
      
      Swal.fire({
        title: '',
        html: editForm,
        showCancelButton: true,
        confirmButtonText: 'حفظ التعديلات',
        cancelButtonText: 'إلغاء',
        preConfirm: () => {
          const name = document.getElementById('edit-doctor-name').value.trim();
          const specialization = document.getElementById('edit-doctor-specialization').value.trim();
          const department = document.getElementById('edit-doctor-department').value;
          const workFrom = document.getElementById('edit-work-from').value;
          const workTo = document.getElementById('edit-work-to').value;
          
          if (!name || !specialization || !department || !workFrom || !workTo) {
            Swal.showValidationMessage('يرجى ملء جميع الحقول الإلزامية');
            return false;
          }
          
          return { name, specialization, department, workFrom, workTo };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const updatedData = result.value;
          
          showLoading();
          safeDatabaseOperation('update', `doctors/${id}`, {
            ...updatedData,
            timestamp: new Date().toISOString()
          }).then(() => {
            hideLoading();
            showSuccessToast('تم تحديث بيانات الطبيب بنجاح');
          }).catch((error) => {
            hideLoading();
            console.error('Error updating doctor:', error);
            showErrorToast('فشل في تحديث بيانات الطبيب');
          });
        }
      });
    }
    
    // Quick book appointment
    window.quickBookAppointment = function(doctorId, doctorName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector('[data-tab="appointments"]').classList.add('active');
      document.getElementById('appointmentsTab').classList.add('active');
      
      appointmentDoctor.value = doctorId;
      generateTimeSlots(doctorId, appointmentDate.value);
      
      document.getElementById('appointmentsTab').scrollIntoView({ behavior: 'smooth' });
    };
    
    // Get payment method text
    function getPaymentMethodText(method) {
      const methods = {
        cash: 'نقدي',
        card: 'بطاقة ائتمان',
        insurance: 'تأمين'
      };
      return methods[method] || method;
    }
    
    // Print report function
    printReportBtn.addEventListener('click', () => {
      window.print();
    });
    
    // Export PDF function
    exportPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFont('Cairo', 'normal');
      doc.setFontSize(18);
      doc.text('تقرير المرضى - مستشفى الحياة الذكية', 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text(`التاريخ: ${new Date().toLocaleDateString("ar-EG")}`, 105, 25, { align: 'center' });
      
      doc.setFontSize(14);
      doc.text('قائمة المرضى', 20, 40);
      
      doc.setFontSize(10);
      let y = 50;
      
      safeDatabaseOperation('once', 'patients')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          let patientCount = 0;
          
          Object.entries(data).forEach(([dept, patients]) => {
            Object.entries(patients).forEach(([id, patient]) => {
              if (patientCount > 0) y += 10;
              doc.text(`${patientCount + 1}. ${patient.name} - ${dept}`, 20, y);
              doc.text(`   العمر: ${patient.age} | الجنس: ${patient.gender === 'male' ? 'ذكر' : 'أنثى'} | الرقم القومي: ${patient.nid}`, 20, y + 5);
              patientCount++;
            });
          });
          
          doc.save('تقرير-المرضى.pdf');
          hideLoading();
        })
        .catch((error) => {
          hideLoading();
          console.error('Error generating PDF:', error);
          showErrorToast('فشل في إنشاء ملف PDF');
        });
      
      showLoading();
    });
    
    // Update statistics
    function updateStats() {
      if (connectionStatus !== 'connected') {
        console.warn('Cannot update stats: not connected to database');
        return;
      }
      
      showLoading();
      const todayDate = new Date().toDateString();
      let total = 0, todayCount = 0, emergency = 0;
      
      safeDatabaseOperation('once', 'patients')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          
          Object.values(data).forEach(dept => {
            Object.values(dept).forEach(patient => {
              total++;
              if (new Date(patient.timestamp).toDateString() === todayDate) todayCount++;
              if (patient.department === 'emergency') emergency++;
            });
          });
          
          totalPatientsElement.textContent = total;
          todayPatientsElement.textContent = todayCount;
          emergencyPatientsElement.textContent = emergency;
          
          hideLoading();
        })
        .catch((error) => {
          hideLoading();
          console.error('Error updating stats:', error);
          showErrorToast('فشل في تحديث الإحصائيات');
        });
    }
    
    // Initialize charts
    function initializeCharts() {
      const deptCtx = document.getElementById('departmentChart').getContext('2d');
      const deptChart = new Chart(deptCtx, {
        type: 'bar',
        data: {
          labels: ['الطوارئ', 'العناية المركزة', 'العمليات', 'الرعاية', 'الإدارة', 'الأشعة'],
          datasets: [{
            label: 'عدد المرضى',
            data: [0, 0, 0, 0, 0, 0],
            backgroundColor: [
              'rgba(255, 107, 107, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(0, 102, 204, 0.7)',
              'rgba(107, 207, 127, 0.7)',
              'rgba(108, 117, 125, 0.7)',
              'rgba(14, 165, 233, 0.7)'
            ],
            borderColor: [
              'rgb(255, 107, 107)',
              'rgb(139, 92, 246)',
              'rgb(0, 102, 204)',
              'rgb(107, 207, 127)',
              'rgb(108, 117, 125)',
              'rgb(14, 165, 233)'
            ],
            borderWidth: 1,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              grid: { borderDash: [5, 5] }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
      
      const dailyCtx = document.getElementById('dailyChart').getContext('2d');
      const dailyChart = new Chart(dailyCtx, {
        type: 'line',
        data: {
          labels: ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'],
          datasets: [{
            label: 'عدد المرضى',
            data: [0, 0, 0, 0, 0, 0, 0],
            fill: true,
            backgroundColor: 'rgba(0, 102, 204, 0.1)',
            borderColor: 'rgb(0, 102, 204)',
            tension: 0.4,
            pointBackgroundColor: 'rgb(0, 102, 204)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              grid: { borderDash: [5, 5] }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
      
      const bloodCtx = document.getElementById('bloodTypeChart').getContext('2d');
      const bloodChart = new Chart(bloodCtx, {
        type: 'doughnut',
        data: {
          labels: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'],
          datasets: [{
            label: 'فصيلة الدم',
            data: [0, 0, 0, 0, 0, 0, 0, 0],
            backgroundColor: [
              'rgba(255, 107, 107, 0.7)',
              'rgba(255, 107, 107, 0.5)',
              'rgba(0, 102, 204, 0.7)',
              'rgba(0, 102, 204, 0.5)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(139, 92, 246, 0.5)',
              'rgba(107, 207, 127, 0.7)',
              'rgba(107, 207, 127, 0.5)'
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                font: { size: 12 }
              }
            }
          }
        }
      });
      
      // Update charts with real data
      if (connectionStatus === 'connected') {
        safeDatabaseOperation('once', 'patients')
          .then((snapshot) => {
            const data = snapshot.val() || {};
            const deptCounts = [0, 0, 0, 0, 0, 0];
            const bloodCounts = [0, 0, 0, 0, 0, 0, 0, 0];
            
            Object.values(data).forEach(dept => {
              Object.values(dept).forEach(patient => {
                const deptIndex = getDepartmentIndex(patient.department);
                if (deptIndex !== -1) deptCounts[deptIndex]++;
                
                const bloodIndex = getBloodTypeIndex(patient.bloodType);
                if (bloodIndex !== -1) bloodCounts[bloodIndex]++;
              });
            });
            
            deptChart.data.datasets[0].data = deptCounts;
            deptChart.update();
            
            bloodChart.data.datasets[0].data = bloodCounts;
            bloodChart.update();
            
            const dailyCounts = [0, 0, 0, 0, 0, 0, 0];
            Object.values(data).forEach(dept => {
              Object.values(dept).forEach(patient => {
                const patientDate = new Date(patient.timestamp);
                const patientDay = patientDate.getDay();
                if (patientDay >= 0 && patientDay <= 6) {
                  dailyCounts[patientDay]++;
                }
              });
            });
            
            dailyChart.data.datasets[0].data = dailyCounts;
            dailyChart.update();
          })
          .catch((error) => {
            console.error('Error updating charts:', error);
          });
      }
    }
    
    function getDepartmentIndex(department) {
      const departments = ['emergency', 'icu', 'surgery', 'care', 'admin', 'radiology'];
      return departments.indexOf(department);
    }
    
    function getBloodTypeIndex(bloodType) {
      const bloodTypes = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
      return bloodTypes.indexOf(bloodType);
    }
    
    // Form submission for patient
    patientForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (connectionStatus !== 'connected') {
        showErrorToast('غير متصل بقاعدة البيانات. يرجى المحاولة مرة أخرى.');
        return;
      }
      
      const selectedDoctor = document.getElementById("doctorSelect").value;
      let doctorName = '';
      
      if (selectedDoctor) {
        const selectedOption = doctorSelect.options[doctorSelect.selectedIndex];
        doctorName = selectedOption.textContent.split(' - ')[0];
      }
      
      const formData = {
        name: document.getElementById("name").value.trim(),
        age: document.getElementById("age").value.trim(),
        nid: document.getElementById("nid").value.trim(),
        gender: document.getElementById("gender").value,
        phone: document.getElementById("phone").value.trim(),
        whatsapp: document.getElementById("whatsapp").value.trim(),
        email: document.getElementById("email").value.trim(),
        address: document.getElementById("address").value.trim(),
        bloodType: document.getElementById("bloodType").value,
        diseases: document.getElementById("diseases").value.trim(),
        patientCategory: document.getElementById("patientCategory").value,
        department: document.getElementById("department").value,
        doctorId: selectedDoctor,
        doctorName: doctorName,
        status: 'active',
        timestamp: new Date().toISOString()
      };
      
      if (!formData.name || !formData.age || !formData.nid || !formData.gender || 
          !formData.address || !formData.bloodType || !formData.patientCategory || !formData.department) {
        Swal.fire({
          icon: 'warning',
          title: 'بيانات ناقصة',
          text: 'يرجى ملء جميع الحقول الإلزامية',
          confirmButtonText: 'حسناً'
        });
        return;
      }
      
      try {
        showLoading();
        await safeDatabaseOperation('push', `patients/${formData.department}`, formData);
        
        showSuccessToast(`تم تسجيل المريض ${formData.name}`);
        patientForm.reset();
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error registering patient:', error);
        showErrorToast('حدث خطأ أثناء التسجيل');
      }
    });
    
    // Form submission for appointment
    appointmentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (connectionStatus !== 'connected') {
        showErrorToast('غير متصل بقاعدة البيانات. يرجى المحاولة مرة أخرى.');
        return;
      }
      
      const selectedTime = document.querySelector('.time-slot.selected');
      if (!selectedTime) {
        Swal.fire({
          icon: 'warning',
          title: 'وقت غير محدد',
          text: 'يرجى اختيار وقت للموعد',
          confirmButtonText: 'حسناً'
        });
        return;
      }
      
      const patientId = document.getElementById("appointmentPatient").value;
      const doctorId = document.getElementById("appointmentDoctor").value;
      const date = document.getElementById("appointmentDate").value;
      const time = selectedTime.dataset.time;
      const reason = document.getElementById("appointmentReason").value.trim();
      
      const patientOption = appointmentPatient.options[appointmentPatient.selectedIndex];
      const doctorOption = appointmentDoctor.options[appointmentDoctor.selectedIndex];
      
      const patientName = patientOption.textContent.split(' - ')[0];
      const doctorName = doctorOption.textContent.split(' - ')[0];
      
      const formData = {
        patientId,
        patientName,
        doctorId,
        doctorName,
        date,
        time,
        reason,
        status: 'scheduled',
        timestamp: new Date().toISOString()
      };
      
      try {
        showLoading();
        await safeDatabaseOperation('push', 'appointments', formData);
        
        showSuccessToast(`تم حجز موعد للمريض ${patientName} مع د. ${doctorName}`);
        appointmentForm.reset();
        timeSlots.innerHTML = '';
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error booking appointment:', error);
        showErrorToast('حدث خطأ أثناء الحجز');
      }
    });
    
    // Form submission for service
    serviceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (connectionStatus !== 'connected') {
        showErrorToast('غير متصل بقاعدة البيانات. يرجى المحاولة مرة أخرى.');
        return;
      }
      
      const formData = {
        name: document.getElementById("serviceName").value.trim(),
        type: document.getElementById("serviceType").value,
        department: document.getElementById("serviceDepartment").value,
        price: parseFloat(document.getElementById("servicePrice").value),
        description: document.getElementById("serviceDescription").value.trim(),
        timestamp: new Date().toISOString()
      };
      
      if (!formData.name || !formData.type || !formData.department || !formData.price) {
        Swal.fire({
          icon: 'warning',
          title: 'بيانات ناقصة',
          text: 'يرجى ملء جميع الحقول الإلزامية',
          confirmButtonText: 'حسناً'
        });
        return;
      }
      
      try {
        showLoading();
        await safeDatabaseOperation('push', 'services', formData);
        
        showSuccessToast(`تم إضافة الخدمة ${formData.name}`);
        serviceForm.reset();
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error adding service:', error);
        showErrorToast('حدث خطأ أثناء الإضافة');
      }
    });
    
    // Tab navigation
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');
        
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        button.classList.add('active');
        document.getElementById(`${tabName}Tab`).classList.add('active');
      });
    });
    
    // Filter and search listeners
    filterDepartment.addEventListener('change', () => {
      const filter = filterDepartment.value;
      const statusFilter = filterStatus.value;
      const searchTerm = searchPatient.value;
      
      safeDatabaseOperation('once', 'patients')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          let allPatients = {};
          
          Object.entries(data).forEach(([dept, patients]) => {
            Object.entries(patients).forEach(([id, patient]) => {
              if (!allPatients[id]) {
                allPatients[id] = { ...patient, department: dept };
              }
            });
          });
          
          renderPatients(allPatients, filter, statusFilter, searchTerm);
        })
        .catch((error) => {
          console.error('Error filtering patients:', error);
        });
    });
    
    filterStatus.addEventListener('change', () => {
      const filter = filterDepartment.value;
      const statusFilter = filterStatus.value;
      const searchTerm = searchPatient.value;
      
      safeDatabaseOperation('once', 'patients')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          let allPatients = {};
          
          Object.entries(data).forEach(([dept, patients]) => {
            Object.entries(patients).forEach(([id, patient]) => {
              if (!allPatients[id]) {
                allPatients[id] = { ...patient, department: dept };
              }
            });
          });
          
          renderPatients(allPatients, filter, statusFilter, searchTerm);
        })
        .catch((error) => {
          console.error('Error filtering patients:', error);
        });
    });
    
    filterDoctorDepartment.addEventListener('change', () => {
      const filter = filterDoctorDepartment.value;
      const searchTerm = searchDoctorAll.value;
      
      safeDatabaseOperation('once', 'doctors')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          renderDoctors(data, filter, searchTerm);
        })
        .catch((error) => {
          console.error('Error filtering doctors:', error);
        });
    });
    
    filterDoctorSpecialization.addEventListener('change', () => {
      const specializationFilter = filterDoctorSpecialization.value;
      const searchTerm = searchDoctor.value;
      
      safeDatabaseOperation('once', 'doctors')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          renderAvailableDoctors(data, specializationFilter, searchTerm);
        })
        .catch((error) => {
          console.error('Error filtering available doctors:', error);
        });
    });
    
    filterServiceType.addEventListener('change', () => {
      const typeFilter = filterServiceType.value;
      const searchTerm = searchService.value;
      
      safeDatabaseOperation('once', 'services')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          renderServices(data, typeFilter, searchTerm);
        })
        .catch((error) => {
          console.error('Error filtering services:', error);
        });
    });
    
    searchPatient.addEventListener('input', () => {
      const filter = filterDepartment.value;
      const statusFilter = filterStatus.value;
      const searchTerm = searchPatient.value;
      
      safeDatabaseOperation('once', 'patients')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          let allPatients = {};
          
          Object.entries(data).forEach(([dept, patients]) => {
            Object.entries(patients).forEach(([id, patient]) => {
              if (!allPatients[id]) {
                allPatients[id] = { ...patient, department: dept };
              }
            });
          });
          
          renderPatients(allPatients, filter, statusFilter, searchTerm);
        })
        .catch((error) => {
          console.error('Error searching patients:', error);
        });
    });
    
    searchDoctor.addEventListener('input', () => {
      const specializationFilter = filterDoctorSpecialization.value;
      const searchTerm = searchDoctor.value;
      
      safeDatabaseOperation('once', 'doctors')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          renderAvailableDoctors(data, specializationFilter, searchTerm);
        })
        .catch((error) => {
          console.error('Error searching available doctors:', error);
        });
    });
    
    searchDoctorAll.addEventListener('input', () => {
      const filter = filterDoctorDepartment.value;
      const searchTerm = searchDoctorAll.value;
      
      safeDatabaseOperation('once', 'doctors')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          renderDoctors(data, filter, searchTerm);
        })
        .catch((error) => {
          console.error('Error searching doctors:', error);
        });
    });
    
    searchService.addEventListener('input', () => {
      const typeFilter = filterServiceType.value;
      const searchTerm = searchService.value;
      
      safeDatabaseOperation('once', 'services')
        .then((snapshot) => {
          const data = snapshot.val() || {};
          renderServices(data, typeFilter, searchTerm);
        })
        .catch((error) => {
          console.error('Error searching services:', error);
        });
    });
    
    appointmentDoctor.addEventListener('change', () => {
      const doctorId = appointmentDoctor.value;
      const date = appointmentDate.value;
      generateTimeSlots(doctorId, date);
    });
    
    appointmentDate.addEventListener('change', () => {
      const doctorId = appointmentDoctor.value;
      const date = appointmentDate.value;
      generateTimeSlots(doctorId, date);
    });
    
    // Load invoices
    function loadInvoices() {
      if (connectionStatus !== 'connected') {
        console.warn('Cannot load invoices: not connected to database');
        return;
      }
      
      safeDatabaseOperation('once', 'invoices')
        .then((snapshot) => {
          const invoices = snapshot.val() || {};
          renderInvoices(invoices);
          updateInvoiceStats(invoices);
        })
        .catch((error) => {
          console.error('Error loading invoices:', error);
          showErrorToast('فشل في تحميل الفواتير');
        });
    }
    
    // Render invoices table
    function renderInvoices(invoices) {
      invoicesTableBody.innerHTML = '';
      
      if (Object.keys(invoices).length === 0) {
        invoicesTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-8 text-gray-500">
              <i class="fas fa-file-invoice text-4xl mb-2 block"></i>
              لا توجد فواتير مسجلة
            </td>
          </tr>
        `;
        return;
      }
      
      Object.entries(invoices).forEach(([id, invoice]) => {
        const row = document.createElement('tr');
        
        const statusClass = invoice.status === 'paid' ? 'status-active' : 
                           invoice.status === 'pending' ? 'status-pending' : 'status-discharged';
        
        const statusText = invoice.status === 'paid' ? 'مدفوعة' : 
                          invoice.status === 'pending' ? 'معلقة' : 'ملغاة';
        
        row.innerHTML = `
          <td class="font-semibold">${invoice.invoiceNumber}</td>
          <td>${invoice.patientName}</td>
          <td>${formatDate(invoice.date)}</td>
          <td class="font-semibold">${formatCurrency(invoice.totalAmount)}</td>
          <td class="text-green-600">${formatCurrency(invoice.paidAmount || 0)}</td>
          <td class="text-orange-600">${formatCurrency((invoice.totalAmount || 0) - (invoice.paidAmount || 0))}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>
            <div class="flex gap-2">
              <button class="action-btn btn-view" onclick="viewInvoice('${id}', ${JSON.stringify(invoice).replace(/"/g, '&quot;')})">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn btn-invoice" onclick="printInvoiceById('${id}')">
                <i class="fas fa-print"></i>
              </button>
              ${invoice.status === 'pending' ? `
              <button class="action-btn btn-success" onclick="markAsPaid('${id}')">
                <i class="fas fa-check"></i>
              </button>
              ` : ''}
            </div>
          </td>
        `;
        
        invoicesTableBody.appendChild(row);
      });
    }
    
    // Update invoice statistics
    function updateInvoiceStats(invoices) {
      const invoicesArray = Object.values(invoices);
      
      const totalInvoices = invoicesArray.length;
      const paidInvoices = invoicesArray.filter(inv => inv.status === 'paid').length;
      const pendingInvoices = invoicesArray.filter(inv => inv.status === 'pending').length;
      const totalRevenue = invoicesArray
        .filter(inv => inv.status === 'paid')
        .reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
      
      const todayRevenue = invoicesArray
        .filter(inv => inv.status === 'paid' && new Date(inv.date).toDateString() === today.toDateString())
        .reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
      
      totalInvoicesElement.textContent = totalInvoices;
      paidInvoicesElement.textContent = paidInvoices;
      pendingInvoicesElement.textContent = pendingInvoices;
      totalRevenueElement.textContent = formatCurrency(totalRevenue);
      dailyRevenueElement.textContent = formatCurrency(todayRevenue);
    }
    
    // Print all invoices
    printAllInvoicesBtn.addEventListener('click', () => {
      safeDatabaseOperation('once', 'invoices')
        .then((snapshot) => {
          const invoices = snapshot.val() || {};
          
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`
            <html dir="rtl">
            <head>
              <title>جميع الفواتير</title>
              <style>
                body { font-family: 'Cairo', sans-serif; padding: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .invoice { margin-bottom: 30px; page-break-inside: avoid; }
                .invoice-header { border-bottom: 2px solid #000; padding-bottom: 10px; }
                .invoice-body { margin: 20px 0; }
                .service-item { padding: 5px 0; border-bottom: 1px solid #ddd; }
                .summary { margin-top: 10px; }
                .summary-row { display: flex; justify-content: space-between; }
                .total { font-weight: bold; border-top: 2px solid #000; padding-top: 5px; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>مستشفى الحياة الذكية</h1>
                <h2>تقرير الفواتير</h2>
                <p>التاريخ: ${new Date().toLocaleDateString('ar-EG')}</p>
              </div>
              
              ${Object.entries(invoices).map(([id, invoice]) => `
                <div class="invoice">
                  <div class="invoice-header">
                    <h3>فاتورة رقم: ${invoice.invoiceNumber}</h3>
                    <p>المريض: ${invoice.patientName} | التاريخ: ${formatDate(invoice.date)}</p>
                  </div>
                  <div class="invoice-body">
                    <div class="service-item">
                      <strong>الخدمات:</strong><br>
                      ${invoice.services ? invoice.services.map(s => `• ${s.name}: ${formatCurrency(s.price)} × ${s.quantity}`).join('<br>') : ''}
                    </div>
                    <div class="summary">
                      <div class="summary-row">
                        <span>المجموع الفرعي:</span>
                        <span>${formatCurrency(invoice.subtotal || 0)}</span>
                      </div>
                      ${invoice.discount ? `
                      <div class="summary-row">
                        <span>الخصم:</span>
                        <span>${formatCurrency(invoice.discount)}</span>
                      </div>
                      ` : ''}
                      ${invoice.coverage ? `
                      <div class="summary-row">
                        <span>تغطية التأمين:</span>
                        <span>${formatCurrency(invoice.coverage)}</span>
                      </div>
                      ` : ''}
                      <div class="total">
                        <span>المبلغ الإجمالي:</span>
                        <span>${formatCurrency(invoice.totalAmount)}</span>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </body>
            </html>
          `);
          
          printWindow.document.close();
          printWindow.print();
        })
        .catch((error) => {
          console.error('Error printing all invoices:', error);
          showErrorToast('فشل في طباعة الفواتير');
        });
    });
    
    // Real-time data listeners
    function setupDataListeners() {
      if (connectionStatus !== 'connected') {
        console.warn('Cannot setup data listeners: not connected to database');
        return;
      }
      
      // Listen for patients changes
      database.ref('patients').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const filter = filterDepartment.value;
        const statusFilter = filterStatus.value;
        const searchTerm = searchPatient.value;
        
        let allPatients = {};
        Object.entries(data).forEach(([dept, patients]) => {
          Object.entries(patients).forEach(([id, patient]) => {
            if (!allPatients[id]) {
              allPatients[id] = { ...patient, department: dept };
            }
          });
        });
        
        renderPatients(allPatients, filter, statusFilter, searchTerm);
        updateStats();
      });
      
      // Listen for doctors changes
      database.ref('doctors').on('value', (snapshot) => {
        const doctors = snapshot.val() || {};
        const deptFilter = filterDoctorDepartment.value;
        const searchTermAll = searchDoctorAll.value;
        const specializationFilter = filterDoctorSpecialization.value;
        const searchTermAvailable = searchDoctor.value;
        
        renderDoctors(doctors, deptFilter, searchTermAll);
        renderAvailableDoctors(doctors, specializationFilter, searchTermAvailable);
        updateAvailableDoctorsCount(doctors);
        loadAvailableDoctorsForPatientForm();
        loadDoctorsForAppointmentForm();
      });
      
      // Listen for services changes
      database.ref('services').on('value', (snapshot) => {
        const services = snapshot.val() || {};
        const typeFilter = filterServiceType.value;
        const searchTerm = searchService.value;
        
        renderServices(services, typeFilter, searchTerm);
        loadServicesForSelection(services);
      });
      
      // Listen for invoices changes
      database.ref('invoices').on('value', (snapshot) => {
        const invoices = snapshot.val() || {};
        renderInvoices(invoices);
        updateInvoiceStats(invoices);
      });
    }
    
    // Update data every minute
    setInterval(() => {
      if (connectionStatus === 'connected') {
        safeDatabaseOperation('once', 'doctors')
          .then((snapshot) => {
            const doctors = snapshot.val() || {};
            renderAvailableDoctors(doctors, filterDoctorSpecialization.value, searchDoctor.value);
            updateAvailableDoctorsCount(doctors);
          })
          .catch((error) => {
            console.error('Error updating available doctors:', error);
          });
        
        // Update daily revenue
        safeDatabaseOperation('once', 'invoices')
          .then((snapshot) => {
            const invoices = snapshot.val() || {};
            const todayRevenue = Object.values(invoices)
              .filter(inv => inv.status === 'paid' && new Date(inv.date).toDateString() === today.toDateString())
              .reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
            
            dailyRevenueElement.textContent = formatCurrency(todayRevenue);
          })
          .catch((error) => {
            console.error('Error updating daily revenue:', error);
          });
      }
    }, 60000);
    
    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for connection to be established
      const checkConnection = setInterval(() => {
        if (connectionStatus === 'connected') {
          clearInterval(checkConnection);
          setupDataListeners();
          initializeCharts();
          loadAvailableDoctorsForPatientForm();
          loadDoctorsForAppointmentForm();
          loadPatientsForForms();
          loadServices();
          loadInvoices();
          updateStats();
        }
      }, 1000);
      
      // Timeout after 10 seconds
      setTimeout(() => {
        clearInterval(checkConnection);
        if (connectionStatus !== 'connected') {
          showErrorToast('فشل الاتصال بقاعدة البيانات. يرجى التحقق من اتصالك بالإنترنت.');
        }
      }, 10000);
    });
  </script>
</body>
</html>
