<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة استقبال المرضى - مستشفى الحياة الذكية</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  body { font-family: 'Tajawal', sans-serif; }
</style>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-5xl">

  <header class="mb-8 bg-blue-600 p-4 rounded-lg shadow text-white flex justify-between items-center">
    <h1 class="text-2xl font-bold">مستشفى الحياة الذكية</h1>
    <div id="currentDate" class="text-sm"></div>
  </header>

  <!-- إحصائيات المرضى -->
  <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h3 class="text-sm text-gray-500 mb-1">إجمالي المرضى</h3>
      <div id="totalPatients" class="text-2xl font-bold text-blue-700">--</div>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h3 class="text-sm text-gray-500 mb-1">المسجلين اليوم</h3>
      <div id="todayPatients" class="text-2xl font-bold text-green-600">--</div>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h3 class="text-sm text-gray-500 mb-1">قسم الطوارئ</h3>
      <div id="emergencyCount" class="text-2xl font-bold text-red-600">--</div>
    </div>
  </section>

  <!-- نموذج تسجيل مريض -->
  <section class="bg-white p-6 rounded-xl shadow mb-8">
    <h2 class="text-xl font-bold mb-4">تسجيل مريض جديد</h2>
    <form id="patientForm" class="space-y-4">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="name" placeholder="اسم المريض" class="border p-2 rounded" required />
        <input type="number" id="age" placeholder="العمر" class="border p-2 rounded" required />
        <input type="text" id="nid" placeholder="الرقم القومي (14 رقم)" maxlength="14" class="border p-2 rounded" required />
        <select id="gender" class="border p-2 rounded" required>
          <option value="">الجنس</option>
          <option value="male">ذكر</option>
          <option value="female">أنثى</option>
        </select>
        <input type="text" id="address" placeholder="العنوان" class="border p-2 rounded" required />
        <select id="bloodType" class="border p-2 rounded" required>
          <option value="">فصيلة الدم</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>
      </div>

      <textarea id="diseases" placeholder="الأمراض المزمنة / ملاحظات" rows="3" class="border p-2 rounded w-full"></textarea>

      <select id="department" class="border p-2 rounded w-full" required>
        <option value="">اختر القسم</option>
        <option value="emergency">الطوارئ</option>
        <option value="icu">العناية المركزة</option>
        <option value="surgery">العمليات</option>
        <option value="care">الرعاية</option>
        <option value="admin">الإدارة</option>
      </select>

      <button type="submit" class="bg-blue-600 text-white rounded p-3 w-full hover:bg-blue-700">
        تسجيل المريض
      </button>
    </form>
  </section>

  <!-- قائمة مرضى الطوارئ -->
  <section class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-xl font-bold mb-4">مرضى قسم الطوارئ</h2>
    <div id="patientsList" class="space-y-4">
      <!-- المرضى سيظهرون هنا -->
    </div>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const currentDateElem = document.getElementById("currentDate");
currentDateElem.textContent = new Date().toLocaleDateString("ar-EG", {
  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
});

const form = document.getElementById("patientForm");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const age = document.getElementById("age").value.trim();
  const nid = document.getElementById("nid").value.trim();
  const gender = document.getElementById("gender").value;
  const address = document.getElementById("address").value.trim();
  const bloodType = document.getElementById("bloodType").value;
  const diseases = document.getElementById("diseases").value.trim();
  const department = document.getElementById("department").value;

  if (!name || !age || !nid || !gender || !address || !bloodType || !department) {
    Swal.fire({ icon: 'warning', title: 'يرجى ملء جميع الحقول', confirmButtonText: 'حسناً' });
    return;
  }

  const patientData = {
    name, age, nid, gender, address, bloodType, diseases,
    timestamp: new Date().toISOString()
  };

  try {
    const patientsRef = ref(db, patients/${department});
    await push(patientsRef, patientData);

    Swal.fire({
      icon: 'success',
      title: تم تسجيل المريض وتحويله إلى قسم ${department === "emergency" ? "الطوارئ" : department},
      timer: 2500,
      showConfirmButton: false,
      position: 'top-end',
      toast: true
    });

    form.reset();
  } catch (error) {
    Swal.fire({ icon: 'error', title: 'حدث خطأ', text: error.message });
  }
});

const patientsList = document.getElementById("patientsList");
const emergencyRef = ref(db, "patients/emergency");

function renderPatients(patients) {
  patientsList.innerHTML = "";
  if (!patients) {
    patientsList.innerHTML = <p class="text-gray-500 text-center">لا يوجد مرضى في قسم الطوارئ</p>;
    return;
  }

  Object.entries(patients).forEach(([id, p]) => {
    const div = document.createElement("div");
    div.className = "border p-4 rounded-lg bg-gray-50 flex flex-col md:flex-row md:justify-between md:items-center";

    div.innerHTML = 
      <div class="mb-3 md:mb-0 max-w-lg">
        <h3 class="font-bold text-lg text-blue-800">${p.name}</h3>
        <div class="flex flex-wrap gap-3 text-sm text-gray-600">
          <span><i class="fas fa-birthday-cake ml-1"></i> ${p.age} سنة</span>
          <span><i class="fas fa-id-card ml-1"></i> ${p.nid}</span>
          <span><i class="fas fa-venus-mars ml-1"></i> ${p.gender === "male" ? "ذكر" : "أنثى"}</span>
          <span><i class="fas fa-map-marker-alt ml-1"></i> ${p.address}</span>
          <span><i class="fas fa-tint ml-1"></i> ${p.bloodType}</span>
          <span><i class="fas fa-notes-medical ml-1"></i> ${p.diseases || "لا توجد"}</span>
          <span><i class="fas fa-calendar-alt ml-1"></i> ${new Date(p.timestamp).toLocaleString("ar-EG")}</span>
        </div>
      </div>
      <button data-id="${id}" class="deleteBtn bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200">
        حذف
      </button>
    ;

    div.querySelector(".deleteBtn").addEventListener("click", () => {
      Swal.fire({
        title: 'هل أنت متأكد من حذف المريض؟',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذفه',
        cancelButtonText: 'إلغاء',
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const patientRef = ref(db, patients/emergency/${id});
            await remove(patientRef);
            Swal.fire({ icon: 'success', title: 'تم الحذف بنجاح', timer: 1500, toast: true, position: 'top-end', showConfirmButton: false });
          } catch (error) {
            Swal.fire({ icon: 'error', title: 'حدث خطأ أثناء الحذف', text: error.message });
          }
        }
      });
    });

    patientsList.appendChild(div);
  });
}

onValue(emergencyRef, (snapshot) => {
  renderPatients(snapshot.val());
});

// تحديث الإحصائيات
const totalPatientsElem = document.getElementById("totalPatients");
const todayPatientsElem = document.getElementById("todayPatients");
const emergencyCountElem = document.getElementById("emergencyCount");

onValue(ref(db, "patients"), (snapshot) => {
  const data = snapshot.val() || {};
  let total = 0, today = 0, emergencyCount = 0;
  const todayDate = new Date().toDateString();

  Object.values(data).forEach(dept => {
    Object.values(dept).forEach(p => {
      total++;
      if (new Date(p.timestamp).toDateString() === todayDate) today++;
    });
  });

  emergencyCount = data.emergency ? Object.keys(data.emergency).length : 0;
  totalPatientsElem.textContent = total;
  todayPatientsElem.textContent = today;
  emergencyCountElem.textContent = emergencyCount;
});
</script>
</body>
</html>
