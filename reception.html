<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام إدارة المرضى - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0066CC;
      --primary-hover: #004499;
      --secondary-color: #00A8E8;
      --accent-color: #00C9A7;
      --danger-color: #FF6B6B;
      --warning-color: #FFD93D;
      --success-color: #6BCF7F;
      --dark-color: #2C3E50;
      --light-bg: #F0F8FF;
      --card-bg: #FFFFFF;
      --text-primary: #2C3E50;
      --text-secondary: #6C757D;
      --border-color: #E1E8ED;
      --shadow-sm: 0 2px 4px rgba(0, 102, 204, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 102, 204, 0.12);
      --shadow-lg: 0 8px 24px rgba(0, 102, 204, 0.16);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Cairo', sans-serif; 
      background: linear-gradient(135deg, #F0F8FF 0%, #E6F4F9 100%);
      min-height: 100vh;
      color: var(--text-primary);
    }
    
    /* Connection Status */
    .connection-status {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 9999;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .status-online {
      background: rgba(107, 207, 127, 0.9);
      color: white;
    }
    
    .status-offline {
      background: rgba(255, 107, 107, 0.9);
      color: white;
    }
    
    .status-syncing {
      background: rgba(255, 193, 7, 0.9);
      color: white;
    }
    
    /* Header Styles */
    .medical-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .medical-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,133.3C960,128,1056,96,1152,90.7C1248,85,1344,107,1392,117.3L1440,128L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path></svg>') no-repeat;
      background-size: cover;
      opacity: 0.3;
    }
    
    .logo-container {
      position: relative;
      z-index: 1;
    }
    
    .logo-badge {
      background: white;
      border-radius: 50%;
      padding: 3px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Card Styles */
    .medical-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    
    .medical-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .medical-card:hover::before {
      opacity: 1;
    }
    
    .medical-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Sync Button */
    .sync-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .sync-button:hover {
      transform: scale(1.1);
      background: var(--primary-hover);
    }
    
    .sync-button.syncing {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0); }
    }
    
    /* Form Styles */
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--primary-hover), var(--secondary-color));
    }
    
    /* Patient Card */
    .patient-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .patient-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      border-radius: 4px 0 0 4px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .patient-card:hover::before {
      opacity: 1;
    }
    
    .patient-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }
    
    .patient-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
    }
    
    /* Action Buttons */
    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      margin: 0 4px;
    }
    
    .action-btn:hover {
      transform: scale(1.1);
    }
    
    .btn-edit {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary-color);
    }
    
    .btn-edit:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-delete {
      background: rgba(255, 107, 107, 0.1);
      color: var(--danger-color);
    }
    
    .btn-delete:hover {
      background: var(--danger-color);
      color: white;
    }
    
    .btn-view {
      background: rgba(0, 201, 167, 0.1);
      color: var(--accent-color);
    }
    
    .btn-view:hover {
      background: var(--accent-color);
      color: white;
    }
    
    /* Tabs */
    .tabs-container {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
      overflow-x: auto;
    }
    
    .tab-btn {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-btn:hover {
      color: var(--primary-color);
    }
    
    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Invoice Preview */
    .invoice-preview {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px dashed var(--primary-color);
    }
    
    .invoice-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .status-paid {
      background: rgba(107, 207, 127, 0.1);
      color: var(--success-color);
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }
    
    /* QR Code Container */
    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }
    
    .qr-container canvas {
      border: 2px solid var(--border-color);
      border-radius: 8px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .connection-status {
        top: 10px;
        left: 10px;
        font-size: 10px;
        padding: 6px 12px;
      }
      
      .sync-button {
        bottom: 10px;
        right: 10px;
        width: 48px;
        height: 48px;
      }
      
      .invoice-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- Connection Status -->
  <div id="connectionStatus" class="connection-status status-offline">
    <i class="fas fa-wifi"></i>
    <span>غير متصل</span>
  </div>

  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay hidden">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-lg font-semibold text-gray-700">جاري تحميل البيانات...</p>
    </div>
  </div>

  <!-- Medical Header -->
  <header class="medical-header text-white p-6">
    <div class="container mx-auto">
      <div class="flex justify-between items-center">
        <div class="logo-container flex items-center gap-4">
          <div class="logo-badge">
            <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" 
                 class="w-14 h-14 rounded-full" alt="شعار المستشفى">
          </div>
          <div>
            <h1 class="text-2xl font-bold">مستشفى الحياة الذكية</h1>
            <p class="text-sm opacity-90">نظام إدارة المرضى المتقدم</p>
          </div>
        </div>
        <div class="text-right">
          <div id="currentDate" class="text-sm opacity-90"></div>
          <div class="flex items-center gap-2 mt-2">
            <i class="fas fa-user-md"></i>
            <span class="text-sm">نظام الاستقبال</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Statistics Dashboard -->
    <section class="mb-8 fade-in">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
        <div class="medical-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
              <i class="fas fa-users text-blue-600"></i>
            </div>
            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">
              <i class="fas fa-arrow-up"></i> 12%
            </span>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">إجمالي المرضى</h3>
          <div id="totalPatients" class="text-3xl font-bold text-gray-800">0</div>
        </div>
        
        <div class="medical-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
              <i class="fas fa-user-plus text-green-600"></i>
            </div>
            <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full">
              <i class="fas fa-clock"></i> اليوم
            </span>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">المسجلين اليوم</h3>
          <div id="todayPatients" class="text-3xl font-bold text-gray-800">0</div>
        </div>
        
        <div class="medical-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
              <i class="fas fa-ambulance text-red-600"></i>
            </div>
            <span class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded-full">
              <i class="fas fa-exclamation-triangle"></i> نشط
            </span>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">حالات الطوارئ</h3>
          <div id="emergencyPatients" class="text-3xl font-bold text-gray-800">0</div>
        </div>
        
        <div class="medical-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
              <i class="fas fa-user-md text-purple-600"></i>
            </div>
            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">
              <i class="fas fa-check"></i> متاح
            </span>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">الأطباء المتاحون</h3>
          <div id="availableDoctors" class="text-3xl font-bold text-gray-800">0</div>
        </div>
        
        <div class="medical-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
              <i class="fas fa-money-bill-wave text-yellow-600"></i>
            </div>
            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">
              <i class="fas fa-arrow-up"></i> 8%
            </span>
          </div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">إيرادات اليوم</h3>
          <div id="dailyRevenue" class="text-3xl font-bold text-gray-800">0</div>
        </div>
      </div>
    </section>

    <!-- Tabs Navigation -->
    <div class="tabs-container mb-6">
      <button class="tab-btn active" data-tab="patients">
        <i class="fas fa-users"></i>
        المرضى
      </button>
      <button class="tab-btn" data-tab="billing">
        <i class="fas fa-file-invoice-dollar"></i>
        الفواتير
      </button>
      <button class="tab-btn" data-tab="services">
        <i class="fas fa-concierge-bell"></i>
        الخدمات
      </button>
      <button class="tab-btn" data-tab="reports">
        <i class="fas fa-chart-line"></i>
        التقارير
      </button>
    </div>

    <!-- Tab Contents -->
    <div id="patientsTab" class="tab-content active">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Patient Registration Form -->
        <div class="lg:col-span-1">
          <div class="medical-card p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center text-white">
                <i class="fas fa-user-plus"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">تسجيل مريض جديد</h2>
            </div>
            
            <form id="patientForm" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-user ml-1"></i>
                  اسم المريض الكامل
                </label>
                <input type="text" id="name" class="form-input" placeholder="أدخل اسم المريض" required />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-birthday-cake ml-1"></i>
                    العمر
                  </label>
                  <input type="number" id="age" min="0" max="120" class="form-input" placeholder="العمر" required />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-id-card ml-1"></i>
                    الرقم القومي
                  </label>
                  <input type="text" id="nid" maxlength="14" class="form-input" placeholder="14 رقم" required />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-venus-mars ml-1"></i>
                    الجنس
                  </label>
                  <select id="gender" class="form-input" required>
                    <option value="">اختر</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-tint ml-1"></i>
                    فصيلة الدم
                  </label>
                  <select id="bloodType" class="form-input" required>
                    <option value="">اختر</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-phone ml-1"></i>
                  رقم الهاتف
                </label>
                <input type="tel" id="phone" class="form-input" placeholder="رقم الهاتف" />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt ml-1"></i>
                  العنوان
                </label>
                <input type="text" id="address" class="form-input" placeholder="العنوان الكامل" required />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-notes-medical ml-1"></i>
                  الأمراض المزمنة / ملاحظات
                </label>
                <textarea id="diseases" rows="3" class="form-input" placeholder="أي أمراض مزمنة أو ملاحظات هامة"></textarea>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-hospital ml-1"></i>
                  القسم الطبي
                </label>
                <select id="department" class="form-input" required>
                  <option value="">-- اختر القسم --</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="radiology">الأشعة</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="operations">العمليات</option>
                </select>
              </div>

              <button type="submit" class="btn-primary w-full">
                <i class="fas fa-save"></i>
                تسجيل المريض
              </button>
            </form>
          </div>
        </div>

        <!-- Patients List -->
        <div class="lg:col-span-2">
          <div class="medical-card p-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-list-ul text-blue-600"></i>
                قائمة المرضى المسجلين
              </h2>
              <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 lg:mt-0">
                <select id="filterDepartment" class="form-input">
                  <option value="all">جميع الأقسام</option>
                  <option value="emergency">الطوارئ</option>
                  <option value="icu">العناية المركزة</option>
                  <option value="operations">العمليات</option>
                </select>
                <div class="relative">
                  <input type="text" id="searchPatient" placeholder="بحث عن مريض..." class="pr-10 pl-4 form-input" />
                  <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                </div>
              </div>
            </div>
            
            <div id="patientsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Patients will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Billing Tab -->
    <div id="billingTab" class="tab-content">
      <div class="medical-card p-6">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-file-invoice-dollar text-purple-600"></i>
            الفواتير والمحاسبة
          </h2>
          <div class="flex gap-3 mt-4 lg:mt-0">
            <button id="generateInvoiceBtn" class="btn-primary">
              <i class="fas fa-plus"></i>
              إنشاء فاتورة جديدة
            </button>
            <button id="exportInvoicesBtn" class="btn-primary" style="background: var(--success-color);">
              <i class="fas fa-download"></i>
              تصدير Excel
            </button>
          </div>
        </div>
        
        <!-- Invoice Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200">
            <div class="text-2xl font-bold text-purple-800" id="totalInvoices">0</div>
            <div class="text-sm text-purple-600">إجمالي الفواتير</div>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200">
            <div class="text-2xl font-bold text-green-800" id="paidInvoices">0</div>
            <div class="text-sm text-green-600">الفواتير المدفوعة</div>
          </div>
          <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200">
            <div class="text-2xl font-bold text-orange-800" id="pendingInvoices">0</div>
            <div class="text-sm text-orange-600">الفواتير المعلقة</div>
          </div>
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
            <div class="text-2xl font-bold text-blue-800" id="totalRevenue">0</div>
            <div class="text-sm text-blue-600">إجمالي الإيرادات</div>
          </div>
        </div>
        
        <!-- Invoices Table -->
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-50 border-b-2 border-gray-200">
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">رقم الفاتورة</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">اسم المريض</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">التاريخ</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">المبلغ</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">الحالة</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">الإجراءات</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody">
              <!-- Invoices will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Services Tab -->
    <div id="servicesTab" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Service Management -->
        <div class="lg:col-span-1">
          <div class="medical-card p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white">
                <i class="fas fa-concierge-bell"></i>
              </div>
              <h2 class="text-xl font-bold text-gray-800">إدارة الخدمات</h2>
            </div>
            
            <form id="serviceForm" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-tag ml-1"></i>
                  اسم الخدمة
                </label>
                <input type="text" id="serviceName" class="form-input" placeholder="أدخل اسم الخدمة" required />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-list ml-1"></i>
                  نوع الخدمة
                </label>
                <select id="serviceType" class="form-input" required>
                  <option value="">-- اختر النوع --</option>
                  <option value="consultation">كشف طبي</option>
                  <option value="xray">أشعة</option>
                  <option value="lab">تحاليل</option>
                  <option value="surgery">عملية جراحية</option>
                  <option value="medication">أدوية</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-money-bill-wave ml-1"></i>
                  السعر (ج.م)
                </label>
                <input type="number" id="servicePrice" class="form-input" placeholder="أدخل السعر" min="0" step="0.01" required />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-info-circle ml-1"></i>
                  وصف الخدمة
                </label>
                <textarea id="serviceDescription" rows="3" class="form-input" placeholder="وصف تفصيلي للخدمة"></textarea>
              </div>

              <button type="submit" class="btn-primary w-full">
                <i class="fas fa-save"></i>
                إضافة الخدمة
              </button>
            </form>
          </div>
        </div>

        <!-- Services List -->
        <div class="lg:col-span-2">
          <div class="medical-card p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-list text-purple-600"></i>
                قائمة الخدمات
              </h2>
              <div class="relative">
                <input type="text" id="searchService" placeholder="بحث عن خدمة..." class="pr-10 pl-4 form-input" />
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
              </div>
            </div>
            
            <div id="servicesList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
              <!-- Services will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div id="reportsTab" class="tab-content">
      <div class="medical-card p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-chart-line text-green-600"></i>
            التقارير والإحصائيات
          </h2>
          <div class="flex gap-3">
            <button id="generateReportBtn" class="btn-primary">
              <i class="fas fa-file-pdf"></i>
              إنشاء تقرير PDF
            </button>
            <button id="refreshDataBtn" class="btn-primary" style="background: var(--warning-color);">
              <i class="fas fa-sync"></i>
              تحديث البيانات
            </button>
          </div>
        </div>
        
        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded-lg border">
            <h3 class="text-lg font-semibold mb-4">توزيع المرضى حسب الأقسام</h3>
            <canvas id="departmentChart"></canvas>
          </div>
          <div class="bg-white p-4 rounded-lg border">
            <h3 class="text-lg font-semibold mb-4">الإيرادات الشهرية</h3>
            <canvas id="revenueChart"></canvas>
          </div>
        </div>
        
        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-semibold text-blue-800">متوسط الفاتورة</h4>
            <p class="text-2xl font-bold text-blue-600" id="avgInvoice">0 ج.م</p>
          </div>
          <div class="bg-green-50 p-4 rounded-lg">
            <h4 class="font-semibold text-green-800">أكثر الخدمات طلباً</h4>
            <p class="text-lg font-bold text-green-600" id="popularService">---</p>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg">
            <h4 class="font-semibold text-purple-800">معدل النمو</h4>
            <p class="text-2xl font-bold text-purple-600" id="growthRate">0%</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Sync Button -->
  <button id="syncButton" class="sync-button" title="مزامنة البيانات">
    <i class="fas fa-sync"></i>
  </button>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">إنشاء فاتورة جديدة</h2>
          <button id="closeInvoiceModal" class="text-white hover:bg-white/20 p-2 rounded-full transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <form id="invoiceForm" class="space-y-6">
          <!-- Patient Selection -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-user ml-1"></i>
                اختر المريض
              </label>
              <select id="invoicePatient" class="form-input" required>
                <option value="">-- اختر المريض --</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-calendar ml-1"></i>
                تاريخ الفاتورة
              </label>
              <input type="date" id="invoiceDate" class="form-input" required />
            </div>
          </div>
          
          <!-- Services Selection -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-concierge-bell ml-1"></i>
              اختر الخدمات
            </label>
            <div id="servicesSelection" class="space-y-2 max-h-60 overflow-y-auto border-2 border-gray-200 rounded-lg p-4">
              <!-- Services will be loaded here -->
            </div>
          </div>
          
          <!-- Payment Method -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-credit-card ml-1"></i>
              طريقة الدفع
            </label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="payment-method-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-purple-500 transition" data-method="cash">
                <i class="fas fa-money-bill-wave text-2xl text-green-600 mb-2"></i>
                <p class="text-sm font-semibold">نقدي</p>
              </div>
              <div class="payment-method-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-purple-500 transition" data-method="card">
                <i class="fas fa-credit-card text-2xl text-blue-600 mb-2"></i>
                <p class="text-sm font-semibold">بطاقة</p>
              </div>
            </div>
          </div>
          
          <!-- Invoice Summary -->
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4">
            <h4 class="font-semibold text-gray-800 mb-3">ملخص الفاتورة</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span>المجموع الفرعي:</span>
                <span id="subtotal" class="font-semibold">0 ج.م</span>
              </div>
              <div class="flex justify-between text-lg font-bold text-gray-800 pt-2 border-t-2 border-purple-200">
                <span>المبلغ الإجمالي:</span>
                <span id="totalAmount">0 ج.م</span>
              </div>
            </div>
          </div>
          
          <div class="flex gap-4">
            <button type="submit" class="btn-primary flex-1">
              <i class="fas fa-save"></i>
              حفظ الفاتورة
            </button>
            <button type="button" id="printInvoiceBtn" class="btn-primary flex-1" style="background: var(--success-color);">
              <i class="fas fa-print"></i>
              طباعة
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Optional) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    // ========== LOCAL STORAGE DATABASE MANAGER ==========
    class LocalDatabaseManager {
      constructor() {
        this.initializeData();
      }
      
      initializeData() {
        if (!localStorage.getItem('hospital_data')) {
          const initialData = {
            patients: {},
            invoices: {},
            services: this.getDefaultServices(),
            doctors: this.getDefaultDoctors(),
            settings: {
              lastSync: null,
              autoSync: true,
              firebaseEnabled: false
            }
          };
          localStorage.setItem('hospital_data', JSON.stringify(initialData));
        }
      }
      
      getDefaultServices() {
        return {
          'service_1': {
            id: 'service_1',
            name: 'كشف طبيب عام',
            type: 'consultation',
            price: 150,
            description: 'فحص عام وتشخيص',
            timestamp: new Date().toISOString()
          },
          'service_2': {
            id: 'service_2',
            name: 'أشعة صدرية',
            type: 'xray',
            price: 250,
            description: 'أشعة على الصدر',
            timestamp: new Date().toISOString()
          },
          'service_3': {
            id: 'service_3',
            name: 'تحليل دم شامل',
            type: 'lab',
            price: 200,
            description: 'تحليل دم كامل',
            timestamp: new Date().toISOString()
          },
          'service_4': {
            id: 'service_4',
            name: 'عملية استئصال الزائدة',
            type: 'surgery',
            price: 5000,
            description: 'جراحة استئصال الزائدة الدودية',
            timestamp: new Date().toISOString()
          }
        };
      }
      
      getDefaultDoctors() {
        return {
          'doctor_1': {
            id: 'doctor_1',
            name: 'د. أحمد محمد',
            specialization: 'طب الطوارئ',
            department: 'emergency',
            workFrom: '08:00',
            workTo: '20:00',
            timestamp: new Date().toISOString()
          },
          'doctor_2': {
            id: 'doctor_2',
            name: 'د. فاطمة علي',
            specialization: 'العناية المركزة',
            department: 'icu',
            workFrom: '08:00',
            workTo: '20:00',
            timestamp: new Date().toISOString()
          }
        };
      }
      
      getData() {
        return JSON.parse(localStorage.getItem('hospital_data') || '{}');
      }
      
      saveData(data) {
        localStorage.setItem('hospital_data', JSON.stringify(data));
        this.updateLastSync();
      }
      
      updateLastSync() {
        const data = this.getData();
        data.settings.lastSync = new Date().toISOString();
        localStorage.setItem('hospital_data', JSON.stringify(data));
      }
      
      // Patients
      addPatient(patient) {
        const data = this.getData();
        const id = 'patient_' + Date.now();
        patient.id = id;
        patient.timestamp = new Date().toISOString();
        patient.status = 'active';
        data.patients[id] = patient;
        this.saveData(data);
        return id;
      }
      
      getPatients() {
        const data = this.getData();
        return data.patients || {};
      }
      
      updatePatient(id, updates) {
        const data = this.getData();
        if (data.patients[id]) {
          data.patients[id] = { ...data.patients[id], ...updates };
          this.saveData(data);
          return true;
        }
        return false;
      }
      
      deletePatient(id) {
        const data = this.getData();
        if (data.patients[id]) {
          delete data.patients[id];
          this.saveData(data);
          return true;
        }
        return false;
      }
      
      // Invoices
      addInvoice(invoice) {
        const data = this.getData();
        const id = 'invoice_' + Date.now();
        invoice.id = id;
        invoice.timestamp = new Date().toISOString();
        invoice.invoiceNumber = this.generateInvoiceNumber();
        data.invoices[id] = invoice;
        this.saveData(data);
        return id;
      }
      
      getInvoices() {
        const data = this.getData();
        return data.invoices || {};
      }
      
      updateInvoice(id, updates) {
        const data = this.getData();
        if (data.invoices[id]) {
          data.invoices[id] = { ...data.invoices[id], ...updates };
          this.saveData(data);
          return true;
        }
        return false;
      }
      
      deleteInvoice(id) {
        const data = this.getData();
        if (data.invoices[id]) {
          delete data.invoices[id];
          this.saveData(data);
          return true;
        }
        return false;
      }
      
      generateInvoiceNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `INV-${year}-${month}-${random}`;
      }
      
      // Services
      addService(service) {
        const data = this.getData();
        const id = 'service_' + Date.now();
        service.id = id;
        service.timestamp = new Date().toISOString();
        data.services[id] = service;
        this.saveData(data);
        return id;
      }
      
      getServices() {
        const data = this.getData();
        return data.services || {};
      }
      
      updateService(id, updates) {
        const data = this.getData();
        if (data.services[id]) {
          data.services[id] = { ...data.services[id], ...updates };
          this.saveData(data);
          return true;
        }
        return false;
      }
      
      deleteService(id) {
        const data = this.getData();
        if (data.services[id]) {
          delete data.services[id];
          this.saveData(data);
          return true;
        }
        return false;
      }
      
      // Export/Import
      exportData() {
        const data = this.getData();
        const dataStr = JSON.stringify(data, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `hospital_backup_${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
      }
      
      importData(jsonData) {
        try {
          const data = JSON.parse(jsonData);
          this.saveData(data);
          return true;
        } catch (error) {
          console.error('Import error:', error);
          return false;
        }
      }
    }
    
    // ========== FIREBASE MANAGER (Optional) ==========
    class FirebaseManager {
      constructor() {
        this.firebase = null;
        this.database = null;
        this.isConnected = false;
        this.tryInitialize();
      }
      
      tryInitialize() {
        try {
          const firebaseConfig = {
            apiKey: "AIzaSyB4glqZb0hz1uvERtq0pSZZzeBy3_grAnQ",
            authDomain: "smart-life-hospital-ef64c.firebaseapp.com",
            databaseURL: "https://smart-life-hospital-ef64c-default-rtdb.firebaseio.com",
            projectId: "smart-life-hospital-ef64c",
            storageBucket: "smart-life-hospital-ef64c.firebasestorage.app",
            messagingSenderId: "851045891087",
            appId: "1:851045891087:web:8e0f6e42f8c7fed17bf77a"
          };
          
          if (typeof firebase !== 'undefined') {
            this.firebase = firebase;
            this.firebase.initializeApp(firebaseConfig);
            this.database = this.firebase.database();
            this.testConnection();
          }
        } catch (error) {
          console.log('Firebase not available, using local storage only');
          this.isConnected = false;
        }
      }
      
      async testConnection() {
        try {
          await this.database.ref('.info/connected').once('value');
          this.isConnected = true;
          updateConnectionStatus(true);
        } catch (error) {
          this.isConnected = false;
          updateConnectionStatus(false);
        }
      }
      
      async syncToFirebase(localData) {
        if (!this.isConnected) return false;
        
        try {
          await this.database.ref('/').set(localData);
          return true;
        } catch (error) {
          console.error('Sync error:', error);
          return false;
        }
      }
      
      async syncFromFirebase() {
        if (!this.isConnected) return null;
        
        try {
          const snapshot = await this.database.ref('/').once('value');
          return snapshot.val();
        } catch (error) {
          console.error('Sync error:', error);
          return null;
        }
      }
    }
    
    // ========== GLOBAL VARIABLES ==========
    let localDB = new LocalDatabaseManager();
    let firebaseManager = new FirebaseManager();
    let selectedServices = new Map();
    let selectedPaymentMethod = null;
    
    // ========== UTILITY FUNCTIONS ==========
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ar-EG', {
        style: 'currency',
        currency: 'EGP',
        minimumFractionDigits: 2
      }).format(amount);
    }
    
    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString("ar-EG", {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function updateConnectionStatus(isConnected) {
      const statusElement = document.getElementById('connectionStatus');
      const syncButton = document.getElementById('syncButton');
      
      if (isConnected) {
        statusElement.className = 'connection-status status-online';
        statusElement.innerHTML = '<i class="fas fa-wifi"></i><span>متصل</span>';
        syncButton.style.display = 'none';
      } else {
        statusElement.className = 'connection-status status-offline';
        statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i><span>غير متصل - يعمل محلياً</span>';
        syncButton.style.display = 'flex';
      }
    }
    
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    // ========== PATIENT MANAGEMENT ==========
    function renderPatients(filter = 'all', searchTerm = '') {
      const patientsList = document.getElementById('patientsList');
      const patients = localDB.getPatients();
      
      let filteredPatients = Object.entries(patients);
      
      if (filter !== 'all') {
        filteredPatients = filteredPatients.filter(([_, patient]) => patient.department === filter);
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredPatients = filteredPatients.filter(([_, patient]) => 
          patient.name.toLowerCase().includes(term) || 
          patient.nid.includes(term) ||
          (patient.phone && patient.phone.includes(term))
        );
      }
      
      if (filteredPatients.length === 0) {
        patientsList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-user-slash text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا يوجد مرضى</p>
          </div>
        `;
        return;
      }
      
      patientsList.innerHTML = '';
      filteredPatients.forEach(([id, patient]) => {
        const patientCard = createPatientCard(patient, id);
        patientsList.appendChild(patientCard);
      });
      
      updateStatistics();
    }
    
    function createPatientCard(patient, id) {
      const card = document.createElement('div');
      card.className = 'patient-card';
      
      const genderText = patient.gender === 'male' ? 'ذكر' : 'أنثى';
      const genderIcon = patient.gender === 'male' ? 'fa-mars' : 'fa-venus';
      
      card.innerHTML = `
        <div class="flex items-start gap-4">
          <div class="patient-avatar">
            ${patient.name.charAt(0).toUpperCase()}
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold text-gray-800">${patient.name}</h3>
              <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                ${getDepartmentName(patient.department)}
              </span>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-gray-600">
              <div><i class="fas fa-id-card ml-1"></i> ${patient.nid}</div>
              <div><i class="fas fa-${genderIcon} ml-1"></i> ${genderText}</div>
              <div><i class="fas fa-birthday-cake ml-1"></i> ${patient.age} سنة</div>
              <div><i class="fas fa-tint ml-1"></i> ${patient.bloodType}</div>
              ${patient.phone ? `<div><i class="fas fa-phone ml-1"></i> ${patient.phone}</div>` : ''}
              <div><i class="fas fa-clock ml-1"></i> ${formatDate(patient.timestamp)}</div>
            </div>
            
            ${patient.diseases ? `
            <div class="mt-3 p-3 bg-gray-50 rounded-lg">
              <div class="text-sm font-semibold text-gray-700 mb-1">ملاحظات طبية:</div>
              <p class="text-sm text-gray-600">${patient.diseases}</p>
            </div>
            ` : ''}
            
            <div class="flex gap-2 mt-3">
              <button class="action-btn btn-view" onclick="viewPatient('${id}')">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn btn-edit" onclick="editPatient('${id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn btn-delete" onclick="deletePatient('${id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }
    
    function getDepartmentName(department) {
      const departments = {
        emergency: 'الطوارئ',
        icu: 'العناية المركزة',
        operations: 'العمليات',
        radiology: 'الأشعة'
      };
      return departments[department] || department;
    }
    
    // ========== INVOICE MANAGEMENT ==========
    function renderInvoices() {
      const invoicesTableBody = document.getElementById('invoicesTableBody');
      const invoices = localDB.getInvoices();
      
      if (Object.keys(invoices).length === 0) {
        invoicesTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
              <i class="fas fa-file-invoice text-4xl mb-2 block"></i>
              لا توجد فواتير مسجلة
            </td>
          </tr>
        `;
        updateInvoiceStatistics();
        return;
      }
      
      invoicesTableBody.innerHTML = '';
      Object.entries(invoices).forEach(([id, invoice]) => {
        const row = createInvoiceRow(invoice, id);
        invoicesTableBody.appendChild(row);
      });
      
      updateInvoiceStatistics();
    }
    
    function createInvoiceRow(invoice, id) {
      const row = document.createElement('tr');
      row.className = 'border-b hover:bg-gray-50';
      
      const statusClass = invoice.status === 'paid' ? 'bg-green-100 text-green-800' : 
                         invoice.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                         'bg-gray-100 text-gray-800';
      
      const statusText = invoice.status === 'paid' ? 'مدفوعة' : 
                        invoice.status === 'pending' ? 'معلقة' : 'ملغاة';
      
      row.innerHTML = `
        <td class="px-4 py-3 font-semibold">${invoice.invoiceNumber}</td>
        <td class="px-4 py-3">${invoice.patientName}</td>
        <td class="px-4 py-3">${formatDate(invoice.date)}</td>
        <td class="px-4 py-3 font-semibold">${formatCurrency(invoice.totalAmount)}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${statusText}</span>
        </td>
        <td class="px-4 py-3">
          <div class="flex gap-2">
            <button class="action-btn btn-view" onclick="viewInvoice('${id}')">
              <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn btn-edit" onclick="printInvoice('${id}')">
              <i class="fas fa-print"></i>
            </button>
            ${invoice.status === 'pending' ? `
            <button class="action-btn btn-edit" style="background: rgba(107, 207, 127, 0.1); color: var(--success-color);" onclick="markAsPaid('${id}')">
              <i class="fas fa-check"></i>
            </button>
            ` : ''}
          </div>
        </td>
      `;
      
      return row;
    }
    
    // ========== SERVICE MANAGEMENT ==========
    function renderServices(searchTerm = '') {
      const servicesList = document.getElementById('servicesList');
      const services = localDB.getServices();
      
      let filteredServices = Object.entries(services);
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredServices = filteredServices.filter(([_, service]) => 
          service.name.toLowerCase().includes(term) || 
          service.description.toLowerCase().includes(term)
        );
      }
      
      if (filteredServices.length === 0) {
        servicesList.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-concierge-bell text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">لا توجد خدمات</p>
          </div>
        `;
        return;
      }
      
      servicesList.innerHTML = '';
      filteredServices.forEach(([id, service]) => {
        const serviceCard = createServiceCard(service, id);
        servicesList.appendChild(serviceCard);
      });
    }
    
    function createServiceCard(service, id) {
      const card = document.createElement('div');
      card.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition';
      
      const typeIcons = {
        consultation: 'fa-stethoscope',
        xray: 'fa-x-ray',
        lab: 'fa-vial',
        surgery: 'fa-procedures',
        medication: 'fa-pills'
      };
      
      card.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
            <i class="fas ${typeIcons[service.type] || 'fa-medkit'} text-purple-600"></i>
          </div>
          <div>
            <div class="font-semibold text-gray-800">${service.name}</div>
            <div class="text-sm text-gray-500">${service.description}</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span class="font-bold text-purple-600">${formatCurrency(service.price)}</span>
          <div class="flex gap-1">
            <button class="action-btn btn-edit" onclick="editService('${id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn btn-delete" onclick="deleteService('${id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      return card;
    }
    
    // ========== STATISTICS ==========
    function updateStatistics() {
      const patients = localDB.getPatients();
      const today = new Date().toDateString();
      
      let totalPatients = Object.keys(patients).length;
      let todayPatients = 0;
      let emergencyPatients = 0;
      
      Object.values(patients).forEach(patient => {
        if (new Date(patient.timestamp).toDateString() === today) {
          todayPatients++;
        }
        if (patient.department === 'emergency') {
          emergencyPatients++;
        }
      });
      
      document.getElementById('totalPatients').textContent = totalPatients;
      document.getElementById('todayPatients').textContent = todayPatients;
      document.getElementById('emergencyPatients').textContent = emergencyPatients;
      document.getElementById('availableDoctors').textContent = '2'; // Default doctors
    }
    
    function updateInvoiceStatistics() {
      const invoices = localDB.getInvoices();
      const today = new Date().toDateString();
      
      let totalInvoices = Object.keys(invoices).length;
      let paidInvoices = 0;
      let pendingInvoices = 0;
      let totalRevenue = 0;
      let dailyRevenue = 0;
      
      Object.values(invoices).forEach(invoice => {
        if (invoice.status === 'paid') {
          paidInvoices++;
          totalRevenue += invoice.totalAmount || 0;
          
          if (new Date(invoice.date).toDateString() === today) {
            dailyRevenue += invoice.totalAmount || 0;
          }
        } else if (invoice.status === 'pending') {
          pendingInvoices++;
        }
      });
      
      document.getElementById('totalInvoices').textContent = totalInvoices;
      document.getElementById('paidInvoices').textContent = paidInvoices;
      document.getElementById('pendingInvoices').textContent = pendingInvoices;
      document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('dailyRevenue').textContent = formatCurrency(dailyRevenue);
    }
    
    // ========== INVOICE MODAL FUNCTIONS ==========
    function loadServicesForInvoice() {
      const services = localDB.getServices();
      const container = document.getElementById('servicesSelection');
      
      container.innerHTML = '';
      
      Object.entries(services).forEach(([id, service]) => {
        const serviceItem = document.createElement('div');
        serviceItem.className = 'flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50';
        
        serviceItem.innerHTML = `
          <div class="flex items-center gap-3">
            <input type="checkbox" id="service-${id}" value="${id}" class="w-4 h-4 text-purple-600">
            <label for="service-${id}" class="cursor-pointer">
              <div class="font-semibold">${service.name}</div>
              <div class="text-sm text-gray-500">${service.description}</div>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-purple-600">${formatCurrency(service.price)}</span>
            <input type="number" id="quantity-${id}" min="1" value="1" class="w-16 text-center border rounded px-2 py-1">
          </div>
        `;
        
        container.appendChild(serviceItem);
        
        // Add event listeners
        const checkbox = serviceItem.querySelector(`#service-${id}`);
        const quantityInput = serviceItem.querySelector(`#quantity-${id}`);
        
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedServices.set(id, {
              ...service,
              quantity: parseInt(quantityInput.value)
            });
          } else {
            selectedServices.delete(id);
          }
          updateInvoiceSummary();
        });
        
        quantityInput.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedServices.set(id, {
              ...service,
              quantity: parseInt(quantityInput.value)
            });
            updateInvoiceSummary();
          }
        });
      });
    }
    
    function loadPatientsForInvoice() {
      const patients = localDB.getPatients();
      const select = document.getElementById('invoicePatient');
      
      select.innerHTML = '<option value="">-- اختر المريض --</option>';
      
      Object.entries(patients).forEach(([id, patient]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = `${patient.name} - ${patient.nid}`;
        select.appendChild(option);
      });
    }
    
    function updateInvoiceSummary() {
      const subtotalElement = document.getElementById('subtotal');
      const totalAmountElement = document.getElementById('totalAmount');
      
      if (selectedServices.size === 0) {
        subtotalElement.textContent = '0 ج.م';
        totalAmountElement.textContent = '0 ج.م';
        return;
      }
      
      let subtotal = 0;
      selectedServices.forEach((service) => {
        subtotal += service.price * service.quantity;
      });
      
      subtotalElement.textContent = formatCurrency(subtotal);
      totalAmountElement.textContent = formatCurrency(subtotal);
    }
    
    // ========== ACTION FUNCTIONS ==========
    window.viewPatient = function(id) {
      const patient = localDB.getPatients()[id];
      if (!patient) return;
      
      Swal.fire({
        title: 'تفاصيل المريض',
        html: `
          <div class="text-right">
            <div class="mb-4">
              <strong>الاسم:</strong> ${patient.name}<br>
              <strong>العمر:</strong> ${patient.age} سنة<br>
              <strong>الجنس:</strong> ${patient.gender === 'male' ? 'ذكر' : 'أنثى'}<br>
              <strong>فصيلة الدم:</strong> ${patient.bloodType}<br>
              <strong>الرقم القومي:</strong> ${patient.nid}<br>
              <strong>الهاتف:</strong> ${patient.phone || '---'}<br>
              <strong>العنوان:</strong> ${patient.address}<br>
              <strong>القسم:</strong> ${getDepartmentName(patient.department)}<br>
              <strong>تاريخ التسجيل:</strong> ${formatDate(patient.timestamp)}<br>
              ${patient.diseases ? `<strong>ملاحظات:</strong> ${patient.diseases}` : ''}
            </div>
          </div>
        `,
        confirmButtonText: 'إغلاق',
        customClass: {
          popup: 'medical-card'
        }
      });
    };
    
    window.editPatient = function(id) {
      const patient = localDB.getPatients()[id];
      if (!patient) return;
      
      Swal.fire({
        title: 'تعديل بيانات المريض',
        html: `
          <form id="editPatientForm" class="text-right space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">الاسم</label>
              <input type="text" id="edit-name" value="${patient.name}" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">العمر</label>
                <input type="number" id="edit-age" value="${patient.age}" class="w-full px-3 py-2 border rounded-lg" required>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">الرقم القومي</label>
                <input type="text" id="edit-nid" value="${patient.nid}" class="w-full px-3 py-2 border rounded-lg" required>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">الهاتف</label>
              <input type="tel" id="edit-phone" value="${patient.phone || ''}" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">العنوان</label>
              <input type="text" id="edit-address" value="${patient.address}" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">ملاحظات</label>
              <textarea id="edit-diseases" rows="3" class="w-full px-3 py-2 border rounded-lg">${patient.diseases || ''}</textarea>
            </div>
          </form>
        `,
        showCancelButton: true,
        confirmButtonText: 'حفظ التعديلات',
        preConfirm: () => {
          const name = document.getElementById('edit-name').value.trim();
          const age = document.getElementById('edit-age').value;
          const nid = document.getElementById('edit-nid').value.trim();
          const phone = document.getElementById('edit-phone').value.trim();
          const address = document.getElementById('edit-address').value.trim();
          const diseases = document.getElementById('edit-diseases').value.trim();
          
          if (!name || !age || !nid || !address) {
            Swal.showValidationMessage('يرجى ملء جميع الحقول الإلزامية');
            return false;
          }
          
          return { name, age, nid, phone, address, diseases };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const updatedData = result.value;
          localDB.updatePatient(id, updatedData);
          
          Swal.fire({
            icon: 'success',
            title: 'تم التحديث',
            text: 'تم تحديث بيانات المريض بنجاح',
            timer: 2000,
            showConfirmButton: false
          });
          
          renderPatients();
        }
      });
    };
    
    window.deletePatient = function(id) {
      Swal.fire({
        title: 'تأكيد الحذف',
        text: "هل أنت متأكد من حذف بيانات هذا المريض؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#FF6B6B',
        cancelButtonColor: '#6C757D',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
      }).then((result) => {
        if (result.isConfirmed) {
          localDB.deletePatient(id);
          
          Swal.fire({
            icon: 'success',
            title: 'تم الحذف',
            text: 'تم حذف بيانات المريض',
            timer: 2000,
            showConfirmButton: false
          });
          
          renderPatients();
        }
      });
    };
    
    window.viewInvoice = function(id) {
      const invoice = localDB.getInvoices()[id];
      if (!invoice) return;
      
      Swal.fire({
        title: `تفاصيل الفاتورة ${invoice.invoiceNumber}`,
        html: `
          <div class="text-right">
            <div class="mb-4">
              <strong>المريض:</strong> ${invoice.patientName}<br>
              <strong>التاريخ:</strong> ${formatDate(invoice.date)}<br>
              <strong>طريقة الدفع:</strong> ${invoice.paymentMethod || '---'}<br>
              <strong>الحالة:</strong> ${invoice.status === 'paid' ? 'مدفوعة' : invoice.status === 'pending' ? 'معلقة' : 'ملغاة'}
            </div>
            <div class="border-t pt-4">
              <strong>الخدمات:</strong><br>
              ${invoice.services ? invoice.services.map(s => `• ${s.name}: ${formatCurrency(s.price)} × ${s.quantity}`).join('<br>') : '---'}
            </div>
            <div class="border-t pt-4 mt-4">
              <div class="flex justify-between mb-2">
                <span>المجموع الفرعي:</span>
                <span>${formatCurrency(invoice.subtotal || 0)}</span>
              </div>
              <div class="flex justify-between font-bold text-lg">
                <span>المبلغ الإجمالي:</span>
                <span>${formatCurrency(invoice.totalAmount)}</span>
              </div>
            </div>
            ${invoice.notes ? `
            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
              <strong>ملاحظات:</strong><br>
              ${invoice.notes}
            </div>
            ` : ''}
          </div>
        `,
        confirmButtonText: 'إغلاق',
        customClass: {
          popup: 'medical-card'
        }
      });
    };
    
    window.printInvoice = function(id) {
      const invoice = localDB.getInvoices()[id];
      if (!invoice) return;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html dir="rtl">
        <head>
          <title>فاتورة - ${invoice.invoiceNumber}</title>
          <style>
            body { font-family: 'Cairo', sans-serif; padding: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .services { margin: 20px 0; }
            .service-item { padding: 10px; border-bottom: 1px solid #ddd; }
            .summary { margin-top: 20px; }
            .summary-row { display: flex; justify-content: space-between; margin: 5px 0; }
            .total { font-weight: bold; font-size: 18px; border-top: 2px solid #000; padding-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>مستشفى الحياة الذكية</h1>
            <h2>فاتورة رقم: ${invoice.invoiceNumber}</h2>
            <p>التاريخ: ${formatDate(invoice.date)}</p>
          </div>
          
          <div class="info">
            <p><strong>المريض:</strong> ${invoice.patientName}</p>
            <p><strong>طريقة الدفع:</strong> ${invoice.paymentMethod || '---'}</p>
            <p><strong>الحالة:</strong> ${invoice.status === 'paid' ? 'مدفوعة' : invoice.status === 'pending' ? 'معلقة' : 'ملغاة'}</p>
          </div>
          
          <div class="services">
            <h3>الخدمات:</h3>
            ${invoice.services ? invoice.services.map(s => `
              <div class="service-item">
                ${s.name} - ${formatCurrency(s.price)} × ${s.quantity} = ${formatCurrency(s.price * s.quantity)}
              </div>
            `).join('') : ''}
          </div>
          
          <div class="summary">
            <div class="summary-row">
              <span>المجموع الفرعي:</span>
              <span>${formatCurrency(invoice.subtotal || 0)}</span>
            </div>
            <div class="total">
              <span>المبلغ الإجمالي:</span>
              <span>${formatCurrency(invoice.totalAmount)}</span>
            </div>
          </div>
          
          ${invoice.notes ? `
          <div class="info">
            <strong>ملاحظات:</strong><br>
            ${invoice.notes}
          </div>
          ` : ''}
        </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    };
    
    window.markAsPaid = function(id) {
      Swal.fire({
        title: 'تأكيد الدفع',
        text: "هل أنت متأكد من أن هذه الفاتورة تم دفعها؟",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#6BCF7F',
        cancelButtonColor: '#6C757D',
        confirmButtonText: 'نعم، تم الدفع',
        cancelButtonText: 'إلغاء'
      }).then((result) => {
        if (result.isConfirmed) {
          localDB.updateInvoice(id, {
            status: 'paid',
            paidDate: new Date().toISOString()
          });
          
          Swal.fire({
            icon: 'success',
            title: 'تم التحديث',
            text: 'تم تحديث حالة الفاتورة إلى مدفوعة',
            timer: 2000,
            showConfirmButton: false
          });
          
          renderInvoices();
        }
      });
    };
    
    window.editService = function(id) {
      const service = localDB.getServices()[id];
      if (!service) return;
      
      Swal.fire({
        title: 'تعديل الخدمة',
        html: `
          <form id="editServiceForm" class="text-right space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">اسم الخدمة</label>
              <input type="text" id="edit-service-name" value="${service.name}" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">النوع</label>
              <select id="edit-service-type" class="w-full px-3 py-2 border rounded-lg" required>
                <option value="consultation" ${service.type === 'consultation' ? 'selected' : ''}>كشف طبي</option>
                <option value="xray" ${service.type === 'xray' ? 'selected' : ''}>أشعة</option>
                <option value="lab" ${service.type === 'lab' ? 'selected' : ''}>تحاليل</option>
                <option value="surgery" ${service.type === 'surgery' ? 'selected' : ''}>عملية جراحية</option>
                <option value="medication" ${service.type === 'medication' ? 'selected' : ''}>أدوية</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">السعر</label>
              <input type="number" id="edit-service-price" value="${service.price}" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">الوصف</label>
              <textarea id="edit-service-description" rows="3" class="w-full px-3 py-2 border rounded-lg">${service.description || ''}</textarea>
            </div>
          </form>
        `,
        showCancelButton: true,
        confirmButtonText: 'حفظ التعديلات',
        preConfirm: () => {
          const name = document.getElementById('edit-service-name').value.trim();
          const type = document.getElementById('edit-service-type').value;
          const price = document.getElementById('edit-service-price').value;
          const description = document.getElementById('edit-service-description').value.trim();
          
          if (!name || !type || !price) {
            Swal.showValidationMessage('يرجى ملء جميع الحقول الإلزامية');
            return false;
          }
          
          return { name, type, price, description };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const updatedData = result.value;
          localDB.updateService(id, updatedData);
          
          Swal.fire({
            icon: 'success',
            title: 'تم التحديث',
            text: 'تم تحديث بيانات الخدمة بنجاح',
            timer: 2000,
            showConfirmButton: false
          });
          
          renderServices();
        }
      });
    };
    
    window.deleteService = function(id) {
      Swal.fire({
        title: 'تأكيد الحذف',
        text: "هل أنت متأكد من حذف هذه الخدمة؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#FF6B6B',
        cancelButtonColor: '#6C757D',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
      }).then((result) => {
        if (result.isConfirmed) {
          localDB.deleteService(id);
          
          Swal.fire({
            icon: 'success',
            title: 'تم الحذف',
            text: 'تم حذف الخدمة',
            timer: 2000,
            showConfirmButton: false
          });
          
          renderServices();
        }
      });
    };
    
    // ========== CHARTS ==========
    function initializeCharts() {
      // Department Chart
      const deptCtx = document.getElementById('departmentChart');
      if (deptCtx) {
        new Chart(deptCtx, {
          type: 'bar',
          data: {
            labels: ['الطوارئ', 'العناية المركزة', 'العمليات', 'الأشعة'],
            datasets: [{
              label: 'عدد المرضى',
              data: [12, 8, 15, 6],
              backgroundColor: [
                'rgba(255, 107, 107, 0.7)',
                'rgba(139, 92, 246, 0.7)',
                'rgba(0, 102, 204, 0.7)',
                'rgba(14, 165, 233, 0.7)'
              ],
              borderWidth: 1,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            }
          }
        });
      }
      
      // Revenue Chart
      const revenueCtx = document.getElementById('revenueChart');
      if (revenueCtx) {
        new Chart(revenueCtx, {
          type: 'line',
          data: {
            labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
            datasets: [{
              label: 'الإيرادات',
              data: [12000, 15000, 18000, 14000, 20000, 22000],
              fill: true,
              backgroundColor: 'rgba(0, 102, 204, 0.1)',
              borderColor: 'rgb(0, 102, 204)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            }
          }
        });
      }
    }
    
    // ========== EVENT LISTENERS ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize
      updateConnectionStatus(firebaseManager.isConnected);
      renderPatients();
      renderInvoices();
      renderServices();
      initializeCharts();
      
      // Set current date
      const today = new Date();
      document.getElementById('currentDate').textContent = today.toLocaleDateString("ar-EG", {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      
      // Tab navigation
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          button.classList.add('active');
          document.getElementById(`${tabName}Tab`).classList.add('active');
        });
      });
      
      // Patient form
      document.getElementById('patientForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = {
          name: document.getElementById('name').value.trim(),
          age: document.getElementById('age').value,
          nid: document.getElementById('nid').value.trim(),
          gender: document.getElementById('gender').value,
          bloodType: document.getElementById('bloodType').value,
          phone: document.getElementById('phone').value.trim(),
          address: document.getElementById('address').value.trim(),
          diseases: document.getElementById('diseases').value.trim(),
          department: document.getElementById('department').value
        };
        
        localDB.addPatient(formData);
        
        Swal.fire({
          icon: 'success',
          title: 'تم التسجيل',
          text: 'تم تسجيل المريض بنجاح',
          timer: 2000,
          showConfirmButton: false
        });
        
        document.getElementById('patientForm').reset();
        renderPatients();
      });
      
      // Service form
      document.getElementById('serviceForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = {
          name: document.getElementById('serviceName').value.trim(),
          type: document.getElementById('serviceType').value,
          price: parseFloat(document.getElementById('servicePrice').value),
          description: document.getElementById('serviceDescription').value.trim()
        };
        
        localDB.addService(formData);
        
        Swal.fire({
          icon: 'success',
          title: 'تم الإضافة',
          text: 'تم إضافة الخدمة بنجاح',
          timer: 2000,
          showConfirmButton: false
        });
        
        document.getElementById('serviceForm').reset();
        renderServices();
      });
      
      // Filters and search
      document.getElementById('filterDepartment').addEventListener('change', () => {
        const filter = document.getElementById('filterDepartment').value;
        const searchTerm = document.getElementById('searchPatient').value;
        renderPatients(filter, searchTerm);
      });
      
      document.getElementById('searchPatient').addEventListener('input', () => {
        const filter = document.getElementById('filterDepartment').value;
        const searchTerm = document.getElementById('searchPatient').value;
        renderPatients(filter, searchTerm);
      });
      
      document.getElementById('searchService').addEventListener('input', () => {
        const searchTerm = document.getElementById('searchService').value;
        renderServices(searchTerm);
      });
      
      // Invoice modal
      document.getElementById('generateInvoiceBtn').addEventListener('click', () => {
        document.getElementById('invoiceModal').classList.remove('hidden');
        document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
        loadServicesForInvoice();
        loadPatientsForInvoice();
      });
      
      document.getElementById('closeInvoiceModal').addEventListener('click', () => {
        document.getElementById('invoiceModal').classList.add('hidden');
        selectedServices.clear();
        selectedPaymentMethod = null;
        updateInvoiceSummary();
      });
      
      // Payment method selection
      document.querySelectorAll('.payment-method-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.payment-method-option').forEach(opt => {
            opt.classList.remove('border-purple-500', 'bg-purple-50');
          });
          
          option.classList.add('border-purple-500', 'bg-purple-50');
          selectedPaymentMethod = option.dataset.method;
        });
      });
      
      // Invoice form
      document.getElementById('invoiceForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        if (selectedServices.size === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'لا توجد خدمات',
            text: 'يرجى اختيار خدمات أولاً'
          });
          return;
        }
        
        if (!selectedPaymentMethod) {
          Swal.fire({
            icon: 'warning',
            title: 'طريقة الدفع',
            text: 'يرجى اختيار طريقة الدفع'
          });
          return;
        }
        
        const patientId = document.getElementById('invoicePatient').value;
        const patient = localDB.getPatients()[patientId];
        
        const servicesArray = Array.from(selectedServices.values());
        const totalAmount = servicesArray.reduce((sum, service) => sum + (service.price * service.quantity), 0);
        
        const invoiceData = {
          patientId,
          patientName: patient.name,
          date: document.getElementById('invoiceDate').value,
          services: servicesArray,
          subtotal: totalAmount,
          totalAmount,
          paymentMethod: selectedPaymentMethod,
          notes: document.getElementById('invoiceNotes')?.value || '',
          status: selectedPaymentMethod === 'cash' ? 'paid' : 'pending'
        };
        
        localDB.addInvoice(invoiceData);
        
        Swal.fire({
          icon: 'success',
          title: 'تم الإنشاء',
          text: 'تم إنشاء الفاتورة بنجاح',
          timer: 2000,
          showConfirmButton: false
        });
        
        document.getElementById('invoiceModal').classList.add('hidden');
        document.getElementById('invoiceForm').reset();
        selectedServices.clear();
        selectedPaymentMethod = null;
        renderInvoices();
      });
      
      // Print invoice
      document.getElementById('printInvoiceBtn').addEventListener('click', () => {
        if (selectedServices.size === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'لا توجد خدمات',
            text: 'يرجى اختيار خدمات أولاً'
          });
          return;
        }
        
        // Create a temporary invoice for printing
        const patientId = document.getElementById('invoicePatient').value;
        const patient = localDB.getPatients()[patientId];
        const servicesArray = Array.from(selectedServices.values());
        const totalAmount = servicesArray.reduce((sum, service) => sum + (service.price * service.quantity), 0);
        
        const tempInvoice = {
          invoiceNumber: localDB.generateInvoiceNumber(),
          patientName: patient ? patient.name : '---',
          date: document.getElementById('invoiceDate').value,
          services: servicesArray,
          subtotal: totalAmount,
          totalAmount,
          paymentMethod: selectedPaymentMethod
        };
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <html dir="rtl">
          <head>
            <title>فاتورة - ${tempInvoice.invoiceNumber}</title>
            <style>
              body { font-family: 'Cairo', sans-serif; padding: 20px; }
              .header { text-align: center; margin-bottom: 30px; }
              .info { margin-bottom: 20px; }
              .services { margin: 20px 0; }
              .service-item { padding: 10px; border-bottom: 1px solid #ddd; }
              .summary { margin-top: 20px; }
              .summary-row { display: flex; justify-content: space-between; margin: 5px 0; }
              .total { font-weight: bold; font-size: 18px; border-top: 2px solid #000; padding-top: 10px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>مستشفى الحياة الذكية</h1>
              <h2>فاتورة رقم: ${tempInvoice.invoiceNumber}</h2>
              <p>التاريخ: ${formatDate(tempInvoice.date)}</p>
            </div>
            
            <div class="info">
              <p><strong>المريض:</strong> ${tempInvoice.patientName}</p>
              <p><strong>طريقة الدفع:</strong> ${tempInvoice.paymentMethod || '---'}</p>
            </div>
            
            <div class="services">
              <h3>الخدمات:</h3>
              ${tempInvoice.services.map(s => `
                <div class="service-item">
                  ${s.name} - ${formatCurrency(s.price)} × ${s.quantity} = ${formatCurrency(s.price * s.quantity)}
                </div>
              `).join('')}
            </div>
            
            <div class="summary">
              <div class="summary-row">
                <span>المجموع الفرعي:</span>
                <span>${formatCurrency(tempInvoice.subtotal)}</span>
              </div>
              <div class="total">
                <span>المبلغ الإجمالي:</span>
                <span>${formatCurrency(tempInvoice.totalAmount)}</span>
              </div>
            </div>
          </body>
          </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
      });
      
      // Export invoices
      document.getElementById('exportInvoicesBtn').addEventListener('click', () => {
        const invoices = localDB.getInvoices();
        const csvContent = generateCSV(invoices);
        downloadCSV(csvContent, 'invoices.csv');
      });
      
      // Generate report
      document.getElementById('generateReportBtn').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFont('Cairo', 'normal');
        doc.setFontSize(18);
        doc.text('تقرير مستشفى الحياة الذكية', 105, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text(`التاريخ: ${today.toLocaleDateString('ar-EG')}`, 105, 25, { align: 'center' });
        
        // Add statistics
        const patients = localDB.getPatients();
        const invoices = localDB.getInvoices();
        
        doc.setFontSize(14);
        doc.text('إحصائيات المرضى:', 20, 40);
        doc.setFontSize(12);
        doc.text(`إجمالي المرضى: ${Object.keys(patients).length}`, 20, 50);
        
        doc.text('إحصائيات الفواتير:', 20, 70);
        doc.text(`إجمالي الفواتير: ${Object.keys(invoices).length}`, 20, 80);
        
        const totalRevenue = Object.values(invoices)
          .filter(inv => inv.status === 'paid')
          .reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        doc.text(`إجمالي الإيرادات: ${formatCurrency(totalRevenue)}`, 20, 90);
        
        doc.save('تقرير-مستشفى.pdf');
      });
      
      // Refresh data
      document.getElementById('refreshDataBtn').addEventListener('click', () => {
        showLoading();
        setTimeout(() => {
          renderPatients();
          renderInvoices();
          renderServices();
          updateStatistics();
          hideLoading();
          
          Swal.fire({
            icon: 'success',
            title: 'تم التحديث',
            text: 'تم تحديث البيانات بنجاح',
            timer: 1500,
            showConfirmButton: false
          });
        }, 1000);
      });
      
      // Sync button
      document.getElementById('syncButton').addEventListener('click', async () => {
        const syncButton = document.getElementById('syncButton');
        syncButton.classList.add('syncing');
        
        try {
          const localData = localDB.getData();
          const success = await firebaseManager.syncToFirebase(localData);
          
          if (success) {
            Swal.fire({
              icon: 'success',
              title: 'تمت المزامنة',
              text: 'تم مزامنة البيانات مع Firebase بنجاح',
              timer: 2000,
              showConfirmButton: false
            });
            updateConnectionStatus(true);
          } else {
            Swal.fire({
              icon: 'error',
              title: 'فشلت المزامنة',
              text: 'لا يمكن الاتصال بـ Firebase'
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'حدث خطأ أثناء المزامنة'
          });
        } finally {
          syncButton.classList.remove('syncing');
        }
      });
    });
    
    // ========== UTILITY FUNCTIONS ==========
    function generateCSV(data) {
      const headers = ['رقم الفاتورة', 'المريض', 'التاريخ', 'المبلغ', 'الحالة'];
      const rows = Object.values(data).map(invoice => [
        invoice.invoiceNumber,
        invoice.patientName,
        formatDate(invoice.date),
        invoice.totalAmount,
        invoice.status === 'paid' ? 'مدفوعة' : invoice.status === 'pending' ? 'معلقة' : 'ملغاة'
      ]);
      
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');
      
      return csvContent;
    }
    
    function downloadCSV(content, filename) {
      const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Auto-save every 30 seconds
    setInterval(() => {
      localDB.updateLastSync();
    }, 30000);
    
    // Show welcome message
    setTimeout(() => {
      Swal.fire({
        icon: 'info',
        title: 'مرحباً بك في مستشفى الحياة الذكية',
        text: 'النظام يعمل حالياً بشكل محلي. يمكنك استخدامه بالكامل ومزامنة البيانات لاحقاً.',
        confirmButtonText: 'حسناً'
      });
    }, 1000);
  </script>
</body>
</html>
