<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>قسم الاستقبال - مستشفى الحياة الذكية</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBWmoydkI2Z4W0NDnAy48bbN7l-U-F6mM",
      authDomain: "hospital-1d15c.firebaseapp.com",
      projectId: "hospital-1d15c",
      storageBucket: "hospital-1d15c.appspot.com",
      messagingSenderId: "1038078501376",
      appId: "1:1038078501376:web:1fa32566a390042f8ed009",
      databaseURL: "https://hospital-1d15c-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("patientForm");
      const stats = document.getElementById("stats");
      const patientsList = document.getElementById("patientsList");

      const departments = ["emergency", "icu", "surgery", "care", "admin"];

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const name = this.name.value.trim();
        const age = this.age.value.trim();
        const nid = this.nid.value.trim();
        const department = this.department.value;

        if (!name || !age || !nid || !department) {
          Swal.fire({
            icon: 'warning',
            title: 'تنبيه!',
            text: 'يرجى ملء جميع الحقول.',
            confirmButtonText: 'حسنًا'
          });
          return;
        }

        const patient = {
          name,
          age,
          nid,
          department,
          entryDate: new Date().toLocaleDateString("ar-EG"),
          doctor: "لم يُحدد بعد",
          status: "مستقر"
        };

        try {
          const dbRef = ref(db, `patients/${department}`);
          await push(dbRef, patient);

          Swal.fire({
            icon: 'success',
            title: 'تم التسجيل بنجاح ✅',
            text: `تم تحويل المريض إلى قسم ${getDeptName(department)}`,
            timer: 3000,
            timerProgressBar: true,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
          });

          this.reset();
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: '❌ فشل التسجيل',
            text: error.message
          });
        }
      });

      function getDeptName(dept) {
        switch (dept) {
          case 'emergency': return 'الطوارئ';
          case 'icu': return 'العناية المركزة';
          case 'surgery': return 'العمليات';
          case 'care': return 'الرعاية';
          case 'admin': return 'الإدارة';
          default: return dept;
        }
      }

      function loadStatsAndPatients() {
        stats.innerHTML = "";
        patientsList.innerHTML = "";

        departments.forEach(dept => {
          const deptRef = ref(db, `patients/${dept}`);
          onValue(deptRef, snapshot => {
            const data = snapshot.val();
            const count = data ? Object.keys(data).length : 0;

            const stat = document.createElement("div");
            stat.innerHTML = `<strong>${getDeptName(dept)}:</strong> ${count} مريض`;
            stats.appendChild(stat);

            if (dept === "emergency" && data) {
              for (let key in data) {
                const p = data[key];
                const card = document.createElement("div");
                card.className = "patient-card";
                card.innerHTML = `
                  <h4>${p.name}</h4>
                  <p>العمر: ${p.age}</p>
                  <p>الرقم القومي: ${p.nid}</p>
                  <p>تاريخ الدخول: ${p.entryDate}</p>
                  <p>الحالة: ${p.status}</p>
                  <button class="delete" data-key="${key}">حذف</button>
                `;
                patientsList.appendChild(card);
              }

              patientsList.querySelectorAll(".delete").forEach(btn => {
                btn.addEventListener("click", async function () {
                  const key = this.getAttribute("data-key");

                  Swal.fire({
                    title: 'هل أنت متأكد؟',
                    text: "لن تتمكن من التراجع!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'نعم، احذفه',
                    cancelButtonText: 'إلغاء'
                  }).then(async (result) => {
                    if (result.isConfirmed) {
                      try {
                        await remove(ref(db, `patients/emergency/${key}`));
                        Swal.fire({
                          icon: 'success',
                          title: 'تم الحذف بنجاح',
                          toast: true,
                          position: 'top-end',
                          showConfirmButton: false,
                          timer: 2000
                        });
                      } catch (err) {
                        Swal.fire({
                          icon: 'error',
                          title: 'حدث خطأ',
                          text: err.message
                        });
                      }
                    }
                  });
                });
              });
            }
          });
        });
      }

      loadStatsAndPatients();
    });
  </script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
      direction: rtl;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
    }

    form, .stats, .patients {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .patient-card {
      background: #e0f7fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
    }

    .delete {
      background-color: #c0392b;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h1>قسم الاستقبال - مستشفى الحياة الذكية</h1>

  <section class="stats" id="stats">
    <h3>إحصائيات الأقسام</h3>
  </section>

  <section class="form">
    <form id="patientForm">
      <h3>تسجيل مريض جديد</h3>
      <label>الاسم:</label>
      <input type="text" name="name" required />
      <label>العمر:</label>
      <input type="number" name="age" required />
      <label>الرقم القومي:</label>
      <input type="text" name="nid" required maxlength="14" />
      <label>القسم:</label>
      <select name="department" required>
        <option value="">اختر القسم</option>
        <option value="emergency">الطوارئ</option>
        <option value="icu">العناية المركزة</option>
        <option value="surgery">العمليات</option>
        <option value="care">الرعاية</option>
        <option value="admin">الإدارة</option>
      </select>
      <button type="submit">تسجيل</button>
    </form>
  </section>

  <section class="patients">
    <h3>المرضى في قسم الطوارئ</h3>
    <div id="patientsList"></div>
  </section>
</body>
</html>
