<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اختبار اتصال Firebase - الدكاترة</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body style="font-family: sans-serif; padding: 20px;">
  <h2>اختبار عرض الدكاترة</h2>

  <label>اختر القسم:</label>
  <select id="department">
    <option value="">-- اختر القسم --</option>
    <option value="emergency">الطوارئ</option>
    <option value="icu">العناية المركزة</option>
    <option value="surgery">العمليات</option>
    <option value="care">الرعاية</option>
    <option value="radiology">الأشعة</option>
  </select>

  <br><br>

  <label>الدكاترة المتاحين:</label>
  <select id="doctor">
    <option value="">اختر القسم أولاً</option>
  </select>

  <script type="module">
    // استيراد Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Config بتاعك
    const firebaseConfig = {
      apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
      authDomain: "hospital-project-e4b59.firebaseapp.com",
      databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hospital-project-e4b59",
      storageBucket: "hospital-project-e4b59.firebasestorage.app",
      messagingSenderId: "974610606258",
      appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
      measurementId: "G-0GV30LL28T"
    };

    // تهيئة Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // عناصر HTML
    const departmentSelect = document.getElementById("department");
    const doctorSelect = document.getElementById("doctor");

    // تحديد الورديه الحالية
    function getCurrentShift() {
      const now = new Date();
      const currentHour = now.getHours();
      const dayName = now.toLocaleString('en-US', { weekday: 'long' });

      let shift;
      if (currentHour >= 8 && currentHour < 16) shift = "Morning";
      else if (currentHour >= 16 && currentHour < 24) shift = "Evening";
      else shift = "Night";

      return { shift, dayName };
    }

    // تحميل الدكاترة
    function loadDoctors() {
      const selectedDept = departmentSelect.value;
      if (!selectedDept) {
        doctorSelect.innerHTML = '<option value="">اختر القسم أولاً</option>';
        return;
      }

      const { shift, dayName } = getCurrentShift();
      const doctorsRef = ref(db, 'doctors');

      onValue(doctorsRef, (snapshot) => {
        console.log("كل الدكاترة في قاعدة البيانات:");
        console.log(snapshot.val()); // عرض كل البيانات للتأكد

        if (!snapshot.exists()) {
          Swal.fire("تنبيه", "مفيش دكاترة في قاعدة البيانات", "warning");
          doctorSelect.innerHTML = '<option value="">لا يوجد بيانات</option>';
          return;
        }

        doctorSelect.innerHTML = '<option value="">اختر الدكتور</option>';
        let found = false;

        snapshot.forEach(childSnapshot => {
          const doctor = childSnapshot.val();

          if (
            doctor.department === selectedDept &&
            doctor.shift === shift &&
            doctor.workDays.includes(dayName) &&
            doctor.manualStatus === "online"
          ) {
            const option = document.createElement("option");
            option.value = doctor.id;
            option.textContent = `${doctor.name} - ${doctor.shift}`;
            doctorSelect.appendChild(option);
            found = true;
          }
        });

        if (!found) {
          doctorSelect.innerHTML = '<option value="">لا يوجد دكاترة متاحين الآن</option>';
        } else {
          Swal.fire("نجاح", "تم جلب بيانات الدكاترة بنجاح", "success");
        }
      });
    }

    departmentSelect.addEventListener("change", loadDoctors);
  </script>
</body>
</html>
