<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اختبار عرض الدكاترة</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body style="font-family: sans-serif; padding: 20px;">

  <h2>اختبار عرض الدكاترة حسب القسم</h2>

  <!-- اختيار القسم -->
  <label>اختر القسم:</label>
  <select id="department">
    <option value="">-- اختر القسم --</option>
    <option value="emergency">الطوارئ</option>
    <option value="icu">العناية المركزة</option>
    <option value="surgery">العمليات</option>
    <option value="care">الرعاية</option>
    <option value="radiology">الأشعة</option>
  </select>

  <br><br>

  <!-- اختيار الدكتور -->
  <label>الدكاترة المتاحين:</label>
  <select id="doctor">
    <option value="">اختر القسم أولاً</option>
  </select>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // عناصر HTML
    const departmentSelect = document.getElementById("department");
    const doctorSelect = document.getElementById("doctor");

    // تحديد الورديه الحالية
    function getCurrentShift() {
      const now = new Date();
      const currentHour = now.getHours();
      const dayName = now.toLocaleString('en-US', { weekday: 'long' });

      let shift;
      if (currentHour >= 8 && currentHour < 16) shift = "Morning";
      else if (currentHour >= 16 && currentHour < 24) shift = "Evening";
      else shift = "Night";

      return { shift, dayName };
    }

    // تحميل الدكاترة
    function loadDoctors() {
      const selectedDept = departmentSelect.value;
      if (!selectedDept) {
        doctorSelect.innerHTML = '<option value="">اختر القسم أولاً</option>';
        return;
      }

      const { shift, dayName } = getCurrentShift();
      const doctorsRef = ref(db, 'doctors');

      onValue(doctorsRef, (snapshot) => {
        doctorSelect.innerHTML = '<option value="">اختر الدكتور</option>';
        let found = false;

        // طباعة كل الدكاترة في Console للفحص
        console.log("كل الدكاترة في قاعدة البيانات:");
        snapshot.forEach(childSnapshot => {
          console.log(childSnapshot.val());
        });

        // فلترة وعرض الدكاترة
        snapshot.forEach(childSnapshot => {
          const doctor = childSnapshot.val();

          if (
            doctor.department === selectedDept &&
            doctor.shift === shift &&
            doctor.workDays.includes(dayName) &&
            doctor.manualStatus === "online"
          ) {
            const option = document.createElement("option");
            option.value = doctor.id;
            option.textContent = `${doctor.name} - ${doctor.shift}`;
            doctorSelect.appendChild(option);
            found = true;
          }
        });

        if (!found) {
          doctorSelect.innerHTML = '<option value="">لا يوجد دكاترة متاحين الآن</option>';
        }
      });
    }

    // لما يغير القسم
    departmentSelect.addEventListener("change", loadDoctors);
  </script>
</body>
</html>
