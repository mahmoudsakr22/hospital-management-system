<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1"
  />
  <title>قسم الطوارئ - مستشفى الحياة الذكية</title>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <style>
    :root{
      --primary:#1d4ed8; --secondary:#0ea5e9; --danger:#ef4444; --warning:#f59e0b;
      --success:#10b981; --muted:#64748b; --bg:#f1f5f9; --card:#ffffff; --ring:rgba(29,78,216,.15)
    }
    *{box-sizing:border-box}
    body{font-family:'Cairo',system-ui,Arial;background:var(--bg);color:#0f172a}
    .container-lg{max-width:1250px;margin:0 auto}
    .glass{background:rgba(255,255,255,.85);backdrop-filter:saturate(150%) blur(6px)}
    .shadow-soft{box-shadow:0 10px 25px rgba(0,0,0,.06)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border-radius:.75rem;font-weight:600;transition:.2s}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#0b3bb0);color:#fff}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 12px 20px rgba(29,78,216,.25)}
    .btn-secondary{background:#e2e8f0;color:#0f172a}
    .btn-secondary:hover{background:#cbd5e1}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#c02626);color:#fff}
    .btn-success{background:linear-gradient(135deg,#10b981,#0f766e);color:#fff}
    .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;font-size:.78rem;font-weight:600;border:1px solid rgba(0,0,0,.06)}
    .chip.critical{background:rgba(239,68,68,.1); color:#b91c1c; border-color:rgba(239,68,68,.25)}
    .chip.deteriorating{background:rgba(249,115,22,.1);color:#c2410c;border-color:rgba(249,115,22,.25)}
    .chip.improving{background:rgba(245,158,11,.1);color:#b45309;border-color:rgba(245,158,11,.25)}
    .chip.stable{background:rgba(16,185,129,.1);color:#065f46;border-color:rgba(16,185,129,.25)}
    .card{background:var(--card);border-radius:1rem}
    .ring{box-shadow:0 0 0 4px var(--ring)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table thead th{font-size:.85rem;color:#475569;text-align:center;padding:.75rem}
    .table tbody tr{background:var(--card)}
    .table tbody td{padding:.8rem;text-align:center;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}
    .table tbody tr td:first-child{border-radius:12px 0 0 12px;border-left:1px solid #e5e7eb}
    .table tbody tr td:last-child{border-radius:0 12px 12px 0;border-right:1px solid #e5e7eb}
    .search-input{width:100%;padding:.8rem 1rem;border:2px solid #e2e8f0;border-radius:.8rem;transition:.2s}
    .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(29,78,216,.12)}
    .badge{font-size:.72rem;border:1px dashed #cbd5e1;padding:.18rem .5rem;border-radius:.5rem;color:#334155;background:#f8fafc}
    .divider{height:1px;background:#e2e8f0;margin:1rem 0}
    .sticky-card{position:sticky;top:16px}
    .empty{display:flex;flex-direction:column;align-items:center;gap:8px;color:#64748b;padding:2rem}
    .toast{position:fixed;bottom:20px;right:20px;display:flex;gap:.75rem;align-items:center;background:#111827;color:#fff;padding:.9rem 1rem;border-radius:.9rem;box-shadow:0 12px 30px rgba(0,0,0,.25);z-index:1000;transform:translateY(10px);opacity:0;pointer-events:none}
    .toast.show{animation:toastIn .2s forwards}
    @keyframes toastIn{to{transform:translateY(0);opacity:1;pointer-events:auto}}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:90}
    .modal{position:fixed;inset:0;display:none;place-items:center;z-index:100}
    .modal.show,.modal-backdrop.show{display:grid}
    .input{width:100%;padding:.7rem .9rem;border:2px solid #e5e7eb;border-radius:.75rem;transition:.2s}
    .input:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 4px rgba(14,165,233,.15)}
    .select{width:100%;padding:.7rem .9rem;border:2px solid #e5e7eb;border-radius:.75rem}
    .label{font-weight:700;font-size:.9rem;color:#334155;margin-bottom:.35rem}
    .pill{border-radius:999px;padding:.25rem .7rem;background:#eef2ff;color:#3730a3;font-weight:700;font-size:.75rem}
    .kbd{background:#111827;color:#e5e7eb;border-radius:.35rem;padding:.05rem .35rem;font-weight:700}
    .fade-in{animation:fade .25s ease-out}
    @keyframes fade{from{opacity:.5;transform:translateY(4px)}to{opacity:1;transform:none}}
  </style>
</head>

<body>
  <!-- Header -->
  <header class="container-lg px-4 py-6">
    <div class="card glass shadow-soft p-4 md:p-6">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-2xl bg-red-600 text-white grid place-items-center text-2xl shadow-lg">
            <i class="fas fa-ambulance"></i>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold">قسم الطوارئ</h1>
            <p class="text-sm text-gray-600">إدارة حالات الطوارئ في الوقت الفعلي</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span class="badge">
            اختصار سريع: <span class="kbd">N</span> لإضافة مريض
          </span>
          <button id="btnOpenCreate" class="btn btn-primary">
            <i class="fa fa-plus"></i> إضافة مريض
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container-lg px-4 pb-16">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Sidebar Stats -->
      <aside class="lg:col-span-1 sticky-card">
        <div class="card p-4 shadow-soft">
          <h2 class="font-bold text-lg mb-4">إحصائيات سريعة</h2>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 rounded-xl bg-blue-50">
              <div class="text-xs text-blue-800 mb-1">إجمالي</div>
              <div id="statTotal" class="text-2xl font-extrabold">0</div>
            </div>
            <div class="p-3 rounded-xl bg-red-50">
              <div class="text-xs text-red-800 mb-1">حرجة</div>
              <div id="statCritical" class="text-2xl font-extrabold">0</div>
            </div>
            <div class="p-3 rounded-xl bg-yellow-50">
              <div class="text-xs text-yellow-800 mb-1">في تدهور</div>
              <div id="statDeteriorating" class="text-2xl font-extrabold">0</div>
            </div>
            <div class="p-3 rounded-xl bg-amber-50">
              <div class="text-xs text-amber-800 mb-1">في تحسن</div>
              <div id="statImproving" class="text-2xl font-extrabold">0</div>
            </div>
            <div class="p-3 rounded-xl bg-emerald-50">
              <div class="text-xs text-emerald-800 mb-1">مستقرة</div>
              <div id="statStable" class="text-2xl font-extrabold">0</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="text-sm text-gray-600">
            آخر تحديث: <span id="lastUpdate">-</span>
          </div>
        </div>

        <div class="card p-4 shadow-soft mt-6">
          <h3 class="font-bold mb-3">إرشادات</h3>
          <ul class="space-y-2 text-sm text-gray-600">
            <li>استخدم البحث السريع باسم/الرقم القومي.</li>
            <li>فلتر حسب الحالة/التاريخ من الشريط العلوي.</li>
            <li>انقر على صف لتعديل المريض.</li>
            <li>زر <span class="kbd">Del</span> يحذف المحدد (بعد تأكيد).</li>
          </ul>
        </div>
      </aside>

      <!-- Content -->
      <section class="lg:col-span-3">
        <!-- Filters -->
        <div class="card p-4 shadow-soft mb-4">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div class="md:col-span-2">
              <label class="label">بحث</label>
              <input id="searchInput" class="input" type="text" placeholder="ابحث بالاسم / الرقم القومي / المعرف"/>
            </div>
            <div>
              <label class="label">الحالة</label>
              <select id="statusFilter" class="select">
                <option value="">جميع الحالات</option>
                <option value="critical">حالة حرجة</option>
                <option value="deteriorating">في تدهور</option>
                <option value="improving">في تحسن</option>
                <option value="stable">مستقرة</option>
              </select>
            </div>
            <div>
              <label class="label">التاريخ</label>
              <input id="dateFilter" class="input" type="date"/>
            </div>
            <div>
              <label class="label">ترتيب حسب</label>
              <select id="sortFilter" class="select">
                <option value="newest">الأحدث أولًا</option>
                <option value="oldest">الأقدم أولًا</option>
                <option value="critical">الأكثر أولوية</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="card p-2 md:p-4 shadow-soft">
          <div class="flex items-center justify-between mb-3 px-2">
            <div class="text-sm text-gray-600">
              نتائج: <span id="resultCount">0</span>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnRefresh" class="btn btn-secondary">
                <i class="fa fa-rotate"></i> تحديث
              </button>
              <button id="btnExport" class="btn btn-success">
                <i class="fa fa-file-export"></i> تصدير CSV
              </button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th>المعرف</th>
                  <th>الاسم</th>
                  <th>الرقم القومي</th>
                  <th>العمر</th>
                  <th>الحالة</th>
                  <th>وقت التسجيل</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div id="emptyState" class="empty hidden">
            <i class="fa-regular fa-face-frown text-3xl"></i>
            <div class="font-bold">لا توجد بيانات مطابقة</div>
            <div class="text-sm">جرّب تغيير خيارات البحث/التصفية</div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal: Create / Edit -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modal" class="modal">
    <div class="card shadow-soft w-[95vw] max-w-2xl p-4 md:p-6 fade-in">
      <div class="flex items-center justify-between mb-4">
        <h3 id="modalTitle" class="text-xl font-extrabold">إضافة مريض</h3>
        <button id="btnCloseModal" class="btn btn-secondary">
          <i class="fa fa-xmark"></i> إغلاق
        </button>
      </div>

      <form id="patientForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label">الاسم الكامل</label>
          <input id="fName" class="input" type="text" placeholder="مثال: أحمد محمد" required/>
        </div>
        <div>
          <label class="label">الرقم القومي</label>
          <input id="fNid" class="input" type="text" placeholder="14 رقم" minlength="10" required/>
        </div>
        <div>
          <label class="label">العمر</label>
          <input id="fAge" class="input" type="number" min="0" max="120" placeholder="بالسنوات" required/>
        </div>
        <div>
          <label class="label">الحالة</label>
          <select id="fStatus" class="select" required>
            <option value="">اختر الحالة</option>
            <option value="critical">حالة حرجة</option>
            <option value="deteriorating">في تدهور</option>
            <option value="improving">في تحسن</option>
            <option value="stable">مستقرة</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="label">التشخيص / الملاحظة</label>
          <textarea id="fNote" class="input" rows="3" placeholder="ملاحظة الطبيب أو سبب الدخول"></textarea>
        </div>

        <div class="md:col-span-2 flex items-center justify-between mt-2">
          <div class="text-sm text-gray-600">
            <span class="pill">سيتم الحفظ مباشرة إلى قاعدة البيانات</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnDelete" type="button" class="btn btn-danger hidden">
              <i class="fa fa-trash"></i> حذف
            </button>
            <button id="btnSubmit" class="btn btn-primary" type="submit">
              <i class="fa fa-save"></i> حفظ
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <i id="toastIcon" class="fa fa-circle-check"></i>
    <div id="toastMsg">تمت العملية بنجاح</div>
  </div>

  <script>
    /*** --------- Firebase Config --------- ***/
    const firebaseConfig = {
      apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
      authDomain: "hospital-project-e4b59.firebaseapp.com",
      databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hospital-project-e4b59",
      storageBucket: "hospital-project-e4b59.appspot.com", // مهم: تم تصحيحها
      messagingSenderId: "974610606258",
      appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
      measurementId: "G-0GV30LL28T"
    };
    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    /*** --------- Constants & State --------- ***/
    const EMERGENCY_PATH = "emergency"; // غيّرها لو داتا الطوارئ في مسار آخر (مثلاً: "patients/emergency")
    let all = {};         // كل المرضى من القاعدة
    let activeId = null;  // المريض الجاري تعديله

    /*** --------- Elements --------- ***/
    const rows = document.getElementById("rows");
    const emptyState = document.getElementById("emptyState");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const dateFilter = document.getElementById("dateFilter");
    const sortFilter = document.getElementById("sortFilter");
    const resultCount = document.getElementById("resultCount");

    const statTotal = document.getElementById("statTotal");
    const statCritical = document.getElementById("statCritical");
    const statDeteriorating = document.getElementById("statDeteriorating");
    const statImproving = document.getElementById("statImproving");
    const statStable = document.getElementById("statStable");
    const lastUpdate = document.getElementById("lastUpdate");

    const btnOpenCreate = document.getElementById("btnOpenCreate");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnExport = document.getElementById("btnExport");

    const modal = document.getElementById("modal");
    const backdrop = document.getElementById("backdrop");
    const modalTitle = document.getElementById("modalTitle");
    const btnCloseModal = document.getElementById("btnCloseModal");

    const form = document.getElementById("patientForm");
    const fName = document.getElementById("fName");
    const fNid = document.getElementById("fNid");
    const fAge = document.getElementById("fAge");
    const fStatus = document.getElementById("fStatus");
    const fNote = document.getElementById("fNote");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnDelete = document.getElementById("btnDelete");

    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    const toastIcon = document.getElementById("toastIcon");

    /*** --------- Utils --------- ***/
    const fmtTime = ts => {
      try {
        const d = new Date(ts || Date.now());
        return d.toLocaleString("ar-EG", { hour12:false });
      } catch { return "-" }
    };
    const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4);

    const showToast = (msg, type="success") => {
      toastMsg.textContent = msg;
      toast.classList.remove("show");
      toastIcon.className = "fa";
      if(type==="success"){ toastIcon.classList.add("fa-circle-check"); toast.style.background = "#065f46"; }
      if(type==="error"){ toastIcon.classList.add("fa-circle-xmark"); toast.style.background = "#7f1d1d"; }
      if(type==="info"){ toastIcon.classList.add("fa-circle-info"); toast.style.background = "#1f2937"; }
      setTimeout(()=> toast.classList.add("show"), 0);
      setTimeout(()=> toast.classList.remove("show"), 2200);
    };

    const openModal = (mode="create", data=null) => {
      modal.classList.add("show"); backdrop.classList.add("show");
      document.body.style.overflow = "hidden";
      if(mode==="create"){
        modalTitle.textContent = "إضافة مريض";
        form.reset(); fStatus.value=""; activeId=null; btnDelete.classList.add("hidden");
      } else {
        modalTitle.textContent = "تعديل مريض";
        activeId = data.id;
        fName.value = data.name || "";
        fNid.value = data.nid || "";
        fAge.value = data.age || "";
        fStatus.value = data.status || "";
        fNote.value = data.note || "";
        btnDelete.classList.remove("hidden");
      }
      setTimeout(()=> fName.focus(), 50);
    };
    const closeModal = () => {
      modal.classList.remove("show"); backdrop.classList.remove("show");
      document.body.style.overflow = "";
    };

    const statusChip = st => {
      const map = {
        critical: {txt:"حالة حرجة",cls:"chip critical",icon:"fa-heart-pulse"},
        deteriorating: {txt:"في تدهور",cls:"chip deteriorating",icon:"fa-arrow-trend-down"},
        improving: {txt:"في تحسن",cls:"chip improving",icon:"fa-arrow-trend-up"},
        stable: {txt:"مستقرة",cls:"chip stable",icon:"fa-circle-check"},
      };
      const s = map[st] || {txt:"-",cls:"chip",icon:"fa-circle"};
      return `<span class="${s.cls}"><i class="fa ${s.icon}"></i>${s.txt}</span>`;
    };

    const escapeCSV = v => `"${String(v ?? "").replace(/"/g,'""')}"`;

    /*** --------- RTDB: Live Subscription --------- ***/
    const emergencyRef = rtdb.ref(EMERGENCY_PATH);

    const applyStats = items => {
      const counts = { total:0, critical:0, deteriorating:0, improving:0, stable:0 };
      items.forEach(p => {
        counts.total++;
        if (counts[p.status] != null) counts[p.status]++;
      });
      statTotal.textContent = counts.total;
      statCritical.textContent = counts.critical;
      statDeteriorating.textContent = counts.deteriorating;
      statImproving.textContent = counts.improving;
      statStable.textContent = counts.stable;
      lastUpdate.textContent = fmtTime(Date.now());
    };

    const render = () => {
      // تحويل الكائن لقائمة
      const items = Object.entries(all).map(([id, p]) => ({ id, ...p }));
      // بحث وتصفية
      const term = (searchInput.value || "").toLowerCase().trim();
      const st = statusFilter.value;
      const dateSel = dateFilter.value; // yyyy-mm-dd

      let filtered = items.filter(p => {
        const inSearch =
          !term ||
          (p.name||"").toLowerCase().includes(term) ||
          (p.nid||"").toLowerCase().includes(term) ||
          (p.id||"").toLowerCase().includes(term);

        const inStatus = !st || p.status === st;

        const inDate = !dateSel || (new Date(p.timestamp||0).toISOString().slice(0,10) === dateSel);

        return inSearch && inStatus && inDate;
      });

      // ترتيب
      const sortBy = sortFilter.value;
      if (sortBy === "newest") filtered.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
      else if (sortBy === "oldest") filtered.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));
      else if (sortBy === "critical"){
        const order = {critical:0, deteriorating:1, improving:2, stable:3};
        filtered.sort((a,b)=> (order[a.status]??9) - (order[b.status]??9));
      }

      // عرض
      rows.innerHTML = "";
      resultCount.textContent = filtered.length;
      if (filtered.length === 0){
        emptyState.classList.remove("hidden");
      } else {
        emptyState.classList.add("hidden");
        for (const p of filtered){
          const tr = document.createElement("tr");
          tr.className = "fade-in";
          tr.innerHTML = `
            <td><span class="badge">${p.id}</span></td>
            <td class="font-bold">${p.name ?? "-"}</td>
            <td>${p.nid ?? "-"}</td>
            <td>${p.age ?? "-"}</td>
            <td>${statusChip(p.status)}</td>
            <td>${fmtTime(p.timestamp)}</td>
            <td>
              <button class="btn btn-secondary" data-action="edit" data-id="${p.id}">
                <i class="fa fa-pen"></i> تعديل
              </button>
              <button class="btn btn-danger" data-action="delete" data-id="${p.id}">
                <i class="fa fa-trash"></i> حذف
              </button>
            </td>
          `;
          rows.appendChild(tr);
        }
      }

      // إحصائيات جانبية
      applyStats(items);
    };

    const subscribe = () => {
      emergencyRef.on("value", snap => {
        all = snap.val() || {};
        render();
      }, err => {
        console.error("RTDB Error:", err);
        showToast("خطأ في الاتصال بقاعدة البيانات: " + err.message, "error");
      });
    };

    /*** --------- CRUD --------- ***/
    const createPatient = async (data) => {
      const id = uid();
      const payload = {
        name: data.name?.trim() || "",
        nid: (data.nid || "").trim(),
        age: Number(data.age || 0),
        status: data.status || "stable",
        note: data.note?.trim() || "",
        timestamp: Date.now()
      };
      await rtdb.ref(`${EMERGENCY_PATH}/${id}`).set(payload);
      return id;
    };

    const updatePatient = async (id, data) => {
      const payload = {
        ...data,
        name: data.name?.trim() || "",
        nid: (data.nid || "").trim(),
        age: Number(data.age || 0),
        timestamp: Date.now()
      };
      await rtdb.ref(`${EMERGENCY_PATH}/${id}`).update(payload);
    };

    const deletePatient = async (id) => {
      await rtdb.ref(`${EMERGENCY_PATH}/${id}`).remove();
    };

    /*** --------- Events --------- ***/
    btnOpenCreate.addEventListener("click", ()=> openModal("create"));
    btnCloseModal.addEventListener("click", closeModal);
    backdrop.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e)=>{
      if(e.key==="Escape") closeModal();
      if(e.key.toLowerCase()==="n"){ openModal("create"); e.preventDefault(); }
      if(e.key==="Delete" && activeId){ // حذف المختار إن وُجد
        confirmDelete(activeId);
      }
    });

    rows.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if(action==="edit"){
        const data = { id, ...(all[id]||{}) };
        openModal("edit", data);
      } else if(action==="delete"){
        confirmDelete(id);
      }
    });

    const confirmDelete = async (id) => {
      const p = all[id];
      if(!p) return;
      const ok = confirm(`هتحذف المريض: ${p.name || id}؟`);
      if(!ok) return;
      try{
        await deletePatient(id);
        showToast("تم حذف المريض بنجاح","success");
        if (activeId === id) activeId = null;
      }catch(err){
        console.error(err);
        showToast("فشل حذف المريض: " + err.message, "error");
      }
    };

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      btnSubmit.disabled = true;

      // تحقق بسيط
      if(!fName.value.trim()){ showToast("من فضلك اكتب اسم المريض","error"); fName.focus(); btnSubmit.disabled=false; return; }
      if(!fStatus.value){ showToast("اختر حالة المريض","error"); fStatus.focus(); btnSubmit.disabled=false; return; }

      const payload = {
        name: fName.value,
        nid: fNid.value,
        age: fAge.value,
        status: fStatus.value,
        note: fNote.value
      };

      try{
        if(activeId){
          await updatePatient(activeId, payload);
          showToast("تم تحديث بيانات المريض","success");
        } else {
          const id = await createPatient(payload);
          showToast("تم إضافة مريض جديد (ID: "+id+")","success");
        }
        closeModal();
      }catch(err){
        console.error(err);
        showToast("فشل الحفظ: " + err.message, "error");
      } finally {
        btnSubmit.disabled = false;
      }
    });

    btnDelete.addEventListener("click", ()=> {
      if(!activeId) return;
      confirmDelete(activeId);
    });

    [searchInput, statusFilter, dateFilter, sortFilter].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    btnRefresh.addEventListener("click", ()=> {
      // إعادة التحميل من السيرفر
      emergencyRef.off("value");
      subscribe();
      showToast("تم تحديث العرض","info");
    });

    btnExport.addEventListener("click", ()=> {
      const items = Object.entries(all).map(([id, p]) => ({id, ...p}));
      if (items.length===0){ showToast("لا توجد بيانات لتصديرها","error"); return; }
      const headers = ["id","name","nid","age","status","note","timestamp"];
      const rowsCSV = items.map(p => headers.map(h=> escapeCSV(p[h])).join(","));
      const csv = [headers.join(","), ...rowsCSV].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "emergency_export.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      showToast("تم تصدير CSV","success");
    });

    /*** --------- Bootstrap --------- ***/
    subscribe();

    // لو أول تشغيل ومفيش داتا، ممكن تضيف مثال بسيط (اختياري جدًا)
    // (مقفل افتراضيًا — شغله لو حابب)
    /*
    ;(async()=>{
      const snap = await emergencyRef.limitToFirst(1).once("value");
      if(!snap.exists()){
        await createPatient({
          name:"مريض تجريبي",
          nid:"00000000000000",
          age:45,
          status:"critical",
          note:"ألم بالصدر"
        });
      }
    })();
    */

  </script>
</body>
</html>
