<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة تحكم الطوارئ - مستشفى الحياة الذكية</title>
    <meta name="description" content="نظام إدارة مرضى قسم الطوارئ في مستشفى الحياة الذكية - لوحة تحكم متقدمة" />
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- START: Alpine.js for interactivity -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- END: Alpine.js -->
    
    <style>
        :root {
            --primary: #3b82f6; --primary-dark: #2563eb;
            --secondary: #10b981; --danger: #ef4444; --warning: #f59e0b;
            
            /* Light Theme */
            --bg-default: #f0f4f9; --bg-secondary: #ffffff; --bg-header: #ffffff;
            --text-default: #1e293b; --text-secondary: #64748b;
            --border-color: #e2e8f0; --shadow-color: rgba(0, 0, 0, 0.05);
        }
        
        html.dark {
            /* Dark Theme */
            --bg-default: #0b1120; --bg-secondary: #1a233a; --bg-header: #1a233a;
            --text-default: #e2e8f0; --text-secondary: #94a3b8;
            --border-color: #334155; --shadow-color: rgba(0, 0, 0, 0.2);
        }
        
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--bg-default);
            color: var(--text-default); transition: background-color 0.3s, color 0.3s;
        }

        /* START: Skeleton Loader Style */
        .skeleton-card { animation: pulse-bg 1.5s infinite; }
        @keyframes pulse-bg { 0%, 100% { background-color: var(--bg-secondary); } 50% { background-color: var(--border-color); } }
        /* END: Skeleton Loader Style */
        
        /* START: New Patient Highlight */
        .new-patient-highlight { animation: new-pulse 2s ease-out; }
        @keyframes new-pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); } }
        /* END: New Patient Highlight */

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .patient-card {
            background: var(--bg-secondary); border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid transparent;
        }
        .patient-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px var(--shadow-color); }
        .patient-card.critical { border-left-color: var(--danger); }
        .patient-card.stable { border-left-color: var(--secondary); }
        .patient-card.improving { border-left-color: var(--warning); }
        .patient-card.deteriorating { border-left-color: #f97316; }
    </style>
</head>

<body x-data="{ isModalOpen: false, patientDetails: null }">

    <!-- Header -->
    <header class="bg-bg-header shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="https://image.cdn2.seaart.me/2025-07-09/d1mo7ble878c73e3dta0-4/3d0cbb13ac1cb6a3c7d657a682e2242e_high.webp" alt="شعار المستشفى" class="h-12 rounded-lg"/>
                <h1 class="text-xl font-extrabold text-text-default">لوحة تحكم الطوارئ</h1>
            </div>
            <div class="flex items-center gap-6">
                <div id="liveClock" class="text-lg font-semibold text-text-secondary hidden md:block"></div>
                <button @click="document.documentElement.classList.toggle('dark')" class="text-text-secondary text-xl">
                    <i class="fas" :class="document.documentElement.classList.contains('dark') ? 'fa-sun' : 'fa-moon'"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6">
        <!-- Statistics Section -->
        <section id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Stats cards will be dynamically inserted here -->
        </section>

        <!-- Filters & Patient List -->
        <div class="bg-bg-secondary p-6 rounded-xl shadow-lg">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                <h2 class="text-2xl font-bold">قائمة المرضى</h2>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary"></i>
                    <input id="searchInput" type="text" placeholder="بحث..." class="bg-bg-default border-2 border-border-color rounded-lg py-2 px-4 pl-10 focus:outline-none focus:border-primary">
                </div>
            </div>
            <div id="patientsList" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Skeleton loaders will be shown here initially -->
            </div>
        </div>
    </main>

    <!-- START: Patient Details Modal -->
    <div x-show="isModalOpen" @keydown.escape.window="isModalOpen = false" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" x-cloak>
        <div @click.away="isModalOpen = false" class="bg-bg-secondary rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8" x-transition>
            <template x-if="patientDetails">
                <div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-3xl font-bold" x-text="patientDetails.name"></h2>
                            <p class="text-text-secondary" x-text="'الرقم القومي: ' + patientDetails.nid"></p>
                        </div>
                        <button @click="isModalOpen = false" class="text-text-secondary hover:text-danger text-2xl">&times;</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-bg-default p-4 rounded-lg">
                            <h3 class="font-bold mb-2">تغيير الحالة</h3>
                            <select x-model="patientDetails.status" class="w-full p-2 border-2 border-border-color rounded-lg bg-bg-secondary focus:outline-none focus:border-primary">
                                <option value="critical">حرجة</option>
                                <option value="deteriorating">في تدهور</option>
                                <option value="improving">في تحسن</option>
                                <option value="stable">مستقرة</option>
                            </select>
                        </div>
                        <div class="bg-bg-default p-4 rounded-lg">
                            <h3 class="font-bold mb-2">تاريخ الوصول</h3>
                            <p class="text-lg" x-text="new Date(patientDetails.timestamp).toLocaleString('ar-EG', { dateStyle: 'full', timeStyle: 'short' })"></p>
                        </div>
                    </div>
                    
                    <div class="bg-bg-default p-4 rounded-lg">
                        <h3 class="font-bold mb-2">ملاحظات الطبيب</h3>
                        <textarea class="w-full h-24 p-2 border-2 border-border-color rounded-lg bg-bg-secondary focus:outline-none focus:border-primary" placeholder="أضف ملاحظاتك هنا..."></textarea>
                    </div>

                    <div class="mt-8 flex justify-end gap-4">
                        <button @click="isModalOpen = false" class="py-2 px-6 rounded-lg bg-border-color text-text-default hover:bg-gray-300 dark:hover:bg-gray-600">إلغاء</button>
                        <button @click="updatePatientStatus(patientDetails.id, patientDetails.status); isModalOpen = false" class="py-2 px-6 rounded-lg btn-primary">حفظ التغييرات</button>
                    </div>
                </div>
            </template>
        </div>
    </div>
    <!-- END: Patient Details Modal -->


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCww7pM0clGr_Nk7Xe3pCnBUJtSaw6nS-k",
            authDomain: "smart-life-hospital.firebaseapp.com",
            databaseURL: "https://smart-life-hospital-default-rtdb.firebaseio.com",
            projectId: "smart-life-hospital",
            storageBucket: "smart-life-hospital.firebasestorage.app",
            messagingSenderId: "988240466536",
            appId: "1:988240466536:web:93e9f945b255cd164361dd",
            measurementId: "G-GEJF0F0ZJ7"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let allPatients = {};
        let patientKeys = new Set();
        const searchInput = document.getElementById('searchInput');

        // Initial setup on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            renderSkeletons();
            startLiveClock();
            searchInput.addEventListener('input', () => renderPatients(filterPatients()));
            const emergencyRef = ref(db, 'patients/emergency');
            
            onValue(emergencyRef, (snapshot) => {
                const newPatientData = snapshot.val() || {};
                const newKeys = new Set(Object.keys(newPatientData));
                const newlyAddedKeys = [...newKeys].filter(key => !patientKeys.has(key));
                
                allPatients = newPatientData;
                patientKeys = newKeys;

                renderPatients(filterPatients(), newlyAddedKeys);
                updateStatistics();
            });
        });

        // UI Rendering Functions
        function renderSkeletons() {
            const list = document.getElementById('patientsList');
            list.innerHTML = Array(6).fill('').map(() => `
                <div class="skeleton-card p-5 rounded-xl space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="h-6 w-1/2 rounded bg-gray-300 dark:bg-gray-700"></div>
                        <div class="h-8 w-1/4 rounded-full bg-gray-300 dark:bg-gray-700"></div>
                    </div>
                    <div class="h-4 w-3/4 rounded bg-gray-300 dark:bg-gray-700"></div>
                    <div class="h-4 w-1/2 rounded bg-gray-300 dark:bg-gray-700"></div>
                </div>
            `).join('');
        }

        function renderPatients(data, newlyAddedKeys = []) {
            const list = document.getElementById('patientsList');
            if (Object.keys(data).length === 0) {
                list.innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-box-open fa-3x text-text-secondary mb-4"></i><h3 class="text-xl font-bold">لا توجد بيانات لعرضها</h3></div>`;
                return;
            }
            list.innerHTML = Object.entries(data).map(([id, patient]) => {
                const statusMap = {
                    critical: { text: "حرجة", icon: "fa-heart-pulse", color: "text-red-500", bg: "bg-red-500/10" },
                    stable: { text: "مستقرة", icon: "fa-check-circle", color: "text-green-500", bg: "bg-green-500/10" },
                    improving: { text: "في تحسن", icon: "fa-arrow-trend-up", color: "text-yellow-500", bg: "bg-yellow-500/10" },
                    deteriorating: { text: "في تدهور", icon: "fa-arrow-trend-down", color: "text-orange-500", bg: "bg-orange-500/10" }
                };
                const status = statusMap[patient.status] || {};
                const isNew = newlyAddedKeys.includes(id);

                return `
                <div class="patient-card ${patient.status} ${isNew ? 'new-patient-highlight' : ''}" x-data="{ dropdownOpen: false }">
                    <div class="p-5">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold">${patient.name}</h3>
                                <p class="text-sm text-text-secondary">العمر: ${patient.age} | الرقم القومي: ${patient.nid}</p>
                            </div>
                            <span class="py-1 px-3 rounded-full text-sm font-semibold ${status.color} ${status.bg}"><i class="fas ${status.icon} ml-2"></i>${status.text}</span>
                        </div>
                        <div class="text-sm text-text-secondary my-4">
                            <i class="fas fa-clock ml-2"></i> وصول: ${new Date(patient.timestamp).toLocaleString('ar-EG')}
                        </div>
                        <div class="flex justify-between items-center">
                             <button @click="isModalOpen = true; patientDetails = {...${JSON.stringify({id, ...patient})}}" class="py-2 px-4 rounded-lg text-sm font-semibold bg-primary/10 text-primary hover:bg-primary/20">
                                <i class="fas fa-eye ml-2"></i>عرض التفاصيل
                            </button>
                            <div class="relative">
                                <button @click="dropdownOpen = !dropdownOpen" class="text-text-secondary hover:text-primary p-2 rounded-full"><i class="fas fa-ellipsis-v"></i></button>
                                <div x-show="dropdownOpen" @click.away="dropdownOpen = false" class="absolute left-0 mt-2 w-40 bg-bg-secondary border border-border-color rounded-lg shadow-xl z-10" x-transition x-cloak>
                                    <a @click="updatePatientStatus('${id}', 'critical'); dropdownOpen = false" href="#" class="block px-4 py-2 text-sm hover:bg-bg-default">حرجة</a>
                                    <a @click="updatePatientStatus('${id}', 'deteriorating'); dropdownOpen = false" href="#" class="block px-4 py-2 text-sm hover:bg-bg-default">في تدهور</a>
                                    <a @click="updatePatientStatus('${id}', 'improving'); dropdownOpen = false" href="#" class="block px-4 py-2 text-sm hover:bg-bg-default">في تحسن</a>
                                    <a @click="updatePatientStatus('${id}', 'stable'); dropdownOpen = false" href="#" class="block px-4 py-2 text-sm hover:bg-bg-default">مستقرة</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function updateStatistics() {
            const statsContainer = document.getElementById('stats');
            const patients = Object.values(allPatients);
            const total = patients.length;
            const waitingTimes = patients.map(p => (Date.now() - p.timestamp) / 60000); // in minutes
            const avgWait = total > 0 ? (waitingTimes.reduce((a, b) => a + b, 0) / total).toFixed(0) : 0;
            const criticalCount = patients.filter(p => p.status === 'critical').length;
            const bedOccupancy = ((total / 50) * 100).toFixed(0); // Assuming 50 beds

            statsContainer.innerHTML = [
                { icon: 'fa-users', value: total, label: 'إجمالي المرضى', color: 'blue' },
                { icon: 'fa-heart-pulse', value: criticalCount, label: 'حالات حرجة', color: 'red' },
                { icon: 'fa-clock', value: `${avgWait} د`, label: 'متوسط الانتظار', color: 'yellow' },
                { icon: 'fa-bed', value: `${bedOccupancy}%`, label: 'إشغال الأسرة', color: 'green' }
            ].map(s => `
                <div class="bg-bg-secondary p-5 rounded-xl shadow-lg flex items-center gap-5">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center bg-${s.color}-500/10 text-${s.color}-500 text-2xl">
                        <i class="fas ${s.icon}"></i>
                    </div>
                    <div>
                        <p class="text-3xl font-extrabold">${s.value}</p>
                        <p class="text-text-secondary font-semibold">${s.label}</p>
                    </div>
                </div>
            `).join('');
        }

        // Logic Functions
        function filterPatients() {
            const term = searchInput.value.toLowerCase();
            return Object.fromEntries(
                Object.entries(allPatients).filter(([id, p]) => 
                    p.name.toLowerCase().includes(term) || p.nid.includes(term)
                ).sort(([, a], [, b]) => b.timestamp - a.timestamp)
            );
        }

        function startLiveClock() {
            const clockEl = document.getElementById('liveClock');
            setInterval(() => {
                clockEl.textContent = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }, 1000);
        }

        // Firebase Interaction
        window.updatePatientStatus = (id, newStatus) => {
            const patientRef = ref(db, `patients/emergency/${id}`);
            update(patientRef, { status: newStatus })
                .catch(err => console.error("Update failed: ", err));
        };
    </script>

</body>
</html>
