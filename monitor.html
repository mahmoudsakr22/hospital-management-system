<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ICU Patient Monitor - Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Cairo for labels, Orbitron for the big numbers to give a digital feel -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Base Styling */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0d1117; /* GitHub Dark Dimmed */
            color: #c9d1d9;
            overflow: hidden; /* No scrolling */
        }

        /* Digital font for vital values */
        .vital-value, .clock {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 0.05em;
        }

        /* Main grid layout for the monitor */
        #monitor-grid {
            display: grid;
            grid-template-columns: 3fr 1fr; /* 75% for waveforms, 25% for vitals */
            grid-template-rows: auto 1fr; /* Patient info row, main content row */
            height: 100vh;
            gap: 8px;
            padding: 8px;
        }

        #patient-info-panel { grid-column: 1 / -1; } /* Span full width */
        #waveform-panel { grid-column: 1 / 2; }
        #vitals-panel { grid-column: 2 / 3; }

        /* Styling for panels */
        .panel {
            background-color: #161b22; /* Slightly lighter than body */
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
        }

        /* Vital Box Styling */
        .vital-box {
            border-left: 5px solid;
            padding: 8px 12px;
            background-color: #0d1117;
            border-radius: 6px;
        }
        .vital-label { font-size: 0.9rem; font-weight: 600; }
        .vital-unit { font-size: 0.8rem; color: #8b949e; }
        .vital-value { font-size: 2.75rem; line-height: 1; }

        /* Color Coding for Vitals */
        .hr-box { border-color: #3fb950; color: #3fb950; }
        .spo2-box { border-color: #38bdf8; color: #38bdf8; }
        .bp-box { border-color: #f0f6fc; color: #f0f6fc; }
        .rr-box { border-color: #d29922; color: #d29922; }
        .temp-box { border-color: #a371f7; color: #a371f7; }

        /* Visual Alarm Animations */
        @keyframes flash-yellow { 50% { background-color: rgba(210, 153, 34, 0.4); } }
        @keyframes flash-red { 50% { background-color: rgba(248, 81, 73, 0.5); } }
        .alarm-warn { animation: flash-yellow 1s infinite; }
        .alarm-crit { animation: flash-red 0.5s infinite; }

        /* Canvas styling */
        canvas {
            width: 100%;
            height: 100%;
            background-color: #010409;
            border-radius: 6px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body>
    <div id="monitor-grid">
        <!-- Patient Info Panel -->
        <div id="patient-info-panel" class="panel flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div>
                    <div class="text-sm text-gray-400">المريض</div>
                    <div class="text-xl font-bold"><span id="patientName">—</span>, <span id="patientAge">—</span> <span id="genderIcon"></span></div>
                </div>
                <div class="border-l border-gray-600 pl-4">
                    <div class="text-sm text-gray-400">معرف</div>
                    <div class="text-lg font-mono" id="patientIdBadge">—</div>
                </div>
                <div class="border-l border-gray-600 pl-4">
                    <div class="text-sm text-gray-400">أمراض مزمنة</div>
                    <div class="text-lg font-bold text-yellow-400" id="patientDiseases">—</div>
                </div>
            </div>
            <div class="text-left">
                 <div class="clock text-3xl font-bold" id="clock">00:00:00</div>
                 <div class="text-sm text-gray-400" id="date"></div>
            </div>
        </div>

        <!-- Waveforms Panel -->
        <div id="waveform-panel" class="panel flex flex-col gap-2">
            <div class="flex-1"><canvas id="ecgCanvas"></canvas></div>
            <div class="flex-1"><canvas id="plethCanvas"></canvas></div>
            <div class="flex-1"><canvas id="respCanvas"></canvas></div>
        </div>

        <!-- Vitals & Alerts Panel -->
        <div id="vitals-panel" class="panel flex flex-col gap-3">
            <!-- Vitals Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div id="hr-box" class="vital-box hr-box col-span-2">
                    <div class="flex justify-between items-baseline">
                        <span class="vital-label">HR</span>
                        <span class="vital-unit">bpm</span>
                    </div>
                    <div class="vital-value text-center" id="hrVal">—</div>
                </div>
                <div id="spo2-box" class="vital-box spo2-box">
                    <div class="vital-label">SpO₂ <span class="vital-unit">%</span></div>
                    <div class="vital-value" id="spo2Val">—</div>
                </div>
                <div id="rr-box" class="vital-box rr-box">
                    <div class="vital-label">RR <span class="vital-unit">/min</span></div>
                    <div class="vital-value" id="rrVal">—</div>
                </div>
            </div>
            <div id="bp-box" class="vital-box bp-box">
                <div class="vital-label">NIBP <span class="vital-unit">mmHg</span></div>
                <div class="vital-value text-2xl">
                    <span id="sysVal">—</span> / <span id="diaVal">—</span>
                </div>
            </div>
            <div id="temp-box" class="vital-box temp-box">
                <div class="vital-label">Temp <span class="vital-unit">°C</span></div>
                <div class="vital-value text-2xl" id="tempVal">—</div>
            </div>

            <!-- AI Alerts & System Messages -->
            <div id="ai-alerts-panel" class="flex-1 flex flex-col bg-gray-900 rounded-lg p-3 mt-2">
                <h3 class="font-bold text-cyan-400 mb-2">رسائل النظام والتنبيهات</h3>
                <div id="ai-analysis-content" class="flex-1 space-y-2 text-sm overflow-y-auto">
                    <p class="text-gray-400">في انتظار البيانات...</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex items-center justify-between gap-2 text-sm">
                <button id="soundToggle" class="px-3 py-2 rounded-md bg-green-600 hover:bg-green-700 transition">تفعيل الصوت</button>
                <div id="connBadge" class="px-3 py-1 rounded-full bg-yellow-800 text-yellow-200">...</div>
                <a id="backLink" href="#" class="text-gray-400 hover:text-white">ملف المريض</a>
            </div>
        </div>
    </div>

    <audio id="audioBeep" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_307ae5843a.mp3" preload="auto"></audio>
    <audio id="audioAlertWarn" src="https://cdn.pixabay.com/download/audio/2022/10/13/audio_a43e40e698.mp3" preload="auto" loop></audio>
    <audio id="audioAlertCritical" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7252e0c144.mp3" preload="auto" loop></audio>
    
<script>
// =============== إعداد Firebase وأدوات مساعدة ===============
const firebaseConfig = { apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0", authDomain: "hospital-project-e4b59.firebaseapp.com", databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app", projectId: "hospital-project-e4b59", storageBucket: "hospital-project-e4b59.firebasestorage.app", messagingSenderId: "974610606258", appId: "1:974610606258:web:71ce7d5d447bca4b4441ab" };
let fb = { enabled: false, app: null, db: null };
try {
    fb.app = firebase.initializeApp(firebaseConfig);
    fb.db = firebase.database();
    fb.enabled = true;
} catch (e) { console.warn("Firebase init failed", e); }

const $ = (id) => document.getElementById(id);

// =============== المتغيرات العامة والحالة ===============
const patientId = new URL(window.location.href).searchParams.get('id') || "-OVjd_eZDCbyD2S14zfc";
const history = []; const MAX_HIST = 200;
const canvases = {
    ecg: { ctx: $('ecgCanvas').getContext('2d'), t: 0, color: '#3fb950' },
    pleth: { ctx: $('plethCanvas').getContext('2d'), t: 0, color: '#38bdf8' },
    resp: { ctx: $('respCanvas').getContext('2d'), t: 0, color: '#d29922' },
};
const audio = {
    beep: $('audioBeep'),
    warn: $('audioAlertWarn'),
    crit: $('audioAlertCritical'),
};
let soundActive = false, beepTimeout = null;
const alarmLimits = { hr: { min: 50, max: 120 }, sys: { min: 90, max: 140 }, spo2: { min: 92, max: 100 }, rr: { min: 10, max: 24 } };

// =============== تحميل وعرض بيانات المريض الثابتة ===============
async function loadPatientHeader() {
    if (!fb.enabled) return;
    try {
        const snap = await fb.db.ref(`/patients/emergency/${patientId}`).get();
        if (!snap.exists()) { console.warn("No patient data"); return; }
        const p = snap.val();
        $('patientName').textContent = p.name || '—';
        $('patientAge').textContent = p.age || '—';
        $('genderIcon').textContent = p.gender === 'male' ? '👨' : '👩';
        $('patientIdBadge').textContent = patientId;
        $('patientDiseases').textContent = p.diseases || 'لا يوجد';
        $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
    } catch (error) { console.error("Error fetching patient data:", error); }
}

// =============== نظام الذكاء الاصطناعي (قاعدة المعرفة) ===============
const medicalKnowledgeBase = { /* ... نفس قاعدة المعرفة من الكود السابق ... */ sepsis:{name:"اشتباه إنتان الدم",trigger:v=>v.hr>100&&v.temp>38&&v.sys<100&&v.rr>22,summary:"مؤشرات التهاب جهازي مع انخفاض ضغط، احتمالية إنتان عالية.",recommendations:["إبلاغ الطبيب فوراً (إنذار حرج).","البدء ببروتوكول الإنتان (Sepsis Bundle).","سحب عينات زرع دم وقياس اللاكتات."]},hypertensiveCrisis:{name:"أزمة ضغط الدم",trigger:v=>v.sys>180||v.dia>110,summary:"ارتفاع حاد في ضغط الدم يتطلب تقييم فوري.",recommendations:["إعادة قياس الضغط وتأكيده.","تقييم الحالة العصبية والقلبية للمريض."]},hypoxia:{name:"نقص الأكسجة",trigger:v=>v.spo2<92,summary:`انخفاض تشبع الأكسجين (${v.spo2}%) يشير لقصور تنفسي.`,recommendations:["رفع رأس السرير وفحص مجرى الهواء.","البدء أو زيادة إمداد الأكسجين."]},stable:{name:"حالة مستقرة",trigger:v=>true,summary:"العلامات الحيوية ضمن النطاق الطبيعي.",recommendations:["الاستمرار بالمراقبة الروتينية."]}};
async function runAIAnalysis(vitals) { for(const key in medicalKnowledgeBase){const c=medicalKnowledgeBase[key];if(c.trigger(vitals))return{condition:c.name,summary:c.summary,recommendations:c.recommendations}} }

function displayAIAnalysis(analysis) {
    if (!analysis) return;
    let colorClass = analysis.condition === "حالة مستقرة" ? "text-green-400" : "text-yellow-400";
    if (analysis.condition.includes("إنتان") || analysis.condition.includes("أزمة")) colorClass = "text-red-400";

    $('ai-analysis-content').innerHTML = `
        <div><strong class="font-bold ${colorClass}">التقييم: ${analysis.condition}</strong></div>
        <p class="text-gray-300">${analysis.summary}</p>
        <ul class="list-disc list-inside mt-1 text-gray-400">
            ${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}
        </ul>`;
}

// =============== دوال الصوت والتنبيهات ===============
function doBeep() {
    if (!soundActive || history.length === 0) return;
    audio.beep.currentTime = 0;
    audio.beep.play().catch(e => {});
    const delay = 60 / (history.at(-1)?.hr || 75) * 1000;
    beepTimeout = setTimeout(doBeep, delay);
}

function handleAlarms(vitals) {
    let crit = false, warn = false;
    const checkAlarm = (val, limits, boxId) => {
        const box = $(boxId);
        box.classList.remove('alarm-warn', 'alarm-crit');
        if (val < limits.min || val > limits.max) {
            // Use a wider margin for critical alarms
            if (val < limits.min * 0.8 || val > limits.max * 1.2) {
                box.classList.add('alarm-crit');
                crit = true;
            } else {
                box.classList.add('alarm-warn');
                warn = true;
            }
        }
    };
    checkAlarm(vitals.hr, alarmLimits.hr, 'hr-box');
    checkAlarm(vitals.spo2, alarmLimits.spo2, 'spo2-box');
    checkAlarm(vitals.sys, alarmLimits.sys, 'bp-box');
    checkAlarm(vitals.rr, alarmLimits.rr, 'rr-box');
    
    if (soundActive) {
        crit ? (audio.warn.pause(), audio.crit.paused && audio.crit.play())
             : warn ? (audio.crit.pause(), audio.warn.paused && audio.warn.play())
             : (audio.warn.pause(), audio.crit.pause());
    }
}

// =============== دوال رسم المخططات ===============
function drawWaveform(canvasInfo, value, periodFactor, amplitude, waveFn) {
    const { ctx, color } = canvasInfo;
    const w = ctx.canvas.width, h = ctx.canvas.height;
    ctx.fillStyle = '#010409'; ctx.fillRect(0, 0, w, h);
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
    const period = Math.max(0.2, 60 / (value || 75) * periodFactor);
    for (let i = 0; i < w; i++) {
        const phase = ((canvasInfo.t + i / 100) % period) / period;
        const y = waveFn(phase);
        const yy = h * (0.5 - y * amplitude);
        i === 0 ? ctx.moveTo(i, yy) : ctx.lineTo(i, yy);
    }
    ctx.stroke();
    canvasInfo.t += 1 / 60;
}

const ecgWave = p => { // p is phase from 0 to 1
    if (p>0.1&&p<0.14) return -0.5; if (p>=0.14&&p<0.18) return 1.4;
    if (p>=0.18&&p<0.22) return -0.3; if (p>0.28&&p<0.36) return 0.25*Math.sin(Math.PI*(p-0.28)/0.08);
    return 0.02 * Math.sin(2 * Math.PI * p * 5) + (Math.random()-0.5)*0.03;
};
const plethWave = p => Math.sin(p * Math.PI * 2) * Math.exp(-3 * p);
const respWave = p => Math.sin(p * Math.PI * 2);

function animateWaveforms() {
    const latestVitals = history.at(-1) || {};
    drawWaveform(canvases.ecg, latestVitals.hr, 1, 0.35, ecgWave);
    drawWaveform(canvases.pleth, latestVitals.hr, 1, 0.4, plethWave);
    drawWaveform(canvases.resp, latestVitals.rr, 1, 0.4, respWave);
    requestAnimationFrame(animateWaveforms);
}

// =============== الدالة الرئيسية لتحديث الواجهة ===============
function render(vitals) {
    if(!vitals) return;
    history.push(vitals);
    if (history.length > MAX_HIST) history.shift();

    $('hrVal').textContent = vitals.hr || '—';
    $('spo2Val').textContent = vitals.spo2 || '—';
    $('sysVal').textContent = vitals.sys || '—';
    $('diaVal').textContent = vitals.dia || '—';
    $('rrVal').textContent = vitals.rr || '—';
    $('tempVal').textContent = (vitals.temp || 0).toFixed(1);

    handleAlarms(vitals);
    runAIAnalysis(vitals).then(displayAIAnalysis);
}

// =============== الاتصال بـ Firebase وبدء التشغيل ===============
function startFirebaseListener() {
    if (!fb.enabled) {
        $('connBadge').textContent = 'Firebase Error'; return;
    }
    const vitalsRef = fb.db.ref(`/patients/emergency/${patientId}/vitalSigns`);
    $('connBadge').textContent = 'Connecting...';
    vitalsRef.on('value', (snapshot) => {
        if (snapshot.exists()) {
            render(snapshot.val());
            $('connBadge').textContent = '● Live';
            $('connBadge').classList.replace('bg-yellow-800', 'bg-green-800');
            $('connBadge').classList.replace('text-yellow-200', 'text-green-200');
        } else {
            $('connBadge').textContent = 'No Data';
        }
    }, (error) => {
        console.error(error);
        $('connBadge').textContent = 'Connection Error';
        $('connBadge').classList.replace('bg-yellow-800', 'bg-red-800');
        $('connBadge').classList.replace('text-yellow-200', 'text-red-200');
    });
}

// =============== تحديث الساعة والتحكم بالأصوات ===============
function updateClock() {
    const now = new Date();
    $('clock').textContent = now.toLocaleTimeString('en-GB');
    $('date').textContent = now.toLocaleDateString('ar-EG-u-nu-latn', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

$('soundToggle').addEventListener('click', () => {
    soundActive = !soundActive;
    const btn = $('soundToggle');
    btn.textContent = soundActive ? 'إيقاف الصوت' : 'تفعيل الصوت';
    btn.classList.toggle('bg-green-600', !soundActive);
    btn.classList.toggle('bg-red-600', soundActive);
    if (soundActive) {
        clearTimeout(beepTimeout);
        doBeep();
    } else {
        clearTimeout(beepTimeout);
        Object.values(audio).forEach(a => { a.pause(); a.currentTime = 0; });
        document.querySelectorAll('.alarm-warn, .alarm-crit').forEach(el => el.classList.remove('alarm-warn', 'alarm-crit'));
    }
});


// =============== بدء التشغيل عند تحميل الصفحة ===============
window.addEventListener('load', () => {
    // Resize canvases initially and on window resize
    Object.values(canvases).forEach(c => {
        c.ctx.canvas.width = c.ctx.canvas.clientWidth;
        c.ctx.canvas.height = c.ctx.canvas.clientHeight;
    });
    window.addEventListener('resize', () => {
        Object.values(canvases).forEach(c => {
            c.ctx.canvas.width = c.ctx.canvas.clientWidth;
            c.ctx.canvas.height = c.ctx.canvas.clientHeight;
        });
    });

    loadPatientHeader();
    startFirebaseListener();
    animateWaveforms();
    setInterval(updateClock, 1000);
    updateClock();
});
</script>
</body>
</html>
