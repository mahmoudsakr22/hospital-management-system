<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>المونيتور الذكي – نظام الرعاية الصحية العالمي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        html, body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
        .card { @apply rounded-2xl shadow-lg p-5 bg-white; }
        .metric { @apply text-3xl font-extrabold tracking-tight; }
        .label { @apply text-sm text-gray-500; }
        .soft { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
        .badge-ok { @apply bg-green-100 text-green-700; }
        .badge-warn { @apply bg-yellow-100 text-yellow-700; }
        .badge-bad { @apply bg-red-100 text-red-700; }
        .badge-critical { @apply bg-red-800 text-white; }
        .badge-high { @apply bg-purple-600 text-white; }
        canvas { image-rendering: pixelated; }
        
        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(to bottom, #1a202c, #2d3748);
            color: #e2e8f0;
        }
        .dark-mode .card {
            background: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode header {
            background: rgba(26, 32, 44, 0.9);
        }
        .dark-mode .bg-slate-50 {
            background-color: #2d3748;
        }
        .dark-mode .text-slate-500 {
            color: #a0aec0;
        }
        .dark-mode .text-slate-800 {
            color: #e2e8f0;
        }
        .dark-mode .border-slate-200 {
            border-color: #4a5568;
        }
        .dark-mode .bg-white {
            background-color: #2d3748;
        }
        .dark-mode .bg-slate-900 {
            background-color: #1a202c;
        }
        
        /* Animations */
        .value-change {
            animation: valueChange 0.5s ease-in-out;
        }
        @keyframes valueChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #3b82f6; }
            100% { transform: scale(1); }
        }
        
        .risk-pulse {
            animation: riskPulse 2s infinite;
        }
        @keyframes riskPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .notification-item {
            animation: slideIn 0.3s ease-out;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-item.info {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        .notification-item.warning {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .notification-item.critical {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .notification-title {
            font-weight: bold;
        }
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
        .notification-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 12px;
        }
        .notification-acknowledge {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .metric { font-size: 1.5rem; }
            .card { padding: 1rem; }
            .grid { gap: 1rem; }
        }
        
        /* Medical Score Styles */
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .score-card.high-risk {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: riskPulse 2s infinite;
        }
        
        .score-card.medium-risk {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .score-value {
            font-size: 3rem;
            font-weight: 800;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .score-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .ecg-lead {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            height: 80px;
            position: relative;
        }
        
        .ecg-lead-label {
            position: absolute;
            top: 5px;
            left: 10px;
            color: #22c55e;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .protocol-card {
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .protocol-card.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .protocol-card.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .protocol-card.active {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .drug-interaction {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            animation: slideIn 0.3s ease-out;
        }
        
        .fhir-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .vital-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .vital-indicator.normal {
            background-color: #10b981;
        }
        
        .vital-indicator.warning {
            background-color: #f59e0b;
            animation: pulse 1s infinite;
        }
        
        .vital-indicator.critical {
            background-color: #ef4444;
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .analysis-card {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #d1d5db;
        }
        
        .analysis-card.critical {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fca5a5;
        }
        
        .analysis-card.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fcd34d;
        }
        
        .trend-arrow {
            display: inline-block;
            font-size: 1.2rem;
            margin-left: 5px;
        }
        
        .trend-up {
            color: #ef4444;
        }
        
        .trend-down {
            color: #10b981;
        }
        
        .trend-stable {
            color: #6b7280;
        }
        
        .data-stream {
            background: #1f2937;
            color: #10b981;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .ml-confidence {
            display: inline-block;
            width: 60px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-left: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .ml-confidence-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen">
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white grid place-items-center soft">🏥</div>
                <div>
                    <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">نظام الرعاية الصحية العالمي</h1>
                    <p class="text-xs text-slate-500">متوافق مع معايير WHO | AHA | Joint Commission</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span id="patientIdBadge" class="badge badge-ok">ID: —</span>
                <button id="themeToggle" class="p-2 rounded-lg bg-slate-200 dark:bg-slate-700">
                    <span id="themeIcon">🌙</span>
                </button>
                <a id="backLink" href="#" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">رجوع لملف المريض</a>
            </div>
        </div>
    </header>

    <div id="notification-container" class="fixed top-20 left-4 z-50 max-w-sm"></div>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <!-- Patient Info Section -->
        <section class="card grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-2">
                <div class="text-slate-500 text-sm">المريض</div>
                <div class="flex items-center gap-2">
                    <div class="text-2xl font-bold text-slate-800">
                        <span id="patientName">—</span> 
                        <span class="text-lg font-normal" style="display: none;">(<span id="patientAge">—</span> سنة)</span>
                    </div>
                    <span id="genderIcon" class="text-lg">👤</span>
                    <span id="bloodTypeBadge" class="badge badge-ok">—</span>
                </div>
                <div class="text-xs text-slate-500 space-y-1">
                    <div>العنوان: <span id="patientAddress">—</span></div>
                    <div>القسم الحالي: <span id="patientDept">—</span></div>
                    <div>أمراض مزمنة: <span id="patientDiseases">—</span></div>
                    <div>وقت الاتصال: <span id="callTime">—</span></div>
                    <div>آخر فحص: <span id="lastCheckup">—</span></div>
                    <div id="patientStatus"></div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">الحالة</div>
                    <div id="aiStatusBadge" class="badge badge-ok inline-block mt-1">مستقرة</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">مؤشر الخطر (0–100)</div>
                    <div id="riskScore" class="metric risk-pulse">0</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">اتصال</div>
                    <div id="connBadge" class="badge badge-warn inline-block mt-1">محلي</div>
                </div>
            </div>
        </section>

        <!-- Medical Scores Section -->
        <section class="grid md:grid-cols-3 gap-4">
            <div class="score-card" id="news2Card">
                <div class="score-label">NEWS2 Score</div>
                <div id="news2Score" class="score-value">0</div>
                <div id="news2Level" class="text-sm">منخفض الخطورة</div>
                <div id="news2Indicators" class="mt-2 text-xs opacity-75">
                    <div>HR: <span id="news2HR">0</span></div>
                    <div>SpO₂: <span id="news2SpO2">0</span></div>
                    <div>BP: <span id="news2BP">0</span></div>
                </div>
            </div>
            <div class="score-card" id="mewsCard">
                <div class="score-label">MEWS Score</div>
                <div id="mewsScore" class="score-value">0</div>
                <div id="mewsLevel" class="text-sm">مستقر</div>
                <div id="mewsIndicators" class="mt-2 text-xs opacity-75">
                    <div>HR: <span id="mewsHR">0</span></div>
                    <div>BP: <span id="mewsBP">0</span></div>
                    <div>Temp: <span id="mewsTemp">0</span></div>
                </div>
            </div>
            <div class="score-card" id="sofaCard">
                <div class="score-label">SOFA Score</div>
                <div id="sofaScore" class="score-value">0</div>
                <div id="sofaLevel" class="text-sm">لا يوجد فشل أعضاء</div>
                <div id="sofaIndicators" class="mt-2 text-xs opacity-75">
                    <div>Resp: <span id="sofaResp">0</span></div>
                    <div>CV: <span id="sofaCV">0</span></div>
                    <div>Renal: <span id="sofaRenal">0</span></div>
                </div>
            </div>
        </section>

        <!-- Vital Signs Section -->
        <section class="grid md:grid-cols-5 gap-4">
            <div class="card">
                <div class="label">معدل ضربات القلب (bpm)</div>
                <div class="flex items-center">
                    <div id="hrVal" class="metric">—</div>
                    <span id="hrIndicator" class="vital-indicator normal"></span>
                </div>
                <div id="hrState" class="text-xs mt-1"></div>
                <div id="hrTrend" class="text-xs text-slate-500"></div>
            </div>
            <div class="card">
                <div class="label">الضغط (SYS/DIA mmHg)</div>
                <div class="flex items-center">
                    <div id="bpVal" class="metric">—</div>
                    <span id="bpIndicator" class="vital-indicator normal"></span>
                </div>
                <div id="bpState" class="text-xs mt-1"></div>
                <div id="bpTrend" class="text-xs text-slate-500"></div>
            </div>
            <div class="card">
                <div class="label">الأكسجين SpO₂ (%)</div>
                <div class="flex items-center">
                    <div id="spo2Val" class="metric">—</div>
                    <span id="spo2Indicator" class="vital-indicator normal"></span>
                </div>
                <div id="spo2State" class="text-xs mt-1"></div>
                <div id="spo2Trend" class="text-xs text-slate-500"></div>
            </div>
            <div class="card">
                <div class="label">معدل التنفس (rpm)</div>
                <div class="flex items-center">
                    <div id="rrVal" class="metric">—</div>
                    <span id="rrIndicator" class="vital-indicator normal"></span>
                </div>
                <div id="rrState" class="text-xs mt-1"></div>
                <div id="rrTrend" class="text-xs text-slate-500"></div>
            </div>
            <div class="card">
                <div class="label">الحرارة (°C)</div>
                <div class="flex items-center">
                    <div id="tempVal" class="metric">—</div>
                    <span id="tempIndicator" class="vital-indicator normal"></span>
                </div>
                <div id="tempState" class="text-xs mt-1"></div>
                <div id="tempTrend" class="text-xs text-slate-500"></div>
            </div>
        </section>

        <!-- Advanced Monitoring Section -->
        <section class="grid md:grid-cols-2 gap-4">
            <div class="card">
                <div class="flex items-center justify-between">
                    <div class="label">ECG – 12 Lead <span class="fhir-badge">FHIR</span></div>
                    <div class="text-xs text-slate-400">تحليل ذكي</div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">I</div>
                        <canvas id="ecgI" class="w-full h-full"></canvas>
                    </div>
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">II</div>
                        <canvas id="ecgII" class="w-full h-full"></canvas>
                    </div>
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">III</div>
                        <canvas id="ecgIII" class="w-full h-full"></canvas>
                    </div>
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">aVR</div>
                        <canvas id="ecgAVR" class="w-full h-full"></canvas>
                    </div>
                </div>
                <div id="ecgAnalysis" class="mt-3 p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold">تحليل ECG:</div>
                    <div class="text-sm">جاري التحليل...</div>
                </div>
            </div>
            
            <div class="card">
                <div class="flex items-center justify-between">
                    <div class="label">الغازات الشريانية (ABG) <span class="fhir-badge">FHIR</span></div>
                    <div class="text-xs text-slate-400">تحليل متقدم</div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-3">
                    <div>
                        <div class="text-xs text-slate-500">pH</div>
                        <div id="phVal" class="text-xl font-bold">—</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">PaCO₂ (mmHg)</div>
                        <div id="paco2Val" class="text-xl font-bold">—</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">PaO₂ (mmHg)</div>
                        <div id="pao2Val" class="text-xl font-bold">—</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">HCO₃ (mmol/L)</div>
                        <div id="hco3Val" class="text-xl font-bold">—</div>
                    </div>
                </div>
                <div id="abgAnalysis" class="mt-3 p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold">تحليل ABG:</div>
                    <div class="text-sm">جاري التحليل...</div>
                </div>
            </div>
        </section>

        <!-- Real-time Data Stream -->
        <section class="card">
            <div class="flex items-center justify-between">
                <div class="font-bold">تيار البيانات المباشر</div>
                <div class="text-xs text-slate-400">
                    <span id="dataRate">0</span> قراءة/ثانية
                </div>
            </div>
            <div id="dataStream" class="data-stream mt-3">
                <div>في انتظار البيانات...</div>
            </div>
        </section>

        <!-- Sepsis Protocol Section -->
        <section id="sepsis-container" class="card">
            <div class="flex items-center justify-between">
                <div class="font-bold">بروتوكول الإنتان (SEP-1) <span class="fhir-badge">FHIR</span></div>
                <div id="sepsisStatus" class="badge badge-ok">لا يوجد اشتباه</div>
            </div>
            <div id="sepsisCriteria" class="mt-3 grid md:grid-cols-3 gap-3">
                <div class="p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold text-sm">المعايير</div>
                    <div class="text-xs mt-1">
                        <div>• درجة الحرارة > 38°C أو < 36°C</div>
                        <div>• معدل ضربات القلب > 90</div>
                        <div>• معدل التنفس > 20</div>
                        <div>• WBC > 12K أو < 4K</div>
                    </div>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold text-sm">الاستجابة</div>
                    <div class="text-xs mt-1">
                        <div>• ضغط الدم الانقباضي < 90</div>
                        <div>• لاكتات > 2 mmol/L</div>
                    </div>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold text-sm">فشل الأعضاء</div>
                    <div class="text-xs mt-1">
                        <div>• Cr > 2.0 mg/dL</div>
                        <div>• البيليروبين > 2 mg/dL</div>
                        <div>• PLT < 100K</div>
                    </div>
                </div>
            </div>
            <div id="sepsisActions" class="mt-3 p-3 bg-yellow-50 rounded-lg">
                <div class="font-bold text-sm">الإجراءات المطلوبة:</div>
                <div class="text-sm mt-1">جاري حساب الإجراءات...</div>
            </div>
        </section>

        <!-- Drug Interaction Section -->
        <section id="drug-interaction-container" class="card">
            <div class="flex items-center justify-between">
                <div class="font-bold">تفاعلات الأدوية <span class="fhir-badge">FHIR</span></div>
                <button id="addDrugBtn" class="text-sm px-3 py-1 bg-blue-600 text-white rounded-lg">إضافة دواء</button>
            </div>
            <div id="drugList" class="mt-3 space-y-2">
                <div class="text-sm text-slate-500">لم تتم إضافة أي أدوية بعد</div>
            </div>
            <div id="drugInteractions" class="mt-3">
                <!-- Drug interactions will appear here -->
            </div>
        </section>

        <!-- Early Warning System -->
        <section id="early-warning-container" class="card">
            <div class="font-bold mb-3">نظام الإنذار المبكر المتقدم</div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">معدل التغير</h3>
                    <div id="rateOfChange" class="space-y-2">
                        <div class="flex justify-between">
                            <span>HR:</span>
                            <span id="hrChange">—</span>
                        </div>
                        <div class="flex justify-between">
                            <span>SpO₂:</span>
                            <span id="spo2Change">—</span>
                        </div>
                        <div class="flex justify-between">
                            <span>BP:</span>
                            <span id="bpChange">—</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">التنبؤ بالتدهور</h3>
                    <div id="deteriorationPrediction" class="p-3 bg-slate-50 rounded-lg">
                        <div class="text-sm">جاري التحليل...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Diagnostics Section -->
        <section id="diagnosis-container" class="card">
            <div class="font-bold mb-2">التشخيص الذكي المتقدم</div>
            <div id="diagnosisContent" class="space-y-3">
                <div class="text-green-600">لا توجد حالات تستدعي القلق</div>
            </div>
        </section>

        <!-- Trends and Predictions -->
        <section id="trends-container" class="card">
            <div class="font-bold mb-2">التنبؤات الديناميكية</div>
            <div id="trendsContent" class="space-y-3">
                <div class="text-gray-500">بيانات غير كافية للتنبؤ</div>
            </div>
        </section>

        <!-- ML Recommendations -->
        <section id="ml-container" class="card">
            <div class="font-bold mb-2">توصيات الذكاء الاصطناعي</div>
            <div id="mlContent" class="space-y-3">
                <div>يتم تحميل التحليل...</div>
            </div>
        </section>

        <!-- Medical Patterns -->
        <section id="patterns-container" class="card">
            <div class="font-bold mb-2">أنماط طبية مكتشفة</div>
            <div id="patternsContent" class="space-y-3">
                <div class="text-gray-500">لا توجد أنماط مكتشفة</div>
            </div>
        </section>

        <!-- Changes Tracking -->
        <section id="changes-container" class="card">
            <div class="font-bold mb-2">تغييرات مهمة</div>
            <div id="changesContent" class="space-y-3">
                <div class="text-gray-500">لا توجد تغييرات مهمة</div>
            </div>
        </section>

        <!-- Trend Patterns -->
        <section id="trend-patterns-container" class="card">
            <div class="font-bold mb-2">أنماط الاتجاه</div>
            <div id="trendPatternsContent" class="space-y-3">
                <div class="text-gray-500">لا توجد أنماط اتجاه</div>
            </div>
        </section>

        <!-- Control Section -->
        <section class="grid lg:grid-cols-3 gap-4">
            <div class="card space-y-3">
                <div class="font-bold">التحكم</div>
                <div class="flex flex-wrap gap-2">
                    <button id="connectBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">اتصال بالجهاز</button>
                    <button id="startBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">بدء المراقبة</button>
                    <button id="stopBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">إيقاف</button>
                    <button id="snapBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">حفظ قراءة الآن</button>
                    <button id="reportBtn" class="px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700">إنشاء تقرير</button>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span>البطارية:</span>
                    <span id="batteryBadge" class="badge badge-ok">—</span>
                    <span id="batteryLevel">—</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                    <input id="autoAlerts" type="checkbox" class="w-4 h-4" checked> تفعيل التنبيه الذكي
                </label>
                <label class="inline-flex items-center gap-2 text-sm">
                    <input id="autoReconnect" type="checkbox" class="w-4 h-4" checked> إعادة الاتصال التلقائي
                </label>
                <p class="text-xs text-slate-500">عند تفعيل التنبيه الذكي سيتم إصدار تنبيه صوتي/مرئي عند تجاوز الحدود أو ارتفاع مؤشر الخطر.</p>
            </div>
            <div class="card lg:col-span-2">
                <div class="font-bold mb-3">حدود الأمان (قابلة للتعديل)</div>
                <div class="grid md:grid-cols-5 gap-3 text-sm">
                    <div>
                        <div class="label">HR</div>
                        <div class="flex gap-2"><input id="hrMin" class="w-full border rounded-xl px-3 py-2" value="50"><input id="hrMax" class="w-full border rounded-xl px-3 py-2" value="120"></div>
                    </div>
                    <div>
                        <div class="label">SYS</div>
                        <div class="flex gap-2"><input id="sysMin" class="w-full border rounded-xl px-3 py-2" value="90"><input id="sysMax" class="w-full border rounded-xl px-3 py-2" value="140"></div>
                    </div>
                    <div>
                        <div class="label">DIA</div>
                        <div class="flex gap-2"><input id="diaMin" class="w-full border rounded-xl px-3 py-2" value="55"><input id="diaMax" class="w-full border rounded-xl px-3 py-2" value="90"></div>
                    </div>
                    <div>
                        <div class="label">SpO₂</div>
                        <div class="flex gap-2"><input id="spo2Min" class="w-full border rounded-xl px-3 py-2" value="92"><input id="spo2Max" class="w-full border rounded-xl px-3 py-2" value="100"></div>
                    </div>
                    <div>
                        <div class="label">RR / Temp</div>
                        <div class="flex gap-2"><input id="rrMin" class="w-full border rounded-xl px-3 py-2" value="10"><input id="rrMax" class="w-full border rounded-xl px-3 py-2" value="24"></div>
                        <div class="flex gap-2 mt-2"><input id="tempMin" class="w-full border rounded-xl px-3 py-2" value="36"><input id="tempMax" class="w-full border rounded-xl px-3 py-2" value="37.8"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Alert Log -->
        <section class="card">
            <div class="flex items-center justify-between mb-2">
                <div class="font-bold">سجل التنبيهات</div>
                <button id="clearLog" class="text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">مسح السجل</button>
            </div>
            <div id="log" class="text-sm space-y-1 max-h-44 overflow-auto"></div>
        </section>

        <!-- Visualization Section -->
        <section id="visualization-container" class="card space-y-6">
            <div class="font-bold">التصور المتقدم للبيانات</div>
            
            <div>
                <h3 class="font-semibold mb-2">العلامات الحيوية مع الوقت</h3>
                <div class="h-64">
                    <canvas id="vitalSignsChart"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">اتجاهات العلامات الحيوية</h3>
                    <div class="h-48">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">توزيع العلامات الحيوية</h3>
                    <div class="h-48">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="correlationMatrix" class="card">
                <div class="text-gray-500">جاري تحليل الارتباطات...</div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="visualizationSystem.exportChart('vitalSignsChart')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">تصدير الرسم البياني</button>
                <button onclick="visualizationSystem.createCorrelationMatrix()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">تحليل الارتباطات</button>
            </div>
        </section>

        <!-- Export/Import Section -->
        <section id="export-import-container" class="card">
            <div class="font-bold mb-3">تصدير واستيراد البيانات <span class="fhir-badge">FHIR</span></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <div class="font-semibold mb-2">تصدير البيانات</div>
                    <div class="space-y-2">
                        <select id="exportFormat" class="w-full border rounded-lg p-2">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="pdf">PDF</option>
                            <option value="xml">XML</option>
                            <option value="fhir">FHIR STU3</option>
                        </select>
                        <div class="flex gap-2">
                            <input type="date" id="exportStartDate" class="flex-1 border rounded-lg p-2">
                            <input type="date" id="exportEndDate" class="flex-1 border rounded-lg p-2">
                        </div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeCharts" checked>
                            <span>تضمين الرسوم البيانية</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeAnalysis" checked>
                            <span>تضمين التحليل الإحصائي</span>
                        </label>
                        <button id="exportBtn" class="w-full bg-blue-600 text-white rounded-lg p-2 hover:bg-blue-700">تصدير</button>
                    </div>
                </div>
                <div>
                    <div class="font-semibold mb-2">استيراد البيانات</div>
                    <div class="space-y-2">
                        <select id="importFormat" class="w-full border rounded-lg p-2">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="fhir">FHIR STU3</option>
                        </select>
                        <input type="file" id="importFile" accept=".json,.csv,.xml" class="w-full border rounded-lg p-2">
                        <button id="importBtn" class="w-full bg-green-600 text-white rounded-lg p-2 hover:bg-green-700">استيراد</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Compliance Reports -->
        <section id="compliance-container" class="card">
            <div class="font-bold mb-3">تقارير الاعتماد الطبي</div>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <div class="font-bold">Joint Commission</div>
                    <div class="text-sm mt-2">
                        <div>• معدل الوفيات: <span id="mortalityRate">—</span></div>
                        <div>• معدل العدوى: <span id="infectionRate">—</span></div>
                        <div>• مدة البقاء: <span id="lengthOfStay">—</span></div>
                    </div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <div class="font-bold">HIPAA Compliance</div>
                    <div class="text-sm mt-2">
                        <div>• تشفير البيانات: <span class="text-green-600">✅</span></div>
                        <div>• إدارة الموافقات: <span class="text-green-600">✅</span></div>
                        <div>• سجل الوصول: <span class="text-green-600">✅</span></div>
                    </div>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <div class="font-bold">WHO Standards</div>
                    <div class="text-sm mt-2">
                        <div>• بروتوكولات الطوارئ: <span class="text-green-600">✅</span></div>
                        <div>• معايير الجودة: <span class="text-green-600">✅</span></div>
                        <div>• التدريب: <span class="text-green-600">✅</span></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-400">
        نظام الرعاية الصحية العالمي - متوافق مع معايير WHO | AHA | Joint Commission | HIPAA | FHIR STU3
    </footer>

    <script>
        // =============== إعداد Firebase ===============
        const firebaseConfig = {
            apiKey: "AIzaSyB4glqZb0hz1uvERtq0pSZZzeBy3_grAnQ",
            authDomain: "smart-life-hospital-ef64c.firebaseapp.com",
            databaseURL: "https://smart-life-hospital-ef64c-default-rtdb.firebaseio.com",
            projectId: "smart-life-hospital-ef64c",
            storageBucket: "smart-life-hospital-ef64c.firebasestorage.app",
            messagingSenderId: "851045891087",
            appId: "1:851045891087:web:8e0f6e42f8c7fed17bf77a",
            measurementId: "G-QE5BL3MTY7"
        };
        
        let fb = { enabled: false, app: null, db: null };
        try {
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL) {
                fb.app = firebase.initializeApp(firebaseConfig);
                fb.db = firebase.database();
                fb.enabled = true;
                document.getElementById('connBadge').textContent = 'Firebase';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
            }
        } catch (e) {
            console.warn('Firebase init failed, running local only.', e);
        }
        
        // =============== أدوات مساعدة ===============
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d=0) => Number(n).toFixed(d);
        const nowIso = () => new Date().toISOString();
        function getQueryParam(key) {
            const u = new URL(window.location.href);
            return u.searchParams.get(key);
        }
        
        const patientId = getQueryParam('id') || '-OVjd_eZDCbyD2S14zfc';
        $('patientIdBadge').textContent = 'ID: ' + patientId;
        $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
        
        // =============== قاعدة بيانات طبية ضخمة ===============
        const MEDICAL_DATABASE = {
            diseases: {
                cardiac: {
                    "تسارع ضربات القلب": {
                        symptoms: ["خفقان", "دوخة", "ضيق تنفس", "ألم صدر"],
                        causes: ["توتر", "قلق", "فقر دم", "أمراض قلبية"],
                        treatments: ["أدوية حاصرة بيتا", "أدوية مضادة لاضطراب النظم", "تعديل نمط الحياة"],
                        riskFactors: ["تقدم العمر", "ضغط دم مرتفع", "سكري", "تدخين"],
                        complications: ["فشل قلبي", "سكتة دماغية", "جلطات"]
                    },
                    "بطء ضربات القلب": {
                        symptoms: ["إرهاق", "دوخة", "إغماء", "ضيق تنفس"],
                        causes: ["أمراض قلبية", "أدوية", "اختلالات كهربائية"],
                        treatments: ["ناظم خطى", "أدوية", "علاج السبب"],
                        riskFactors: ["تقدم العمر", "أمراض قلبية", "أدوية"],
                        complications: ["فشل قلبي", "إغماء", "موت مفاجئ"]
                    },
                    "ارتفاع ضغط الدم": {
                        symptoms: ["صداع", "دوخة", "ضيق تنفس", "ألم صدر"],
                        causes: ["وراثة", "سمنة", "توتر", "أمراض كلوية"],
                        treatments: ["أدوية خافضة للضغط", "تعديل غذائي", "تمارين"],
                        riskFactors: ["سمنة", "توتر", "تقدم العمر", "وراثة"],
                        complications: ["سكتة دماغية", "فشل قلبي", "أمراض كلوية"]
                    }
                },
                respiratory: {
                    "انخفاض تشبع الأكسجين": {
                        symptoms: ["ضيق تنفس", "زرقة", "تسارع تنفس", "قلق"],
                        causes: ["أمراض رئة", "فشل قلبي", "فقر دم", "ارتفاع"],
                        treatments: ["أكسجين", "أدوية", "علاج السبب"],
                        riskFactors: ["تدخين", "أمراض رئة", "فشل قلبي"],
                        complications: ["فشل تنفسي", "تلف أعضاء", "موت"]
                    },
                    "فشل تنفسي": {
                        symptoms: ["ضيق تنفس شديد", "تسارع تنفس", "قلق", "إرهاق"],
                        causes: ["التهاب رئة", "انسداد رئوي", "فشل قلبي"],
                        treatments: ["تنفس اصطناعي", "أكسجين", "أدوية"],
                        riskFactors: ["أمراض رئة", "فشل قلبي", "تقدم العمر"],
                        complications: ["موت", "تلف أعضاء", "عدوى"]
                    }
                },
                metabolic: {
                    "الإنتان": {
                        symptoms: ["حمى", "قشعريرة", "تسارع ضربات القلب", "انخفاض ضغط الدم"],
                        causes: ["عدوى بكتيرية", "عدوى فيروسية", "فطريات"],
                        treatments: ["مضادات حيوية", "سوائل وريدية", "أدوية ضغط الدم"],
                        riskFactors: ["ضعف مناعة", "أمراض مزمنة", "جراحات"],
                        complications: ["صدمة إنتانية", "فشل أعضاء", "موت"]
                    },
                    "الحماض الأيضي": {
                        symptoms: ["إرهاق", "غثيان", "قيء", "ضيق تنفس"],
                        causes: ["فشل كلوي", "سكري", "تسمم", "جفاف"],
                        treatments: ["علاج السبب", "تصحيح الحموضة", "سوائل"],
                        riskFactors: ["أمراض كلوية", "سكري", "جفاف"],
                        complications: ["فشل أعضاء", "غيبوبة", "موت"]
                    }
                }
            },
            medications: {
                interactions: {
                    "Warfarin": {
                        severe: ["NSAIDs", "Antibiotics", "Antifungals"],
                        moderate: ["SSRIs", "Statins", "ACE Inhibitors"],
                        effects: ["زيادة خطر النزيف", "تغيرات في INR", "كدمات"],
                        management: ["مراقبة INR", "تعديل الجرعة", "تجنب الأدوية المتفاعلة"]
                    },
                    "Digoxin": {
                        severe: ["Amiodarone", "Verapamil", "Diltiazem"],
                        moderate: ["Diuretics", "Spironolactone", "ACE Inhibitors"],
                        effects: ["تسمم ديجوكسين", "اضطرابات نظم", "غثيان"],
                        management: ["مراقبة المستويات", "تعديل الجرعة", "مراقبة البوتاسيوم"]
                    },
                    "Insulin": {
                        severe: ["Beta-blockers", "Alcohol", "Steroids"],
                        moderate: ["Thiazides", "SSRIs", "MAOIs"],
                        effects: ["نقص سكر الدم", "تعرق", "رعشة", "إغماء"],
                        management: ["مراقبة سكر الدم", "تعديل الجرعة", "تعليم المريض"]
                    }
                },
                dosages: {
                    "Warfarin": {
                        initial: "5-10 mg/day",
                        maintenance: "2-10 mg/day",
                        targetINR: "2.0-3.0",
                        monitoring: "INR weekly initially, then monthly"
                    },
                    "Digoxin": {
                        initial: "0.125-0.25 mg/day",
                        maintenance: "0.125-0.5 mg/day",
                        targetLevel: "0.8-2.0 ng/mL",
                        monitoring: "Levels weekly, electrolytes"
                    },
                    "Insulin": {
                        initial: "0.1-0.2 units/kg/day",
                        maintenance: "individualized",
                        targetGlucose: "80-180 mg/dL",
                        monitoring: "Glucose 4x/day, HbA1c quarterly"
                    }
                }
            },
            protocols: {
                sepsis: {
                    hour1: [
                        "قياس لاكتات الدم",
                        "الحصول على مزارع الدم",
                        "إعطاء مضادات حيوية واسعة الطيف",
                        "إعطاء سوائل وريدية (30 mL/kg)"
                    ],
                    hour3: [
                        "إعادة تقييم ضغط الدم",
                        "مراجعة نتائج المزارع",
                        "تعديل المضادات الحيوية",
                        "تقييم وظائف الأعضاء"
                    ],
                    hour6: [
                        "تقييم استجابة المريض",
                        "تعديل العلاج",
                        "استشارة الاختصاصيين",
                        "التخطيط
