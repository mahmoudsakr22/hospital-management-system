<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        /* Apply Cairo font globally */
        html, body { 
            font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; 
            scroll-behavior: smooth;
        }
        
        /* Custom component styles using @apply for cleaner HTML */
        .card {
            @apply rounded-xl shadow-lg p-5 bg-white border border-slate-200/80 transition-all duration-300 hover:shadow-xl;
        }
        .metric {
            @apply text-4xl font-extrabold tracking-tight text-slate-800;
        }
        .label {
            @apply text-sm font-medium text-slate-500 mb-1;
        }
        .badge {
            @apply px-3 py-1 rounded-full text-xs font-semibold inline-flex items-center gap-1.5;
        }
        .badge-ok {
            @apply bg-green-100 text-green-800;
        }
        .badge-warn {
            @apply bg-yellow-100 text-yellow-800;
        }
        .badge-bad {
            @apply bg-red-100 text-red-800;
        }
        .styled-input {
            @apply w-full border border-slate-300 rounded-lg px-3 py-2 text-center transition duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
        }
        .control-button {
            @apply px-4 py-2 rounded-lg font-semibold text-white transition duration-200 flex items-center gap-2 justify-center;
        }
        .icon-metric {
            @apply flex items-start gap-4;
        }
        .icon-metric .icon-wrapper {
            @apply w-10 h-10 rounded-lg grid place-items-center flex-shrink-0;
        }
        
        /* For better pixelated rendering of the ECG chart */
        canvas { 
            image-rendering: pixelated; 
        }
    </style>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur-lg border-b border-slate-200/90">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-blue-600 text-white grid place-items-center shadow-md shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</h1>
                    <p class="text-xs text-slate-500">Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø­Ø¸ÙŠØ©ØŒ ØªÙ†Ø¨ÙŠÙ‡ Ø°ÙƒÙŠØŒ ÙˆØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</p>
                </div>
            </div>
            <div class="flex items-center gap-3 text-sm">
                <span id="patientIdBadge" class="badge bg-slate-100 text-slate-700">ID: â€”</span>
                <a id="backLink" href="#" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 transition font-semibold">Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">
        
        <!-- Patient Info & AI Status -->
        <section class="grid md:grid-cols-3 gap-6">
            <div class="card md:col-span-2">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <div class="text-slate-500 text-sm mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                        <div class="flex items-center gap-3 mb-3">
                            <h2 class="text-3xl font-bold text-slate-800">
                                <span id="patientName">â€”</span> 
                                <span class="text-xl font-medium text-slate-500" style="display: none;">(<span id="patientAge">â€”</span> Ø³Ù†Ø©)</span>
                            </h2>
                            <span id="genderIcon" class="text-2xl text-slate-400"></span>
                            <span id="bloodTypeBadge" class="badge bg-red-100 text-red-800">â€”</span>
                        </div>
                        <div class="text-sm text-slate-600 space-y-2 text-pretty">
                            <div><strong class="font-semibold text-slate-500">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span id="patientAddress">â€”</span></div>
                            <div><strong class="font-semibold text-slate-500">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="patientDept">â€”</span></div>
                            <div><strong class="font-semibold text-slate-500">Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©:</strong> <span id="patientDiseases">â€”</span></div>
                            <div><strong class="font-semibold text-slate-500">ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„:</strong> <span id="callTime">â€”</span></div>
                            <div><strong class="font-semibold text-slate-500">Ø¢Ø®Ø± ÙØ­Øµ:</strong> <span id="lastCheckup">â€”</span></div>
                        </div>
                    </div>
                     <div id="patientStatus" class="mt-2 text-base"></div>
                </div>
            </div>

            <div class="card flex flex-col justify-between">
                 <div class="label">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø©</div>
                 <div class="grid grid-rows-3 gap-3">
                    <div class="text-center bg-slate-100 rounded-lg p-3">
                        <div class="label">Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
                        <div id="aiStatusBadge" class="badge badge-ok mt-1">Ù…Ø³ØªÙ‚Ø±Ø©</div>
                    </div>
                    <div class="text-center bg-slate-100 rounded-lg p-3">
                        <div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± (0â€“100)</div>
                        <div id="riskScore" class="metric text-3xl">0</div>
                    </div>
                    <div class="text-center bg-slate-100 rounded-lg p-3">
                        <div class="label">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                        <div id="connBadge" class="badge badge-warn mt-1">Ù…Ø­Ù„ÙŠ</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Vital Signs -->
        <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <!-- Heart Rate -->
            <div class="card icon-metric">
                <div class="icon-wrapper bg-red-100 text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                </div>
                <div>
                    <div class="label">Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)</div>
                    <div id="hrVal" class="metric">â€”</div>
                    <div id="hrState" class="badge mt-1"></div>
                </div>
            </div>
            <!-- Blood Pressure -->
            <div class="card icon-metric">
                <div class="icon-wrapper bg-blue-100 text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5-2.986-6.344a8.047 8.047 0 00-3.064 5.034" /></svg>
                </div>
                <div>
                    <div class="label">Ø§Ù„Ø¶ØºØ· (SYS/DIA)</div>
                    <div id="bpVal" class="metric text-3xl">â€”</div>
                    <div id="bpState" class="badge mt-1"></div>
                </div>
            </div>
            <!-- SpO2 -->
            <div class="card icon-metric">
                <div class="icon-wrapper bg-sky-100 text-sky-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11" /></svg>
                </div>
                <div>
                    <div class="label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† SpOâ‚‚ (%)</div>
                    <div id="spo2Val" class="metric">â€”</div>
                    <div id="spo2State" class="badge mt-1"></div>
                </div>
            </div>
            <!-- Respiration Rate -->
            <div class="card icon-metric">
                <div class="icon-wrapper bg-teal-100 text-teal-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0l-2-2m2 2l7-7" /></svg>
                </div>
                <div>
                    <div class="label">Ø§Ù„ØªÙ†ÙØ³ (rpm)</div>
                    <div id="rrVal" class="metric">â€”</div>
                    <div id="rrState" class="badge mt-1"></div>
                </div>
            </div>
            <!-- Temperature -->
            <div class="card icon-metric">
                <div class="icon-wrapper bg-orange-100 text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.176-5.97M15 21H9" /></svg>
                </div>
                <div>
                    <div class="label">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</div>
                    <div id="tempVal" class="metric">â€”</div>
                    <div id="tempState" class="badge mt-1"></div>
                </div>
            </div>
        </section>

        <!-- ECG Chart -->
        <section class="card">
            <div class="flex items-center justify-between mb-3">
                <div class="font-bold text-slate-700 text-lg">Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ù„Ø¨ (ECG)</div>
                <div class="text-xs text-slate-400">Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·</div>
            </div>
            <canvas id="ecg" class="w-full h-48 bg-black rounded-lg"></canvas>
        </section>
        
        <!-- AI Analysis Sections -->
        <section class="grid lg:grid-cols-3 gap-6">
            <div id="diagnosis-container" class="card">
                <h3 class="font-bold text-slate-700 mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø°ÙƒÙŠ</h3>
                <div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚.</div>
            </div>
            <div id="trends-container" class="card">
                <h3 class="font-bold text-slate-700 mb-2">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©</h3>
                <div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤.</div>
            </div>
            <div id="ml-container" class="card">
                <h3 class="font-bold text-slate-700 mb-2">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
                <div>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
            </div>
        </section>

        <!-- Controls & Settings -->
        <section class="grid lg:grid-cols-3 gap-6">
            <div class="card space-y-4">
                <h3 class="font-bold text-slate-700">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button id="connectBtn" class="control-button bg-blue-600 hover:bg-blue-700">Ø§ØªØµØ§Ù„</button>
                    <button id="startBtn" class="control-button bg-green-600 hover:bg-green-700">Ø¨Ø¯Ø¡</button>
                    <button id="stopBtn" class="control-button bg-red-600 hover:bg-red-700">Ø¥ÙŠÙ‚Ø§Ù</button>
                    <button id="snapBtn" class="control-button bg-slate-800 hover:bg-slate-900">Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø©</button>
                </div>
                <label class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer">
                    <input id="autoAlerts" type="checkbox" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ
                </label>
                <p class="text-xs text-slate-500">Ø³ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ/Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø±.</p>
            </div>
            
            <div class="card lg:col-span-2">
                <h3 class="font-bold text-slate-700 mb-3">Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</h3>
                <div class="grid md:grid-cols-5 gap-4 text-sm">
                    <div>
                        <div class="label text-center">HR</div>
                        <div class="flex gap-2"><input id="hrMin" class="styled-input" value="50"><input id="hrMax" class="styled-input" value="120"></div>
                    </div>
                    <div>
                        <div class="label text-center">SYS</div>
                        <div class="flex gap-2"><input id="sysMin" class="styled-input" value="90"><input id="sysMax" class="styled-input" value="140"></div>
                    </div>
                    <div>
                        <div class="label text-center">DIA</div>
                        <div class="flex gap-2"><input id="diaMin" class="styled-input" value="55"><input id="diaMax" class="styled-input" value="90"></div>
                    </div>
                    <div>
                        <div class="label text-center">SpOâ‚‚</div>
                        <div class="flex gap-2"><input id="spo2Min" class="styled-input" value="92"><input id="spo2Max" class="styled-input" value="100"></div>
                    </div>
                    <div>
                        <div class="label text-center">RR / Temp</div>
                        <div class="flex gap-2"><input id="rrMin" class="styled-input" value="10"><input id="rrMax" class="styled-input" value="24"></div>
                        <div class="flex gap-2 mt-2"><input id="tempMin" class="styled-input" value="36"><input id="tempMax" class="styled-input" value="37.8"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Alert Log -->
        <section class="card">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold text-slate-700">Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
                <button id="clearLog" class="text-sm px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 transition text-slate-600 font-semibold">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div id="log" class="text-sm space-y-2 max-h-48 overflow-auto p-1"></div>
        </section>

    </main>
    
    <!-- Footer -->
    <footer class="max-w-7xl mx-auto text-center px-4 py-8 text-xs text-slate-400">
        <p>Ù†Ø³Ø®Ø© Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€“ Ù„Ù„Ø¹Ø±Ø¶ Ø¶Ù…Ù† Ù…Ø´Ø±ÙˆØ¹ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©.</p>
        <p>Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ÙŠØ³ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ Ø£Ùˆ Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.</p>
    </footer>

    <!-- All JavaScript logic remains unchanged -->
    <script>
        // =============== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ===============
        const firebaseConfig = {
            apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
            authDomain: "hospital-project-e4b59.firebaseapp.com",
            databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hospital-project-e4b59",
            storageBucket: "hospital-project-e4b59.firebasestorage.app",
            messagingSenderId: "974610606258",
            appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
            measurementId: "G-0GV30LL28T"
        };
        let fb = { enabled: false, app: null, db: null };
        try {
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL) {
                fb.app = firebase.initializeApp(firebaseConfig);
                fb.db = firebase.database();
                fb.enabled = true;
                document.getElementById('connBadge').textContent = 'Firebase';
                document.getElementById('connBadge').className = 'badge badge-ok mt-1';
            }
        } catch (e) {
            console.warn('Firebase init failed, running local only.', e);
        }
        
        // =============== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===============
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d=0) => Number(n).toFixed(d);
        const nowIso = () => new Date().toISOString();
        function getQueryParam(key) {
            const u = new URL(window.location.href);
            return u.searchParams.get(key);
        }
        
        const patientId = getQueryParam('id') || '-OVjd_eZDCbyD2S14zfc';
        $('patientIdBadge').textContent = 'ID: ' + patientId;
        $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
        
        // =============== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ===============
        async function loadPatientHeader() {
            if (!fb.enabled) return;
            try {
               const snap = await fb.db.ref(`/patients/emergency/${patientId}`).get();
                if (!snap.exists()) {
                    console.warn("No patient data in emergency", patientId);
                    const regularSnap = await fb.db.ref(`/patients/${patientId}/basic`).get();
                    if (!regularSnap.exists()) {
                        console.error("No patient data found anywhere for ID", patientId);
                        return;
                    }
                    updatePatientDisplay(regularSnap.val());
                    return;
                }
                updatePatientDisplay(snap.val());
            } catch (error) {
                console.error("Error fetching patient data:", error);
            }
        }
        
        function updatePatientDisplay(basic) {
            $('patientName').textContent = basic.name || 'â€”';
            if (basic.age) {
                $('patientAge').textContent = basic.age;
                $('patientName').nextElementSibling.style.display = 'inline';
            } else {
                $('patientName').nextElementSibling.style.display = 'none';
            }
            $('patientAddress').textContent = basic.address || 'â€”';
            $('patientDept').textContent = basic.serviceType || basic.department || 'â€”';
            $('patientDiseases').textContent = basic.diseases || 'â€”';
            if (basic.diseases && basic.diseases !== "Ù„Ø§ ÙŠÙˆØ¬Ø¯") {
                $('patientDiseases').innerHTML = `<span class="text-red-600 font-bold">âš ï¸ ${basic.diseases}</span>`;
            }

            // Updated gender icons
            const maleIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`;
            const femaleIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`;
            const defaultIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0012 11z" clip-rule="evenodd" /></svg>`;

            if (basic.gender === 'male') {
                $('genderIcon').innerHTML = maleIcon;
                $('genderIcon').title = "Ø°ÙƒØ±";
            } else if (basic.gender === 'female') {
                $('genderIcon').innerHTML = femaleIcon;
                 $('genderIcon').title = "Ø£Ù†Ø«Ù‰";
            } else {
                $('genderIcon').innerHTML = defaultIcon;
            }
            
            $('bloodTypeBadge').textContent = basic.bloodType || 'â€”';
            
            if (basic.callTime) {
                $('callTime').textContent = new Date(basic.callTime).toLocaleString('ar-EG');
            }
            
            if (basic.lastCheckup) {
                $('lastCheckup').textContent = new Date(basic.lastCheckup).toLocaleDateString('ar-EG');
            }
            
            if (basic.status) {
                let statusClass = '', statusText = basic.status;
                switch(basic.status.toLowerCase()) {
                    case 'deteriorating': statusClass = 'text-red-600 font-bold'; statusText = 'ÙÙŠ ØªØ¯Ù‡ÙˆØ± âš ï¸'; break;
                    case 'stable': statusClass = 'text-green-600 font-bold'; statusText = 'Ù…Ø³ØªÙ‚Ø± âœ…'; break;
                    case 'critical': statusClass = 'text-red-800 font-bold'; statusText = 'Ø­Ø±Ø¬ ğŸš¨'; break;
                    default: statusClass = 'text-yellow-600 font-bold';
                }
                $('patientStatus').innerHTML = `<div class="label">Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</div><span class="${statusClass}">${statusText}</span>`;
            }
        }
        
        loadPatientHeader();
        
        // =============== Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) ===============
        const limits = {
            hr: { min: 50, max: 120 }, sys: { min: 90, max: 140 }, dia: { min: 55, max: 90 },
            spo2: { min: 92, max: 100 }, rr: { min: 10, max: 24 }, temp: { min: 36.0, max: 37.8 }
        };
        function readLimits() {
            limits.hr.min = +$('hrMin').value; limits.hr.max = +$('hrMax').value;
            limits.sys.min = +$('sysMin').value; limits.sys.max = +$('sysMax').value;
            limits.dia.min = +$('diaMin').value; limits.dia.max = +$('diaMax').value;
            limits.spo2.min = +$('spo2Min').value; limits.spo2.max = +$('spo2Max').value;
            limits.rr.min = +$('rrMin').value; limits.rr.max = +$('rrMax').value;
            limits.temp.min = +$('tempMin').value; limits.temp.max = +$('tempMax').value;
        }
        
        // =============== Ù…Ø­Ø§ÙƒØ§Ø© Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ø­Ø¸ÙŠØ© ===============
        let timer = null;
        let t = 0;
        function randn(mean, sd) {
            let u = 1 - Math.random(), v = 1 - Math.random();
            let z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return mean + z * sd;
        }
        function simulateVitals() {
            const hr = Math.max(30, Math.round(randn(82, 6)));
            const sys = Math.round(randn(118, 8));
            const dia = Math.round(randn(76, 6));
            const spo2 = Math.min(100, Math.max(85, Math.round(randn(97, 1.2))));
            const rr = Math.max(6, Math.round(randn(16, 2)));
            const temp = Math.max(34.5, Math.min(40, randn(36.9, 0.2)));
            return { hr, sys, dia, spo2, rr, temp: +temp.toFixed(1) };
        }
        
        // =============== ECG Ø±Ø³Ù… ===============
        const ecgCanvas = $('ecg');
        const ecgCtx = ecgCanvas.getContext('2d');
        function resizeCanvas() {
            ecgCanvas.width = ecgCanvas.clientWidth;
            ecgCanvas.height = ecgCanvas.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        function drawECG(hr) {
            const w = ecgCanvas.width, h = ecgCanvas.height;
            const ctx = ecgCtx;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = 'rgba(0, 255, 135, 0.1)';
            ctx.lineWidth = 1;
            for (let gx = 0; gx < w; gx += 20) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
            for (let gy = 0; gy < h; gy += 20) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
            ctx.strokeStyle = '#00ff87';
            ctx.lineWidth = 2;
            ctx.shadowColor = '#00ff87';
            ctx.shadowBlur = 5;
            ctx.beginPath();
            let bpm = hr || 80;
            let period = Math.max(0.4, 60 / bpm);
            let samples = w;
            for (let i = 0; i < samples; i++) {
                let x = i;
                let tt = (t + i / 120);
                let phase = (tt % period) / period;
                let y = 0.02 * Math.sin(2 * Math.PI * phase * 5);
                if (phase > 0.1 && phase < 0.14) y += -0.5;
                if (phase >= 0.14 && phase < 0.18) y += 1.4;
                if (phase >= 0.18 && phase < 0.22) y += -0.3;
                if (phase > 0.28 && phase < 0.36) y += 0.25 * Math.sin(Math.PI * (phase - 0.28) / 0.08);
                y += (Math.random() - 0.5) * 0.02;
                let yy = h * (0.5 - y * 0.35);
                if (i === 0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
            t += 1/60;
        }
        
        // =============== Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¨Ø³Ù‘Ø· ===============
        const history = [];
        const MAX_HIST = 120;
        function riskScoreFrom(v) {
            readLimits();
            const dev = (val, {min, max}) => val < min ? (min - val) / (min || 1) : (val > max ? (val - max) / (max || 1) : 0);
            let s = 0;
            s += 35 * Math.min(2, dev(v.hr, limits.hr));
            s += 18 * Math.min(2, dev(v.sys, limits.sys));
            s += 12 * Math.min(2, dev(v.dia, limits.dia));
            s += 25 * Math.min(2, dev(v.spo2, limits.spo2));
            s += 5 * Math.min(2, dev(v.rr, limits.rr));
            s += 5 * Math.min(2, dev(v.temp, limits.temp));
            const n = history.length;
            if (n >= 6) {
                const trendHr = history.slice(-6).map(x=>x.hr), trendSp = history.slice(-6).map(x=>x.spo2);
                if ((trendHr[5]-trendHr[0]) > 12) s += 10;
                if ((trendSp[0]-trendSp[5]) > 3) s += 15;
            }
            return Math.max(0, Math.min(100, Math.round(s)));
        }
        
        function setStatus(score, v) {
            const statusBadge = $('aiStatusBadge');
            let label = 'Ù…Ø³ØªÙ‚Ø±Ø©', cls = 'badge badge-ok';
            if (score >= 70) { label = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹'; cls = 'badge badge-bad'; }
            else if (score >= 35) { label = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·'; cls = 'badge badge-warn'; }
            statusBadge.textContent = label; statusBadge.className = cls + ' mt-1';
            $('riskScore').textContent = String(score);
            
            const setMetricState = (elId, value, limits) => {
                const el = $(elId);
                const isBp = Array.isArray(value);
                const inRange = isBp ? (value[0] >= limits[0].min && value[0] <= limits[0].max && value[1] >= limits[1].min && value[1] <= limits[1].max) : (value >= limits.min && value <= limits.max);
                el.textContent = inRange ? 'Ø·Ø¨ÙŠØ¹ÙŠ' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
                el.className = inRange ? 'badge badge-ok mt-1' : 'badge badge-bad mt-1';
                $(elId.replace('State', 'Val')).classList.toggle('text-red-600', !inRange);
            };

            setMetricState('hrState', v.hr, limits.hr);
            setMetricState('bpState', [v.sys, v.dia], [limits.sys, limits.dia]);
            setMetricState('spo2State', v.spo2, limits.spo2);
            setMetricState('rrState', v.rr, limits.rr);
            setMetricState('tempState', v.temp, limits.temp);
        }
        
        // =============== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ø¨Ø¯Ø¡ ===============
        // Note: All connection logic (Bluetooth, Serial) remains the same.
        let deviceConnected = false;
        let currentVitals = null;
        function handleHeartRate(event) {
            const value = event.target.value;
            const heartRate = value.getUint8(1);
            if (!currentVitals) currentVitals = {};
            currentVitals.hr = heartRate;
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                render(currentVitals);
                pushToFirebase(currentVitals);
            }
        }
        function handleBloodPressure(event) {
            const value = event.target.value;
            let offset = 1;
            const sys = value.getUint16(offset, true);
            offset += 2;
            const dia = value.getUint16(offset, true);
            if (!currentVitals) currentVitals = {};
            currentVitals.sys = sys;
            currentVitals.dia = dia;
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                render(currentVitals);
                pushToFirebase(currentVitals);
            }
        }
        async function connectToDevice() {
            try {
                logEvent('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø©...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate', 'blood_pressure'] }],
                    optionalServices: ['battery_service']
                });
                logEvent(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²: ${device.name}`);
                const server = await device.gatt.connect();
                logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
                const heartRateService = await server.getPrimaryService('heart_rate');
                const heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
                await heartRateCharacteristic.startNotifications();
                heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
                try {
                    const bpService = await server.getPrimaryService('blood_pressure');
                    const bpCharacteristic = await bpService.getCharacteristic('blood_pressure_measurement');
                    await bpCharacteristic.startNotifications();
                    bpCharacteristic.addEventListener('characteristicvaluechanged', handleBloodPressure);
                } catch (e) {
                    console.warn('Ø¬Ù‡Ø§Ø² Ø¶ØºØ· Ø§Ù„Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­', e);
                }
                deviceConnected = true;
                $('connBadge').textContent = 'Ø¬Ù‡Ø§Ø² Ø¨Ù„ÙˆØªÙˆØ«';
                $('connBadge').className = 'badge badge-ok mt-1';
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²:', error);
                logEvent('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', 'danger');
                return false;
            }
        }
        async function connectToSerialDevice() {
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¹Ø¨Ø± Ù…Ù†ÙØ° ØªØ³Ù„Ø³Ù„ÙŠ');
                const reader = port.readable.getReader();
                deviceConnected = true;
                $('connBadge').textContent = 'Ø¬Ù‡Ø§Ø² ØªØ³Ù„Ø³Ù„ÙŠ';
                $('connBadge').className = 'badge badge-ok mt-1';
                const readData = async () => {
                    const { value, done } = await reader.read();
                    if (done) {
                        reader.releaseLock();
                        return;
                    }
                    const data = new TextDecoder().decode(value);
                    parseSerialData(data);
                    readData();
                };
                readData();
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ:', error);
                logEvent('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', 'danger');
                return false;
            }
        }
        function parseSerialData(data) {
            const lines = data.trim().split('\n');
            const lastLine = lines[lines.length - 1];
            const parts = lastLine.split(',');
            const vitals = {};
            parts.forEach(part => {
                const [key, value] = part.split(':');
                if (key && value) {
                    vitals[key.toLowerCase()] = parseFloat(value);
                }
            });
            if (!currentVitals) currentVitals = {};
            Object.assign(currentVitals, vitals);
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                render(currentVitals);
                pushToFirebase(currentVitals);
            }
        }
        function startSimulationMode() {
            timer = setInterval(async () => {
                const v = simulateVitals();
                render(v);
                pushToFirebase(v);
            }, 1000);
            if (!window.__ecgAnim) {
                const step = () => { 
                    if (timer) drawECG(history.at(-1)?.hr || 80); 
                    window.__ecgAnim = requestAnimationFrame(step); 
                };
                step();
            }
            $('connBadge').textContent = 'Ù…Ø­Ø§ÙƒØ§Ø©';
            $('connBadge').className = 'badge badge-warn mt-1';
        }

        // =============== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ù…ÙØ­Ø³Ù‘Ù†Ø© Ù„Ù„Ø¹Ø±Ø¶) ===============
        function predictTrends() {
            if (history.length < 10) return null;
            const recentData = history.slice(-10);
            const calculateTrend = (values) => {
                let changes = 0;
                for (let i = 1; i < values.length; i++) { changes += values[i] - values[i-1]; }
                return changes / (values.length - 1);
            };
            const hrTrend = calculateTrend(recentData.map(d => d.hr));
            const spo2Trend = calculateTrend(recentData.map(d => d.spo2));
            return {
                hrPrediction: recentData[recentData.length - 1].hr + (hrTrend * 5),
                spo2Prediction: recentData[recentData.length - 1].spo2 + (spo2Trend * 5),
                deteriorationRisk: hrTrend > 2 || spo2Trend < -1
            };
        }
        function diagnoseCondition(vitals) {
            const { hr, sys, dia, spo2, rr, temp } = vitals, diagnosis = [];
            if (hr > 120) diagnosis.push({ condition: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨", severity: sys > 140 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…ØªÙˆØ³Ø·", recommendation: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù… ÙˆØ§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ¨" });
            else if (hr < 50) diagnosis.push({ condition: "Ø¨Ø·Ø¡ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨", severity: "Ù…ØªÙˆØ³Ø·", recommendation: "ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ù„Ø¨" });
            if (spo2 < 92) diagnosis.push({ condition: "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†", severity: spo2 < 88 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…ØªÙˆØ³Ø·", recommendation: rr > 24 ? "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙ†ÙØ³" : "ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†" });
            if (temp > 37.8) diagnosis.push({ condition: "Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©", severity: temp > 39 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…Ù†Ø®ÙØ¶", recommendation: "ØªØ®ÙÙŠØ¶ Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¯ÙˆÙ‰" });
            return diagnosis;
        }
        async function analyzeWithML(vitals) {
            return {
                riskLevel: Math.random() > 0.7 ? "high" : Math.random() > 0.4 ? "medium" : "low",
                possibleConditions: [
                    { name: "Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…", probability: vitals.sys > 140 ? 0.85 : 0.45 },
                    { name: "Ù‚Ù„Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†", probability: vitals.spo2 < 95 ? 0.75 : 0.25 },
                    { name: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨", probability: vitals.hr > 100 ? 0.80 : 0.30 }
                ],
                recommendations: ["Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ø¶ØºØ·", "Ù‚ÙŠØ§Ø³ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©", "ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ù„Ø¨ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ø­Ø§Ù„Ø©"]
            };
        }
        function displayDiagnosis(diagnosis) {
            const container = $('diagnosis-container');
            container.innerHTML = '<h3 class="font-bold text-slate-700 mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø°ÙƒÙŠ</h3>';
            if (diagnosis.length === 0) {
                container.innerHTML += '<div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚.</div>';
                return;
            }
            diagnosis.forEach(item => {
                const div = document.createElement('div');
                div.className = `p-3 mb-2 rounded-lg text-sm ${item.severity === 'Ø¹Ø§Ù„ÙŠ' ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800'}`;
                div.innerHTML = `<div class="font-bold">${item.condition} (Ø§Ù„Ø´Ø¯Ø©: ${item.severity})</div><div><strong>Ø§Ù„ØªÙˆØµÙŠØ©:</strong> ${item.recommendation}</div>`;
                container.appendChild(div);
            });
        }
        function displayTrends(trends) {
            const container = $('trends-container');
            container.innerHTML = '<h3 class="font-bold text-slate-700 mb-2">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©</h3>';
            if (!trends) {
                container.innerHTML += '<div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤.</div>';
                return;
            }
            container.innerHTML += `<div class="text-sm space-y-1">
                <div><strong>Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (5Ø¯):</strong> ${Math.round(trends.hrPrediction)} bpm</div>
                <div><strong>Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (5Ø¯):</strong> ${Math.round(trends.spo2Prediction)}%</div>
                ${trends.deteriorationRisk ? '<div class="text-red-600 font-bold mt-2">ØªØ­Ø°ÙŠØ±: ÙŠÙˆØ¬Ø¯ Ø§Ø­ØªÙ…Ø§Ù„ Ù„ØªØ¯Ù‡ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©!</div>' : '<div class="text-green-600 mt-2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¤Ø´Ø± Ø¹Ù„Ù‰ ØªØ¯Ù‡ÙˆØ± ÙˆØ´ÙŠÙƒ.</div>'}
            </div>`;
        }
        function displayMLRecommendations(ml) {
            const container = $('ml-container');
            const riskColors = { high: 'text-red-600', medium: 'text-yellow-600', low: 'text-green-600' };
            const riskText = { high: 'Ø¹Ø§Ù„ÙŠ', medium: 'Ù…ØªÙˆØ³Ø·', low: 'Ù…Ù†Ø®ÙØ¶' };
            container.innerHTML = `<h3 class="font-bold text-slate-700 mb-2">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
            <div class="text-sm space-y-2">
                <div><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©:</strong> <span class="font-bold ${riskColors[ml.riskLevel]}">${riskText[ml.riskLevel]}</span></div>
                <div><strong>Ø­Ø§Ù„Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©:</strong>
                    <ul class="list-disc pr-4 text-xs">${ml.possibleConditions.map(c => `<li>${c.name} (${Math.round(c.probability*100)}%)</li>`).join('')}</ul>
                </div>
                <div><strong>ØªÙˆØµÙŠØ§Øª:</strong>
                    <ul class="list-disc pr-4 text-xs">${ml.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
                </div>
            </div>`;
        }

        // =============== Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ===============
        function logEvent(txt, level='info') {
            const row = document.createElement('div');
            const t = new Date().toLocaleTimeString('ar-EG');
            row.className = 'flex items-center gap-3 p-1.5 rounded-md';
            const colors = { danger: 'bg-red-500', warn: 'bg-yellow-500', info: 'bg-slate-400' };
            const dot = `<span class="w-2 h-2 rounded-full ${colors[level]} flex-shrink-0"></span>`;
            const msg = `<span class="flex-grow"><strong class="font-mono text-xs text-slate-500">[${t}]</strong> ${txt}</span>`;
            row.innerHTML = dot + msg;
            $('log').prepend(row);
        }
        function alertIfNeeded(score, v) {
            if (!$('autoAlerts').checked || score < 35) return;
            const title = score >= 70 ? 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹' : 'ØªÙ†Ø¨ÙŠÙ‡';
            const icon = score >= 70 ? 'error' : 'warning';
            const text = `HR:${v.hr} | BP:${v.sys}/${v.dia} | SpOâ‚‚:${v.spo2}%`;
            Swal.fire({ title, text, icon, toast: true, position: 'top-end', timer: 3500, showConfirmButton: false });
            logEvent(`${title}: ${text}`, score >= 70 ? 'danger' : 'warn');
            try {
                const be = new (window.AudioContext || window.webkitAudioContext)();
                const o = be.createOscillator(), g = be.createGain();
                o.type='triangle'; o.frequency.value = score >= 70 ? 900 : 600;
                o.connect(g); g.connect(be.destination); o.start(0);
                g.gain.exponentialRampToValueAtTime(0.00001, be.currentTime + 0.5);
                o.stop(be.currentTime + 0.5);
            } catch(e) { console.warn("Audio API failed", e); }
        }
        
        // =============== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ ===============
        function render(vitals) {
            $('hrVal').textContent = fmt(vitals.hr);
            $('bpVal').textContent = `${fmt(vitals.sys)}/${fmt(vitals.dia)}`;
            $('spo2Val').textContent = fmt(vitals.spo2);
            $('rrVal').textContent = fmt(vitals.rr);
            $('tempVal').textContent = fmt(vitals.temp, 1);
            history.push(vitals);
            if (history.length > MAX_HIST) history.shift();
            const score = riskScoreFrom(vitals);
            setStatus(score, vitals);
            alertIfNeeded(score, vitals);
            displayDiagnosis(diagnoseCondition(vitals));
            displayTrends(predictTrends());
            analyzeWithML(vitals).then(displayMLRecommendations);
        }
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Firebase ===============
        function pushToFirebase(vitals) {
            if (!fb.enabled) return;
            const now = new Date();
            const vitalSignsRef = fb.db.ref(`/patients/emergency/${patientId}/vitalSigns`);
            const readingsRef = fb.db.ref(`/patients/emergency/${patientId}/readings/${nowIso().replace(/[\.\#\$\[\]]/g, '')}`);
            vitalSignsRef.set(vitals).catch(e => console.error("Firebase update failed", e));
            readingsRef.set({ ...vitals, timestamp: now.toISOString() }).catch(e => console.error("Firebase save failed", e));
        }
        
        // =============== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===============
        $('connectBtn').addEventListener('click', () => {
            if (window.isSecureContext) {
                Swal.fire({
                    title: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„', text: 'Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', icon: 'question',
                    showCancelButton: true, confirmButtonText: 'Ø¨Ù„ÙˆØªÙˆØ«', cancelButtonText: 'Ù…Ù†ÙØ° ØªØ³Ù„Ø³Ù„ÙŠ'
                }).then(async (result) => {
                    if (result.isConfirmed) await connectToDevice();
                    else if (result.dismiss === Swal.DismissReason.cancel) await connectToSerialDevice();
                });
            } else {
                Swal.fire('Ø¨ÙŠØ¦Ø© ØºÙŠØ± Ø¢Ù…Ù†Ø©', 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ¦Ø© Ø¢Ù…Ù†Ø© (HTTPS). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©.', 'error');
            }
        });
        
        $('startBtn').addEventListener('click', () => {
            if (!timer) {
                logEvent('Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                startSimulationMode();
            }
        });
        
        $('stopBtn').addEventListener('click', () => {
            if (timer) {
                clearInterval(timer);
                timer = null;
                logEvent('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
                $('connBadge').textContent = 'Ù…Ø­Ù„ÙŠ';
                $('connBadge').className = 'badge badge-warn mt-1';
            }
        });
        
        $('snapBtn').addEventListener('click', () => {
            if (history.length > 0) {
                const latest = history.at(-1);
                const now = nowIso();
                const ref = fb.db.ref(`/patients/emergency/${patientId}/snapshots/${now.replace(/[\.\#\$\[\]]/g, '')}`);
                ref.set({ ...latest, timestamp: now })
                    .then(() => Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.', 'success'))
                    .catch(e => Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + e.message, 'error'));
            } else {
                Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.', 'error');
            }
        });
        
        $('clearLog').addEventListener('click', () => {
            $('log').innerHTML = '';
            logEvent('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„');
        });
        
        window.addEventListener('load', () => {
            logEvent('Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
            startSimulationMode();
        });
    </script>
</body>
</html>
