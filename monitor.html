<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        html, body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
        .card { @apply rounded-2xl shadow-lg p-5 bg-white; }
        .metric { @apply text-3xl font-extrabold tracking-tight; }
        .label { @apply text-sm text-gray-500; }
        .soft { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
        .badge-ok { @apply bg-green-100 text-green-700; }
        .badge-warn { @apply bg-yellow-100 text-yellow-700; }
        .badge-bad { @apply bg-red-100 text-red-700; }
        .badge-critical { @apply bg-red-200 text-red-800 animate-pulse; }
        canvas { image-rendering: pixelated; }
        .ai-recommendation ul { @apply list-disc list-inside space-y-1 mt-2 text-slate-700; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen">
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white grid place-items-center soft">ğŸ«€</div>
                <div>
                    <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</h1>
                    <p class="text-xs text-slate-500">Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø­Ø¸ÙŠØ© + ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ + Ø¯Ø¹Ù… Ù‚Ø±Ø§Ø± Ø·Ø¨ÙŠ</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span id="patientIdBadge" class="badge badge-ok">ID: â€”</span>
                <a id="backLink" href="#" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">Ø±Ø¬ÙˆØ¹ Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶</a>
            </div>
        </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <!-- Ù‚Ø³Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
        <section class="card grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-2">
                <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                <div class="flex items-center gap-2">
                    <div class="text-2xl font-bold text-slate-800">
                        <span id="patientName">â€”</span> 
                        <span class="text-lg font-normal" style="display: none;">(<span id="patientAge">â€”</span> Ø³Ù†Ø©)</span>
                    </div>
                    <span id="genderIcon" class="text-lg">ğŸ‘¤</span>
                    <span id="bloodTypeBadge" class="badge badge-ok">â€”</span>
                </div>
                <div class="text-xs text-slate-500 space-y-1 mt-1">
                    <div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="patientAddress">â€”</span></div>
                    <div>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="patientDept">â€”</span></div>
                    <div>Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©: <span id="patientDiseases">â€”</span></div>
                    <div>ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„: <span id="callTime">â€”</span></div>
                    <div>Ø¢Ø®Ø± ÙØ­Øµ: <span id="lastCheckup">â€”</span></div>
                    <div id="patientStatus"></div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                    <div id="aiStatusBadge" class="badge badge-ok inline-block mt-1">Ù…Ø³ØªÙ‚Ø±Ø©</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± (0â€“100)</div>
                    <div id="riskScore" class="metric">0</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§ØªØµØ§Ù„</div>
                    <div id="connBadge" class="badge badge-warn inline-block mt-1">Ù…Ø­Ù„ÙŠ</div>
                </div>
            </div>
        </section>
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© -->
        <section class="grid md:grid-cols-5 gap-4">
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)</div>
                <div id="hrVal" class="metric">â€”</div>
                <div id="hrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø¶ØºØ· (SYS/DIA mmHg)</div>
                <div id="bpVal" class="metric">â€”</div>
                <div id="bpState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† SpOâ‚‚ (%)</div>
                <div id="spo2Val" class="metric">â€”</div>
                <div id="spo2State" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³ (rpm)</div>
                <div id="rrVal" class="metric">â€”</div>
                <div id="rrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</div>
                <div id="tempVal" class="metric">â€”</div>
                <div id="tempState" class="text-xs mt-1"></div>
            </div>
        </section>
        <!-- ECG -->
        <section class="card">
            <div class="flex items-center justify-between">
                <div class="label">ECG â€“ Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ù„Ø¨ (Ù…Ø­Ø§ÙƒØ§Ø©)</div>
                <div class="text-xs text-slate-400">Ù„ÙŠØ³ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ</div>
            </div>
            <canvas id="ecg" class="w-full h-40 bg-black rounded-xl mt-3"></canvas>
        </section>

        <!-- =================================================================== -->
        <!-- ============== Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø·ÙˆØ±: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ============== -->
        <!-- =================================================================== -->
        <section id="ai-analysis-section" class="card bg-slate-800 text-white">
            <h2 class="text-xl font-bold mb-3 text-cyan-300">ğŸ”¬ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„ÙÙˆØ±ÙŠ</h2>
            <div id="ai-analysis-content" class="space-y-4">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                <div class="text-slate-400">ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©...</div>
            </div>
        </section>
        
        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <section class="grid lg:grid-cols-3 gap-4">
            <div class="card space-y-3">
                <div class="font-bold">Ø§Ù„ØªØ­ÙƒÙ…</div>
                <div class="flex flex-wrap gap-2">
                    <button id="connectBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                    <button id="startBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
                    <button id="stopBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Ø¥ÙŠÙ‚Ø§Ù</button>
                    <button id="snapBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù†</button>
                    <label class="inline-flex items-center gap-2 text-sm ml-auto">
                        <input id="autoAlerts" type="checkbox" class="w-4 h-4" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ
                    </label>
                </div>
                <p class="text-xs text-slate-500">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ Ø³ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ/Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø±.</p>
            </div>
            <div class="card lg:col-span-2">
                <div class="font-bold mb-3">Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
                <div class="grid md:grid-cols-5 gap-3 text-sm">
                    <div>
                        <div class="label">HR</div>
                        <div class="flex gap-2"><input id="hrMin" class="w-full border rounded-xl px-3 py-2" value="50"><input id="hrMax" class="w-full border rounded-xl px-3 py-2" value="120"></div>
                    </div>
                    <div>
                        <div class="label">SYS</div>
                        <div class="flex gap-2"><input id="sysMin" class="w-full border rounded-xl px-3 py-2" value="90"><input id="sysMax" class="w-full border rounded-xl px-3 py-2" value="140"></div>
                    </div>
                    <div>
                        <div class="label">DIA</div>
                        <div class="flex gap-2"><input id="diaMin" class="w-full border rounded-xl px-3 py-2" value="55"><input id="diaMax" class="w-full border rounded-xl px-3 py-2" value="90"></div>
                    </div>
                    <div>
                        <div class="label">SpOâ‚‚</div>
                        <div class="flex gap-2"><input id="spo2Min" class="w-full border rounded-xl px-3 py-2" value="92"><input id="spo2Max" class="w-full border rounded-xl px-3 py-2" value="100"></div>
                    </div>
                    <div>
                        <div class="label">RR / Temp</div>
                        <div class="flex gap-2"><input id="rrMin" class="w-full border rounded-xl px-3 py-2" value="10"><input id="rrMax" class="w-full border rounded-xl px-3 py-2" value="24"></div>
                        <div class="flex gap-2 mt-2"><input id="tempMin" class="w-full border rounded-xl px-3 py-2" value="36"><input id="tempMax" class="w-full border rounded-xl px-3 py-2" value="37.8"></div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
        <section class="card">
            <div class="flex items-center justify-between mb-2">
                <div class="font-bold">Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
                <button id="clearLog" class="text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div id="log" class="text-sm space-y-1 max-h-44 overflow-auto"></div>
        </section>
    </main>
    <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-400">
        Ù†Ø³Ø®Ø© Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€“ Ù„Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©. Ù„ÙŠØ³Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.
    </footer>
    
    <script>
    // =============== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    const firebaseConfig = {
        apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
        authDomain: "hospital-project-e4b59.firebaseapp.com",
        databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "hospital-project-e4b59",
        storageBucket: "hospital-project-e4b59.firebasestorage.app",
        messagingSenderId: "974610606258",
        appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
        measurementId: "G-0GV30LL28T"
    };
    let fb = { enabled: false, app: null, db: null };
    try {
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL) {
            fb.app = firebase.initializeApp(firebaseConfig);
            fb.db = firebase.database();
            fb.enabled = true;
            document.getElementById('connBadge').textContent = 'Firebase';
            document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
        }
    } catch (e) {
        console.warn('Firebase init failed, running local only.', e);
    }
    
    // =============== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d=0) => Number(n).toFixed(d);
    const nowIso = () => new Date().toISOString();
    function getQueryParam(key) {
        const u = new URL(window.location.href);
        return u.searchParams.get(key);
    }
    const patientId = getQueryParam('id') || '-OVjd_eZDCbyD2S14zfc';
    $('patientIdBadge').textContent = 'ID: ' + patientId;
    $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
    
    // =============== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    async function loadPatientHeader() {
        if (!fb.enabled) return;
        try {
            const snap = await fb.db.ref(`/patients/emergency/${patientId}`).get();
            if (!snap.exists()) {
                console.warn("No patient data in emergency", patientId);
                return;
            }
            const basic = snap.val();
            updatePatientDisplay(basic);
        } catch (error) {
            console.error("Error fetching patient data:", error);
        }
    }
    function updatePatientDisplay(basic) {
        $('patientName').textContent = basic.name || 'â€”';
        if (basic.age) {
            $('patientAge').textContent = basic.age;
            document.querySelector('.text-2xl.font-bold .text-lg').style.display = 'inline';
        }
        $('patientAddress').textContent = basic.address || 'â€”';
        $('patientDept').textContent = basic.serviceType || basic.department || 'â€”';
        $('patientDiseases').textContent = basic.diseases || 'â€”';
        if (basic.diseases && basic.diseases !== "Ù„Ø§ ÙŠÙˆØ¬Ø¯") {
            $('patientDiseases').innerHTML = `<span class="text-red-600 font-bold">âš ï¸ ${basic.diseases}</span>`;
        }
        $('genderIcon').textContent = basic.gender === 'male' ? 'ğŸ‘¨' : (basic.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¤');
        $('bloodTypeBadge').textContent = basic.bloodType || 'â€”';
        if (basic.callTime) $('callTime').textContent = new Date(basic.callTime).toLocaleString('ar-EG');
        if (basic.lastCheckup) $('lastCheckup').textContent = new Date(basic.lastCheckup).toLocaleDateString('ar-EG');
        if (basic.status) {
            let statusClass = '', statusText = basic.status;
            switch(basic.status.toLowerCase()) {
                case 'deteriorating': statusClass = 'text-red-600 font-bold'; statusText = 'ÙÙŠ ØªØ¯Ù‡ÙˆØ± âš ï¸'; break;
                case 'stable': statusClass = 'text-green-600'; statusText = 'Ù…Ø³ØªÙ‚Ø± âœ…'; break;
                case 'critical': statusClass = 'text-red-800 font-bold'; statusText = 'Ø­Ø±Ø¬ ğŸš¨'; break;
                default: statusClass = 'text-yellow-600';
            }
            $('patientStatus').innerHTML = `<span class="${statusClass}">Ø§Ù„Ø­Ø§Ù„Ø©: ${statusText}</span>`;
        }
    }
    loadPatientHeader();
    
    // =============== Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    const limits = { hr: {}, sys: {}, dia: {}, spo2: {}, rr: {}, temp: {} };
    function readLimits() {
        limits.hr.min = +$('hrMin').value; limits.hr.max = +$('hrMax').value;
        limits.sys.min = +$('sysMin').value; limits.sys.max = +$('sysMax').value;
        limits.dia.min = +$('diaMin').value; limits.dia.max = +$('diaMax').value;
        limits.spo2.min = +$('spo2Min').value; limits.spo2.max = +$('spo2Max').value;
        limits.rr.min = +$('rrMin').value; limits.rr.max = +$('rrMax').value;
        limits.temp.min = +$('tempMin').value; limits.temp.max = +$('tempMax').value;
    }
    
    // =============== Ù…Ø­Ø§ÙƒØ§Ø© Ùˆ ECG (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    let timer = null, t = 0;
    const history = [];
    const MAX_HIST = 120;
    function randn(mean, sd) { let u=1-Math.random(),v=1-Math.random(); let z=Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v); return mean+z*sd; }
    function simulateVitals() { return { hr: Math.max(30,Math.round(randn(82,6))), sys: Math.round(randn(118,8)), dia: Math.round(randn(76,6)), spo2: Math.min(100,Math.max(85,Math.round(randn(97,1.2)))), rr: Math.max(6,Math.round(randn(16,2))), temp: +randn(36.9,0.2).toFixed(1) }; }
    const ecgCanvas = $('ecg'), ecgCtx = ecgCanvas.getContext('2d');
    function resizeCanvas() { ecgCanvas.width=ecgCanvas.clientWidth; ecgCanvas.height=ecgCanvas.clientHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function drawECG(hr) { const w=ecgCanvas.width,h=ecgCanvas.height,ctx=ecgCtx; ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h); ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1; for(let gx=0;gx<w;gx+=20){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,h);ctx.stroke();} for(let gy=0;gy<h;gy+=20){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(w,gy);ctx.stroke();} ctx.strokeStyle='#22c55e'; ctx.lineWidth=2; ctx.beginPath(); let bpm=hr||80; let period=Math.max(0.4,60/bpm); for(let i=0;i<w;i++){ let tt=(t+i/120); let phase=(tt%period)/period; let y=0.02*Math.sin(2*Math.PI*phase*5); if(phase>0.1&&phase<0.14)y+=-0.5; if(phase>=0.14&&phase<0.18)y+=1.4; if(phase>=0.18&&phase<0.22)y+=-0.3; if(phase>0.28&&phase<0.36)y+=0.25*Math.sin(Math.PI*(phase-0.28)/0.08); y+=(Math.random()-0.5)*0.02; let yy=h*(0.5-y*0.35); if(i===0)ctx.moveTo(i,yy);else ctx.lineTo(i,yy); } ctx.stroke(); t+=1/60; }

    // =============== ØªØ­Ø¯ÙŠØ«: Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø·ÙˆØ± ===============
    const medicalKnowledgeBase = {
        sepsis: {
            name: "Ø§Ø´ØªØ¨Ø§Ù‡ ÙÙŠ Ø¥Ù†ØªØ§Ù† Ø§Ù„Ø¯Ù… (Sepsis)",
            priority: 10,
            trigger: (v, p) => v.hr > 100 && v.temp > 38 && v.sys < 100 && v.rr > 22,
            analysis: {
                summary: "ØªØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± Ù…ØªÙ„Ø§Ø²Ù…Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨ÙŠØ© Ø§Ù„Ø¬Ù‡Ø§Ø²ÙŠØ© (SIRS)ØŒ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ù†Ø®ÙØ§Ø¶ ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù…ØŒ Ù…Ù…Ø§ ÙŠØ±ÙØ¹ Ù…Ù† Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© ÙˆØ¬ÙˆØ¯ Ø¥Ù†ØªØ§Ù† Ø­Ø§Ø¯.",
                rationale: "Ø§Ø¬ØªÙ…Ø§Ø¹ ØªØ³Ø§Ø±Ø¹ Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ§Ù„ØªÙ†ÙØ³ Ù…Ø¹ Ø§Ù„Ø­Ù…Ù‰ ÙˆØ§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø¶ØºØ· Ù‡Ùˆ Ø¹Ù„Ø§Ù…Ø© ØªØ­Ø°ÙŠØ±ÙŠØ© ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ© ØªØªØ·Ù„Ø¨ ØªØ¯Ø®Ù„Ø§Ù‹ Ø¹Ø§Ø¬Ù„Ø§Ù‹ Ù„Ù…Ù†Ø¹ ØªØ·ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ØµØ¯Ù…Ø© Ø¥Ù†ØªØ§Ù†ÙŠØ©.",
                recommendations: [
                    "Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ (Critical Alert).",
                    "Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø¥Ù†ØªØ§Ù† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ (Sepsis Bundle).",
                    "Ø³Ø­Ø¨ Ø¹ÙŠÙ†Ø§Øª Ù„Ù„Ø²Ø±Ø¹ Ø§Ù„Ø¯Ù…ÙˆÙŠ ÙˆÙ‚ÙŠØ§Ø³ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù„Ø§ÙƒØªØ§Øª.",
                    "Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ø¨Ø¯Ø¡ Ø¥Ù†Ø¹Ø§Ø´ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„ÙˆØ±ÙŠØ¯ÙŠØ© ÙˆØ§Ù„Ù…Ø¶Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© ÙˆØ§Ø³Ø¹Ø© Ø§Ù„Ø·ÙŠÙ."
                ]
            }
        },
        hypertensiveCrisis: {
            name: "Ø£Ø²Ù…Ø© Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…",
            priority: 9,
            trigger: (v, p) => v.sys > 180 || v.dia > 110,
            analysis: {
                summary: "Ø§Ø±ØªÙØ§Ø¹ Ø­Ø§Ø¯ ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù… ÙŠØªØ·Ù„Ø¨ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ ÙÙˆØ±ÙŠØ§Ù‹ Ù„ÙˆØ¬ÙˆØ¯ Ø¶Ø±Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø­ÙŠÙˆÙŠØ©.",
                rationale: "Ù‚Ø±Ø§Ø¡Ø§Øª Ø¶ØºØ· Ø§Ù„Ø¯Ù… ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹ØªØ¨Ø© Ø§Ù„Ø­Ø±Ø¬Ø©. ÙŠØ¬Ø¨ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„Ø£Ø¹Ø±Ø§Ø¶ Ù…Ø«Ù„ Ø£Ù„Ù… Ø§Ù„ØµØ¯Ø±ØŒ Ø§Ù„ØµØ¯Ø§Ø¹ Ø§Ù„Ø´Ø¯ÙŠØ¯ØŒ Ø£Ùˆ Ø§Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹ØµØ¨ÙŠØ©.",
                recommendations: [
                    "Ø¥Ø¹Ø§Ø¯Ø© Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¶ØºØ· ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ø°Ø±Ø§Ø¹ÙŠÙ† Ù„Ù„ØªØ£ÙƒÙŠØ¯.",
                    "Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙˆØ±Ø§Ù‹.",
                    "ØªÙ‚ÙŠÙŠÙ… Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø¹ØµØ¨ÙŠØ© ÙˆØ§Ù„Ù‚Ù„Ø¨ÙŠØ©.",
                    "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø®Ø§ÙØ¶Ø© Ù„Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ (PRN)."
                ]
            }
        },
        hypoxia: {
            name: "Ù†Ù‚Øµ Ø§Ù„Ø£ÙƒØ³Ø¬Ø© (Hypoxia)",
            priority: 8,
            trigger: (v, p) => v.spo2 < 92,
            analysis: {
                summary: `Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ø³ØªÙˆÙ‰ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø¥Ù„Ù‰ ${v.spo2}%ØŒ Ù…Ù…Ø§ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ù‚ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙ†ÙØ³ÙŠ.`,
                rationale: "ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¨Ø¨ Ù†Ù‚Øµ Ø§Ù„Ø£ÙƒØ³Ø¬Ø©. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ ÙŠØ¹Ø§Ù†ÙŠ Ù…Ù† Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø© Ù…Ø«Ù„ (COPD)ØŒ ÙÙ‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ØªÙˆÙ‚Ø¹Ø© ÙˆÙ„ÙƒÙ†Ù‡Ø§ Ù„Ø§ ØªØ²Ø§Ù„ ØªØªØ·Ù„Ø¨ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©.",
                recommendations: [
                    "Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ù…Ø±ÙŠØ¶ (Ø±ÙØ¹ Ø±Ø£Ø³ Ø§Ù„Ø³Ø±ÙŠØ±).",
                    "ÙØ­Øµ Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¡ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹ÙˆØ§Ø¦Ù‚.",
                    "Ø§Ù„Ø¨Ø¯Ø¡ Ø£Ùˆ Ø²ÙŠØ§Ø¯Ø© Ø¥Ù…Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„.",
                    "ØªÙ‚ÙŠÙŠÙ… ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¦Ø© (Auscultation) ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø¨ÙŠØ¨."
                ]
            }
        },
        bradycardia: {
            name: "Ø¨Ø·Ø¡ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (Bradycardia)",
            priority: 7,
            trigger: (v, p) => v.hr < 50,
            analysis: {
                summary: "Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ø¹Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ.",
                rationale: "ÙŠØ¬Ø¨ ØªÙ‚ÙŠÙŠÙ… Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø·Ø¡ Ø§Ù„Ù‚Ù„Ø¨ Ù…ØµØ­ÙˆØ¨Ø§Ù‹ Ø¨Ø£Ø¹Ø±Ø§Ø¶ (Symptomatic) Ù…Ø«Ù„ Ø§Ù„Ø¯ÙˆØ®Ø© Ø£Ùˆ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø¶ØºØ·. Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠÙŠÙ† Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙ‡Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ.",
                recommendations: [
                    "ØªÙ‚ÙŠÙŠÙ… Ù…Ø³ØªÙˆÙ‰ ÙˆØ¹ÙŠ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ³Ø¤Ø§Ù„Ù‡ Ø¹Ù† Ø£ÙŠ Ø£Ø¹Ø±Ø§Ø¶.",
                    "ÙØ­Øµ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù…ØªØ²Ø§Ù…Ù†.",
                    "Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø±ÙŠØ¶ (Ù…Ø«Ù„ Ø­Ø§ØµØ±Ø§Øª Ø¨ÙŠØªØ§).",
                    "Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù‡Ø§Ø² ØªÙ†Ø¸ÙŠÙ… Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ÙƒØ¥Ø¬Ø±Ø§Ø¡ Ø§Ø­ØªØ±Ø§Ø²ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±."
                ]
            }
        },
        stable: {
            name: "Ø­Ø§Ù„Ø© Ù…Ø³ØªÙ‚Ø±Ø©",
            priority: 0,
            trigger: (v, p) => true, // Default case
            analysis: {
                summary: "Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù„Ù„Ù…Ø±ÙŠØ¶ Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø§Ù„Ø¢Ù…Ù†Ø©.",
                rationale: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù†Ø­Ø±Ø§ÙØ§Øª ÙƒØ¨ÙŠØ±Ø© Ø£Ùˆ Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø³Ù„Ø¨ÙŠØ© Ù…Ù‚Ù„Ù‚Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©. Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶.",
                recommendations: [
                    "Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙˆØªÙŠÙ†ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©.",
                    "Ø¶Ù…Ø§Ù† Ø±Ø§Ø­Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØªÙ„Ø¨ÙŠØ© Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙ‡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©."
                ]
            }
        }
    };
    async function runAIAnalysis(vitals) {
        const patientInfo = {
            diseases: ($('patientDiseases')?.textContent || '').toLowerCase()
        };
        for (const key in medicalKnowledgeBase) {
            const condition = medicalKnowledgeBase[key];
            if (condition.trigger(vitals, patientInfo)) {
                return {
                    condition: condition.name,
                    ...condition.analysis
                };
            }
        }
    }
    function displayAIAnalysis(analysis) {
        const container = $('ai-analysis-content');
        if (!analysis) {
            container.innerHTML = '<div class="text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„.</div>';
            return;
        }
        let bgColor = 'bg-slate-700';
        if (analysis.condition.includes('Ø¥Ù†ØªØ§Ù†') || analysis.condition.includes('Ø£Ø²Ù…Ø©')) {
            bgColor = 'bg-red-900/50';
        } else if (analysis.condition.includes('Ù†Ù‚Øµ') || analysis.condition.includes('Ø¨Ø·Ø¡')) {
            bgColor = 'bg-yellow-900/50';
        }
        container.innerHTML = `
            <div class="p-4 rounded-lg ${bgColor}">
                <h3 class="font-bold text-lg text-white">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: <span class="text-yellow-300">${analysis.condition}</span></h3>
                <p class="text-sm text-slate-300 mt-1">${analysis.summary}</p>
            </div>
            <div class="p-4 rounded-lg bg-slate-700">
                <h4 class="font-bold text-cyan-300">Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ (Rationale)</h4>
                <p class="text-sm text-slate-300 mt-1">${analysis.rationale}</p>
            </div>
            <div class="p-4 rounded-lg bg-slate-700 ai-recommendation">
                <h4 class="font-bold text-cyan-300">Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (Next Actions)</h4>
                <ul>
                    ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    // =============== Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ===============
    function riskScoreFrom(v) {
        readLimits();
        const dev = (val, {min, max}) => val < min ? (min - val) / (min || 1) : (val > max ? (val - max) / (max || 1) : 0);
        let s = 0;
        s += 35 * Math.min(2, dev(v.hr, limits.hr));
        s += 18 * Math.min(2, dev(v.sys, limits.sys));
        s += 12 * Math.min(2, dev(v.dia, limits.dia));
        s += 25 * Math.min(2, dev(v.spo2, limits.spo2));
        s += 5 * Math.min(2, dev(v.rr, limits.rr));
        s += 5 * Math.min(2, dev(v.temp, limits.temp));
        const n = history.length;
        if (n >= 10) {
            const trendSp = history.slice(-10).map(x=>x.spo2).reduce((a,b,i,arr) => a + (b - arr[0]), 0) / 10;
            if (trendSp < -0.5) s += 15; // Add risk for dropping SpO2 trend
        }
        return Math.max(0, Math.min(100, Math.round(s)));
    }
    function setStatus(score, v) {
        const badge = $('aiStatusBadge');
        let label = 'Ù…Ø³ØªÙ‚Ø±Ø©', cls = 'badge badge-ok';
        if (score >= 80) { label = 'Ø­Ø§Ù„Ø© Ø­Ø±Ø¬Ø©'; cls = 'badge badge-critical'; }
        else if (score >= 60) { label = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹'; cls = 'badge badge-bad'; }
        else if (score >= 30) { label = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·'; cls = 'badge badge-warn'; }
        badge.textContent = label; badge.className = cls + ' inline-block';
        $('riskScore').textContent = String(score);
        const within = (val, lim) => (val >= lim.min && val <= lim.max);
        const updateState = (el, ok) => { el.textContent = ok ? 'Ø·Ø¨ÙŠØ¹ÙŠ' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚'; el.className = ok ? 'text-green-600' : 'text-red-600 font-bold'; };
        updateState($('hrState'), within(v.hr, limits.hr));
        updateState($('bpState'), within(v.sys, limits.sys) && within(v.dia, limits.dia));
        updateState($('spo2State'), within(v.spo2, limits.spo2));
        updateState($('rrState'), within(v.rr, limits.rr));
        updateState($('tempState'), within(v.temp, limits.temp));
    }
    
    // =============== Ø³Ø¬Ù„ ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    function logEvent(txt, level='info') {
        const row = document.createElement('div');
        const t = new Date().toLocaleTimeString();
        row.className = 'flex items-center gap-2';
        const dot = document.createElement('span'); dot.className = 'w-2.5 h-2.5 rounded-full ' + (level==='danger'? 'bg-rose-500' : level==='warn'? 'bg-amber-500':'bg-slate-400');
        const msg = document.createElement('span'); msg.textContent = `[${t}] ${txt}`;
        row.appendChild(dot); row.appendChild(msg);
        $('log').prepend(row);
    }
    function alertIfNeeded(score, v) {
        if (!$('autoAlerts').checked || score < 30) return;
        const title = score >= 60 ? 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹' : 'ØªÙ†Ø¨ÙŠÙ‡';
        const icon = score >= 60 ? 'error' : 'warning';
        const text = `HR:${v.hr} | BP:${v.sys}/${v.dia} | SpOâ‚‚:${v.spo2}%`;
        Swal.fire({ title, text, icon, toast: true, position: 'top-end', timer: 3500, showConfirmButton: false });
        logEvent(`${title}: ${text}`, score>=60? 'danger':'warn');
        try { const be = new AudioContext(), o=be.createOscillator(), g=be.createGain(); o.type='square'; o.frequency.value=score>=60?880:660; o.connect(g); g.connect(be.destination); g.gain.setValueAtTime(0.001, be.currentTime); g.gain.exponentialRampToValueAtTime(0.15, be.currentTime+0.1); o.start(); o.stop(be.currentTime+0.4); } catch(e) {}
    }

    // =============== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ (Ù…ÙØ·ÙˆÙ‘Ø±) ===============
    function render(vitals) {
        $('hrVal').textContent = fmt(vitals.hr);
        $('bpVal').textContent = `${fmt(vitals.sys)}/${fmt(vitals.dia)}`;
        $('spo2Val').textContent = fmt(vitals.spo2);
        $('rrVal').textContent = fmt(vitals.rr);
        $('tempVal').textContent = fmt(vitals.temp, 1);
        
        history.push(vitals);
        if (history.length > MAX_HIST) history.shift();
        
        const score = riskScoreFrom(vitals);
        setStatus(score, vitals);
        alertIfNeeded(score, vitals);
        
        // ** Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ **
        runAIAnalysis(vitals).then(analysisResult => {
            displayAIAnalysis(analysisResult);
        });
    }

    // =============== ÙˆØ¸Ø§Ø¦Ù Firebase (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    function pushToFirebase(vitals) {
        if (!fb.enabled) return;
        const now = new Date();
        const path = `/patients/emergency/${patientId}`;
        fb.db.ref(`${path}/vitalSigns`).set(vitals).catch(e=>console.error("Firebase update failed", e));
        fb.db.ref(`${path}/readings/${nowIso().replace(/[\.\#\$\[\]]/g, '')}`).set({ ...vitals, timestamp: now.toISOString() }).catch(e=>console.error("Firebase save failed", e));
    }
    
    // =============== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ùˆ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    async function connectToDevice(){ /* ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ... */ return false; }
    function startSimulationMode() {
        if (timer) return;
        timer = setInterval(() => render(simulateVitals()), 1500); // Ø¥Ø¨Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        if (!window.__ecgAnim) { const step = () => { if (timer) drawECG(history.at(-1)?.hr || 80); window.__ecgAnim = requestAnimationFrame(step); }; step(); }
        $('connBadge').textContent = 'Ù…Ø­Ø§ÙƒØ§Ø©'; $('connBadge').className = 'badge badge-warn inline-block mt-1';
    }

    // =============== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù„Ø§ ØªØºÙŠÙŠØ± Ù‡Ù†Ø§) ===============
    $('connectBtn').addEventListener('click', () => { Swal.fire('ØºÙŠØ± Ù…ØªØ§Ø­', 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø£Ø¬Ù‡Ø²Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ¦Ø© Ø¢Ù…Ù†Ø© (HTTPS) ÙˆØªØ¬Ù‡ÙŠØ²Ø§Øª Ø®Ø§ØµØ©.', 'info'); });
    $('startBtn').addEventListener('click', () => { if (!timer) { logEvent('Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©'); startSimulationMode(); } });
    $('stopBtn').addEventListener('click', () => { if (timer) { clearInterval(timer); timer = null; logEvent('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©'); $('connBadge').textContent='Ù…Ø­Ù„ÙŠ'; $('connBadge').className='badge badge-warn inline-block mt-1'; } });
    $('snapBtn').addEventListener('click', () => {
        if (history.length > 0) {
            const latest = history.at(-1);
            const now = nowIso();
            const ref = fb.db.ref(`/patients/emergency/${patientId}/snapshots/${now.replace(/[\.\#\$\[\]]/g, '')}`);
            ref.set({ ...latest, timestamp: now })
               .then(() => Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success'))
               .catch(e => Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + e.message, 'error'));
        } else { Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§.', 'error'); }
    });
    $('clearLog').addEventListener('click', () => { $('log').innerHTML = ''; logEvent('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„'); });
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('load', () => {
        logEvent('Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
        startSimulationMode();
    });
    </script>
</body>
</html>
