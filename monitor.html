<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุงูููููุชูุฑ ุงูุฐูู โ Smart Patient Monitor</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { @apply rounded-2xl shadow-lg p-5 bg-white; }
    .metric { @apply text-3xl font-extrabold tracking-tight; }
    .label { @apply text-sm text-gray-500; }
    .soft { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
    .badge-ok { @apply bg-green-100 text-green-700; }
    .badge-warn { @apply bg-yellow-100 text-yellow-700; }
    .badge-bad { @apply bg-red-100 text-red-700; }
    canvas { image-rendering: pixelated; }
  </style>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Firebase (Compat CDN: ุณูู ุฏูุฌู ูู ุตูุญุฉ HTML ูุงุญุฏุฉ) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white grid place-items-center soft">๐ซ</div>
        <div>
          <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">ุงูููููุชูุฑ ุงูุฐูู โ Smart Patient Monitor</h1>
          <p class="text-xs text-slate-500">ูุฑุงูุจุฉ ูุญุธูุฉ + ุชูุจูู ุฐูู + ุญูุธ ุชููุงุฆู ููุฑุงุกุงุช ุงููุฑูุถ</p>
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span id="patientIdBadge" class="badge badge-ok">ID: โ</span>
        <a id="backLink" href="#" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">ุฑุฌูุน ูููู ุงููุฑูุถ</a>
      </div>
    </div>
  </header>
  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Patient strip -->
    <section class="card grid md:grid-cols-4 gap-4 items-center">
      <div class="md:col-span-2">
        <div class="text-slate-500 text-sm">ุงููุฑูุถ</div>
        <div class="text-2xl font-bold text-slate-800"><span id="patientName">โ</span></div>
        <div class="text-xs text-slate-500">ุงููุณู ุงูุญุงูู: <span id="patientDept">โ</span></div>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div class="text-center bg-slate-50 rounded-xl p-3">
          <div class="label">ุงูุญุงูุฉ</div>
          <div id="aiStatusBadge" class="badge badge-ok inline-block mt-1">ูุณุชูุฑุฉ</div>
        </div>
        <div class="text-center bg-slate-50 rounded-xl p-3">
          <div class="label">ูุคุดุฑ ุงูุฎุทุฑ (0โ100)</div>
          <div id="riskScore" class="metric">0</div>
        </div>
        <div class="text-center bg-slate-50 rounded-xl p-3">
          <div class="label">ุงุชุตุงู</div>
          <div id="connBadge" class="badge badge-warn inline-block mt-1">ูุญูู</div>
        </div>
      </div>
    </section>
    <!-- Metrics -->
    <section class="grid md:grid-cols-5 gap-4">
      <div class="card">
        <div class="label">ูุนุฏู ุถุฑุจุงุช ุงูููุจ (bpm)</div>
        <div id="hrVal" class="metric">โ</div>
        <div id="hrState" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">ุงูุถุบุท (SYS/DIA mmHg)</div>
        <div id="bpVal" class="metric">โ</div>
        <div id="bpState" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">ุงูุฃูุณุฌูู SpOโ (%)</div>
        <div id="spo2Val" class="metric">โ</div>
        <div id="spo2State" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">ูุนุฏู ุงูุชููุณ (rpm)</div>
        <div id="rrVal" class="metric">โ</div>
        <div id="rrState" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">ุงูุญุฑุงุฑุฉ (ยฐC)</div>
        <div id="tempVal" class="metric">โ</div>
        <div id="tempState" class="text-xs mt-1"></div>
      </div>
    </section>
    <!-- ECG -->
    <section class="card">
      <div class="flex items-center justify-between">
        <div class="label">ECG โ ูุฎุทุท ุงูููุจ (ูุญุงูุงุฉ)</div>
        <div class="text-xs text-slate-400">ููุณ ููุงุณุชุฎุฏุงู ุงูุทุจู</div>
      </div>
      <canvas id="ecg" class="w-full h-40 bg-black rounded-xl mt-3"></canvas>
    </section>
    <!-- AI Diagnosis Section -->
    <section id="diagnosis-container" class="card">
      <div class="font-bold mb-2">ุงูุชุดุฎูุต ุงูุฐูู</div>
      <div class="text-green-600">ูุง ุชูุฌุฏ ุญุงูุงุช ุชุณุชุฏุนู ุงูููู</div>
    </section>
    <!-- AI Predictions Section -->
    <section id="trends-container" class="card">
      <div class="font-bold mb-2">ุงูุชูุจุคุงุช</div>
      <div class="text-gray-500">ุจูุงูุงุช ุบูุฑ ูุงููุฉ ููุชูุจุค</div>
    </section>
    <!-- AI Recommendations Section -->
    <section id="ml-container" class="card">
      <div class="font-bold mb-2">ุชูุตูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู</div>
      <div>ูุชู ุชุญููู ุงูุชุญููู...</div>
    </section>
    <!-- Controls & Thresholds -->
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="card space-y-3">
        <div class="font-bold">ุงูุชุญูู</div>
        <div class="flex flex-wrap gap-2">
          <button id="connectBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">ุงุชุตุงู ุจุงูุฌูุงุฒ</button>
          <button id="startBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">ุจุฏุก ุงููุฑุงูุจุฉ</button>
          <button id="stopBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">ุฅููุงู</button>
          <button id="snapBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">ุญูุธ ูุฑุงุกุฉ ุงูุขู</button>
          <label class="inline-flex items-center gap-2 text-sm ml-auto">
            <input id="autoAlerts" type="checkbox" class="w-4 h-4" checked> ุชูุนูู ุงูุชูุจูู ุงูุฐูู
          </label>
        </div>
        <p class="text-xs text-slate-500">ุนูุฏ ุชูุนูู ุงูุชูุจูู ุงูุฐูู ุณูุชู ุฅุตุฏุงุฑ ุชูุจูู ุตูุชู/ูุฑุฆู ุนูุฏ ุชุฌุงูุฒ ุงูุญุฏูุฏ ุฃู ุงุฑุชูุงุน ูุคุดุฑ ุงูุฎุทุฑ.</p>
      </div>
      <div class="card lg:col-span-2">
        <div class="font-bold mb-3">ุญุฏูุฏ ุงูุฃูุงู (ูุงุจูุฉ ููุชุนุฏูู)</div>
        <div class="grid md:grid-cols-5 gap-3 text-sm">
          <div>
            <div class="label">HR</div>
            <div class="flex gap-2"><input id="hrMin" class="w-full border rounded-xl px-3 py-2" value="50"><input id="hrMax" class="w-full border rounded-xl px-3 py-2" value="120"></div>
          </div>
          <div>
            <div class="label">SYS</div>
            <div class="flex gap-2"><input id="sysMin" class="w-full border rounded-xl px-3 py-2" value="90"><input id="sysMax" class="w-full border rounded-xl px-3 py-2" value="140"></div>
          </div>
          <div>
            <div class="label">DIA</div>
            <div class="flex gap-2"><input id="diaMin" class="w-full border rounded-xl px-3 py-2" value="55"><input id="diaMax" class="w-full border rounded-xl px-3 py-2" value="90"></div>
          </div>
          <div>
            <div class="label">SpOโ</div>
            <div class="flex gap-2"><input id="spo2Min" class="w-full border rounded-xl px-3 py-2" value="92"><input id="spo2Max" class="w-full border rounded-xl px-3 py-2" value="100"></div>
          </div>
          <div>
            <div class="label">RR / Temp</div>
            <div class="flex gap-2"><input id="rrMin" class="w-full border rounded-xl px-3 py-2" value="10"><input id="rrMax" class="w-full border rounded-xl px-3 py-2" value="24"></div>
            <div class="flex gap-2 mt-2"><input id="tempMin" class="w-full border rounded-xl px-3 py-2" value="36"><input id="tempMax" class="w-full border rounded-xl px-3 py-2" value="37.8"></div>
          </div>
        </div>
      </div>
    </section>
    <!-- Alerts log -->
    <section class="card">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold">ุณุฌู ุงูุชูุจููุงุช</div>
        <button id="clearLog" class="text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">ูุณุญ ุงูุณุฌู</button>
      </div>
      <div id="log" class="text-sm space-y-1 max-h-44 overflow-auto"></div>
    </section>
  </main>
  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-400">
    ูุณุฎุฉ ูุญุงูุงุฉ ุชุนููููุฉ โ ููุนุฑุถ ุฏุงุฎู ูุดุฑูุน ูุณุชุดูู ุงูุญูุงุฉ ุงูุฐููุฉ. ููุณุช ููุงุณุชุฎุฏุงู ุงูุทุจู ุงูุญูููู.
  </footer>
  <script>
    // =============== ุฅุนุฏุงุฏ Firebase ===============
    // ุถุน ุฅุนุฏุงุฏุงุช ูุดุฑูุนู ููุง (ุฃู ุงุชุฑููุง ูุงุฑุบุฉ ููุชุดุบูู ุงููุญูู ุฏูู ุญูุธ)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "",
      appId: ""
    };
    let fb = { enabled: false, app: null, db: null };
    try {
      if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL) {
        fb.app = firebase.initializeApp(firebaseConfig);
        fb.db = firebase.database();
        fb.enabled = true;
        document.getElementById('connBadge').textContent = 'Firebase';
        document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
      }
    } catch (e) {
      console.warn('Firebase init failed, running local only.', e);
    }
    // =============== ุฃุฏูุงุช ูุณุงุนุฏุฉ ===============
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d=0) => Number(n).toFixed(d);
    const nowIso = () => new Date().toISOString();
    function getQueryParam(key) {
      const u = new URL(window.location.href);
      return u.searchParams.get(key);
    }
    const patientId = getQueryParam('id') || 'DEMO-1001';
    $('patientIdBadge').textContent = 'ID: ' + patientId;
    $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
    // ูุญุงููุฉ ุฌูุจ ุงุณู ุงููุฑูุถ ูุงููุณู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    async function loadPatientHeader() {
      if (!fb.enabled) return;
      const snap = await fb.db.ref(`/patients/${patientId}/basic`).get();
      const basic = snap.val();
      if (basic) {
        $('patientName').textContent = basic.name || 'โ';
        $('patientDept').textContent = basic.department || 'โ';
      }
    }
    loadPatientHeader();
    // =============== ุญุฏูุฏ ุงูุฃูุงู (ูุงุจูุฉ ููุชุนุฏูู) ===============
    const limits = {
      hr: { min: 50, max: 120 },
      sys: { min: 90, max: 140 },
      dia: { min: 55, max: 90 },
      spo2: { min: 92, max: 100 },
      rr: { min: 10, max: 24 },
      temp: { min: 36.0, max: 37.8 }
    };
    function readLimits() {
      limits.hr.min = +$('hrMin').value; limits.hr.max = +$('hrMax').value;
      limits.sys.min = +$('sysMin').value; limits.sys.max = +$('sysMax').value;
      limits.dia.min = +$('diaMin').value; limits.dia.max = +$('diaMax').value;
      limits.spo2.min = +$('spo2Min').value; limits.spo2.max = +$('spo2Max').value;
      limits.rr.min = +$('rrMin').value; limits.rr.max = +$('rrMax').value;
      limits.temp.min = +$('tempMin').value; limits.temp.max = +$('tempMax').value;
    }
    // =============== ูุญุงูุงุฉ ููุงุณุงุช ูุญุธูุฉ ===============
    let timer = null;
    let t = 0; // ุฒูู ูุญุงูุงุฉ ููู ECG
    function randn(mean, sd) {
      // BoxโMuller
      let u = 1 - Math.random();
      let v = 1 - Math.random();
      let z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
      return mean + z * sd;
    }
    function simulateVitals() {
      // ุชูููุฏ ูุฑุงุกุงุช ุญูู ุงููุทุงู ุงูุทุจูุนู ูุน ุชุญูู ุจุณูุท ูู ุงูุถูุถุงุก
      const hr = Math.max(30, Math.round(randn(82, 6)));
      const sys = Math.round(randn(118, 8));
      const dia = Math.round(randn(76, 6));
      const spo2 = Math.min(100, Math.max(85, Math.round(randn(97, 1.2))));
      const rr = Math.max(6, Math.round(randn(16, 2)));
      const temp = Math.max(34.5, Math.min(40, randn(36.9, 0.2)));
      return { hr, sys, dia, spo2, rr, temp: +temp.toFixed(1) };
    }
    // =============== ECG ุฑุณู ===============
    const ecgCanvas = $('ecg');
    const ecgCtx = ecgCanvas.getContext('2d');
    function resizeCanvas() {
      ecgCanvas.width = ecgCanvas.clientWidth;
      ecgCanvas.height = ecgCanvas.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    const ecg = { x: 0 };
    function drawECG(hr) {
      const w = ecgCanvas.width, h = ecgCanvas.height;
      const ctx = ecgCtx;
      // scroll effect
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, w, h);
      // grid
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 1;
      for (let gx = 0; gx < w; gx += 20) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
      for (let gy = 0; gy < h; gy += 20) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
      // waveform
      ctx.strokeStyle = '#22c55e';
      ctx.lineWidth = 2;
      ctx.beginPath();
      let bpm = hr || 80;
      let period = Math.max(0.4, 60 / bpm); // seconds per beat
      let samples = w;
      for (let i = 0; i < samples; i++) {
        let x = i;
        let tt = (t + i / 120); // time in seconds @120Hz
        let phase = (tt % period) / period;
        // simple synthetic heartbeat: P, QRS, T
        let y = 0.02 * Math.sin(2 * Math.PI * phase * 5); // baseline
        if (phase > 0.1 && phase < 0.14) y += -0.5; // Q dip
        if (phase >= 0.14 && phase < 0.18) y += 1.4; // R spike
        if (phase >= 0.18 && phase < 0.22) y += -0.3; // S dip
        if (phase > 0.28 && phase < 0.36) y += 0.25 * Math.sin(Math.PI * (phase - 0.28) / 0.08);
        // noise
        y += (Math.random() - 0.5) * 0.02;
        let yy = h * (0.5 - y * 0.35);
        if (i === 0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
      }
      ctx.stroke();
      t += 1/60; // advance time ~60 FPS
    }
    // =============== ุฐูุงุก ุงุตุทูุงุนู ูุจุณูุท (ูุคุดุฑ ุฎุทุฑ + ุญุงูุฉ) ===============
    const history = [];
    const MAX_HIST = 120; // ุขุฎุฑ ุฏูููุชูู (ุจุงูุชุฑุงุถ 1 ูุฑุงุกุฉ/ุซ)
    function riskScoreFrom(v) {
      readLimits();
      // ุญุณุงุจ ุงูุญุฑุงู ูู ูุคุดุฑ ุนู ุงููุทุงู + ุชุฑูุฏ ุจุณูุท
      const dev = (val, {min, max}) => val < min ? (min - val) / (min || 1) : (val > max ? (val - max) / (max || 1) : 0);
      let s = 0;
      s += 35 * Math.min(2, dev(v.hr, limits.hr));
      s += 18 * Math.min(2, dev(v.sys, limits.sys));
      s += 12 * Math.min(2, dev(v.dia, limits.dia));
      s += 25 * Math.min(2, dev(v.spo2, limits.spo2));
      s += 5  * Math.min(2, dev(v.rr, limits.rr));
      s += 5  * Math.min(2, dev(v.temp, limits.temp));
      // ุชุฑูุฏ: ุฅุฐุง ุญุฏุซ ูุจูุท ูุชุชุงูู ูู SpO2 ุฃู ุงุฑุชูุงุน ูุชุชุงูู ูู HR
      const n = history.length;
      if (n >= 6) {
        const trendHr = history.slice(-6).map(x=>x.hr);
        const trendSp = history.slice(-6).map(x=>x.spo2);
        const dHr = trendHr[5]-trendHr[0];
        const dSp = trendSp[0]-trendSp[5];
        if (dHr > 12) s += 10;
        if (dSp > 3) s += 15;
      }
      return Math.max(0, Math.min(100, Math.round(s)));
    }
    function setStatus(score, v) {
      const badge = $('aiStatusBadge');
      let label = 'ูุณุชูุฑุฉ', cls = 'badge badge-ok';
      if (score >= 70) { label = 'ุฎุทุฑ ูุฑุชูุน'; cls = 'badge badge-bad'; }
      else if (score >= 35) { label = 'ุฎุทุฑ ูุชูุณุท'; cls = 'badge badge-warn'; }
      badge.textContent = label; badge.className = cls + ' inline-block';
      $('riskScore').textContent = String(score);
      // ุนุฑุถ ุญุงูุฉ ูุฎุชุตุฑุฉ ููู ูุคุดุฑ
      const within = (v, lim) => (v >= lim.min && v <= lim.max);
      $('hrState').textContent   = within(v.hr, limits.hr)   ? 'ุณููู' : 'ุฎุงุฑุฌ ุงููุทุงู';
      $('bpState').textContent   = within(v.sys, limits.sys) && within(v.dia, limits.dia) ? 'ุณููู' : 'ุฎุงุฑุฌ ุงููุทุงู';
      $('spo2State').textContent = within(v.spo2, limits.spo2) ? 'ุณููู' : 'ุฎุงุฑุฌ ุงููุทุงู';
      $('rrState').textContent   = within(v.rr, limits.rr)   ? 'ุณููู' : 'ุฎุงุฑุฌ ุงููุทุงู';
      $('tempState').textContent = within(v.temp, limits.temp) ? 'ุณููู' : 'ุฎุงุฑุฌ ุงููุทุงู';
    }
    // =============== ุงูุงุชุตุงู ุจุฌูุงุฒ ุงูููููุชูุฑ ุงูุญูููู ===============
    // ุงุณุชุจุฏุงู ูุญุงูุงุฉ ุงูุจูุงูุงุช ุจูุฑุงุกุฉ ูู ุฌูุงุฒ ุญูููู
    let deviceConnected = false;
    let dataStream = null;
    let currentVitals = null;

    // ูุนุงูุฌุฉ ุจูุงูุงุช ูุนุฏู ุถุฑุจุงุช ุงูููุจ
    function handleHeartRate(event) {
      const value = event.target.value;
      const heartRate = value.getUint8(1); // ูุฑุงุกุฉ ูุนุฏู ุถุฑุจุงุช ุงูููุจ
      
      // ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงููุธุงู
      if (!currentVitals) currentVitals = {};
      currentVitals.hr = heartRate;
      
      // ุฅุฐุง ูุงูุช ุฌููุน ุงูุจูุงูุงุช ูุชุงุญุฉุ ูู ุจุชุญุฏูุซ ุงูุนุฑุถ
      if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
        render(currentVitals);
        pushToFirebase(currentVitals);
      }
    }

    // ูุนุงูุฌุฉ ุจูุงูุงุช ุถุบุท ุงูุฏู
    function handleBloodPressure(event) {
      const value = event.target.value;
      const flags = value.getUint8(0);
      let offset = 1;
      
      // ูุฑุงุกุฉ ุถุบุท ุงูุฏู ุงูุงููุจุงุถู (SYS)
      const sys = value.getUint16(offset, true);
      offset += 2;
      
      // ูุฑุงุกุฉ ุถุบุท ุงูุฏู ุงูุงูุจุณุงุทู (DIA)
      const dia = value.getUint16(offset, true);
      
      // ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงููุธุงู
      if (!currentVitals) currentVitals = {};
      currentVitals.sys = sys;
      currentVitals.dia = dia;
      
      // ุฅุฐุง ูุงูุช ุฌููุน ุงูุจูุงูุงุช ูุชุงุญุฉุ ูู ุจุชุญุฏูุซ ุงูุนุฑุถ
      if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
        render(currentVitals);
        pushToFirebase(currentVitals);
      }
    }

    // ุฏุงูุฉ ููุงุชุตุงู ุจุงูุฌูุงุฒ (ุชุญุงูู ุงูุจููุชูุซ ุฃููุงูุ ุซู ุงูุชุณูุณูู)
    async function connectToMonitor() {
      // ูุญุงููุฉ ุงูุงุชุตุงู ุนุจุฑ ุงูุจููุชูุซ ุฃููุงู
      if ('bluetooth' in navigator) {
        const connected = await connectToDevice();
        if (connected) return true;
      }
      
      // ุฅุฐุง ูุดู ุงูุจููุชูุซุ ุฌุฑุจ ุงูุงุชุตุงู ุงูุชุณูุณูู
      if ('serial' in navigator) {
        const connected = await connectToSerialDevice();
        if (connected) return true;
      }
      
      // ุฅุฐุง ูุดู ูู ุดูุกุ ุฃุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ
      Swal.fire({
        title: 'ุบูุฑ ูุฏุนูู',
        text: 'ุงููุชุตูุญ ูุง ูุฏุนู ุงูุงุชุตุงู ุจุฃุฌูุฒุฉ ุงูููููุชูุฑ. ูุฑุฌู ุงุณุชุฎุฏุงู ูุชุตูุญ ุญุฏูุซ ูุฏุนู Web Bluetooth ุฃู Web Serial API.',
        icon: 'error',
        confirmButtonText: 'ุญุณูุงู'
      });
      
      return false;
    }

    // ุฏุงูุฉ ููุงุชุตุงู ุจุฌูุงุฒ ุจููุชูุซ
    async function connectToDevice() {
      try {
        logEvent('ุงูุจุญุซ ุนู ุฃุฌูุฒุฉ ุงูููููุชูุฑ ุงููุชุงุญุฉ...');
        
        // ุทูุจ ุงูุงุชุตุงู ุจุฌูุงุฒ ุจููุชูุซ (ูุฏุนู ูุนุงููุฑ BLE)
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['heart_rate', 'blood_pressure'] }],
          optionalServices: ['battery_service']
        });
        
        logEvent(`ุชู ุงูุนุซูุฑ ุนูู ุฌูุงุฒ: ${device.name}`);
        
        // ุงูุงุชุตุงู ุจุงูุฌูุงุฒ
        const server = await device.gatt.connect();
        logEvent('ุชู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ ุจูุฌุงุญ');
        
        // ุงูุญุตูู ุนูู ุฎุฏูุฉ ูุนุฏู ุถุฑุจุงุช ุงูููุจ
        const heartRateService = await server.getPrimaryService('heart_rate');
        const heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
        
        // ุงูุงุดุชุฑุงู ูู ูุฑุงุกุงุช ูุนุฏู ุถุฑุจุงุช ุงูููุจ
        await heartRateCharacteristic.startNotifications();
        heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
        
        // ุงูุญุตูู ุนูู ุฎุฏูุฉ ุถุบุท ุงูุฏู (ุฅู ูุฌุฏุช)
        try {
          const bpService = await server.getPrimaryService('blood_pressure');
          const bpCharacteristic = await bpService.getCharacteristic('blood_pressure_measurement');
          await bpCharacteristic.startNotifications();
          bpCharacteristic.addEventListener('characteristicvaluechanged', handleBloodPressure);
        } catch (e) {
          console.warn('ุฌูุงุฒ ุถุบุท ุงูุฏู ุบูุฑ ูุชุงุญ', e);
        }
        
        deviceConnected = true;
        document.getElementById('connBadge').textContent = 'ุฌูุงุฒ ุจููุชูุซ';
        document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
        
        return true;
      } catch (error) {
        console.error('ูุดู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ:', error);
        logEvent('ูุดู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ', 'danger');
        return false;
      }
    }

    // ุฏุงูุฉ ุจุฏููุฉ ููุงุชุตุงู ุนุจุฑ USB/Serial (ููุฃุฌูุฒุฉ ุงูุชู ุชุฏุนู ุฐูู)
    async function connectToSerialDevice() {
      try {
        // ุทูุจ ูููุฐ ุชุณูุณูู
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        
        logEvent('ุชู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ ุนุจุฑ ูููุฐ ุชุณูุณูู');
        
        const reader = port.readable.getReader();
        deviceConnected = true;
        document.getElementById('connBadge').textContent = 'ุฌูุงุฒ ุชุณูุณูู';
        document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
        
        // ูุฑุงุกุฉ ุงูุจูุงูุงุช ุจุดูู ูุณุชูุฑ
        const readData = async () => {
          const { value, done } = await reader.read();
          if (done) {
            reader.releaseLock();
            return;
          }
          
          // ุชุญููู ุงูุจูุงูุงุช ุงููุณุชููุฉ (ูุนุชูุฏ ุนูู ุชูุณูู ุฌูุงุฒู)
          const data = new TextDecoder().decode(value);
          parseSerialData(data);
          
          readData();
        };
        
        readData();
        return true;
      } catch (error) {
        console.error('ูุดู ุงูุงุชุตุงู ุงูุชุณูุณูู:', error);
        logEvent('ูุดู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ', 'danger');
        return false;
      }
    }

    // ุชุญููู ุงูุจูุงูุงุช ุงูุชุณูุณููุฉ
    function parseSerialData(data) {
      // ูุฐุง ูุซุงู ุจุณูุทุ ูุฌุจ ุชุนุฏููู ุญุณุจ ุชูุณูู ุจูุงูุงุช ุฌูุงุฒู
      // ูุซุงู: "HR:75,SYS:120,DIA:80,SPO2:98,RR:16,TEMP:36.5"
      const lines = data.trim().split('\n');
      const lastLine = lines[lines.length - 1];
      
      const parts = lastLine.split(',');
      const vitals = {};
      
      parts.forEach(part => {
        const [key, value] = part.split(':');
        if (key && value) {
          vitals[key.toLowerCase()] = parseFloat(value);
        }
      });
      
      // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูุญุงููุฉ
      if (!currentVitals) currentVitals = {};
      Object.assign(currentVitals, vitals);
      
      // ุชุญุฏูุซ ุงูุนุฑุถ ุฅุฐุง ูุงูุช ุฌููุน ุงูุจูุงูุงุช ูุชุงุญุฉ
      if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
        render(currentVitals);
        pushToFirebase(currentVitals);
      }
    }

    // ุฏุงูุฉ ูุจุฏุก ูุถุน ุงููุญุงูุงุฉ ูุฎูุงุฑ ุงุญุชูุงุทู
    function startSimulationMode() {
      timer = setInterval(async () => {
        const v = simulateVitals();
        render(v);
        pushToFirebase(v);
      }, 1000);
      
      // ุฑุณู ECG ุจูุนุฏู ุฃุนูู ููุนููุฉ ุงูุฎุท
      if (!window.__ecgAnim) {
        const step = () => { 
          if (timer) drawECG(history.at(-1)?.hr || 80); 
          window.__ecgAnim = requestAnimationFrame(step); 
        };
        step();
      }
      
      document.getElementById('connBadge').textContent = 'ูุญุงูุงุฉ';
      document.getElementById('connBadge').className = 'badge badge-warn inline-block mt-1';
    }
    
    // =============== ูุธุงุฆู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ===============
    // ุฅุถุงูุฉ ูููุฐุฌ ุชูุจุคู ุจุณูุท ููุชูุจุค ุจุงูุงุชุฌุงูุงุช ุงููุณุชูุจููุฉ
    function predictTrends() {
      if (history.length < 10) return null;
      
      // ุชุญููู ุงูุงุชุฌุงูุงุช ุงูุฃุฎูุฑุฉ
      const recentData = history.slice(-10);
      const hrTrend = calculateTrend(recentData.map(d => d.hr));
      const spo2Trend = calculateTrend(recentData.map(d => d.spo2));
      
      // ุงูุชูุจุค ุจุงูุญุงูุฉ ุฎูุงู ุงูู 5 ุฏูุงุฆู ุงููุงุฏูุฉ
      return {
        hrPrediction: recentData[recentData.length - 1].hr + (hrTrend * 5),
        spo2Prediction: recentData[recentData.length - 1].spo2 + (spo2Trend * 5),
        deteriorationRisk: hrTrend > 2 || spo2Trend < -1
      };
    }

    function calculateTrend(values) {
      // ุญุณุงุจ ูุชูุณุท ุงูุชุบูุฑ ุจูู ุงูููู ุงููุชุชุงููุฉ
      let changes = 0;
      for (let i = 1; i < values.length; i++) {
        changes += values[i] - values[i-1];
      }
      return changes / (values.length - 1);
    }

    // ุฅุถุงูุฉ ูุธุงู ุชุดุฎูุต ูุนุชูุฏ ุนูู ููุงุนุฏ ุทุจูุฉ
    function diagnoseCondition(vitals) {
      const { hr, sys, dia, spo2, rr, temp } = vitals;
      const diagnosis = [];
      
      // ุชุดุฎูุต ุญุงูุงุช ุงูููุจ
      if (hr > 120) {
        diagnosis.push({
          condition: "ุชุณุงุฑุน ุถุฑุจุงุช ุงูููุจ",
          severity: sys > 140 ? "ุนุงูู" : "ูุชูุณุท",
          recommendation: "ูุฑุงูุจุฉ ุถุบุท ุงูุฏู ูุงุณุชุดุงุฑุฉ ุทุจูุจ"
        });
      } else if (hr < 50) {
        diagnosis.push({
          condition: "ุจุทุก ุถุฑุจุงุช ุงูููุจ",
          severity: "ูุชูุณุท",
          recommendation: "ูุญุต ูุธุงุฆู ุงูููุจ"
        });
      }
      
      // ุชุดุฎูุต ูุดุงูู ุงูุชููุณ
      if (spo2 < 92) {
        diagnosis.push({
          condition: "ุงูุฎูุงุถ ุชุดุจุน ุงูุฃูุณุฌูู",
          severity: spo2 < 88 ? "ุนุงูู" : "ูุชูุณุท",
          recommendation: rr > 24 ? "ุงูุชุญูู ูู ูุดุงูู ุงูุชููุณ" : "ุชุฒููุฏ ุงูุฃูุณุฌูู"
        });
      }
      
      // ุชุดุฎูุต ุงูุญูู
      if (temp > 37.8) {
        diagnosis.push({
          condition: "ุงุฑุชูุงุน ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ",
          severity: temp > 39 ? "ุนุงูู" : "ููุฎูุถ",
          recommendation: "ุชุฎููุถ ุงูุญุฑุงุฑุฉ ูุงูุชุญูู ูู ุงูุนุฏูู"
        });
      }
      
      return diagnosis;
    }

    // ุฏูุฌ ูููุฐุฌ ุชุนูู ุงูุขูุฉ (ูููู ุงุณุชุจุฏุงูู ุจูููุฐุฌ ุญูููู ูุฏุฑุจ)
    async function analyzeWithML(vitals) {
      // ูุญุงูุงุฉ ุงุณุชุฏุนุงุก API ูุชุญููู ุงูุจูุงูุงุช
      // ูู ุชุทุจูู ุญููููุ ููููู ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุชุนูู ุงูุขูุฉ
      
      // ูุญุงูุงุฉ ูุชูุฌุฉ ุงููููุฐุฌ
      const mlResult = {
        riskLevel: Math.random() > 0.7 ? "high" : Math.random() > 0.4 ? "medium" : "low",
        possibleConditions: [
          { name: "ุงุฑุชูุงุน ุถุบุท ุงูุฏู", probability: vitals.sys > 140 ? 0.85 : 0.45 },
          { name: "ููุฉ ุงูุฃูุณุฌูู", probability: vitals.spo2 < 95 ? 0.75 : 0.25 },
          { name: "ุชุณุงุฑุน ุถุฑุจุงุช ุงูููุจ", probability: vitals.hr > 100 ? 0.80 : 0.30 }
        ],
        recommendations: [
          "ูุฑุงูุจุฉ ูุณุชูุฑุฉ ููุถุบุท",
          "ููุงุณ ูุณุชูู ุงูุฃูุณุฌูู ูู 30 ุฏูููุฉ",
          "ูุญุต ูุธุงุฆู ุงูููุจ ุฅุฐุง ุงุณุชูุฑุช ุงูุญุงูุฉ"
        ]
      };
      
      return mlResult;
    }

    // ูุธุงุฆู ุฌุฏูุฏุฉ ูุนุฑุถ ูุชุงุฆุฌ ุงูุชุญููู
    function displayDiagnosis(diagnosis) {
      const diagnosisContainer = document.getElementById('diagnosis-container');
      diagnosisContainer.innerHTML = '';
      
      if (diagnosis.length === 0) {
        diagnosisContainer.innerHTML = '<div class="text-green-600">ูุง ุชูุฌุฏ ุญุงูุงุช ุชุณุชุฏุนู ุงูููู</div>';
        return;
      }
      
      diagnosis.forEach(item => {
        const div = document.createElement('div');
        div.className = `p-3 mb-2 rounded-lg ${item.severity === 'ุนุงูู' ? 'bg-red-100' : 'bg-yellow-100'}`;
        div.innerHTML = `
          <div class="font-bold">${item.condition}</div>
          <div class="text-sm">ุงูุดุฏุฉ: ${item.severity}</div>
          <div class="text-sm">ุงูุชูุตูุฉ: ${item.recommendation}</div>
        `;
        diagnosisContainer.appendChild(div);
      });
    }

    function displayTrends(trends) {
      const trendsContainer = document.getElementById('trends-container');
      
      if (!trends) {
        trendsContainer.innerHTML = '<div class="text-gray-500">ุจูุงูุงุช ุบูุฑ ูุงููุฉ ููุชูุจุค</div>';
        return;
      }
      
      trendsContainer.innerHTML = `
        <div class="mb-2">
          <div class="font-bold">ุงูุชูุจุคุงุช ุฎูุงู 5 ุฏูุงุฆู:</div>
          <div>ูุนุฏู ุถุฑุจุงุช ุงูููุจ ุงููุชููุน: ${Math.round(trends.hrPrediction)} bpm</div>
          <div>ูุณุชูู ุงูุฃูุณุฌูู ุงููุชููุน: ${Math.round(trends.spo2Prediction)}%</div>
          ${trends.deteriorationRisk ? '<div class="text-red-600 font-bold">ุชุญุฐูุฑ: ููุงู ุงุญุชูุงู ูุชุฏููุฑ ุงูุญุงูุฉ!</div>' : ''}
        </div>
      `;
    }

    function displayMLRecommendations(mlAnalysis) {
      const mlContainer = document.getElementById('ml-container');
      
      mlContainer.innerHTML = `
        <div class="mb-2">
          <div class="font-bold">ุชุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู:</div>
          <div>ูุณุชูู ุงูุฎุทูุฑุฉ: ${mlAnalysis.riskLevel === 'high' ? 'ุนุงูู' : mlAnalysis.riskLevel === 'medium' ? 'ูุชูุณุท' : 'ููุฎูุถ'}</div>
          <div class="mt-2">ุงูุญุงูุงุช ุงููุญุชููุฉ:</div>
          <ul>
            ${mlAnalysis.possibleConditions.map(cond => 
              `<li>${cond.name} (${Math.round(cond.probability * 100)}%)</li>`
            ).join('')}
          </ul>
          <div class="mt-2">ุชูุตูุงุช:</div>
          <ul>
            ${mlAnalysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
          </ul>
        </div>
      `;
    }
    
    // =============== ุณุฌู ุงูุชูุจููุงุช ===============
    function logEvent(txt, level='info') {
      const row = document.createElement('div');
      const t = new Date().toLocaleTimeString();
      row.className = 'flex items-center gap-2';
      const dot = document.createElement('span'); dot.className = 'w-2.5 h-2.5 rounded-full ' + (level==='danger'? 'bg-rose-500' : level==='warn'? 'bg-amber-500':'bg-slate-400');
      const msg = document.createElement('span'); msg.textContent = `[${t}] ${txt}`;
      row.appendChild(dot); row.appendChild(msg);
      $('log').prepend(row);
    }
    function alertIfNeeded(score, v) {
      if (!$('autoAlerts').checked) return;
      if (score < 35) return;
      const title = score >= 70 ? 'ุฎุทุฑ ูุฑุชูุน' : 'ุชูุจูู';
      const icon = score >= 70 ? 'error' : 'warning';
      const text = `HR:${v.hr} | BP:${v.sys}/${v.dia} | SpOโ:${v.spo2}%`;
      Swal.fire({ title, text, icon, toast: true, position: 'top-end', timer: 3500, showConfirmButton: false });
      logEvent(`${title}: ${text}`, score>=70? 'danger':'warn');
      // ุตูุช ุจุณูุท
      try { const be = new AudioContext(); const o = be.createOscillator(); const g = be.createGain(); o.type='square'; o.frequency.value = score>=70? 880: 660; o.connect(g); g.connect(be.destination); g.gain.setValueAtTime(0.001, be.currentTime); g.gain.exponentialRampToValueAtTime(0.15, be.currentTime+0.02); o.start(); o.stop(be.currentTime+0.2);} catch(e){}
    }
    // =============== ุนุฑุถ ุงูููุงุณุงุช + ุญูุธ ุฅูู Firebase ===============
    async function pushToFirebase(v) {
      if (!fb.enabled) return;
      const base = `/patients/${patientId}`;
      const ts = Date.now();
      const rec = { ...v, ts, iso: nowIso(), risk: riskScoreFrom(v) };
      await fb.db.ref(`${base}/vitalsStream/${ts}`).set(rec);
      await fb.db.ref(`${base}/latestVitals`).set(rec);
    }
    // ุชุนุฏูู ูุธููุฉ ุงูุนุฑุถ ูุชุดูู ูุชุงุฆุฌ ุงูุชุญููู ุงูุฐูู
    async function render(v) {
      $('hrVal').textContent   = v.hr + ' bpm';
      $('bpVal').textContent   = `${v.sys}/${v.dia}`;
      $('spo2Val').textContent = v.spo2 + ' %';
      $('rrVal').textContent   = v.rr + ' rpm';
      $('tempVal').textContent = v.temp + ' ยฐC';
      drawECG(v.hr);
      
      history.push(v); 
      if (history.length > MAX_HIST) history.shift();
      
      const score = riskScoreFrom(v);
      setStatus(score, v);
      
      // ุฅุถุงูุฉ ุงูุชุญููู ุงูุฐูู
      const diagnosis = diagnoseCondition(v);
      const trends = predictTrends();
      const mlAnalysis = await analyzeWithML(v);
      
      // ุนุฑุถ ูุชุงุฆุฌ ุงูุชุดุฎูุต
      displayDiagnosis(diagnosis);
      
      // ุนุฑุถ ุงูุงุชุฌุงูุงุช ุงููุชููุนุฉ
      displayTrends(trends);
      
      // ุนุฑุถ ุชูุตูุงุช ุชุนูู ุงูุขูุฉ
      displayMLRecommendations(mlAnalysis);
      
      alertIfNeeded(score, v);
    }
    // =============== ุฃุฒุฑุงุฑ ุงูุชุญูู ===============
    // ุฅุถุงูุฉ ูุนุงูุฌ ุญุฏุซ ูุฒุฑ ุงูุงุชุตุงู
    $('connectBtn').addEventListener('click', async () => {
      // ุงูุชุญูู ูู ุฏุนู ุงููุชุตูุญ ูู Web Bluetooth API
      if (!navigator.bluetooth) {
        Swal.fire({
          title: 'ุงููุชุตูุญ ุบูุฑ ูุฏุนูู',
          text: 'ูุชุตูุญู ูุง ูุฏุนู Web Bluetooth. ูุฑุฌู ุงุณุชุฎุฏุงู ูุชุตูุญ Chrome ุฃู Edge.',
          icon: 'error',
          confirmButtonText: 'ุญุณูุงู'
        });
        return;
      }
      
      // ูุชุญ ูุงูุฐุฉ ุงุฎุชูุงุฑ ุฃุฌูุฒุฉ ุงูุจููุชูุซ
      try {
        logEvent('ุฌุงุฑู ูุชุญ ูุงูุฐุฉ ุงุฎุชูุงุฑ ุฃุฌูุฒุฉ ุงูุจููุชูุซ...');
        
        // ุทูุจ ุงูุงุชุตุงู ุจุฌูุงุฒ ุจููุชูุซ ูุฏุนู ุฎุฏูุงุช ุงูููุจ ูุถุบุท ุงูุฏู
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['heart_rate'] },
            { services: ['blood_pressure'] }
          ],
          optionalServices: ['battery_service']
        });
        
        logEvent(`ุชู ุงุฎุชูุงุฑ ุฌูุงุฒ: ${device.name}`);
        
        // ุงูุงุชุตุงู ุจุงูุฌูุงุฒ
        const server = await device.gatt.connect();
        logEvent('ุชู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ ุจูุฌุงุญ');
        
        // ุงูุญุตูู ุนูู ุฎุฏูุฉ ูุนุฏู ุถุฑุจุงุช ุงูููุจ
        try {
          const heartRateService = await server.getPrimaryService('heart_rate');
          const heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
          
          // ุงูุงุดุชุฑุงู ูู ูุฑุงุกุงุช ูุนุฏู ุถุฑุจุงุช ุงูููุจ
          await heartRateCharacteristic.startNotifications();
          heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
          logEvent('ุชู ุชูุนูู ูุฑุงุกุงุช ูุนุฏู ุถุฑุจุงุช ุงูููุจ');
        } catch (error) {
          console.error('ูุดู ูู ุงููุตูู ูุฎุฏูุฉ ูุนุฏู ุถุฑุจุงุช ุงูููุจ:', error);
          logEvent('ุงูุฌูุงุฒ ูุง ูุฏุนู ูุฑุงุกุฉ ูุนุฏู ุถุฑุจุงุช ุงูููุจ', 'warn');
        }
        
        // ุงูุญุตูู ุนูู ุฎุฏูุฉ ุถุบุท ุงูุฏู
        try {
          const bpService = await server.getPrimaryService('blood_pressure');
          const bpCharacteristic = await bpService.getCharacteristic('blood_pressure_measurement');
          
          // ุงูุงุดุชุฑุงู ูู ูุฑุงุกุงุช ุถุบุท ุงูุฏู
          await bpCharacteristic.startNotifications();
          bpCharacteristic.addEventListener('characteristicvaluechanged', handleBloodPressure);
          logEvent('ุชู ุชูุนูู ูุฑุงุกุงุช ุถุบุท ุงูุฏู');
        } catch (error) {
          console.error('ูุดู ูู ุงููุตูู ูุฎุฏูุฉ ุถุบุท ุงูุฏู:', error);
          logEvent('ุงูุฌูุงุฒ ูุง ูุฏุนู ูุฑุงุกุฉ ุถุบุท ุงูุฏู', 'warn');
        }
        
        deviceConnected = true;
        document.getElementById('connBadge').textContent = 'ุฌูุงุฒ ุจููุชูุซ';
        document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
        
        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        Swal.fire({
          title: 'ุชู ุงูุงุชุตุงู ุจูุฌุงุญ',
          text: `ุชู ุงูุงุชุตุงู ุจุฌูุงุฒ ${device.name}`,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
        
      } catch (error) {
        console.error('ูุดู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ:', error);
        logEvent('ูุดู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ', 'danger');
        
        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ
        Swal.fire({
          title: 'ูุดู ุงูุงุชุตุงู',
          text: 'ุชุนุฐุฑ ุงูุงุชุตุงู ุจุฌูุงุฒ ุงูููููุชูุฑ. ูุฑุฌู ุงูุชุญูู ูู ุฃู ุงูุฌูุงุฒ ูุฑูุจ ูููุนูู.',
          icon: 'error',
          confirmButtonText: 'ุญุณูุงู'
        });
        
        // ุงูุนูุฏุฉ ุฅูู ูุถุน ุงููุญุงูุงุฉ
        logEvent('ุงูุฑุฌูุน ุฅูู ูุถุน ุงููุญุงูุงุฉ');
        deviceConnected = false;
        document.getElementById('connBadge').textContent = 'ูุญูู';
        document.getElementById('connBadge').className = 'badge badge-warn inline-block mt-1';
      }
    });

    // ุชุนุฏูู ุฒุฑ ุจุฏุก ุงููุฑุงูุจุฉ
    $('startBtn').addEventListener('click', () => {
      if (timer) return;
      
      if (!deviceConnected) {
        // ุฅุฐุง ูู ููู ุงูุฌูุงุฒ ูุชุตูุงูุ ุงุจุฏุฃ ูุถุน ุงููุญุงูุงุฉ
        logEvent('ุชู ุจุฏุก ูุถุน ุงููุญุงูุงุฉ');
        startSimulationMode();
      } else {
        // ุฅุฐุง ูุงู ุงูุฌูุงุฒ ูุชุตูุงูุ ุงุจุฏุฃ ุงููุฑุงูุจุฉ ุงูุญููููุฉ
        logEvent('ุชู ุจุฏุก ุงููุฑุงูุจุฉ ุงูุญููููุฉ');
        
        timer = setInterval(() => {
          if (currentVitals) {
            drawECG(currentVitals.hr || 80);
          }
        }, 1000);
        
        // ุฑุณู ECG ุจูุนุฏู ุฃุนูู ููุนููุฉ ุงูุฎุท
        if (!window.__ecgAnim) {
          const step = () => { 
            if (timer) drawECG(currentVitals?.hr || 80); 
            window.__ecgAnim = requestAnimationFrame(step); 
          };
          step();
        }
      }
    });

    $('stopBtn').addEventListener('click', () => {
      if (timer) { 
        clearInterval(timer); 
        timer = null; 
        logEvent('ุชู ุฅููุงู ุงููุฑุงูุจุฉ', 'warn'); 
      }
      if (window.__ecgAnim) { 
        cancelAnimationFrame(window.__ecgAnim); 
        window.__ecgAnim = null; 
      }
      
      // ูููู ุฅุถุงูุฉ ูุตู ุงูุงุชุตุงู ุจุงูุฌูุงุฒ ููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
    });
    
    $('snapBtn').addEventListener('click', async () => {
      if (!currentVitals && !deviceConnected) {
        const v = simulateVitals();
        render(v);
        await pushToFirebase(v);
        Swal.fire({ 
          title: 'ุชู ุงูุญูุธ', 
          text: 'ุชู ุญูุธ ูุฑุงุกุฉ ูุญุธูุฉ ูู ููู ุงููุฑูุถ', 
          icon: 'success', 
          timer: 1800, 
          showConfirmButton: false 
        });
        logEvent(`ุชู ุญูุธ ูุฑุงุกุฉ HR:${v.hr} BP:${v.sys}/${v.dia} SpOโ:${v.spo2}%`);
      } else if (currentVitals) {
        render(currentVitals);
        await pushToFirebase(currentVitals);
        Swal.fire({ 
          title: 'ุชู ุงูุญูุธ', 
          text: 'ุชู ุญูุธ ูุฑุงุกุฉ ูุญุธูุฉ ูู ููู ุงููุฑูุถ', 
          icon: 'success', 
          timer: 1800, 
          showConfirmButton: false 
        });
        logEvent(`ุชู ุญูุธ ูุฑุงุกุฉ HR:${currentVitals.hr} BP:${currentVitals.sys}/${currentVitals.dia} SpOโ:${currentVitals.spo2}%`);
      } else {
        Swal.fire({
          title: 'ูุง ุชูุฌุฏ ุจูุงูุงุช',
          text: 'ูุง ุชูุฌุฏ ุจูุงูุงุช ุญุงููุฉ ูุญูุธูุง. ูุฑุฌู ุงูุชุฃูุฏ ูู ุงุชุตุงู ุงูุฌูุงุฒ.',
          icon: 'warning',
          confirmButtonText: 'ุญุณูุงู'
        });
      }
    });
    
    $('clearLog').addEventListener('click', () => {
      $('log').innerHTML = '';
    });
    
    // ุชุดุบูู ุชููุงุฆู ุฎููู ุนูุฏ ุงููุชุญ (ูุฑุฉ ูุงุญุฏุฉ)
    setTimeout(()=> $('startBtn').click(), 400);
  </script>
</body>
</html>
