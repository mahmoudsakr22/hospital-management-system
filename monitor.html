<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        html, body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
        .card { @apply rounded-2xl shadow-lg p-5 bg-white; }
        .metric { @apply text-3xl font-extrabold tracking-tight; }
        .label { @apply text-sm text-gray-500; }
        .soft { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
        .badge-ok { @apply bg-green-100 text-green-700; }
        .badge-warn { @apply bg-yellow-100 text-yellow-700; }
        .badge-bad { @apply bg-red-100 text-red-700; }
        canvas { image-rendering: pixelated; }
        .diagnosis-card { @apply p-3 mb-2 rounded-lg border-l-4; }
        .high-severity { @apply bg-red-100 border-red-500; }
        .medium-severity { @apply bg-yellow-100 border-yellow-500; }
        .low-severity { @apply bg-blue-100 border-blue-500; }
        .urgency-badge { @apply text-xs px-2 py-1 rounded-full; }
        .urgency-immediate { @apply bg-red-200 text-red-800; }
        .urgency-urgent { @apply bg-yellow-200 text-yellow-800; }
        .urgency-routine { @apply bg-blue-200 text-blue-800; }
        .volume-slider { @apply w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer; }
        .volume-slider::-webkit-slider-thumb { @apply appearance-none w-4 h-4 bg-blue-600 rounded-full cursor-pointer; }
        .sound-btn { @apply p-2 rounded-full hover:bg-gray-200 transition; }
        .sound-btn.active { @apply bg-blue-100 text-blue-600; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen">
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white grid place-items-center soft">ğŸ«€</div>
                <div>
                    <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</h1>
                    <p class="text-xs text-slate-500">Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø­Ø¸ÙŠØ© + ØªÙ†Ø¨ÙŠÙ‡ Ø°ÙƒÙŠ + Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª -->
                <div class="flex items-center gap-2 bg-white rounded-xl p-2 shadow-sm">
                    <button id="soundToggle" class="sound-btn active" title="ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØµÙˆØª">
                        ğŸ”Š
                    </button>
                    <input type="range" id="volumeControl" min="0" max="100" value="70" class="volume-slider w-20">
                    <span id="volumeDisplay" class="text-xs w-8">70%</span>
                </div>
                <span id="patientIdBadge" class="badge badge-ok">ID: â€”</span>
                <a id="backLink" href="#" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">Ø±Ø¬ÙˆØ¹ Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶</a>
            </div>
        </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <section class="card grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-2">
                <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                <div class="flex items-center gap-2">
                    <div class="text-2xl font-bold text-slate-800">
                        <span id="patientName">â€”</span> 
                        <span class="text-lg font-normal" style="display: none;">(<span id="patientAge">â€”</span> Ø³Ù†Ø©)</span>
                    </div>
                    <span id="genderIcon" class="text-lg">ğŸ‘¤</span>
                    <span id="bloodTypeBadge" class="badge badge-ok">â€”</span>
                </div>
                <div class="text-xs text-slate-500 space-y-1">
                    <div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="patientAddress">â€”</span></div>
                    <div>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="patientDept">â€”</span></div>
                    <div>Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©: <span id="patientDiseases">â€”</span></div>
                    <div>ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„: <span id="callTime">â€”</span></div>
                    <div>Ø¢Ø®Ø± ÙØ­Øµ: <span id="lastCheckup">â€”</span></div>
                    <div id="patientStatus"></div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                    <div id="aiStatusBadge" class="badge badge-ok inline-block mt-1">Ù…Ø³ØªÙ‚Ø±Ø©</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± (0â€“100)</div>
                    <div id="riskScore" class="metric">0</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§ØªØµØ§Ù„</div>
                    <div id="connBadge" class="badge badge-warn inline-block mt-1">Ù…Ø­Ù„ÙŠ</div>
                </div>
            </div>
        </section>
        <section class="grid md:grid-cols-5 gap-4">
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)</div>
                <div id="hrVal" class="metric">â€”</div>
                <div id="hrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø¶ØºØ· (SYS/DIA mmHg)</div>
                <div id="bpVal" class="metric">â€”</div>
                <div id="bpState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† SpOâ‚‚ (%)</div>
                <div id="spo2Val" class="metric">â€”</div>
                <div id="spo2State" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³ (rpm)</div>
                <div id="rrVal" class="metric">â€”</div>
                <div id="rrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</div>
                <div id="tempVal" class="metric">â€”</div>
                <div id="tempState" class="text-xs mt-1"></div>
            </div>
        </section>
        <section class="card">
            <div class="flex items-center justify-between">
                <div class="label">ECG â€“ Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ù„Ø¨ (Ù…Ø­Ø§ÙƒØ§Ø©)</div>
                <div class="text-xs text-slate-400">Ù„ÙŠØ³ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ</div>
            </div>
            <canvas id="ecg" class="w-full h-40 bg-black rounded-xl mt-3"></canvas>
        </section>
        <section id="diagnosis-container" class="card">
            <div class="font-bold mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø°ÙƒÙŠ</div>
            <div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚</div>
        </section>
        <section id="trends-container" class="card">
            <div class="font-bold mb-2">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª</div>
            <div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤</div>
        </section>
        <section id="ml-container" class="card">
            <div class="font-bold mb-2">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
            <div>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
        </section>
        <section class="grid lg:grid-cols-3 gap-4">
            <div class="card space-y-3">
                <div class="font-bold">Ø§Ù„ØªØ­ÙƒÙ…</div>
                <div class="flex flex-wrap gap-2">
                    <button id="connectBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                    <button id="startBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
                    <button id="stopBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Ø¥ÙŠÙ‚Ø§Ù</button>
                    <button id="snapBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù†</button>
                    <label class="inline-flex items-center gap-2 text-sm ml-auto">
                        <input id="autoAlerts" type="checkbox" class="w-4 h-4" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ
                    </label>
                </div>
                <!-- Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØª -->
                <div class="mt-2 p-3 bg-slate-50 rounded-xl">
                    <div class="font-bold text-sm mb-2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm">
                            <input id="alertSoundEnabled" type="checkbox" class="w-4 h-4" checked> ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input id="connectionSoundEnabled" type="checkbox" class="w-4 h-4" checked> ØµÙˆØª Ø§Ù„Ø§ØªØµØ§Ù„
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input id="saveSoundEnabled" type="checkbox" class="w-4 h-4" checked> ØµÙˆØª Ø§Ù„Ø­ÙØ¸
                        </label>
                    </div>
                </div>
                <p class="text-xs text-slate-500">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ Ø³ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ/Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø±.</p>
            </div>
            <div class="card lg:col-span-2">
                <div class="font-bold mb-3">Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
                <div class="grid md:grid-cols-5 gap-3 text-sm">
                    <div>
                        <div class="label">HR</div>
                        <div class="flex gap-2"><input id="hrMin" class="w-full border rounded-xl px-3 py-2" value="50"><input id="hrMax" class="w-full border rounded-xl px-3 py-2" value="120"></div>
                    </div>
                    <div>
                        <div class="label">SYS</div>
                        <div class="flex gap-2"><input id="sysMin" class="w-full border rounded-xl px-3 py-2" value="90"><input id="sysMax" class="w-full border rounded-xl px-3 py-2" value="140"></div>
                    </div>
                    <div>
                        <div class="label">DIA</div>
                        <div class="flex gap-2"><input id="diaMin" class="w-full border rounded-xl px-3 py-2" value="55"><input id="diaMax" class="w-full border rounded-xl px-3 py-2" value="90"></div>
                    </div>
                    <div>
                        <div class="label">SpOâ‚‚</div>
                        <div class="flex gap-2"><input id="spo2Min" class="w-full border rounded-xl px-3 py-2" value="92"><input id="spo2Max" class="w-full border rounded-xl px-3 py-2" value="100"></div>
                    </div>
                    <div>
                        <div class="label">RR / Temp</div>
                        <div class="flex gap-2"><input id="rrMin" class="w-full border rounded-xl px-3 py-2" value="10"><input id="rrMax" class="w-full border rounded-xl px-3 py-2" value="24"></div>
                        <div class="flex gap-2 mt-2"><input id="tempMin" class="w-full border rounded-xl px-3 py-2" value="36"><input id="tempMax" class="w-full border rounded-xl px-3 py-2" value="37.8"></div>
                    </div>
                </div>
            </div>
        </section>
        <section class="card">
            <div class="flex items-center justify-between mb-2">
                <div class="font-bold">Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
                <button id="clearLog" class="text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div id="log" class="text-sm space-y-1 max-h-44 overflow-auto"></div>
        </section>
    </main>
    <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-400">
        Ù†Ø³Ø®Ø© Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€“ Ù„Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©. Ù„ÙŠØ³Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.
    </footer>
    
    <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ÙÙŠØ© -->
    <audio id="alertHighSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE" type="audio/wav">
    </audio>
    <audio id="alertMediumSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE" type="audio/wav">
    </audio>
    <audio id="connectionSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE" type="audio/wav">
    </audio>
    <audio id="saveSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE" type="audio/wav">
    </audio>
    <audio id="statusChangeSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE" type="audio/wav">
    </audio>
    
    <script>
        // =============== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ===============
        const firebaseConfig = {
            apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
            authDomain: "hospital-project-e4b59.firebaseapp.com",
            databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.com",
            projectId: "hospital-project-e4b59",
            storageBucket: "hospital-project-e4b59.firebasestorage.app",
            messagingSenderId: "974610606258",
            appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
            measurementId: "G-0GV30LL28T"
        };
        let fb = { enabled: false, app: null, db: null };
        try {
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL) {
                fb.app = firebase.initializeApp(firebaseConfig);
                fb.db = firebase.database();
                fb.enabled = true;
                document.getElementById('connBadge').textContent = 'Firebase';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
            }
        } catch (e) {
            console.warn('Firebase init failed, running local only.', e);
        }
        
        // =============== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===============
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d=0) => Number(n).toFixed(d);
        const nowIso = () => new Date().toISOString();
        function getQueryParam(key) {
            const u = new URL(window.location.href);
            return u.searchParams.get(key);
        }
        
        // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙƒÙ…Ø¹Ø±Ù Ø§ÙØªØ±Ø§Ø¶ÙŠ
        const patientId = getQueryParam('id') || '-OVjd_eZDCbyD2S14zfc';
        $('patientIdBadge').textContent = 'ID: ' + patientId;
        $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
        
        // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        let patientData = {};
        
        // =============== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØª ===============
        const soundSystem = {
            enabled: true,
            volume: 0.7,
            alertEnabled: true,
            connectionEnabled: true,
            saveEnabled: true,
            
            init() {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
                const savedSettings = localStorage.getItem('monitorSoundSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    this.enabled = settings.enabled !== undefined ? settings.enabled : true;
                    this.volume = settings.volume !== undefined ? settings.volume : 0.7;
                    this.alertEnabled = settings.alertEnabled !== undefined ? settings.alertEnabled : true;
                    this.connectionEnabled = settings.connectionEnabled !== undefined ? settings.connectionEnabled : true;
                    this.saveEnabled = settings.saveEnabled !== undefined ? settings.saveEnabled : true;
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    this.updateUI();
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                $('soundToggle').addEventListener('click', () => this.toggle());
                $('volumeControl').addEventListener('input', (e) => this.setVolume(e.target.value / 100));
                $('alertSoundEnabled').addEventListener('change', (e) => this.alertEnabled = e.target.checked);
                $('connectionSoundEnabled').addEventListener('change', (e) => this.connectionEnabled = e.target.checked);
                $('saveSoundEnabled').addEventListener('change', (e) => this.saveEnabled = e.target.checked);
            },
            
            toggle() {
                this.enabled = !this.enabled;
                this.updateUI();
                this.saveSettings();
                this.playSound('statusChange');
            },
            
            setVolume(volume) {
                this.volume = volume;
                $('volumeDisplay').textContent = Math.round(volume * 100) + '%';
                this.saveSettings();
            },
            
            updateUI() {
                $('soundToggle').classList.toggle('active', this.enabled);
                $('soundToggle').textContent = this.enabled ? 'ğŸ”Š' : 'ğŸ”‡';
                $('volumeControl').value = this.volume * 100;
                $('volumeDisplay').textContent = Math.round(this.volume * 100) + '%';
                $('alertSoundEnabled').checked = this.alertEnabled;
                $('connectionEnabled').checked = this.connectionEnabled;
                $('saveEnabled').checked = this.saveEnabled;
            },
            
            saveSettings() {
                const settings = {
                    enabled: this.enabled,
                    volume: this.volume,
                    alertEnabled: this.alertEnabled,
                    connectionEnabled: this.connectionEnabled,
                    saveEnabled: this.saveEnabled
                };
                localStorage.setItem('monitorSoundSettings', JSON.stringify(settings));
            },
            
            playSound(type) {
                if (!this.enabled) return;
                
                let soundElement;
                let shouldPlay = false;
                
                switch(type) {
                    case 'alertHigh':
                        soundElement = $('alertHighSound');
                        shouldPlay = this.alertEnabled;
                        break;
                    case 'alertMedium':
                        soundElement = $('alertMediumSound');
                        shouldPlay = this.alertEnabled;
                        break;
                    case 'connection':
                        soundElement = $('connectionSound');
                        shouldPlay = this.connectionEnabled;
                        break;
                    case 'save':
                        soundElement = $('saveSound');
                        shouldPlay = this.saveEnabled;
                        break;
                    case 'statusChange':
                        soundElement = $('statusChangeSound');
                        shouldPlay = this.alertEnabled;
                        break;
                }
                
                if (shouldPlay && soundElement) {
                    soundElement.volume = this.volume;
                    soundElement.currentTime = 0;
                    soundElement.play().catch(e => console.warn('Audio play failed:', e));
                }
            },
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            playTone(frequency, duration) {
                if (!this.enabled) return;
                
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.value = frequency;
                    gainNode.gain.value = this.volume * 0.3;
                    
                    oscillator.start();
                    
                    // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØª ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                    oscillator.stop(audioContext.currentTime + duration);
                } catch (e) {
                    console.warn('Tone generation failed:', e);
                }
            }
        };
        
        // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª
        soundSystem.init();
        
        // =============== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ (Ù…Ø¹Ø¯Ù„) ===============
        async function enhancedLoadPatientHeader() {
            if (!fb.enabled) return;
            
            console.log("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ø·ÙˆØ§Ø±Ø¦...");
            
            try {
                // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©
               const snap = await fb.db.ref(`/patients/emergency/${patientId}`).get();
                
                if (!snap.exists()) {
                    console.warn("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦", patientId);
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
                    const regularSnap = await fb.db.ref(`/patients/${patientId}/basic`).get();
                    if (!regularSnap.exists()) {
                        console.error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø£ÙŠ Ù‚Ø³Ù…", patientId);
                        return;
                    }
                    patientData = regularSnap.val();
                    updatePatientDisplay(patientData);
                    return;
                }
                
                patientData = snap.val();
                console.log("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:", patientData);
                updatePatientDisplay(patientData);
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:", error);
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
        function updatePatientDisplay(basic) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            $('patientName').textContent = basic.name || 'â€”';
            
            // Ø§Ù„Ø¹Ù…Ø±
            if (basic.age) {
                $('patientAge').textContent = basic.age;
                document.querySelector('.text-2xl.font-bold .text-lg').style.display = 'inline';
            } else {
                document.querySelector('.text-2xl.font-bold .text-lg').style.display = 'none';
            }
            
            // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            $('patientAddress').textContent = basic.address || 'â€”';
            
            // Ø§Ù„Ù‚Ø³Ù…/Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©
            $('patientDept').textContent = basic.serviceType || basic.department || 'â€”';
            
            // Ø§Ù„Ø£Ù…Ø±Ø§Ø¶
            $('patientDiseases').textContent = basic.diseases || 'â€”';
            if (basic.diseases && basic.diseases !== "Ù„Ø§ ÙŠÙˆØ¬Ø¯") {
                $('patientDiseases').innerHTML = `<span class="text-red-600">âš ï¸ ${basic.diseases}</span>`;
            }
            
            // Ø§Ù„Ø¬Ù†Ø³
            if (basic.gender === 'male') {
                $('genderIcon').textContent = 'ğŸ‘¨';
            } else if (basic.gender === 'female') {
                $('genderIcon').textContent = 'ğŸ‘©';
            } else {
                $('genderIcon').textContent = 'ğŸ‘¤';
            }
            
            // ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…
            $('bloodTypeBadge').textContent = basic.bloodType || 'â€”';
            
            // ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„
            if (basic.callTime) {
                const callDate = new Date(basic.callTime);
                $('callTime').textContent = callDate.toLocaleString('ar-EG');
            }
            
            // Ø¢Ø®Ø± ÙØ­Øµ
            if (basic.lastCheckup) {
                const checkupDate = new Date(basic.lastCheckup);
                $('lastCheckup').textContent = checkupDate.toLocaleDateString('ar-EG');
            }
            
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
            if (basic.status) {
                // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
                if (!$('patientStatus')) {
                    const statusDiv = document.createElement('div');
                    statusDiv.id = 'patientStatus';
                    statusDiv.className = 'text-xs mt-1';
                    document.querySelector('.text-slate-500').appendChild(statusDiv);
                }
                
                let statusClass = '';
                let statusText = basic.status;
                
                switch(basic.status.toLowerCase()) {
                    case 'deteriorating':
                        statusClass = 'text-red-600 font-bold';
                        statusText = 'ÙÙŠ ØªØ¯Ù‡ÙˆØ± âš ï¸';
                        break;
                    case 'stable':
                        statusClass = 'text-green-600';
                        statusText = 'Ù…Ø³ØªÙ‚Ø± âœ…';
                        break;
                    case 'critical':
                        statusClass = 'text-red-800 font-bold';
                        statusText = 'Ø­Ø±Ø¬ ğŸš¨';
                        break;
                    default:
                        statusClass = 'text-yellow-600';
                }
                
                $('patientStatus').innerHTML = `<span class="${statusClass}">Ø§Ù„Ø­Ø§Ù„Ø©: ${statusText}</span>`;
            }
            
            console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­");
        }
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        enhancedLoadPatientHeader();
        
        // =============== Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) ===============
        const limits = {
            hr: { min: 50, max: 120 },
            sys: { min: 90, max: 140 },
            dia: { min: 55, max: 90 },
            spo2: { min: 92, max: 100 },
            rr: { min: 10, max: 24 },
            temp: { min: 36.0, max: 37.8 }
        };
        function readLimits() {
            limits.hr.min = +$('hrMin').value; limits.hr.max = +$('hrMax').value;
            limits.sys.min = +$('sysMin').value; limits.sys.max = +$('sysMax').value;
            limits.dia.min = +$('diaMin').value; limits.dia.max = +$('diaMax').value;
            limits.spo2.min = +$('spo2Min').value; limits.spo2.max = +$('spo2Max').value;
            limits.rr.min = +$('rrMin').value; limits.rr.max = +$('rrMax').value;
            limits.temp.min = +$('tempMin').value; limits.temp.max = +$('tempMax').value;
        }
        
        // =============== Ù…Ø­Ø§ÙƒØ§Ø© Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ø­Ø¸ÙŠØ© ===============
        let timer = null;
        let t = 0; // Ø²Ù…Ù† Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ù€ ECG
        function randn(mean, sd) {
            // Boxâ€“Muller
            let u = 1 - Math.random();
            let v = 1 - Math.random();
            let z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return mean + z * sd;
        }
        function simulateVitals() {
            // ØªÙˆÙ„ÙŠØ¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù…Ø¹ ØªØ­ÙƒÙ… Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
            const hr = Math.max(30, Math.round(randn(82, 6)));
            const sys = Math.round(randn(118, 8));
            const dia = Math.round(randn(76, 6));
            const spo2 = Math.min(100, Math.max(85, Math.round(randn(97, 1.2))));
            const rr = Math.max(6, Math.round(randn(16, 2)));
            const temp = Math.max(34.5, Math.min(40, randn(36.9, 0.2)));
            return { hr, sys, dia, spo2, rr, temp: +temp.toFixed(1) };
        }
        
        // =============== ECG Ø±Ø³Ù… ===============
        const ecgCanvas = $('ecg');
        const ecgCtx = ecgCanvas.getContext('2d');
        function resizeCanvas() {
            ecgCanvas.width = ecgCanvas.clientWidth;
            ecgCanvas.height = ecgCanvas.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        const ecg = { x: 0 };
        function drawECG(hr) {
            const w = ecgCanvas.width, h = ecgCanvas.height;
            const ctx = ecgCtx;
            // scroll effect
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            // grid
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (let gx = 0; gx < w; gx += 20) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
            for (let gy = 0; gy < h; gy += 20) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
            // waveform
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 2;
            ctx.beginPath();
            let bpm = hr || 80;
            let period = Math.max(0.4, 60 / bpm); // seconds per beat
            let samples = w;
            for (let i = 0; i < samples; i++) {
                let x = i;
                let tt = (t + i / 120); // time in seconds @120Hz
                let phase = (tt % period) / period;
                // simple synthetic heartbeat: P, QRS, T
                let y = 0.02 * Math.sin(2 * Math.PI * phase * 5); // baseline
                if (phase > 0.1 && phase < 0.14) y += -0.5; // Q dip
                if (phase >= 0.14 && phase < 0.18) y += 1.4; // R spike
                if (phase >= 0.18 && phase < 0.22) y += -0.3; // S dip
                if (phase > 0.28 && phase < 0.36) y += 0.25 * Math.sin(Math.PI * (phase - 0.28) / 0.08);
                // noise
                y += (Math.random() - 0.5) * 0.02;
                let yy = h * (0.5 - y * 0.35);
                if (i === 0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
            }
            ctx.stroke();
            t += 1/60; // advance time ~60 FPS
        }
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ===============
        function calculateTrend(values) {
            let changes = 0;
            for (let i = 1; i < values.length; i++) {
                changes += values[i] - values[i-1];
            }
            return changes / (values.length - 1);
        }
        
        function calculateVolatility(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const squaredDiffs = values.map(value => Math.pow(value - mean, 2));
            const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / squaredDiffs.length;
            return Math.sqrt(avgSquaredDiff);
        }
        
        function calculateAcceleration(values) {
            if (values.length < 3) return 0;
            
            const firstHalf = values.slice(0, Math.floor(values.length / 2));
            const secondHalf = values.slice(Math.floor(values.length / 2));
            
            const firstTrend = calculateTrend(firstHalf);
            const secondTrend = calculateTrend(secondHalf);
            
            return secondTrend - firstTrend;
        }
        
        function calculatePredictionConfidence(history, predictions) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
            const recentVolatility = calculateVolatility(history.slice(-10).map(d => d.hr));
            const olderVolatility = calculateVolatility(history.slice(-20, -10).map(d => d.hr));
            
            // ÙƒÙ„Ù…Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ù‹Ø§ØŒ Ø²Ø§Ø¯Øª Ø«Ù‚Ø© Ø§Ù„ØªÙ†Ø¨Ø¤
            const stabilityFactor = 1 - Math.min(1, recentVolatility / 20);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ·ÙˆØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const modelAccuracy = 0.75; // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ù‡Ø°Ø§ Ù…Ù† Ø®Ù„Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨
            
            return Math.min(0.95, Math.max(0.3, stabilityFactor * modelAccuracy));
        }
        
        // =============== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø­Ø³Ù† ===============
        const history = [];
        const MAX_HIST = 120; // Ø¢Ø®Ø± Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† (Ø¨Ø§ÙØªØ±Ø§Ø¶ 1 Ù‚Ø±Ø§Ø¡Ø©/Ø«)
        
        function enhancedRiskScoreFrom(vitals, patientData) {
            readLimits();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø¹Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø²Ù…Ù†Ø©
            const dev = (val, {min, max}, condition) => {
                if (condition === 'hypertension') {
                    // Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø¶ØºØ·ØŒ ØªÙƒÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø£ÙƒØ«Ø± ØµØ±Ø§Ù…Ø©
                    min = min - 5;
                    max = max - 10;
                } else if (condition === 'diabetes') {
                    // Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø³ÙƒØ±ÙŠØŒ ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ù†Ø®ÙØ§Ø¶ ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø£ÙƒØ«Ø± Ø®Ø·ÙˆØ±Ø©
                    min = min + 5;
                }
                
                return val < min ? (min - val) / (min || 1) : (val > max ? (val - max) / (max || 1) : 0);
            };
            
            let s = 0;
            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ­Ø§Ù„ØªÙ‡ Ø§Ù„ØµØ­ÙŠØ©
            const ageFactor = patientData.age > 65 ? 1.2 : 1.0;
            const chronicConditions = patientData.diseases ? patientData.diseases.split(',') : [];
            
            s += 35 * Math.min(2, dev(vitals.hr, limits.hr, 'heart')) * ageFactor;
            s += 18 * Math.min(2, dev(vitals.sys, limits.sys, chronicConditions.includes('hypertension') ? 'hypertension' : 'normal'));
            s += 12 * Math.min(2, dev(vitals.dia, limits.dia, chronicConditions.includes('hypertension') ? 'hypertension' : 'normal'));
            s += 25 * Math.min(2, dev(vitals.spo2, limits.spo2, 'oxygen'));
            s += 5 * Math.min(2, dev(vitals.rr, limits.rr, 'respiratory'));
            s += 5 * Math.min(2, dev(vitals.temp, limits.temp, 'temperature'));
            
            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø¨Ø´ÙƒÙ„ Ø£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ù‹Ø§
            const n = history.length;
            if (n >= 10) {
                const trendHr = calculateTrend(history.slice(-10).map(x => x.hr));
                const trendSp = calculateTrend(history.slice(-10).map(x => x.spo2));
                const trendBp = calculateTrend(history.slice(-10).map(x => x.sys));
                
                // ØªÙ‚ÙŠÙŠÙ… Ù…Ø¯Ù‰ Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºÙŠØ±
                if (Math.abs(trendHr) > 5) s += 15;
                if (trendSp < -2) s += 20;
                if (trendBp > 3) s += 15;
                
                // ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙØ§Ø¬Ø¦Ø©
                if (n >= 3) {
                    const recentHr = history.slice(-3).map(x => x.hr);
                    const recentSp = history.slice(-3).map(x => x.spo2);
                    const hrVolatility = calculateVolatility(recentHr);
                    const spVolatility = calculateVolatility(recentSp);
                    
                    if (hrVolatility > 10) s += 10;
                    if (spVolatility > 5) s += 15;
                }
            }
            
            // Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
            if (vitals.hr > 100 && vitals.spo2 < 95) s += 15; // Ø¹Ø¯Ù… Ø§Ù†ØªØ¸Ø§Ù… Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ù…Ø¹ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†
            if (vitals.sys > 140 && vitals.hr < 60) s += 20; // Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ù…Ø¹ Ø¨Ø·Ø¡ Ø§Ù„Ù‚Ù„Ø¨
            
            return Math.max(0, Math.min(100, Math.round(s)));
        }
        
        function enhancedDiagnoseCondition(vitals, patientData) {
            const { hr, sys, dia, spo2, rr, temp } = vitals;
            const diagnosis = [];
            const chronicConditions = patientData.diseases ? patientData.diseases.split(',') : [];
            
            // ØªØ´Ø®ÙŠØµ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù‚Ù„Ø¨
            if (hr > 120) {
                if (sys > 140) {
                    diagnosis.push({
                        condition: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ù…Ø¹ Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…",
                        severity: "Ø¹Ø§Ù„ÙŠ",
                        recommendation: "Ø¥Ø¹Ø·Ø§Ø¡ Ø£Ø¯ÙˆÙŠØ© Ø®ÙØ¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù… ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©",
                        urgency: "ÙÙˆØ±ÙŠ"
                    });
                } else if (spo2 < 95) {
                    diagnosis.push({
                        condition: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ù…Ø¹ Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†",
                        severity: "Ø¹Ø§Ù„ÙŠ",
                        recommendation: "ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙˆÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙ†ÙØ³ÙŠ",
                        urgency: "ÙÙˆØ±ÙŠ"
                    });
                } else {
                    diagnosis.push({
                        condition: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨",
                        severity: "Ù…ØªÙˆØ³Ø·",
                        recommendation: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù‚Ù„Ø¨",
                        urgency: "Ø¹Ø§Ø¬Ù„"
                    });
                }
            } else if (hr < 50) {
                if (sys < 90) {
                    diagnosis.push({
                        condition: "Ø¨Ø·Ø¡ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ù…Ø¹ Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…",
                        severity: "Ø¹Ø§Ù„ÙŠ",
                        recommendation: "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ­Ø¶ÙŠØ± Ø£Ø¯ÙˆÙŠØ© Ø±ÙØ¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…",
                        urgency: "ÙÙˆØ±ÙŠ"
                    });
                } else {
                    diagnosis.push({
                        condition: "Ø¨Ø·Ø¡ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨",
                        severity: "Ù…ØªÙˆØ³Ø·",
                        recommendation: "ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
                        urgency: "Ø¹Ø§Ø¬Ù„"
                    });
                }
            }
            
            // ØªØ´Ø®ÙŠØµ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙ†ÙØ³ÙŠ
            if (spo2 < 92) {
                if (rr > 24) {
                    diagnosis.push({
                        condition: "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ù…Ø¹ Ø²ÙŠØ§Ø¯Ø© Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³",
                        severity: "Ø¹Ø§Ù„ÙŠ",
                        recommendation: "ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙ†ÙØ³ÙŠ",
                        urgency: "ÙÙˆØ±ÙŠ"
                    });
                } else if (rr < 12) {
                    diagnosis.push({
                        condition: "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ù…Ø¹ Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³",
                        severity: "Ø¹Ø§Ù„ÙŠ",
                        recommendation: "Ø¯Ø¹Ù… ØªÙ†ÙØ³ ÙÙˆØ±ÙŠ ÙˆØªØ­Ø¶ÙŠØ± Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ",
                        urgency: "ÙÙˆØ±ÙŠ"
                    });
                } else {
                    diagnosis.push({
                        condition: "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†",
                        severity: spo2 < 88 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…ØªÙˆØ³Ø·",
                        recommendation: "ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø©",
                        urgency: spo2 < 88 ? "ÙÙˆØ±ÙŠ" : "Ø¹Ø§Ø¬Ù„"
                    });
                }
            }
            
            // ØªØ´Ø®ÙŠØµ Ø­Ø§Ù„Ø§Øª Ø¶ØºØ· Ø§Ù„Ø¯Ù…
            if (sys > 160 || dia > 100) {
                diagnosis.push({
                    condition: "Ø§Ø±ØªÙØ§Ø¹ Ø­Ø§Ø¯ ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù…",
                    severity: "Ø¹Ø§Ù„ÙŠ",
                    recommendation: chronicConditions.includes('hypertension') ? 
                        "ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©" : 
                        "Ø¥Ø¹Ø·Ø§Ø¡ Ø£Ø¯ÙˆÙŠØ© Ø®ÙØ¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„ÙÙˆØ±ÙŠØ©",
                    urgency: "ÙÙˆØ±ÙŠ"
                });
            } else if (sys < 90 || dia < 60) {
                diagnosis.push({
                    condition: "Ø§Ù†Ø®ÙØ§Ø¶ Ø­Ø§Ø¯ ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù…",
                    severity: "Ø¹Ø§Ù„ÙŠ",
                    recommendation: "ØªÙ‚ÙŠÙŠÙ… Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ø®ÙØ§Ø¶ ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„ÙˆØ±ÙŠØ¯ÙŠØ©",
                    urgency: "ÙÙˆØ±ÙŠ"
                });
            }
            
            // ØªØ´Ø®ÙŠØµ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© Ø§Ù„ØªÙŠ ØªØªØ·Ù„Ø¨ ØªÙØ§Ø¹Ù„ Ø¹Ø¯Ø© Ù…Ø¤Ø´Ø±Ø§Øª
            if (hr > 100 && sys > 140 && temp > 37.5) {
                diagnosis.push({
                    condition: "Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ØªÙ‡Ø§Ø¨ÙŠØ© Ø¬Ù‡Ø§Ø²ÙŠØ© Ù…Ø­ØªÙ…Ù„Ø©",
                    severity: "Ø¹Ø§Ù„ÙŠ",
                    recommendation: "ÙØ­ÙˆØµØ§Øª Ø¯Ù… Ø¹Ø§Ø¬Ù„Ø© ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø¯ÙˆÙ‰",
                    urgency: "ÙÙˆØ±ÙŠ"
                });
            }
            
            // Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø²Ù…Ù†Ø© Ù„Ù„Ù…Ø±ÙŠØ¶
            if (chronicConditions.includes('diabetes') && temp > 37.5) {
                diagnosis.push({
                    condition: "Ø¹Ø¯ÙˆÙ‰ Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø¯Ù‰ Ù…Ø±ÙŠØ¶ Ø³ÙƒØ±ÙŠ",
                    severity: "Ù…ØªÙˆØ³Ø·",
                    recommendation: "ÙØ­Øµ Ø³ÙƒØ± Ø§Ù„Ø¯Ù… ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ØµØ¯Ø± Ø§Ù„Ø¹Ø¯ÙˆÙ‰",
                    urgency: "Ø¹Ø§Ø¬Ù„"
                });
            }
            
            if (chronicConditions.includes('heart_disease') && hr > 100) {
                diagnosis.push({
                    condition: "ØªÙØ§Ù‚Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø²Ù…Ù†Ø©",
                    severity: "Ø¹Ø§Ù„ÙŠ",
                    recommendation: "Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù‚Ù„Ø¨ ÙÙˆØ±Ø§Ù‹",
                    urgency: "ÙÙˆØ±ÙŠ"
                });
            }
            
            return diagnosis;
        }
        
        function enhancedPredictTrends(history, patientData) {
            if (history.length < 15) return null;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…Ø§Ø°Ø¬ Ø£ÙƒØ«Ø± ØªÙ‚Ø¯Ù…Ù‹Ø§ Ù„Ù„ØªÙ†Ø¨Ø¤
            const recentData = history.slice(-15);
            const olderData = history.slice(-30, -15);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const hrTrend = calculateTrend(recentData.map(d => d.hr));
            const spo2Trend = calculateTrend(recentData.map(d => d.spo2));
            const sysTrend = calculateTrend(recentData.map(d => d.sys));
            const diaTrend = calculateTrend(recentData.map(d => d.dia));
            const tempTrend = calculateTrend(recentData.map(d => d.temp));
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠØ± ÙÙŠ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± (Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ³Ø§Ø±Ø¹)
            const hrAcceleration = calculateAcceleration(history.slice(-30).map(d => d.hr));
            const spo2Acceleration = calculateAcceleration(history.slice(-30).map(d => d.spo2));
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ù„Ø¨Ø§Øª
            const hrVolatility = calculateVolatility(recentData.map(d => d.hr));
            const spo2Volatility = calculateVolatility(recentData.map(d => d.spo2));
            
            // Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const predictions = {
                hrPrediction: recentData[recentData.length - 1].hr + (hrTrend * 10) + (hrAcceleration * 5),
                spo2Prediction: recentData[recentData.length - 1].spo2 + (spo2Trend * 10) + (spo2Acceleration * 5),
                sysPrediction: recentData[recentData.length - 1].sys + (sysTrend * 10),
                diaPrediction: recentData[recentData.length - 1].dia + (diaTrend * 10),
                tempPrediction: recentData[recentData.length - 1].temp + (tempTrend * 10)
            };
            
            // ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±
            let riskFactors = [];
            let deteriorationRisk = false;
            
            if (hrTrend > 3 || hrAcceleration > 0.5) {
                riskFactors.push("Ø²ÙŠØ§Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© ÙÙŠ Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨");
                deteriorationRisk = true;
            }
            
            if (spo2Trend < -1.5 || spo2Acceleration < -0.2) {
                riskFactors.push("Ø§Ù†Ø®ÙØ§Ø¶ Ø³Ø±ÙŠØ¹ ÙÙŠ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†");
                deteriorationRisk = true;
            }
            
            if (sysTrend > 2 && diaTrend > 1) {
                riskFactors.push("Ø§Ø±ØªÙØ§Ø¹ Ù…ØªØ³Ø§Ø±Ø¹ ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù…");
                deteriorationRisk = true;
            }
            
            if (hrVolatility > 10) {
                riskFactors.push("Ø¹Ø¯Ù… Ø§Ù†ØªØ¸Ø§Ù… ÙÙŠ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨");
                deteriorationRisk = true;
            }
            
            if (spo2Volatility > 3) {
                riskFactors.push("ØªÙ‚Ù„Ø¨Ø§Øª ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†");
                deteriorationRisk = true;
            }
            
            // Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø²Ù…Ù†Ø© Ù„Ù„Ù…Ø±ÙŠØ¶
            const chronicConditions = patientData.diseases ? patientData.diseases.split(',') : [];
            
            if (chronicConditions.includes('heart_disease') && hrTrend > 2) {
                riskFactors.push("ØªÙØ§Ù‚Ù… Ù…Ø­ØªÙ…Ù„ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø²Ù…Ù†Ø©");
                deteriorationRisk = true;
            }
            
            if (chronicConditions.includes('respiratory') && spo2Trend < -1) {
                riskFactors.push("ØªÙØ§Ù‚Ù… Ù…Ø­ØªÙ…Ù„ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†ÙØ³ÙŠØ© Ø§Ù„Ù…Ø²Ù…Ù†Ø©");
                deteriorationRisk = true;
            }
            
            return {
                ...predictions,
                riskFactors,
                deteriorationRisk,
                confidence: calculatePredictionConfidence(history, predictions),
                timeframe: "10 Ø¯Ù‚Ø§Ø¦Ù‚"
            };
        }
        
        async function enhancedAnalyzeWithML(vitals, history, patientData) {
            // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
            const modelInput = {
                currentVitals: vitals,
                history: history.slice(-20), // Ø¢Ø®Ø± 20 Ù‚Ø±Ø§Ø¡Ø©
                patientData: patientData,
                timeOfDay: new Date().getHours(),
                dayOfWeek: new Date().getDay()
            };
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ
            const mlResult = await simulateMLModelCall(modelInput);
            
            // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            const enhancedRecommendations = generatePersonalizedRecommendations(mlResult, patientData);
            
            return {
                ...mlResult,
                recommendations: enhancedRecommendations
            };
        }
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ
        async function simulateMLModelCall(input) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Ø­Ø³Ø§Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const { currentVitals, history, patientData } = input;
                    
                    // Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø± Ø®Ø·ÙˆØ±Ø© Ù…Ø¹Ù‚Ø¯
                    let riskScore = 0;
                    
                    // Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø·Ø± Ù…Ù† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©
                    if (currentVitals.hr > 120 || currentVitals.hr < 50) riskScore += 25;
                    if (currentVitals.sys > 160 || currentVitals.sys < 90) riskScore += 20;
                    if (currentVitals.spo2 < 92) riskScore += 30;
                    if (currentVitals.temp > 38.5 || currentVitals.temp < 36) riskScore += 15;
                    
                    // Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø·Ø± Ù…Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª
                    if (history.length >= 10) {
                        const hrTrend = calculateTrend(history.slice(-10).map(d => d.hr));
                        const spo2Trend = calculateTrend(history.slice(-10).map(d => d.spo2));
                        
                        if (hrTrend > 3) riskScore += 15;
                        if (spo2Trend < -1.5) riskScore += 20;
                    }
                    
                    // Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø·Ø± Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
                    const chronicConditions = patientData.diseases ? patientData.diseases.split(',') : [];
                    if (chronicConditions.includes('heart_disease')) riskScore += 10;
                    if (chronicConditions.includes('diabetes')) riskScore += 5;
                    if (chronicConditions.includes('respiratory')) riskScore += 10;
                    
                    if (patientData.age > 65) riskScore += 5;
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©
                    let riskLevel = 'low';
                    if (riskScore > 70) riskLevel = 'high';
                    else if (riskScore > 40) riskLevel = 'medium';
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
                    const possibleConditions = [];
                    
                    if (currentVitals.hr > 100) {
                        possibleConditions.push({
                            name: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨",
                            probability: Math.min(0.95, 0.5 + (currentVitals.hr - 100) / 40)
                        });
                    }
                    
                    if (currentVitals.spo2 < 95) {
                        possibleConditions.push({
                            name: "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†",
                            probability: Math.min(0.95, 0.5 + (95 - currentVitals.spo2) / 10)
                        });
                    }
                    
                    if (currentVitals.sys > 140) {
                        possibleConditions.push({
                            name: "Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…",
                            probability: Math.min(0.95, 0.5 + (currentVitals.sys - 140) / 40)
                        });
                    }
                    
                    if (currentVitals.temp > 37.5) {
                        possibleConditions.push({
                            name: "Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©",
                            probability: Math.min(0.95, 0.3 + (currentVitals.temp - 37.5) / 2)
                        });
                    }
                    
                    resolve({
                        riskLevel,
                        riskScore: Math.min(100, riskScore),
                        possibleConditions,
                        timestamp: new Date().toISOString()
                    });
                }, 500); // Ù…Ø­Ø§ÙƒØ§Ø© ÙˆÙ‚Øª Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            });
        }
        
        // ØªÙˆÙ„ÙŠØ¯ ØªÙˆØµÙŠØ§Øª Ø´Ø®ØµÙŠØ©
        function generatePersonalizedRecommendations(mlResult, patientData) {
            const { riskLevel, possibleConditions } = mlResult;
            const recommendations = [];
            const chronicConditions = patientData.diseases ? patientData.diseases.split(',') : [];
            
            // ØªÙˆØµÙŠØ§Øª Ø¹Ø§Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©
            if (riskLevel === 'high') {
                recommendations.push("Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ ÙÙˆØ±Ø§Ù‹");
                recommendations.push("Ø²ÙŠØ§Ø¯Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ù„Ù‰ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚");
            } else if (riskLevel === 'medium') {
                recommendations.push("Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¹Ù† ÙƒØ«Ø¨");
                recommendations.push("Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·Ø© Ø·ÙˆØ§Ø±Ø¦ Ù…Ø­ØªÙ…Ù„Ø©");
            } else {
                recommendations.push("Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙˆØªÙŠÙ†ÙŠØ©");
            }
            
            // ØªÙˆØµÙŠØ§Øª Ø®Ø§ØµØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
            possibleConditions.forEach(condition => {
                if (condition.name === "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨" && condition.probability > 0.7) {
                    recommendations.push("Ø¥Ø¬Ø±Ø§Ø¡ ØªØ®Ø·ÙŠØ· Ù„Ù„Ù‚Ù„Ø¨ (ECG)");
                    if (chronicConditions.includes('heart_disease')) {
                        recommendations.push("Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©");
                    }
                }
                
                if (condition.name === "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†" && condition.probability > 0.7) {
                    recommendations.push("ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†");
                    recommendations.push("ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¦Ø©");
                    if (chronicConditions.includes('respiratory')) {
                        recommendations.push("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø² ØªÙ†ÙØ³ Ù…Ø³Ø§Ø¹Ø¯ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±");
                    }
                }
                
                if (condition.name === "Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…" && condition.probability > 0.7) {
                    recommendations.push("Ù‚ÙŠØ§Ø³ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø±");
                    if (chronicConditions.includes('hypertension')) {
                        recommendations.push("ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø±Ø¹Ø§Øª Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø¶ØºØ·");
                    } else {
                        recommendations.push("Ø¥Ø¹Ø·Ø§Ø¡ Ø£Ø¯ÙˆÙŠØ© Ø®ÙØ¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©");
                    }
                }
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
            return [...new Set(recommendations)];
        }
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===============
        let lastStatus = 'Ù…Ø³ØªÙ‚Ø±Ø©';
        function setStatus(score, v) {
            const badge = $('aiStatusBadge');
            let label = 'Ù…Ø³ØªÙ‚Ø±Ø©', cls = 'badge badge-ok';
            if (score >= 70) { label = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹'; cls = 'badge badge-bad'; }
            else if (score >= 35) { label = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·'; cls = 'badge badge-warn'; }
            badge.textContent = label; badge.className = cls + ' inline-block';
            $('riskScore').textContent = String(score);
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
            if (lastStatus !== label) {
                soundSystem.playSound('statusChange');
                lastStatus = label;
            }
            
            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù…Ø®ØªØµØ±Ø© Ù„ÙƒÙ„ Ù…Ø¤Ø´Ø±
            const within = (v, lim) => (v >= lim.min && v <= lim.max);
            $('hrState').textContent = within(v.hr, limits.hr) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('bpState').textContent = within(v.sys, limits.sys) && within(v.dia, limits.dia) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('spo2State').textContent = within(v.spo2, limits.spo2) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('rrState').textContent = within(v.rr, limits.rr) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('tempState').textContent = within(v.temp, limits.temp) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
        }
        
        function enhancedDisplayDiagnosis(diagnosis) {
            const diagnosisContainer = document.getElementById('diagnosis-container');
            diagnosisContainer.innerHTML = '';
            
            if (diagnosis.length === 0) {
                diagnosisContainer.innerHTML = '<div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚</div>';
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ±Ø©
            diagnosis.sort((a, b) => {
                const severityOrder = { 'Ø¹Ø§Ù„ÙŠ': 3, 'Ù…ØªÙˆØ³Ø·': 2, 'Ù…Ù†Ø®ÙØ¶': 1 };
                return severityOrder[b.severity] - severityOrder[a.severity];
            });
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª
            diagnosis.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `diagnosis-card ${item.severity === 'Ø¹Ø§Ù„ÙŠ' ? 'high-severity' : 
                                          item.severity === 'Ù…ØªÙˆØ³Ø·' ? 'medium-severity' : 
                                          'low-severity'}`;
                
                // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©
                const icon = item.severity === 'Ø¹Ø§Ù„ÙŠ' ? 'ğŸš¨' : item.severity === 'Ù…ØªÙˆØ³Ø·' ? 'âš ï¸' : 'â„¹ï¸';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold flex items-center gap-2">
                                <span>${icon}</span>
                                <span>${item.condition}</span>
                            </div>
                            <div class="text-sm mt-1">
                                <span class="font-medium">Ø§Ù„Ø´Ø¯Ø©:</span> 
                                <span class="${item.severity === 'Ø¹Ø§Ù„ÙŠ' ? 'text-red-700' : 
                                        item.severity === 'Ù…ØªÙˆØ³Ø·' ? 'text-yellow-700' : 
                                        'text-blue-700'}">${item.severity}</span>
                            </div>
                            <div class="text-sm mt-1">
                                <span class="font-medium">Ø§Ù„ØªÙˆØµÙŠØ©:</span> ${item.recommendation}
                            </div>
                        </div>
                        <div class="urgency-badge ${
                            item.urgency === 'ÙÙˆØ±ÙŠ' ? 'urgency-immediate' : 
                            item.urgency === 'Ø¹Ø§Ø¬Ù„' ? 'urgency-urgent' : 
                            'urgency-routine'
                        }">
                            ${item.urgency}
                        </div>
                    </div>
                `;
                
                diagnosisContainer.appendChild(div);
            });
        }
        
        function enhancedDisplayTrends(trends) {
            const trendsContainer = document.getElementById('trends-container');
            if (!trends) {
                trendsContainer.innerHTML = '<div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤</div>';
                return;
            }
            
            trendsContainer.innerHTML = `
                <div class="mb-2">
                    <div class="font-bold">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª Ø®Ù„Ø§Ù„ ${trends.timeframe}:</div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="bg-slate-50 p-2 rounded-lg">
                            <div class="text-sm">Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                            <div class="text-lg font-bold">${Math.round(trends.hrPrediction)} bpm</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded-lg">
                            <div class="text-sm">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                            <div class="text-lg font-bold">${Math.round(trends.spo2Prediction)}%</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded-lg">
                            <div class="text-sm">Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                            <div class="text-lg font-bold">${Math.round(trends.sysPrediction)} mmHg</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded-lg">
                            <div class="text-sm">Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                            <div class="text-lg font-bold">${Math.round(trends.diaPrediction)} mmHg</div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="font-bold">Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø·Ø±:</div>
                        <div class="mt-1">
                            ${trends.riskFactors.length > 0 ? 
                                trends.riskFactors.map(factor => `<div class="text-sm text-red-600">â€¢ ${factor}</div>`).join('') : 
                                '<div class="text-sm text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹ÙˆØ§Ù…Ù„ Ø®Ø·Ø± ÙˆØ§Ø¶Ø­Ø©</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="font-bold">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©:</div>
                        <div class="mt-1">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${trends.confidence * 100}%"></div>
                            </div>
                            <div class="text-sm mt-1">${Math.round(trends.confidence * 100)}%</div>
                        </div>
                    </div>
                    
                    ${trends.deteriorationRisk ? '<div class="mt-3 p-2 bg-red-100 text-red-800 rounded-lg font-bold">ØªØ­Ø°ÙŠØ±: Ù‡Ù†Ø§Ùƒ Ø§Ø­ØªÙ…Ø§Ù„ Ù„ØªØ¯Ù‡ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©!</div>' : ''}
                </div>
            `;
        }
        
        function enhancedDisplayMLRecommendations(mlAnalysis) {
            const mlContainer = document.getElementById('ml-container');
            mlContainer.innerHTML = `
                <div class="mb-2">
                    <div class="font-bold">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:</div>
                    <div class="flex items-center gap-2 mt-1">
                        <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©:</div>
                        <div class="px-2 py-1 rounded-full text-xs font-semibold ${
                            mlAnalysis.riskLevel === 'high' ? 'bg-red-100 text-red-800' : 
                            mlAnalysis.riskLevel === 'medium' ? 'bg-yellow-100 text-yellow-800' : 
                            'bg-green-100 text-green-800'
                        }">
                            ${mlAnalysis.riskLevel === 'high' ? 'Ø¹Ø§Ù„ÙŠ' : mlAnalysis.riskLevel === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶'}
                        </div>
                        <div class="text-sm">(${mlAnalysis.riskScore}/100)</div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="font-bold">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:</div>
                        <div class="mt-1 space-y-2">
                            ${mlAnalysis.possibleConditions.map(cond => `
                                <div class="flex justify-between items-center">
                                    <div>${cond.name}</div>
                                    <div class="w-24 bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${cond.probability * 100}%"></div>
                                    </div>
                                    <div class="text-sm w-12 text-left">${Math.round(cond.probability * 100)}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="font-bold">ØªÙˆØµÙŠØ§Øª:</div>
                        <ul class="mt-1 space-y-1">
                            ${mlAnalysis.recommendations.map(rec => `<li class="text-sm">â€¢ ${rec}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="mt-3 text-xs text-gray-500">
                        ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ: ${new Date(mlAnalysis.timestamp).toLocaleTimeString('ar-EG')}
                    </div>
                </div>
            `;
        }
        
        // =============== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ===============
        let deviceConnected = false;
        let currentVitals = null;
        function handleHeartRate(event) {
            const value = event.target.value;
            const heartRate = value.getUint8(1);
            if (!currentVitals) currentVitals = {};
            currentVitals.hr = heartRate;
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                enhancedRender(currentVitals, patientData);
                pushToFirebase(currentVitals);
            }
        }
        function handleBloodPressure(event) {
            const value = event.target.value;
            let offset = 1;
            const sys = value.getUint16(offset, true);
            offset += 2;
            const dia = value.getUint16(offset, true);
            if (!currentVitals) currentVitals = {};
            currentVitals.sys = sys;
            currentVitals.dia = dia;
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                enhancedRender(currentVitals, patientData);
                pushToFirebase(currentVitals);
            }
        }
        async function connectToDevice() {
            try {
                logEvent('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø©...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate', 'blood_pressure'] }],
                    optionalServices: ['battery_service']
                });
                logEvent(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²: ${device.name}`);
                const server = await device.gatt.connect();
                logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
                soundSystem.playSound('connection');
                const heartRateService = await server.getPrimaryService('heart_rate');
                const heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
                await heartRateCharacteristic.startNotifications();
                heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
                try {
                    const bpService = await server.getPrimaryService('blood_pressure');
                    const bpCharacteristic = await bpService.getCharacteristic('blood_pressure_measurement');
                    await bpCharacteristic.startNotifications();
                    bpCharacteristic.addEventListener('characteristicvaluechanged', handleBloodPressure);
                } catch (e) {
                    console.warn('Ø¬Ù‡Ø§Ø² Ø¶ØºØ· Ø§Ù„Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­', e);
                }
                deviceConnected = true;
                document.getElementById('connBadge').textContent = 'Ø¬Ù‡Ø§Ø² Ø¨Ù„ÙˆØªÙˆØ«';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²:', error);
                logEvent('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', 'danger');
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø®Ø·Ø£
                soundSystem.playTone(200, 0.5);
                return false;
            }
        }
        async function connectToSerialDevice() {
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¹Ø¨Ø± Ù…Ù†ÙØ° ØªØ³Ù„Ø³Ù„ÙŠ');
                soundSystem.playSound('connection');
                const reader = port.readable.getReader();
                deviceConnected = true;
                document.getElementById('connBadge').textContent = 'Ø¬Ù‡Ø§Ø² ØªØ³Ù„Ø³Ù„ÙŠ';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
                const readData = async () => {
                    const { value, done } = await reader.read();
                    if (done) {
                        reader.releaseLock();
                        return;
                    }
                    const data = new TextDecoder().decode(value);
                    parseSerialData(data);
                    readData();
                };
                readData();
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ:', error);
                logEvent('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', 'danger');
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø®Ø·Ø£
                soundSystem.playTone(200, 0.5);
                return false;
            }
        }
        function parseSerialData(data) {
            const lines = data.trim().split('\n');
            const lastLine = lines[lines.length - 1];
            const parts = lastLine.split(',');
            const vitals = {};
            parts.forEach(part => {
                const [key, value] = part.split(':');
                if (key && value) {
                    vitals[key.toLowerCase()] = parseFloat(value);
                }
            });
            if (!currentVitals) currentVitals = {};
            Object.assign(currentVitals, vitals);
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                enhancedRender(currentVitals, patientData);
                pushToFirebase(currentVitals);
            }
        }
        function enhancedStartSimulationMode() {
            timer = setInterval(async () => {
                const v = simulateVitals();
                enhancedRender(v, patientData);
                pushToFirebase(v);
            }, 1000);
            if (!window.__ecgAnim) {
                const step = () => { 
                    if (timer) drawECG(history.at(-1)?.hr || 80); 
                    window.__ecgAnim = requestAnimationFrame(step); 
                };
                step();
            }
            document.getElementById('connBadge').textContent = 'Ù…Ø­Ø§ÙƒØ§Ø©';
            document.getElementById('connBadge').className = 'badge badge-warn inline-block mt-1';
        }
        
        // =============== ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===============
        function enhancedRender(vitals, patientData) {
            $('hrVal').textContent = fmt(vitals.hr);
            $('bpVal').textContent = `${fmt(vitals.sys)}/${fmt(vitals.dia)}`;
            $('spo2Val').textContent = fmt(vitals.spo2);
            $('rrVal').textContent = fmt(vitals.rr);
            $('tempVal').textContent = fmt(vitals.temp, 1);
            
            history.push(vitals);
            if (history.length > MAX_HIST) history.shift();
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
            const score = enhancedRiskScoreFrom(vitals, patientData);
            setStatus(score, vitals);
            alertIfNeeded(score, vitals);
            
            const diagnosis = enhancedDiagnoseCondition(vitals, patientData);
            enhancedDisplayDiagnosis(diagnosis);
            
            const trends = enhancedPredictTrends(history, patientData);
            enhancedDisplayTrends(trends);
            
            enhancedAnalyzeWithML(vitals, history, patientData).then(result => {
                enhancedDisplayMLRecommendations(result);
            });
        }
        
        // =============== Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ===============
        function logEvent(txt, level='info') {
            const row = document.createElement('div');
            const t = new Date().toLocaleTimeString();
            row.className = 'flex items-center gap-2';
            const dot = document.createElement('span'); dot.className = 'w-2.5 h-2.5 rounded-full ' + (level==='danger'? 'bg-rose-500' : level==='warn'? 'bg-amber-500':'bg-slate-400');
            const msg = document.createElement('span'); msg.textContent = `[${t}] ${txt}`;
            row.appendChild(dot); row.appendChild(msg);
            $('log').prepend(row);
        }
        function alertIfNeeded(score, v) {
            if (!$('autoAlerts').checked) return;
            if (score < 35) return;
            const title = score >= 70 ? 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹' : 'ØªÙ†Ø¨ÙŠÙ‡';
            const icon = score >= 70 ? 'error' : 'warning';
            const text = `HR:${v.hr} | BP:${v.sys}/${v.dia} | SpOâ‚‚:${v.spo2}%`;
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©
            if (score >= 70) {
                soundSystem.playSound('alertHigh');
                // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ù…ØªÙƒØ±Ø±Ø© Ù„Ù„Ø®Ø·Ø± Ø§Ù„Ø¹Ø§Ù„ÙŠ
                setTimeout(() => soundSystem.playTone(880, 0.3), 500);
                setTimeout(() => soundSystem.playTone(880, 0.3), 1000);
            } else {
                soundSystem.playSound('alertMedium');
                soundSystem.playTone(660, 0.4);
            }
            
            Swal.fire({ title, text, icon, toast: true, position: 'top-end', timer: 3500, showConfirmButton: false });
            logEvent(`${title}: ${text}`, score>=70? 'danger':'warn');
        }
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Firebase ===============
        function pushToFirebase(vitals) {
            if (!fb.enabled) return;
            const now = new Date();
            const vitalSignsRef = fb.db.ref(`/patients/emergency/${patientId}/vitalSigns`);
            const readingsRef = fb.db.ref(`/patients/emergency/${patientId}/readings/${nowIso().replace(/[\.\#\$\[\]]/g, '')}`);
            vitalSignsRef.set(vitals).catch(e => console.error("Firebase update failed", e));
            readingsRef.set({ ...vitals, timestamp: now.toISOString() }).catch(e => console.error("Firebase save failed", e));
        }
        
        // =============== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===============
        $('connectBtn').addEventListener('click', () => {
            if (window.isSecureContext) {
                Swal.fire({
                    title: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
                    text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ø£Ù… Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠØŸ',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ø¨Ù„ÙˆØªÙˆØ«',
                    cancelButtonText: 'Ù…Ù†ÙØ° ØªØ³Ù„Ø³Ù„ÙŠ'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await connectToDevice();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        await connectToSerialDevice();
                    }
                });
            } else {
                Swal.fire('ØºÙŠØ± Ø¢Ù…Ù†', 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ¦Ø© Ø¢Ù…Ù†Ø© (HTTPS). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.', 'error');
                soundSystem.playTone(200, 0.5);
            }
        });
        
        $('startBtn').addEventListener('click', () => {
            if (!timer) {
                logEvent('Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                soundSystem.playSound('connection');
                enhancedStartSimulationMode();
            }
        });
        
        $('stopBtn').addEventListener('click', () => {
            if (timer) {
                clearInterval(timer);
                timer = null;
                logEvent('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
                soundSystem.playSound('statusChange');
                document.getElementById('connBadge').textContent = 'Ù…Ø­Ù„ÙŠ';
                document.getElementById('connBadge').className = 'badge badge-warn inline-block mt-1';
            }
        });
        
        $('snapBtn').addEventListener('click', () => {
            if (history.length > 0) {
                const latest = history[history.length - 1];
                const now = nowIso();
                const snapshotRef = fb.db.ref(`/patients/emergency/${patientId}/snapshots/${now.replace(/[\.\#\$\[\]]/g, '')}`);
                snapshotRef.set({ ...latest, timestamp: now })
                    .then(() => {
                        Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                        soundSystem.playSound('save');
                    })
                    .catch(e => {
                        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + e.message, 'error');
                        soundSystem.playTone(200, 0.5);
                    });
            } else {
                Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§.', 'error');
                soundSystem.playTone(200, 0.5);
            }
        });
        
        $('clearLog').addEventListener('click', () => {
            $('log').innerHTML = '';
            logEvent('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„');
            soundSystem.playSound('statusChange');
        });
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            logEvent('Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
            enhancedStartSimulationMode();
        });
        
    </script>
</body>
</html>
