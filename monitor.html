<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        html, body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
        .card { @apply rounded-2xl shadow-lg p-5 bg-white; }
        .metric { @apply text-3xl font-extrabold tracking-tight; }
        .label { @apply text-sm text-gray-500; }
        .soft { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
        .badge-ok { @apply bg-green-100 text-green-700; }
        .badge-warn { @apply bg-yellow-100 text-yellow-700; }
        .badge-bad { @apply bg-red-100 text-red-700; }
        canvas { image-rendering: pixelated; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen">
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white grid place-items-center soft">ğŸ«€</div>
                <div>
                    <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</h1>
                    <p class="text-xs text-slate-500">Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø­Ø¸ÙŠØ© + ØªÙ†Ø¨ÙŠÙ‡ Ø°ÙƒÙŠ + Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span id="patientIdBadge" class="badge badge-ok">ID: â€”</span>
                <a id="backLink" href="#" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">Ø±Ø¬ÙˆØ¹ Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶</a>
            </div>
        </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <section class="card grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-2">
                <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                <div class="flex items-center gap-2">
                    <div class="text-2xl font-bold text-slate-800">
                        <span id="patientName">â€”</span> 
                        <span class="text-lg font-normal" style="display: none;">(<span id="patientAge">â€”</span> Ø³Ù†Ø©)</span>
                    </div>
                    <span id="genderIcon" class="text-lg">ğŸ‘¤</span>
                    <span id="bloodTypeBadge" class="badge badge-ok">â€”</span>
                </div>
                <div class="text-xs text-slate-500 space-y-1">
                    <div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="patientAddress">â€”</span></div>
                    <div>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="patientDept">â€”</span></div>
                    <div>Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©: <span id="patientDiseases">â€”</span></div>
                    <div>ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„: <span id="callTime">â€”</span></div>
                    <div>Ø¢Ø®Ø± ÙØ­Øµ: <span id="lastCheckup">â€”</span></div>
                    <div id="patientStatus"></div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                    <div id="aiStatusBadge" class="badge badge-ok inline-block mt-1">Ù…Ø³ØªÙ‚Ø±Ø©</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± (0â€“100)</div>
                    <div id="riskScore" class="metric">0</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§ØªØµØ§Ù„</div>
                    <div id="connBadge" class="badge badge-warn inline-block mt-1">Ù…Ø­Ù„ÙŠ</div>
                </div>
            </div>
        </section>
        <section class="grid md:grid-cols-5 gap-4">
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)</div>
                <div id="hrVal" class="metric">â€”</div>
                <div id="hrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø¶ØºØ· (SYS/DIA mmHg)</div>
                <div id="bpVal" class="metric">â€”</div>
                <div id="bpState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† SpOâ‚‚ (%)</div>
                <div id="spo2Val" class="metric">â€”</div>
                <div id="spo2State" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³ (rpm)</div>
                <div id="rrVal" class="metric">â€”</div>
                <div id="rrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</div>
                <div id="tempVal" class="metric">â€”</div>
                <div id="tempState" class="text-xs mt-1"></div>
            </div>
        </section>
        <section class="card">
            <div class="flex items-center justify-between">
                <div class="label">ECG â€“ Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ù„Ø¨ (Ù…Ø­Ø§ÙƒØ§Ø©)</div>
                <div class="text-xs text-slate-400">Ù„ÙŠØ³ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ</div>
            </div>
            <canvas id="ecg" class="w-full h-40 bg-black rounded-xl mt-3"></canvas>
        </section>
        <section id="diagnosis-container" class="card">
            <div class="font-bold mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø°ÙƒÙŠ</div>
            <div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚</div>
        </section>
        <section id="trends-container" class="card">
            <div class="font-bold mb-2">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª</div>
            <div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤</div>
        </section>
        <section id="ml-container" class="card">
            <div class="font-bold mb-2">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
            <div>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
        </section>
        <section class="grid lg:grid-cols-3 gap-4">
            <div class="card space-y-3">
                <div class="font-bold">Ø§Ù„ØªØ­ÙƒÙ…</div>
                <div class="flex flex-wrap gap-2">
                    <button id="connectBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                    <button id="startBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
                    <button id="stopBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Ø¥ÙŠÙ‚Ø§Ù</button>
                    <button id="snapBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù†</button>
                    <label class="inline-flex items-center gap-2 text-sm ml-auto">
                        <input id="autoAlerts" type="checkbox" class="w-4 h-4" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ
                    </label>
                </div>
                <p class="text-xs text-slate-500">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ Ø³ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ/Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø±.</p>
            </div>
            <div class="card lg:col-span-2">
                <div class="font-bold mb-3">Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
                <div class="grid md:grid-cols-5 gap-3 text-sm">
                    <div>
                        <div class="label">HR</div>
                        <div class="flex gap-2"><input id="hrMin" class="w-full border rounded-xl px-3 py-2" value="50"><input id="hrMax" class="w-full border rounded-xl px-3 py-2" value="120"></div>
                    </div>
                    <div>
                        <div class="label">SYS</div>
                        <div class="flex gap-2"><input id="sysMin" class="w-full border rounded-xl px-3 py-2" value="90"><input id="sysMax" class="w-full border rounded-xl px-3 py-2" value="140"></div>
                    </div>
                    <div>
                        <div class="label">DIA</div>
                        <div class="flex gap-2"><input id="diaMin" class="w-full border rounded-xl px-3 py-2" value="55"><input id="diaMax" class="w-full border rounded-xl px-3 py-2" value="90"></div>
                    </div>
                    <div>
                        <div class="label">SpOâ‚‚</div>
                        <div class="flex gap-2"><input id="spo2Min" class="w-full border rounded-xl px-3 py-2" value="92"><input id="spo2Max" class="w-full border rounded-xl px-3 py-2" value="100"></div>
                    </div>
                    <div>
                        <div class="label">RR / Temp</div>
                        <div class="flex gap-2"><input id="rrMin" class="w-full border rounded-xl px-3 py-2" value="10"><input id="rrMax" class="w-full border rounded-xl px-3 py-2" value="24"></div>
                        <div class="flex gap-2 mt-2"><input id="tempMin" class="w-full border rounded-xl px-3 py-2" value="36"><input id="tempMax" class="w-full border rounded-xl px-3 py-2" value="37.8"></div>
                    </div>
                </div>
            </div>
        </section>
        <section class="card">
            <div class="flex items-center justify-between mb-2">
                <div class="font-bold">Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
                <button id="clearLog" class="text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div id="log" class="text-sm space-y-1 max-h-44 overflow-auto"></div>
        </section>
    </main>
    <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-400">
        Ù†Ø³Ø®Ø© Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€“ Ù„Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©. Ù„ÙŠØ³Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.
    </footer>
    <script>
        // =============== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ===============
        const firebaseConfig = {
            apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
            authDomain: "hospital-project-e4b59.firebaseapp.com",
            databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hospital-project-e4b59",
            storageBucket: "hospital-project-e4b59.firebasestorage.app",
            messagingSenderId: "974610606258",
            appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
            measurementId: "G-0GV30LL28T"
        };
        let fb = { enabled: false, app: null, db: null };
        try {
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL) {
                fb.app = firebase.initializeApp(firebaseConfig);
                fb.db = firebase.database();
                fb.enabled = true;
                document.getElementById('connBadge').textContent = 'Firebase';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
            }
        } catch (e) {
            console.warn('Firebase init failed, running local only.', e);
        }
        
        // =============== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===============
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d=0) => Number(n).toFixed(d);
        const nowIso = () => new Date().toISOString();
        function getQueryParam(key) {
            const u = new URL(window.location.href);
            return u.searchParams.get(key);
        }
        
        const patientId = getQueryParam('id') || '-OVjd_eZDCbyD2S14zfc';
        $('patientIdBadge').textContent = 'ID: ' + patientId;
        $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
        
        // =============== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ (Ù…Ø¹Ø¯Ù„) ===============
        async function loadPatientHeader() {
            if (!fb.enabled) return;
            
            console.log("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ø·ÙˆØ§Ø±Ø¦...");
            
            try {
                const snap = await fb.db.ref(`/patients/emergency/${patientId}`).get();
                
                if (!snap.exists()) {
                    console.warn("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦", patientId);
                    const regularSnap = await fb.db.ref(`/patients/${patientId}/basic`).get();
                    if (!regularSnap.exists()) {
                        console.error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø£ÙŠ Ù‚Ø³Ù…", patientId);
                        return;
                    }
                    const basic = regularSnap.val();
                    updatePatientDisplay(basic);
                    return;
                }
                
                const basic = snap.val();
                console.log("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:", basic);
                updatePatientDisplay(basic);
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:", error);
            }
        }
        
        function updatePatientDisplay(basic) {
            $('patientName').textContent = basic.name || 'â€”';
            
            if (basic.age) {
                $('patientAge').textContent = basic.age;
                document.querySelector('.text-2xl.font-bold .text-lg').style.display = 'inline';
            } else {
                document.querySelector('.text-2xl.font-bold .text-lg').style.display = 'none';
            }
            
            $('patientAddress').textContent = basic.address || 'â€”';
            
            $('patientDept').textContent = basic.serviceType || basic.department || 'â€”';
            
            $('patientDiseases').textContent = basic.diseases || 'â€”';
            if (basic.diseases && basic.diseases !== "Ù„Ø§ ÙŠÙˆØ¬Ø¯") {
                $('patientDiseases').innerHTML = `<span class="text-red-600">âš ï¸ ${basic.diseases}</span>`;
            }
            
            if (basic.gender === 'male') {
                $('genderIcon').textContent = 'ğŸ‘¨';
            } else if (basic.gender === 'female') {
                $('genderIcon').textContent = 'ğŸ‘©';
            } else {
                $('genderIcon').textContent = 'ğŸ‘¤';
            }
            
            $('bloodTypeBadge').textContent = basic.bloodType || 'â€”';
            
            if (basic.callTime) {
                const callDate = new Date(basic.callTime);
                $('callTime').textContent = callDate.toLocaleString('ar-EG');
            }
            
            if (basic.lastCheckup) {
                const checkupDate = new Date(basic.lastCheckup);
                $('lastCheckup').textContent = checkupDate.toLocaleDateString('ar-EG');
            }
            
            if (basic.status) {
                if (!$('patientStatus')) {
                    const statusDiv = document.createElement('div');
                    statusDiv.id = 'patientStatus';
                    statusDiv.className = 'text-xs mt-1';
                    document.querySelector('.text-slate-500').appendChild(statusDiv);
                }
                
                let statusClass = '';
                let statusText = basic.status;
                
                switch(basic.status.toLowerCase()) {
                    case 'deteriorating':
                        statusClass = 'text-red-600 font-bold';
                        statusText = 'ÙÙŠ ØªØ¯Ù‡ÙˆØ± âš ï¸';
                        break;
                    case 'stable':
                        statusClass = 'text-green-600';
                        statusText = 'Ù…Ø³ØªÙ‚Ø± âœ…';
                        break;
                    case 'critical':
                        statusClass = 'text-red-800 font-bold';
                        statusText = 'Ø­Ø±Ø¬ ğŸš¨';
                        break;
                    default:
                        statusClass = 'text-yellow-600';
                }
                
                $('patientStatus').innerHTML = `<span class="${statusClass}">Ø§Ù„Ø­Ø§Ù„Ø©: ${statusText}</span>`;
            }
            
            console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­");
        }
        
        loadPatientHeader();
        
        // =============== Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) ===============
        const limits = {
            hr: { min: 50, max: 120 },
            sys: { min: 90, max: 140 },
            dia: { min: 55, max: 90 },
            spo2: { min: 92, max: 100 },
            rr: { min: 10, max: 24 },
            temp: { min: 36.0, max: 37.8 }
        };
        function readLimits() {
            limits.hr.min = +$('hrMin').value; limits.hr.max = +$('hrMax').value;
            limits.sys.min = +$('sysMin').value; limits.sys.max = +$('sysMax').value;
            limits.dia.min = +$('diaMin').value; limits.dia.max = +$('diaMax').value;
            limits.spo2.min = +$('spo2Min').value; limits.spo2.max = +$('spo2Max').value;
            limits.rr.min = +$('rrMin').value; limits.rr.max = +$('rrMax').value;
            limits.temp.min = +$('tempMin').value; limits.temp.max = +$('tempMax').value;
        }
        
        // =============== Ù…Ø­Ø§ÙƒØ§Ø© Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ø­Ø¸ÙŠØ© ===============
        let timer = null;
        let t = 0;
        function randn(mean, sd) {
            let u = 1 - Math.random();
            let v = 1 - Math.random();
            let z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return mean + z * sd;
        }
        function simulateVitals() {
            const hr = Math.max(30, Math.round(randn(82, 6)));
            const sys = Math.round(randn(118, 8));
            const dia = Math.round(randn(76, 6));
            const spo2 = Math.min(100, Math.max(85, Math.round(randn(97, 1.2))));
            const rr = Math.max(6, Math.round(randn(16, 2)));
            const temp = Math.max(34.5, Math.min(40, randn(36.9, 0.2)));
            return { hr, sys, dia, spo2, rr, temp: +temp.toFixed(1) };
        }
        
        // =============== ECG Ø±Ø³Ù… ===============
        const ecgCanvas = $('ecg');
        const ecgCtx = ecgCanvas.getContext('2d');
        function resizeCanvas() {
            ecgCanvas.width = ecgCanvas.clientWidth;
            ecgCanvas.height = ecgCanvas.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        const ecg = { x: 0 };
        function drawECG(hr) {
            const w = ecgCanvas.width, h = ecgCanvas.height;
            const ctx = ecgCtx;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (let gx = 0; gx < w; gx += 20) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
            for (let gy = 0; gy < h; gy += 20) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 2;
            ctx.beginPath();
            let bpm = hr || 80;
            let period = Math.max(0.4, 60 / bpm);
            let samples = w;
            for (let i = 0; i < samples; i++) {
                let x = i;
                let tt = (t + i / 120);
                let phase = (tt % period) / period;
                let y = 0.02 * Math.sin(2 * Math.PI * phase * 5);
                if (phase > 0.1 && phase < 0.14) y += -0.5;
                if (phase >= 0.14 && phase < 0.18) y += 1.4;
                if (phase >= 0.18 && phase < 0.22) y += -0.3;
                if (phase > 0.28 && phase < 0.36) y += 0.25 * Math.sin(Math.PI * (phase - 0.28) / 0.08);
                y += (Math.random() - 0.5) * 0.02;
                let yy = h * (0.5 - y * 0.35);
                if (i === 0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
            }
            ctx.stroke();
            t += 1/60;
        }
        
        // =============== Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¨Ø³Ù‘Ø· (Ù…Ø¤Ø´Ø± Ø®Ø·Ø± + Ø­Ø§Ù„Ø©) ===============
        const history = [];
        const MAX_HIST = 120;
        function riskScoreFrom(v) {
            readLimits();
            const dev = (val, {min, max}) => val < min ? (min - val) / (min || 1) : (val > max ? (val - max) / (max || 1) : 0);
            let s = 0;
            s += 35 * Math.min(2, dev(v.hr, limits.hr));
            s += 18 * Math.min(2, dev(v.sys, limits.sys));
            s += 12 * Math.min(2, dev(v.dia, limits.dia));
            s += 25 * Math.min(2, dev(v.spo2, limits.spo2));
            s += 5 * Math.min(2, dev(v.rr, limits.rr));
            s += 5 * Math.min(2, dev(v.temp, limits.temp));
            const n = history.length;
            if (n >= 6) {
                const trendHr = history.slice(-6).map(x=>x.hr);
                const trendSp = history.slice(-6).map(x=>x.spo2);
                const dHr = trendHr[5]-trendHr[0];
                const dSp = trendSp[0]-trendSp[5];
                if (dHr > 12) s += 10;
                if (dSp > 3) s += 15;
            }
            return Math.max(0, Math.min(100, Math.round(s)));
        }
        function setStatus(score, v) {
            const badge = $('aiStatusBadge');
            let label = 'Ù…Ø³ØªÙ‚Ø±Ø©', cls = 'badge badge-ok';
            if (score >= 70) { label = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹'; cls = 'badge badge-bad'; }
            else if (score >= 35) { label = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·'; cls = 'badge badge-warn'; }
            badge.textContent = label; badge.className = cls + ' inline-block';
            $('riskScore').textContent = String(score);
            const within = (v, lim) => (v >= lim.min && v <= lim.max);
            $('hrState').textContent = within(v.hr, limits.hr) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('bpState').textContent = within(v.sys, limits.sys) && within(v.dia, limits.dia) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('spo2State').textContent = within(v.spo2, limits.spo2) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('rrState').textContent = within(v.rr, limits.rr) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('tempState').textContent = within(v.temp, limits.temp) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
        }
        
        // =============== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ===============
        let deviceConnected = false;
        let currentVitals = null;

        // ØªÙ… ØªØ¨Ø³ÙŠØ· Ø¯Ø§Ù„Ø© connectToDevice Ù„ØªØµØ¨Ø­ Ø£ÙƒØ«Ø± Ø´Ù…ÙˆÙ„ÙŠØ©
        async function connectToDevice() {
            try {
                logEvent('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ø§Ù„Ù…ØªØ§Ø­Ø©...');
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… acceptAllDevices Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙÙ„Ø§ØªØ± Ù…Ø­Ø¯Ø¯Ø©
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    // ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ù‡Ù†Ø§ØŒ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§
                    optionalServices: ['heart_rate', 'blood_pressure', 'battery_service', 'glucose_meter']
                });
                
                logEvent(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²: ${device.name}`);
                const server = await device.gatt.connect();
                logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­ âœ…');
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø§Øª Ù…Ø­Ø¯Ø¯Ø©
                try {
                    const heartRateService = await server.getPrimaryService('heart_rate');
                    const heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
                    await heartRateCharacteristic.startNotifications();
                    heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
                    logEvent('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨.');
                } catch (e) {
                    console.warn('Ø®Ø¯Ù…Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².');
                }

                try {
                    const bpService = await server.getPrimaryService('blood_pressure');
                    const bpCharacteristic = await bpService.getCharacteristic('blood_pressure_measurement');
                    await bpCharacteristic.startNotifications();
                    bpCharacteristic.addEventListener('characteristicvaluechanged', handleBloodPressure);
                    logEvent('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù….');
                } catch (e) {
                    console.warn('Ø®Ø¯Ù…Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².');
                }
                
                deviceConnected = true;
                document.getElementById('connBadge').textContent = 'Ø¬Ù‡Ø§Ø² Ø¨Ù„ÙˆØªÙˆØ«';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²:', error);
                logEvent(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² âŒ: ${error.message}`, 'danger');
                return false;
            }
        }
        
        // ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ù‡Ù†Ø§
        function handleHeartRate(event) {
            const value = event.target.value;
            const heartRate = value.getUint8(1);
            if (!currentVitals) currentVitals = {};
            currentVitals.hr = heartRate;
            render(currentVitals);
            pushToFirebase(currentVitals);
        }
        function handleBloodPressure(event) {
            const value = event.target.value;
            let offset = 1;
            const sys = value.getUint16(offset, true);
            offset += 2;
            const dia = value.getUint16(offset, true);
            if (!currentVitals) currentVitals = {};
            currentVitals.sys = sys;
            currentVitals.dia = dia;
            render(currentVitals);
            pushToFirebase(currentVitals);
        }

        // ØªÙ… Ù†Ù‚Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ (Ù„Ù… ØªØªØºÙŠØ±)
        async function connectToSerialDevice() {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        function parseSerialData(data) {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }

        function startSimulationMode() {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ù„Ù… ØªØªØºÙŠØ±) ===============
        function predictTrends() {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        function calculateTrend(values) {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        function diagnoseCondition(vitals) {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        async function analyzeWithML(vitals) {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶ Ùˆ Firebase (Ù„Ù… ØªØªØºÙŠØ±) ===============
        function render(v) {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        function pushToFirebase(v) {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        function recordSnapshot() {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        function logEvent(message, type = 'info') {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        function updateAlerts(v) {
            // ... Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
        }
        
        // =============== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ===============
        $('connectBtn').addEventListener('click', async () => {
            const success = await connectToDevice();
            if (!success) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„',
                    text: 'Ù‡Ù„ ØªÙˆØ¯ ØªØ¬Ø±Ø¨Ø© ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„ÙƒØŸ',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        startSimulationMode();
                    }
                });
            }
        });
        
        $('startBtn').addEventListener('click', startSimulationMode);
        $('stopBtn').addEventListener('click', () => {
            clearInterval(timer);
            timer = null;
            logEvent('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©.', 'warning');
            document.getElementById('connBadge').textContent = 'Ù…Ø­Ù„ÙŠ';
            document.getElementById('connBadge').className = 'badge badge-warn inline-block mt-1';
        });
        $('snapBtn').addEventListener('click', recordSnapshot);
        $('clearLog').addEventListener('click', () => $('log').innerHTML = '');
        
        // ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        startSimulationMode();

    </script>
</body>
</html>
