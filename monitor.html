<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراقبة المريض - مستشفى الحياة الذكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        .vital-sign-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .vital-sign-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .graph-container {
            height: 200px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">مراقبة حالة المريض</h1>
                <div class="flex items-center gap-4">
                    <button id="disconnectBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-plug-circle-xmark ml-2"></i> قطع الاتصال
                    </button>
                    <button onclick="window.print()" class="bg-blue-800 text-white px-4 py-2 rounded-lg hover:bg-blue-900 transition-colors">
                        <i class="fas fa-print ml-2"></i> طباعة التقرير
                    </button>
                </div>
            </div>
            <div id="patientInfo" class="bg-gray-100 rounded-lg p-4">
                <p class="text-lg font-semibold">اسم المريض: <span id="patientName" class="font-normal">-</span></p>
                <p class="text-lg font-semibold">رقم السرير: <span id="bedNumber" class="font-normal">-</span></p>
                <p class="text-lg font-semibold">ID المريض: <span id="patientIdDisplay" class="font-normal">-</span></p>
            </div>
        </div>

        <div id="vitalSignsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

            <div class="vital-sign-card bg-white rounded-xl p-6 text-center">
                <div class="text-4xl text-red-500 mb-2"><i class="fas fa-heartbeat"></i></div>
                <h3 class="text-xl font-semibold text-gray-700">معدل ضربات القلب</h3>
                <p id="heartRate" class="text-5xl font-extrabold mt-2 text-red-600">--</p>
                <span class="text-gray-500">نبضة / دقيقة</span>
            </div>

            <div class="vital-sign-card bg-white rounded-xl p-6 text-center">
                <div class="text-4xl text-blue-500 mb-2"><i class="fas fa-lungs"></i></div>
                <h3 class="text-xl font-semibold text-gray-700">مستوى الأكسجين</h3>
                <p id="oxygenSaturation" class="text-5xl font-extrabold mt-2 text-blue-600">--</p>
                <span class="text-gray-500">% SPO₂</span>
            </div>

            <div class="vital-sign-card bg-white rounded-xl p-6 text-center">
                <div class="text-4xl text-orange-500 mb-2"><i class="fas fa-thermometer-half"></i></div>
                <h3 class="text-xl font-semibold text-gray-700">درجة الحرارة</h3>
                <p id="temperature" class="text-5xl font-extrabold mt-2 text-orange-600">--</p>
                <span class="text-gray-500">°C</span>
            </div>

            <div class="vital-sign-card bg-white rounded-xl p-6 text-center">
                <div class="text-4xl text-green-500 mb-2"><i class="fas fa-tint"></i></div>
                <h3 class="text-xl font-semibold text-gray-700">ضغط الدم</h3>
                <p id="bloodPressure" class="text-4xl font-extrabold mt-2 text-green-600">--</p>
                <span class="text-gray-500">mmHg</span>
            </div>

        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">الرسوم البيانية</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">معدل ضربات القلب (نبضة / دقيقة)</h3>
                    <div class="graph-container">
                        <canvas id="heartRateChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">مستوى الأكسجين (SPO₂)</h3>
                    <div class="graph-container">
                        <canvas id="oxygenChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">درجة الحرارة (°C)</h3>
                    <div class="graph-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">التحكم</h2>
                <div class="flex flex-col space-y-4">
                    <button id="bluetoothBtn" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-bluetooth-b ml-2"></i> اتصال عبر البلوتوث
                    </button>
                    <button id="serialBtn" class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-server ml-2"></i> اتصال عبر المنفذ التسلسلي
                    </button>
                    <button id="toggleSimulationBtn" class="bg-teal-600 text-white px-4 py-3 rounded-lg hover:bg-teal-700 transition-colors">
                        <i class="fas fa-play ml-2"></i> تفعيل وضع المحاكاة
                    </button>
                    <button id="testAlarmBtn" class="bg-amber-500 text-white px-4 py-3 rounded-lg hover:bg-amber-600 transition-colors">
                        <i class="fas fa-bell ml-2"></i> اختبار التنبيه
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">التنبيهات</h2>
                <div id="alarmsContainer" class="space-y-3">
                    <div id="warning-low-temp" class="bg-yellow-100 text-yellow-800 p-3 rounded-lg hidden">
                        <i class="fas fa-triangle-exclamation ml-2"></i> انخفاض درجة الحرارة عن المعدل الطبيعي.
                    </div>
                    <div id="warning-high-temp" class="bg-red-100 text-red-800 p-3 rounded-lg hidden">
                        <i class="fas fa-triangle-exclamation ml-2"></i> ارتفاع درجة الحرارة عن المعدل الطبيعي!
                    </div>
                    <div id="warning-low-oxygen" class="bg-red-100 text-red-800 p-3 rounded-lg hidden">
                        <i class="fas fa-triangle-exclamation ml-2"></i> انخفاض مستوى الأكسجين بشكل حرج!
                    </div>
                    <div id="warning-high-heart" class="bg-red-100 text-red-800 p-3 rounded-lg hidden">
                        <i class="fas fa-triangle-exclamation ml-2"></i> ارتفاع معدل ضربات القلب بشكل حرج!
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, off, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
            authDomain: "hospital-project-e4b59.firebaseapp.com",
            databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hospital-project-e4b59",
            storageBucket: "hospital-project-e4b59.firebasestorage.app",
            messagingSenderId: "974610606258",
            appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
            measurementId: "G-0GV30LL28T"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const patientId = new URLSearchParams(window.location.search).get('id') || '-OVjd_eZDCbyD2S14zfc';

        const patientRef = ref(db, `patients/emergency/${patientId}`);
        const vitalSignsRef = ref(db, `patients/emergency/${patientId}/vitalSigns`);
        let simulationInterval;
        let isSimulationActive = false;
        let isConnected = false;

        // VITAL SIGNS DATA
        const vitalSigns = {
            heartRate: [],
            oxygenSaturation: [],
            temperature: [],
            bloodPressure: [],
            labels: []
        };
        
        // UTILITY FUNCTIONS
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // CHARTS SETUP
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 0
            },
            scales: {
                y: { beginAtZero: false }
            }
        };

        const heartRateChart = new Chart(document.getElementById('heartRateChart').getContext('2d'), {
            type: 'line',
            data: { labels: vitalSigns.labels, datasets: [{ label: 'النبض', data: vitalSigns.heartRate, borderColor: 'red', tension: 0.4, fill: false }] },
            options: chartOptions
        });

        const oxygenChart = new Chart(document.getElementById('oxygenChart').getContext('2d'), {
            type: 'line',
            data: { labels: vitalSigns.labels, datasets: [{ label: 'الأكسجين', data: vitalSigns.oxygenSaturation, borderColor: 'blue', tension: 0.4, fill: false }] },
            options: chartOptions
        });

        const temperatureChart = new Chart(document.getElementById('temperatureChart').getContext('2d'), {
            type: 'line',
            data: { labels: vitalSigns.labels, datasets: [{ label: 'الحرارة', data: vitalSigns.temperature, borderColor: 'orange', tension: 0.4, fill: false }] },
            options: chartOptions
        });

        // DATA UPDATE & ALARMS
        function updateVitalSigns(data) {
            document.getElementById('heartRate').textContent = data.heartRate || '--';
            document.getElementById('oxygenSaturation').textContent = data.oxygenSaturation || '--';
            document.getElementById('temperature').textContent = data.temperature ? data.temperature.toFixed(1) : '--';
            document.getElementById('bloodPressure').textContent = data.bloodPressure || '--';

            const now = new Date();
            const timeLabel = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            
            if (vitalSigns.labels.length >= 10) {
                vitalSigns.labels.shift();
                vitalSigns.heartRate.shift();
                vitalSigns.oxygenSaturation.shift();
                vitalSigns.temperature.shift();
            }

            vitalSigns.labels.push(timeLabel);
            vitalSigns.heartRate.push(data.heartRate);
            vitalSigns.oxygenSaturation.push(data.oxygenSaturation);
            vitalSigns.temperature.push(data.temperature);
            
            heartRateChart.update();
            oxygenChart.update();
            temperatureChart.update();

            checkAlarms(data);
        }

        function checkAlarms(data) {
            const temp = data.temperature;
            const oxygen = data.oxygenSaturation;
            const heart = data.heartRate;

            document.getElementById('warning-low-temp').classList.toggle('hidden', !(temp < 36 && temp !== null));
            document.getElementById('warning-high-temp').classList.toggle('hidden', !(temp > 38 && temp !== null));
            document.getElementById('warning-low-oxygen').classList.toggle('hidden', !(oxygen < 92 && oxygen !== null));
            document.getElementById('warning-high-heart').classList.toggle('hidden', !(heart > 120 && heart !== null));

            if (temp > 38 || oxygen < 92 || heart > 120) {
                // Play alarm sound
                // new Audio('path_to_alarm_sound.mp3').play();
            }
        }
        
        // FIREBASE CONNECTION
        function startFirebaseConnection() {
            onValue(ref(db, `patients/emergency/${patientId}`), (snapshot) => {
                const patientData = snapshot.val();
                if (patientData) {
                    document.getElementById('patientName').textContent = patientData.name;
                    document.getElementById('bedNumber').textContent = patientData.bedNumber || 'غير محدد';
                    document.getElementById('patientIdDisplay').textContent = patientId;
                } else {
                    document.getElementById('patientName').textContent = 'غير معروف';
                    document.getElementById('bedNumber').textContent = '-';
                }
            });

            onValue(vitalSignsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateVitalSigns(data);
                    isConnected = true;
                    showResult('تم الاتصال', 'يتم استقبال البيانات من الجهاز', 'success');
                } else {
                    isConnected = false;
                    Swal.fire({
                        title: 'انتظار البيانات',
                        text: 'جارٍ انتظار اتصال الجهاز وإرسال البيانات...',
                        icon: 'info',
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });
                }
            }, (error) => {
                console.error("Firebase Read Error:", error);
                isConnected = false;
                Swal.fire('خطأ', 'فشل الاتصال بقاعدة البيانات: ' + error.message, 'error');
            });
        }

        function stopFirebaseConnection() {
            off(vitalSignsRef);
            isConnected = false;
            Swal.fire('تم قطع الاتصال', 'تم إيقاف استقبال البيانات من قاعدة البيانات.', 'info');
        }

        // SIMULATION MODE
        function startSimulationMode() {
            stopFirebaseConnection();
            isSimulationActive = true;
            document.getElementById('toggleSimulationBtn').textContent = 'إيقاف المحاكاة';
            Swal.fire('وضع المحاكاة', 'يتم توليد بيانات عشوائية للمراقبة', 'info');

            simulationInterval = setInterval(() => {
                const data = {
                    heartRate: Math.floor(Math.random() * (110 - 60 + 1)) + 60,
                    oxygenSaturation: Math.floor(Math.random() * (100 - 90 + 1)) + 90,
                    temperature: (Math.random() * (38.5 - 36.5) + 36.5).toFixed(1),
                    bloodPressure: `${Math.floor(Math.random() * (140 - 110 + 1)) + 110}/${Math.floor(Math.random() * (90 - 70 + 1)) + 70}`
                };
                updateVitalSigns(data);
            }, 1000); // تحديث كل 1 ثانية
        }

        function stopSimulationMode() {
            clearInterval(simulationInterval);
            isSimulationActive = false;
            document.getElementById('toggleSimulationBtn').textContent = 'تفعيل وضع المحاكاة';
            showResult('تم الإيقاف', 'تم إيقاف وضع المحاكاة', 'info');
        }

        // DEVICE CONNECTION (Serial & Bluetooth)
        async function connectSerial() {
            if (!("serial" in navigator)) {
                Swal.fire('غير مدعوم', 'متصفحك لا يدعم Web Serial API. يرجى استخدام متصفح Google Chrome.', 'error');
                return;
            }
            // Code to connect and read from a serial port would go here
        }

        async function connectBluetooth() {
            if (!("bluetooth" in navigator)) {
                Swal.fire('غير مدعوم', 'متصفحك لا يدعم Web Bluetooth API. يرجى استخدام متصفح Google Chrome.', 'error');
                return;
            }
            // Code to connect and read from a Bluetooth device would go here
        }

        // EVENT LISTENERS
        document.getElementById('disconnectBtn').addEventListener('click', stopFirebaseConnection);
        document.getElementById('bluetoothBtn').addEventListener('click', connectBluetooth);
        document.getElementById('serialBtn').addEventListener('click', connectSerial);
        document.getElementById('toggleSimulationBtn').addEventListener('click', () => {
            if (isSimulationActive) {
                stopSimulationMode();
                startFirebaseConnection();
            } else {
                stopFirebaseConnection();
                startSimulationMode();
            }
        });
        document.getElementById('testAlarmBtn').addEventListener('click', () => {
            new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3').play();
            Swal.fire('اختبار التنبيه', 'تم تشغيل صوت تنبيه', 'info');
        });
        
        // Initial setup
        const patientIdFromUrl = getQueryParam('id');
        if (patientIdFromUrl) {
            document.getElementById('patientIdDisplay').textContent = patientIdFromUrl;
        }

        startFirebaseConnection();

        // Utility for SweetAlert
        function showResult(title, message, icon) {
            Swal.fire({
                title,
                text: message,
                icon,
                timer: 2000,
                showConfirmButton: false
            });
        }
    </script>
</body>
</html>
