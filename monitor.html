<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        html, body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
        .card { @apply rounded-2xl shadow-lg p-5 bg-white; }
        .metric { @apply text-3xl font-extrabold tracking-tight; }
        .label { @apply text-sm text-gray-500; }
        .soft { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
        .badge-ok { @apply bg-green-100 text-green-700; }
        .badge-warn { @apply bg-yellow-100 text-yellow-700; }
        .badge-bad { @apply bg-red-100 text-red-700; }
        .badge-critical { @apply bg-red-800 text-white; }
        canvas { image-rendering: pixelated; }
        
        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(to bottom, #1a202c, #2d3748);
            color: #e2e8f0;
        }
        .dark-mode .card {
            background: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode header {
            background: rgba(26, 32, 44, 0.9);
        }
        .dark-mode .bg-slate-50 {
            background-color: #2d3748;
        }
        .dark-mode .text-slate-500 {
            color: #a0aec0;
        }
        .dark-mode .text-slate-800 {
            color: #e2e8f0;
        }
        .dark-mode .border-slate-200 {
            border-color: #4a5568;
        }
        .dark-mode .bg-white {
            background-color: #2d3748;
        }
        .dark-mode .bg-slate-900 {
            background-color: #1a202c;
        }
        
        /* Animations */
        .value-change {
            animation: valueChange 0.5s ease-in-out;
        }
        @keyframes valueChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #3b82f6; }
            100% { transform: scale(1); }
        }
        
        .notification-item {
            animation: slideIn 0.3s ease-out;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-item.info {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        .notification-item.warning {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .notification-item.critical {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .notification-title {
            font-weight: bold;
        }
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
        .notification-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 12px;
        }
        .notification-acknowledge {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .metric { font-size: 1.5rem; }
            .card { padding: 1rem; }
            .grid { gap: 1rem; }
        }
        
        /* Medical Score Styles */
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .score-value {
            font-size: 3rem;
            font-weight: 800;
            margin: 10px 0;
        }
        
        .score-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .ecg-lead {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            height: 80px;
            position: relative;
        }
        
        .ecg-lead-label {
            position: absolute;
            top: 5px;
            left: 10px;
            color: #22c55e;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .protocol-card {
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .protocol-card.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .protocol-card.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .drug-interaction {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .fhir-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen">
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white grid place-items-center soft">ğŸ¥</div>
                <div>
                    <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</h1>
                    <p class="text-xs text-slate-500">Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± WHO | AHA | Joint Commission</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span id="patientIdBadge" class="badge badge-ok">ID: â€”</span>
                <button id="themeToggle" class="p-2 rounded-lg bg-slate-200 dark:bg-slate-700">
                    <span id="themeIcon">ğŸŒ™</span>
                </button>
                <a id="backLink" href="#" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">Ø±Ø¬ÙˆØ¹ Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶</a>
            </div>
        </div>
    </header>

    <div id="notification-container" class="fixed top-20 left-4 z-50 max-w-sm"></div>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <!-- Patient Info Section -->
        <section class="card grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-2">
                <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                <div class="flex items-center gap-2">
                    <div class="text-2xl font-bold text-slate-800">
                        <span id="patientName">â€”</span> 
                        <span class="text-lg font-normal" style="display: none;">(<span id="patientAge">â€”</span> Ø³Ù†Ø©)</span>
                    </div>
                    <span id="genderIcon" class="text-lg">ğŸ‘¤</span>
                    <span id="bloodTypeBadge" class="badge badge-ok">â€”</span>
                </div>
                <div class="text-xs text-slate-500 space-y-1">
                    <div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="patientAddress">â€”</span></div>
                    <div>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="patientDept">â€”</span></div>
                    <div>Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©: <span id="patientDiseases">â€”</span></div>
                    <div>ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„: <span id="callTime">â€”</span></div>
                    <div>Ø¢Ø®Ø± ÙØ­Øµ: <span id="lastCheckup">â€”</span></div>
                    <div id="patientStatus"></div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                    <div id="aiStatusBadge" class="badge badge-ok inline-block mt-1">Ù…Ø³ØªÙ‚Ø±Ø©</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± (0â€“100)</div>
                    <div id="riskScore" class="metric">0</div>
                </div>
                <div class="text-center bg-slate-50 rounded-xl p-3">
                    <div class="label">Ø§ØªØµØ§Ù„</div>
                    <div id="connBadge" class="badge badge-warn inline-block mt-1">Ù…Ø­Ù„ÙŠ</div>
                </div>
            </div>
        </section>

        <!-- Medical Scores Section -->
        <section class="grid md:grid-cols-3 gap-4">
            <div class="score-card">
                <div class="score-label">NEWS2 Score</div>
                <div id="news2Score" class="score-value">0</div>
                <div id="news2Level" class="text-sm">Ù…Ù†Ø®ÙØ¶ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</div>
            </div>
            <div class="score-card">
                <div class="score-label">MEWS Score</div>
                <div id="mewsScore" class="score-value">0</div>
                <div id="mewsLevel" class="text-sm">Ù…Ø³ØªÙ‚Ø±</div>
            </div>
            <div class="score-card">
                <div class="score-label">SOFA Score</div>
                <div id="sofaScore" class="score-value">0</div>
                <div id="sofaLevel" class="text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ´Ù„ Ø£Ø¹Ø¶Ø§Ø¡</div>
            </div>
        </section>

        <!-- Vital Signs Section -->
        <section class="grid md:grid-cols-5 gap-4">
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)</div>
                <div id="hrVal" class="metric">â€”</div>
                <div id="hrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø¶ØºØ· (SYS/DIA mmHg)</div>
                <div id="bpVal" class="metric">â€”</div>
                <div id="bpState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† SpOâ‚‚ (%)</div>
                <div id="spo2Val" class="metric">â€”</div>
                <div id="spo2State" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³ (rpm)</div>
                <div id="rrVal" class="metric">â€”</div>
                <div id="rrState" class="text-xs mt-1"></div>
            </div>
            <div class="card">
                <div class="label">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</div>
                <div id="tempVal" class="metric">â€”</div>
                <div id="tempState" class="text-xs mt-1"></div>
            </div>
        </section>

        <!-- Advanced Monitoring Section -->
        <section class="grid md:grid-cols-2 gap-4">
            <div class="card">
                <div class="flex items-center justify-between">
                    <div class="label">ECG â€“ 12 Lead <span class="fhir-badge">FHIR</span></div>
                    <div class="text-xs text-slate-400">ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ</div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">I</div>
                        <canvas id="ecgI" class="w-full h-full"></canvas>
                    </div>
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">II</div>
                        <canvas id="ecgII" class="w-full h-full"></canvas>
                    </div>
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">III</div>
                        <canvas id="ecgIII" class="w-full h-full"></canvas>
                    </div>
                    <div class="ecg-lead">
                        <div class="ecg-lead-label">aVR</div>
                        <canvas id="ecgAVR" class="w-full h-full"></canvas>
                    </div>
                </div>
                <div id="ecgAnalysis" class="mt-3 p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold">ØªØ­Ù„ÙŠÙ„ ECG:</div>
                    <div class="text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
                </div>
            </div>
            
            <div class="card">
                <div class="flex items-center justify-between">
                    <div class="label">Ø§Ù„ØºØ§Ø²Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ§Ù†ÙŠØ© (ABG) <span class="fhir-badge">FHIR</span></div>
                    <div class="text-xs text-slate-400">ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù…</div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-3">
                    <div>
                        <div class="text-xs text-slate-500">pH</div>
                        <div id="phVal" class="text-xl font-bold">â€”</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">PaCOâ‚‚ (mmHg)</div>
                        <div id="paco2Val" class="text-xl font-bold">â€”</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">PaOâ‚‚ (mmHg)</div>
                        <div id="pao2Val" class="text-xl font-bold">â€”</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">HCOâ‚ƒ (mmol/L)</div>
                        <div id="hco3Val" class="text-xl font-bold">â€”</div>
                    </div>
                </div>
                <div id="abgAnalysis" class="mt-3 p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold">ØªØ­Ù„ÙŠÙ„ ABG:</div>
                    <div class="text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <!-- Sepsis Protocol Section -->
        <section id="sepsis-container" class="card">
            <div class="flex items-center justify-between">
                <div class="font-bold">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø¥Ù†ØªØ§Ù† (SEP-1) <span class="fhir-badge">FHIR</span></div>
                <div id="sepsisStatus" class="badge badge-ok">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡</div>
            </div>
            <div id="sepsisCriteria" class="mt-3 grid md:grid-cols-3 gap-3">
                <div class="p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold text-sm">Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</div>
                    <div class="text-xs mt-1">
                        <div>â€¢ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© > 38Â°C Ø£Ùˆ < 36Â°C</div>
                        <div>â€¢ Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ > 90</div>
                        <div>â€¢ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³ > 20</div>
                        <div>â€¢ WBC > 12K Ø£Ùˆ < 4K</div>
                    </div>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold text-sm">Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</div>
                    <div class="text-xs mt-1">
                        <div>â€¢ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ < 90</div>
                        <div>â€¢ Ù„Ø§ÙƒØªØ§Øª > 2 mmol/L</div>
                    </div>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg">
                    <div class="font-bold text-sm">ÙØ´Ù„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
                    <div class="text-xs mt-1">
                        <div>â€¢ Cr > 2.0 mg/dL</div>
                        <div>â€¢ Ø§Ù„Ø¨ÙŠÙ„ÙŠØ±ÙˆØ¨ÙŠÙ† > 2 mg/dL</div>
                        <div>â€¢ PLT < 100K</div>
                    </div>
                </div>
            </div>
            <div id="sepsisActions" class="mt-3 p-3 bg-yellow-50 rounded-lg">
                <div class="font-bold text-sm">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</div>
                <div class="text-xs mt-1">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª...</div>
            </div>
        </section>

        <!-- Drug Interaction Section -->
        <section id="drug-interaction-container" class="card">
            <div class="flex items-center justify-between">
                <div class="font-bold">ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ© <span class="fhir-badge">FHIR</span></div>
                <button id="addDrugBtn" class="text-sm px-3 py-1 bg-blue-600 text-white rounded-lg">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡</button>
            </div>
            <div id="drugList" class="mt-3 space-y-2">
                <div class="text-sm text-slate-500">Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¹Ø¯</div>
            </div>
            <div id="drugInteractions" class="mt-3">
                <!-- Drug interactions will appear here -->
            </div>
        </section>

        <!-- Early Warning System -->
        <section id="early-warning-container" class="card">
            <div class="font-bold mb-3">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ±</h3>
                    <div id="rateOfChange" class="space-y-2">
                        <div class="flex justify-between">
                            <span>HR:</span>
                            <span id="hrChange">â€”</span>
                        </div>
                        <div class="flex justify-between">
                            <span>SpOâ‚‚:</span>
                            <span id="spo2Change">â€”</span>
                        </div>
                        <div class="flex justify-between">
                            <span>BP:</span>
                            <span id="bpChange">â€”</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„ØªØ¯Ù‡ÙˆØ±</h3>
                    <div id="deteriorationPrediction" class="p-3 bg-slate-50 rounded-lg">
                        <div class="text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Diagnostics Section -->
        <section id="diagnosis-container" class="card">
            <div class="font-bold mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø°ÙƒÙŠ</div>
            <div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚</div>
        </section>

        <!-- Trends and Predictions -->
        <section id="trends-container" class="card">
            <div class="font-bold mb-2">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª</div>
            <div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤</div>
        </section>

        <!-- ML Recommendations -->
        <section id="ml-container" class="card">
            <div class="font-bold mb-2">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
            <div>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
        </section>

        <!-- Medical Patterns -->
        <section id="patterns-container" class="card">
            <div class="font-bold mb-2">Ø£Ù†Ù…Ø§Ø· Ø·Ø¨ÙŠØ© Ù…ÙƒØªØ´ÙØ©</div>
            <div class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ù…Ø§Ø· Ù…ÙƒØªØ´ÙØ©</div>
        </section>

        <!-- Changes Tracking -->
        <section id="changes-container" class="card">
            <div class="font-bold mb-2">ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù‡Ù…Ø©</div>
            <div class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù‡Ù…Ø©</div>
        </section>

        <!-- Trend Patterns -->
        <section id="trend-patterns-container" class="card">
            <div class="font-bold mb-2">Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø§ØªØ¬Ø§Ù‡</div>
            <div class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ù…Ø§Ø· Ø§ØªØ¬Ø§Ù‡</div>
        </section>

        <!-- Control Section -->
        <section class="grid lg:grid-cols-3 gap-4">
            <div class="card space-y-3">
                <div class="font-bold">Ø§Ù„ØªØ­ÙƒÙ…</div>
                <div class="flex flex-wrap gap-2">
                    <button id="connectBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                    <button id="startBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
                    <button id="stopBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Ø¥ÙŠÙ‚Ø§Ù</button>
                    <button id="snapBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù†</button>
                    <button id="reportBtn" class="px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±</button>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span>Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©:</span>
                    <span id="batteryBadge" class="badge badge-ok">â€”</span>
                    <span id="batteryLevel">â€”</span>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                    <input id="autoAlerts" type="checkbox" class="w-4 h-4" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ
                </label>
                <label class="inline-flex items-center gap-2 text-sm">
                    <input id="autoReconnect" type="checkbox" class="w-4 h-4" checked> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                </label>
                <p class="text-xs text-slate-500">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ Ø³ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ/Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø±.</p>
            </div>
            <div class="card lg:col-span-2">
                <div class="font-bold mb-3">Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
                <div class="grid md:grid-cols-5 gap-3 text-sm">
                    <div>
                        <div class="label">HR</div>
                        <div class="flex gap-2"><input id="hrMin" class="w-full border rounded-xl px-3 py-2" value="50"><input id="hrMax" class="w-full border rounded-xl px-3 py-2" value="120"></div>
                    </div>
                    <div>
                        <div class="label">SYS</div>
                        <div class="flex gap-2"><input id="sysMin" class="w-full border rounded-xl px-3 py-2" value="90"><input id="sysMax" class="w-full border rounded-xl px-3 py-2" value="140"></div>
                    </div>
                    <div>
                        <div class="label">DIA</div>
                        <div class="flex gap-2"><input id="diaMin" class="w-full border rounded-xl px-3 py-2" value="55"><input id="diaMax" class="w-full border rounded-xl px-3 py-2" value="90"></div>
                    </div>
                    <div>
                        <div class="label">SpOâ‚‚</div>
                        <div class="flex gap-2"><input id="spo2Min" class="w-full border rounded-xl px-3 py-2" value="92"><input id="spo2Max" class="w-full border rounded-xl px-3 py-2" value="100"></div>
                    </div>
                    <div>
                        <div class="label">RR / Temp</div>
                        <div class="flex gap-2"><input id="rrMin" class="w-full border rounded-xl px-3 py-2" value="10"><input id="rrMax" class="w-full border rounded-xl px-3 py-2" value="24"></div>
                        <div class="flex gap-2 mt-2"><input id="tempMin" class="w-full border rounded-xl px-3 py-2" value="36"><input id="tempMax" class="w-full border rounded-xl px-3 py-2" value="37.8"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Alert Log -->
        <section class="card">
            <div class="flex items-center justify-between mb-2">
                <div class="font-bold">Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
                <button id="clearLog" class="text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div id="log" class="text-sm space-y-1 max-h-44 overflow-auto"></div>
        </section>

        <!-- Visualization Section -->
        <section id="visualization-container" class="card space-y-6">
            <div class="font-bold">Ø§Ù„ØªØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            
            <div>
                <h3 class="font-semibold mb-2">Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª</h3>
                <div class="h-64">
                    <canvas id="vitalSignsChart"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</h3>
                    <div class="h-48">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</h3>
                    <div class="h-48">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="correlationMatrix" class="card">
                <div class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª...</div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="visualizationSystem.exportChart('vitalSignsChart')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</button>
                <button onclick="visualizationSystem.createCorrelationMatrix()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª</button>
            </div>
        </section>

        <!-- Export/Import Section -->
        <section id="export-import-container" class="card">
            <div class="font-bold mb-3">ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª <span class="fhir-badge">FHIR</span></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <div class="font-semibold mb-2">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    <div class="space-y-2">
                        <select id="exportFormat" class="w-full border rounded-lg p-2">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="pdf">PDF</option>
                            <option value="xml">XML</option>
                            <option value="fhir">FHIR STU3</option>
                        </select>
                        <div class="flex gap-2">
                            <input type="date" id="exportStartDate" class="flex-1 border rounded-lg p-2">
                            <input type="date" id="exportEndDate" class="flex-1 border rounded-lg p-2">
                        </div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeCharts" checked>
                            <span>ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeAnalysis" checked>
                            <span>ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</span>
                        </label>
                        <button id="exportBtn" class="w-full bg-blue-600 text-white rounded-lg p-2 hover:bg-blue-700">ØªØµØ¯ÙŠØ±</button>
                    </div>
                </div>
                <div>
                    <div class="font-semibold mb-2">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    <div class="space-y-2">
                        <select id="importFormat" class="w-full border rounded-lg p-2">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="fhir">FHIR STU3</option>
                        </select>
                        <input type="file" id="importFile" accept=".json,.csv,.xml" class="w-full border rounded-lg p-2">
                        <button id="importBtn" class="w-full bg-green-600 text-white rounded-lg p-2 hover:bg-green-700">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Compliance Reports -->
        <section id="compliance-container" class="card">
            <div class="font-bold mb-3">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ø¨ÙŠ</div>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <div class="font-bold">Joint Commission</div>
                    <div class="text-sm mt-2">
                        <div>â€¢ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙˆÙÙŠØ§Øª: <span id="mortalityRate">â€”</span></div>
                        <div>â€¢ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø¯ÙˆÙ‰: <span id="infectionRate">â€”</span></div>
                        <div>â€¢ Ù…Ø¯Ø© Ø§Ù„Ø¨Ù‚Ø§Ø¡: <span id="lengthOfStay">â€”</span></div>
                    </div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <div class="font-bold">HIPAA Compliance</div>
                    <div class="text-sm mt-2">
                        <div>â€¢ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: <span class="text-green-600">âœ…</span></div>
                        <div>â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª: <span class="text-green-600">âœ…</span></div>
                        <div>â€¢ Ø³Ø¬Ù„ Ø§Ù„ÙˆØµÙˆÙ„: <span class="text-green-600">âœ…</span></div>
                    </div>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <div class="font-bold">WHO Standards</div>
                    <div class="text-sm mt-2">
                        <div>â€¢ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦: <span class="text-green-600">âœ…</span></div>
                        <div>â€¢ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©: <span class="text-green-600">âœ…</span></div>
                        <div>â€¢ Ø§Ù„ØªØ¯Ø±ÙŠØ¨: <span class="text-green-600">âœ…</span></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-400">
        Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± WHO | AHA | Joint Commission | HIPAA | FHIR STU3
    </footer>

    <script>
        // =============== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ===============
        const firebaseConfig = {
            apiKey: "AIzaSyB4glqZb0hz1uvERtq0pSZZzeBy3_grAnQ",
            authDomain: "smart-life-hospital-ef64c.firebaseapp.com",
            databaseURL: "https://smart-life-hospital-ef64c-default-rtdb.firebaseio.com",
            projectId: "smart-life-hospital-ef64c",
            storageBucket: "smart-life-hospital-ef64c.firebasestorage.app",
            messagingSenderId: "851045891087",
            appId: "1:851045891087:web:8e0f6e42f8c7fed17bf77a",
            measurementId: "G-QE5BL3MTY7"
        };
        
        let fb = { enabled: false, app: null, db: null };
        try {
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL) {
                fb.app = firebase.initializeApp(firebaseConfig);
                fb.db = firebase.database();
                fb.enabled = true;
                document.getElementById('connBadge').textContent = 'Firebase';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
            }
        } catch (e) {
            console.warn('Firebase init failed, running local only.', e);
        }
        
        // =============== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===============
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d=0) => Number(n).toFixed(d);
        const nowIso = () => new Date().toISOString();
        function getQueryParam(key) {
            const u = new URL(window.location.href);
            return u.searchParams.get(key);
        }
        
        const patientId = getQueryParam('id') || '-OVjd_eZDCbyD2S14zfc';
        $('patientIdBadge').textContent = 'ID: ' + patientId;
        $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
        
        // =============== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ===============
        async function loadPatientHeader() {
            if (!fb.enabled) return;
            
            try {
                const snap = await fb.db.ref(`/patients/emergency/${patientId}`).get();
                
                if (!snap.exists()) {
                    const regularSnap = await fb.db.ref(`/patients/${patientId}/basic`).get();
                    if (!regularSnap.exists()) return;
                    const basic = regularSnap.val();
                    updatePatientDisplay(basic);
                    return;
                }
                
                const basic = snap.val();
                updatePatientDisplay(basic);
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:", error);
            }
        }
        
        function updatePatientDisplay(basic) {
            $('patientName').textContent = basic.name || 'â€”';
            
            if (basic.age) {
                $('patientAge').textContent = basic.age;
                document.querySelector('.text-2xl.font-bold .text-lg').style.display = 'inline';
            } else {
                document.querySelector('.text-2xl.font-bold .text-lg').style.display = 'none';
            }
            
            $('patientAddress').textContent = basic.address || 'â€”';
            $('patientDept').textContent = basic.serviceType || basic.department || 'â€”';
            $('patientDiseases').textContent = basic.diseases || 'â€”';
            if (basic.diseases && basic.diseases !== "Ù„Ø§ ÙŠÙˆØ¬Ø¯") {
                $('patientDiseases').innerHTML = `<span class="text-red-600">âš ï¸ ${basic.diseases}</span>`;
            }
            
            if (basic.gender === 'male') {
                $('genderIcon').textContent = 'ğŸ‘¨';
            } else if (basic.gender === 'female') {
                $('genderIcon').textContent = 'ğŸ‘©';
            } else {
                $('genderIcon').textContent = 'ğŸ‘¤';
            }
            
            $('bloodTypeBadge').textContent = basic.bloodType || 'â€”';
            
            if (basic.callTime) {
                const callDate = new Date(basic.callTime);
                $('callTime').textContent = callDate.toLocaleString('ar-EG');
            }
            
            if (basic.lastCheckup) {
                const checkupDate = new Date(basic.lastCheckup);
                $('lastCheckup').textContent = checkupDate.toLocaleDateString('ar-EG');
            }
            
            if (basic.status) {
                if (!$('patientStatus')) {
                    const statusDiv = document.createElement('div');
                    statusDiv.id = 'patientStatus';
                    statusDiv.className = 'text-xs mt-1';
                    document.querySelector('.text-slate-500').appendChild(statusDiv);
                }
                
                let statusClass = '';
                let statusText = basic.status;
                
                switch(basic.status.toLowerCase()) {
                    case 'deteriorating':
                        statusClass = 'text-red-600 font-bold';
                        statusText = 'ÙÙŠ ØªØ¯Ù‡ÙˆØ± âš ï¸';
                        break;
                    case 'stable':
                        statusClass = 'text-green-600';
                        statusText = 'Ù…Ø³ØªÙ‚Ø± âœ…';
                        break;
                    case 'critical':
                        statusClass = 'text-red-800 font-bold';
                        statusText = 'Ø­Ø±Ø¬ ğŸš¨';
                        break;
                    default:
                        statusClass = 'text-yellow-600';
                }
                
                $('patientStatus').innerHTML = `<span class="${statusClass}">Ø§Ù„Ø­Ø§Ù„Ø©: ${statusText}</span>`;
            }
        }
        
        loadPatientHeader();
        
        // =============== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ===============
        function calculateNEWS2(vitals) {
            let score = 0;
            
            // Respiratory rate
            if (vitals.rr < 9) score += 3;
            else if (vitals.rr >= 9 && vitals.rr <= 11) score += 1;
            else if (vitals.rr >= 12 && vitals.rr <= 20) score += 0;
            else if (vitals.rr >= 21 && vitals.rr <= 24) score += 2;
            else score += 3;
            
            // Oxygen saturation
            if (vitals.spo2 <= 91) score += 3;
            else if (vitals.spo2 >= 92 && vitals.spo2 <= 93) score += 2;
            else if (vitals.spo2 >= 94 && vitals.spo2 <= 95) score += 1;
            else score += 0;
            
            // Supplemental oxygen
            // Assuming no supplemental oxygen for now
            
            // Temperature
            if (vitals.temp < 35.0) score += 3;
            else if (vitals.temp >= 35.1 && vitals.temp <= 36.0) score += 1;
            else if (vitals.temp >= 36.1 && vitals.temp <= 38.0) score += 0;
            else if (vitals.temp >= 38.1 && vitals.temp <= 39.0) score += 1;
            else score += 2;
            
            // Systolic blood pressure
            if (vitals.sys < 90) score += 3;
            else if (vitals.sys >= 90 && vitals.sys <= 99) score += 2;
            else if (vitals.sys >= 100 && vitals.sys <= 109) score += 1;
            else if (vitals.sys >= 110 && vitals.sys <= 219) score += 0;
            else score += 3;
            
            // Heart rate
            if (vitals.hr < 40) score += 3;
            else if (vitals.hr >= 40 && vitals.hr <= 50) score += 1;
            else if (vitals.hr >= 51 && vitals.hr <= 90) score += 0;
            else if (vitals.hr >= 91 && vitals.hr <= 110) score += 1;
            else if (vitals.hr >= 111 && vitals.hr <= 130) score += 2;
            else score += 3;
            
            return score;
        }
        
        function calculateMEWS(vitals) {
            let score = 0;
            
            // Heart rate
            if (vitals.hr < 40) score += 2;
            else if (vitals.hr >= 40 && vitals.hr <= 50) score += 1;
            else if (vitals.hr >= 51 && vitals.hr <= 100) score += 0;
            else if (vitals.hr >= 101 && vitals.hr <= 110) score += 1;
            else if (vitals.hr >= 111 && vitals.hr <= 129) score += 2;
            else score += 3;
            
            // Systolic blood pressure
            if (vitals.sys < 70) score += 3;
            else if (vitals.sys >= 70 && vitals.sys <= 80) score += 2;
            else if (vitals.sys >= 81 && vitals.sys <= 100) score += 1;
            else if (vitals.sys >= 101 && vitals.sys <= 199) score += 0;
            else score += 2;
            
            // Respiratory rate
            if (vitals.rr < 9) score += 2;
            else if (vitals.rr >= 9 && vitals.rr <= 14) score += 0;
            else if (vitals.rr >= 15 && vitals.rr <= 20) score += 1;
            else if (vitals.rr >= 21 && vitals.rr <= 29) score += 2;
            else score += 3;
            
            // Temperature
            if (vitals.temp < 35.0) score += 2;
            else if (vitals.temp >= 35.0 && vitals.temp <= 38.4) score += 0;
            else score += 2;
            
            // Level of consciousness (assuming normal for now)
            // score += 0 if alert, 1 if responds to voice, 2 if responds to pain, 3 if unresponsive
            
            return score;
        }
        
        function calculateSOFA(vitals) {
            let score = 0;
            
            // Respiratory (PaO2/FiO2 ratio) - assuming room air (FiO2 = 0.21)
            const pafi = vitals.pao2 ? (vitals.pao2 / 0.21) : 0;
            if (pafi >= 400) score += 0;
            else if (pafi < 400 && pafi >= 300) score += 1;
            else if (pafi < 300 && pafi >= 200) score += 2;
            else if (pafi < 200 && pafi >= 100) score += 3;
            else score += 4;
            
            // Coagulation (platelets) - assuming normal for now
            // score based on platelet count
            
            // Liver (bilirubin) - assuming normal for now
            // score based on bilirubin levels
            
            // Cardiovascular (MAP or vasopressors)
            const map = (vitals.sys + 2 * vitals.dia) / 3;
            if (map >= 70) score += 0;
            else if (map < 70) score += 1;
            // Additional scoring for vasopressor use
            
            // CNS (GCS) - assuming normal for now
            // score based on Glasgow Coma Scale
            
            // Renal (creatinine or urine output) - assuming normal for now
            // score based on creatinine levels
            
            return score;
        }
        
        function updateMedicalScores(vitals) {
            const news2 = calculateNEWS2(vitals);
            const mews = calculateMEWS(vitals);
            const sofa = calculateSOFA(vitals);
            
            // Update NEWS2
            $('news2Score').textContent = news2;
            let news2Level = 'Ù…Ù†Ø®ÙØ¶ Ø§Ù„Ø®Ø·ÙˆØ±Ø©';
            let news2Class = 'text-green-600';
            if (news2 >= 5) {
                news2Level = 'Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø®Ø·ÙˆØ±Ø©';
                news2Class = 'text-red-600';
            } else if (news2 >= 3) {
                news2Level = 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®Ø·ÙˆØ±Ø©';
                news2Class = 'text-yellow-600';
            }
            $('news2Level').textContent = news2Level;
            $('news2Level').className = news2Class;
            
            // Update MEWS
            $('mewsScore').textContent = mews;
            let mewsLevel = 'Ù…Ø³ØªÙ‚Ø±';
            let mewsClass = 'text-green-600';
            if (mews >= 5) {
                mewsLevel = 'Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø®Ø·ÙˆØ±Ø©';
                mewsClass = 'text-red-600';
            } else if (mews >= 3) {
                mewsLevel = 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®Ø·ÙˆØ±Ø©';
                mewsClass = 'text-yellow-600';
            }
            $('mewsLevel').textContent = mewsLevel;
            $('mewsLevel').className = mewsClass;
            
            // Update SOFA
            $('sofaScore').textContent = sofa;
            let sofaLevel = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ´Ù„ Ø£Ø¹Ø¶Ø§Ø¡';
            let sofaClass = 'text-green-600';
            if (sofa >= 12) {
                sofaLevel = 'ÙØ´Ù„ Ø£Ø¹Ø¶Ø§Ø¡ Ø­Ø§Ø¯';
                sofaClass = 'text-red-600';
            } else if (sofa >= 6) {
                sofaLevel = 'ÙØ´Ù„ Ø£Ø¹Ø¶Ø§Ø¡ Ù…ØªÙˆØ³Ø·';
                sofaClass = 'text-yellow-600';
            } else if (sofa >= 2) {
                sofaLevel = 'ÙØ´Ù„ Ø£Ø¹Ø¶Ø§Ø¡ Ø®ÙÙŠÙ';
                sofaClass = 'text-orange-600';
            }
            $('sofaLevel').textContent = sofaLevel;
            $('sofaLevel').className = sofaClass;
        }
        
        // =============== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†ØªØ§Ù† (SEP-1) ===============
        function assessSepsis(vitals) {
            const criteria = {
                systemic: false,
                response: false,
                organ: false
            };
            
            // Systemic inflammatory response
            if (vitals.temp > 38 || vitals.temp < 36) criteria.systemic = true;
            if (vitals.hr > 90) criteria.systemic = true;
            if (vitals.rr > 20) criteria.systemic = true;
            // WBC criteria would need lab data
            
            // Response criteria
            if (vitals.sys < 90) criteria.response = true;
            // Lactate criteria would need lab data
            
            // Organ dysfunction
            if (vitals.creatinine > 2.0) criteria.organ = true;
            // Other organ dysfunction criteria
            
            const sepsisScore = (criteria.systemic ? 1 : 0) + (criteria.response ? 1 : 0) + (criteria.organ ? 1 : 0);
            
            return {
                score: sepsisScore,
                criteria,
                status: sepsisScore >= 2 ? 'Ø§Ø´ØªØ¨Ø§Ù‡ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ù†' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡',
                actions: sepsisScore >= 2 ? getSepsisActions(vitals) : []
            };
        }
        
        function getSepsisActions(vitals) {
            const actions = [];
            
            // Hour 1 bundle
            actions.push('Ù‚ÙŠØ§Ø³ Ù„Ø§ÙƒØªØ§Øª Ø§Ù„Ø¯Ù…');
            actions.push('Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ø¯Ù…');
            actions.push('Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ø¶Ø§Ø¯Ø§Øª Ø­ÙŠÙˆÙŠØ© ÙˆØ§Ø³Ø¹Ø© Ø§Ù„Ø·ÙŠÙ');
            actions.push('Ø¥Ø¹Ø·Ø§Ø¡ Ø³ÙˆØ§Ø¦Ù„ ÙˆØ±ÙŠØ¯ÙŠØ© (30 mL/kg)');
            
            // Additional actions based on condition
            if (vitals.sys < 90) {
                actions.push('Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø±');
                actions.push('Ø¥Ø¹Ø¯Ø§Ø¯ vasopressors Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±');
            }
            
            if (vitals.spo2 < 90) {
                actions.push('Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙƒØ³Ø¬ÙŠÙ† Ø¥Ø¶Ø§ÙÙŠ');
                actions.push('Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†');
            }
            
            return actions;
        }
        
        function updateSepsisDisplay(vitals) {
            const sepsis = assessSepsis(vitals);
            
            $('sepsisStatus').textContent = sepsis.status;
            if (sepsis.score >= 2) {
                $('sepsisStatus').className = 'badge badge-critical';
            } else {
                $('sepsisStatus').className = 'badge badge-ok';
            }
            
            // Update criteria display
            const criteriaElements = document.querySelectorAll('#sepsisCriteria > div');
            criteriaElements[0].style.backgroundColor = sepsis.criteria.systemic ? '#fef2f2' : '#f8fafc';
            criteriaElements[1].style.backgroundColor = sepsis.criteria.response ? '#fef2f2' : '#f8fafc';
            criteriaElements[2].style.backgroundColor = sepsis.criteria.organ ? '#fef2f2' : '#f8fafc';
            
            // Update actions
            const actionsHtml = sepsis.actions.length > 0 ? 
                sepsis.actions.map(action => `<div class="text-sm">â€¢ ${action}</div>`).join('') :
                '<div class="text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©</div>';
            
            $('sepsisActions').innerHTML = `
                <div class="font-bold text-sm">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</div>
                ${actionsHtml}
            `;
            
            // Alert if sepsis suspected
            if (sepsis.score >= 2 && $('autoAlerts').checked) {
                notificationSystem.sendNotification('critical', 'Ø§Ø´ØªØ¨Ø§Ù‡ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ù†', 
                    `ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${sepsis.score} Ù…Ù† 3 Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¥Ù†ØªØ§Ù†. Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${sepsis.actions.join(', ')}`);
            }
        }
        
        // =============== Ù†Ø¸Ø§Ù… ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ===============
        let patientDrugs = [];
        
        function addDrug(drugName) {
            patientDrugs.push({
                name: drugName,
                addedAt: new Date().toISOString()
            });
            updateDrugList();
            checkDrugInteractions();
        }
        
        function updateDrugList() {
            const drugListHtml = patientDrugs.length > 0 ?
                patientDrugs.map(drug => `
                    <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                        <span>${drug.name}</span>
                        <button onclick="removeDrug('${drug.name}')" class="text-red-600 hover:text-red-800">Ø­Ø°Ù</button>
                    </div>
                `).join('') :
                '<div class="text-sm text-slate-500">Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¹Ø¯</div>';
            
            $('drugList').innerHTML = drugListHtml;
        }
        
        function removeDrug(drugName) {
            patientDrugs = patientDrugs.filter(drug => drug.name !== drugName);
            updateDrugList();
            checkDrugInteractions();
        }
        
        function checkDrugInteractions() {
            const interactions = [];
            
            // Common drug interactions database
            const interactionDB = {
                'Warfarin': ['NSAIDs', 'Antibiotics', 'Antifungals'],
                'Digoxin': ['Diuretics', 'Amiodarone', 'Verapamil'],
                'Insulin': ['Beta-blockers', 'Steroids', 'Thiazides'],
                'ACE Inhibitors': ['Potassium supplements', 'NSAIDs', 'Diuretics'],
                'Statins': ['Fibrates', 'Antibiotics', 'Antifungals']
            };
            
            patientDrugs.forEach(drug => {
                if (interactionDB[drug.name]) {
                    interactionDB[drug.name].forEach(interactingDrug => {
                        if (patientDrugs.some(d => d.name === interactingDrug)) {
                            interactions.push({
                                drug1: drug.name,
                                drug2: interactingDrug,
                                severity: 'high',
                                effect: 'Ø²ÙŠØ§Ø¯Ø© Ø®Ø·Ø± Ø§Ù„Ù†Ø²ÙŠÙ/ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‚Ù„Ø¨'
                            });
                        }
                    });
                }
            });
            
            displayDrugInteractions(interactions);
        }
        
        function displayDrugInteractions(interactions) {
            const container = $('drugInteractions');
            
            if (interactions.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const interactionsHtml = interactions.map(interaction => `
                <div class="drug-interaction">
                    <div class="font-bold text-red-600">ØªÙØ§Ø¹Ù„ Ø¯ÙˆØ§Ø¦ÙŠ Ø®Ø·ÙŠØ±</div>
                    <div class="text-sm">${interaction.drug1} + ${interaction.drug2}</div>
                    <div class="text-xs">Ø§Ù„ØªØ£Ø«ÙŠØ±: ${interaction.effect}</div>
                </div>
            `).join('');
            
            container.innerHTML = interactionsHtml;
            
            // Alert for dangerous interactions
            if (interactions.length > 0 && $('autoAlerts').checked) {
                notificationSystem.sendNotification('critical', 'ØªÙØ§Ø¹Ù„Ø§Øª Ø¯ÙˆØ§Ø¦ÙŠØ© Ø®Ø·ÙŠØ±Ø©', 
                    `ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${interactions.length} ØªÙØ§Ø¹Ù„ Ø¯ÙˆØ§Ø¦ÙŠ Ø®Ø·ÙŠØ±. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙˆØ±Ø§Ù‹.`);
            }
        }
        
        // =============== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ===============
        function calculateRateOfChange(vitals) {
            if (history.length < 2) return null;
            
            const current = vitals;
            const previous = history[history.length - 2];
            
            const timeDiff = (new Date(current.timestamp) - new Date(previous.timestamp)) / 1000 / 60; // minutes
            
            return {
                hr: (current.hr - previous.hr) / timeDiff,
                spo2: (current.spo2 - previous.spo2) / timeDiff,
                sys: (current.sys - previous.sys) / timeDiff,
                dia: (current.dia - previous.dia) / timeDiff
            };
        }
        
        function updateRateOfChangeDisplay(vitals) {
            const rateOfChange = calculateRateOfChange(vitals);
            
            if (!rateOfChange) return;
            
            $('hrChange').textContent = `${rateOfChange.hr > 0 ? '+' : ''}${rateOfChange.hr.toFixed(1)} bpm/min`;
            $('spo2Change').textContent = `${rateOfChange.spo2 > 0 ? '+' : ''}${rateOfChange.spo2.toFixed(1)} %/min`;
            $('bpChange').textContent = `${rateOfChange.sys > 0 ? '+' : ''}${rateOfChange.sys.toFixed(1)}/${rateOfChange.dia > 0 ? '+' : ''}${rateOfChange.dia.toFixed(1)} mmHg/min`;
            
            // Color coding for significant changes
            if (Math.abs(rateOfChange.hr) > 2) $('hrChange').className = 'text-red-600';
            if (Math.abs(rateOfChange.spo2) > 1) $('spo2Change').className = 'text-red-600';
            if (Math.abs(rateOfChange.sys) > 3) $('bpChange').className = 'text-red-600';
        }
        
        function predictDeterioration(vitals) {
            if (history.length < 10) return null;
            
            // Simple ML-based prediction using recent trends
            const recentData = history.slice(-10);
            
            // Calculate trends
            const hrTrend = calculateTrend(recentData.map(d => d.hr));
            const spo2Trend = calculateTrend(recentData.map(d => d.spo2));
            const bpTrend = calculateTrend(recentData.map(d => d.sys));
            
            // Simple risk assessment
            let riskScore = 0;
            let riskFactors = [];
            
            if (hrTrend > 1.5) {
                riskScore += 30;
                riskFactors.push('Ø²ÙŠØ§Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© ÙÙŠ Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨');
            }
            
            if (spo2Trend < -0.5) {
                riskScore += 40;
                riskFactors.push('Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ø³ØªÙ…Ø± ÙÙŠ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†');
            }
            
            if (bpTrend > 2) {
                riskScore += 20;
                riskFactors.push('Ø²ÙŠØ§Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù…');
            }
            
            if (vitals.spo2 < 92) {
                riskScore += 25;
                riskFactors.push('Ø§Ù†Ø®ÙØ§Ø¶ Ø­Ø§Ø¯ ÙÙŠ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†');
            }
            
            if (vitals.sys > 160 || vitals.sys < 90) {
                riskScore += 15;
                riskFactors.push('Ø¶ØºØ· Ø¯Ù… ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ');
            }
            
            return {
                riskScore,
                riskLevel: riskScore > 60 ? 'Ø¹Ø§Ù„ÙŠ' : riskScore > 30 ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶',
                riskFactors,
                timeFrame: '30-60 Ø¯Ù‚ÙŠÙ‚Ø©',
                recommendations: getDeteriorationRecommendations(riskScore, riskFactors)
            };
        }
        
        function getDeteriorationRecommendations(riskScore, riskFactors) {
            const recommendations = [];
            
            if (riskScore > 60) {
                recommendations.push('Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙˆØ±Ø§Ù‹');
                recommendations.push('Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦');
                recommendations.push('Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©');
            } else if (riskScore > 30) {
                recommendations.push('Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø¨ÙŠØ¨');
                recommendations.push('Ø²ÙŠØ§Ø¯Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
                recommendations.push('ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ');
            } else {
                recommendations.push('Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ù†ØªØ¸Ù…Ø©');
                recommendations.push('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
            }
            
            // Specific recommendations based on risk factors
            if (riskFactors.includes('Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ø³ØªÙ…Ø± ÙÙŠ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†')) {
                recommendations.push('ØªÙ‚ÙŠÙŠÙ… ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¦Ø©');
            }
            
            if (riskFactors.includes('Ø²ÙŠØ§Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© ÙÙŠ Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨')) {
                recommendations.push('ØªØ®Ø·ÙŠØ· Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ');
            }
            
            return recommendations;
        }
        
        function updateDeteriorationPrediction(vitals) {
            const prediction = predictDeterioration(vitals);
            
            if (!prediction) {
                $('deteriorationPrediction').innerHTML = '<div class="text-sm">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤</div>';
                return;
            }
            
            const riskClass = prediction.riskLevel === 'Ø¹Ø§Ù„ÙŠ' ? 'text-red-600' : 
                              prediction.riskLevel === 'Ù…ØªÙˆØ³Ø·' ? 'text-yellow-600' : 'text-green-600';
            
            $('deteriorationPrediction').innerHTML = `
                <div class="font-bold ${riskClass}">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${prediction.riskLevel}</div>
                <div class="text-sm mt-1">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${prediction.riskScore}/100</div>
                <div class="text-sm mt-1">Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: ${prediction.timeFrame}</div>
                <div class="text-sm mt-2">Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø·Ø±:</div>
                <ul class="text-xs list-disc list-inside">
                    ${prediction.riskFactors.map(factor => `<li>${factor}</li>`).join('')}
                </ul>
                <div class="text-sm mt-2">Ø§Ù„ØªÙˆØµÙŠØ§Øª:</div>
                <ul class="text-xs list-disc list-inside">
                    ${prediction.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
            
            // Alert for high risk
            if (prediction.riskLevel === 'Ø¹Ø§Ù„ÙŠ' && $('autoAlerts').checked) {
                notificationSystem.sendNotification('critical', 'Ø®Ø·Ø± ØªØ¯Ù‡ÙˆØ± ÙˆØ´ÙŠÙƒ', 
                    `Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${prediction.riskScore}/100. Ø§Ù„Ø¹ÙˆØ§Ù…Ù„: ${prediction.riskFactors.join(', ')}`);
            }
        }
        
        // =============== ØªØ­Ù„ÙŠÙ„ ECG Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ===============
        function analyzeECG(vitals) {
            // Simulated ECG analysis
            const ecgAnalysis = {
                rhythm: 'Sinus Rhythm',
                rate: vitals.hr,
                prInterval: 160,
                qrsDuration: 80,
                qtInterval: 400,
                axis: 'Normal',
                abnormalities: []
            };
            
            // Detect abnormalities
            if (vitals.hr > 100) {
                ecgAnalysis.abnormalities.push('Tachycardia');
            } else if (vitals.hr < 60) {
                ecgAnalysis.abnormalities.push('Bradycardia');
            }
            
            if (vitals.hr > 120 && Math.random() > 0.7) {
                ecgAnalysis.rhythm = 'Atrial Fibrillation';
                ecgAnalysis.abnormalities.push('Irregular Rhythm');
            }
            
            return ecgAnalysis;
        }
        
        function updateECGAnalysis(vitals) {
            const analysis = analyzeECG(vitals);
            
            const abnormalitiesHtml = analysis.abnormalities.length > 0 ?
                analysis.abnormalities.map(ab => `<div class="text-red-600">âš ï¸ ${ab}</div>`).join('') :
                '<div class="text-green-600">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø°ÙˆØ°</div>';
            
            $('ecgAnalysis').innerHTML = `
                <div class="font-bold">ØªØ­Ù„ÙŠÙ„ ECG:</div>
                <div class="text-sm">Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¹: ${analysis.rhythm}</div>
                <div class="text-sm">Ø§Ù„Ù…Ø¹Ø¯Ù„: ${analysis.rate} bpm</div>
                <div class="text-sm">Ø§Ù„Ù…Ø­ÙˆØ±: ${analysis.axis}</div>
                <div class="mt-2">${abnormalitiesHtml}</div>
            `;
        }
        
        // =============== ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºØ§Ø²Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ§Ù†ÙŠØ© ===============
        function analyzeABG(abgValues) {
            const analysis = {
                acidBaseStatus: 'Normal',
                oxygenation: 'Normal',
                ventilation: 'Normal',
                compensation: 'None',
                abnormalities: []
            };
            
            // Acid-Base analysis
            if (abgValues.ph < 7.35) {
                analysis.acidBaseStatus = 'Acidosis';
                analysis.abnormalities.push('Acidemia');
            } else if (abgValues.ph > 7.45) {
                analysis.acidBaseStatus = 'Alkalosis';
                analysis.abnormalities.push('Alkalemia');
            }
            
            // Oxygenation
            if (abgValues.pao2 < 80) {
                analysis.oxygenation = 'Hypoxemia';
                analysis.abnormalities.push('Low PaO2');
            }
            
            // Ventilation
            if (abgValues.paco2 < 35) {
                analysis.ventilation = 'Hyperventilation';
                analysis.abnormalities.push('Low PaCO2');
            } else if (abgValues.paco2 > 45) {
                analysis.ventilation = 'Hypoventilation';
                analysis.abnormalities.push('High PaCO2');
            }
            
            // Compensation
            if (analysis.acidBaseStatus === 'Acidosis' && abgValues.hco3 < 22) {
                analysis.compensation = 'Metabolic';
            } else if (analysis.acidBaseStatus === 'Alkalosis' && abgValues.hco3 > 26) {
                analysis.compensation = 'Metabolic';
            }
            
            return analysis;
        }
        
        function updateABGDisplay(vitals) {
            // Simulated ABG values
            const abgValues = {
                ph: 7.35 + (Math.random() - 0.5) * 0.1,
                paco2: 40 + (Math.random() - 0.5) * 10,
                pao2: 95 + (Math.random() - 0.5) * 20,
                hco3: 24 + (Math.random() - 0.5) * 4
            };
            
            // Update display
            $('phVal').textContent = fmt(abgValues.ph, 2);
            $('paco2Val').textContent = fmt(abgValues.paco2, 0);
            $('pao2Val').textContent = fmt(abgValues.pao2, 0);
            $('hco3Val').textContent = fmt(abgValues.hco3, 1);
            
            // Analyze and display results
            const analysis = analyzeABG(abgValues);
            
            const abnormalitiesHtml = analysis.abnormalities.length > 0 ?
                analysis.abnormalities.map(ab => `<div class="text-red-600">âš ï¸ ${ab}</div>`).join('') :
                '<div class="text-green-600">âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©</div>';
            
            $('abgAnalysis').innerHTML = `
                <div class="font-bold">ØªØ­Ù„ÙŠÙ„ ABG:</div>
                <div class="text-sm">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø¶ÙŠØ©-Ø§Ù„Ù‚Ø§Ø¹Ø¯ÙŠØ©: ${analysis.acidBaseStatus}</div>
                <div class="text-sm">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†: ${analysis.oxygenation}</div>
                <div class="text-sm">Ø§Ù„ØªÙ‡ÙˆÙŠØ©: ${analysis.ventilation}</div>
                <div class="text-sm">Ø§Ù„ØªØ¹ÙˆÙŠØ¶: ${analysis.compensation}</div>
                <div class="mt-2">${abnormalitiesHtml}</div>
            `;
        }
        
        // =============== Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) ===============
        const limits = {
            hr: { min: 50, max: 120 },
            sys: { min: 90, max: 140 },
            dia: { min: 55, max: 90 },
            spo2: { min: 92, max: 100 },
            rr: { min: 10, max: 24 },
            temp: { min: 36.0, max: 37.8 }
        };
        
        function readLimits() {
            limits.hr.min = +$('hrMin').value; limits.hr.max = +$('hrMax').value;
            limits.sys.min = +$('sysMin').value; limits.sys.max = +$('sysMax').value;
            limits.dia.min = +$('diaMin').value; limits.dia.max = +$('diaMax').value;
            limits.spo2.min = +$('spo2Min').value; limits.spo2.max = +$('spo2Max').value;
            limits.rr.min = +$('rrMin').value; limits.rr.max = +$('rrMax').value;
            limits.temp.min = +$('tempMin').value; limits.temp.max = +$('tempMax').value;
        }
        
        // =============== Ù…Ø­Ø§ÙƒØ§Ø© Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ø­Ø¸ÙŠØ© ===============
        let timer = null;
        let t = 0;
        
        function randn(mean, sd) {
            let u = 1 - Math.random();
            let v = 1 - Math.random();
            let z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return mean + z * sd;
        }
        
        function simulateVitals() {
            const hr = Math.max(30, Math.round(randn(82, 6)));
            const sys = Math.round(randn(118, 8));
            const dia = Math.round(randn(76, 6));
            const spo2 = Math.min(100, Math.max(85, Math.round(randn(97, 1.2))));
            const rr = Math.max(6, Math.round(randn(16, 2)));
            const temp = Math.max(34.5, Math.min(40, randn(36.9, 0.2)));
            
            return { 
                hr, 
                sys, 
                dia, 
                spo2, 
                rr, 
                temp: +temp.toFixed(1),
                timestamp: new Date().toISOString(),
                // Simulated lab values
                creatinine: 1.0 + Math.random() * 0.5,
                lactate: 1.0 + Math.random() * 1.5,
                wbc: 8 + Math.random() * 4
            };
        }
        
        // =============== ECG Ø±Ø³Ù… ===============
        const ecgCanvases = ['ecgI', 'ecgII', 'ecgIII', 'ecgAVR'];
        const ecgContexts = {};
        
        ecgCanvases.forEach(canvasId => {
            const canvas = $(canvasId);
            const ctx = canvas.getContext('2d');
            ecgContexts[canvasId] = ctx;
            
            function resizeCanvas() {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        });
        
        function drawECG(ctx, hr, leadType) {
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            
            // Grid
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (let gx = 0; gx < w; gx += 20) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
            for (let gy = 0; gy < h; gy += 20) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
            
            // Waveform
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            let bpm = hr || 80;
            let period = Math.max(0.4, 60 / bpm);
            let samples = w;
            
            for (let i = 0; i < samples; i++) {
                let x = i;
                let tt = (t + i / 120);
                let phase = (tt % period) / period;
                
                // Different patterns for different leads
                let y = 0.02 * Math.sin(2 * Math.PI * phase * 5);
                
                if (leadType === 'II') {
                    // Standard lead II pattern
                    if (phase > 0.1 && phase < 0.14) y += -0.5;
                    if (phase >= 0.14 && phase < 0.18) y += 1.4;
                    if (phase >= 0.18 && phase < 0.22) y += -0.3;
                    if (phase > 0.28 && phase < 0.36) y += 0.25 * Math.sin(Math.PI * (phase - 0.28) / 0.08);
                } else if (leadType === 'I') {
                    // Lead I pattern (inverted)
                    if (phase > 0.1 && phase < 0.14) y += 0.3;
                    if (phase >= 0.14 && phase < 0.18) y += -0.8;
                    if (phase >= 0.18 && phase < 0.22) y += 0.2;
                } else {
                    // Other leads
                    if (phase > 0.1 && phase < 0.14) y += -0.3;
                    if (phase >= 0.14 && phase < 0.18) y += 0.8;
                    if (phase >= 0.18 && phase < 0.22) y += -0.2;
                }
                
                y += (Math.random() - 0.5) * 0.02;
                let yy = h * (0.5 - y * 0.35);
                
                if (i === 0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
            }
            
            ctx.stroke();
        }
        
        function drawAllECGs(hr) {
            ecgCanvases.forEach((canvasId, index) => {
                const leadType = canvasId.replace('ecg', '');
                drawECG(ecgContexts[canvasId], hr, leadType);
            });
        }
        
        // =============== Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¨Ø³Ù‘Ø· (Ù…Ø¤Ø´Ø± Ø®Ø·Ø± + Ø­Ø§Ù„Ø©) ===============
        const history = [];
        const MAX_HIST = 120;
        
        function riskScoreFrom(v) {
            readLimits();
            
            const dev = (val, {min, max}) => val < min ? (min - val) / (min || 1) : (val > max ? (val - max) / (max || 1) : 0);
            let s = 0;
            s += 35 * Math.min(2, dev(v.hr, limits.hr));
            s += 18 * Math.min(2, dev(v.sys, limits.sys));
            s += 12 * Math.min(2, dev(v.dia, limits.dia));
            s += 25 * Math.min(2, dev(v.spo2, limits.spo2));
            s += 5 * Math.min(2, dev(v.rr, limits.rr));
            s += 5 * Math.min(2, dev(v.temp, limits.temp));
            
            const n = history.length;
            if (n >= 6) {
                const trendHr = history.slice(-6).map(x=>x.hr);
                const trendSp = history.slice(-6).map(x=>x.spo2);
                const dHr = trendHr[5]-trendHr[0];
                const dSp = trendSp[0]-trendSp[5];
                if (dHr > 12) s += 10;
                if (dSp > 3) s += 15;
            }
            
            return Math.max(0, Math.min(100, Math.round(s)));
        }
        
        function setStatus(score, v) {
            const badge = $('aiStatusBadge');
            let label = 'Ù…Ø³ØªÙ‚Ø±Ø©', cls = 'badge badge-ok';
            if (score >= 70) { label = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹'; cls = 'badge badge-bad'; }
            else if (score >= 35) { label = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·'; cls = 'badge badge-warn'; }
            badge.textContent = label; badge.className = cls + ' inline-block';
            $('riskScore').textContent = String(score);
            
            const within = (v, lim) => (v >= lim.min && v <= lim.max);
            $('hrState').textContent = within(v.hr, limits.hr) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('bpState').textContent = within(v.sys, limits.sys) && within(v.dia, limits.dia) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('spo2State').textContent = within(v.spo2, limits.spo2) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('rrState').textContent = within(v.rr, limits.rr) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
            $('tempState').textContent = within(v.temp, limits.temp) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
        }
        
        // =============== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø·Ø¨ÙŠØ© ===============
        class MedicalPatternRecognition {
            constructor() {
                this.patterns = [
                    {
                        name: "Ù†ÙˆØ¨Ø© Ù‚Ù„Ø¨ÙŠØ© Ù…Ø­ØªÙ…Ù„Ø©",
                        conditions: [
                            { metric: "hr", operator: ">", value: 120 },
                            { metric: "sys", operator: ">", value: 160 },
                            { metric: "spo2", operator: "<", value: 94 }
                        ],
                        severity: "critical",
                        recommendations: [
                            "Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙˆØ±Ø§Ù‹",
                            "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ",
                            "Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ®Ø·ÙŠØ· Ø§Ù„Ù‚Ù„Ø¨"
                        ]
                    },
                    {
                        name: "ØµØ¯Ù…Ø© Ø¥Ù†ØªØ§Ù†ÙŠØ©",
                        conditions: [
                            { metric: "hr", operator: ">", value: 90 },
                            { metric: "temp", operator: ">", value: 38.5 },
                            { metric: "rr", operator: ">", value: 22 }
                        ],
                        severity: "high",
                        recommendations: [
                            "ÙØ­Øµ Ø§Ù„Ø¹Ø¯ÙˆÙ‰",
                            "Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„ÙˆØ±ÙŠØ¯ÙŠØ©",
                            "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…"
                        ]
                    },
                    {
                        name: "ÙØ´Ù„ ØªÙ†ÙØ³ÙŠ",
                        conditions: [
                            { metric: "spo2", operator: "<", value: 90 },
                            { metric: "rr", operator: ">", value: 25 }
                        ],
                        severity: "critical",
                        recommendations: [
                            "Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ ÙÙˆØ±ÙŠ",
                            "Ø£ÙƒØ³Ø¬ÙŠÙ† Ø¹Ø§Ù„ÙŠ Ø§Ù„ØªØ±ÙƒÙŠØ²",
                            "Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø±Ø¦Ø©"
                        ]
                    }
                ];
            }

            detectPatterns(vitals, history) {
                const detectedPatterns = [];
                
                for (const pattern of this.patterns) {
                    let match = true;
                    const reasons = [];
                    
                    for (const condition of pattern.conditions) {
                        const value = vitals[condition.metric];
                        let conditionMet = false;
                        
                        switch (condition.operator) {
                            case ">":
                                conditionMet = value > condition.value;
                                break;
                            case "<":
                                conditionMet = value < condition.value;
                                break;
                            case ">=":
                                conditionMet = value >= condition.value;
                                break;
                            case "<=":
                                conditionMet = value <= condition.value;
                                break;
                            case "==":
                                conditionMet = value === condition.value;
                                break;
                        }
                        
                        if (!conditionMet) {
                            match = false;
                            break;
                        } else {
                            reasons.push(`${condition.metric}: ${value} ${condition.operator} ${condition.value}`);
                        }
                    }
                    
                    if (match) {
                        const isPersistent = this.checkPatternPersistence(pattern, history);
                        
                        detectedPatterns.push({
                            pattern,
                            reasons,
                            isPersistent,
                            confidence: isPersistent ? 0.9 : 0.7
                        });
                    }
                }
                
                return detectedPatterns;
            }

            checkPatternPersistence(pattern, history) {
                if (history.length < 3) return false;
                
                let persistentCount = 0;
                
                for (let i = history.length - 3; i < history.length; i++) {
                    let match = true;
                    
                    for (const condition of pattern.conditions) {
                        const value = history[i][condition.metric];
                        
                        switch (condition.operator) {
                            case ">":
                                match = value > condition.value;
                                break;
                            case "<":
                                match = value < condition.value;
                                break;
                            case ">=":
                                match = value >= condition.value;
                                break;
                            case "<=":
                                match = value <= condition.value;
                                break;
                            case "==":
                                match = value === condition.value;
                                break;
                        }
                        
                        if (!match) break;
                    }
                    
                    if (match) persistentCount++;
                }
                
                return persistentCount >= 2;
            }

            analyzeTrendPatterns(history) {
                if (history.length < 10) return [];
                
                const trendPatterns = [];
                
                const improvementPattern = this.checkImprovementTrend(history);
                if (improvementPattern) {
                    trendPatterns.push({
                        name: "ØªØ­Ø³Ù† ØªØ¯Ø±ÙŠØ¬ÙŠ",
                        type: "positive",
                        metrics: improvementPattern
                    });
                }
                
                const deteriorationPattern = this.checkDeteriorationTrend(history);
                if (deteriorationPattern) {
                    trendPatterns.push({
                        name: "ØªØ¯Ù‡ÙˆØ± ØªØ¯Ø±ÙŠØ¬ÙŠ",
                        type: "negative",
                        metrics: deteriorationPattern
                    });
                }
                
                const instabilityPattern = this.checkInstability(history);
                if (instabilityPattern) {
                    trendPatterns.push({
                        name: "Ø¹Ø¯Ù… Ø§Ø³ØªÙ‚Ø±Ø§Ø±",
                        type: "warning",
                        metrics: instabilityPattern
                    });
                }
                
                return trendPatterns;
            }

            checkImprovementTrend(history) {
                const improvingMetrics = [];
                
                ['hr', 'sys', 'spo2', 'temp'].forEach(metric => {
                    const recent = history.slice(-5);
                    const older = history.slice(-10, -5);
                    
                    if (recent.length === 5 && older.length === 5) {
                        const recentAvg = recent.reduce((sum, item) => sum + item[metric], 0) / 5;
                        const olderAvg = older.reduce((sum, item) => sum + item[metric], 0) / 5;
                        
                        const improvement = metric === 'spo2' ? 
                            (recentAvg - olderAvg) > 2 : 
                            metric === 'temp' ? 
                            (olderAvg - recentAvg) > 0.3 :
                            metric === 'hr' ?
                            (olderAvg - recentAvg) > 5 :
                            (olderAvg - recentAvg) > 8;
                        
                        if (improvement) {
                            improvingMetrics.push({
                                metric,
                                change: recentAvg - olderAvg,
                                percentChange: ((recentAvg - olderAvg) / olderAvg) * 100
                            });
                        }
                    }
                });
                
                return improvingMetrics.length >= 2 ? improvingMetrics : null;
            }

            checkDeteriorationTrend(history) {
                const deterioratingMetrics = [];
                
                ['hr', 'sys', 'spo2', 'temp'].forEach(metric => {
                    const recent = history.slice(-5);
                    const older = history.slice(-10, -5);
                    
                    if (recent.length === 5 && older.length === 5) {
                        const recentAvg = recent.reduce((sum, item) => sum + item[metric], 0) / 5;
                        const olderAvg = older.reduce((sum, item) => sum + item[metric], 0) / 5;
                        
                        const deterioration = metric === 'spo2' ? 
                            (olderAvg - recentAvg) > 2 : 
                            metric === 'temp' ? 
                            (recentAvg - olderAvg) > 0.3 :
                            metric === 'hr' ?
                            (recentAvg - olderAvg) > 5 :
                            (recentAvg - olderAvg) > 8;
                        
                        if (deterioration) {
                            deterioratingMetrics.push({
                                metric,
                                change: recentAvg - olderAvg,
                                percentChange: ((recentAvg - olderAvg) / olderAvg) * 100
                            });
                        }
                    }
                });
                
                return deterioratingMetrics.length >= 2 ? deterioratingMetrics : null;
            }

            checkInstability(history) {
                const unstableMetrics = [];
                
                ['hr', 'sys', 'spo2'].forEach(metric => {
                    const recent = history.slice(-10);
                    if (recent.length === 10) {
                        const values = recent.map(item => item[metric]);
                        const max = Math.max(...values);
                        const min = Math.min(...values);
                        const range = max - min;
                        
                        const threshold = metric === 'hr' ? 20 : 
                                       metric === 'sys' ? 25 : 
                                       metric === 'spo2' ? 5 : 10;
                        
                        if (range > threshold) {
                            unstableMetrics.push({
                                metric,
                                range,
                                coefficientOfVariation: (this.calculateStandardDeviation(values) / (values.reduce((a, b) => a + b) / values.length)) * 100
                            });
                        }
                    }
                });
                
                return unstableMetrics.length >= 1 ? unstableMetrics : null;
            }

            calculateStandardDeviation(values) {
                const avg = values.reduce((a, b) => a + b) / values.length;
                const squareDiffs = values.map(value => Math.pow(value - avg, 2));
                const avgSquareDiff = squareDiffs.reduce((a, b) => a + b) / values.length;
                return Math.sqrt(avgSquareDiff);
            }
        }
        
        // =============== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ===============
        class AdvancedNotificationSystem {
            constructor() {
                this.notificationQueue = [];
                this.activeNotifications = new Set();
                this.notificationSettings = {
                    sound: true,
                    vibration: true,
                    desktop: true,
                    email: false,
                    sms: false
                };
                this.notificationLevels = {
                    info: { priority: 1, sound: 'info', duration: 3000 },
                    warning: { priority: 2, sound: 'warning', duration: 5000 },
                    critical: { priority: 3, sound: 'critical', duration: 8000 }
                };
            }

            async sendNotification(level, title, message, data = {}) {
                const notification = {
                    id: this.generateNotificationId(),
                    level,
                    title,
                    message,
                    data,
                    timestamp: new Date().toISOString(),
                    acknowledged: false
                };

                this.notificationQueue.push(notification);
                
                this.notificationQueue.sort((a, b) => 
                    this.notificationLevels[b.level].priority - this.notificationLevels[a.level].priority
                );

                this.processNotifications();

                if (fb.enabled) {
                    await this.saveNotificationToFirebase(notification);
                }

                return notification.id;
            }

            async processNotifications() {
                while (this.notificationQueue.length > 0) {
                    const notification = this.notificationQueue.shift();
                    
                    if (this.activeNotifications.has(notification.id)) continue;
                    
                    this.activeNotifications.add(notification.id);
                    
                    await this.displayNotification(notification);
                    
                    setTimeout(() => {
                        this.activeNotifications.delete(notification.id);
                    }, this.notificationLevels[notification.level].duration);
                }
            }

            async displayNotification(notification) {
                const level = this.notificationLevels[notification.level];
                
                if (this.notificationSettings.desktop && 'Notification' in window) {
                    if (Notification.permission === 'granted') {
                        new Notification(notification.title, {
                            body: notification.message,
                            icon: '/favicon.ico',
                            badge: '/favicon.ico',
                            tag: notification.id,
                            requireInteraction: notification.level === 'critical'
                        });
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                new Notification(notification.title, {
                                    body: notification.message,
                                    icon: '/favicon.ico'
                                });
                            }
                        });
                    }
                }

                if (this.notificationSettings.sound) {
                    this.playNotificationSound(level.sound);
                }

                if (this.notificationSettings.vibration && 'vibrate' in navigator) {
                    const pattern = notification.level === 'critical' ? [200, 100, 200] : [200];
                    navigator.vibrate(pattern);
                }

                this.showInAppNotification(notification);

                if (notification.level === 'critical') {
                    await this.sendCriticalAlerts(notification);
                }
            }

            showInAppNotification(notification) {
                const container = document.getElementById('notification-container');
                const notificationEl = document.createElement('div');
                notificationEl.className = `notification-item ${notification.level}`;
                notificationEl.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${notification.title}</span>
                        <button class="notification-close" data-id="${notification.id}">Ã—</button>
                    </div>
                    <div class="notification-body">${notification.message}</div>
                    <div class="notification-footer">
                        <span class="notification-time">${new Date(notification.timestamp).toLocaleTimeString('ar-EG')}</span>
                        <button class="notification-acknowledge" data-id="${notification.id}">ØªÙ…</button>
                    </div>
                `;

                container.appendChild(notificationEl);

                notificationEl.querySelector('.notification-close').addEventListener('click', () => {
                    this.dismissNotification(notification.id);
                    notificationEl.remove();
                });

                notificationEl.querySelector('.notification-acknowledge').addEventListener('click', () => {
                    this.acknowledgeNotification(notification.id);
                    notificationEl.remove();
                });

                setTimeout(() => {
                    if (notificationEl.parentNode) {
                        notificationEl.remove();
                    }
                }, this.notificationLevels[notification.level].duration);
            }

            playNotificationSound(type) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch (type) {
                    case 'critical':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        break;
                    case 'warning':
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        break;
                    default:
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                }

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            async sendCriticalAlerts(notification) {
                if (this.notificationSettings.email) {
                    await this.sendEmailAlert(notification);
                }

                if (this.notificationSettings.sms) {
                    await this.sendSMSAlert(notification);
                }

                await this.sendPushNotification(notification);
            }

            async sendEmailAlert(notification) {
                console.log('Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø·Ø¨ÙŠ:', notification);
                
                if (fb.enabled) {
                    await fb.db.ref(`/alerts/email/${notification.id}`).set({
                        to: 'medical-team@hospital.com',
                        subject: `ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ø¬Ù„: ${notification.title}`,
                        body: notification.message,
                        timestamp: notification.timestamp,
                        patientId: patientId
                    });
                }
            }

            async sendSMSAlert(notification) {
                console.log('Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© SMS Ù„Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø·Ø¨ÙŠ:', notification);
                
                if (fb.enabled) {
                    await fb.db.ref(`/alerts/sms/${notification.id}`).set({
                        to: '+1234567890',
                        message: `${notification.title}: ${notification.message}`,
                        timestamp: notification.timestamp,
                        patientId: patientId
                    });
                }
            }

            async sendPushNotification(notification) {
                console.log('Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø·Ø¨ÙŠ:', notification);
                
                if (fb.enabled) {
                    await fb.db.ref(`/alerts/push/${notification.id}`).set({
                        title: notification.title,
                        body: notification.message,
                        timestamp: notification.timestamp,
                        patientId: patientId,
                        data: notification.data
                    });
                }
            }

            async saveNotificationToFirebase(notification) {
                if (!fb.enabled) return;
                
                await fb.db.ref(`/notifications/${patientId}/${notification.id}`).set(notification);
            }

            acknowledgeNotification(id) {
                if (fb.enabled) {
                    fb.db.ref(`/notifications/${patientId}/${id}/acknowledged`).set(true);
                }
            }

            dismissNotification(id) {
                if (fb.enabled) {
                    fb.db.ref(`/notifications/${patientId}/${id}/dismissed`).set(true);
                }
            }

            generateNotificationId() {
                return 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            updateSettings(settings) {
                this.notificationSettings = { ...this.notificationSettings, ...settings };
                localStorage.setItem('notificationSettings', JSON.stringify(this.notificationSettings));
            }

            loadSettings() {
                const saved = localStorage.getItem('notificationSettings');
                if (saved) {
                    this.notificationSettings = { ...this.notificationSettings, ...JSON.parse(saved) };
                }
            }
        }
        
        // =============== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ===============
        class AdvancedVisualizationSystem {
            constructor() {
                this.charts = {};
                this.colors = {
                    hr: '#ef4444',
                    sys: '#3b82f6',
                    dia: '#60a5fa',
                    spo2: '#10b981',
                    rr: '#f59e0b',
                    temp: '#8b5cf6'
                };
            }

            initializeCharts() {
                this.createVitalSignsChart();
                this.createTrendChart();
                this.createDistributionChart();
            }

            createVitalSignsChart() {
                const ctx = document.getElementById('vitalSignsChart').getContext('2d');
                
                this.charts.vitalSigns = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨',
                                data: [],
                                borderColor: this.colors.hr,
                                backgroundColor: this.colors.hr + '20',
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ',
                                data: [],
                                borderColor: this.colors.sys,
                                backgroundColor: this.colors.sys + '20',
                                tension: 0.4,
                                yAxisID: 'y1'
                            },
                            {
                                label: 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ',
                                data: [],
                                borderColor: this.colors.dia,
                                backgroundColor: this.colors.dia + '20',
                                tension: 0.4,
                                yAxisID: 'y1'
                            },
                            {
                                label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',
                                data: [],
                                borderColor: this.colors.spo2,
                                backgroundColor: this.colors.spo2 + '20',
                                tension: 0.4,
                                yAxisID: 'y2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª'
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Ø§Ù„ÙˆÙ‚Øª'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… (mmHg)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            },
                            y2: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† (%)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        }
                    }
                });
            }

            createTrendChart() {
                const ctx = document.getElementById('trendChart').getContext('2d');
                
                this.charts.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨',
                                data: [],
                                borderColor: this.colors.hr,
                                backgroundColor: this.colors.hr + '20',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',
                                data: [],
                                borderColor: this.colors.spo2,
                                backgroundColor: this.colors.spo2 + '20',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©'
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Ø§Ù„ÙˆÙ‚Øª'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Ø§Ù„Ù‚ÙŠÙ…Ø©'
                                }
                            }
                        }
                    }
                });
            }

            createDistributionChart() {
                const ctx = document.getElementById('distributionChart').getContext('2d');
                
                this.charts.distribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨', 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ', 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³', 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©'],
                        datasets: [
                            {
                                label: 'Ø§Ù„Ù…ØªÙˆØ³Ø·',
                                data: [0, 0, 0, 0, 0, 0],
                                backgroundColor: [
                                    this.colors.hr,
                                    this.colors.sys,
                                    this.colors.dia,
                                    this.colors.spo2,
                                    this.colors.rr,
                                    this.colors.temp
                                ]
                            },
                            {
                                label: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰',
                                data: [0, 0, 0, 0, 0, 0],
                                backgroundColor: '#9ca3af'
                            },
                            {
                                label: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰',
                                data: [0, 0, 0, 0, 0, 0],
                                backgroundColor: '#6b7280'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©'
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø­ÙŠÙˆÙŠØ©'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Ø§Ù„Ù‚ÙŠÙ…Ø©'
                                }
                            }
                        }
                    }
                });
            }

            updateCharts(vitals) {
                if (this.charts.vitalSigns) {
                    const time = new Date(vitals.timestamp).toLocaleTimeString('ar-EG');
                    
                    this.charts.vitalSigns.data.labels.push(time);
                    this.charts.vitalSigns.data.datasets[0].data.push(vitals.hr);
                    this.charts.vitalSigns.data.datasets[1].data.push(vitals.sys);
                    this.charts.vitalSigns.data.datasets[2].data.push(vitals.dia);
                    this.charts.vitalSigns.data.datasets[3].data.push(vitals.spo2);
                    
                    if (this.charts.vitalSigns.data.labels.length > 20) {
                        this.charts.vitalSigns.data.labels.shift();
                        this.charts.vitalSigns.data.datasets.forEach(dataset => {
                            dataset.data.shift();
                        });
                    }
                    
                    this.charts.vitalSigns.update();
                }
                
                if (this.charts.trend) {
                    const time = new Date(vitals.timestamp).toLocaleTimeString('ar-EG');
                    
                    this.charts.trend.data.labels.push(time);
                    this.charts.trend.data.datasets[0].data.push(vitals.hr);
                    this.charts.trend.data.datasets[1].data.push(vitals.spo2);
                    
                    if (this.charts.trend.data.labels.length > 30) {
                        this.charts.trend.data.labels.shift();
                        this.charts.trend.data.datasets.forEach(dataset => {
                            dataset.data.shift();
                        });
                    }
                    
                    this.charts.trend.update();
                }
                
                if (this.charts.distribution && history.length > 0) {
                    const stats = this.calculateStatistics();
                    
                    this.charts.distribution.data.datasets[0].data = [
                        stats.hr.avg,
                        stats.sys.avg,
                        stats.dia.avg,
                        stats.spo2.avg,
                        stats.rr.avg,
                        stats.temp.avg
                    ];
                    
                    this.charts.distribution.data.datasets[1].data = [
                        stats.hr.min,
                        stats.sys.min,
                        stats.dia.min,
                        stats.spo2.min,
                        stats.rr.min,
                        stats.temp.min
                    ];
                    
                    this.charts.distribution.data.datasets[2].data = [
                        stats.hr.max,
                        stats.sys.max,
                        stats.dia.max,
                        stats.spo2.max,
                        stats.rr.max,
                        stats.temp.max
                    ];
                    
                    this.charts.distribution.update();
                }
            }

            calculateStatistics() {
                if (history.length === 0) return null;
                
                const calculateStats = (key) => {
                    const values = history.map(item => item[key]);
                    return {
                        min: Math.min(...values),
                        max: Math.max(...values),
                        avg: values.reduce((a, b) => a + b, 0) / values.length
                    };
                };
                
                return {
                    hr: calculateStats('hr'),
                    sys: calculateStats('sys'),
                    dia: calculateStats('dia'),
                    spo2: calculateStats('spo2'),
                    rr: calculateStats('rr'),
                    temp: calculateStats('temp')
                };
            }

            createCorrelationMatrix() {
                if (history.length < 10) return;
                
                const metrics = ['hr', 'sys', 'dia', 'spo2', 'rr', 'temp'];
                const correlations = {};
                
                for (let i = 0; i < metrics.length; i++) {
                    for (let j = i; j < metrics.length; j++) {
                        const corr = this.calculateCorrelation(
                            history.map(item => item[metrics[i]]),
                            history.map(item => item[metrics[j]])
                        );
                        
                        correlations[`${metrics[i]}_${metrics[j]}`] = corr;
                        correlations[`${metrics[j]}_${metrics[i]}`] = corr;
                    }
                }
                
                this.displayCorrelationMatrix(correlations, metrics);
            }

            calculateCorrelation(x, y) {
                const n = x.length;
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = y.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
                const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
                const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
                
                const numerator = n * sumXY - sumX * sumY;
                const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
                
                return denominator === 0 ? 0 : numerator / denominator;
            }

            displayCorrelationMatrix(correlations, metrics) {
                const container = document.getElementById('correlationMatrix');
                
                let html = '<div class="font-bold mb-2">Ù…ØµÙÙˆÙØ© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·</div>';
                html += '<div class="overflow-x-auto">';
                html += '<table class="min-w-full border-collapse border border-gray-300">';
                html += '<thead><tr><th class="border border-gray-300 p-2"></th>';
                
                metrics.forEach(metric => {
                    html += `<th class="border border-gray-300 p-2">${this.getMetricName(metric)}</th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                metrics.forEach(metric1 => {
                    html += `<tr><th class="border border-gray-300 p-2">${this.getMetricName(metric1)}</th>`;
                    
                    metrics.forEach(metric2 => {
                        const corr = correlations[`${metric1}_${metric2}`];
                        const intensity = Math.abs(corr);
                        const color = corr > 0 ? `rgba(239, 68, 68, ${intensity})` : `rgba(59, 130, 246, ${intensity})`;
                        
                        html += `<td class="border border-gray-300 p-2 text-center" style="background-color: ${color}">${corr.toFixed(2)}</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                container.innerHTML = html;
            }

            getMetricName(metric) {
                const names = {
                    'hr': 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨',
                    'sys': 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ',
                    'dia': 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ',
                    'spo2': 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',
                    'rr': 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³',
                    'temp': 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©'
                };
                return names[metric] || metric;
            }

            exportChart(chartId, format = 'png') {
                const chart = this.charts[chartId];
                if (!chart) return;
                
                const url = chart.toBase64Image();
                const a = document.createElement('a');
                a.href = url;
                a.download = `${chartId}_chart.${format}`;
                a.click();
            }
        }
        
        // =============== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ===============
        class DataExportImportSystem {
            constructor() {
                this.exportFormats = ['json', 'csv', 'pdf', 'xml', 'fhir'];
                this.importFormats = ['json', 'csv', 'fhir'];
            }

            async exportData(format, options = {}) {
                const { startDate, endDate, includeCharts, includeAnalysis } = options;
                
                let filteredData = history;
                if (startDate || endDate) {
                    filteredData = history.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return (!startDate || itemDate >= new Date(startDate)) &&
                               (!endDate || itemDate <= new Date(endDate));
                    });
                }

                switch (format) {
                    case 'json':
                        return this.exportToJSON(filteredData, options);
                    case 'csv':
                        return this.exportToCSV(filteredData, options);
                    case 'pdf':
                        return this.exportToPDF(filteredData, options);
                    case 'xml':
                        return this.exportToXML(filteredData, options);
                    case 'fhir':
                        return this.exportToFHIR(filteredData, options);
                    default:
                        throw new Error('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØµØ¯ÙŠØ± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                }
            }

            exportToJSON(data, options) {
                const exportData = {
                    patientInfo: {
                        id: patientId,
                        name: $('patientName').textContent,
                        exportDate: new Date().toISOString(),
                        dataPoints: data.length,
                        compliance: {
                            hipaa: true,
                            fhir: true,
                            who: true
                        }
                    },
                    vitalSigns: data,
                    analysis: options.includeAnalysis ? this.generateAnalysis(data) : null
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                return this.downloadFile(blob, `patient_${patientId}_data.json`);
            }

            exportToCSV(data, options) {
                if (data.length === 0) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                
                const headers = ['Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª', 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨', 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ', 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³', 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©'];
                const rows = data.map(item => [
                    new Date(item.timestamp).toLocaleString('ar-EG'),
                    item.hr,
                    item.sys,
                    item.dia,
                    item.spo2,
                    item.rr,
                    item.temp
                ]);

                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                return this.downloadFile(blob, `patient_${patientId}_data.csv`);
            }

            async exportToPDF(data, options) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.addFont('https://fonts.gstatic.com/s/cairo/v7/SLXGc1nY6HkvalIkTpu0xg.woff2', 'Cairo', 'normal');
                doc.setFont('Cairo');
                
                doc.setFontSize(20);
                doc.text('ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`Ø§Ù„Ù…Ø¹Ø±Ù: ${patientId}`, 20, 40);
                doc.text(`Ø§Ù„Ø§Ø³Ù…: ${$('patientName').textContent}`, 20, 50);
                doc.text(`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleDateString('ar-EG')}`, 20, 60);
                
                const headers = ['Ø§Ù„ÙˆÙ‚Øª', 'HR', 'SYS', 'DIA', 'SpO2', 'RR', 'TEMP'];
                const tableData = data.slice(0, 30).map(item => [
                    new Date(item.timestamp).toLocaleTimeString('ar-EG'),
                    item.hr.toString(),
                    item.sys.toString(),
                    item.dia.toString(),
                    item.spo2.toString(),
                    item.rr.toString(),
                    item.temp.toString()
                ]);
                
                doc.autoTable({
                    head: [headers],
                    body: tableData,
                    startY: 80,
                    styles: { font: 'Cairo' }
                });
                
                doc.save(`patient_${patientId}_report.pdf`);
            }

            exportToXML(data, options) {
                let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>\n`;
                xmlContent += `<patientData>\n`;
                xmlContent += `  <patientInfo>\n`;
                xmlContent += `    <id>${patientId}</id>\n`;
                xmlContent += `    <name>${$('patientName').textContent}</name>\n`;
                xmlContent += `    <exportDate>${new Date().toISOString()}</exportDate>\n`;
                xmlContent += `    <dataPoints>${data.length}</dataPoints>\n`;
                xmlContent += `    <compliance>\n`;
                xmlContent += `      <hipaa>true</hipaa>\n`;
                xmlContent += `      <fhir>true</fhir>\n`;
                xmlContent += `      <who>true</who>\n`;
                xmlContent += `    </compliance>\n`;
                xmlContent += `  </patientInfo>\n`;
                xmlContent += `  <vitalSigns>\n`;
                
                data.forEach(item => {
                    xmlContent += `    <reading>\n`;
                    xmlContent += `      <timestamp>${item.timestamp}</timestamp>\n`;
                    xmlContent += `      <hr>${item.hr}</hr>\n`;
                    xmlContent += `      <sys>${item.sys}</sys>\n`;
                    xmlContent += `      <dia>${item.dia}</dia>\n`;
                    xmlContent += `      <spo2>${item.spo2}</spo2>\n`;
                    xmlContent += `      <rr>${item.rr}</rr>\n`;
                    xmlContent += `      <temp>${item.temp}</temp>\n`;
                    xmlContent += `    </reading>\n`;
                });
                
                xmlContent += `  </vitalSigns>\n`;
                if (options.includeAnalysis) {
                    xmlContent += `  <analysis>\n`;
                    const analysis = this.generateAnalysis(data);
                    Object.keys(analysis).forEach(key => {
                        xmlContent += `    <${key}>${analysis[key]}</${key}>\n`;
                    });
                    xmlContent += `  </analysis>\n`;
                }
                xmlContent += `</patientData>`;
                
                const blob = new Blob([xmlContent], { type: 'application/xml' });
                return this.downloadFile(blob, `patient_${patientId}_data.xml`);
            }

            exportToFHIR(data, options) {
                const fhirBundle = {
                    resourceType: "Bundle",
                    type: "collection",
                    entry: []
                };

                // Patient resource
                fhirBundle.entry.push({
                    resource: {
                        resourceType: "Patient",
                        id: patientId,
                        name: [{ text: $('patientName').textContent }]
                    }
                });

                // Observation resources
                data.forEach(item => {
                    fhirBundle.entry.push({
                        resource: {
                            resourceType: "Observation",
                            status: "final",
                            category: [{
                                coding: [{
                                    system: "http://terminology.hl7.org/CodeSystem/observation-category",
                                    code: "vital-signs"
                                }]
                            }],
                            code: {
                                coding: [{
                                    system: "http://loinc.org",
                                    code: "85354-9"
                                }]
                            },
                            subject: { reference: `Patient/${patientId}` },
                            effectiveDateTime: item.timestamp,
                            component: [
                                {
                                    code: { coding: [{ system: "http://loinc.org", code: "8867-4" }] },
                                    valueQuantity: { value: item.hr, unit: "bpm" }
                                },
                                {
                                    code: { coding: [{ system: "http://loinc.org", code: "8480-6" }] },
                                    valueQuantity: { value: item.sys, unit: "mmHg" }
                                },
                                {
                                    code: { coding: [{ system: "http://loinc.org", code: "8462-4" }] },
                                    valueQuantity: { value: item.dia, unit: "mmHg" }
                                },
                                {
                                    code: { coding: [{ system: "http://loinc.org", code: "59408-5" }] },
                                    valueQuantity: { value: item.spo2, unit: "%" }
                                },
                                {
                                    code: { coding: [{ system: "http://loinc.org", code: "9279-1" }] },
                                    valueQuantity: { value: item.rr, unit: "/min" }
                                },
                                {
                                    code: { coding: [{ system: "http://loinc.org", code: "8310-5" }] },
                                    valueQuantity: { value: item.temp, unit: "Cel" }
                                }
                            ]
                        }
                    });
                });

                const blob = new Blob([JSON.stringify(fhirBundle, null, 2)], { type: 'application/fhir+json' });
                return this.downloadFile(blob, `patient_${patientId}_fhir.json`);
            }

            async importData(file, format) {
                const reader = new FileReader();
                
                return new Promise((resolve, reject) => {
                    reader.onload = async (e) => {
                        try {
                            let data;
                            
                            switch (format) {
                                case 'json':
                                    data = JSON.parse(e.target.result);
                                    break;
                                case 'csv':
                                    data = this.parseCSV(e.target.result);
                                    break;
                                case 'fhir':
                                    data = this.parseFHIR(e.target.result);
                                    break;
                                default:
                                    throw new Error('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                            }
                            
                            const processedData = await this.processImportedData(data);
                            
                            history.push(...processedData);
                            
                            if (fb.enabled) {
                                await this.saveImportedData(processedData);
                            }
                            
                            resolve(processedData.length);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.readAsText(file);
                });
            }

            parseCSV(csvText) {
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',');
                    const reading = {
                        timestamp: new Date(values[0]).toISOString(),
                        hr: parseInt(values[1]),
                        sys: parseInt(values[2]),
                        dia: parseInt(values[3]),
                        spo2: parseInt(values[4]),
                        rr: parseInt(values[5]),
                        temp: parseFloat(values[6])
                    };
                    
                    data.push(reading);
                }
                
                return data;
            }

            parseFHIR(fhirJson) {
                const bundle = JSON.parse(fhirJson);
                const data = [];
                
                if (bundle.resourceType === "Bundle") {
                    bundle.entry.forEach(entry => {
                        if (entry.resource.resourceType === "Observation") {
                            const obs = entry.resource;
                            const components = obs.component || [];
                            
                            const reading = {
                                timestamp: obs.effectiveDateTime,
                                hr: this.findComponentValue(components, "8867-4"),
                                sys: this.findComponentValue(components, "8480-6"),
                                dia: this.findComponentValue(components, "8462-4"),
                                spo2: this.findComponentValue(components, "59408-5"),
                                rr: this.findComponentValue(components, "9279-1"),
                                temp: this.findComponentValue(components, "8310-5")
                            };
                            
                            data.push(reading);
                        }
                    });
                }
                
                return data;
            }

            findComponentValue(components, code) {
                const component = components.find(c => 
                    c.code.coding && c.code.coding.some(coding => coding.code === code)
                );
                return component ? component.valueQuantity.value : null;
            }

            async processImportedData(data) {
                const validData = data.filter(item => {
                    return item.hr && item.sys && item.dia && item.spo2 && item.rr && item.temp;
                });
                
                validData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                return validData;
            }

            async saveImportedData(data) {
                if (!fb.enabled) return;
                
                const batch = {};
                data.forEach((item, index) => {
                    const timestamp = item.timestamp.replace(/[\.\#\$\[\]]/g, '');
                    batch[`/patients/emergency/${patientId}/readings/${timestamp}`] = item;
                });
                
                await fb.db.ref().update(batch);
            }

            generateAnalysis(data) {
                if (data.length === 0) return {};
                
                const calculateStats = (key) => {
                    const values = data.map(item => item[key]);
                    return {
                        min: Math.min(...values),
                        max: Math.max(...values),
                        avg: values.reduce((a, b) => a + b, 0) / values.length,
                        std: this.calculateStandardDeviation(values)
                    };
                };
                
                return {
                    hr: calculateStats('hr'),
                    sys: calculateStats('sys'),
                    dia: calculateStats('dia'),
                    spo2: calculateStats('spo2'),
                    rr: calculateStats('rr'),
                    temp: calculateStats('temp'),
                    totalReadings: data.length,
                    dateRange: {
                        start: data[0].timestamp,
                        end: data[data.length - 1].timestamp
                    }
                };
            }

            calculateStandardDeviation(values) {
                const avg = values.reduce((a, b) => a + b) / values.length;
                const squareDiffs = values.map(value => Math.pow(value - avg, 2));
                const avgSquareDiff = squareDiffs.reduce((a, b) => a + b) / values.length;
                return Math.sqrt(avgSquareDiff);
            }

            downloadFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        // =============== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø© ===============
        const patternRecognition = new MedicalPatternRecognition();
        const notificationSystem = new AdvancedNotificationSystem();
        const visualizationSystem = new AdvancedVisualizationSystem();
        const dataExportImport = new DataExportImportSystem();
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ===============
        function calculateTrend(values) {
            let changes = 0;
            for (let i = 1; i < values.length; i++) {
                changes += values[i] - values[i-1];
            }
            return changes / (values.length - 1);
        }
        
        function compareWithPrevious(current, previous) {
            if (!previous) return null;
            
            const changes = {};
            let significantChanges = [];
            
            Object.keys(current).forEach(key => {
                if (typeof current[key] === 'number' && typeof previous[key] === 'number') {
                    const change = current[key] - previous[key];
                    const percentChange = (change / previous[key]) * 100;
                    
                    changes[key] = {
                        value: change,
                        percent: percentChange,
                        direction: change > 0 ? 'up' : change < 0 ? 'down' : 'same'
                    };
                    
                    if (key === 'hr' && Math.abs(change) > 10) {
                        significantChanges.push({
                            metric: 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨',
                            change,
                            percent: percentChange,
                            severity: Math.abs(change) > 20 ? 'high' : 'medium'
                        });
                    } else if (key === 'sys' && Math.abs(change) > 15) {
                        significantChanges.push({
                            metric: 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ',
                            change,
                            percent: percentChange,
                            severity: Math.abs(change) > 25 ? 'high' : 'medium'
                        });
                    } else if (key === 'spo2' && Math.abs(change) > 3) {
                        significantChanges.push({
                            metric: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',
                            change,
                            percent: percentChange,
                            severity: Math.abs(change) > 5 ? 'high' : 'medium'
                        });
                    }
                }
            });
            
            return {
                changes,
                significantChanges,
                current,
                previous
            };
        }
        
        function getMetricName(metric) {
            const names = {
                'hr': 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨',
                'sys': 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ',
                'dia': 'Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ',
                'spo2': 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',
                'rr': 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³',
                'temp': 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©'
            };
            return names[metric] || metric;
        }
        
        // =============== Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ===============
        function logEvent(txt, level='info') {
            const row = document.createElement('div');
            const t = new Date().toLocaleTimeString();
            row.className = 'flex items-center gap-2';
            const dot = document.createElement('span'); dot.className = 'w-2.5 h-2.5 rounded-full ' + (level==='danger'? 'bg-rose-500' : level==='warn'? 'bg-amber-500':'bg-slate-400');
            const msg = document.createElement('span'); msg.textContent = `[${t}] ${txt}`;
            row.appendChild(dot); row.appendChild(msg);
            $('log').prepend(row);
        }
        
        async function alertIfNeeded(score, v) {
            if (!$('autoAlerts').checked) return;
            if (score < 35) return;
            
            let level = 'warning';
            let title = 'ØªÙ†Ø¨ÙŠÙ‡';
            let message = `HR:${v.hr} | BP:${v.sys}/${v.dia} | SpOâ‚‚:${v.spo2}%`;
            
            if (score >= 70) {
                level = 'critical';
                title = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹';
                message = `Ø®Ø·Ø± Ù…Ø±ØªÙØ¹: HR:${v.hr} | BP:${v.sys}/${v.dia} | SpOâ‚‚:${v.spo2}%`;
            }
            
            await notificationSystem.sendNotification(level, title, message, {
                score,
                vitals: v,
                patientId: patientId
            });
            
            logEvent(`${title}: ${message}`, level === 'critical' ? 'danger' : 'warn');
        }
        
        // =============== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ ===============
        function render(vitals) {
            const updateValue = (id, value) => {
                const element = $(id);
                if (element.textContent !== value) {
                    element.textContent = value;
                    element.classList.add('value-change');
                    setTimeout(() => element.classList.remove('value-change'), 500);
                }
            };
            
            updateValue('hrVal', fmt(vitals.hr));
            updateValue('bpVal', `${fmt(vitals.sys)}/${fmt(vitals.dia)}`);
            updateValue('spo2Val', fmt(vitals.spo2));
            updateValue('rrVal', fmt(vitals.rr));
            updateValue('tempVal', fmt(vitals.temp, 1));
            
            history.push(vitals);
            if (history.length > MAX_HIST) history.shift();
            
            const score = riskScoreFrom(vitals);
            setStatus(score, vitals);
            
            updateMedicalScores(vitals);
            updateSepsisDisplay(vitals);
            updateRateOfChangeDisplay(vitals);
            updateDeteriorationPrediction(vitals);
            updateECGAnalysis(vitals);
            updateABGDisplay(vitals);
            
            if (history.length > 1) {
                const previous = history[history.length - 2];
                const comparison = compareWithPrevious(vitals, previous);
                
                if (comparison && comparison.significantChanges.length > 0) {
                    const changesContainer = document.getElementById('changes-container');
                    changesContainer.innerHTML = `
                        <div class="font-bold mb-2">ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù‡Ù…Ø© Ù…Ù†Ø° Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
                        <div class="space-y-2">
                            ${comparison.significantChanges.map(change => `
                                <div class="p-2 rounded-lg ${change.severity === 'high' ? 'bg-red-100' : 'bg-yellow-100'}">
                                    <div class="font-bold">${change.metric}</div>
                                    <div class="text-sm">
                                        ${change.direction === 'up' ? 'â†—ï¸' : 'â†˜ï¸'} ${Math.abs(change.change)} (${change.percent.toFixed(1)}%)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            const detectedPatterns = patternRecognition.detectPatterns(vitals, history);
            if (detectedPatterns.length > 0) {
                displayDetectedPatterns(detectedPatterns);
            }
            
            const trendPatterns = patternRecognition.analyzeTrendPatterns(history);
            if (trendPatterns.length > 0) {
                displayTrendPatterns(trendPatterns);
            }
            
            alertIfNeeded(score, vitals);
            
            const diagnosis = diagnoseCondition(vitals);
            displayDiagnosis(diagnosis);
            
            const trends = predictTrends();
            displayTrends(trends);
            
            analyzeWithML(vitals).then(result => displayMLRecommendations(result));
            
            visualizationSystem.updateCharts(vitals);
        }
        
        function displayDetectedPatterns(patterns) {
            const patternsContainer = document.getElementById('patterns-container');
            patternsContainer.innerHTML = `
                <div class="font-bold mb-2">Ø£Ù†Ù…Ø§Ø· Ø·Ø¨ÙŠØ© Ù…ÙƒØªØ´ÙØ©</div>
                <div class="space-y-3">
                    ${patterns.map(item => `
                        <div class="p-4 rounded-lg ${item.pattern.severity === 'critical' ? 'bg-red-100 border-l-4 border-red-500' : 'bg-yellow-100 border-l-4 border-yellow-500'}">
                            <div class="font-bold text-lg">${item.pattern.name}</div>
                            <div class="text-sm mt-1">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: ${(item.confidence * 100).toFixed(0)}% ${item.isPersistent ? '(Ù…Ø³ØªÙ…Ø±)' : '(Ù…Ø¤Ù‚Øª)'}</div>
                            <div class="text-sm mt-2">Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨:</div>
                            <ul class="list-disc list-inside text-sm">
                                ${item.reasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                            <div class="text-sm mt-2">Ø§Ù„ØªÙˆØµÙŠØ§Øª:</div>
                            <ul class="list-disc list-inside text-sm">
                                ${item.pattern.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function displayTrendPatterns(patterns) {
            const trendsContainer = document.getElementById('trend-patterns-container');
            trendsContainer.innerHTML = `
                <div class="font-bold mb-2">Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø§ØªØ¬Ø§Ù‡</div>
                <div class="space-y-2">
                    ${patterns.map(pattern => `
                        <div class="p-3 rounded-lg ${pattern.type === 'positive' ? 'bg-green-100' : pattern.type === 'negative' ? 'bg-red-100' : 'bg-yellow-100'}">
                            <div class="font-bold">${pattern.name}</div>
                            <div class="text-sm">
                                ${pattern.metrics.map(metric => `
                                    <div>${getMetricName(metric.metric)}: ${metric.change > 0 ? '+' : ''}${metric.change.toFixed(1)} (${metric.percentChange.toFixed(1)}%)</div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function diagnoseCondition(vitals) {
            const { hr, sys, dia, spo2, rr, temp } = vitals;
            const diagnosis = [];
            if (hr > 120) {
                diagnosis.push({
                    condition: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨",
                    severity: sys > 140 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…ØªÙˆØ³Ø·",
                    recommendation: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù… ÙˆØ§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ¨"
                });
            } else if (hr < 50) {
                diagnosis.push({
                    condition: "Ø¨Ø·Ø¡ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨",
                    severity: "Ù…ØªÙˆØ³Ø·",
                    recommendation: "ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ù„Ø¨"
                });
            }
            if (spo2 < 92) {
                diagnosis.push({
                    condition: "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†",
                    severity: spo2 < 88 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…ØªÙˆØ³Ø·",
                    recommendation: rr > 24 ? "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙ†ÙØ³" : "ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†"
                });
            }
            if (temp > 37.8) {
                diagnosis.push({
                    condition: "Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©",
                    severity: temp > 39 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…Ù†Ø®ÙØ¶",
                    recommendation: "ØªØ®ÙÙŠØ¶ Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¯ÙˆÙ‰"
                });
            }
            return diagnosis;
        }
        
        function displayDiagnosis(diagnosis) {
            const diagnosisContainer = document.getElementById('diagnosis-container');
            diagnosisContainer.innerHTML = '';
            if (diagnosis.length === 0) {
                diagnosisContainer.innerHTML = '<div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚</div>';
                return;
            }
            diagnosis.forEach(item => {
                const div = document.createElement('div');
                div.className = `p-3 mb-2 rounded-lg ${item.severity === 'Ø¹Ø§Ù„ÙŠ' ? 'bg-red-100' : 'bg-yellow-100'}`;
                div.innerHTML = `
                    <div class="font-bold">${item.condition}</div>
                    <div class="text-sm">Ø§Ù„Ø´Ø¯Ø©: ${item.severity}</div>
                    <div class="text-sm">Ø§Ù„ØªÙˆØµÙŠØ©: ${item.recommendation}</div>
                `;
                diagnosisContainer.appendChild(div);
            });
        }
        
        function predictTrends() {
            if (history.length < 10) return null;
            const recentData = history.slice(-10);
            const hrTrend = calculateTrend(recentData.map(d => d.hr));
            const spo2Trend = calculateTrend(recentData.map(d => d.spo2));
            return {
                hrPrediction: recentData[recentData.length - 1].hr + (hrTrend * 5),
                spo2Prediction: recentData[recentData.length - 1].spo2 + (spo2Trend * 5),
                deteriorationRisk: hrTrend > 2 || spo2Trend < -1
            };
        }
        
        function displayTrends(trends) {
            const trendsContainer = document.getElementById('trends-container');
            if (!trends) {
                trendsContainer.innerHTML = '<div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤</div>';
                return;
            }
            trendsContainer.innerHTML = `
                <div class="mb-2">
                    <div class="font-bold">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª Ø®Ù„Ø§Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚:</div>
                    <div>Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${Math.round(trends.hrPrediction)} bpm</div>
                    <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${Math.round(trends.spo2Prediction)}%</div>
                    ${trends.deteriorationRisk ? '<div class="text-red-600 font-bold">ØªØ­Ø°ÙŠØ±: Ù‡Ù†Ø§Ùƒ Ø§Ø­ØªÙ…Ø§Ù„ Ù„ØªØ¯Ù‡ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©!</div>' : ''}
                </div>
            `;
        }
        
        async function analyzeWithML(vitals) {
            const mlResult = {
                riskLevel: Math.random() > 0.7 ? "high" : Math.random() > 0.4 ? "medium" : "low",
                possibleConditions: [
                    { name: "Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…", probability: vitals.sys > 140 ? 0.85 : 0.45 },
                    { name: "Ù‚Ù„Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†", probability: vitals.spo2 < 95 ? 0.75 : 0.25 },
                    { name: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨", probability: vitals.hr > 100 ? 0.80 : 0.30 }
                ],
                recommendations: [
                    "Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ø¶ØºØ·",
                    "Ù‚ÙŠØ§Ø³ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©",
                    "ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ù„Ø¨ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ø­Ø§Ù„Ø©"
                ]
            };
            return mlResult;
        }
        
        function displayMLRecommendations(mlAnalysis) {
            const mlContainer = document.getElementById('ml-container');
            mlContainer.innerHTML = `
                <div class="mb-2">
                    <div class="font-bold">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:</div>
                    <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${mlAnalysis.riskLevel === 'high' ? 'Ø¹Ø§Ù„ÙŠ' : mlAnalysis.riskLevel === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶'}</div>
                    <div class="mt-2">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:</div>
                    <ul>
                        ${mlAnalysis.possibleConditions.map(cond => 
                            `<li>${cond.name} (${Math.round(cond.probability * 100)}%)</li>`
                        ).join('')}
                    </ul>
                    <div class="mt-2">ØªÙˆØµÙŠØ§Øª:</div>
                    <ul>
                        ${mlAnalysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        // =============== ÙˆØ¸Ø§Ø¦Ù Firebase ===============
        function pushToFirebase(vitals) {
            if (!fb.enabled) return;
            const now = new Date();
            const vitalSignsRef = fb.db.ref(`/patients/emergency/${patientId}/vitalSigns`);
            const readingsRef = fb.db.ref(`/patients/emergency/${patientId}/readings/${nowIso().replace(/[\.\#\$\[\]]/g, '')}`);
            vitalSignsRef.set(vitals).catch(e => console.error("Firebase update failed", e));
            readingsRef.set({ ...vitals, timestamp: now.toISOString() }).catch(e => console.error("Firebase save failed", e));
        }
        
        // =============== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===============
        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('darkMode', isDark);
        });

        window.addEventListener('load', () => {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
        });

        $('connectBtn').addEventListener('click', () => {
            if (window.isSecureContext) {
                Swal.fire({
                    title: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
                    text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ø£Ù… WiFi Ø£Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©ØŸ',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ø¨Ù„ÙˆØªÙˆØ«',
                    cancelButtonText: 'WiFi',
                    denyButtonText: 'Ù…Ø­Ø§ÙƒØ§Ø©'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await connectToDevice();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        await connectToWiFiDevice();
                    } else if (result.dismiss === Swal.DismissReason.deny) {
                        startSimulationMode();
                    }
                });
            } else {
                Swal.fire('ØºÙŠØ± Ø¢Ù…Ù†', 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ¦Ø© Ø¢Ù…Ù†Ø© (HTTPS). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.', 'error');
            }
        });

        $('startBtn').addEventListener('click', () => {
            if (!timer) {
                logEvent('Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                startSimulationMode();
            }
        });

        $('stopBtn').addEventListener('click', () => {
            if (timer) {
                clearInterval(timer);
                timer = null;
                logEvent('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
                document.getElementById('connBadge').textContent = 'Ù…Ø­Ù„ÙŠ';
                document.getElementById('connBadge').className = 'badge badge-warn inline-block mt-1';
            }
        });

        $('snapBtn').addEventListener('click', () => {
            if (history.length > 0) {
                const latest = history[history.length - 1];
                const now = nowIso();
                const snapshotRef = fb.db.ref(`/patients/emergency/${patientId}/snapshots/${now.replace(/[\.\#\$\[\]]/g, '')}`);
                snapshotRef.set({ ...latest, timestamp: now })
                    .then(() => Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success'))
                    .catch(e => Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + e.message, 'error'));
            } else {
                Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§.', 'error');
            }
        });

        $('clearLog').addEventListener('click', () => {
            $('log').innerHTML = '';
            logEvent('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„');
        });

        $('addDrugBtn').addEventListener('click', () => {
            Swal.fire({
                title: 'Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡',
                input: 'text',
                inputPlaceholder: 'Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡',
                showCancelButton: true,
                confirmButtonText: 'Ø¥Ø¶Ø§ÙØ©',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    addDrug(result.value);
                }
            });
        });

        $('reportBtn').addEventListener('click', generateReport);

        function generateReport() {
            if (history.length === 0) {
                Swal.fire('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±.', 'warning');
                return;
            }
            
            const calculateStats = (key) => {
                const values = history.map(item => item[key]);
                const min = Math.min(...values);
                const max = Math.max(...values);
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                return { min, max, avg: Number(avg.toFixed(1)) };
            };
            
            const hrStats = calculateStats('hr');
            const sysStats = calculateStats('sys');
            const diaStats = calculateStats('dia');
            const spo2Stats = calculateStats('spo2');
            const rrStats = calculateStats('rr');
            const tempStats = calculateStats('temp');
            
            const reportContent = `
                <div class="text-right" dir="rtl">
                    <h2 class="text-xl font-bold mb-4">ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
                    <div class="mb-4">
                        <h3 class="font-bold">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h3>
                        <p>Ø§Ù„Ø§Ø³Ù…: ${$('patientName').textContent}</p>
                        <p>Ø§Ù„Ù…Ø¹Ø±Ù: ${patientId}</p>
                        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold">Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</h3>
                        <p>NEWS2: ${$('news2Score').textContent} - ${$('news2Level').textContent}</p>
                        <p>MEWS: ${$('mewsScore').textContent} - ${$('mewsLevel').textContent}</p>
                        <p>SOFA: ${$('sofaScore').textContent} - ${$('sofaLevel').textContent}</p>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</h3>
                        <table class="w-full border-collapse border border-gray-300">
                            <tr>
                                <th class="border border-gray-300 p-2">Ø§Ù„Ù…Ø¤Ø´Ø±</th>
                                <th class="border border-gray-300 p-2">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                                <th class="border border-gray-300 p-2">Ø§Ù„Ù…ØªÙˆØ³Ø·</th>
                                <th class="border border-gray-300 p-2">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰</th>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2">Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)</td>
                                <td class="border border-gray-300 p-2">${hrStats.min}</td>
                                <td class="border border-gray-300 p-2">${hrStats.avg}</td>
                                <td class="border border-gray-300 p-2">${hrStats.max}</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2">Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ (mmHg)</td>
                                <td class="border border-gray-300 p-2">${sysStats.min}</td>
                                <td class="border border-gray-300 p-2">${sysStats.avg}</td>
                                <td class="border border-gray-300 p-2">${sysStats.max}</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2">Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ (mmHg)</td>
                                <td class="border border-gray-300 p-2">${diaStats.min}</td>
                                <td class="border border-gray-300 p-2">${diaStats.avg}</td>
                                <td class="border border-gray-300 p-2">${diaStats.max}</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2">Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† (%)</td>
                                <td class="border border-gray-300 p-2">${spo2Stats.min}</td>
                                <td class="border border-gray-300 p-2">${spo2Stats.avg}</td>
                                <td class="border border-gray-300 p-2">${spo2Stats.max}</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³ (rpm)</td>
                                <td class="border border-gray-300 p-2">${rrStats.min}</td>
                                <td class="border border-gray-300 p-2">${rrStats.avg}</td>
                                <td class="border border-gray-300 p-2">${rrStats.max}</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</td>
                                <td class="border border-gray-300 p-2">${tempStats.min}</td>
                                <td class="border border-gray-300 p-2">${tempStats.avg}</td>
                                <td class="border border-gray-300 p-2">${tempStats.max}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
                        <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ${history.length} Ù‚Ø±Ø§Ø¡Ø©.</p>
                        <p>ÙØªØ±Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: Ù…Ù† ${new Date(history[0].timestamp).toLocaleString('ar-EG')} Ø¥Ù„Ù‰ ${new Date(history[history.length - 1].timestamp).toLocaleString('ar-EG')}</p>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold">Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</h3>
                        <p>âœ… Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± WHO</p>
                        <p>âœ… Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± AHA</p>
                        <p>âœ… Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± Joint Commission</p>
                        <p>âœ… Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± HIPAA</p>
                        <p>âœ… Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± FHIR STU3</p>
                    </div>
                </div>
            `;
            
            Swal.fire({
                title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶',
                html: reportContent,
                width: '80%',
                confirmButtonText: 'Ø·Ø¨Ø§Ø¹Ø©',
                cancelButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
                showCancelButton: true,
                showCloseButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶</title>
                            <style>
                                body { font-family: 'Cairo', sans-serif; direction: rtl; }
                                table { width: 100%; border-collapse: collapse; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                                th { background-color: #f2f2f2; }
                            </style>
                        </head>
                        <body>
                            ${reportContent}
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                }
            });
            
            if (fb.enabled) {
                const reportData = {
                    patientId,
                    patientName: $('patientName').textContent,
                    timestamp: nowIso(),
                    medicalScores: {
                        news2: parseInt($('news2Score').textContent),
                        mews: parseInt($('mewsScore').textContent),
                        sofa: parseInt($('sofaScore').textContent)
                    },
                    stats: {
                        hr: hrStats,
                        sys: sysStats,
                        dia: diaStats,
                        spo2: spo2Stats,
                        rr: rrStats,
                        temp: tempStats
                    },
                    readingsCount: history.length,
                    period: {
                        start: history[0].timestamp,
                        end: history[history.length - 1].timestamp
                    },
                    compliance: {
                        who: true,
                        aha: true,
                        jointCommission: true,
                        hipaa: true,
                        fhir: true
                    }
                };
                
                fb.db.ref(`/reports/${patientId}/${nowIso().replace(/[\.\#\$\[\]]/g, '')}`).set(reportData)
                    .then(() => logEvent('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Firebase'))
                    .catch(e => console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', e));
            }
        }

        document.getElementById('exportBtn').addEventListener('click', async () => {
            const format = document.getElementById('exportFormat').value;
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            const includeCharts = document.getElementById('includeCharts').checked;
            const includeAnalysis = document.getElementById('includeAnalysis').checked;
            
            try {
                await dataExportImport.exportData(format, {
                    startDate,
                    endDate,
                    includeCharts,
                    includeAnalysis
                });
                Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
            }
        });
        
        document.getElementById('importBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('importFile');
            const format = document.getElementById('importFormat').value;
            
            if (!fileInput.files.length) {
                Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            try {
                const count = await dataExportImport.importData(file, format);
                Swal.fire('Ù†Ø¬Ø§Ø­', `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            } catch (error) {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
            }
        });

        // =============== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ===============
        let deviceConnected = false;
        let currentVitals = null;

        function handleHeartRate(event) {
            const value = event.target.value;
            const heartRate = value.getUint8(1);
            if (!currentVitals) currentVitals = {};
            currentVitals.hr = heartRate;
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                render(currentVitals);
                pushToFirebase(currentVitals);
            }
        }

        function handleBloodPressure(event) {
            const value = event.target.value;
            let offset = 1;
            const sys = value.getUint16(offset, true);
            offset += 2;
            const dia = value.getUint16(offset, true);
            if (!currentVitals) currentVitals = {};
            currentVitals.sys = sys;
            currentVitals.dia = dia;
            if (currentVitals.hr && currentVitals.sys && currentVitals.spo2) {
                render(currentVitals);
                pushToFirebase(currentVitals);
            }
        }

        function handleBatteryLevel(event) {
            const batteryLevel = event.target.value.getUint8(0);
            document.getElementById('batteryLevel').textContent = `${batteryLevel}%`;
            
            const batteryBadge = document.getElementById('batteryBadge');
            if (batteryLevel <= 20) {
                batteryBadge.className = 'badge badge-bad';
            } else if (batteryLevel <= 50) {
                batteryBadge.className = 'badge badge-warn';
            } else {
                batteryBadge.className = 'badge badge-ok';
            }
            
            if (batteryLevel <= 20 && $('autoAlerts').checked) {
                logEvent(`Ø§Ù†Ø®ÙØ§Ø¶ Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ù‡Ø§Ø²: ${batteryLevel}%`, 'warn');
                Swal.fire({
                    title: 'Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©',
                    text: `Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù†Ø®ÙØ¶Ø©: ${batteryLevel}%`,
                    icon: 'warning',
                    toast: true,
                    position: 'top-end',
                    timer: 3000,
                    showConfirmButton: false
                });
            }
        }

        async function connectToDevice() {
            try {
                logEvent('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø©...');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['heart_rate'] },
                        { services: ['blood_pressure'] },
                        { namePrefix: 'Pulse' },
                        { namePrefix: 'Monitor' }
                    ],
                    optionalServices: ['battery_service']
                });
                
                logEvent(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²: ${device.name}`);
                
                const server = await device.gatt.connect();
                logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
                
                try {
                    const heartRateService = await server.getPrimaryService('heart_rate');
                    const heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
                    await heartRateCharacteristic.startNotifications();
                    heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
                    logEvent('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨');
                } catch (e) {
                    console.warn('Ø®Ø¯Ù…Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­Ø©', e);
                }
                
                try {
                    const bpService = await server.getPrimaryService('blood_pressure');
                    const bpCharacteristic = await bpService.getCharacteristic('blood_pressure_measurement');
                    await bpCharacteristic.startNotifications();
                    bpCharacteristic.addEventListener('characteristicvaluechanged', handleBloodPressure);
                    logEvent('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…');
                } catch (e) {
                    console.warn('Ø®Ø¯Ù…Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­Ø©', e);
                }
                
                try {
                    const batteryService = await server.getPrimaryService('battery_service');
                    const batteryCharacteristic = await batteryService.getCharacteristic('battery_level');
                    await batteryCharacteristic.startNotifications();
                    batteryCharacteristic.addEventListener('characteristicvaluechanged', handleBatteryLevel);
                    logEvent('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©');
                } catch (e) {
                    console.warn('Ø®Ø¯Ù…Ø© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©', e);
                }
                
                deviceConnected = true;
                document.getElementById('connBadge').textContent = `Ø¬Ù‡Ø§Ø²: ${device.name}`;
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
                
                device.addEventListener('gattserverdisconnected', () => {
                    logEvent('ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', 'danger');
                    deviceConnected = false;
                    document.getElementById('connBadge').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                    document.getElementById('connBadge').className = 'badge badge-bad inline-block mt-1';
                    
                    setTimeout(() => {
                        if (!deviceConnected && $('autoReconnect').checked) {
                            logEvent('Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
                            connectToDevice();
                        }
                    }, 5000);
                });
                
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²:', error);
                logEvent('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', 'danger');
                return false;
            }
        }

        async function connectToWiFiDevice() {
            try {
                logEvent('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¬Ù‡Ø²Ø© WiFi...');
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² WiFi');
                
                deviceConnected = true;
                document.getElementById('connBadge').textContent = 'Ø¬Ù‡Ø§Ø² WiFi';
                document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
                
                const simulateWiFiData = () => {
                    if (!deviceConnected) return;
                    
                    const v = simulateVitals();
                    render(v);
                    pushToFirebase(v);
                    
                    setTimeout(simulateWiFiData, 2000);
                };
                
                simulateWiFiData();
                
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² WiFi:', error);
                logEvent('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² WiFi', 'danger');
                return false;
            }
        }

        function startSimulationMode() {
            timer = setInterval(async () => {
                const v = simulateVitals();
                render(v);
                pushToFirebase(v);
            }, 1000);
            
            if (!window.__ecgAnim) {
                const step = () => { 
                    if (timer) drawAllECGs(history.at(-1)?.hr || 80); 
                    window.__ecgAnim = requestAnimationFrame(step); 
                };
                step();
            }
            
            document.getElementById('connBadge').textContent = 'Ù…Ø­Ø§ÙƒØ§Ø©';
            document.getElementById('connBadge').className = 'badge badge-warn inline-block mt-1';
        }

        // =============== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===============
        window.addEventListener('load', async () => {
            notificationSystem.loadSettings();
            visualizationSystem.initializeCharts();
            
            logEvent('Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
            startSimulationMode();
        });
    </script>
</body>
</html>
