<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { @apply rounded-2xl shadow-lg p-5 bg-white; }
    .metric { @apply text-3xl font-extrabold tracking-tight; }
    .label { @apply text-sm text-gray-500; }
    .soft { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
    .badge-ok { @apply bg-green-100 text-green-700; }
    .badge-warn { @apply bg-yellow-100 text-yellow-700; }
    .badge-bad { @apply bg-red-100 text-red-700; }
    canvas { image-rendering: pixelated; }
    .loading { @apply animate-pulse bg-gray-200; }
  </style>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Firebase (Compat CDN: Ø³Ù‡Ù„ Ø¯Ù…Ø¬Ù‡ ÙÙŠ ØµÙØ­Ø© HTML ÙˆØ§Ø­Ø¯Ø©) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white grid place-items-center soft">ğŸ«€</div>
        <div>
          <h1 class="text-xl md:text-2xl font-extrabold text-slate-800">Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø°ÙƒÙŠ â€“ Smart Patient Monitor</h1>
          <p class="text-xs text-slate-500">Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø­Ø¸ÙŠØ© + ØªÙ†Ø¨ÙŠÙ‡ Ø°ÙƒÙŠ + Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</p>
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span id="patientIdBadge" class="badge badge-warn">ID: â€”</span>
        <a id="backLink" href="#" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">Ø±Ø¬ÙˆØ¹ Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶</a>
      </div>
    </div>
  </header>
  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Patient strip -->
    <section class="card grid md:grid-cols-4 gap-4 items-center">
      <div class="md:col-span-2">
        <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ø±ÙŠØ¶</div>
        <div class="text-2xl font-bold text-slate-800"><span id="patientName">â€”</span></div>
        <div class="text-xs text-slate-500">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="patientDept">â€”</span></div>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div class="text-center bg-slate-50 rounded-xl p-3">
          <div class="label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <div id="aiStatusBadge" class="badge badge-warn inline-block mt-1">ØºÙŠØ± Ù…ØªØµÙ„</div>
        </div>
        <div class="text-center bg-slate-50 rounded-xl p-3">
          <div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± (0â€“100)</div>
          <div id="riskScore" class="metric">â€”</div>
        </div>
        <div class="text-center bg-slate-50 rounded-xl p-3">
          <div class="label">Ø§ØªØµØ§Ù„</div>
          <div id="connBadge" class="badge badge-bad inline-block mt-1">ØºÙŠØ± Ù…ØªØµÙ„</div>
        </div>
      </div>
    </section>
    <!-- Metrics -->
    <section class="grid md:grid-cols-5 gap-4">
      <div class="card">
        <div class="label">Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (bpm)</div>
        <div id="hrVal" class="metric">â€”</div>
        <div id="hrState" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">Ø§Ù„Ø¶ØºØ· (SYS/DIA mmHg)</div>
        <div id="bpVal" class="metric">â€”</div>
        <div id="bpState" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† SpOâ‚‚ (%)</div>
        <div id="spo2Val" class="metric">â€”</div>
        <div id="spo2State" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†ÙØ³ (rpm)</div>
        <div id="rrVal" class="metric">â€”</div>
        <div id="rrState" class="text-xs mt-1"></div>
      </div>
      <div class="card">
        <div class="label">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</div>
        <div id="tempVal" class="metric">â€”</div>
        <div id="tempState" class="text-xs mt-1"></div>
      </div>
    </section>
    <!-- ECG -->
    <section class="card">
      <div class="flex items-center justify-between">
        <div class="label">ECG â€“ Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ù„Ø¨</div>
        <div class="text-xs text-slate-400">Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø±ÙŠØ¶</div>
      </div>
      <canvas id="ecg" class="w-full h-40 bg-black rounded-xl mt-3"></canvas>
    </section>
    <!-- AI Diagnosis Section -->
    <section id="diagnosis-container" class="card">
      <div class="font-bold mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø°ÙƒÙŠ</div>
      <div class="text-gray-500">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </section>
    <!-- AI Predictions Section -->
    <section id="trends-container" class="card">
      <div class="font-bold mb-2">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª</div>
      <div class="text-gray-500">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </section>
    <!-- AI Recommendations Section -->
    <section id="ml-container" class="card">
      <div class="font-bold mb-2">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
      <div class="text-gray-500">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </section>
    <!-- Controls & Thresholds -->
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="card space-y-3">
        <div class="font-bold">Ø§Ù„ØªØ­ÙƒÙ…</div>
        <div class="flex flex-wrap gap-2">
          <button id="connectBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø±ÙŠØ¶</button>
          <button id="disconnectBtn" class="px-4 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-700" disabled>ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„</button>
          <button id="snapBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù†</button>
          <label class="inline-flex items-center gap-2 text-sm ml-auto">
            <input id="autoAlerts" type="checkbox" class="w-4 h-4" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ
          </label>
        </div>
        <p class="text-xs text-slate-500">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ Ø³ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ/Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø±.</p>
      </div>
      <div class="card lg:col-span-2">
        <div class="font-bold mb-3">Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
        <div class="grid md:grid-cols-5 gap-3 text-sm">
          <div>
            <div class="label">HR</div>
            <div class="flex gap-2"><input id="hrMin" class="w-full border rounded-xl px-3 py-2" value="50"><input id="hrMax" class="w-full border rounded-xl px-3 py-2" value="120"></div>
          </div>
          <div>
            <div class="label">SYS</div>
            <div class="flex gap-2"><input id="sysMin" class="w-full border rounded-xl px-3 py-2" value="90"><input id="sysMax" class="w-full border rounded-xl px-3 py-2" value="140"></div>
          </div>
          <div>
            <div class="label">DIA</div>
            <div class="flex gap-2"><input id="diaMin" class="w-full border rounded-xl px-3 py-2" value="55"><input id="diaMax" class="w-full border rounded-xl px-3 py-2" value="90"></div>
          </div>
          <div>
            <div class="label">SpOâ‚‚</div>
            <div class="flex gap-2"><input id="spo2Min" class="w-full border rounded-xl px-3 py-2" value="92"><input id="spo2Max" class="w-full border rounded-xl px-3 py-2" value="100"></div>
          </div>
          <div>
            <div class="label">RR / Temp</div>
            <div class="flex gap-2"><input id="rrMin" class="w-full border rounded-xl px-3 py-2" value="10"><input id="rrMax" class="w-full border rounded-xl px-3 py-2" value="24"></div>
            <div class="flex gap-2 mt-2"><input id="tempMin" class="w-full border rounded-xl px-3 py-2" value="36"><input id="tempMax" class="w-full border rounded-xl px-3 py-2" value="37.8"></div>
          </div>
        </div>
      </div>
    </section>
    <!-- Alerts log -->
    <section class="card">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold">Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
        <button id="clearLog" class="text-sm px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
      </div>
      <div id="log" class="text-sm space-y-1 max-h-44 overflow-auto"></div>
    </section>
  </main>
  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-400">
    Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©
  </footer>
  <script>
   // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Ø¬Ù„Ø¨ patientId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
  const params = new URLSearchParams(window.location.search);
  const patientId = params.get('id');

  if (patientId) {
    const patientRef = db.ref(`patients/${patientId}`);

    patientRef.on('value', snapshot => {
      if (!snapshot.exists()) {
        Swal.fire('âŒ', 'Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        return;
      }
      const data = snapshot.val();
    
    // =============== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===============
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d=0) => Number(n).toFixed(d);
    const nowIso = () => new Date().toISOString();
    
    // Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø·
    function getQueryParam(key) {
      const u = new URL(window.location.href);
      return u.searchParams.get(key);
    }
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const patientId = getQueryParam('id');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶
    if (!patientId) {
      console.error('Patient ID is missing');
    } else {
      console.log('Patient ID:', patientId);
      
      // Ø¹Ø±Ø¶ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
      $('patientIdBadge').textContent = 'ID: ' + patientId;
      
      // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
      $('backLink').href = `patient.html?id=${encodeURIComponent(patientId)}`;
    }
    
    // =============== Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) ===============
    const limits = {
      hr: { min: 50, max: 120 },
      sys: { min: 90, max: 140 },
      dia: { min: 55, max: 90 },
      spo2: { min: 92, max: 100 },
      rr: { min: 10, max: 24 },
      temp: { min: 36.0, max: 37.8 }
    };
    function readLimits() {
      limits.hr.min = +$('hrMin').value; limits.hr.max = +$('hrMax').value;
      limits.sys.min = +$('sysMin').value; limits.sys.max = +$('sysMax').value;
      limits.dia.min = +$('diaMin').value; limits.dia.max = +$('diaMax').value;
      limits.spo2.min = +$('spo2Min').value; limits.spo2.max = +$('spo2Max').value;
      limits.rr.min = +$('rrMin').value; limits.rr.max = +$('rrMax').value;
      limits.temp.min = +$('tempMin').value; limits.temp.max = +$('tempMax').value;
    }
    
    // =============== ECG Ø±Ø³Ù… ===============
    const ecgCanvas = $('ecg');
    const ecgCtx = ecgCanvas.getContext('2d');
    function resizeCanvas() {
      ecgCanvas.width = ecgCanvas.clientWidth;
      ecgCanvas.height = ecgCanvas.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    let t = 0; // Ø²Ù…Ù† Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ù€ ECG
    
    function drawECG(hr) {
      const w = ecgCanvas.width, h = ecgCanvas.height;
      const ctx = ecgCtx;
      // scroll effect
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, w, h);
      // grid
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 1;
      for (let gx = 0; gx < w; gx += 20) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
      for (let gy = 0; gy < h; gy += 20) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
      // waveform
      ctx.strokeStyle = '#22c55e';
      ctx.lineWidth = 2;
      ctx.beginPath();
      let bpm = hr || 80;
      let period = Math.max(0.4, 60 / bpm); // seconds per beat
      let samples = w;
      for (let i = 0; i < samples; i++) {
        let x = i;
        let tt = (t + i / 120); // time in seconds @120Hz
        let phase = (tt % period) / period;
        // simple synthetic heartbeat: P, QRS, T
        let y = 0.02 * Math.sin(2 * Math.PI * phase * 5); // baseline
        if (phase > 0.1 && phase < 0.14) y += -0.5; // Q dip
        if (phase >= 0.14 && phase < 0.18) y += 1.4; // R spike
        if (phase >= 0.18 && phase < 0.22) y += -0.3; // S dip
        if (phase > 0.28 && phase < 0.36) y += 0.25 * Math.sin(Math.PI * (phase - 0.28) / 0.08);
        // noise
        y += (Math.random() - 0.5) * 0.02;
        let yy = h * (0.5 - y * 0.35);
        if (i === 0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
      }
      ctx.stroke();
      t += 1/60; // advance time ~60 FPS
    }
    
    // =============== Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ===============
    const history = [];
    const MAX_HIST = 120; // Ø¢Ø®Ø± Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† (Ø¨Ø§ÙØªØ±Ø§Ø¶ 1 Ù‚Ø±Ø§Ø¡Ø©/Ø«)
    
    function riskScoreFrom(v) {
      readLimits();
      // Ø­Ø³Ø§Ø¨ Ø§Ù†Ø­Ø±Ø§Ù ÙƒÙ„ Ù…Ø¤Ø´Ø± Ø¹Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ + ØªØ±Ù†Ø¯ Ø¨Ø³ÙŠØ·
      const dev = (val, {min, max}) => val < min ? (min - val) / (min || 1) : (val > max ? (val - max) / (max || 1) : 0);
      let s = 0;
      s += 35 * Math.min(2, dev(v.hr, limits.hr));
      s += 18 * Math.min(2, dev(v.sys, limits.sys));
      s += 12 * Math.min(2, dev(v.dia, limits.dia));
      s += 25 * Math.min(2, dev(v.spo2, limits.spo2));
      s += 5  * Math.min(2, dev(v.rr, limits.rr));
      s += 5  * Math.min(2, dev(v.temp, limits.temp));
      // ØªØ±Ù†Ø¯: Ø¥Ø°Ø§ Ø­Ø¯Ø« Ù‡Ø¨ÙˆØ· Ù…ØªØªØ§Ù„Ù ÙÙŠ SpO2 Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù…ØªØªØ§Ù„Ù ÙÙŠ HR
      const n = history.length;
      if (n >= 6) {
        const trendHr = history.slice(-6).map(x=>x.hr);
        const trendSp = history.slice(-6).map(x=>x.spo2);
        const dHr = trendHr[5]-trendHr[0];
        const dSp = trendSp[0]-trendSp[5];
        if (dHr > 12) s += 10;
        if (dSp > 3) s += 15;
      }
      return Math.max(0, Math.min(100, Math.round(s)));
    }
    
    function setStatus(score, v) {
      const badge = $('aiStatusBadge');
      let label = 'Ù…Ø³ØªÙ‚Ø±Ø©', cls = 'badge badge-ok';
      if (score >= 70) { label = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹'; cls = 'badge badge-bad'; }
      else if (score >= 35) { label = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·'; cls = 'badge badge-warn'; }
      badge.textContent = label; badge.className = cls + ' inline-block';
      $('riskScore').textContent = String(score);
      // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù…Ø®ØªØµØ±Ø© Ù„ÙƒÙ„ Ù…Ø¤Ø´Ø±
      const within = (v, lim) => (v >= lim.min && v <= lim.max);
      $('hrState').textContent   = within(v.hr, limits.hr)   ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
      $('bpState').textContent   = within(v.sys, limits.sys) && within(v.dia, limits.dia) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
      $('spo2State').textContent = within(v.spo2, limits.spo2) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
      $('rrState').textContent   = within(v.rr, limits.rr)   ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
      $('tempState').textContent = within(v.temp, limits.temp) ? 'Ø³Ù„ÙŠÙ…' : 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚';
    }
    
    // =============== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ===============
    function predictTrends() {
      if (history.length < 10) return null;
      
      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©
      const recentData = history.slice(-10);
      const hrTrend = calculateTrend(recentData.map(d => d.hr));
      const spo2Trend = calculateTrend(recentData.map(d => d.spo2));
      
      // Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø®Ù„Ø§Ù„ Ø§Ù„Ù€ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
      return {
        hrPrediction: recentData[recentData.length - 1].hr + (hrTrend * 5),
        spo2Prediction: recentData[recentData.length - 1].spo2 + (spo2Trend * 5),
        deteriorationRisk: hrTrend > 2 || spo2Trend < -1
      };
    }

    function calculateTrend(values) {
      // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØºÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
      let changes = 0;
      for (let i = 1; i < values.length; i++) {
        changes += values[i] - values[i-1];
      }
      return changes / (values.length - 1);
    }

    function diagnoseCondition(vitals) {
      const { hr, sys, dia, spo2, rr, temp } = vitals;
      const diagnosis = [];
      
      // ØªØ´Ø®ÙŠØµ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù‚Ù„Ø¨
      if (hr > 120) {
        diagnosis.push({
          condition: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨",
          severity: sys > 140 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…ØªÙˆØ³Ø·",
          recommendation: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù… ÙˆØ§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ¨"
        });
      } else if (hr < 50) {
        diagnosis.push({
          condition: "Ø¨Ø·Ø¡ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨",
          severity: "Ù…ØªÙˆØ³Ø·",
          recommendation: "ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ù„Ø¨"
        });
      }
      
      // ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙ†ÙØ³
      if (spo2 < 92) {
        diagnosis.push({
          condition: "Ø§Ù†Ø®ÙØ§Ø¶ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†",
          severity: spo2 < 88 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…ØªÙˆØ³Ø·",
          recommendation: rr > 24 ? "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙ†ÙØ³" : "ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†"
        });
      }
      
      // ØªØ´Ø®ÙŠØµ Ø§Ù„Ø­Ù…Ù‰
      if (temp > 37.8) {
        diagnosis.push({
          condition: "Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©",
          severity: temp > 39 ? "Ø¹Ø§Ù„ÙŠ" : "Ù…Ù†Ø®ÙØ¶",
          recommendation: "ØªØ®ÙÙŠØ¶ Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¯ÙˆÙ‰"
        });
      }
      
      return diagnosis;
    }

    async function analyzeWithML(vitals) {
      // Ù…Ø­Ø§ÙƒØ§Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      const mlResult = {
        riskLevel: Math.random() > 0.7 ? "high" : Math.random() > 0.4 ? "medium" : "low",
        possibleConditions: [
          { name: "Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…", probability: vitals.sys > 140 ? 0.85 : 0.45 },
          { name: "Ù‚Ù„Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†", probability: vitals.spo2 < 95 ? 0.75 : 0.25 },
          { name: "ØªØ³Ø§Ø±Ø¹ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨", probability: vitals.hr > 100 ? 0.80 : 0.30 }
        ],
        recommendations: [
          "Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ø¶ØºØ·",
          "Ù‚ÙŠØ§Ø³ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©",
          "ÙØ­Øµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ù„Ø¨ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ø­Ø§Ù„Ø©"
        ]
      };
      
      return mlResult;
    }

    function displayDiagnosis(diagnosis) {
      const diagnosisContainer = document.getElementById('diagnosis-container');
      diagnosisContainer.innerHTML = '';
      
      if (diagnosis.length === 0) {
        diagnosisContainer.innerHTML = '<div class="text-green-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚</div>';
        return;
      }
      
      diagnosis.forEach(item => {
        const div = document.createElement('div');
        div.className = `p-3 mb-2 rounded-lg ${item.severity === 'Ø¹Ø§Ù„ÙŠ' ? 'bg-red-100' : 'bg-yellow-100'}`;
        div.innerHTML = `
          <div class="font-bold">${item.condition}</div>
          <div class="text-sm">Ø§Ù„Ø´Ø¯Ø©: ${item.severity}</div>
          <div class="text-sm">Ø§Ù„ØªÙˆØµÙŠØ©: ${item.recommendation}</div>
        `;
        diagnosisContainer.appendChild(div);
      });
    }

    function displayTrends(trends) {
      const trendsContainer = document.getElementById('trends-container');
      
      if (!trends) {
        trendsContainer.innerHTML = '<div class="text-gray-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ†Ø¨Ø¤</div>';
        return;
      }
      
      trendsContainer.innerHTML = `
        <div class="mb-2">
          <div class="font-bold">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª Ø®Ù„Ø§Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚:</div>
          <div>Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${Math.round(trends.hrPrediction)} bpm</div>
          <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${Math.round(trends.spo2Prediction)}%</div>
          ${trends.deteriorationRisk ? '<div class="text-red-600 font-bold">ØªØ­Ø°ÙŠØ±: Ù‡Ù†Ø§Ùƒ Ø§Ø­ØªÙ…Ø§Ù„ Ù„ØªØ¯Ù‡ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©!</div>' : ''}
        </div>
      `;
    }

    function displayMLRecommendations(mlAnalysis) {
      const mlContainer = document.getElementById('ml-container');
      
      mlContainer.innerHTML = `
        <div class="mb-2">
          <div class="font-bold">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:</div>
          <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${mlAnalysis.riskLevel === 'high' ? 'Ø¹Ø§Ù„ÙŠ' : mlAnalysis.riskLevel === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶'}</div>
          <div class="mt-2">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:</div>
          <ul>
            ${mlAnalysis.possibleConditions.map(cond => 
              `<li>${cond.name} (${Math.round(cond.probability * 100)}%)</li>`
            ).join('')}
          </ul>
          <div class="mt-2">ØªÙˆØµÙŠØ§Øª:</div>
          <ul>
            ${mlAnalysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
          </ul>
        </div>
      `;
    }
    
    // =============== Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ===============
    function logEvent(txt, level='info') {
      const row = document.createElement('div');
      const t = new Date().toLocaleTimeString();
      row.className = 'flex items-center gap-2';
      const dot = document.createElement('span'); dot.className = 'w-2.5 h-2.5 rounded-full ' + (level==='danger'? 'bg-rose-500' : level==='warn'? 'bg-amber-500':'bg-slate-400');
      const msg = document.createElement('span'); msg.textContent = `[${t}] ${txt}`;
      row.appendChild(dot); row.appendChild(msg);
      $('log').prepend(row);
    }
    
    function alertIfNeeded(score, v) {
      if (!$('autoAlerts').checked) return;
      if (score < 35) return;
      const title = score >= 70 ? 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹' : 'ØªÙ†Ø¨ÙŠÙ‡';
      const icon = score >= 70 ? 'error' : 'warning';
      const text = `HR:${v.hr} | BP:${v.sys}/${v.dia} | SpOâ‚‚:${v.spo2}%`;
      Swal.fire({ title, text, icon, toast: true, position: 'top-end', timer: 3500, showConfirmButton: false });
      logEvent(`${title}: ${text}`, score>=70? 'danger':'warn');
      // ØµÙˆØª Ø¨Ø³ÙŠØ·
      try { 
        const be = new AudioContext(); 
        const o = be.createOscillator(); 
        const g = be.createGain(); 
        o.type='square'; 
        o.frequency.value = score>=70? 880: 660; 
        o.connect(g); 
        g.connect(be.destination); 
        g.gain.setValueAtTime(0.001, be.currentTime); 
        g.gain.exponentialRampToValueAtTime(0.15, be.currentTime+0.02); 
        o.start(); 
        o.stop(be.currentTime+0.2);
      } catch(e){}
    }
    
    // =============== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===============
    async function pushToFirebase(v) {
      if (!fb.enabled) return;
      const base = `/patients/${patientId}`;
      const ts = Date.now();
      const rec = { ...v, ts, iso: nowIso(), risk: riskScoreFrom(v) };
      await fb.db.ref(`${base}/vitalsStream/${ts}`).set(rec);
      await fb.db.ref(`${base}/latestVitals`).set(rec);
    }
    
    // =============== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ===============
    let deviceConnected = false;
    let bluetoothDevice = null;
    let currentVitals = {
      hr: null,
      sys: null,
      dia: null,
      spo2: null,
      rr: null,
      temp: null
    };

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨
    function handleHeartRate(event) {
      const value = event.target.value;
      const flags = value.getUint8(0);
      let offset = 1;
      
      // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨
      let hr;
      if (flags & 0x01) {
        // HR format UINT16
        hr = value.getUint16(offset, true);
        offset += 2;
      } else {
        // HR format UINT8
        hr = value.getUint8(offset);
        offset += 1;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
      currentVitals.hr = hr;
      
      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      checkAndUpdateDisplay();
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¶ØºØ· Ø§Ù„Ø¯Ù…
    function handleBloodPressure(event) {
      const value = event.target.value;
      const flags = value.getUint8(0);
      let offset = 1;
      
      // Ù‚Ø±Ø§Ø¡Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…
      let sys, dia;
      
      if (flags & 0x01) {
        // Unit is kPa
        sys = value.getUint16(offset, true) * 0.00750061683;
        offset += 2;
        dia = value.getUint16(offset, true) * 0.00750061683;
        offset += 2;
      } else {
        // Unit is mmHg
        sys = value.getUint16(offset, true);
        offset += 2;
        dia = value.getUint16(offset, true);
        offset += 2;
      }
      
      // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚ÙŠÙ…
      sys = Math.round(sys);
      dia = Math.round(dia);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
      currentVitals.sys = sys;
      currentVitals.dia = dia;
      
      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      checkAndUpdateDisplay();
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    function checkAndUpdateDisplay() {
      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      if (currentVitals.hr !== null && 
          currentVitals.sys !== null && 
          currentVitals.dia !== null) {
        
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø£Ùˆ Ø§Ù„ØªÙ†ÙØ³ Ø£Ùˆ Ø§Ù„Ø­Ø±Ø§Ø±Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        if (currentVitals.spo2 === null) currentVitals.spo2 = 98;
        if (currentVitals.rr === null) currentVitals.rr = 16;
        if (currentVitals.temp === null) currentVitals.temp = 36.6;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        render(currentVitals);
        pushToFirebase(currentVitals);
      }
    }

    // =============== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ===============
    async function loadPatientData() {
      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶
        if (!patientId) {
          console.error('Patient ID is missing');
          Swal.fire({
            title: 'Ø®Ø·Ø£',
            text: 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø±ÙŠØ¶. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶.',
            icon: 'error',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
          });
          return;
        }
        
        console.log(`Loading data for patient: ${patientId}`);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Firebase
        if (!fb.enabled) {
          throw new Error('Firebase is not enabled');
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const patientSnap = await fb.db.ref(`/patients/${patientId}/basic`).get();
        const patientData = patientSnap.val();
        
        console.log('Patient data:', patientData);
        
        if (!patientData) {
          throw new Error(`Patient not found: ${patientId}`);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
        $('patientName').textContent = patientData.name || 'â€”';
        
        // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…
        if (patientData.department) {
          const deptSnap = await fb.db.ref(`/departments/${patientData.department}`).get();
          const deptData = deptSnap.val();
          
          if (deptData) {
            console.log('Department data:', deptData);
            $('patientDept').textContent = deptData.name || 'â€”';
          } else {
            console.warn(`Department not found: ${patientData.department}`);
            $('patientDept').textContent = 'â€”';
          }
        } else {
          console.warn('Patient has no department assigned');
          $('patientDept').textContent = 'â€”';
        }
        
        // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
        window.currentPatient = patientData;
        
        // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
        const latestVitalsSnap = await fb.db.ref(`/patients/${patientId}/latestVitals`).get();
        const latestVitals = latestVitalsSnap.val();
        
        console.log('Latest vitals:', latestVitals);
        
        if (latestVitals) {
          // Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª
          $('hrVal').textContent = latestVitals.hr + ' bpm';
          $('bpVal').textContent = `${latestVitals.sys}/${latestVitals.dia}`;
          $('spo2Val').textContent = latestVitals.spo2 + ' %';
          $('rrVal').textContent = latestVitals.rr + ' rpm';
          $('tempVal').textContent = latestVitals.temp + ' Â°C';
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
          const score = riskScoreFrom(latestVitals);
          setStatus(score, latestVitals);
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
          const badge = $('aiStatusBadge');
          let label = 'Ù…Ø³ØªÙ‚Ø±Ø©', cls = 'badge badge-ok';
          if (score >= 70) { label = 'Ø®Ø·Ø± Ù…Ø±ØªÙØ¹'; cls = 'badge badge-bad'; }
          else if (score >= 35) { label = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·'; cls = 'badge badge-warn'; }
          badge.textContent = label; 
          badge.className = cls + ' inline-block mt-1';
          $('riskScore').textContent = String(score);
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
          document.getElementById('connBadge').textContent = 'Firebase';
          document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
          document.getElementById('patientIdBadge').className = 'badge badge-ok inline-block mt-1';
        } else {
          console.warn('No latest vitals found for patient');
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        const deptsSnap = await fb.db.ref('/departments').get();
        const departments = deptsSnap.val();
        
        if (departments) {
          console.log('Departments loaded:', departments);
          window.departments = departments;
        } else {
          console.warn('No departments found in database');
        }
        
      } catch (error) {
        console.error('Error loading patient data:', error);
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        Swal.fire({
          title: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
          text: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
          icon: 'error',
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
        });
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
        $('patientName').textContent = 'â€”';
        $('patientDept').textContent = 'â€”';
        $('hrVal').textContent = 'â€”';
        $('bpVal').textContent = 'â€”';
        $('spo2Val').textContent = 'â€”';
        $('rrVal').textContent = 'â€”';
        $('tempVal').textContent = 'â€”';
        $('riskScore').textContent = 'â€”';
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        document.getElementById('connBadge').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        document.getElementById('connBadge').className = 'badge badge-bad inline-block mt-1';
        document.getElementById('patientIdBadge').className = 'badge badge-bad inline-block mt-1';
      }
    }

    // =============== Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ===============
    async function render(v) {
      $('hrVal').textContent   = v.hr + ' bpm';
      $('bpVal').textContent   = `${v.sys}/${v.dia}`;
      $('spo2Val').textContent = v.spo2 + ' %';
      $('rrVal').textContent   = v.rr + ' rpm';
      $('tempVal').textContent = v.temp + ' Â°C';
      drawECG(v.hr);
      
      history.push(v); 
      if (history.length > MAX_HIST) history.shift();
      
      const score = riskScoreFrom(v);
      setStatus(score, v);
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
      const diagnosis = diagnoseCondition(v);
      const trends = predictTrends();
      const mlAnalysis = await analyzeWithML(v);
      
      // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ´Ø®ÙŠØµ
      displayDiagnosis(diagnosis);
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
      displayTrends(trends);
      
      // Ø¹Ø±Ø¶ ØªÙˆØµÙŠØ§Øª ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„Ø©
      displayMLRecommendations(mlAnalysis);
      
      alertIfNeeded(score, v);
    }
    
    // =============== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ===============
    // Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²
    $('connectBtn').addEventListener('click', async () => {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù€ Web Bluetooth API
      if (!navigator.bluetooth) {
        Swal.fire({
          title: 'Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…',
          text: 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Bluetooth. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Chrome Ø£Ùˆ Edge.',
          icon: 'error',
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
        });
        return;
      }
      
      try {
        logEvent('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ±...');
        
        // Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø¨Ù„ÙˆØªÙˆØ« ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ¶ØºØ· Ø§Ù„Ø¯Ù…
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['heart_rate'] },
            { services: ['blood_pressure'] }
          ],
          optionalServices: ['battery_service']
        });
        
        logEvent(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Ø²: ${bluetoothDevice.name}`);
        
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²
        const server = await bluetoothDevice.gatt.connect();
        logEvent('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨
        try {
          const heartRateService = await server.getPrimaryService('heart_rate');
          const heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
          
          // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨
          await heartRateCharacteristic.startNotifications();
          heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
          logEvent('ØªÙ… ØªÙØ¹ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨');
        } catch (error) {
          console.error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø®Ø¯Ù…Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨:', error);
          logEvent('Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨', 'warn');
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…
        try {
          const bpService = await server.getPrimaryService('blood_pressure');
          const bpCharacteristic = await bpService.getCharacteristic('blood_pressure_measurement');
          
          // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¶ØºØ· Ø§Ù„Ø¯Ù…
          await bpCharacteristic.startNotifications();
          bpCharacteristic.addEventListener('characteristicvaluechanged', handleBloodPressure);
          logEvent('ØªÙ… ØªÙØ¹ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¶ØºØ· Ø§Ù„Ø¯Ù…');
        } catch (error) {
          console.error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø®Ø¯Ù…Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…:', error);
          logEvent('Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‚Ø±Ø§Ø¡Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…', 'warn');
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        try {
          const batteryService = await server.getPrimaryService('battery_service');
          const batteryCharacteristic = await batteryService.getCharacteristic('battery_level');
          
          // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
          const batteryValue = await batteryCharacteristic.readValue();
          const batteryLevel = batteryValue.getUint8(0);
          logEvent(`Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${batteryLevel}%`);
        } catch (error) {
          console.log('Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‚Ø±Ø§Ø¡Ø© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©');
        }
        
        deviceConnected = true;
        document.getElementById('connBadge').textContent = 'Ø¬Ù‡Ø§Ø² Ø¨Ù„ÙˆØªÙˆØ«';
        document.getElementById('connBadge').className = 'badge badge-ok inline-block mt-1';
        
        // ØªÙØ¹ÙŠÙ„ Ø²Ø± ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„
        $('disconnectBtn').disabled = false;
        $('connectBtn').disabled = true;
        
        // Ø¨Ø¯Ø¡ Ø±Ø³Ù… ECG
        if (!window.__ecgAnim) {
          const step = () => { 
            if (deviceConnected && currentVitals.hr) {
              drawECG(currentVitals.hr);
            }
            window.__ecgAnim = requestAnimationFrame(step); 
          };
          step();
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        Swal.fire({
          title: 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­',
          text: `ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² ${bluetoothDevice.name}`,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
        
      } catch (error) {
        console.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²:', error);
        logEvent('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²', 'danger');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        Swal.fire({
          title: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„',
          text: 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ù‚Ø±ÙŠØ¨ ÙˆÙ…ÙØ¹Ù‘Ù„.',
          icon: 'error',
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
        });
      }
    });

    // Ø²Ø± ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„
    $('disconnectBtn').addEventListener('click', async () => {
      if (bluetoothDevice && bluetoothDevice.gatt.connected) {
        await bluetoothDevice.gatt.disconnect();
        logEvent('ØªÙ… ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø²');
        
        deviceConnected = false;
        document.getElementById('connBadge').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        document.getElementById('connBadge').className = 'badge badge-bad inline-block mt-1';
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø±Ø³Ù… ECG
        if (window.__ecgAnim) {
          cancelAnimationFrame(window.__ecgAnim);
          window.__ecgAnim = null;
        }
        
        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„ÙØµÙ„
        $('connectBtn').disabled = false;
        $('disconnectBtn').disabled = true;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…
        currentVitals = {
          hr: null,
          sys: null,
          dia: null,
          spo2: null,
          rr: null,
          temp: null
        };
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
        Swal.fire({
          title: 'ØªÙ… ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„',
          text: 'ØªÙ… ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…ÙˆÙ†ÙŠØªÙˆØ±',
          icon: 'info',
          timer: 1500,
          showConfirmButton: false
        });
      }
    });

    // Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
    $('snapBtn').addEventListener('click', async () => {
      if (!deviceConnected || !currentVitals.hr) {
        Swal.fire({
          title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
          text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ© Ù„Ø­ÙØ¸Ù‡Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø².',
          icon: 'warning',
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
        });
        return;
      }
      
      render(currentVitals);
      await pushToFirebase(currentVitals);
      
      Swal.fire({ 
        title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', 
        text: 'ØªÙ… Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø© Ù„Ø­Ø¸ÙŠØ© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶', 
        icon: 'success', 
        timer: 1800, 
        showConfirmButton: false 
      });
      
      logEvent(`ØªÙ… Ø­ÙØ¸ Ù‚Ø±Ø§Ø¡Ø© HR:${currentVitals.hr} BP:${currentVitals.sys}/${currentVitals.dia} SpOâ‚‚:${currentVitals.spo2}%`);
    });
    
    // Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
    $('clearLog').addEventListener('click', () => {
      $('log').innerHTML = '';
    });
    
    // =============== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===============
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM loaded, initializing monitor...');
      
      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
      await loadPatientData();
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
      window.addEventListener('beforeunload', () => {
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
          bluetoothDevice.gatt.disconnect();
        }
      });
    });
  </script>
</body>
</html>
