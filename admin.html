<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ููุญุฉ ุชุญูู ูุฏูุฑ ุงููุณุชุดูู</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, update, push, set, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

// ุฅุนุฏุงุฏุงุช Firebase
const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};

// ุชููุฆุฉ Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ุงูุงูุชูุงู ุจูู ุงูุฃูุณุงู
function setupNavigation() {
  const sections = document.querySelectorAll(".section");
  const navLinks = document.querySelectorAll(".nav-link");
  
  navLinks.forEach(link => {
    link.addEventListener("click", () => {
      sections.forEach(sec => sec.classList.add("hidden"));
      document.getElementById(link.dataset.target).classList.remove("hidden");
      
      navLinks.forEach(l => l.classList.remove("bg-blue-600", "text-white"));
      link.classList.add("bg-blue-600", "text-white");
    });
  });
}

// ุฅุฏุงุฑุฉ ุงููุฑุถู
const patientManager = {
  init() {
    this.setupEventListeners();
    this.loadPatients();
  },
  
  setupEventListeners() {
    const searchInput = document.getElementById("searchPatient");
    searchInput.addEventListener("input", () => this.handleSearch(searchInput.value));
  },
  
  loadPatients() {
    const patientsRef = ref(db, "patients");
    const patientsTable = document.getElementById("patientsTable");
    
    onValue(patientsRef, (snapshot) => {
      const data = snapshot.val();
      let countPatients = 0;
      let countVisits = 0;
      let departmentSet = new Set();
      const allPatients = [];
      
      if (data) {
        Object.entries(data).forEach(([department, patients]) => {
          departmentSet.add(department);
          Object.entries(patients).forEach(([id, patient]) => {
            countPatients++;
            if (patient.visits) countVisits += Object.keys(patient.visits).length;
            allPatients.push({ id, department, ...patient });
          });
        });
        
        this.renderPatients(allPatients);
        this.updateStats(countPatients, departmentSet.size, countVisits);
      }
    });
  },
  
  renderPatients(patients) {
    const patientsTable = document.getElementById("patientsTable");
    patientsTable.innerHTML = "";
    
    patients.forEach(patient => {
      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50 text-sm";
      row.innerHTML = `
        <td class="border p-2">${patient.name}</td>
        <td class="border p-2">${patient.age}</td>
        <td class="border p-2">${patient.department}</td>
        <td class="border p-2">${new Date(patient.timestamp).toLocaleString("ar-EG")}</td>
        <td class="border p-2 flex gap-2 justify-center">
          <button class="detailsBtn text-blue-600 hover:underline" data-id="${patient.id}" data-department="${patient.department}">
            <i class="fas fa-info-circle mr-1"></i> ุชูุงุตูู
          </button>
          <button class="text-red-600 hover:underline deleteBtn" data-id="${patient.id}" data-department="${patient.department}">
            <i class="fas fa-trash mr-1"></i> ุญุฐู
          </button>
        </td>
      `;
      patientsTable.appendChild(row);
    });
    
    this.attachPatientEvents();
  },
  
  handleSearch(query) {
    const allPatients = [...document.querySelectorAll("#patientsTable tr")].map(row => {
      const cells = row.querySelectorAll("td");
      return {
        name: cells[0].textContent,
        nid: cells[1].textContent,
        element: row
      };
    });
    
    allPatients.forEach(patient => {
      const match = patient.name.toLowerCase().includes(query.toLowerCase()) ||
                   patient.nid.toLowerCase().includes(query.toLowerCase());
      patient.element.style.display = match ? "" : "none";
    });
  },
  
  attachPatientEvents() {
    // ุชูุงุตูู ุงููุฑูุถ
    document.querySelectorAll(".detailsBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const dept = btn.dataset.department;
        const patient = [...document.querySelectorAll("#patientsTable tr")].find(row => {
          return row.querySelector(`[data-id="${id}"]`);
        })?.dataset;
        
        if (patient) {
          Swal.fire({
            title: "ุชูุงุตูู ุงููุฑูุถ",
            html: `
              <div class="text-right text-sm">
                <p><b>ุงูุงุณู:</b> ${patient.name}</p>
                <p><b>ุงูุนูุฑ:</b> ${patient.age}</p>
                <p><b>ุงููุณู:</b> ${patient.department}</p>
                <p><b>ุงูุนููุงู:</b> ${patient.address || "-"}</p>
                <p><b>ุงูุฃูุฑุงุถ:</b> ${patient.diseases || "-"}</p>
                <p><b>ุงูุฏูุชูุฑ:</b> ${patient.doctors || "-"}</p>
              </div>
            `,
            icon: "info",
            confirmButtonText: "ุฅุบูุงู"
          });
        }
      });
    });
    
    // ุญุฐู ุงููุฑูุถ
    document.querySelectorAll(".deleteBtn").forEach(button => {
      button.addEventListener("click", () => {
        const id = button.dataset.id;
        const department = button.dataset.department;
        const patientRef = ref(db, `patients/${department}/${id}`);
        
        Swal.fire({
          title: "ูู ุฃูุช ูุชุฃูุฏุ",
          text: "ูู ุชุชููู ูู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "ูุนูุ ุงุญุฐู",
          cancelButtonText: "ุฅูุบุงุก"
        }).then((result) => {
          if (result.isConfirmed) {
            remove(patientRef)
              .then(() => Swal.fire("ุชู ุงูุญุฐู", "ุชู ุญุฐู ุงููุฑูุถ ุจูุฌุงุญ", "success"))
              .catch(() => Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู", "error"));
          }
        });
      });
    });
  },
  
  updateStats(countPatients, countDepartments, countVisits) {
    document.getElementById("totalPatients").textContent = countPatients;
    document.getElementById("totalDepartments").textContent = countDepartments;
    document.getElementById("totalVisits").textContent = countVisits;
  }
};

// ุฅุฏุงุฑุฉ ุงูุฃุทุจุงุก
const doctorManager = {
  init() {
    this.loadDoctors();
    this.setupEventListeners();
  },
  
  setupEventListeners() {
    document.getElementById("addDoctorBtn").addEventListener("click", () => this.addDoctor());
  },
  
  loadDoctors() {
    const doctorsRef = ref(db, "doctors");
    const doctorsTable = document.getElementById("doctorsTable");
    
    onValue(doctorsRef, (snapshot) => {
      const doctors = snapshot.val();
      doctorsTable.innerHTML = "";
      
      if (doctors) {
        Object.entries(doctors).forEach(([docId, doc]) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50 text-sm";
          row.innerHTML = `
            <td class="border p-2">${doc.name}</td>
            <td class="border p-2">${doc.department}</td>
            <td class="border p-2">${doc.shift}</td>
            <td class="border p-2">
              <span class="${doc.manualStatus === "online" ? "text-green-600" : "text-red-600"} font-bold">
                ${doc.manualStatus === "online" ? "ูุชุงุญ" : "ุบูุฑ ูุชุงุญ"}
              </span>
            </td>
            <td class="border p-2 flex gap-2 justify-center">
              <button class="changeStatusBtn bg-blue-500 text-white px-2 py-1 rounded" data-id="${docId}" data-status="${doc.manualStatus}">
                <i class="fas fa-toggle-on mr-1"></i> ${doc.manualStatus === "online" ? "ุฅุฎูุงุก" : "ุฅุธูุงุฑ"}
              </button>
              <button class="editDoctorBtn bg-yellow-500 text-white px-2 py-1 rounded" data-id="${docId}">
                <i class="fas fa-edit mr-1"></i> ุชุนุฏูู
              </button>
              <button class="deleteDoctorBtn bg-red-500 text-white px-2 py-1 rounded" data-id="${docId}">
                <i class="fas fa-trash mr-1"></i> ุญุฐู
              </button>
            </td>
          `;
          doctorsTable.appendChild(row);
        });
        
        this.attachDoctorEvents();
      }
    });
  },
  
  attachDoctorEvents() {
    // ุชุบููุฑ ุญุงูุฉ ุงูุทุจูุจ
    document.querySelectorAll(".changeStatusBtn").forEach(button => {
      button.addEventListener("click", () => {
        const docId = button.dataset.id;
        const currentStatus = button.dataset.status;
        const newStatus = currentStatus === "online" ? "offline" : "online";
        const doctorStatusRef = ref(db, `doctors/${docId}`);
        
        update(doctorStatusRef, { manualStatus: newStatus });
      });
    });
    
    // ุชุนุฏูู ุงูุทุจูุจ
    document.querySelectorAll(".editDoctorBtn").forEach(button => {
      button.addEventListener("click", () => {
        const docId = button.dataset.id;
        const doctorsRef = ref(db, "doctors");
        
        get(doctorsRef).then((snapshot) => {
          const doctor = snapshot.val()[docId];
          if (doctor) {
            Swal.fire({
              title: "ุชุนุฏูู ุจูุงูุงุช ุงูุทุจูุจ",
              html: `
                <input id="editDocName" class="swal2-input" value="${doctor.name}">
                <input id="editDocDept" class="swal2-input" value="${doctor.department}">
                <input id="editDocShift" class="swal2-input" value="${doctor.shift}">
              `,
              preConfirm: () => {
                const name = document.getElementById("editDocName").value;
                const department = document.getElementById("editDocDept").value;
                const shift = document.getElementById("editDocShift").value;
                
                if (!name || !department || !shift) {
                  Swal.showValidationMessage("ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูุญููู");
                  return false;
                }
                
                update(ref(db, `doctors/${docId}`), { name, department, shift });
              }
            }).then(result => {
              if (result.isConfirmed) Swal.fire("ุชู", "ุชู ุชุนุฏูู ุงูุทุจูุจ ุจูุฌุงุญ", "success");
            });
          }
        });
      });
    });
    
    // ุญุฐู ุงูุทุจูุจ
    document.querySelectorAll(".deleteDoctorBtn").forEach(button => {
      button.addEventListener("click", () => {
        const docId = button.dataset.id;
        
        Swal.fire({
          title: "ูู ุฃูุช ูุชุฃูุฏุ",
          text: "ุณูุชู ุญุฐู ุงูุทุจูุจ ููุงุฆูุงู",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "ูุนูุ ุงุญุฐู",
          cancelButtonText: "ุฅูุบุงุก"
        }).then((result) => {
          if (result.isConfirmed) {
            remove(ref(db, `doctors/${docId}`))
              .then(() => Swal.fire("ุชู", "ุชู ุญุฐู ุงูุทุจูุจ", "success"))
              .catch(() => Swal.fire("ุฎุทุฃ", "ูุดู ุงูุญุฐู", "error"));
          }
        });
      });
    });
  },
  
  addDoctor() {
    Swal.fire({
      title: "ุฅุถุงูุฉ ุทุจูุจ",
      html: `
        <input id="docName" class="swal2-input" placeholder="ุงุณู ุงูุทุจูุจ">
        <input id="docDept" class="swal2-input" placeholder="ุงููุณู (emergency)">
        <input id="docShift" class="swal2-input" placeholder="Morning/Evening/Night">
      `,
      preConfirm: () => {
        const name = document.getElementById("docName").value;
        const department = document.getElementById("docDept").value;
        const shift = document.getElementById("docShift").value;
        
        if (!name || !department || !shift) {
          Swal.showValidationMessage("ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูุญููู");
          return false;
        }
        
        const newDocRef = push(ref(db, "doctors"));
        return set(newDocRef, { name, department, shift, manualStatus: "online" });
      }
    }).then(result => {
      if (result.isConfirmed) Swal.fire("ุชู", "ุชูุช ุฅุถุงูุฉ ุงูุทุจูุจ ุจูุฌุงุญ", "success");
    });
  }
};

// ุชููุฆุฉ ุงูุชุทุจูู
window.addEventListener("DOMContentLoaded", () => {
  setupNavigation();
  patientManager.init();
  doctorManager.init();
});
</script>
</head>
<body class="bg-gray-100 min-h-screen flex">
<!-- ุงูุดุฑูุท ุงูุฌุงูุจู -->
<div class="w-64 bg-white shadow-md h-screen p-4">
  <h2 class="text-2xl font-bold mb-6 text-blue-700">ููุญุฉ ุงููุฏูุฑ</h2>
  <nav class="flex flex-col gap-2">
    <button class="nav-link px-4 py-2 rounded text-right hover:bg-blue-100" data-target="dashboard">
      <i class="fas fa-home mr-2"></i> ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
    </button>
    <button class="nav-link px-4 py-2 rounded text-right hover:bg-blue-100" data-target="doctors">
      <i class="fas fa-user-md mr-2"></i> ุฅุฏุงุฑุฉ ุงูุฃุทุจุงุก
    </button>
    <button class="nav-link px-4 py-2 rounded text-right hover:bg-blue-100" data-target="patients">
      <i class="fas fa-procedures mr-2"></i> ุฅุฏุงุฑุฉ ุงููุฑุถู
    </button>
  </nav>
</div>

<!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
<div class="flex-1 p-6">
  <!-- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
  <section id="dashboard" class="section">
    <div class="flex items-center mb-6">
      <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold mr-4">
        <i class="fas fa-user-tie"></i>
      </div>
      <div>
        <h1 class="text-3xl font-bold">ุฃููุงู ุจูุ <span class="text-blue-600">ุฏ. ุฃุญูุฏ ูุญูุฏ</span></h1>
        <p class="text-gray-600">ูุฏูุฑ ูุณุชุดูู ุงูููุฑ ุงูุชุฎุตุตู</p>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
      <div class="bg-white shadow-md p-4 rounded">
        <h3 class="text-sm text-gray-500">ุฅุฌูุงูู ุงููุฑุถู</h3>
        <p id="totalPatients" class="text-2xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white shadow-md p-4 rounded">
        <h3 class="text-sm text-gray-500">ุนุฏุฏ ุงูุฃูุณุงู</h3>
        <p id="totalDepartments" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white shadow-md p-4 rounded">
        <h3 class="text-sm text-gray-500">ุฅุฌูุงูู ุงููุดูู</h3>
        <p id="totalVisits" class="text-2xl font-bold text-red-600">0</p>
      </div>
    </div>
    
    <div class="bg-white shadow-md rounded p-4 mb-6">
      <h2 class="text-xl font-bold mb-4 text-blue-700">ุฅุญุตุงุฆูุงุช ุงูุฃูุณุงู</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border rounded p-3">
          <h3 class="font-bold mb-2">ุฃูุณุงู ุงูุฃุทุจุงุก</h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span>ุงูุทูุงุฑุฆ</span>
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded">3 ุฃุทุจุงุก</span>
            </div>
            <div class="flex justify-between">
              <span>ุงูุจุงุทูุฉ</span>
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded">5 ุฃุทุจุงุก</span>
            </div>
            <div class="flex justify-between">
              <span>ุงูุฌุฑุงุญุฉ</span>
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded">4 ุฃุทุจุงุก</span>
            </div>
            <div class="flex justify-between">
              <span>ุงูุฃุทูุงู</span>
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded">2 ุฃุทุจุงุก</span>
            </div>
          </div>
        </div>
        <div class="border rounded p-3">
          <h3 class="font-bold mb-2">ุฅุญุตุงุฆูุงุช ุงููุฑุถู</h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span>ุงูุทูุงุฑุฆ</span>
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">12 ูุฑูุถ</span>
            </div>
            <div class="flex justify-between">
              <span>ุงูุจุงุทูุฉ</span>
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">24 ูุฑูุถ</span>
            </div>
            <div class="flex justify-between">
              <span>ุงูุฌุฑุงุญุฉ</span>
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">18 ูุฑูุถ</span>
            </div>
            <div class="flex justify-between">
              <span>ุงูุฃุทูุงู</span>
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">9 ูุฑูุถ</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-white shadow-md rounded p-4">
      <h2 class="text-xl font-bold mb-4 text-blue-700">ุฃูู ุงูุฅุดุนุงุฑุงุช</h2>
      <div class="space-y-2">
        <div class="border-l-4 border-yellow-500 p-3 bg-yellow-50">
          <p class="font-bold">ุทูุจ ุฌุฏูุฏ</p>
          <p>ุชู ุฅุถุงูุฉ ุทุจูุจ ุฌุฏูุฏ ุฅูู ูุณู ุงูุทูุงุฑุฆ</p>
          <p class="text-xs text-gray-500">ููุฐ 2 ุณุงุนุงุช</p>
        </div>
        <div class="border-l-4 border-green-500 p-3 bg-green-50">
          <p class="font-bold">ุญุงูุฉ ูุณุชูุฑุฉ</p>
          <p>ุฌููุน ุงูุฃูุณุงู ุชุนูู ุจููุงุกุฉ ุนุงููุฉ</p>
          <p class="text-xs text-gray-500">ููุฐ 4 ุณุงุนุงุช</p>
        </div>
        <div class="border-l-4 border-red-500 p-3 bg-red-50">
          <p class="font-bold">ุนุงุฌู</p>
          <p>ุฒูุงุฏุฉ ูู ุนุฏุฏ ุงููุฑุถู ูู ูุณู ุงูุทูุงุฑุฆ</p>
          <p class="text-xs text-gray-500">ููุฐ 6 ุณุงุนุงุช</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ุฅุฏุงุฑุฉ ุงูุฃุทุจุงุก -->
  <section id="doctors" class="section hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-blue-700">ุฅุฏุงุฑุฉ ุงูุฃุทุจุงุก</h2>
      <div class="flex gap-2">
        <div class="relative">
          <input id="searchDoctor" type="text" placeholder="๐ ุงุจุญุซ ุนู ุทุจูุจ" 
                 class="w-full p-2 pl-10 border rounded">
          <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
        <button id="addDoctorBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          <i class="fas fa-plus mr-2"></i> ุฅุถุงูุฉ ุทุจูุจ
        </button>
      </div>
    </div>
    
    <div class="bg-white shadow-md rounded overflow-x-auto">
      <table class="min-w-full table-auto border">
        <thead class="bg-gray-100 text-gray-700 text-sm">
          <tr>
            <th class="border p-2">ุงูุงุณู</th>
            <th class="border p-2">ุงููุณู</th>
            <th class="border p-2">ุงููุฑุฏูุฉ</th>
            <th class="border p-2">ุงูุญุงูุฉ</th>
            <th class="border p-2">ุฅุฌุฑุงุก</th>
          </tr>
        </thead>
        <tbody id="doctorsTable" class="text-center"></tbody>
      </table>
    </div>
    
    <!-- ุฅุญุตุงุฆูุงุช ุงูุฃุทุจุงุก -->
    <div class="bg-white shadow-md rounded p-4 mt-6">
      <h3 class="text-lg font-bold mb-3 text-blue-700">ุฅุญุตุงุฆูุงุช ุงูุฃุทุจุงุก</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-blue-50 p-3 rounded border border-blue-100">
          <p class="text-sm text-gray-600">ุฅุฌูุงูู ุงูุฃุทุจุงุก</p>
          <p id="totalDoctors" class="text-2xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-green-50 p-3 rounded border border-green-100">
          <p class="text-sm text-gray-600">ุงูุฃุทุจุงุก ุงููุชุงุญูู</p>
          <p id="availableDoctors" class="text-2xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-red-50 p-3 rounded border border-red-100">
          <p class="text-sm text-gray-600">ุงูุฃุทุจุงุก ุบูุฑ ุงููุชุงุญูู</p>
          <p id="unavailableDoctors" class="text-2xl font-bold text-red-600">0</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ุฅุฏุงุฑุฉ ุงููุฑุถู -->
  <section id="patients" class="section hidden">
    <h2 class="text-xl font-bold text-blue-700 mb-4">ุฅุฏุงุฑุฉ ุงููุฑุถู</h2>
    <div class="relative mb-4">
      <input id="searchPatient" type="text" placeholder="๐ ุงุจุญุซ ุนู ูุฑูุถ ุจุงูุงุณู ุฃู ุงูุฑูู ุงููููู" 
             class="w-full p-2 pl-10 border rounded">
      <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
    </div>
    <div class="bg-white shadow-md rounded overflow-x-auto">
      <table class="min-w-full table-auto border">
        <thead class="bg-gray-100 text-gray-700 text-sm">
          <tr>
            <th class="border p-2">ุงูุงุณู</th>
            <th class="border p-2">ุงูุนูุฑ</th>
            <th class="border p-2">ุงููุณู</th>
            <th class="border p-2">ุชุงุฑูุฎ ุงูุชุณุฌูู</th>
            <th class="border p-2">ุฅุฌุฑุงุก</th>
          </tr>
        </thead>
        <tbody id="patientsTable" class="text-center"></tbody>
      </table>
    </div>
  </section>
</div>
</body>
</html>
