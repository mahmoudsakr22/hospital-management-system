<!-- admin.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-blue-600">ğŸ”’ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø¯ÙŠØ± Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h1>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-1 rounded">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </header>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <main class="p-6 space-y-6">
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</p>
        <h2 id="todayCount" class="text-3xl font-bold text-blue-600">0</h2>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰</p>
        <h2 id="totalPatients" class="text-3xl font-bold text-green-600">0</h2>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¨ÙƒÙ„ Ù‚Ø³Ù…</p>
        <ul id="departmentStats" class="list-disc ml-4 text-lg"></ul>
      </div>
    </section>

    <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ -->
    <section class="bg-white p-4 rounded shadow">
      <h3 class="text-xl font-semibold mb-2">Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
      <canvas id="patientsChart" width="400" height="200"></canvas>
    </section>

    <!-- Ø§Ù„Ø¨Ø­Ø« -->
    <section class="bg-white p-4 rounded shadow">
      <h3 class="text-xl font-semibold mb-2">ğŸ” Ø¨Ø­Ø« ÙˆØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø±Ø¶Ù‰</h3>
      <input id="searchBox" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ID" class="border p-2 w-full mb-4 rounded" />
      <table class="w-full border">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¹Ù…Ø±</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¹Ø±Ø¶</th>
          </tr>
        </thead>
        <tbody id="patientsTable"></tbody>
      </table>
    </section>

    <!-- Ø²Ø± ØªÙ‚Ø±ÙŠØ± -->
    <section class="text-center">
      <button onclick="downloadReport()" class="bg-blue-600 text-white px-6 py-2 mt-4 rounded">ğŸ“„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF</button>
    </section>
  </main>

  <!-- Ø±Ø¨Ø· Ù…Ø¹ Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://smart-hospital-life.firebaseio.com/",
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let chart;
    let deptCounts = {};

    function loadStats() {
      const patientsRef = ref(db, "patients");
      onValue(patientsRef, (snapshot) => {
        const data = snapshot.val();
        let today = 0;
        let total = 0;
        deptCounts = {};

        const tbody = document.getElementById("patientsTable");
        tbody.innerHTML = "";

        const nowDate = new Date().toISOString().split("T")[0];

        for (let id in data) {
          const p = data[id];
          total++;
          if ((p.date || "").startsWith(nowDate)) today++;
          deptCounts[p.department] = (deptCounts[p.department] || 0) + 1;

          // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p-2">${p.name || ""}</td>
            <td>${p.age || ""}</td>
            <td>${p.department || ""}</td>
            <td>${p.status || "-"}</td>
            <td><a class="text-blue-600 underline" href="patient.html?id=${id}" target="_blank">Ø¹Ø±Ø¶</a></td>
          `;
          tbody.appendChild(tr);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        document.getElementById("todayCount").innerText = today;
        document.getElementById("totalPatients").innerText = total;

        // Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        const ul = document.getElementById("departmentStats");
        ul.innerHTML = "";
        for (let dept in deptCounts) {
          const li = document.createElement("li");
          li.textContent = `${dept}: ${deptCounts[dept]}`;
          ul.appendChild(li);
        }

        updateChart();
      });
    }

    function updateChart() {
      const ctx = document.getElementById("patientsChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(deptCounts),
          datasets: [
            {
              label: "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰",
              data: Object.values(deptCounts),
              backgroundColor: ["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#14b8a6"],
            },
          ],
        },
      });
    }

    document.getElementById("searchBox").addEventListener("input", () => {
      const rows = document.querySelectorAll("#patientsTable tr");
      const term = document.getElementById("searchBox").value.toLowerCase();
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
      });
    });

    window.downloadReport = () => {
      Swal.fire("ğŸ“„ Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø§Ø­Ù‚Ù‹Ø§", "Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
    };

    window.logout = () => {
      window.location.href = "index.html";
    };

    loadStats();
  </script>
</body>
</html>
