<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم الإدارة - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 text-right">
  <div class="bg-white shadow p-4 flex items-center justify-between">
    <h1 class="text-2xl font-bold text-blue-800">🧑‍⚕️ لوحة تحكم الإدارة - مستشفى الحياة الذكية</h1>
    <button onclick="location.href='index.html'" class="bg-blue-600 text-white px-4 py-2 rounded">🔙 الصفحة الرئيسية</button>
  </div>

  <div class="p-4">
    <input id="searchInput" type="text" placeholder="🔍 بحث عن مريض بالاسم أو الرقم القومي..." class="w-full p-2 mb-4 border rounded shadow">

    <div id="patientsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- المرضى سيُعرضون هنا -->
    </div>
  </div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const patientsContainer = document.getElementById("patientsContainer");
    const searchInput = document.getElementById("searchInput");

    // تحميل كل المرضى من جميع الأقسام
    const loadPatients = async () => {
      patientsContainer.innerHTML = `<div class="text-center w-full col-span-3">⏳ جاري تحميل المرضى...</div>`;
      const snapshot = await db.ref("patients").once("value");
      patientsContainer.innerHTML = "";

      snapshot.forEach(sectionSnap => {
        sectionSnap.forEach(patientSnap => {
          const patient = patientSnap.val();
          const id = patientSnap.key;
          const section = sectionSnap.key;

          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded shadow";

          card.innerHTML = `
            <h2 class="text-xl font-bold text-blue-700 mb-2">${patient.name || "بدون اسم"}</h2>
            <p><strong>الرقم القومي:</strong> ${patient.nationalId || "غير مسجل"}</p>
            <p><strong>القسم:</strong> ${section}</p>
            <div class="mt-4 flex justify-between gap-2">
              <button onclick="viewPatient('${id}', '${section}')" class="bg-green-600 text-white px-3 py-1 rounded">👁️ عرض التفاصيل</button>
              <button onclick="deletePatient('${id}', '${section}')" class="bg-red-600 text-white px-3 py-1 rounded">🗑️ حذف</button>
            </div>
          `;
          patientsContainer.appendChild(card);
        });
      });
    };

    // حذف مريض
    function deletePatient(id, section) {
      Swal.fire({
        title: "هل أنت متأكد؟",
        text: "سيتم حذف هذا المريض نهائيًا",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "نعم، احذف",
        cancelButtonText: "إلغاء"
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref(`patients/${section}/${id}`).remove().then(() => {
            Swal.fire("تم الحذف", "تم حذف المريض بنجاح", "success");
            loadPatients();
          });
        }
      });
    }

    // عرض التفاصيل
    function viewPatient(id, section) {
      localStorage.setItem("patientId", id);
      localStorage.setItem("patientSection", section);
      window.location.href = "patient.html";
    }

    // فلترة البحث
    searchInput.addEventListener("input", () => {
      const term = searchInput.value.toLowerCase();
      const cards = patientsContainer.querySelectorAll("div");
      cards.forEach(card => {
        const name = card.querySelector("h2")?.textContent.toLowerCase() || "";
        const nationalId = card.querySelector("p")?.textContent.toLowerCase() || "";
        card.style.display = (name.includes(term) || nationalId.includes(term)) ? "block" : "none";
      });
    });

    loadPatients();
  </script>
</body>
</html>
