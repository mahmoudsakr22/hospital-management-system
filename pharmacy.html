<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام الصيدلة المتكامل – مستشفى الحياة الذكية</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- QR Code -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- XLSX for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <!-- Barcode Generator -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  
  <style>
    body { background: #0b1220; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: saturate(180%) blur(12px); }
    .card { @apply glass rounded-2xl shadow-xl p-4 md:p-6; }
    .btn { @apply px-3 py-2 rounded-xl text-sm font-medium shadow transition-all duration-200; }
    .dark-mode { background: #000; color: #fff; }
    .dark-mode .glass { background: rgba(255,255,255,0.03); }
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-in-out;
    }
    @keyframes slideIn {
      from { transform: translateX(20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
      100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
    }
    .barcode-container {
      background: white;
      padding: 10px;
      border-radius: 8px;
      display: inline-block;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background-color: #1e293b;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #334155;
      width: 80%;
      max-width: 800px;
      border-radius: 12px;
      color: white;
    }
    .close {
      color: #aaa;
      float: left;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: white;
    }
    .permission-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: #3b82f6;
      color: white;
      padding: 2px 8px;
      border-radius: 0 8px 0 8px;
      font-size: 10px;
    }
    .low-stock { background-color: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.5); }
    .expiring { background-color: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); }
    .controlled { background-color: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.5); }
  </style>
</head>
<body class="text-white transition-colors duration-300">
  <!-- Topbar -->
  <header class="sticky top-0 z-50 glass border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class='bx bxs-capsule text-2xl text-teal-300'></i>
        <div>
          <h1 class="text-xl md:text-2xl font-bold">نظام الصيدلة المتكامل</h1>
          <p class="text-xs md:text-sm text-white/70">Smart Life Hospital – Advanced Pharmacy</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnTheme" class="btn bg-white/10 hover:bg-white/20 relative">
          <i class='bx bx-moon'></i>
        </button>
        <button id="btnNotifications" class="btn bg-white/10 hover:bg-white/20 relative">
          <i class='bx bx-bell'></i>
          <span id="notificationBadge" class="notification-badge hidden">0</span>
        </button>
        <button id="btnReports" class="btn bg-indigo-600 hover:bg-indigo-700">تقارير</button>
        <button id="btnBarcodeScanner" class="btn bg-purple-600 hover:bg-purple-700">
          <i class='bx bx-barcode-reader'></i>
        </button>
        <button id="btnPrint" class="btn bg-green-600 hover:bg-green-700">
          <i class='bx bx-printer'></i>
        </button>
        <button id="btnRefresh" class="btn bg-white/10 hover:bg-white/20">تحديث</button>
        <button id="btnLogout" class="btn bg-rose-600 hover:bg-rose-700">
          <i class='bx bx-log-out'></i> خروج
        </button>
      </div>
    </div>
  </header>
  
  <!-- Notification Panel -->
  <div id="notificationPanel" class="fixed top-16 left-4 w-80 glass rounded-xl shadow-2xl z-50 hidden slide-in">
    <div class="p-4 border-b border-white/10 flex justify-between items-center">
      <h3 class="font-bold">الإشعارات</h3>
      <button id="closeNotifications" class="text-white/60 hover:text-white">
        <i class='bx bx-x'></i>
      </button>
    </div>
    <div id="notificationList" class="max-h-96 overflow-y-auto p-2 space-y-2">
      <!-- Notifications will be added here dynamically -->
    </div>
  </div>
  
  <!-- Barcode Scanner Modal -->
  <div id="barcodeModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="text-xl font-bold mb-4">ماسح الباركود</h2>
      <div class="mb-4">
        <input type="text" id="barcodeInput" class="w-full p-3 rounded-lg bg-slate-700 border border-slate-600" placeholder="امسح الباركود أو أدخله يدوياً">
      </div>
      <div class="mb-4">
        <button id="simulateScan" class="btn bg-purple-600 hover:bg-purple-700 w-full">محاكاة المسح</button>
      </div>
      <div id="barcodeResult" class="hidden p-4 bg-slate-800 rounded-lg">
        <!-- Barcode result will be shown here -->
      </div>
    </div>
  </div>
  
  <!-- Invoice Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="text-xl font-bold mb-4">حساب الفاتورة</h2>
      <div id="invoiceContent">
        <!-- Invoice content will be shown here -->
      </div>
    </div>
  </div>
  
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Quick Stats -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="card hover:scale-[1.02] transition-transform">
        <p class="text-xs text-white/60">إجمالي الأدوية</p>
        <p id="statTotal" class="text-2xl font-bold">0</p>
        <div class="mt-2 h-1 bg-teal-500/30 rounded-full overflow-hidden">
          <div id="totalProgress" class="h-full bg-teal-500 rounded-full" style="width: 0%"></div>
        </div>
      </div>
      <div class="card hover:scale-[1.02] transition-transform">
        <p class="text-xs text-white/60">أدوية منخفضة</p>
        <p id="statLow" class="text-2xl font-bold">0</p>
        <div class="mt-2 h-1 bg-amber-500/30 rounded-full overflow-hidden">
          <div id="lowProgress" class="h-full bg-amber-500 rounded-full" style="width: 0%"></div>
        </div>
      </div>
      <div class="card hover:scale-[1.02] transition-transform">
        <p class="text-xs text-white/60">قاربت الانتهاء</p>
        <p id="statExpSoon" class="text-2xl font-bold">0</p>
        <div class="mt-2 h-1 bg-rose-500/30 rounded-full overflow-hidden">
          <div id="expProgress" class="h-full bg-rose-500 rounded-full" style="width: 0%"></div>
        </div>
      </div>
      <div class="card hover:scale-[1.02] transition-transform">
        <p class="text-xs text-white/60">وصفات جديدة</p>
        <p id="statNewRx" class="text-2xl font-bold">0</p>
        <div class="mt-2 h-1 bg-indigo-500/30 rounded-full overflow-hidden">
          <div id="rxProgress" class="h-full bg-indigo-500 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </section>
    
    <!-- Revenue Chart -->
    <section class="card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">إحصائيات المبيعات</h2>
        <div class="flex gap-2">
          <button id="btnExportExcel" class="btn bg-green-600 hover:bg-green-700 text-xs">
            <i class='bx bx-spreadsheet ml-1'></i> Excel
          </button>
          <button id="btnExportPdf" class="btn bg-red-600 hover:bg-red-700 text-xs">
            <i class='bx bx-file-pdf ml-1'></i> PDF
          </button>
        </div>
      </div>
      <div class="h-64">
        <canvas id="revenueChart"></canvas>
      </div>
    </section>
    
    <!-- Auto Reorder Alert -->
    <div id="autoReorderAlert" class="hidden card bg-amber-900/30 border border-amber-700/50 pulse">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class='bx bx-error-circle text-2xl text-amber-400'></i>
          <div>
            <h3 class="font-bold">تنبيه إعادة طلب تلقائي</h3>
            <p class="text-sm">تم إنشاء طلبات تلقائية للأدوية التالية</p>
          </div>
        </div>
        <button id="viewReorders" class="btn bg-amber-600 hover:bg-amber-700">عرض الطلبات</button>
      </div>
    </div>
    
    <!-- Tabs -->
    <section class="glass rounded-2xl">
      <div class="flex border-b border-white/10">
        <button id="tabInventory" class="flex-1 p-3 md:p-4 text-center font-semibold border-b-2 border-teal-400">المخزن</button>
        <button id="tabPrescriptions" class="flex-1 p-3 md:p-4 text-center font-semibold border-b-2 border-transparent">الوصفات الطبية</button>
        <button id="tabSuppliers" class="flex-1 p-3 md:p-4 text-center font-semibold border-b-2 border-transparent">الموردون</button>
        <button id="tabOrders" class="flex-1 p-3 md:p-4 text-center font-semibold border-b-2 border-transparent">الطلبات</button>
        <button id="tabReports" class="flex-1 p-3 md:p-4 text-center font-semibold border-b-2 border-transparent">التقارير</button>
      </div>
      <div class="p-4 md:p-6 space-y-6">
        <!-- Inventory Panel -->
        <div id="panelInventory" class="space-y-6">
          <!-- Add Drug Form -->
          <div class="card fade-in">
            <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
              <i class='bx bx-plus-medical'></i> إضافة دواء جديد
            </h2>
            <form id="formAddDrug" class="grid md:grid-cols-6 gap-3">
              <input id="drugName" required placeholder="اسم الدواء" class="md:col-span-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <input id="manufacturer" placeholder="الشركة المصنعة" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <input id="batch" placeholder="رقم التشغيلة (Batch)" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <input id="expiry" type="date" required class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <input id="quantity" type="number" min="0" required placeholder="الكمية" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <input id="price" type="number" min="0" step="0.01" placeholder="السعر للوحدة" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <div class="md:col-span-6 flex items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                  <input id="lowThreshold" type="number" min="0" value="10" class="w-24 px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
                  <label for="lowThreshold" class="text-sm text-white/70">حد التنبيه</label>
                  <input id="reorderPoint" type="number" min="0" value="5" class="w-24 px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
                  <label for="reorderPoint" class="text-sm text-white/70">نقطة إعادة الطلب</label>
                </div>
                <div class="flex items-center gap-2">
                  <select id="supplierSelect" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <option value="">اختر المورد</option>
                  </select>
                  <button class="btn bg-teal-600 hover:bg-teal-700" type="submit">حفظ الدواء</button>
                </div>
              </div>
            </form>
          </div>
          
          <!-- Inventory Table -->
          <div class="card fade-in">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-3 gap-3">
              <h2 class="text-lg font-bold">قائمة الأدوية</h2>
              <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                <input id="searchDrug" placeholder="بحث عن دواء..." class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500 w-full md:w-60" />
                <select id="filterCategory" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500">
                  <option value="all">جميع الفئات</option>
                  <option value="antibiotics">مضادات حيوية</option>
                  <option value="painkillers">مسكنات</option>
                  <option value="chronic">أمراض مزمنة</option>
                </select>
              </div>
            </div>
            <div class="overflow-auto rounded-xl border border-white/10">
              <table class="min-w-full text-sm">
                <thead class="bg-white/5">
                  <tr class="text-white/80">
                    <th class="p-3 text-right">الدواء</th>
                    <th class="p-3 text-right">الشركة</th>
                    <th class="p-3">Batch</th>
                    <th class="p-3">الصلاحية</th>
                    <th class="p-3">الكمية</th>
                    <th class="p-3">السعر</th>
                    <th class="p-3 text-center">الباركود</th>
                    <th class="p-3 text-center">تنبيهات</th>
                    <th class="p-3 text-center">إجراءات</th>
                  </tr>
                </thead>
                <tbody id="tbodyDrugs" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
            <div class="mt-4 flex justify-between items-center">
              <div class="text-sm text-white/60">
                إجمالي: <span id="drugCount">0</span> أدوية
              </div>
              <div class="flex gap-2">
                <button id="prevPage" class="btn bg-white/10 hover:bg-white/20 disabled:opacity-50" disabled>
                  <i class='bx bx-chevron-right'></i>
                </button>
                <span id="pageInfo" class="px-3 py-1">صفحة 1 من 1</span>
                <button id="nextPage" class="btn bg-white/10 hover:bg-white/20 disabled:opacity-50" disabled>
                  <i class='bx bx-chevron-left'></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Prescriptions Panel -->
        <div id="panelPrescriptions" class="hidden space-y-6">
          <!-- Regular Prescriptions Table -->
          <div class="card fade-in">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-3 gap-3">
              <h2 class="text-lg font-bold">الوصفات الطبية</h2>
              <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                <select id="filterRx" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500">
                  <option value="all">الكل</option>
                  <option value="new">جديدة</option>
                  <option value="dispensed">تم الصرف</option>
                  <option value="unavailable">غير متوفر</option>
                </select>
                <input id="searchRx" placeholder="بحث باسم المريض/الدواء" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500 w-full md:w-60" />
              </div>
            </div>
            <div class="overflow-auto rounded-xl border border-white/10">
              <table class="min-w-full text-sm">
                <thead class="bg-white/5">
                  <tr class="text-white/80">
                    <th class="p-3 text-right">المريض</th>
                    <th class="p-3">ID</th>
                    <th class="p-3 text-right">الدواء</th>
                    <th class="p-3">الجرعة</th>
                    <th class="p-3">المدة</th>
                    <th class="p-3">التأمين</th>
                    <th class="p-3">الجرعات</th>
                    <th class="p-3">الحالة</th>
                    <th class="p-3 text-center">QR</th>
                    <th class="p-3 text-center">إجراءات</th>
                  </tr>
                </thead>
                <tbody id="tbodyRx" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>
          
          <!-- Medication Requests Table -->
          <div id="medRequestsTable" class="card fade-in">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-3 gap-3">
              <h2 class="text-lg font-bold">طلبات الدواء من الأقسام الأخرى</h2>
              <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                <select id="filterMedRequests" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500">
                  <option value="all">الكل</option>
                  <option value="pending">قيد الانتظار</option>
                  <option value="dispensed">تم الصرف</option>
                  <option value="unavailable">غير متوفر</option>
                </select>
                <input id="searchMedRequests" placeholder="بحث باسم المريض/الدواء" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500 w-full md:w-60" />
              </div>
            </div>
            <div class="overflow-auto rounded-xl border border-white/10">
              <table class="min-w-full text-sm">
                <thead class="bg-white/5">
                  <tr class="text-white/80">
                    <th class="p-3 text-right">المريض</th>
                    <th class="p-3">ID</th>
                    <th class="p-3 text-right">القسم المرسل</th>
                    <th class="p-3 text-right">الدواء</th>
                    <th class="p-3">الجرعة</th>
                    <th class="p-3">المدة</th>
                    <th class="p-3">التأمين</th>
                    <th class="p-3">الجرعات</th>
                    <th class="p-3">الحالة</th>
                    <th class="p-3 text-center">QR</th>
                    <th class="p-3 text-center">إجراءات</th>
                  </tr>
                </thead>
                <tbody id="tbodyMedRequests" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Suppliers Panel -->
        <div id="panelSuppliers" class="hidden space-y-6">
          <div class="card fade-in">
            <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
              <i class='bx bx-truck'></i> إدارة الموردين
            </h2>
            <form id="formAddSupplier" class="grid md:grid-cols-4 gap-3 mb-6">
              <input id="supplierName" required placeholder="اسم المورد" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <input id="supplierContact" placeholder="رقم الاتصال" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <input id="supplierEmail" type="email" placeholder="البريد الإلكتروني" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
              <button class="btn bg-teal-600 hover:bg-teal-700" type="submit">إضافة مورد</button>
            </form>
            <div class="overflow-auto rounded-xl border border-white/10">
              <table class="min-w-full text-sm">
                <thead class="bg-white/5">
                  <tr class="text-white/80">
                    <th class="p-3 text-right">المورد</th>
                    <th class="p-3">الاتصال</th>
                    <th class="p-3">البريد الإلكتروني</th>
                    <th class="p-3">الأدوية</th>
                    <th class="p-3 text-center">إجراءات</th>
                  </tr>
                </thead>
                <tbody id="tbodySuppliers" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Orders Panel -->
        <div id="panelOrders" class="hidden space-y-6">
          <div class="card fade-in">
            <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
              <i class='bx bx-shopping-bag'></i> إدارة الطلبات
            </h2>
            <div class="grid md:grid-cols-3 gap-4 mb-6">
              <div class="card bg-teal-900/20 border border-teal-700/30">
                <h3 class="font-bold text-teal-300">الطلبات النشطة</h3>
                <p class="text-2xl font-bold" id="activeOrdersCount">0</p>
              </div>
              <div class="card bg-amber-900/20 border border-amber-700/30">
                <h3 class="font-bold text-amber-300">بانتظار الموافقة</h3>
                <p class="text-2xl font-bold" id="pendingOrdersCount">0</p>
              </div>
              <div class="card bg-rose-900/20 border border-rose-700/30">
                <h3 class="font-bold text-rose-300">الطلبات المتأخرة</h3>
                <p class="text-2xl font-bold" id="overdueOrdersCount">0</p>
              </div>
            </div>
            <div class="overflow-auto rounded-xl border border-white/10">
              <table class="min-w-full text-sm">
                <thead class="bg-white/5">
                  <tr class="text-white/80">
                    <th class="p-3 text-right">رقم الطلب</th>
                    <th class="p-3 text-right">المورد</th>
                    <th class="p-3">التاريخ</th>
                    <th class="p-3">الحالة</th>
                    <th class="p-3">القيمة</th>
                    <th class="p-3 text-center">إجراءات</th>
                  </tr>
                </thead>
                <tbody id="tbodyOrders" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Reports Panel -->
        <div id="panelReports" class="hidden space-y-6">
          <div class="card fade-in">
            <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
              <i class='bx bx-bar-chart-alt-2'></i> التقارير والإحصائيات
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <h3 class="font-medium mb-3">تقرير المخزون</h3>
                <div class="h-64">
                  <canvas id="inventoryChart"></canvas>
                </div>
              </div>
              <div>
                <h3 class="font-medium mb-3">تقرير الوصفات</h3>
                <div class="h-64">
                  <canvas id="prescriptionChart"></canvas>
                </div>
              </div>
            </div>
            <div class="mt-6 flex flex-wrap gap-3">
              <button id="generateInventoryReport" class="btn bg-indigo-600 hover:bg-indigo-700">
                تقرير المخزون الحالي
              </button>
              <button id="generateExpiryReport" class="btn bg-amber-600 hover:bg-amber-700">
                تقرير الأدوية منتهية الصلاحية
              </button>
              <button id="generateLowStockReport" class="btn bg-rose-600 hover:bg-rose-700">
                تقرير الأدوية منخفضة المخزون
              </button>
              <button id="generateSupplierReport" class="btn bg-teal-600 hover:bg-teal-700">
                تقرير أداء الموردين
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Firebase SDKs (Compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script>
    // =============================
    // 🔧 Firebase Config (ضع إعداداتك هنا)
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyCww7pM0clGr_Nk7Xe3pCnBUJtSaw6nS-k",
      authDomain: "smart-life-hospital.firebaseapp.com",
      databaseURL: "https://smart-life-hospital-default-rtdb.firebaseio.com",
      projectId: "smart-life-hospital",
      storageBucket: "smart-life-hospital.firebasestorage.app",
      messagingSenderId: "988240466536",
      appId: "1:988240466536:web:93e9f945b255cd164361dd",
      measurementId: "G-GEJF0F0ZJ7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // =============================
    // Global Variables
    // =============================
    let revenueChart = null;
    let inventoryChart = null;
    let prescriptionChart = null;
    let notifications = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let allDrugs = [];
    let autoReorders = [];
    let currentUser = null;
    let userPermissions = {};
    
    // =============================
    // User Authentication & Permissions
    // =============================
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        // Load user permissions
        db.ref(`users/${user.uid}/permissions`).once('value').then(snap => {
          userPermissions = snap.val() || {};
          applyPermissions();
        });
      } else {
        window.location.href = 'login.html';
      }
    });
    
    function applyPermissions() {
      // Hide/show elements based on permissions
      if (!userPermissions.canDeleteDrugs) {
        document.querySelectorAll('.del').forEach(btn => btn.style.display = 'none');
      }
      
      if (!userPermissions.canManageSuppliers) {
        document.getElementById('tabSuppliers').style.display = 'none';
      }
      
      if (!userPermissions.canViewReports) {
        document.getElementById('tabReports').style.display = 'none';
      }
      
      if (!userPermissions.canManageOrders) {
        document.getElementById('tabOrders').style.display = 'none';
      }
    }
    
    // =============================
    // Helpers
    // =============================
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const fmtDate = (v) => v ? new Date(v).toLocaleDateString('ar-EG') : '-';
    const todayISO = () => new Date().toISOString().slice(0,10);
    
    // Theme Toggle
    $('#btnTheme').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      $('#btnTheme').innerHTML = isDark ? '<i class="bx bx-sun"></i>' : '<i class="bx bx-moon"></i>';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
    
    // Load saved theme
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
      $('#btnTheme').innerHTML = '<i class="bx bx-sun"></i>';
    }
    
    // Barcode Scanner Modal
    const barcodeModal = $('#barcodeModal');
    const barcodeInput = $('#barcodeInput');
    
    $('#btnBarcodeScanner').addEventListener('click', () => {
      barcodeModal.style.display = 'block';
      barcodeInput.focus();
    });
    
    $('.close').forEach(closeBtn => {
      closeBtn.addEventListener('click', () => {
        closeBtn.closest('.modal').style.display = 'none';
      });
    });
    
    window.addEventListener('click', (event) => {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });
    
    // Invoice Modal
    const invoiceModal = $('#invoiceModal');
    
    // Notification System
    $('#btnNotifications').addEventListener('click', () => {
      $('#notificationPanel').classList.toggle('hidden');
    });
    
    $('#closeNotifications').addEventListener('click', () => {
      $('#notificationPanel').classList.add('hidden');
    });
    
    function addNotification(type, title, message, action = null) {
      const id = Date.now();
      const notification = { id, type, title, message, read: false, action };
      notifications.unshift(notification);
      updateNotificationBadge();
      renderNotifications();
      
      // Show toast notification
      const toast = Swal.mixin({
        toast: true,
        position: 'top-start',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.addEventListener('mouseenter', Swal.stopTimer)
          toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
      });
      
      toast.fire({
        icon: type === 'warning' ? 'warning' : type === 'error' ? 'error' : 'info',
        title: title,
        text: message
      });
    }
    
    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = $('#notificationBadge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    function renderNotifications() {
      const container = $('#notificationList');
      if (notifications.length === 0) {
        container.innerHTML = '<div class="text-center p-4 text-white/60">لا توجد إشعارات</div>';
        return;
      }
      
      container.innerHTML = notifications.map(n => `
        <div class="p-3 rounded-lg bg-white/5 hover:bg-white/10 cursor-pointer ${n.read ? 'opacity-60' : ''}" data-id="${n.id}">
          <div class="flex justify-between">
            <h4 class="font-medium">${n.title}</h4>
            <span class="text-xs text-white/60">${new Date(n.id).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}</span>
          </div>
          <p class="text-sm text-white/70 mt-1">${n.message}</p>
          ${n.action ? `<button class="mt-2 text-xs text-teal-400 hover:text-teal-300" onclick="${n.action}">اتخذ إجراء</button>` : ''}
        </div>
      `).join('');
      
      // Mark as read when clicked
      $$('#notificationList > div').forEach(el => {
        el.addEventListener('click', () => {
          const id = parseInt(el.getAttribute('data-id'));
          const notif = notifications.find(n => n.id === id);
          if (notif) notif.read = true;
          updateNotificationBadge();
          renderNotifications();
        });
      });
    }
    
    // Auto Reorder System
    function checkAutoReorder() {
      autoReorders = [];
      allDrugs.forEach(drug => {
        const quantity = Number(drug.data.quantity || 0);
        const reorderPoint = Number(drug.data.reorderPoint || 5);
        
        if (quantity <= reorderPoint) {
          autoReorders.push(drug);
        }
      });
      
      if (autoReorders.length > 0) {
        $('#autoReorderAlert').classList.remove('hidden');
        addNotification('warning', 'تنبيه إعادة طلب', `يوجد ${autoReorders.length} أدوية تحتاج إلى إعادة طلب`, 'viewReorders()');
      } else {
        $('#autoReorderAlert').classList.add('hidden');
      }
    }
    
    window.viewReorders = () => {
      switchTab(tabOrders, panelOrders);
      $('#notificationPanel').classList.add('hidden');
    };
    
    $('#viewReorders').addEventListener('click', () => {
      switchTab(tabOrders, panelOrders);
    });
    
    // Logout
    $('#btnLogout').addEventListener('click', () => {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        console.error('Logout error:', error);
      });
    });
    
    // Tabs
    const tabInventory = $('#tabInventory');
    const tabPrescriptions = $('#tabPrescriptions');
    const tabSuppliers = $('#tabSuppliers');
    const tabOrders = $('#tabOrders');
    const tabReports = $('#tabReports');
    const panelInventory = $('#panelInventory');
    const panelPrescriptions = $('#panelPrescriptions');
    const panelSuppliers = $('#panelSuppliers');
    const panelOrders = $('#panelOrders');
    const panelReports = $('#panelReports');
    
    function switchTab(activeTab, activePanel) {
      [tabInventory, tabPrescriptions, tabSuppliers, tabOrders, tabReports].forEach(tab => {
        tab.classList.remove('border-teal-400');
        tab.classList.add('border-transparent');
      });
      [panelInventory, panelPrescriptions, panelSuppliers, panelOrders, panelReports].forEach(panel => {
        panel.classList.add('hidden');
      });
      activeTab.classList.add('border-teal-400');
      activeTab.classList.remove('border-transparent');
      activePanel.classList.remove('hidden');
      
      // Initialize charts when reports tab is opened
      if (activePanel === panelReports && !inventoryChart) {
        initCharts();
      }
      
      // Load medication requests when prescriptions tab is opened
      if (activePanel === panelPrescriptions) {
        loadMedicationRequests();
      }
    }
    
    tabInventory.addEventListener('click', () => switchTab(tabInventory, panelInventory));
    tabPrescriptions.addEventListener('click', () => {
      switchTab(tabPrescriptions, panelPrescriptions);
      loadMedicationRequests();
    });
    tabSuppliers.addEventListener('click', () => switchTab(tabSuppliers, panelSuppliers));
    tabOrders.addEventListener('click', () => switchTab(tabOrders, panelOrders));
    tabReports.addEventListener('click', () => switchTab(tabReports, panelReports));
    
    // =============================
    // Invoice System
    // =============================
    
    // دالة لحساب الفاتورة
    window.calculateInvoice = async (patientId, transferKey) => {
      try {
        // جلب بيانات المريض والطلب
        const patientSnap = await medicationRequestsRef.child(patientId).get();
        const transferSnap = await medicationRequestsRef.child(`${patientId}/transfers/${transferKey}`).get();
        
        const patientData = patientSnap.val();
        const transfer = transferSnap.val();
        const medication = transfer.medication || {};
        
        // جلب سعر الدواء من المخزون
        const drugSnap = await drugsRef.orderByChild('name').equalTo(medication.name).limitToFirst(1).get();
        let drugPrice = 0;
        if (drugSnap.exists()) {
          const drugData = Object.values(drugSnap.val())[0];
          drugPrice = drugData.price || 0;
        }
        
        // حساب الإجمالي
        const quantity = medication.dosesCount || 1;
        const totalPrice = drugPrice * quantity;
        
        // عرض نافذة الفاتورة
        const { value: formValues } = await Swal.fire({
          title: 'حساب الفاتورة',
          html: `
            <div class="text-right">
              <div class="mb-4 p-3 bg-slate-800 rounded-lg">
                <div class="font-bold mb-2">معلومات المريض</div>
                <div>الاسم: ${patientData.name || '-'}</div>
                <div>الرقم: ${patientId}</div>
                <div>القسم: ${transfer.department || '-'}</div>
              </div>
              
              <div class="mb-4 p-3 bg-slate-800 rounded-lg">
                <div class="font-bold mb-2">معلومات الدواء</div>
                <div>الدواء: ${medication.name || '-'}</div>
                <div>الجرعة: ${medication.dosage || '-'}</div>
                <div>المدة: ${medication.duration || '-'}</div>
                <div>الكمية: ${quantity}</div>
              </div>
              
              <div class="mb-4">
                <label class="block mb-2">سعر الوحدة (ريال):</label>
                <input type="number" id="unitPrice" class="swal2-input" value="${drugPrice}" step="0.01">
              </div>
              
              <div class="mb-4">
                <label class="block mb-2">الخصم (ريال):</label>
                <input type="number" id="discount" class="swal2-input" value="0" step="0.01">
              </div>
              
              <div class="mb-4 p-3 bg-slate-800 rounded-lg">
                <div class="flex justify-between mb-1">
                  <span>الإجمالي:</span>
                  <span id="totalAmount">${totalPrice.toFixed(2)} ريال</span>
                </div>
                <div class="flex justify-between mb-1">
                  <span>الخصم:</span>
                  <span id="discountAmount">0.00 ريال</span>
                </div>
                <div class="flex justify-between font-bold text-lg">
                  <span>الصافي:</span>
                  <span id="netAmount">${totalPrice.toFixed(2)} ريال</span>
                </div>
              </div>
              
              <div class="mb-4">
                <label class="block mb-2">طريقة الدفع:</label>
                <select id="paymentMethod" class="swal2-select">
                  <option value="cash">نقدي</option>
                  <option value="card">بطاقة</option>
                  <option value="department">حساب القسم</option>
                  <option value="insurance">تأمين</option>
                </select>
              </div>
              
              <div class="mb-4">
                <label class="block mb-2">ملاحظات:</label>
                <textarea id="notes" class="swal2-textarea" placeholder="أي ملاحظات إضافية..."></textarea>
              </div>
            </div>
          `,
          width: 600,
          showCancelButton: true,
          confirmButtonText: 'حفظ وطباعة',
          cancelButtonText: 'إلغاء',
          preConfirm: () => {
            return {
              unitPrice: parseFloat(document.getElementById('unitPrice').value) || 0,
              discount: parseFloat(document.getElementById('discount').value) || 0,
              paymentMethod: document.getElementById('paymentMethod').value,
              notes: document.getElementById('notes').value,
              patientName: patientData.name,
              patientId: patientId,
              drugName: medication.name,
              quantity: quantity,
              department: transfer.department
            };
