<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>قسم الأشعة - مستشفى الحياة الذكية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const requestsContainer = document.getElementById("requests");

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString("ar-EG") + " " + date.toLocaleTimeString("ar-EG");
    }

    onValue(ref(db, "radiologyRequests"), (snapshot) => {
      requestsContainer.innerHTML = "";
      snapshot.forEach((childSnap) => {
        const data = childSnap.val();
        const key = childSnap.key;

        const card = document.createElement("div");
        card.className = "bg-white shadow-md rounded-xl p-4 mb-4 border border-gray-200";

        card.innerHTML = `
          <p><span class="font-bold">اسم المريض:</span> ${data.patientName || "غير معروف"}</p>
          <p><span class="font-bold">رقم المريض:</span> ${data.patientId}</p>
          <p><span class="font-bold">نوع الأشعة:</span> ${data.type}</p>
          <p><span class="font-bold">الطبيب المحوّل:</span> ${data.doctor || "غير محدد"}</p>
          <p><span class="font-bold">ملاحظات:</span> ${data.notes || "لا توجد"}</p>
          <p><span class="font-bold">التاريخ:</span> ${formatDate(data.timestamp)}</p>
          <p><span class="font-bold">الحالة:</span> <span id="status-${key}" class="text-blue-600">${data.status}</span></p>
          <div class="mt-3 flex gap-3">
            <button onclick="acceptRequest('${key}')" class="bg-green-600 text-white px-4 py-1 rounded">قبول</button>
            <button onclick="rejectRequest('${key}')" class="bg-red-600 text-white px-4 py-1 rounded">رفض</button>
          </div>
        `;
        requestsContainer.appendChild(card);
      });
    });

    window.acceptRequest = function (key) {
      update(ref(db, "radiologyRequests/" + key), { status: "تم القبول" }).then(() => {
        Swal.fire("تم!", "تم قبول طلب الأشعة.", "success");
      });
    };

    window.rejectRequest = function (key) {
      Swal.fire({
        title: "سبب الرفض؟",
        input: "text",
        inputPlaceholder: "اكتب السبب هنا...",
        showCancelButton: true,
        confirmButtonText: "رفض",
        cancelButtonText: "إلغاء"
      }).then((result) => {
        if (result.isConfirmed && result.value) {
          update(ref(db, "radiologyRequests/" + key), {
            status: "مرفوض - " + result.value
          }).then(() => {
            Swal.fire("تم!", "تم رفض الطلب.", "info");
          });
        }
      });
    };
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">لوحة استقبال طلبات الأشعة</h1>
    <div id="requests"></div>
  </div>
</body>
</html>
