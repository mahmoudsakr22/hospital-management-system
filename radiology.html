<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‚Ø³Ù… Ø§Ù„Ø£Ø´Ø¹Ø© - Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-center mb-6">ğŸ©» Ù‚Ø³Ù… Ø§Ù„Ø£Ø´Ø¹Ø©</h1>

    <!-- Ø¨Ø­Ø« -->
    <input type="text" id="searchInput" oninput="searchRequests()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / ID / Ù†ÙˆØ¹ Ø§Ù„Ø£Ø´Ø¹Ø©" class="w-full p-2 border mb-4 rounded">

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div class="overflow-x-auto">
      <table class="w-full bg-white shadow rounded">
        <thead class="bg-gray-200 text-sm">
          <tr>
            <th class="p-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
            <th class="p-2">ID</th>
            <th class="p-2">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø´Ø¹Ø©</th>
            <th class="p-2">Ø§Ù„Ù‚Ø³Ù…</th>
            <th class="p-2">Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
            <th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th class="p-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="p-2">Ø®ÙŠØ§Ø±Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="requestsTable" class="text-sm">
          <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function fetchRequests() {
      const table = document.getElementById("requestsTable");
      table.innerHTML = "";

      db.ref("radiology_requests").on("value", (snapshot) => {
        table.innerHTML = "";
        snapshot.forEach((child) => {
          const data = child.val();
          const key = child.key;

          const row = `
            <tr class="border-b hover:bg-gray-50">
              <td class="p-2">${data.patientName}</td>
              <td class="p-2">${data.patientID}</td>
              <td class="p-2">${data.scanType}</td>
              <td class="p-2">${data.fromDepartment}</td>
              <td class="p-2">${data.doctor}</td>
              <td class="p-2">${data.createdAt}</td>
              <td class="p-2">
                <span class="px-2 py-1 rounded text-white ${getStatusColor(data.status)}">${data.status}</span>
              </td>
              <td class="p-2 space-x-1">
                <button onclick="updateStatus('${key}', 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°')" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs">Ø¨Ø¯Ø¡</button>
                <button onclick="updateStatus('${key}', 'ØªÙ…')" class="bg-green-600 text-white px-2 py-1 rounded text-xs">ØªÙ…</button>
                <button onclick="rejectRequest('${key}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Ø±ÙØ¶</button>
              </td>
            </tr>
          `;
          table.innerHTML += row;
        });
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    function updateStatus(key, status) {
      db.ref("radiology_requests/" + key).update({ status }).then(() => {
        Swal.fire("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«", "ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ " + status, "success");
      });
    }

    // Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨
    function rejectRequest(key) {
      Swal.fire({
        title: "Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨",
        input: "text",
        inputLabel: "Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶",
        inputPlaceholder: "Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§",
        showCancelButton: true,
        confirmButtonText: "Ø±ÙØ¶",
        cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
        preConfirm: (reason) => {
          if (!reason) {
            Swal.showValidationMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶");
          }
          return reason;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref("radiology_requests/" + key).update({
            status: "Ù…Ø±ÙÙˆØ¶",
            rejectionReason: result.value
          }).then(() => {
            Swal.fire("âŒ Ù…Ø±ÙÙˆØ¶", "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨", "error");
          });
        }
      });
    }

    // Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    function getStatusColor(status) {
      switch (status) {
        case "Ø¨Ø§Ù†ØªØ¸Ø§Ø±": return "bg-yellow-500";
        case "Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°": return "bg-blue-500";
        case "ØªÙ…": return "bg-green-600";
        case "Ù…Ø±ÙÙˆØ¶": return "bg-red-600";
        default: return "bg-gray-400";
      }
    }

    // Ø§Ù„Ø¨Ø­Ø«
    function searchRequests() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#requestsTable tr");

      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? "" : "none";
      });
    }

    fetchRequests();
  </script>
</body>
</html>
