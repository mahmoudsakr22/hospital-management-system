<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>قسم الأشعة - مستشفى الحياة الذكية</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<style>
body { font-family: 'Tajawal', sans-serif; }
.status-badge {
display: inline-flex;
align-items: center;
padding: 0.25rem 0.75rem;
border-radius: 9999px;
font-weight: 500;
}
.card {
border: 1px solid #e5e7eb;
border-radius: 10px;
background: #fff;
margin-bottom: 1rem;
box-shadow: 0 2px 8px #0001;
}
</style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-gray-100 min-h-screen">
<div class="container mx-auto px-4 py-8">
<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
<div class="flex items-center gap-3">
<div class="bg-blue-800 p-3 rounded-lg shadow-md">
<i class="fas fa-x-ray text-white text-2xl"></i>
</div>
<div>
<h1 class="text-2xl font-bold text-gray-800">قسم الأشعة</h1>
<p class="text-gray-600">كل طلبات التحويل للأشعة</p>
</div>
</div>
<div class="flex flex-wrap gap-3">
<button onclick="window.location.href='index.html'" class="bg-green-500 text-white px-4 py-2 rounded-lg">الرئيسية</button>
</div>
</div>

<div class="bg-white p-4 rounded shadow" id="transfersContainer">
<h2 class="text-lg font-semibold mb-4">طلبات التحويل للأشعة</h2>
<div id="transferList"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// تحميل كل طلبات الأشعة في المستشفى
async function loadAllRadiologyTransfers() {
  const list = document.getElementById("transferList");
  list.innerHTML = "<div class='text-gray-500 p-4'>جاري التحميل...</div>";
  const patientsRef = ref(db, `patients/emergency`);
  onValue(patientsRef, async (snapshot) => {
    list.innerHTML = "";
    let found = false;
    const promises = [];
    snapshot.forEach((patientSnap) => {
      const patientId = patientSnap.key;
      const patient = patientSnap.val();
      const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
      promises.push(get(transfersRef).then(transfersSnap => {
        transfersSnap.forEach(child => {
          const t = child.val();
          const key = child.key;
          if (t.department === "radiology") {
            found = true;
            let resultText = "";
            if (t.report) resultText += ` | <span class="text-green-700">النتيجة: ${t.report}</span>`;
            if (t.technician) resultText += ` | <span class="text-blue-700">منفذ الأشعة: ${t.technician}</span>`;
            if (t.lastEditedBy) resultText += ` | <span class="text-gray-700">آخر تعديل بواسطة: ${t.lastEditedBy}</span>`;
            if (t.executionDate) resultText += ` | <span class="text-gray-500">تاريخ التنفيذ: ${t.executionDate}</span>`;
            if (t.device) resultText += ` | <span class="text-purple-700">الجهاز: ${t.device}</span>`;
            // أزرار العمليات
            let actionBtns = "";
            if (t.status === "قيد الانتظار") {
              actionBtns += `<button onclick='editRadiology("${patientId}","${key}", ${JSON.stringify(t)})' class="bg-blue-600 text-white px-2 py-1 rounded ml-2">تعديل</button>`;
            }
            actionBtns += `
              <button onclick='showRadiologyReport(${JSON.stringify(t)})' class="bg-green-600 text-white px-2 py-1 rounded ml-2">عرض تقرير الأشعة</button>
              <button onclick='deleteTransfer("${patientId}","${key}")' class="bg-red-600 text-white px-2 py-1 rounded ml-2">حذف</button>
            `;
            const card = document.createElement("div");
            card.className = "card p-4 mb-4";
            card.innerHTML = `
              <div class="mb-2">
                <b>اسم المريض:</b> ${patient.name || "-"} | <b>العمر:</b> ${patient.age || "-"} | <b>القسم الحالي:</b> ${patient.department || "-"}
              </div>
              <div class="mb-2">
                <b>نوع الأشعة:</b> ${t.type || "-"} | <b>الجهاز:</b> ${t.device || "-"} | <b>ملاحظات:</b> ${t.notes || "-"} | <b>الحالة:</b> <span class="font-bold">${t.status || "قيد الانتظار"}</span>
              </div>
              <div>
                ${resultText}
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                ${actionBtns}
              </div>
            `;
            list.appendChild(card);
          }
        });
      }));
    });
    await Promise.all(promises);
    if (!found) {
      list.innerHTML = "<div class='text-gray-500 p-4'>لا يوجد طلبات تحويل للأشعة في المستشفى.</div>";
    }
  });
}

// تعديل نوع الأشعة (وأي بيانات أخرى) إذا كان الطلب قيد الانتظار
window.editRadiology = function(patientId, key, transfer) {
  Swal.fire({
    title: "تعديل بيانات التحويل",
    html: `
      <label>نوع الأشعة المطلوبة:</label>
      <input id="editType" class="swal2-input" placeholder="نوع الأشعة" value="${transfer.type || ''}">
      <label>الجهاز:</label>
      <input id="editDevice" class="swal2-input" placeholder="الجهاز" value="${transfer.device || ''}">
      <label>ملاحظات:</label>
      <textarea id="editNotes" class="swal2-textarea" placeholder="ملاحظات">${transfer.notes || ''}</textarea>
    `,
    confirmButtonText: "حفظ",
    showCancelButton: true,
    preConfirm: () => {
      return {
        type: document.getElementById('editType').value,
        device: document.getElementById('editDevice').value,
        notes: document.getElementById('editNotes').value
      }
    }
  }).then((result) => {
    if (result.isConfirmed) {
      const data = result.value;
      update(ref(db, `patients/emergency/${patientId}/transfers/${key}`), {
        type: data.type,
        device: data.device,
        notes: data.notes
      }).then(() => {
        Swal.fire("تم الحفظ", "تم تعديل بيانات التحويل بنجاح", "success");
      });
    }
  });
}

// حذف سجل تحويل
window.deleteTransfer = function(patientId, transferKey) {
  Swal.fire({
    title: 'تأكيد الحذف',
    text: "هل أنت متأكد أنك تريد حذف هذا السجل؟",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'نعم، احذف',
    cancelButtonText: 'إلغاء'
  }).then((result) => {
    if (result.isConfirmed) {
      remove(ref(db, `patients/emergency/${patientId}/transfers/${transferKey}`))
        .then(() => {
          Swal.fire('تم الحذف!', 'تم حذف السجل بنجاح.', 'success');
        })
        .catch((error) => {
          Swal.fire('خطأ', 'حدث خطأ أثناء الحذف', 'error');
        });
    }
  });
};

// نافذة عرض تقرير الأشعة
window.showRadiologyReport = function(transfer) {
  let fileHtml = '';
  if (transfer.fileUrl) {
    const ext = transfer.fileUrl.split('.').pop().toLowerCase();
    if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
      fileHtml = `<img src="${transfer.fileUrl}" alt="صورة الأشعة" style="max-width:100%;max-height:40vh;display:block;margin:10px auto;">`;
    } else if (ext === "pdf") {
      fileHtml = `<iframe src="${transfer.fileUrl}" style="width:100%;height:40vh;" frameborder="0"></iframe>`;
    } else {
      fileHtml = `<a href="${transfer.fileUrl}" target="_blank" class="text-blue-700 underline">تحميل الملف</a>`;
    }
  } else {
    fileHtml = `<span class="text-gray-500">لا يوجد ملف مرفق</span>`;
  }

  let html = `
    <div style="text-align:right">
      <p><b>نوع الأشعة:</b> ${transfer.type || "-"}</p>
      <p><b>الجهاز:</b> ${transfer.device || "-"}</p>
      <p><b>منفذ الأشعة:</b> ${transfer.technician || "-"}</p>
      <p><b>تقرير الفني:</b> ${transfer.report || "لا يوجد تقرير"}</p>
      <p><b>آخر تعديل بواسطة:</b> ${transfer.lastEditedBy || "-"}</p>
      <p><b>تاريخ التنفيذ:</b> ${transfer.executionDate || "-"}</p>
      <p><b>ملف الأشعة:</b></p>
      ${fileHtml}
    </div>
  `;
  Swal.fire({
    title: "تقرير الأشعة",
    html: html,
    width: "60vw",
    showCloseButton: true,
    confirmButtonText: "إغلاق"
  });
};

loadAllRadiologyTransfers();
</script>
</body>
</html>
