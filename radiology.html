<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>قسم الأشعة - مستشفى الحياة الذكية</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</head>
<body class="bg-gradient-to-b from-blue-50 to-gray-100 min-h-screen">
<div class="container mx-auto px-4 py-8">

<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
  <div class="flex items-center gap-3">
    <div class="bg-blue-800 p-3 rounded-lg shadow-md">
      <i class="fas fa-x-ray text-white text-2xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold text-gray-800">قسم الأشعة</h1>
      <p class="text-gray-600">طلبات التحويل للأشعة</p>
    </div>
  </div>
  <div class="flex flex-wrap gap-3">
    <button onclick="window.exportRadiology()" class="bg-blue-600 text-white px-4 py-2 rounded mb-2">تصدير الطلبات</button>
    <button onclick="window.location.href='index.html'" class="bg-green-500 text-white px-4 py-2 rounded-lg">الرئيسية</button>
    <button onclick="window.history.back()" class="bg-gray-600 text-white px-4 py-2 rounded-lg">رجوع</button>
  </div>
</div>

<!-- بيانات المريض -->
<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
  <div class="bg-gradient-to-r from-blue-800 to-blue-700 p-6 text-white flex justify-between items-center">
    <div>
      <h2 class="text-2xl font-bold">بيانات المريض</h2>
    </div>
  </div>
  <div class="p-6">
    <div class="bg-gray-50 p-4 rounded-lg">
      <table class="table-auto w-full" id="infoTable"></table>
    </div>
  </div>
</div>

<!-- طلبات التحويل للأشعة -->
<div class="bg-white p-4 rounded shadow" id="transfersContainer">
  <h2 class="text-lg font-semibold mb-4">طلبات التحويل للأشعة</h2>
  <div id="transferList"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// استخراج patientId من الرابط
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

// تحميل بيانات المريض
async function loadPatientData() {
  const infoTable = document.getElementById("infoTable");
  if (!patientId) {
    infoTable.innerHTML = "<tr><td colspan='2'>معرف المريض غير موجود في الرابط.</td></tr>";
    return;
  }
  const patientRef = ref(db, `patients/emergency/${patientId}`);
  const snapshot = await get(patientRef);
  if (snapshot.exists()) {
    const patient = snapshot.val();
    infoTable.innerHTML = `
      <tr><td class="font-semibold py-1">الاسم:</td><td class="py-1">${patient.name || '-'}</td></tr>
      <tr><td class="font-semibold py-1">العمر:</td><td class="py-1">${patient.age || '-'}</td></tr>
      <tr><td class="font-semibold py-1">الرقم القومي:</td><td class="py-1">${patient.nid || '-'}</td></tr>
      <tr><td class="font-semibold py-1">ID:</td><td class="py-1">${patientId}</td></tr>
      <tr><td class="font-semibold py-1">تاريخ الدخول:</td><td class="py-1">${patient.timestamp ? new Date(patient.timestamp).toLocaleString('ar-EG') : '-'}</td></tr>
      <tr><td class="font-semibold py-1">القسم الحالي:</td><td class="py-1">${patient.department || '-'}</td></tr>
      <tr><td class="font-semibold py-1">الطبيب المعالج:</td><td class="py-1">${patient.doctor || '-'}</td></tr>
    `;
  } else {
    infoTable.innerHTML = "<tr><td colspan='2'>لم يتم العثور على بيانات المريض.</td></tr>";
  }
}

// تحميل طلبات التحويل للأشعة
window.loadRadiologyTransfers = function() {
  const list = document.getElementById("transferList");
  list.innerHTML = "";
  if (!patientId) return;
  const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
  onValue(transfersRef, (snapshot) => {
    list.innerHTML = "";
    let found = false;
    snapshot.forEach((child) => {
      const t = child.val();
      const key = child.key;
      if (t.department === "radiology") {
        found = true;
        const status = t.status || "قيد الانتظار";
        let buttons = `
          <button onclick='showRadiologyReport(${JSON.stringify(t)})' class="bg-green-600 text-white px-3 py-1 rounded">عرض النتيجة</button>
          <button onclick='deleteTransfer("${key}")' class="bg-red-600 text-white px-3 py-1 rounded">حذف</button>
        `;
        if (status === "قيد الانتظار") {
          buttons = `
            <button onclick='editRadiology("${key}", ${JSON.stringify(t)})' class="bg-blue-600 text-white px-3 py-1 rounded">تعديل</button>
            ${buttons}
          `;
        }
        const card = document.createElement("div");
        card.className = "card p-4 mb-4";
        card.innerHTML = `
          <div class="mb-2">
            <b>نوع الأشعة:</b> ${t.type || "-"} | 
            <b>الجهاز:</b> ${t.device || "-"} | 
            <b>ملاحظات:</b> ${t.notes || "-"} | 
            <b>الحالة:</b> ${status}
          </div>
          <div class="flex flex-wrap gap-2">
            ${buttons}
          </div>
        `;
        list.appendChild(card);
      }
    });
    if (!found) {
      list.innerHTML = "<div class='text-gray-500 p-4'>لا يوجد طلبات تحويل للأشعة لهذا المريض.</div>";
    }
  });
};

// تعديل سجل الأشعة
window.editRadiology = function(key, transfer) {
  Swal.fire({
    title: "تعديل سجل الأشعة",
    html: `
      <input id="technician" class="swal2-input" placeholder="اسم الفني" value="${transfer.technician || ''}">
      <input id="executionDate" class="swal2-input" placeholder="تاريخ التنفيذ" value="${transfer.executionDate || new Date().toLocaleString('ar-EG')}">
      <textarea id="report" class="swal2-textarea" placeholder="تقرير الفني">${transfer.report || ''}</textarea>
      <input id="fileUrl" class="swal2-input" placeholder="رابط ملف النتيجة (صورة أو PDF)" value="${transfer.fileUrl || ''}">
    `,
    confirmButtonText: "حفظ",
    showCancelButton: true,
    preConfirm: () => {
      return {
        technician: document.getElementById('technician').value,
        executionDate: document.getElementById('executionDate').value,
        report: document.getElementById('report').value,
        fileUrl: document.getElementById('fileUrl').value
      }
    }
  }).then((result) => {
    if (result.isConfirmed) {
      const data = result.value;
      update(ref(db, `patients/emergency/${patientId}/transfers/${key}`), {
        technician: data.technician,
        executionDate: data.executionDate,
        report: data.report,
        fileUrl: data.fileUrl,
        status: "تم التنفيذ",
        lastEditedBy: "موظف الأشعة"
      }).then(() => {
        Swal.fire("تم الحفظ", "تم حفظ نتيجة الأشعة بنجاح", "success");
      });
    }
  });
}

// عرض نتيجة الأشعة
window.showRadiologyReport = function(transfer) {
  let fileHtml = '';
  if (transfer.fileUrl) {
    const ext = transfer.fileUrl.split('.').pop().toLowerCase();
    if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
      fileHtml = `<img src="${transfer.fileUrl}" alt="صورة الأشعة" style="max-width:100%;max-height:40vh;display:block;margin:10px auto;">`;
    } else if (ext === "pdf") {
      fileHtml = `<iframe src="${transfer.fileUrl}" style="width:100%;height:40vh;" frameborder="0"></iframe>`;
    } else {
      fileHtml = `<a href="${transfer.fileUrl}" target="_blank" class="text-blue-700 underline">تحميل الملف</a>`;
    }
  } else {
    fileHtml = `<span class="text-gray-500">لا يوجد ملف مرفق</span>`;
  }

  let html = `
    <div style="text-align:right">
      <p><b>نوع الأشعة:</b> ${transfer.type || "-"}</p>
      <p><b>الجهاز:</b> ${transfer.device || "-"}</p>
      <p><b>منفذ الأشعة:</b> ${transfer.technician || "-"}</p>
      <p><b>تقرير الفني:</b> ${transfer.report || "لا يوجد تقرير"}</p>
      <p><b>آخر تعديل بواسطة:</b> ${transfer.lastEditedBy || "-"}</p>
      <p><b>تاريخ التنفيذ:</b> ${transfer.executionDate || "-"}</p>
      <p><b>ملف الأشعة:</b></p>
      ${fileHtml}
    </div>
  `;
  Swal.fire({
    title: "نتيجة الأشعة",
    html: html,
    width: "60vw",
    showCloseButton: true,
    confirmButtonText: "إغلاق"
  });
};

// حذف سجل التحويل
window.deleteTransfer = function(key) {
  Swal.fire({
    title: 'تأكيد الحذف',
    text: "هل أنت متأكد أنك تريد حذف هذا السجل؟",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'نعم، احذف',
    cancelButtonText: 'إلغاء'
  }).then((result) => {
    if (result.isConfirmed) {
      remove(ref(db, `patients/emergency/${patientId}/transfers/${key}`))
        .then(() => {
          Swal.fire('تم الحذف!', 'تم حذف السجل بنجاح.', 'success');
        })
        .catch((error) => {
          Swal.fire('خطأ', 'حدث خطأ أثناء الحذف', 'error');
        });
    }
  });
};

// تصدير الطلبات كـ CSV (اختياري)
window.exportRadiology = async function() {
  const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
  const snapshot = await get(transfersRef);
  let rows = [["نوع الإجراء", "التاريخ", "الحالة", "اسم الفني", "رابط الملف"]];
  snapshot.forEach(child => {
    const t = child.val();
    if (t.department === "radiology") {
      rows.push([t.type, t.date, t.status || "", t.technician || "", t.fileUrl || ""]);
    }
  });
  let csv = rows.map(r => r.join(",")).join("\n");
  let blob = new Blob([csv], {type: "text/csv"});
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "radiology_requests.csv";
  link.click();
};

// تحميل البيانات عند فتح الصفحة
if (patientId) {
  loadPatientData();
  window.loadRadiologyTransfers();
}
</script>
</body>
</html>
