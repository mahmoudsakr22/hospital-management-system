<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>قسم الأشعة - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-center mb-6">🩻 قسم الأشعة</h1>

    <!-- بحث -->
    <input type="text" id="searchInput" oninput="searchRequests()" placeholder="بحث بالاسم / ID / نوع الأشعة" class="w-full p-2 border mb-4 rounded">

    <!-- جدول الطلبات -->
    <div class="overflow-x-auto">
      <table class="w-full bg-white shadow rounded">
        <thead class="bg-gray-200 text-sm">
          <tr>
            <th class="p-2">اسم المريض</th>
            <th class="p-2">ID</th>
            <th class="p-2">نوع الأشعة</th>
            <th class="p-2">القسم</th>
            <th class="p-2">الطبيب</th>
            <th class="p-2">التاريخ</th>
            <th class="p-2">الحالة</th>
            <th class="p-2">خيارات</th>
          </tr>
        </thead>
        <tbody id="requestsTable" class="text-sm">
          <!-- البيانات من Firebase -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // عرض الطلبات
    function fetchRequests() {
      const table = document.getElementById("requestsTable");
      table.innerHTML = "";

      db.ref("radiology_requests").on("value", (snapshot) => {
        table.innerHTML = "";
        snapshot.forEach((child) => {
          const data = child.val();
          const key = child.key;

          const row = `
            <tr class="border-b hover:bg-gray-50">
              <td class="p-2">${data.patientName}</td>
              <td class="p-2">${data.patientID}</td>
              <td class="p-2">${data.scanType}</td>
              <td class="p-2">${data.fromDepartment}</td>
              <td class="p-2">${data.doctor}</td>
              <td class="p-2">${data.createdAt}</td>
              <td class="p-2">
                <span class="px-2 py-1 rounded text-white ${getStatusColor(data.status)}">${data.status}</span>
              </td>
              <td class="p-2 space-x-1">
                <button onclick="updateStatus('${key}', 'جارٍ التنفيذ')" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs">بدء</button>
                <button onclick="updateStatus('${key}', 'تم')" class="bg-green-600 text-white px-2 py-1 rounded text-xs">تم</button>
                <button onclick="rejectRequest('${key}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">رفض</button>
              </td>
            </tr>
          `;
          table.innerHTML += row;
        });
      });
    }

    // تحديث الحالة
    function updateStatus(key, status) {
      db.ref("radiology_requests/" + key).update({ status }).then(() => {
        Swal.fire("✅ تم التحديث", "تم تغيير حالة الطلب إلى " + status, "success");
      });
    }

    // رفض الطلب
    function rejectRequest(key) {
      Swal.fire({
        title: "رفض الطلب",
        input: "text",
        inputLabel: "سبب الرفض",
        inputPlaceholder: "اكتب السبب هنا",
        showCancelButton: true,
        confirmButtonText: "رفض",
        cancelButtonText: "إلغاء",
        preConfirm: (reason) => {
          if (!reason) {
            Swal.showValidationMessage("الرجاء كتابة سبب الرفض");
          }
          return reason;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref("radiology_requests/" + key).update({
            status: "مرفوض",
            rejectionReason: result.value
          }).then(() => {
            Swal.fire("❌ مرفوض", "تم رفض الطلب", "error");
          });
        }
      });
    }

    // لون الحالة
    function getStatusColor(status) {
      switch (status) {
        case "بانتظار": return "bg-yellow-500";
        case "جارٍ التنفيذ": return "bg-blue-500";
        case "تم": return "bg-green-600";
        case "مرفوض": return "bg-red-600";
        default: return "bg-gray-400";
      }
    }

    // البحث
    function searchRequests() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#requestsTable tr");

      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? "" : "none";
      });
    }

    fetchRequests();
  </script>
</body>
</html>
