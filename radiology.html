<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‚Ø³Ù… Ø§Ù„Ø£Ø´Ø¹Ø© - Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 500;
    }
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px #0001;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <div class="flex items-center gap-3">
        <div class="bg-blue-800 p-3 rounded-lg shadow-md">
          <i class="fas fa-x-ray text-white text-2xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Ù‚Ø³Ù… Ø§Ù„Ø£Ø´Ø¹Ø©</h1>
          <p class="text-gray-600">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø´Ø¹Ø©</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-3">
        <button onclick="window.exportRadiology()" class="bg-blue-600 text-white px-4 py-2 rounded mb-2">ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button onclick="window.location.href='index.html'" class="bg-green-500 text-white px-4 py-2 rounded-lg">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button onclick="window.history.back()" class="bg-gray-600 text-white px-4 py-2 rounded-lg">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div id="stats" class="mb-6"></div>

    <!-- ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div class="mb-4">
      <label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
      <select id="filterStatus" class="border rounded p-2" onchange="window.loadRadiologyTransfers()">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
        <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</option>
        <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
        <option value="ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</option>
        <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
      </select>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
      <div class="bg-gradient-to-r from-blue-800 to-blue-700 p-6 text-white flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
        </div>
      </div>
      <div class="p-6">
        <div class="bg-gray-50 p-4 rounded-lg">
          <table class="table-auto w-full" id="infoTable"></table>
        </div>
      </div>
    </div>

    <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø´Ø¹Ø© -->
    <div class="bg-white p-4 rounded shadow" id="transfersContainer">
      <h2 class="text-lg font-semibold mb-4">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø´Ø¹Ø©</h2>
      <div id="transferList"></div>
    </div>
  </div>

  <!-- Firebase & Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
      authDomain: "hospital-project-e4b59.firebaseapp.com",
      databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hospital-project-e4b59",
      storageBucket: "hospital-project-e4b59.appspot.com",
      messagingSenderId: "974610606258",
      appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ patientId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
    async function loadPatientData() {
      const infoTable = document.getElementById("infoTable");
      if (!patientId) {
        infoTable.innerHTML = "<tr><td colspan='2'>Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.</td></tr>";
        return;
      }
      const patientRef = ref(db, `patients/emergency/${patientId}`);
      const snapshot = await get(patientRef);
      if (snapshot.exists()) {
        const patient = snapshot.val();
        infoTable.innerHTML = `
          <tr><td class="font-semibold py-1">Ø§Ù„Ø§Ø³Ù…:</td><td class="py-1">${patient.name || '-'}</td></tr>
          <tr><td class="font-semibold py-1">Ø§Ù„Ø¹Ù…Ø±:</td><td class="py-1">${patient.age || '-'}</td></tr>
          <tr><td class="font-semibold py-1">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</td><td class="py-1">${patient.nid || '-'}</td></tr>
          <tr><td class="font-semibold py-1">ID:</td><td class="py-1">${patientId}</td></tr>
          <tr><td class="font-semibold py-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„:</td><td class="py-1">${patient.timestamp ? new Date(patient.timestamp).toLocaleString('ar-EG') : '-'}</td></tr>
          <tr><td class="font-semibold py-1">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</td><td class="py-1">${patient.department || '-'}</td></tr>
          <tr><td class="font-semibold py-1">Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:</td><td class="py-1">${patient.doctor || '-'}</td></tr>
        `;
      } else {
        infoTable.innerHTML = "<tr><td colspan='2'>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶.</td></tr>";
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø´Ø¹Ø© Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª
    window.loadRadiologyTransfers = function() {
      const list = document.getElementById("transferList");
      const filterStatus = document.getElementById("filterStatus")?.value || "";
      list.innerHTML = "";
      if (!patientId) return;
      const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
      onValue(transfersRef, (snapshot) => {
        list.innerHTML = "";
        let found = false, total=0, done=0, pending=0, waiting=0, rejected=0;
        snapshot.forEach((child) => {
          const t = child.val();
          // Ø§Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø´Ø¹Ø© ÙˆØ£ÙŠ Ø­Ø§Ù„Ø© (Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±)
          if (t.department === "radiology" && (!filterStatus || t.status === filterStatus)) {
            found = true; total++;
            if (t.status === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°") done++;
            else if (t.status === "Ù…Ø±ÙÙˆØ¶") rejected++;
            else if (t.status === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±") waiting++;
            else pending++;

            const key = child.key;
            const status = t.status || "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
            let statusColor = "bg-yellow-100 text-yellow-800";
            if (status === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°") statusColor = "bg-green-100 text-green-800";
            if (status === "Ù…Ø±ÙÙˆØ¶") statusColor = "bg-red-100 text-red-800";
            if (status === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±") statusColor = "bg-gray-200 text-gray-800";

            // ØªØ¹Ù„ÙŠÙ‚Ø§Øª
            const comments = t.comments || [];
            let commentsHtml = comments.map(c => `<li>ğŸ—¨ï¸ ${c.text} <span class="text-xs text-gray-400">(${c.date})</span></li>`).join("");

            // Ù…Ù„Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©
            let fileHtml = "";
            if (t.fileUrl) {
              fileHtml = `<a href="${t.fileUrl}" target="_blank" class="text-blue-700 underline">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</a>
                <div id="qr_${key}" class="mt-2"></div>`;
            }

            // ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
            let instructionsHtml = t.instructions ? `<div><span class="font-bold">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨:</span> ${t.instructions}</div>` : "";

            // Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø·Ù„Ø¨
            let priorityHtml = `<span class="font-bold">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</span> ${t.priority || "Ø¹Ø§Ø¯ÙŠ"}`;

            // Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„
            let scheduledHtml = `<label>Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°:</label>
              <input type="datetime-local" id="execDate_${key}" value="${t.scheduledDate || ""}" class="border rounded p-2 w-full mb-2" />`;

            // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙØ¹Ù„ÙŠ
            let execDateHtml = t.executionDate ? `<div class="text-xs text-green-700">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° ÙØ¹Ù„ÙŠÙ‹Ø§: ${t.executionDate}</div>` : "";

            // Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„
            let lastEditHtml = t.lastEditedBy ? `<div class="text-xs text-gray-400">Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø©: ${t.lastEditedBy} (${t.lastEditDate || ""})</div>` : "";

            const card = document.createElement("div");
            card.className = "card p-4 mb-4";
            card.innerHTML = `
              <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2 mb-2">
                <div>
                  <span class="font-bold">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</span> ${t.type} <br>
                  <span class="font-bold">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${t.date} <br>
                  ${priorityHtml}<br>
                  ${instructionsHtml}
                  <span class="font-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span> ${t.notes || "Ø¨Ø¯ÙˆÙ† Ù…Ù„Ø§Ø­Ø¸Ø§Øª"}
                </div>
                <div>
                  <span class="status-badge ${statusColor}">${status}</span>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                <div>
                  <label class="block mb-1 text-gray-700">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                  <select id="status_${key}" class="border rounded p-2 w-full">
                    <option value="Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ${status === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ? "selected" : ""}>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                    <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„" ${status === "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„" ? "selected" : ""}>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</option>
                    <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${status === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ? "selected" : ""}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                    <option value="ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°" ${status === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°" ? "selected" : ""}>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                    <option value="Ù…Ø±ÙÙˆØ¶" ${status === "Ù…Ø±ÙÙˆØ¶" ? "selected" : ""}>Ù…Ø±ÙÙˆØ¶</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-gray-700">Ø§Ø³Ù… Ù…Ù†ÙØ° Ø§Ù„Ø£Ø´Ø¹Ø©:</label>
                  <input type="text" id="tech_${key}" class="border rounded p-2 w-full" value="${t.technician || ""}" placeholder="Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ø·Ø¨ÙŠØ¨" />
                </div>
              </div>
              <div class="mb-2">
                <label class="block mb-1 text-gray-700">ØªÙ‚Ø±ÙŠØ±/Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø´Ø¹Ø©:</label>
                <textarea id="report_${key}" class="border rounded p-2 w-full" rows="2" placeholder="Ø§ÙƒØªØ¨ ØªÙ‚Ø±ÙŠØ± Ø£Ùˆ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø´Ø¹Ø©">${t.report || ""}</textarea>
              </div>
              <div class="mb-2">
                <label class="block mb-1 text-gray-700">Ø±ÙØ¹ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø´Ø¹Ø© (ØµÙˆØ±Ø© Ø£Ùˆ PDF):</label>
                <input type="file" id="file_${key}" accept="image/*,application/pdf" class="mb-2" />
                <button onclick="window.uploadRadiologyFile('${key}')" class="bg-gray-700 text-white px-2 py-1 rounded">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>
                <div id="fileLink_${key}" class="mt-1">${fileHtml}</div>
              </div>
              <div class="mb-2">
                ${scheduledHtml}
                ${execDateHtml}
              </div>
              <div class="mb-2">
                <label>ØªØ¹Ù„ÙŠÙ‚Ø§Øª:</label>
                <ul id="comments_${key}" class="mb-2">${commentsHtml}</ul>
                <input type="text" id="commentInput_${key}" class="border rounded p-2 w-2/3" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚..." />
                <button onclick="window.addComment('${key}')" class="bg-gray-700 text-white px-2 py-1 rounded">Ø¥Ø¶Ø§ÙØ©</button>
              </div>
              <button class="bg-blue-700 hover:bg-blue-900 text-white px-4 py-2 rounded" onclick="window.saveRadiology('${key}')">
                <i class="fas fa-save mr-2"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
              </button>
              ${lastEditHtml}
            `;
            list.appendChild(card);

            // ØªÙˆÙ„ÙŠØ¯ QR Ù„Ù„Ù…Ù„Ù
            if (t.fileUrl) {
              setTimeout(() => {
                QRCode.toCanvas(document.getElementById(`qr_${key}`), t.fileUrl, function (error) {});
              }, 100);
            }
          }
        });
        if (!found) {
          list.innerHTML = "<div class='text-gray-500 p-4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø´Ø¹Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶.</div>";
        }
        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        document.getElementById("stats").innerHTML =
          `<span class="mr-4">Ø§Ù„ÙƒÙ„: ${total}</span>
           <span class="mr-4 text-green-700">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°: ${done}</span>
           <span class="mr-4 text-yellow-700">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ${waiting}</span>
           <span class="mr-4 text-yellow-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„/Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: ${pending}</span>
           <span class="mr-4 text-red-700">Ù…Ø±ÙÙˆØ¶: ${rejected}</span>`;
      });
    };

    // Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©
    window.uploadRadiologyFile = async function(key) {
      const fileInput = document.getElementById(`file_${key}`);
      if (!fileInput.files.length) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ø®ØªØ± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹", "warning");
      const file = fileInput.files[0];
      const storageRef = sRef(storage, `radiology/${patientId}/${key}/${file.name}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await update(ref(db, `patients/emergency/${patientId}/transfers/${key}`), { fileUrl: url });
      document.getElementById(`fileLink_${key}`).innerHTML = `<a href="${url}" target="_blank" class="text-blue-700 underline">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù</a>`;
      Swal.fire("ØªÙ…", "ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
      window.loadRadiologyTransfers();
    };

    // Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
    window.addComment = async function(key) {
      const input = document.getElementById(`commentInput_${key}`);
      const comment = input.value.trim();
      if (!comment) return;
      const transferRef = ref(db, `patients/emergency/${patientId}/transfers/${key}`);
      const snapshot = await get(transferRef);
      let comments = (snapshot.val().comments || []);
      comments.push({ text: comment, date: new Date().toLocaleString('ar-EG') });
      await update(transferRef, { comments });
      input.value = "";
      window.loadRadiologyTransfers();
    };

    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨
    window.saveRadiology = async function(key) {
      const status = document.getElementById(`status_${key}`).value;
      const report = document.getElementById(`report_${key}`).value.trim();
      const technician = document.getElementById(`tech_${key}`).value.trim();
      const scheduledDate = document.getElementById(`execDate_${key}`).value;
      const lastEditedBy = "Ù…ÙˆØ¸Ù Ø§Ù„Ø£Ø´Ø¹Ø©";
      let updates = { status, report, technician, scheduledDate, lastEditedBy, lastEditDate: new Date().toLocaleString('ar-EG') };

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
      const transferRef = ref(db, `patients/emergency/${patientId}/transfers/${key}`);
      const snapshot = await get(transferRef);
      const t = snapshot.val();

      // Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
      if (status === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°" && !t.executionDate) {
        updates.executionDate = new Date().toLocaleString('ar-EG');
        // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ø¨ÙŠØ¨ (ØªØ³Ø¬ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        const patientRef = ref(db, `patients/emergency/${patientId}`);
        const patientSnap = await get(patientRef);
        const patient = patientSnap.val() || {};
        const notifRef = ref(db, `notifications/${patientId}`);
        await push(notifRef, {
          message: `ØªÙ… ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨ Ø§Ù„Ø£Ø´Ø¹Ø© (${t.type}) Ù„Ù„Ù…Ø±ÙŠØ¶ ${patient.name || patientId}`,
          date: new Date().toLocaleString('ar-EG'),
          seen: false
        });
      }
      await update(transferRef, updates);
      Swal.fire({
        icon: "success",
        title: "ØªÙ… Ø§Ù„Ø­ÙØ¸",
        text: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.",
        timer: 1500,
        showConfirmButton: false
      });
    };

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ€ CSV
    window.exportRadiology = async function() {
      const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
      const snapshot = await get(transfersRef);
      let rows = [["Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", "Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ", "Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù"]];
      snapshot.forEach(child => {
        const t = child.val();
        if (t.department === "Ø§Ù„Ø§Ø´Ø¹Ø©") {
          rows.push([t.type, t.date, t.status || "", t.technician || "", t.fileUrl || ""]);
        }
      });
      let csv = rows.map(r => r.join(",")).join("\n");
      let blob = new Blob([csv], {type: "text/csv"});
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "radiology_requests.csv";
      link.click();
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    if (patientId) {
      loadPatientData();
      window.loadRadiologyTransfers();
    }
  </script>
</body>
</html>
