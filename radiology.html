<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>قسم الأشعة - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-center">قسم الأشعة - مستشفى الحياة الذكية</h1>
    
    <div id="patientsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // جلب المرضى المحولين لقسم الأشعة
    db.ref("patients").on("value", (snapshot) => {
      const container = document.getElementById("patientsContainer");
      container.innerHTML = "";
      snapshot.forEach((child) => {
        const data = child.val();
        const id = child.key;
        if (data.currentSection === "الأشعة") {
          const div = document.createElement("div");
          div.className = "bg-white p-4 rounded shadow";
          div.innerHTML = `
            <h2 class="text-xl font-semibold mb-2">${data.name}</h2>
            <p><strong>العمر:</strong> ${data.age}</p>
            <p><strong>الرقم القومي:</strong> ${data.nationalId}</p>
            <p><strong>تاريخ الدخول:</strong> ${data.entryDate}</p>
            <div class="mt-2">
              <button onclick="showReportForm('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">إضافة تقرير أشعة</button>
              <button onclick="viewReports('${id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded ml-2">عرض التقارير</button>
            </div>
            <div id="reportForm-${id}" class="mt-4 hidden">
              <h3 class="font-bold mb-1">تقرير جديد:</h3>
              <input id="type-${id}" class="border p-1 w-full mb-2" placeholder="نوع الأشعة" />
              <textarea id="notes-${id}" class="border p-1 w-full mb-2" placeholder="ملاحظات"></textarea>
              <button onclick="saveReport('${id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">حفظ التقرير</button>
            </div>
            <div id="reports-${id}" class="mt-4 text-sm"></div>
          `;
          container.appendChild(div);
        }
      });
    });

    function showReportForm(id) {
      document.getElementById(`reportForm-${id}`).classList.toggle("hidden");
    }

    function saveReport(id) {
      const type = document.getElementById(`type-${id}`).value;
      const notes = document.getElementById(`notes-${id}`).value;
      const date = new Date().toLocaleDateString("ar-EG");

      if (!type || !notes) {
        Swal.fire("يرجى تعبئة جميع الحقول", "", "warning");
        return;
      }

      const reportData = {
        type,
        notes,
        date
      };

      db.ref(`patients/${id}/radiologyReports`).push(reportData).then(() => {
        Swal.fire("تم حفظ التقرير بنجاح", "", "success");
        document.getElementById(`type-${id}`).value = "";
        document.getElementById(`notes-${id}`).value = "";
      });
    }

    function viewReports(id) {
      const container = document.getElementById(`reports-${id}`);
      container.innerHTML = "<p class='text-gray-500'>جاري التحميل...</p>";
      db.ref(`patients/${id}/radiologyReports`).once("value", (snapshot) => {
        if (!snapshot.exists()) {
          container.innerHTML = "<p class='text-gray-500'>لا توجد تقارير بعد</p>";
          return;
        }
        let html = `<h4 class="font-semibold mb-1">سجل تقارير الأشعة:</h4>`;
        snapshot.forEach((reportSnap) => {
          const r = reportSnap.val();
          html += `
            <div class="bg-gray-100 p-2 mb-1 rounded">
              <p><strong>التاريخ:</strong> ${r.date}</p>
              <p><strong>النوع:</strong> ${r.type}</p>
              <p><strong>ملاحظات:</strong> ${r.notes}</p>
            </div>
          `;
        });
        container.innerHTML = html;
      });
    }
  </script>
</body>
</html>
