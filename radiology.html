<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>قسم الأشعة - مستشفى الحياة الذكية</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: 'Tajawal', sans-serif; }
.card {
border: 1px solid #e5e7eb;
border-radius: 10px;
background: #fff;
margin-bottom: 1rem;
box-shadow: 0 2px 8px #0001;
}
.status-badge {
display: inline-flex;
align-items: center;
padding: 0.25rem 0.75rem;
border-radius: 9999px;
font-weight: 500;
}
.bg-green-100 { background: #d1fae5; color: #065f46; }
.bg-yellow-100 { background: #fef9c3; color: #92400e; }
.bg-red-100 { background: #fee2e2; color: #991b1b; }
.bg-gray-200 { background: #e5e7eb; color: #374151; }
</style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-gray-100 min-h-screen">
<div class="container mx-auto px-4 py-8">

<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
  <div class="flex items-center gap-3">
    <div class="bg-blue-800 p-3 rounded-lg shadow-md">
      <i class="fas fa-x-ray text-white text-2xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold text-gray-800">قسم الأشعة</h1>
      <p class="text-gray-600">كل طلبات التحويل للأشعة</p>
    </div>
  </div>
  <div class="flex flex-wrap gap-3">
    <button onclick="window.location.href='index.html'" class="bg-green-500 text-white px-4 py-2 rounded-lg">الرئيسية</button>
  </div>
</div>

<!-- لوحة الإحصائيات -->
<div class="flex flex-col md:flex-row gap-4 mb-6">
  <div class="bg-white rounded shadow p-4 flex-1 text-center">
    <div class="text-2xl font-bold" id="count-today">0</div>
    <div>طلبات اليوم</div>
  </div>
  <div class="bg-white rounded shadow p-4 flex-1 text-center">
    <div class="text-2xl font-bold" id="count-month">0</div>
    <div>طلبات هذا الشهر</div>
  </div>
  <div class="bg-white rounded shadow p-4 flex-1 text-center">
    <div class="text-2xl font-bold" id="count-all">0</div>
    <div>إجمالي الطلبات</div>
  </div>
  <div class="bg-white rounded shadow p-4 flex-1 text-center">
    <canvas id="statusChart" width="100" height="100"></canvas>
    <div class="text-xs mt-2">توزيع الحالات</div>
  </div>
</div>

<!-- تصفية وبحث -->
<div class="flex flex-col md:flex-row gap-4 mb-4">
  <div>
    <label>تصفية حسب الحالة:</label>
    <select id="filterStatus" class="border rounded p-2" onchange="loadAllRadiologyTransfers()">
      <option value="">الكل</option>
      <option value="قيد الانتظار">قيد الانتظار</option>
      <option value="تم التنفيذ">تم التنفيذ</option>
      <option value="مرفوض">مرفوض</option>
    </select>
  </div>
  <div>
    <label>بحث:</label>
    <input id="searchInput" class="border rounded p-2" placeholder="اسم/نوع أشعة/رقم هوية/رقم طلب..." oninput="loadAllRadiologyTransfers()">
  </div>
  <div>
    <label>تصفية بالتاريخ:</label>
    <input type="date" id="dateFrom" class="border rounded p-2" onchange="loadAllRadiologyTransfers()">
    <input type="date" id="dateTo" class="border rounded p-2" onchange="loadAllRadiologyTransfers()">
  </div>
</div>

<div class="bg-white p-4 rounded shadow" id="transfersContainer">
<h2 class="text-lg font-semibold mb-4">طلبات التحويل للأشعة</h2>
<div id="transferList"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function statusColor(status) {
  if (status === "تم التنفيذ") return "bg-green-100";
  if (status === "مرفوض") return "bg-red-100";
  if (status === "قيد الانتظار") return "bg-yellow-100";
  return "bg-gray-200";
}

async function loadAllRadiologyTransfers() {
  const list = document.getElementById("transferList");
  const filterStatus = document.getElementById("filterStatus").value;
  const searchValue = document.getElementById("searchInput").value.trim().toLowerCase();
  const dateFrom = document.getElementById("dateFrom").value;
  const dateTo = document.getElementById("dateTo").value;
  list.innerHTML = "<div class='text-gray-500 p-4'>جاري التحميل...</div>";
  const patientsRef = ref(db, `patients/emergency`);
  onValue(patientsRef, async (snapshot) => {
    list.innerHTML = "";
    let found = false, total=0, done=0, waiting=0, rejected=0, today=0, month=0;
    let statusCounts = { "تم التنفيذ": 0, "قيد الانتظار": 0, "مرفوض": 0 };
    const now = new Date();
    const todayStr = now.toLocaleDateString('ar-EG');
    const monthStr = now.getMonth() + 1;
    const promises = [];
    snapshot.forEach((patientSnap) => {
      const patientId = patientSnap.key;
      const patient = patientSnap.val();
      const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
      promises.push(get(transfersRef).then(transfersSnap => {
        transfersSnap.forEach(child => {
          const t = child.val();
          const key = child.key;
          if (t.department === "radiology") {
            // فلترة حسب الحالة
            if (filterStatus && t.status !== filterStatus) return;
            // بحث باسم المريض أو نوع الأشعة أو رقم الهوية أو رقم الطلب
            if (searchValue) {
              const name = (patient.name || "").toLowerCase();
              const type = (t.type || "").toLowerCase();
              const nid = (patient.nid || "").toLowerCase();
              if (!name.includes(searchValue) && !type.includes(searchValue) && !nid.includes(searchValue) && !key.includes(searchValue)) return;
            }
            // فلترة بالتاريخ
            if (dateFrom || dateTo) {
              let reqDate = t.date ? new Date(t.date) : null;
              if (reqDate) {
                if (dateFrom && reqDate < new Date(dateFrom)) return;
                if (dateTo && reqDate > new Date(dateTo)) return;
              }
            }
            found = true; total++;
            if (t.status === "تم التنفيذ") done++;
            else if (t.status === "مرفوض") rejected++;
            else waiting++;
            statusCounts[t.status] = (statusCounts[t.status] || 0) + 1;
            // عدادات اليوم والشهر
            if (t.date && t.date.includes(todayStr)) today++;
            if (t.date && (new Date(t.date).getMonth() + 1) === monthStr) month++;
            // بطاقة الطلب
            const card = document.createElement("div");
            card.className = "card p-4 mb-4";
            card.innerHTML = `
              <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2 mb-2">
                <div>
                  <b>اسم المريض:</b> ${patient.name || "-"}<br>
                  <b>نوع الأشعة:</b> ${t.type || "-"}<br>
                  <b>الجهاز:</b> ${t.device || "-"}<br>
                  <b>ملاحظات:</b> ${t.notes || "-"}
                </div>
                <div>
                  <span class="status-badge ${statusColor(t.status)}">${t.status || "قيد الانتظار"}</span>
                  ${t.status === "تم التنفيذ" ? `<button onclick="window.print()" class="bg-green-700 text-white px-2 py-1 rounded ml-2"><i class="fas fa-print"></i> طباعة</button>
                  <button onclick="rateService('${patientId}','${key}')" class="bg-yellow-600 text-white px-2 py-1 rounded ml-2"><i class="fas fa-star"></i> تقييم الخدمة</button>
                  <button onclick="sendResultToDoctor('${patientId}','${key}')" class="bg-blue-700 text-white px-2 py-1 rounded ml-2"><i class="fas fa-paper-plane"></i> إرسال للطبيب</button>
                  ` : ""}
                </div>
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                <button onclick='window.location.href="radiology-action.html?patient=${encodeURIComponent(patientId)}&transfer=${encodeURIComponent(key)}"' class="bg-blue-600 text-white px-2 py-1 rounded ml-2">تنفيذ الطلب</button>
                <button onclick='toggleDetails(this)' class="bg-gray-400 text-white px-2 py-1 rounded ml-2">تفاصيل</button>
                <button onclick='copyToClipboard("${key}")' class="bg-gray-200 text-gray-800 px-2 py-1 rounded ml-2"><i class="fas fa-copy"></i> نسخ رقم الطلب</button>
                <button onclick='showTimeline(${JSON.stringify(t)})' class="bg-purple-600 text-white px-2 py-1 rounded ml-2"><i class="fas fa-stream"></i> تتبع الطلب</button>
                <button onclick='uploadMultipleFiles("${patientId}","${key}")' class="bg-indigo-600 text-white px-2 py-1 rounded ml-2"><i class="fas fa-upload"></i> رفع ملفات متعددة</button>
              </div>
              <div class="hidden mt-3 details">
                <b>تاريخ الطلب:</b> ${t.date || "-"}<br>
                <b>آخر تعديل:</b> ${t.lastEditedBy ? `${t.lastEditedBy} (${t.lastEditDate || ""})` : "-"}<br>
                <b>رابط الملف:</b> ${t.fileUrl ? `<a href="${t.fileUrl}" target="_blank" class="text-blue-700 underline">عرض الملف</a>` : "-"}
                <div class="mt-2"><b>QR:</b> <canvas id="qr_${key}" class="w-20 h-20"></canvas></div>
              </div>
            `;
            list.appendChild(card);
            // توليد QR
            setTimeout(() => {
              if (document.getElementById(`qr_${key}`)) {
                QRCode.toCanvas(document.getElementById(`qr_${key}`), key, function (error) {});
              }
            }, 100);
          }
        });
      }));
    });
    await Promise.all(promises);
    if (!found) {
      list.innerHTML = "<div class='text-gray-500 p-4'>لا يوجد طلبات تحويل للأشعة في المستشفى.</div>";
    }
    // إحصائيات
    document.getElementById("count-today").textContent = today;
    document.getElementById("count-month").textContent = month;
    document.getElementById("count-all").textContent = total;
    // رسم بياني دائري
    const ctx = document.getElementById('statusChart').getContext('2d');
    if (window.statusChartObj) window.statusChartObj.destroy();
    window.statusChartObj = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['تم التنفيذ', 'قيد الانتظار', 'مرفوض'],
        datasets: [{
          data: [statusCounts["تم التنفيذ"] || 0, statusCounts["قيد الانتظار"] || 0, statusCounts["مرفوض"] || 0],
          backgroundColor: ['#22c55e', '#facc15', '#ef4444']
        }]
      },
      options: { plugins: { legend: { display: false } }, cutout: '70%' }
    });
  });
}

window.toggleDetails = function(btn) {
  const details = btn.parentElement.parentElement.querySelector('.details');
  if (details.classList.contains('hidden')) {
    details.classList.remove('hidden');
    btn.textContent = "إخفاء التفاصيل";
  } else {
    details.classList.add('hidden');
    btn.textContent = "تفاصيل";
  }
};

window.copyToClipboard = function(text) {
  navigator.clipboard.writeText(text);
  Swal.fire({ icon: "success", title: "تم نسخ رقم الطلب!", timer: 900, showConfirmButton: false });
};

window.showTimeline = function(t) {
  let html = `
    <ul class="text-right">
      <li>إنشاء الطلب: ${t.date || "-"}</li>
      ${t.lastEditedBy ? `<li>آخر تعديل: ${t.lastEditedBy} (${t.lastEditDate || "-"})</li>` : ""}
      ${t.executionDate ? `<li>تم التنفيذ: ${t.executionDate}</li>` : ""}
      ${t.status ? `<li>الحالة الحالية: ${t.status}</li>` : ""}
    </u
