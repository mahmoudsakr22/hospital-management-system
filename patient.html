<!-- ضمن ملف patient.html، فقط الجزء الخاص بالسكريبت -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
    authDomain: "hospital-project-e4b59.firebaseapp.com",
    databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hospital-project-e4b59",
    storageBucket: "hospital-project-e4b59.appspot.com",
    messagingSenderId: "974610606258",
    appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('id');

  const infoTable = document.getElementById("infoTable");
  const patientStatus = document.getElementById("patientStatus");
  const qrCanvas = document.getElementById("qrCode");

  async function loadPatientData() {
    if (!patientId) {
      infoTable.innerHTML = "<tr><td colspan='2'>معرف المريض غير موجود في الرابط.</td></tr>";
      return;
    }

    const patientRef = ref(db, `patients/emergency/${patientId}`);
    const snapshot = await get(patientRef);

    if (snapshot.exists()) {
      const patient = snapshot.val();
      infoTable.innerHTML = `
        <tr><td class="font-semibold py-1">الاسم:</td><td class="py-1">${patient.name || '-'}</td></tr>
        <tr><td class="font-semibold py-1">العمر:</td><td class="py-1">${patient.age || '-'}</td></tr>
        <tr><td class="font-semibold py-1">الرقم القومي:</td><td class="py-1">${patient.nid || '-'}</td></tr>
        <tr><td class="font-semibold py-1">ID:</td><td class="py-1">${patientId}</td></tr>
        <tr><td class="font-semibold py-1">تاريخ الدخول:</td><td class="py-1">${new Date(patient.timestamp).toLocaleString('ar-EG') || '-'}</td></tr>
        <tr><td class="font-semibold py-1">القسم الحالي:</td><td class="py-1">${patient.department || '-'}</td></tr>
        <tr><td class="font-semibold py-1">الطبيب المعالج:</td><td class="py-1">${patient.doctor || '-'}</td></tr>
      `;

      // تعيين حالة المريض في العنصر
      patientStatus.textContent = patient.status || "غير محدد";

      // توليد QR Code
      QRCode.toCanvas(qrCanvas, patientId, function (error) {
        if (error) console.error(error);
      });

      // تعيين قيمة الحالة في الاختيار
      const statusSelect = document.getElementById('currentStatus');
      if (statusSelect) {
        statusSelect.value = patient.status || "stable";
      }

    } else {
      infoTable.innerHTML = "<tr><td colspan='2'>لم يتم العثور على بيانات المريض.</td></tr>";
      patientStatus.textContent = "";
    }
  }

  // دالة لتحديث الحالة في قاعدة البيانات
  async function updatePatientStatus(newStatus) {
    if (!patientId) return;
    const patientRef = ref(db, `patients/emergency/${patientId}`);
    
    try {
      await update(patientRef, { status: newStatus });
      patientStatus.textContent = newStatus;
      alert('تم تحديث حالة المريض بنجاح');
    } catch (err) {
      console.error(err);
      alert('حدث خطأ أثناء تحديث الحالة');
    }
  }

  // استماع لتغيير حالة المريض في الاختيار
  document.addEventListener('DOMContentLoaded', () => {
    loadPatientData();

    const statusSelect = document.getElementById('currentStatus');
    if (statusSelect) {
      statusSelect.addEventListener('change', (e) => {
        const val = e.target.value;
        // فقط تأكد أن القيمة محفوظة بصيغة متسقة مع صفحة الطوارئ
        // يمكنك تعديل القيم لتتناسب مع قاعدة البيانات
        updatePatientStatus(val);
      });
    }
  });

  // أزرار التنقل والطباعة ونزّل QR Code كما هي في الكود الأساسي...

  window.goHome = () => {
    window.location.href = "index.html";
  };

  window.goToEmergency = () => {
    window.location.href = "emergency.html";
  };

  window.printReport = () => {
    window.print();
  };

  window.downloadQR = () => {
    const link = document.createElement('a');
    link.download = `qr_${patientId}.png`;
    link.href = qrCanvas.toDataURL();
    link.click();
  };
</script>
