<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-md p-6">
    <h1 class="text-2xl font-bold mb-4 text-center text-blue-700">ملف المريض</h1>

    <!-- جدول البيانات الأساسية -->
    <table class="w-full mb-6 border">
      <tbody id="basic-info" class="text-right"></tbody>
    </table>

    <!-- تسجيل زيارة -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">تسجيل زيارة</h2>
      <select id="visitType" class="border p-2 rounded w-full mb-2">
        <option value="كشف طبي">كشف طبي</option>
        <option value="متابعة">متابعة</option>
        <option value="استشارة">استشارة</option>
      </select>
      <textarea id="visitNotes" class="border p-2 rounded w-full mb-2" placeholder="ملاحظات الطبيب"></textarea>
      <button onclick="registerVisit()" class="bg-green-600 text-white px-4 py-2 rounded">تسجيل الزيارة</button>
      <table class="w-full mt-4 border text-sm">
        <thead><tr><th>النوع</th><th>ملاحظات</th><th>الوقت</th></tr></thead>
        <tbody id="visitHistory"></tbody>
      </table>
    </div>

    <!-- تسجيل تحويل -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">تسجيل تحويل</h2>
      <select id="transferDept" class="border p-2 rounded w-full mb-2" onchange="toggleExtraFields()">
        <option disabled selected>اختر القسم</option>
        <option value="الأشعة">الأشعة</option>
        <option value="التحاليل">التحاليل</option>
      </select>

      <div id="extraFields" class="hidden">
        <input id="transferDetail" class="border p-2 rounded w-full mb-2" placeholder="نوع الخدمة المطلوبة" />
        <textarea id="transferNotes" class="border p-2 rounded w-full mb-2" placeholder="ملاحظات إضافية"></textarea>
      </div>

      <button onclick="registerTransfer()" class="bg-blue-600 text-white px-4 py-2 rounded">تسجيل التحويل</button>

      <table class="w-full mt-4 border text-sm">
        <thead><tr><th>القسم</th><th>تفاصيل</th><th>ملاحظات</th><th>الوقت</th></tr></thead>
        <tbody id="transferHistory"></tbody>
      </table>
    </div>

    <button onclick="goBack()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded">رجوع إلى قسم الطوارئ</button>
  </div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      databaseURL: "https://smart-hospital-life.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");

    const basicInfoBody = document.getElementById("basic-info");
    const visitHistory = document.getElementById("visitHistory");
    const transferHistory = document.getElementById("transferHistory");

    function loadPatientData() {
      if (!patientId) return;

      const patientRef = db.ref("patients/" + patientId);
      patientRef.once("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        basicInfoBody.innerHTML = `
          <tr><td class="border p-2">الاسم</td><td class="border p-2">${data.name}</td></tr>
          <tr><td class="border p-2">العمر</td><td class="border p-2">${data.age}</td></tr>
          <tr><td class="border p-2">الرقم القومي</td><td class="border p-2">${data.nationalId}</td></tr>
          <tr><td class="border p-2">ID</td><td class="border p-2">${patientId}</td></tr>
          <tr><td class="border p-2">تاريخ الدخول</td><td class="border p-2">${data.entryDate}</td></tr>
          <tr><td class="border p-2">القسم الحالي</td><td class="border p-2">${data.department}</td></tr>
          <tr><td class="border p-2">الطبيب المعالج</td><td class="border p-2">${data.doctor}</td></tr>
        `;
      });

      db.ref("visits/" + patientId).on("value", (snap) => {
        visitHistory.innerHTML = "";
        snap.forEach((child) => {
          const v = child.val();
          visitHistory.innerHTML += `
            <tr><td class="border p-2">${v.type}</td><td class="border p-2">${v.notes}</td><td class="border p-2">${v.time}</td></tr>
          `;
        });
      });

      db.ref("transfers/" + patientId).on("value", (snap) => {
        transferHistory.innerHTML = "";
        snap.forEach((child) => {
          const t = child.val();
          transferHistory.innerHTML += `
            <tr><td class="border p-2">${t.department}</td><td class="border p-2">${t.detail}</td><td class="border p-2">${t.notes}</td><td class="border p-2">${t.time}</td></tr>
          `;
        });
      });
    }

    function registerVisit() {
      const type = document.getElementById("visitType").value;
      const notes = document.getElementById("visitNotes").value;
      const now = new Date().toLocaleString();

      db.ref("visits/" + patientId).push({
        type, notes, time: now
      }).then(() => {
        Swal.fire("تم تسجيل الزيارة", "", "success");
        document.getElementById("visitNotes").value = "";
      });
    }

    function toggleExtraFields() {
      const dept = document.getElementById("transferDept").value;
      const extra = document.getElementById("extraFields");
      extra.classList.remove("hidden");
    }

    function registerTransfer() {
      const department = document.getElementById("transferDept").value;
      const detail = document.getElementById("transferDetail").value;
      const notes = document.getElementById("transferNotes").value;
      const now = new Date().toLocaleString();

      db.ref("transfers/" + patientId).push({
        department, detail, notes, time: now
      }).then(() => {
        Swal.fire("تم تسجيل التحويل بنجاح", "", "success");

        // تحديث القسم الحالي
        db.ref("patients/" + patientId).update({ department });

        // توجيه إلى صفحة القسم الجديد
        setTimeout(() => {
          if (department === "الأشعة") {
            window.location.href = "radiology.html?id=" + patientId;
          } else if (department === "التحاليل") {
            window.location.href = "labs.html?id=" + patientId;
          }
        }, 1000);
      });
    }

    function goBack() {
      window.location.href = "emergency.html";
    }

    loadPatientData();
  </script>
</body>
</html>
