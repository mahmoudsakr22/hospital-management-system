<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام ملف المريض - مستشفى الحياة الذكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        body { 
            background-color: #f8fafc;
            color: #334155;
        }
        
        /* Professional Medical Theme Colors */
        :root {
            --primary: #0c4a6e;
            --primary-light: #0891b2;
            --secondary: #4f46e5;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --light: #f1f5f9;
            --dark: #0f172a;
        }
        
        /* Modern Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Status Badge Styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-critical {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }
        
        .status-stable {
            background-color: rgba(5, 150, 105, 0.1);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .status-improving {
            background-color: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        
        .status-deteriorating {
            background-color: rgba(217, 119, 6, 0.1);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }
        
        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0a3855;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
        }
        
        /* Form Styles */
        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }
        
        /* Medical Record Item Styles */
        .medical-record-item {
            border-right: 4px solid var(--primary-light);
            background: linear-gradient(to left, rgba(8, 145, 178, 0.05), transparent);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .medical-record-item:hover {
            transform: translateX(-4px);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Tab Styles */
        .tab {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Professional Checkup Form Styles */
        .checkup-form-container {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        .checkup-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .checkup-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }
        
        .form-section {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s ease;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section:hover {
            background-color: #fafbfc;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px rgba(3, 105, 161, 0.3);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            color: #1e293b;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1), 0 1px 2px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Medication Item Styles */
        .medication-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .medication-item:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .medication-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
        }
        
        .remove-medication {
            background: var(--danger);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .remove-medication:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }
        
        .medication-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        /* Save Button Styles - Enhanced */
        .save-section {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 2rem;
            border-radius: 0 0 16px 16px;
            margin-top: 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        
        .save-btn {
            background: linear-gradient(135deg, var(--success), #10b981);
            color: white;
            padding: 1.25rem 3rem;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .save-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        
        .save-btn:hover::before {
            left: 100%;
        }
        
        .save-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(5, 150, 105, 0.5);
        }
        
        .save-btn:active {
            transform: translateY(-1px);
        }
        
        .save-btn i {
            font-size: 1.5rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Success Animation */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        
        /* Checkup Display Styles */
        .checkup-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-right: 4px solid var(--primary);
            transition: all 0.2s ease;
        }
        
        .checkup-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(-2px);
        }
        
        .checkup-header-info {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .checkup-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .checkup-type-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .checkup-date {
            color: #64748b;
            font-size: 0.875rem;
        }
        
        .checkup-section {
            margin-bottom: 1rem;
        }
        
        .checkup-section-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .checkup-section-content {
            color: #4b5563;
            line-height: 1.5;
        }
        
        .medications-list {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        
        .medication-list-item {
            background: white;
            border: 1px solid #d1fae5;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .medication-list-item:last-child {
            margin-bottom: 0;
        }
        
        .medication-name {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 0.25rem;
        }
        
        .medication-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .modal-content {
                width: 98%;
                margin: 1rem;
                max-height: 98vh;
            }
            
            .save-btn {
                padding: 1rem 2rem;
                font-size: 1rem;
                width: 100%;
                justify-content: center;
            }
            
            .medication-grid {
                grid-template-columns: 1fr;
            }
            
            .checkup-header-info {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .medication-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <div class="bg-white p-2 rounded-xl shadow-md">
                <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" class="w-14 h-14 rounded-full" alt="شعار مستشفى الحياة الذكية">
            </div>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">مستشفى الحياة الذكية</h1>
                <p class="text-gray-600">نظام إدارة ملفات المرضى</p>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> طباعة الملف
            </button>
            <button onclick="window.location.href='emergency.html'" class="btn btn-secondary">
                <i class="fas fa-ambulance"></i> الطوارئ
            </button>
            <button onclick="window.location.href='index.html'" class="btn btn-success">
                <i class="fas fa-home"></i> الرئيسية
            </button>
        </div>
    </div>

    <!-- Patient Info Card -->
    <div class="card mb-6">
        <div class="header flex justify-between items-center">
            <div>
                <h2 class="text-xl md:text-2xl font-bold">ملف المريض</h2>
                <p class="opacity-90">تفاصيل المريض وسجلاته الطبية</p>
            </div>
            <div id="patientStatus" class="status-badge"></div>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-user-circle text-blue-600"></i> المعلومات الأساسية
                    </h3>
                    <div class="bg-gray-50 p-5 rounded-lg">
                        <table class="table-auto w-full" id="infoTable"></table>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mt-5">
                        <button onclick="changePatientStatus()" class="btn btn-secondary">
                            <i class="fas fa-exchange-alt"></i> تغيير الحالة
                        </button>
                        <button onclick="openCheckupModal()" class="btn btn-primary">
                            <i class="fas fa-stethoscope"></i> كشف طبي جديد
                        </button>
                        <a href="#" id="monitorBtn" class="btn btn-success">
                            <i class="fas fa-heartbeat"></i> عرض المونيتور
                        </a>
                    </div>
                </div>
                
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-qrcode text-blue-600"></i> رمز الاستجابة السريع
                    </h3>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                        <canvas id="qrCode" class="w-40 h-40"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex border-b border-gray-200 mb-6">
        <div class="tab active" onclick="showTab('transfers')">
            <i class="fas fa-exchange-alt ml-2"></i> التحويلات
        </div>
        <div class="tab" onclick="showTab('checkups')">
            <i class="fas fa-file-medical ml-2"></i> الكشوفات الطبية
        </div>
    </div>

    <!-- Transfers Tab -->
    <div id="transfersTab" class="tab-content">
        <!-- New Transfer Form -->
        <div class="card mb-6">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-600"></i> تسجيل تحويل جديد
                </h2>
            </div>
            
            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">القسم</label>
                        <select id="transferDepartment" class="form-input">
                            <option value="">اختر القسم</option>
                            <option value="radiology">الأشعة</option>
                            <option value="التحاليل">التحاليل</option>
                            <option value="العناية المركزة">العناية المركزة</option>
                            <option value="العمليات">العمليات</option>
                            <option value="الصيدلية">الصيدلية</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">نوع الإجراء</label>
                        <input type="text" id="transferType" placeholder="نوع الإجراء (أشعة/تحاليل)" class="form-input" />
                    </div>
                    
                    <div id="radiologyDeviceDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">جهاز الأشعة</label>
                        <select id="radiologyDevice" class="form-input">
                            <option value="">اختر جهاز الأشعة</option>
                            <option value="أشعة عادية">أشعة عادية</option>
                            <option value="أشعة مقطعية">أشعة مقطعية</option>
                            <option value="رنين مغناطيسي">رنين مغناطيسي</option>
                            <option value="موجات صوتية">موجات صوتية</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات إضافية</label>
                        <textarea id="transferNotes" placeholder="ملاحظات إضافية" class="form-input" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Pharmacy Fields (Hidden by default) -->
                <div id="pharmacyFields" class="hidden mt-5 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-pills"></i>
                        تفاصيل طلب الدواء
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">اسم الدواء <span class="text-red-500">*</span></label>
                            <input type="text" id="medicationName" class="form-input" placeholder="اكتب اسم الدواء">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">الجرعة <span class="text-red-500">*</span></label>
                            <input type="text" id="dosage" class="form-input" placeholder="مثال: 500 مجم">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">المدة <span class="text-red-500">*</span></label>
                            <input type="text" id="duration" class="form-input" placeholder="مثال: 7 أيام">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نوع التأمين</label>
                            <select id="insuranceType" class="form-input">
                                <option value="">اختر نوع التأمين</option>
                                <option value="تأمين أساسي">تأمين أساسي</option>
                                <option value="تأمين تكميلي">تأمين تكميلي</option>
                                <option value="خاص">خاص</option>
                                <option value="غير مؤمن">غير مؤمن</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">عدد الجرعات</label>
                            <input type="number" id="dosesCount" class="form-input" placeholder="مثال: 3" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تعليمات الإعطاء</label>
                            <input type="text" id="administration" class="form-input" placeholder="مثال: بعد الأكل">
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 flex justify-end">
                    <button onclick="addTransfer()" class="btn btn-primary">
                        <i class="fas fa-save"></i> تسجيل التحويل
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Transfers History -->
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-history text-blue-600"></i> سجل التحويلات
                </h2>
            </div>
            <div class="p-5">
                <ul id="transferList" class="space-y-4"></ul>
            </div>
        </div>
    </div>

    <!-- Checkups Tab -->
    <div id="checkupsTab" class="tab-content hidden">
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-file-medical-alt text-blue-600"></i> سجل الكشوفات الطبية
                </h2>
            </div>
            <div class="p-5">
                <div id="checkupsList">
                    <!-- Checkups will be loaded here -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                        <p>جاري تحميل الكشوفات الطبية...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Medical Checkup Modal -->
<div id="checkupModal" class="modal checkup-form-container">
    <div class="modal-content">
        <!-- Modal Header -->
        <div class="checkup-header">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                                <i class="fas fa-stethoscope text-3xl"></i>
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold mb-1">كشف طبي جديد</h1>
                                <p class="text-blue-100 text-lg">تسجيل بيانات الكشف الطبي للمريض</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-blue-100">
                            <i class="fas fa-user-md"></i>
                            <span id="doctorName">د. أحمد محمد</span>
                            <span>•</span>
                            <span id="currentDate"></span>
                        </div>
                    </div>
                    <button onclick="closeCheckupModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Patient Info Bar -->
        <div class="bg-white rounded-xl shadow-md p-4 border border-blue-100">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 p-2 rounded-lg">
                        <i class="fas fa-user-injured text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800" id="patientName">جاري تحميل بيانات المريض...</h3>
                        <p class="text-sm text-gray-600" id="patientDetails">الرجاء الانتظار</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <a href="patient-file.html?id=" class="btn btn-secondary">
                        <i class="fas fa-arrow-right"></i>
                        العودة لملف المريض
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="overflow-y-auto" style="max-height: calc(95vh - 280px);">
            <form id="checkupForm">
                <!-- Visit Type Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h2 class="section-title">نوع الكشف</h2>
                    </div>
                    <div class="form-group">
                        <select id="visitType" class="form-select" required>
                            <option value="">اختر نوع الكشف</option>
                            <option value="كشف أولي">كشف أولي</option>
                            <option value="متابعة">متابعة</option>
                            <option value="استشارة">استشارة</option>
                            <option value="كشف دوري">كشف دوري</option>
                            <option value="طوارئ">طوارئ</option>
                        </select>
                    </div>
                </div>

                <!-- Symptoms Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-notes-medical"></i>
                        </div>
                        <h2 class="section-title">الأعراض</h2>
                    </div>
                    <div class="form-group">
                        <textarea id="symptoms" class="form-textarea" placeholder="اكتب الأعراض التي يشتكي منها المريض بالتفصيل..." required></textarea>
                    </div>
                </div>

                <!-- Diagnosis Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-diagnoses"></i>
                        </div>
                        <h2 class="section-title">التشخيص</h2>
                    </div>
                    <div class="form-group">
                        <textarea id="diagnosis" class="form-textarea" placeholder="اكتب التشخيص الطبي للحالة..." required></textarea>
                    </div>
                </div>

                <!-- Treatment Plan Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-pills"></i>
                        </div>
                        <h2 class="section-title">الخطة العلاجية والوصفات الطبية</h2>
                    </div>
                    
                    <div class="form-group mb-4">
                        <textarea id="treatmentPlan" class="form-textarea" placeholder="الخطة العلاجية العامة والتوصيات..." rows="3"></textarea>
                    </div>
                    
                    <!-- Medications Section -->
                    <div class="bg-gray-50 rounded-xl p-4 border-2 border-dashed border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-prescription-bottle text-green-600"></i>
                                الأدوية الموصوفة
                            </h3>
                            <button type="button" onclick="addMedication()" class="btn btn-success">
                                <i class="fas fa-plus"></i>
                                إضافة دواء
                            </button>
                        </div>
                        
                        <div id="medicationsList">
                            <!-- Medications will be added dynamically -->
                        </div>
                        
                        <div id="noMedications" class="empty-state">
                            <i class="fas fa-pills"></i>
                            <p class="font-medium">لا توجد أدوية مضافة</p>
                            <p class="text-sm">اضغط على زر "إضافة دواء" لبدء إضافة الأدوية</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Save Section -->
        <div class="save-section">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-gray-600">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        <span class="font-medium">تأكد من ملء جميع الحقول المطلوبة قبل الحفظ</span>
                    </div>
                    <p class="text-sm">سيتم حفظ الكشف الطبي في ملف المريض</p>
                </div>
                <button onclick="saveVisit()" class="save-btn">
                    <i class="fas fa-save"></i>
                    <span>حفظ الكشف الطبي</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, onValue, get, remove, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCww7pM0clGr_Nk7Xe3pCnBUJtSaw6nS-k",
  authDomain: "smart-life-hospital.firebaseapp.com",
  databaseURL: "https://smart-life-hospital-default-rtdb.firebaseio.com",
  projectId: "smart-life-hospital",
  storageBucket: "smart-life-hospital.firebasestorage.app",
  messagingSenderId: "988240466536",
  appId: "1:988240466536:web:93e9f945b255cd164361dd",
  measurementId: "G-GEJF0F0ZJ7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Get patient ID from URL
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

// Set current date in modal
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// Helper function to validate patient ID
function validatePatientId() {
    if (!patientId) {
        Swal.fire("خطأ", "معرف المريض غير موجود في الرابط", "error");
        return false;
    }
    return true;
}

// Helper function to show loading message
function showLoading(message = "جاري التحميل...") {
    Swal.fire({
        title: message,
        didOpen: () => { Swal.showLoading(); }
    });
}

// Helper function to show result message
function showResult(title, message, icon = "success") {
    Swal.fire({
        title,
        text: message,
        icon,
        timer: 1500,
        showConfirmButton: false
    });
}

// Function to update patient status UI
function updateStatusUI(status) {
    const statusEl = document.getElementById("patientStatus");
    
    const statusConfig = {
        critical: { 
            text: 'حرجة',
            class: 'status-critical',
            icon: 'fa-exclamation-triangle'
        },
        stable: { 
            text: 'مستقرة',
            class: 'status-stable',
            icon: 'fa-check-circle'
        },
        improving: { 
            text: 'في تحسن',
            class: 'status-improving',
            icon: 'fa-arrow-up'
        },
        deteriorating: { 
            text: 'في تدهور',
            class: 'status-deteriorating',
            icon: 'fa-arrow-down'
        }
    };
    
    if (statusConfig[status]) {
        statusEl.className = `status-badge ${statusConfig[status].class}`;
        statusEl.innerHTML = `<i class="fas ${statusConfig[status].icon} ml-2"></i>${statusConfig[status].text}`;
    }
}

// Function to change patient status
window.changePatientStatus = async function() {
    if (!validatePatientId()) return;
    
    const { value: newStatus } = await Swal.fire({
        title: 'تغيير حالة المريض',
        input: 'select',
        inputOptions: {
            'critical': 'حرجة',
            'stable': 'مستقرة',
            'improving': 'في تحسن',
            'deteriorating': 'في تدهور'
        },
        inputPlaceholder: 'اختر الحالة الجديدة',
        showCancelButton: true,
        confirmButtonText: 'حفظ',
        cancelButtonText: 'إلغاء',
        inputValidator: (value) => {
            if (!value) return 'يرجى اختيار الحالة';
        }
    });
    
    if (newStatus) {
        try {
            showLoading("جاري تحديث الحالة...");
            await update(ref(db, `patients/emergency/${patientId}`), { status: newStatus });
            updateStatusUI(newStatus);
            showResult("تم!", "تم تغيير حالة المريض بنجاح");
        } catch (error) {
            Swal.fire("خطأ", "فشل تحديث الحالة: " + error.message, "error");
        }
    }
};

// Load patient data
async function loadPatientData() {
    if (!validatePatientId()) return;
    
    const infoTable = document.getElementById("infoTable");
    const qrCanvas = document.getElementById("qrCode");
    
    try {
        const snapshot = await get(ref(db, `patients/emergency/${patientId}`));
        
        if (snapshot.exists()) {
            const patient = snapshot.val();
            infoTable.innerHTML = `
                <tr><td class="py-2 px-3 font-semibold text-gray-700 w-1/3">الاسم:</td><td class="py-2 px-3">${patient.name || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">العمر:</td><td class="py-2 px-3">${patient.age || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الرقم القومي:</td><td class="py-2 px-3">${patient.nid || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">ID:</td><td class="py-2 px-3 font-mono">${patientId}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">تاريخ الدخول:</td><td class="py-2 px-3">${patient.timestamp ? new Date(patient.timestamp).toLocaleString('ar-EG') : '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">القسم الحالي:</td><td class="py-2 px-3">${patient.department || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الطبيب المعالج:</td><td class="py-2 px-3">${patient.doctors || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">نوع الخدمة:</td><td class="py-2 px-3" id="serviceType">${patient.serviceType || 'غير محدد'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الحالة:</td><td class="py-2 px-3" id="patientStatusInTable">${patient.status || 'غير محدد'}</td></tr>
            `;
            
            updateStatusUI(patient.status || "stable");
            
            // Generate QR code
            QRCode.toCanvas(qrCanvas, patientId, function (error) {
                if (error) console.error(error);
            });
        } else {
            infoTable.innerHTML = "<tr><td colspan='2' class='py-2 px-3 text-center text-gray-500'>لم يتم العثور على بيانات المريض.</td></tr>";
        }
    } catch (error) {
        Swal.fire("خطأ", "فشل تحميل بيانات المريض: " + error.message, "error");
    }
}

// Load patient and doctor data for modal
async function loadPatientAndDoctorData() {
    if (!validatePatientId()) return;
    
    try {
        // Get patient data
        const patientSnapshot = await get(ref(db, `patients/emergency/${patientId}`));
        
        if (patientSnapshot.exists()) {
            const patient = patientSnapshot.val();
            
            // Update patient info in modal
            document.getElementById('patientName').textContent = patient.name || 'مريض غير معروف';
            document.getElementById('patientDetails').textContent = 
                `العمر: ${patient.age || '-'} | الرقم القومي: ${patient.nid || '-'}`;
            
            // Get doctor name - try from patient data first, then use default
            const doctorName = patient.doctors || patient.doctorId || "د. أحمد محمد";
            document.getElementById('doctorName').textContent = doctorName;
            
            console.log("Loaded patient data:", patient);
            console.log("Doctor name:", doctorName);
        } else {
            document.getElementById('patientName').textContent = 'مريض غير موجود';
            document.getElementById('patientDetails').textContent = 'لا توجد بيانات المريض';
        }
    } catch (error) {
        console.error("Error loading patient data:", error);
        Swal.fire("خطأ", "فشل تحميل بيانات المريض: " + error.message, "error");
    }
}

// Open medical checkup modal
window.openCheckupModal = function() {
    if (!validatePatientId()) return;
    
    // Load patient and doctor data first
    loadPatientAndDoctorData().then(() => {
        // Reset form
        document.getElementById('checkupForm').reset();
        
        // Reset medications list
        document.getElementById('medicationsList').innerHTML = '';
        document.getElementById('noMedications').style.display = 'block';
        
        // Show modal with animation
        const modal = document.getElementById('checkupModal');
        modal.classList.add('active');
        
        // Add entrance animations
        const sections = modal.querySelectorAll('.form-section');
        sections.forEach((section, index) => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                section.style.transition = 'all 0.5s ease';
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
};

// Close medical checkup modal
window.closeCheckupModal = function() {
    const modal = document.getElementById('checkupModal');
    modal.classList.remove('active');
};

// Function to add a new medication
window.addMedication = function() {
    const medicationsList = document.getElementById("medicationsList");
    const noMedications = document.getElementById("noMedications");
    
    // Hide "no medications" message
    noMedications.style.display = 'none';
    
    const medicationId = Date.now();
    const medicationItem = document.createElement('div');
    medicationItem.className = 'medication-item';
    medicationItem.id = `medication-${medicationId}`;
    
    medicationItem.innerHTML = `
        <div class="medication-header">
            <h4 class="medication-title">الدواء #${medicationsList.children.length + 1}</h4>
            <button type="button" onclick="removeMedication(${medicationId})" class="remove-medication">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="medication-grid">
            <div class="form-group">
                <label class="form-label">اسم الدواء <span class="text-red-500">*</span></label>
                <input type="text" class="medication-name form-input" placeholder="اسم الدواء" required>
            </div>
            <div class="form-group">
                <label class="form-label">الجرعة <span class="text-red-500">*</span></label>
                <input type="text" class="medication-dosage form-input" placeholder="مثال: 500 مجم" required>
            </div>
            <div class="form-group">
                <label class="form-label">المدة <span class="text-red-500">*</span></label>
                <input type="text" class="medication-duration form-input" placeholder="مثال: 7 أيام" required>
            </div>
            <div class="form-group">
                <label class="form-label">نوع التأمين</label>
                <select class="medication-insurance form-select">
                    <option value="">اختر نوع التأمين</option>
                    <option value="تأمين أساسي">تأمين أساسي</option>
                    <option value="تأمين تكميلي">تأمين تكميلي</option>
                    <option value="خاص">خاص</option>
                    <option value="غير مؤمن">غير مؤمن</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">عدد الجرعات</label>
                <input type="number" class="medication-doses form-input" placeholder="مثال: 3" min="1">
            </div>
            <div class="form-group">
                <label class="form-label">تعليمات الإعطاء</label>
                <input type="text" class="medication-instructions form-input" placeholder="مثال: بعد الأكل">
            </div>
        </div>
    `;
    
    medicationsList.appendChild(medicationItem);
    
    // Add animation
    medicationItem.style.opacity = '0';
    medicationItem.style.transform = 'translateY(20px)';
    setTimeout(() => {
        medicationItem.style.transition = 'all 0.3s ease';
        medicationItem.style.opacity = '1';
        medicationItem.style.transform = 'translateY(0)';
    }, 10);
};

// Function to remove a medication
window.removeMedication = function(medicationId) {
    const medicationItem = document.getElementById(`medication-${medicationId}`);
    if (medicationItem) {
        medicationItem.style.transition = 'all 0.3s ease';
        medicationItem.style.opacity = '0';
        medicationItem.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
            medicationItem.remove();
            
            // Check if no medications left
            const medicationsList = document.getElementById('medicationsList');
            if (medicationsList.children.length === 0) {
                document.getElementById('noMedications').style.display = 'block';
            }
        }, 300);
    }
};

// Save medical checkup data
window.saveVisit = async function() {
    if (!validatePatientId()) return;
    
    // Collect form data
    const visitType = document.getElementById('visitType').value;
    const symptoms = document.getElementById('symptoms').value;
    const diagnosis = document.getElementById('diagnosis').value;
    const treatmentPlan = document.getElementById('treatmentPlan').value;
    
    // Get current doctor name from the header
    const doctorName = document.getElementById('doctorName').textContent;
    
    // Validate required fields
    if (!visitType || !symptoms || !diagnosis) {
        Swal.fire({
            title: 'حقول مطلوبة',
            text: 'يرجى ملء الحقول المطلوبة (نوع الكشف، الأعراض، التشخيص)',
            icon: 'warning',
            confirmButtonText: 'موافق'
        });
        return;
    }
    
    // Collect medications data
    const medications = [];
    const medicationItems = document.querySelectorAll('#medicationsList > div');
    
    medicationItems.forEach(item => {
        const name = item.querySelector('.medication-name').value.trim();
        const dosage = item.querySelector('.medication-dosage').value.trim();
        const duration = item.querySelector('.medication-duration').value.trim();
        const insurance = item.querySelector('.medication-insurance').value;
        const doses = item.querySelector('.medication-doses').value;
        const instructions = item.querySelector('.medication-instructions').value.trim();
        
        if (name && dosage && duration) {
            medications.push({
                name,
                dosage,
                duration,
                insurance: insurance || "غير محدد",
                doses: doses || null,
                instructions: instructions || "حسب إرشادات الطبيب"
            });
        }
    });
    
    try {
        // Show loading with custom styling
        Swal.fire({
            title: 'جاري حفظ الكشف الطبي...',
            html: '<div class="loading"></div>',
            didOpen: () => { Swal.showLoading(); },
            allowOutsideClick: false,
            allowEscapeKey: false
        });
        
        // Prepare checkup data
        const checkupData = {
            visitType,
            symptoms,
            diagnosis,
            treatmentPlan,
            medications,
            doctorId: doctorName,
            doctorName: doctorName,
            date: new Date().toISOString(),
            status: "مكتمل"
        };
        
        // Save data to Firebase
        const newCheckupRef = await push(ref(db, `patients/emergency/${patientId}/checkups`), checkupData);
        checkupData.id = newCheckupRef.key;
        
        // Update patient status
        await update(ref(db, `patients/emergency/${patientId}`), {
            lastCheckup: new Date().toISOString(),
            serviceType: visitType,
            lastCheckupBy: doctorName
        });
        
        // Show success message
        Swal.fire({
            title: 'تم الحفظ بنجاح!',
            text: 'تم حفظ الكشف الطبي في ملف المريض',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
        
        // Add success animation to save button
        const saveBtn = document.querySelector('.save-btn');
        saveBtn.classList.add('success-animation');
        
        // Close modal and refresh data
        setTimeout(() => {
            closeCheckupModal();
            loadCheckups();
        }, 1500);
        
    } catch (error) {
        console.error('Error saving checkup:', error);
        Swal.fire("خطأ", "فشل حفظ الكشف: " + error.message, "error");
    }
};

// Show/hide fields based on selected department
document.getElementById("transferDepartment").addEventListener("change", function() {
    const department = this.value;
    const deviceSelect = document.getElementById("radiologyDevice");
    const deviceDiv = document.getElementById("radiologyDeviceDiv");
    const pharmacyFields = document.getElementById("pharmacyFields");
    const transferTypeInput = document.getElementById("transferType");
    
    // Hide all specialized fields first
    deviceDiv.classList.add("hidden");
    pharmacyFields.classList.add("hidden");
    
    // Show appropriate fields based on department
    if (department === "radiology") {
        deviceDiv.classList.remove("hidden");
        transferTypeInput.placeholder = "نوع الأشعة";
    } else if (department === "الصيدلية") {
        pharmacyFields.classList.remove("hidden");
        transferTypeInput.placeholder = "طلب دواء";
        transferTypeInput.value = "طلب صرف دواء"; // Default value
    } else if (department === "التحاليل") {
        transferTypeInput.placeholder = "نوع التحليل";
    } else {
        transferTypeInput.placeholder = "نوع الإجراء";
    }
});

// Register a new transfer
window.addTransfer = async function() {
    if (!validatePatientId()) return;
    
    const department = document.getElementById("transferDepartment").value;
    const type = document.getElementById("transferType").value.trim();
    const notes = document.getElementById("transferNotes").value.trim();
    const device = document.getElementById("radiologyDevice").value;
    
    // Pharmacy data
    const medicationName = document.getElementById("medicationName").value.trim();
    const dosage = document.getElementById("dosage").value.trim();
    const duration = document.getElementById("duration").value.trim();
    const insuranceType = document.getElementById("insuranceType").value;
    const dosesCount = document.getElementById("dosesCount").value;
    const administration = document.getElementById("administration").value.trim();
    
    // Validate required fields
    if (!department || !type) {
        Swal.fire("تنبيه", "يرجى ملء جميع الحقول", "warning");
        return;
    }
    
    // Pharmacy-specific validation
    if (department === "الصيدلية") {
        if (!medicationName || !dosage || !duration) {
            Swal.fire("تنبيه", "يرجى ملء حقول الدواء الأساسية (الاسم، الجرعة، المدة)", "warning");
            return;
        }
    }
    
    // Radiology-specific validation
    if (department === "radiology" && !device) {
        Swal.fire("تنبيه", "يرجى اختيار جهاز الأشعة", "warning");
        return;
    }
    
    const newTransfer = {
        department,
        type,
        notes,
        device: department === "radiology" ? device : "",
        // Pharmacy data
        medication: department === "الصيدلية" ? {
            name: medicationName,
            dosage: dosage,
            duration: duration,
            insuranceType: insuranceType || "غير محدد",
            dosesCount: dosesCount || null,
            administration: administration || "حسب إرشادات الطبيب"
        } : null,
        date: new Date().toLocaleString('ar-EG'),
        status: "قيد الانتظار",
        requestedBy: "د. أحمد محمد" // In real system: use doctor name from authentication
    };
    
    try {
        showLoading("جاري تسجيل التحويل...");
        await push(ref(db, `patients/emergency/${patientId}/transfers`), newTransfer);
        
        // Reset form
        document.getElementById("transferDepartment").value = "";
        document.getElementById("transferType").value = "";
        document.getElementById("transferNotes").value = "";
        document.getElementById("radiologyDevice").value = "";
        document.getElementById("pharmacyFields").classList.add("hidden");
        
        // Reset pharmacy fields
        document.getElementById("medicationName").value = "";
        document.getElementById("dosage").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("insuranceType").value = "";
        document.getElementById("dosesCount").value = "";
        document.getElementById("administration").value = "";
        
        showResult("تم", "تم تسجيل التحويل بنجاح");
    } catch (error) {
        Swal.fire("خطأ", "حدث خطأ أثناء التسجيل: " + error.message, "error");
    }
};

// Delete a transfer record
window.deleteTransfer = function(transferKey) {
    Swal.fire({
        title: 'تأكيد الحذف',
        text: "هل أنت متأكد أنك تريد حذف هذا السجل؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            remove(ref(db, `patients/emergency/${patientId}/transfers/${transferKey}`))
            .then(() => {
                showResult("تم الحذف!", "تم حذف السجل بنجاح");
            })
            .catch((error) => {
                Swal.fire("خطأ", "حدث خطأ أثناء الحذف: " + error.message, "error");
            });
        }
    });
};

// Load transfers data
function loadTransfers() {
    if (!validatePatientId()) return;
    
    const list = document.getElementById("transferList");
    const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
    
    onValue(transfersRef, (snapshot) => {
        list.innerHTML = "";
        
        if (!snapshot.exists()) {
            list.innerHTML = "<p class='text-gray-500 text-center py-4'>لا توجد تحويلات مسجلة</p>";
            return;
        }
        
        snapshot.forEach((child) => {
            const t = child.val();
            const key = child.key;
            let resultText = "";
            
            // Display medication details if transfer is to pharmacy
            if (t.department === "الصيدلية" && t.medication) {
                const med = t.medication;
                resultText += `
                    <div class="bg-green-50 p-3 rounded-lg mt-2 border border-green-200">
                        <div class="font-semibold text-green-800 mb-2">تفاصيل الدواء:</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <div><span class="font-medium">الدواء:</span> ${med.name}</div>
                            <div><span class="font-medium">الجرعة:</span> ${med.dosage}</div>
                            <div><span class="font-medium">المدة:</span> ${med.duration}</div>
                            <div><span class="font-medium">التأمين:</span> ${med.insuranceType}</div>
                            ${med.dosesCount ? `<div><span class="font-medium">عدد الجرعات:</span> ${med.dosesCount}</div>` : ''}
                            <div class="md:col-span-2"><span class="font-medium">طريقة الإعطاء:</span> ${med.administration}</div>
                        </div>
                    </div>
                `;
            }
            
            if (t.report) {
                resultText += ` | <span class="text-green-700">النتيجة: ${t.report}</span>`;
            }
            if (t.technician) {
                resultText += ` | <span class="text-blue-700">منفذ الأشعة: ${t.technician}</span>`;
            }
            if (t.device) {
                resultText += ` | <span class="text-purple-700">الجهاز: ${t.device}</span>`;
            }
            
            let actionBtns = "";
            if (t.department === "radiology") {
                if (t.status === "قيد الانتظار") {
                    actionBtns += `<button onclick='editRadiology("${key}", ${JSON.stringify(t)})' class="btn btn-primary text-sm ml-2">تعديل</button>`;
                }
                if (t.status === "تم التنفيذ") {
                    actionBtns += `<button onclick='showRadiologyReport(${JSON.stringify(t)})' class="btn btn-success text-sm ml-2">عرض النتيجة</button>`;
                }
                actionBtns += `<button onclick='deleteTransfer("${key}")' class="btn btn-danger text-sm ml-2">حذف</button>`;
            } else if (t.department === "الصيدلية") {
                // Pharmacy-specific buttons
                if (t.status === "قيد الانتظار") {
                    actionBtns += `
                        <button onclick='updateMedicationStatus("${key}", "تم الصرف")' class="btn btn-success text-sm ml-2">
                            <i class="fas fa-check"></i>تأكيد الصرف
                        </button>
                        <button onclick='updateMedicationStatus("${key}", "مرفوض")
