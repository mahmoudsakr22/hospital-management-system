<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام ملف المريض - مستشفى الحياة الذكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        body { 
            background-color: #f8fafc;
            color: #334155;
        }
        
        /* Professional Medical Theme Colors */
        :root {
            --primary: #0c4a6e;
            --primary-light: #0891b2;
            --secondary: #4f46e5;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --light: #f1f5f9;
            --dark: #0f172a;
            --accent: #667eea;
            --accent-light: #a78bfa;
        }
        
        /* Modern Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Status Badge Styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-critical {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }
        
        .status-stable {
            background-color: rgba(5, 150, 105, 0.1);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .status-improving {
            background-color: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        
        .status-deteriorating {
            background-color: rgba(217, 119, 6, 0.1);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }
        
        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0a3855;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
        }
        
        /* Form Styles */
        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }
        
        /* Medical Record Item Styles */
        .medical-record-item {
            border-right: 4px solid var(--primary-light);
            background: linear-gradient(to left, rgba(8, 145, 178, 0.05), transparent);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .medical-record-item:hover {
            transform: translateX(-4px);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Tab Styles */
        .tab {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Enhanced Checkup Form Styles */
        .checkup-form-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .checkup-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .checkup-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }
        
        .form-section {
            padding: 2.5rem;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--accent-light);
        }
        
        .section-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .section-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-group {
            margin-bottom: 2rem;
        }
        
        .form-label {
            display: block;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        
        .form-textarea, .form-select {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            background: white;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        /* Enhanced Medication Item Styles */
        .medication-item {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
        }
        
        .medication-item:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.1);
        }
        
        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .medication-title {
            font-weight: 800;
            color: var(--accent);
            font-size: 1.3rem;
        }
        
        .remove-medication {
            background: var(--danger);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .remove-medication:hover {
            background: #c53030;
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(229, 62, 62, 0.3);
        }
        
        .medication-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        /* Enhanced Medications Container */
        .medications-container {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            border-radius: 20px;
            padding: 2.5rem;
            border: 3px dashed #e2e8f0;
            margin-top: 2rem;
        }
        
        .medications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .medications-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        /* Enhanced Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #718096;
            background: white;
            border-radius: 15px;
            border: 2px dashed #e2e8f0;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--accent-light);
            margin-bottom: 1.5rem;
        }
        
        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        /* Enhanced Save Section */
        .save-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 3rem;
            border-radius: 0 0 16px 16px;
            margin-top: 0;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .save-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .save-info {
            color: white;
            flex: 1;
        }
        
        .save-info h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .save-info p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* Enhanced Save Button */
        .save-btn {
            background: linear-gradient(135deg, var(--success) 0%, #48bb78 100%);
            color: white;
            padding: 1.5rem 4rem;
            border-radius: 20px;
            font-weight: 900;
            font-size: 1.3rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 12px 24px rgba(56, 161, 105, 0.4);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .save-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.8s;
        }
        
        .save-btn:hover::before {
            left: 100%;
        }
        
        .save-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(56, 161, 105, 0.5);
        }
        
        .save-btn:active {
            transform: translateY(-2px);
        }
        
        .save-btn i {
            font-size: 2rem;
        }
        
        /* Enhanced Add Medication Button */
        .add-medication-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .add-medication-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
        }
        
        .add-medication-btn i {
            font-size: 1.2rem;
        }
        
        /* Checkup Display Styles */
        .checkup-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-right: 4px solid var(--primary);
            transition: all 0.2s ease;
        }
        
        .checkup-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(-2px);
        }
        
        .checkup-header-info {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .checkup-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .checkup-type-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .checkup-date {
            color: #64748b;
            font-size: 0.875rem;
        }
        
        .checkup-section {
            margin-bottom: 1rem;
        }
        
        .checkup-section-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .checkup-section-content {
            color: #4b5563;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .medications-list {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        
        .medication-list-item {
            background: white;
            border: 1px solid #d1fae5;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .medication-list-item:last-child {
            margin-bottom: 0;
        }
        
        .medication-name {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 0.25rem;
        }
        
        .medication-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Success Animation */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        
        /* Required field indicator */
        .required::after {
            content: " *";
            color: var(--danger);
            font-weight: bold;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .modal-content {
                width: 98%;
                margin: 1rem;
                max-height: 98vh;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .section-header {
                margin-bottom: 1.5rem;
            }
            
            .section-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
            
            .save-section {
                padding: 2rem;
            }
            
            .save-content {
                flex-direction: column;
                text-align: center;
            }
            
            .save-btn {
                padding: 1.2rem 3rem;
                font-size: 1.1rem;
                width: 100%;
                justify-content: center;
            }
            
            .medication-grid {
                grid-template-columns: 1fr;
            }
            
            .checkup-header-info {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .medication-details {
                grid-template-columns: 1fr;
            }
            
            .medications-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .add-medication-btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <div class="bg-white p-2 rounded-xl shadow-md">
                <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" class="w-14 h-14 rounded-full" alt="شعار مستشفى الحياة الذكية">
            </div>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">مستشفى الحياة الذكية</h1>
                <p class="text-gray-600">نظام إدارة ملفات المرضى</p>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> طباعة الملف
            </button>
            <button onclick="window.location.href='emergency.html'" class="btn btn-secondary">
                <i class="fas fa-ambulance"></i> الطوارئ
            </button>
            <button onclick="window.location.href='index.html'" class="btn btn-success">
                <i class="fas fa-home"></i> الرئيسية
            </button>
        </div>
    </div>
    <!-- Patient Info Card -->
    <div class="card mb-6">
        <div class="header flex justify-between items-center">
            <div>
                <h2 class="text-xl md:text-2xl font-bold">ملف المريض</h2>
                <p class="opacity-90">تفاصيل المريض وسجلاته الطبية</p>
            </div>
            <div id="patientStatus" class="status-badge"></div>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-user-circle text-blue-600"></i> المعلومات الأساسية
                    </h3>
                    <div class="bg-gray-50 p-5 rounded-lg">
                        <table class="table-auto w-full" id="infoTable"></table>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mt-5">
                        <button onclick="changePatientStatus()" class="btn btn-secondary">
                            <i class="fas fa-exchange-alt"></i> تغيير الحالة
                        </button>
                        <button onclick="openCheckupModal()" class="btn btn-primary">
                            <i class="fas fa-stethoscope"></i> كشف طبي جديد
                        </button>
                        <a href="#" id="monitorBtn" class="btn btn-success">
                            <i class="fas fa-heartbeat"></i> عرض المونيتور
                        </a>
                    </div>
                </div>
                
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-qrcode text-blue-600"></i> رمز الاستجابة السريع
                    </h3>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                        <canvas id="qrCode" class="w-40 h-40"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Tabs Navigation -->
    <div class="flex border-b border-gray-200 mb-6">
        <div class="tab active" onclick="showTab('transfers', this)">
            <i class="fas fa-exchange-alt ml-2"></i> التحويلات
        </div>
        <div class="tab" onclick="showTab('checkups', this)">
            <i class="fas fa-file-medical ml-2"></i> الكشوفات الطبية
        </div>
    </div>
    <!-- Transfers Tab -->
    <div id="transfersTab" class="tab-content">
        <!-- New Transfer Form -->
        <div class="card mb-6">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-600"></i> تسجيل تحويل جديد
                </h2>
            </div>
            
            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">القسم</label>
                        <select id="transferDepartment" class="form-input">
                            <option value="">اختر القسم</option>
                            <option value="radiology">الأشعة</option>
                            <option value="التحاليل">التحاليل</option>
                            <option value="العناية المركزة">العناية المركزة</option>
                            <option value="العمليات">العمليات</option>
                            <option value="الصيدلية">الصيدلية</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">نوع الإجراء</label>
                        <input type="text" id="transferType" placeholder="نوع الإجراء (أشعة/تحاليل)" class="form-input" />
                    </div>
                    
                    <div id="radiologyDeviceDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">جهاز الأشعة</label>
                        <select id="radiologyDevice" class="form-input">
                            <option value="">اختر جهاز الأشعة</option>
                            <option value="أشعة عادية">أشعة عادية</option>
                            <option value="أشعة مقطعية">أشعة مقطعية</option>
                            <option value="رنين مغناطيسي">رنين مغناطيسي</option>
                            <option value="موجات صوتية">موجات صوتية</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات إضافية</label>
                        <textarea id="transferNotes" placeholder="ملاحظات إضافية" class="form-input" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Pharmacy Fields (Hidden by default) -->
                <div id="pharmacyFields" class="hidden mt-5 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-pills"></i>
                        تفاصيل طلب الدواء
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">اسم الدواء <span class="text-red-500">*</span></label>
                            <input type="text" id="medicationName" class="form-input" placeholder="اكتب اسم الدواء">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">الجرعة <span class="text-red-500">*</span></label>
                            <input type="text" id="dosage" class="form-input" placeholder="مثال: 500 مجم">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">المدة <span class="text-red-500">*</span></label>
                            <input type="text" id="duration" class="form-input" placeholder="مثال: 7 أيام">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نوع التأمين</label>
                            <select id="insuranceType" class="form-input">
                                <option value="">اختر نوع التأمين</option>
                                <option value="تأمين أساسي">تأمين أساسي</option>
                                <option value="تأمين تكميلي">تأمين تكميلي</option>
                                <option value="خاص">خاص</option>
                                <option value="غير مؤمن">غير مؤمن</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">عدد الجرعات</label>
                            <input type="number" id="dosesCount" class="form-input" placeholder="مثال: 3" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تعليمات الإعطاء</label>
                            <input type="text" id="administration" class="form-input" placeholder="مثال: بعد الأكل">
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 flex justify-end">
                    <button onclick="addTransfer()" class="btn btn-primary">
                        <i class="fas fa-save"></i> تسجيل التحويل
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Transfers History -->
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-history text-blue-600"></i> سجل التحويلات
                </h2>
            </div>
            <div class="p-5">
                <ul id="transferList" class="space-y-4"></ul>
            </div>
        </div>
    </div>
    <!-- Checkups Tab -->
    <div id="checkupsTab" class="tab-content hidden">
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-file-medical-alt text-blue-600"></i> سجل الكشوفات الطبية
                </h2>
            </div>
            <div class="p-5">
                <div id="checkupsList">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                        <p>جاري تحميل الكشوفات الطبية...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Enhanced Medical Checkup Modal -->
<div id="checkupModal" class="modal checkup-form-container" aria-modal="true" role="dialog" aria-labelledby="checkupModalTitle">
    <div class="modal-content">
        <!-- Modal Header -->
        <div class="checkup-header">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-6 mb-4">
                            <div class="bg-white/20 p-4 rounded-2xl backdrop-blur-sm">
                                <i class="fas fa-stethoscope text-4xl" aria-hidden="true"></i>
                            </div>
                            <div>
                                <h1 id="checkupModalTitle" class="text-4xl font-black mb-2">كشف طبي جديد</h1>
                                <p class="text-purple-100 text-xl">تسجيل بيانات الكشف الطبي للمريض</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 text-purple-100 text-lg">
                            <i class="fas fa-user-md text-2xl" aria-hidden="true"></i>
                            <span class="font-semibold" id="doctorDisplay">د. أحمد محمد</span>
                            <span class="text-2xl">•</span>
                            <span id="currentDate" class="font-medium"></span>
                        </div>
                    </div>
                    <button onclick="closeCheckupModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors" aria-label="إغلاق">
                        <i class="fas fa-times text-xl" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="overflow-y-auto" style="max-height: calc(95vh - 200px);">
            <form id="checkupForm">
                <!-- Visit Type Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-clipboard-list" aria-hidden="true"></i>
                        </div>
                        <h2 class="section-title">نوع الكشف</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="visitType">نوع الكشف</label>
                        <select id="visitType" class="form-select" required>
                            <option value="">اختر نوع الكشف</option>
                            <option value="كشف أولي">كشف أولي</option>
                            <option value="متابعة">متابعة</option>
                            <option value="استشارة">استشارة</option>
                            <option value="كشف دوري">كشف دوري</option>
                            <option value="طوارئ">طوارئ</option>
                        </select>
                    </div>
                </div>
                
                <!-- Symptoms Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-notes-medical" aria-hidden="true"></i>
                        </div>
                        <h2 class="section-title">الأعراض</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="symptoms">الأعراض التي يشتكي منها المريض</label>
                        <textarea id="symptoms" class="form-textarea" placeholder="اكتب الأعراض التي يشتكي منها المريض بالتفصيل..." required></textarea>
                    </div>
                </div>
                
                <!-- Diagnosis Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-diagnoses" aria-hidden="true"></i>
                        </div>
                        <h2 class="section-title">التشخيص</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="diagnosis">التشخيص الطبي</label>
                        <textarea id="diagnosis" class="form-textarea" placeholder="اكتب التشخيص الطبي للحالة..." required></textarea>
                    </div>
                </div>
                
                <!-- Treatment Plan Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-pills" aria-hidden="true"></i>
                        </div>
                        <h2 class="section-title">الخطة العلاجية والوصفات الطبية</h2>
                    </div>
                    
                    <div class="form-group mb-6">
                        <label class="form-label" for="treatmentPlan">الخطة العلاجية العامة</label>
                        <textarea id="treatmentPlan" class="form-textarea" placeholder="الخطة العلاجية العامة والتوصيات..." rows="4"></textarea>
                    </div>
                    
                    <!-- Enhanced Medications Section -->
                    <div class="medications-container">
                        <div class="medications-header">
                            <h3 class="medications-title">
                                <i class="fas fa-prescription-bottle text-green-600" aria-hidden="true"></i>
                                الأدوية الموصوفة
                            </h3>
                            <button type="button" onclick="addMedication()" class="add-medication-btn">
                                <i class="fas fa-plus-circle" aria-hidden="true"></i>
                                إضافة دواء
                            </button>
                        </div>
                        
                        <div id="medicationsList"></div>
                        
                        <div id="noMedications" class="empty-state">
                            <i class="fas fa-pills" aria-hidden="true"></i>
                            <p class="font-semibold text-lg">لا توجد أدوية مضافة</p>
                            <p class="text-base">اضغط على زر "إضافة دواء" لبدء إضافة الأدوية</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Enhanced Save Section -->
        <div class="save-section">
            <div class="save-content">
                <div class="save-info">
                    <h3>
                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                        تأكد من ملء جميع الحقول المطلوبة
                    </h3>
                    <p>سيتم حفظ الكشف الطبي في ملف المريض بعد التأكد من صحة البيانات</p>
                </div>
                <button onclick="saveVisit()" class="save-btn">
                    <i class="fas fa-save" aria-hidden="true"></i>
                    <span>حفظ الكشف الطبي</span>
                </button>
            </div>
        </div>
    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, onValue, get, remove, update, off } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB4glqZb0hz1uvERtq0pSZZzeBy3_grAnQ",
  authDomain: "smart-life-hospital-ef64c.firebaseapp.com",
  databaseURL: "https://smart-life-hospital-ef64c-default-rtdb.firebaseio.com",
  projectId: "smart-life-hospital-ef64c",
  storageBucket: "smart-life-hospital-ef64c.firebasestorage.app",
  messagingSenderId: "851045891087",
  appId: "1:851045891087:web:8e0f6e42f8c7fed17bf77a",
  measurementId: "G-QE5BL3MTY7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Escape helper to prevent XSS in text insertions
function escapeHTML(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Get patient ID from URL
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

// Set current date in modal
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Helper function to validate patient ID
function validatePatientId() {
  if (!patientId) {
    Swal.fire("خطأ", "معرف المريض غير موجود في الرابط", "error");
    return false;
  }
  return true;
}

// Helper function to show loading message
function showLoading(message = "جاري التحميل...") {
  Swal.fire({
    title: message,
    didOpen: () => { Swal.showLoading(); }
  });
}

// Helper function to show result message
function showResult(title, message, icon = "success") {
  Swal.fire({
    title,
    text: message,
    icon,
    timer: 1500,
    showConfirmButton: false
  });
}

// Function to update patient status UI
function updateStatusUI(status) {
  const statusEl = document.getElementById("patientStatus");
  
  const statusConfig = {
    critical: { 
      text: 'حرجة',
      class: 'status-critical',
      icon: 'fa-exclamation-triangle'
    },
    stable: { 
      text: 'مستقرة',
      class: 'status-stable',
      icon: 'fa-check-circle'
    },
    improving: { 
      text: 'في تحسن',
      class: 'status-improving',
      icon: 'fa-arrow-up'
    },
    deteriorating: { 
      text: 'في تدهور',
      class: 'status-deteriorating',
      icon: 'fa-arrow-down'
    }
  };
  
  const cfg = statusConfig[status] || statusConfig.stable;
  statusEl.className = \`status-badge \${cfg.class}\`;
  statusEl.innerHTML = \`<i class="fas \${cfg.icon} ml-2"></i>\${cfg.text}\`;
}

// Function to change patient status
window.changePatientStatus = async function() {
  if (!validatePatientId()) return;
  
  const { value: newStatus } = await Swal.fire({
    title: 'تغيير حالة المريض',
    input: 'select',
    inputOptions: {
      'critical': 'حرجة',
      'stable': 'مستقرة',
      'improving': 'في تحسن',
      'deteriorating': 'في تدهور'
    },
    inputPlaceholder: 'اختر الحالة الجديدة',
    showCancelButton: true,
    confirmButtonText: 'حفظ',
    cancelButtonText: 'إلغاء',
    inputValidator: (value) => {
      if (!value) return 'يرجى اختيار الحالة';
    }
  });
  
  if (newStatus) {
        try {
            showLoading("جاري تحديث الحالة...");
            await update(ref(db, \`patients/emergency/\${patientId}\`), { status: newStatus });
            updateStatusUI(newStatus);
            showResult("تم!", "تم تغيير حالة المريض بنجاح");
        } catch (error) {
            Swal.fire("خطأ", "فشل تحديث الحالة: " + error.message, "error");
        }
  }
};

// Load patient data
async function loadPatientData() {
  if (!validatePatientId()) return;
  
  const infoTable = document.getElementById("infoTable");
  const qrCanvas = document.getElementById("qrCode");
  
  try {
    const snapshot = await get(ref(db, \`patients/emergency/\${patientId}\`));
    
    if (snapshot.exists()) {
      const patient = snapshot.val();
      // Build safe rows
      const rows = [
        ['الاسم:', escapeHTML(patient.name || '-')],
        ['العمر:', escapeHTML(patient.age || '-')],
        ['الرقم القومي:', escapeHTML(patient.nid || '-')],
        ['ID:', escapeHTML(patientId)],
        ['تاريخ الدخول:', escapeHTML(patient.timestamp ? new Date(patient.timestamp).toLocaleString('ar-EG') : '-')],
        ['القسم الحالي:', escapeHTML(patient.department || '-')],
        ['الطبيب المعالج:', escapeHTML(patient.doctors || '-')],
        ['نوع الخدمة:', escapeHTML(patient.serviceType || 'غير محدد')],
        ['الحالة:', escapeHTML(patient.status || 'غير محدد')]
      ];
      infoTable.innerHTML = rows.map(([k, v]) => 
        \`<tr><td class="py-2 px-3 font-semibold text-gray-700 w-1/3">\${k}</td><td class="py-2 px-3">\${v}</td></tr>\`
      ).join('');
      
      updateStatusUI(patient.status || "stable");
      
      // Generate QR code
      QRCode.toCanvas(qrCanvas, patientId, function (error) {
        if (error) console.error(error);
      });
    } else {
      infoTable.innerHTML = "<tr><td colspan='2' class='py-2 px-3 text-center text-gray-500'>لم يتم العثور على بيانات المريض.</td></tr>";
    }
  } catch (error) {
    Swal.fire("خطأ", "فشل تحميل بيانات المريض: " + error.message, "error");
  }
}

// Open medical checkup modal
window.openCheckupModal = function() {
  if (!validatePatientId()) return;
  
  // Reset form
  document.getElementById('checkupForm').reset();
  
  // Reset medications list
  document.getElementById('medicationsList').innerHTML = '';
  document.getElementById('noMedications').style.display = 'block';
  
  // Show modal with animation
  const modal = document.getElementById('checkupModal');
  modal.classList.add('active');
  
  // Add entrance animations
  const sections = modal.querySelectorAll('.form-section');
  sections.forEach((section, index) => {
    section.style.opacity = '0';
    section.style.transform = 'translateY(30px)';
    
    setTimeout(() => {
      section.style.transition = 'all 0.6s ease';
      section.style.opacity = '1';
      section.style.transform = 'translateY(0)';
    }, index * 150);
  });

  // Focus first control for accessibility
  const visitTypeEl = document.getElementById('visitType');
  visitTypeEl && visitTypeEl.focus();
};

// Close medical checkup modal
window.closeCheckupModal = function() {
  const modal = document.getElementById('checkupModal');
  modal.classList.remove('active');
};

// Function to add a new medication
window.addMedication = function() {
  const medicationsList = document.getElementById("medicationsList");
  const noMedications = document.getElementById("noMedications");
  
  noMedications.style.display = 'none';
  
  const medicationId = Date.now();
  const medicationItem = document.createElement('div');
  medicationItem.className = 'medication-item';
  medicationItem.id = \`medication-\${medicationId}\`;
  
  medicationItem.innerHTML = \`
    <div class="medication-header">
      <h4 class="medication-title">الدواء #\${medicationsList.children.length + 1}</h4>
      <button type="button" onclick="removeMedication(\${medicationId})" class="remove-medication" aria-label="حذف الدواء">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    <div class="medication-grid">
      <div class="form-group">
        <label class="form-label required">اسم الدواء</label>
        <input type="text" class="medication-name form-input" placeholder="اسم الدواء" required>
      </div>
      <div class="form-group">
        <label class="form-label required">الجرعة</label>
        <input type="text" class="medication-dosage form-input" placeholder="مثال: 500 مجم" required>
      </div>
      <div class="form-group">
        <label class="form-label required">المدة</label>
        <input type="text" class="medication-duration form-input" placeholder="مثال: 7 أيام" required>
      </div>
      <div class="form-group">
        <label class="form-label">نوع التأمين</label>
        <select class="medication-insurance form-select">
          <option value="">اختر نوع التأمين</option>
          <option value="تأمين أساسي">تأمين أساسي</option>
          <option value="تأمين تكميلي">تأمين تكميلي</option>
          <option value="خاص">خاص</option>
          <option value="غير مؤمن">غير مؤمن</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">عدد الجرعات</label>
        <input type="number" class="medication-doses form-input" placeholder="مثال: 3" min="1">
      </div>
      <div class="form-group">
        <label class="form-label">تعليمات الإعطاء</label>
        <input type="text" class="medication-instructions form-input" placeholder="مثال: بعد الأكل">
      </div>
    </div>
  \`;
  
  medicationsList.appendChild(medicationItem);
  
  medicationItem.style.opacity = '0';
  medicationItem.style.transform = 'translateY(30px)';
  setTimeout(() => {
    medicationItem.style.transition = 'all 0.5s ease';
    medicationItem.style.opacity = '1';
    medicationItem.style.transform = 'translateY(0)';
  }, 10);
};

// Function to remove a medication
window.removeMedication = function(medicationId) {
  const medicationItem = document.getElementById(\`medication-\${medicationId}\`);
  if (medicationItem) {
    medicationItem.style.transition = 'all 0.3s ease';
    medicationItem.style.opacity = '0';
    medicationItem.style.transform = 'translateX(-30px)';
    
    setTimeout(() => {
      medicationItem.remove();
      
      const medicationsList = document.getElementById('medicationsList');
      if (medicationsList.children.length === 0) {
        document.getElementById('noMedications').style.display = 'block';
      }
    }, 300);
  }
};

// Save medical checkup data
window.saveVisit = async function() {
  if (!validatePatientId()) return;
  
  const visitType = document.getElementById('visitType').value;
  const symptoms = document.getElementById('symptoms').value;
  const diagnosis = document.getElementById('diagnosis').value;
  const treatmentPlan = document.getElementById('treatmentPlan').value;
  
  if (!visitType || !symptoms || !diagnosis) {
    Swal.fire({
      title: 'حقول مطلوبة',
      text: 'يرجى ملء الحقول المطلوبة (نوع الكشف، الأعراض، التشخيص)',
      icon: 'warning',
      confirmButtonText: 'موافق'
    });
    return;
  }
  
  const medications = [];
  const medicationItems = document.querySelectorAll('#medicationsList > div');
  
  medicationItems.forEach(item => {
    const name = item.querySelector('.medication-name').value.trim();
    const dosage = item.querySelector('.medication-dosage').value.trim();
    const duration = item.querySelector('.medication-duration').value.trim();
    const insurance = item.querySelector('.medication-insurance').value;
    const doses = item.querySelector('.medication-doses').value;
    const instructions = item.querySelector('.medication-instructions').value.trim();
    
    if (name && dosage && duration) {
      medications.push({
        name,
        dosage,
        duration,
        insurance: insurance || "غير محدد",
        doses: doses || null,
        instructions: instructions || "حسب إرشادات الطبيب"
      });
    }
  });
  
  try {
    Swal.fire({
      title: 'جاري حفظ الكشف الطبي...',
      html: '<div class="loading"></div>',
      didOpen: () => { Swal.showLoading(); },
      allowOutsideClick: false,
      allowEscapeKey: false
    });
    
    const checkupData = {
      visitType,
      symptoms,
      diagnosis,
      treatmentPlan,
      medications,
      doctorId: "د. أحمد محمد",
      doctorName: "أحمد محمد",
      date: new Date().toISOString(),
      status: "مكتمل"
    };
    
    const newCheckupRef = await push(ref(db, \`patients/emergency/\${patientId}/checkups\`), checkupData);
    checkupData.id = newCheckupRef.key;
    
    await update(ref(db, \`patients/emergency/\${patientId}\`), {
      lastCheckup: new Date().toISOString(),
      serviceType: visitType,
      lastCheckupBy: "د. أحمد محمد"
    });
    
    Swal.fire({
      title: 'تم الحفظ بنجاح!',
      text: 'تم حفظ الكشف الطبي في ملف المريض',
      icon: 'success',
      timer: 2000,
      showConfirmButton: false
    });
    
    const saveBtn = document.querySelector('.save-btn');
    saveBtn.classList.add('success-animation');
    
    setTimeout(() => {
      closeCheckupModal();
      loadCheckups();
    }, 1500);
    
  } catch (error) {
    console.error('Error saving checkup:', error);
    Swal.fire("خطأ", "فشل حفظ الكشف: " + error.message, "error");
  }
};

// Show/hide fields based on selected department
document.getElementById("transferDepartment").addEventListener("change", function() {
  const department = this.value;
  const deviceSelect = document.getElementById("radiologyDevice");
  const deviceDiv = document.getElementById("radiologyDeviceDiv");
  const pharmacyFields = document.getElementById("pharmacyFields");
  const transferTypeInput = document.getElementById("transferType");
  
  deviceDiv.classList.add("hidden");
  pharmacyFields.classList.add("hidden");
  
  if (department === "radiology") {
    deviceDiv.classList.remove("hidden");
    transferTypeInput.placeholder = "نوع الأشعة";
  } else if (department === "الصيدلية") {
    pharmacyFields.classList.remove("hidden");
    transferTypeInput.placeholder = "طلب دواء";
    transferTypeInput.value = "طلب صرف دواء";
  } else if (department === "التحاليل") {
    transferTypeInput.placeholder = "نوع التحليل";
  } else {
    transferTypeInput.placeholder = "نوع الإجراء";
  }
});

// Track active Firebase listeners to unsubscribe later
const activeListeners = [];

function addTransferListener() {
  if (!validatePatientId()) return;
  const list = document.getElementById("transferList");
  const transfersRef = ref(db, \`patients/emergency/\${patientId}/transfers\`);
  
  const callback = (snapshot) => {
    list.innerHTML = "";
    
    if (!snapshot.exists()) {
      list.innerHTML = "<p class='text-gray-500 text-center py-4'>لا توجد تحويلات مسجلة</p>";
      return;
    }
    
    snapshot.forEach((child) => {
      const t = child.val();
      const key = child.key;
      let resultHtml = "";
      
      if (t.department === "الصيدلية" && t.medication) {
        const med = t.medication;
        resultHtml += \`
          <div class="bg-green-50 p-3 rounded-lg mt-2 border border-green-200">
            <div class="font-semibold text-green-800 mb-2">تفاصيل الدواء:</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              <div><span class="font-medium">الدواء:</span> \${escapeHTML(med.name)}</div>
              <div><span class="font-medium">الجرعة:</span> \${escapeHTML(med.dosage)}</div>
              <div><span class="font-medium">المدة:</span> \${escapeHTML(med.duration)}</div>
              <div><span class="font-medium">التأمين:</span> \${escapeHTML(med.insuranceType)}</div>
              \${med.dosesCount ? \`<div><span class="font-medium">عدد الجرعات:</span> \${escapeHTML(med.dosesCount)}</div>\` : ''}
              <div class="md:col-span-2"><span class="font-medium">طريقة الإعطاء:</span> \${escapeHTML(med.administration)}</div>
            </div>
          </div>
        \`;
      }
      
      if (t.report) {
        resultHtml += \` | <span class="text-green-700">النتيجة: \${escapeHTML(t.report)}</span>\`;
      }
      if (t.technician) {
        resultHtml += \` | <span class="text-blue-700">منفذ الأشعة: \${escapeHTML(t.technician)}</span>\`;
      }
      if (t.device) {
        resultHtml += \` | <span class="text-purple-700">الجهاز: \${escapeHTML(t.device)}</span>\`;
      }
      
      let actionBtns = "";
      if (t.department === "radiology") {
        if (t.status === "قيد الانتظار") {
          actionBtns += \`<button onclick='editRadiology("\${key}", \${JSON.stringify(t).replace(/</g,'\\u003c')})' class="btn btn-primary text-sm ml-2">تعديل</button>\`;
        }
        if (t.status === "تم التنفيذ") {
          actionBtns += \`<button onclick='showRadiologyReport(\${JSON.stringify(t).replace(/</g,'\\u003c')})' class="btn btn-success text-sm ml-2">عرض النتيجة</button>\`;
        }
        actionBtns += \`<button onclick='deleteTransfer("\${key}")' class="btn btn-danger text-sm ml-2">حذف</button>\`;
      } else if (t.department === "الصيدلية") {
        if (t.status === "قيد الانتظار") {
          actionBtns += \`
            <button onclick='updateMedicationStatus("\${key}", "تم الصرف")' class="btn btn-success text-sm ml-2">
              <i class="fas fa-check"></i>تأكيد الصرف
            </button>
            <button onclick='updateMedicationStatus("\${key}", "مرفوض")' class="btn btn-danger text-sm ml-2">
              <i class="fas fa-times"></i>رفض
            </button>
          \`;
        } else if (t.status === "تم الصرف") {
          actionBtns += \`<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">تم الصرف</span>\`;
        } else if (t.status === "مرفوض") {
          actionBtns += \`<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">مرفوض</span>\`;
        }
        actionBtns += \`<button onclick='deleteTransfer("\${key}")' class="btn btn-danger text-sm ml-2"><i class="fas fa-trash"></i></button>\`;
      }
      
      const statusColor = {
        "قيد الانتظار": "text-yellow-600 bg-yellow-50",
        "تم التنفيذ": "text-green-600 bg-green-50",
        "تم الصرف": "text-green-600 bg-green-50",
        "مرفوض": "text-red-600 bg-red-50"
      };
      
      const item = document.createElement("div");
      item.className = "medical-record-item";
      item.innerHTML = \`
        <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-2">
          <div class="mb-2 md:mb-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="font-semibold text-lg">\${getDepartmentIcon(t.department)} \${escapeHTML(t.department)}</span>
              <span class="mx-1">•</span>
              <span>\${escapeHTML(t.type || '')}</span>
            </div>
            <div class="text-sm text-gray-500">
              \${escapeHTML(t.date || '')}
            </div>
          </div>
          <div class="px-3 py-1 rounded-full text-sm font-medium \${statusColor[t.status] || 'text-gray-600 bg-gray-50'}">
            \${escapeHTML(t.status || '')}
          </div>
        </div>
        \${resultHtml}
        <div class="mt-3 flex flex-wrap gap-2">
          \${actionBtns}
        </div>
      \`;
      list.appendChild(item);
    });
  };

  onValue(transfersRef, callback);
  activeListeners.push({ ref: transfersRef, callback });
}

// Helper function to get department icon
function getDepartmentIcon(department) {
  const icons = {
    "radiology": "📡",
    "التحاليل": "🔬",
    "العناية المركزة": "🏥",
    "العمليات": "🔪",
    "الصيدلية": "💊"
  };
  return icons[department] || "📋";
}

// Function to update medication status
window.updateMedicationStatus = async function(transferKey, newStatus) {
  try {
    showLoading("جاري تحديث الحالة...");
    await update(ref(db, \`patients/emergency/\${patientId}/transfers/\${transferKey}\`), {
      status: newStatus,
      updatedAt: new Date().toISOString(),
      processedBy: "موظف الصيدلية"
    });
    showResult("تم!", \`تم تحديث حالة الطلب إلى: \${newStatus}\`);
  } catch (error) {
    Swal.fire("خطأ", "فشل تحديث الحالة: " + error.message, "error");
  }
};

// Show radiology report
window.showRadiologyReport = function(transfer) {
  let fileHtml = '';
  if (transfer.fileUrl) {
    const ext = transfer.fileUrl.split('.').pop().toLowerCase();
    if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
      fileHtml = \`<img src="\${transfer.fileUrl}" alt="صورة الأشعة" style="max-width:100%;max-height:40vh;display:block;margin:10px auto;">\`;
    } else if (ext === "pdf") {
      fileHtml = \`<iframe src="\${transfer.fileUrl}" style="width:100%;height:40vh;" frameborder="0" title="ملف الأشعة"></iframe>\`;
    } else {
      fileHtml = \`<a href="\${transfer.fileUrl}" target="_blank" class="text-blue-700 underline" rel="noopener noreferrer">تحميل الملف</a>\`;
    }
  } else {
    fileHtml = \`<span class="text-gray-500">لا يوجد ملف مرفق</span>\`;
  }
  
  Swal.fire({
    title: "نتيجة الأشعة",
    html: \`
      <div class="text-right">
        <p><b>نوع الأشعة:</b> \${escapeHTML(transfer.type || "-")}</p>
        <p><b>الجهاز:</b> \${escapeHTML(transfer.device || "-")}</p>
        <p><b>منفذ الأشعة:</b> \${escapeHTML(transfer.technician || "-")}</p>
        <p><b>تقرير الفني:</b> \${escapeHTML(transfer.report || "لا يوجد تقرير")}</p>
        <p><b>تاريخ التنفيذ:</b> \${escapeHTML(transfer.executionDate || "-")}</p>
        <div class="mt-4">
          \${fileHtml}
        </div>
      </div>
    \`,
    width: "60vw",
    showCloseButton: true,
    confirmButtonText: "إغلاق"
  });
};

// Load medical checkups with improved error handling and display
function addCheckupsListener() {
  if (!validatePatientId()) return;
  
  const checkupsList = document.getElementById("checkupsList");
  const checkupsRef = ref(db, \`patients/emergency/\${patientId}/checkups\`);
  
  checkupsList.innerHTML = \`
    <div class="text-center py-8 text-gray-500">
      <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
      <p>جاري تحميل الكشوفات الطبية...</p>
    </div>
  \`;
  
  const callback = (snapshot) => {
    checkupsList.innerHTML = "";
    
    if (!snapshot.exists()) {
      checkupsList.innerHTML = \`
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-file-medical text-4xl mb-3"></i>
          <p class="text-lg font-medium">لا توجد كشوفات طبية مسجلة</p>
          <p class="text-sm">اضغط على "كشف طبي جديد" لتسجيل أول كشف</p>
        </div>
      \`;
      return;
    }
    
    const checkupsArray = [];
    snapshot.forEach((child) => {
      const checkup = child.val();
      checkup.id = child.key;
      checkupsArray.push(checkup);
    });
    
    if (checkupsArray.length === 0) {
      checkupsList.innerHTML = \`
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-file-medical text-4xl mb-3"></i>
          <p class="text-lg font-medium">لا توجد كشوفات طبية مسجلة</p>
          <p class="text-sm">اضغط على "كشف طبي جديد" لتسجيل أول كشف</p>
        </div>
      \`;
      return;
    }
    
    checkupsArray.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    checkupsArray.forEach((checkup) => {
      const checkupEl = document.createElement("div");
      checkupEl.className = "checkup-item";
      
      const checkupDate = new Date(checkup.date);
      const formattedDate = isNaN(checkupDate.getTime())
        ? escapeHTML(checkup.date || '')
        : checkupDate.toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
      
      let medicationsHtml = '';
      if (checkup.medications && checkup.medications.length > 0) {
        const medicationsList = checkup.medications.map((med, index) => \`
          <div class="medication-list-item">
            <div class="medication-name">\${index + 1}. \${escapeHTML(med.name)}</div>
            <div class="medication-details">
              <div><span class="font-medium">الجرعة:</span> \${escapeHTML(med.dosage)}</div>
              <div><span class="font-medium">المدة:</span> \${escapeHTML(med.duration)}</div>
              <div><span class="font-medium">التأمين:</span> \${escapeHTML(med.insurance)}</div>
              \${med.doses ? \`<div><span class="font-medium">الجرعات:</span> \${escapeHTML(med.doses)}</div>\` : ''}
              <div><span class="font-medium">التعليمات:</span> \${escapeHTML(med.instructions)}</div>
            </div>
          </div>
        \`).join('');
        
        medicationsHtml = \`
          <div class="checkup-section">
            <div class="checkup-section-title">
              <i class="fas fa-pills text-green-600" aria-hidden="true"></i>
              الأدوية الموصوفة (\${checkup.medications.length})
            </div>
            <div class="medications-list">
              \${medicationsList}
            </div>
          </div>
        \`;
      }
      
      checkupEl.innerHTML = \`
        <div class="checkup-header-info">
          <div>
            <div class="checkup-meta">
              <span class="checkup-type-badge">\${escapeHTML(checkup.visitType || 'كشف')}</span>
              <span class="checkup-date">\${formattedDate}</span>
            </div>
          </div>
          <div class="text-xs text-gray-500">
            <i class="fas fa-user-md" aria-hidden="true"></i> \${escapeHTML(checkup.doctorName || checkup.doctorId || 'طبيب')}
          </div>
        </div>
        
        <div class="checkup-section">
          <div class="checkup-section-title">
            <i class="fas fa-notes-medical text-red-500" aria-hidden="true"></i>
            الأعراض
          </div>
          <div class="checkup-section-content">\${escapeHTML(checkup.symptoms || 'لا توجد أعراض مسجلة')}</div>
        </div>
        
        <div class="checkup-section">
          <div class="checkup-section-title">
            <i class="fas fa-diagnoses text-purple-600" aria-hidden="true"></i>
            التشخيص
          </div>
          <div class="checkup-section-content">\${escapeHTML(checkup.diagnosis || 'لا يوجد تشخيص مسجل')}</div>
        </div>
        
        <div class="checkup-section">
          <div class="checkup-section-title">
            <i class="fas fa-heartbeat text-blue-600" aria-hidden="true"></i>
            الخطة العلاجية
          </div>
          <div class="checkup-section-content">\${escapeHTML(checkup.treatmentPlan || 'لا توجد خطة علاجية مسجلة')}</div>
        </div>
        
        \${medicationsHtml}
      \`;
      
      checkupsList.appendChild(checkupEl);
    });
  };

  onValue(checkupsRef, callback);
  activeListeners.push({ ref: checkupsRef, callback });
}

// Tab switching functionality (fixed to avoid implicit event)
window.showTab = function(tabName, el) {
  document.getElementById('transfersTab').classList.add('hidden');
  document.getElementById('checkupsTab').classList.add('hidden');
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.remove('hidden');
  if (el) el.classList.add('active');
  if (tabName === 'checkups') {
    // ensure listener attached
    if (!activeListeners.find(l => String(l.ref).includes('/checkups'))) {
      addCheckupsListener();
    }
  }
};

// Add keyboard shortcut for save (Ctrl+S)
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    if (document.getElementById('checkupModal').classList.contains('active')) {
      saveVisit();
    }
  }
});

// Load data when page opens
if (patientId) {
  loadPatientData();
  addTransferListener();
  addCheckupsListener();
} else {
  Swal.fire("خطأ", "معرف المريض غير موجود في الرابط", "error");
}

// Link monitor button
const monitorBtn = document.getElementById('monitorBtn');
if (monitorBtn && patientId) {
  monitorBtn.href = \`monitor.html?id=\${encodeURIComponent(patientId)}\`;
}

// Unsubscribe all listeners on unload to avoid leaks
window.addEventListener('beforeunload', () => {
  try {
    activeListeners.forEach(({ ref: r, callback }) => off(r, 'value', callback));
  } catch (e) {
    // no-op
  }
});
</script>
</body>
</html>
