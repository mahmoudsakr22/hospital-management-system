<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶ - Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-4">

  <div class="max-w-5xl mx-auto bg-white shadow-md rounded-xl p-6 space-y-6">
    <h1 class="text-3xl font-bold text-center text-blue-800">ğŸ©º Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶</h1>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <div class="border rounded-xl p-4 bg-blue-50">
      <h2 class="text-xl font-semibold mb-2">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
      <div id="patientInfo" class="grid grid-cols-2 gap-4 text-sm text-gray-700"></div>
    </div>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© -->
    <div class="border rounded-xl p-4 bg-green-50">
      <h2 class="text-xl font-semibold mb-2">ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <select id="visitType" class="border rounded p-2 w-full mb-2">
        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</option>
        <option>ÙƒØ´Ù Ø·Ø¨ÙŠ</option>
        <option>Ù…ØªØ§Ø¨Ø¹Ø©</option>
        <option>Ø§Ø³ØªØ´Ø§Ø±Ø©</option>
      </select>
      <textarea id="visitNotes" class="border rounded p-2 w-full mb-2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨"></textarea>
      <button onclick="addVisit()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
      <div id="visitsList" class="mt-4 text-sm text-gray-700"></div>
    </div>

    <!-- ØªØ­ÙˆÙŠÙ„ Ù„Ù‚Ø³Ù… Ø¢Ø®Ø± -->
    <div class="border rounded-xl p-4 bg-yellow-50">
      <h2 class="text-xl font-semibold mb-2">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
      <select id="transferDept" class="border rounded p-2 w-full mb-2" onchange="toggleTransferFields()">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
        <option value="radiology">Ø§Ù„Ø£Ø´Ø¹Ø©</option>
        <option value="lab">Ø§Ù„Ù…Ø¹Ù…Ù„</option>
        <option value="icu">Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²Ø©</option>
      </select>
      <div id="extraFields" class="space-y-2 hidden">
        <input id="transferType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ù…Ø«Ù„Ø§Ù‹ Ù†ÙˆØ¹ Ø§Ù„Ø£Ø´Ø¹Ø© Ø£Ùˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„)" class="border rounded p-2 w-full" />
        <textarea id="transferNotes" class="border rounded p-2 w-full" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
      </div>
      <button onclick="addTransfer()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded mt-2">ØªØ­ÙˆÙŠÙ„</button>
      <div id="transfersList" class="mt-4 text-sm text-gray-700"></div>
    </div>

  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");
    
    const firebaseConfig = {
      apiKey: "AIzaSyDq...",
      authDomain: "smart-hospital-life.firebaseapp.com",
      databaseURL: "https://smart-hospital-life-default-rtdb.firebaseio.com",
      projectId: "smart-hospital-life",
      storageBucket: "smart-hospital-life.appspot.com",
      messagingSenderId: "927436837793",
      appId: "1:927436837793:web:43cd4..."
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
    async function loadPatientData() {
      const snapshot = await db.ref("patients/emergency/" + patientId).get();
      if (!snapshot.exists()) {
        Swal.fire("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙŠØ¶", "error");
        return;
      }
      const p = snapshot.val();
      document.getElementById("patientInfo").innerHTML = `
        <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${p.name}</div>
        <div><strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${p.age}</div>
        <div><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</strong> ${p.nationalId}</div>
        <div><strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${patientId}</div>
        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„:</strong> ${p.admissionDate}</div>
        <div><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.department}</div>
        <div><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> ${p.doctor}</div>
      `;
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©
    async function addVisit() {
      const type = document.getElementById("visitType").value;
      const notes = document.getElementById("visitNotes").value;
      if (!type || !notes) return alert("Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
      await db.ref(`visits/${patientId}`).push({
        type,
        notes,
        time: new Date().toLocaleString()
      });
      Swal.fire("ØªÙ…", "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­", "success");
      loadVisits();
    }

    async function loadVisits() {
      const snapshot = await db.ref(`visits/${patientId}`).get();
      let html = "<h3 class='font-bold mb-2'>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª:</h3>";
      snapshot.forEach(child => {
        const v = child.val();
        html += `<div class="mb-1">ğŸ”¹ <strong>${v.type}</strong>: ${v.notes} - <span class="text-gray-500">${v.time}</span></div>`;
      });
      document.getElementById("visitsList").innerHTML = html;
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„Ù‚Ø³Ù…
    async function addTransfer() {
      const dept = document.getElementById("transferDept").value;
      const type = document.getElementById("transferType").value;
      const notes = document.getElementById("transferNotes").value;

      const snapshot = await db.ref("patients/emergency/" + patientId).get();
      const p = snapshot.val();

      // Ù„Ùˆ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø± Ø£Ø´Ø¹Ø© Ù†Ø±ÙˆØ­ Ù†Ø­ÙØ¸Ù‡ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ù†ÙØµÙ„ radiology_requests
      if (dept === "radiology") {
        await db.ref("radiology_requests").push({
          patientId,
          patientName: p.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
          age: p.age || "",
          doctor: p.doctor || "",
          department: p.department || "",
          type: type || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
          notes: notes || "",
          timestamp: Date.now(),
          status: "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ†ÙÙŠØ°"
        });
      }

      // Ù†Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª
      await db.ref(`transfers/${patientId}`).push({
        department: dept,
        type,
        notes,
        time: new Date().toLocaleString()
      });

      Swal.fire("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„", "ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­", "success");
      loadTransfers();
    }

    async function loadTransfers() {
      const snapshot = await db.ref(`transfers/${patientId}`).get();
      let html = "<h3 class='font-bold mb-2'>Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª:</h3>";
      snapshot.forEach(child => {
        const t = child.val();
        html += `<div class="mb-1">ğŸ“¤ <strong>${t.department}</strong> - ${t.type} (${t.notes}) - <span class="text-gray-500">${t.time}</span></div>`;
      });
      document.getElementById("transfersList").innerHTML = html;
    }

    function toggleTransferFields() {
      const dept = document.getElementById("transferDept").value;
      const extra = document.getElementById("extraFields");
      extra.classList.toggle("hidden", dept === "");
    }

    loadPatientData();
    loadVisits();
    loadTransfers();
  </script>

</body>
</html>
