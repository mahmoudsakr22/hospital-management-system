<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">

  <h1 class="text-2xl font-bold mb-4 text-center">ملف المريض</h1>

  <!-- معلومات أساسية -->
  <div id="basicInfo" class="bg-white rounded-xl shadow p-4 mb-6">
    <h2 class="text-xl font-bold mb-2">المعلومات الأساسية</h2>
    <table class="table-auto w-full text-right">
      <tbody>
        <tr><td>الاسم:</td><td id="name"></td></tr>
        <tr><td>العمر:</td><td id="age"></td></tr>
        <tr><td>الرقم القومي:</td><td id="nid"></td></tr>
        <tr><td>ID:</td><td id="id"></td></tr>
        <tr><td>تاريخ الدخول:</td><td id="admissionDate"></td></tr>
        <tr><td>القسم الحالي:</td><td id="currentSection"></td></tr>
        <tr><td>الطبيب المعالج:</td><td id="doctor"></td></tr>
      </tbody>
    </table>
    <div id="qrcode" class="mt-4"></div>
  </div>

  <!-- سجل الزيارات -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h2 class="text-xl font-bold mb-2">سجل الزيارات</h2>
    <table class="table-auto w-full text-right border">
      <thead><tr><th>النوع</th><th>ملاحظات</th><th>التاريخ</th></tr></thead>
      <tbody id="visitsTable"></tbody>
    </table>
  </div>

  <!-- سجل التحويلات -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h2 class="text-xl font-bold mb-2">سجل التحويلات</h2>
    <table class="table-auto w-full text-right border">
      <thead><tr><th>إلى قسم</th><th>تفاصيل</th><th>التاريخ</th></tr></thead>
      <tbody id="transfersTable"></tbody>
    </table>
  </div>

  <!-- سجل الأدوية -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h2 class="text-xl font-bold mb-2">سجل الأدوية</h2>
    <table class="table-auto w-full text-right border">
      <thead><tr><th>اسم الدواء</th><th>الجرعة</th><th>ملاحظات</th></tr></thead>
      <tbody id="medsTable"></tbody>
    </table>
  </div>

  <!-- قسم الأشعة -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h2 class="text-xl font-bold mb-2">طلب أشعة</h2>
    <label>نوع الأشعة:</label>
    <select id="radiologyType" class="border rounded p-1 w-full my-2">
      <option value="أشعة سينية">أشعة سينية</option>
      <option value="أشعة مقطعية">أشعة مقطعية</option>
      <option value="رنين مغناطيسي">رنين مغناطيسي</option>
      <option value="أشعة صوتية">أشعة صوتية</option>
    </select>
    <label>ملاحظات:</label>
    <textarea id="radiologyNotes" class="border rounded p-1 w-full my-2"></textarea>
    <button onclick="requestRadiology()" class="bg-blue-600 text-white px-4 py-2 rounded">تحويل لقسم الأشعة</button>
  </div>

  <!-- سجل طلبات الأشعة -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h2 class="text-xl font-bold mb-2">طلبات الأشعة السابقة</h2>
    <table class="table-auto w-full text-right border">
      <thead><tr><th>النوع</th><th>ملاحظات</th><th>التاريخ</th></tr></thead>
      <tbody id="radiologyRequestsTable"></tbody>
    </table>
  </div>

  <!-- العودة -->
  <div class="text-center mt-8">
    <a href="emergency.html" class="bg-gray-500 text-white px-6 py-2 rounded">رجوع إلى قسم الطوارئ</a>
  </div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const patientId = localStorage.getItem("patientId");

    function loadPatientData() {
      const ref = db.ref("patients/emergency/" + patientId);
      ref.once("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        document.getElementById("name").textContent = data.name || '';
        document.getElementById("age").textContent = data.age || '';
        document.getElementById("nid").textContent = data.nid || '';
        document.getElementById("id").textContent = patientId;
        document.getElementById("admissionDate").textContent = data.admissionDate || '';
        document.getElementById("currentSection").textContent = data.section || '';
        document.getElementById("doctor").textContent = data.doctor || '';

        QRCode.toCanvas(document.getElementById("qrcode"), patientId);

        renderTable("visitsTable", data.visits, ["type", "notes", "date"]);
        renderTable("transfersTable", data.transfers, ["to", "details", "date"]);
        renderTable("medsTable", data.meds, ["name", "dose", "notes"]);
        renderTable("radiologyRequestsTable", data.radiology || {}, ["type", "notes", "date"]);
      });
    }

    function renderTable(tableId, dataObj, keys) {
      const table = document.getElementById(tableId);
      table.innerHTML = "";
      if (!dataObj) return;
      Object.values(dataObj).forEach((item) => {
        const row = document.createElement("tr");
        keys.forEach((key) => {
          const td = document.createElement("td");
          td.textContent = item[key] || "";
          row.appendChild(td);
        });
        table.appendChild(row);
      });
    }

    function requestRadiology() {
      const type = document.getElementById("radiologyType").value;
      const notes = document.getElementById("radiologyNotes").value;
      const date = new Date().toLocaleString();

      const ref = db.ref(`patients/emergency/${patientId}/radiology`).push();
      ref.set({ type, notes, date }).then(() => {
        Swal.fire("تم تحويل المريض لقسم الأشعة بنجاح");
        loadPatientData();
        document.getElementById("radiologyNotes").value = "";
      });
    }

    // تحميل البيانات عند فتح الصفحة
    window.onload = loadPatientData;
  </script>
</body>
</html>
