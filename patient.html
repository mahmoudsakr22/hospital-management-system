<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-4">

  <div class="max-w-5xl mx-auto bg-white shadow-md rounded-xl p-6 space-y-6">
    <h1 class="text-3xl font-bold text-center text-blue-800">🩺 ملف المريض</h1>

    <!-- معلومات المريض -->
    <div class="border rounded-xl p-4 bg-blue-50">
      <h2 class="text-xl font-semibold mb-2">المعلومات الأساسية</h2>
      <div id="patientInfo" class="grid grid-cols-2 gap-4 text-sm text-gray-700"></div>
    </div>

    <!-- تسجيل زيارة -->
    <div class="border rounded-xl p-4 bg-green-50">
      <h2 class="text-xl font-semibold mb-2">تسجيل زيارة جديدة</h2>
      <select id="visitType" class="border rounded p-2 w-full mb-2">
        <option value="">اختر نوع الزيارة</option>
        <option>كشف طبي</option>
        <option>متابعة</option>
        <option>استشارة</option>
      </select>
      <textarea id="visitNotes" class="border rounded p-2 w-full mb-2" placeholder="ملاحظات الطبيب"></textarea>
      <button onclick="addVisit()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">تسجيل الزيارة</button>
      <div id="visitsList" class="mt-4 text-sm text-gray-700"></div>
    </div>

    <!-- تحويل لقسم آخر -->
    <div class="border rounded-xl p-4 bg-yellow-50">
      <h2 class="text-xl font-semibold mb-2">تحويل المريض</h2>
      <select id="transferDept" class="border rounded p-2 w-full mb-2" onchange="toggleTransferFields()">
        <option value="">اختر القسم</option>
        <option value="radiology">الأشعة</option>
        <option value="lab">المعمل</option>
        <option value="icu">العناية المركزة</option>
      </select>
      <div id="extraFields" class="space-y-2 hidden">
        <input id="transferType" placeholder="نوع الإجراء (مثلاً نوع الأشعة أو التحليل)" class="border rounded p-2 w-full" />
        <textarea id="transferNotes" class="border rounded p-2 w-full" placeholder="ملاحظات إضافية"></textarea>
      </div>
      <button onclick="addTransfer()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded mt-2">تحويل</button>
      <div id="transfersList" class="mt-4 text-sm text-gray-700"></div>
    </div>

  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");
    
    const firebaseConfig = {
      apiKey: "AIzaSyDq...",
      authDomain: "smart-hospital-life.firebaseapp.com",
      databaseURL: "https://smart-hospital-life-default-rtdb.firebaseio.com",
      projectId: "smart-hospital-life",
      storageBucket: "smart-hospital-life.appspot.com",
      messagingSenderId: "927436837793",
      appId: "1:927436837793:web:43cd4..."
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // تحميل بيانات المريض
    async function loadPatientData() {
      const snapshot = await db.ref("patients/emergency/" + patientId).get();
      if (!snapshot.exists()) {
        Swal.fire("خطأ", "لم يتم العثور على المريض", "error");
        return;
      }
      const p = snapshot.val();
      document.getElementById("patientInfo").innerHTML = `
        <div><strong>الاسم:</strong> ${p.name}</div>
        <div><strong>العمر:</strong> ${p.age}</div>
        <div><strong>الرقم القومي:</strong> ${p.nationalId}</div>
        <div><strong>رقم المريض:</strong> ${patientId}</div>
        <div><strong>تاريخ الدخول:</strong> ${p.admissionDate}</div>
        <div><strong>القسم:</strong> ${p.department}</div>
        <div><strong>الطبيب:</strong> ${p.doctor}</div>
      `;
    }

    // تسجيل زيارة
    async function addVisit() {
      const type = document.getElementById("visitType").value;
      const notes = document.getElementById("visitNotes").value;
      if (!type || !notes) return alert("أدخل جميع الحقول");
      await db.ref(`visits/${patientId}`).push({
        type,
        notes,
        time: new Date().toLocaleString()
      });
      Swal.fire("تم", "تم تسجيل الزيارة بنجاح", "success");
      loadVisits();
    }

    async function loadVisits() {
      const snapshot = await db.ref(`visits/${patientId}`).get();
      let html = "<h3 class='font-bold mb-2'>سجل الزيارات:</h3>";
      snapshot.forEach(child => {
        const v = child.val();
        html += `<div class="mb-1">🔹 <strong>${v.type}</strong>: ${v.notes} - <span class="text-gray-500">${v.time}</span></div>`;
      });
      document.getElementById("visitsList").innerHTML = html;
    }

    // تحويل المريض لقسم
    async function addTransfer() {
      const dept = document.getElementById("transferDept").value;
      const type = document.getElementById("transferType").value;
      const notes = document.getElementById("transferNotes").value;

      const snapshot = await db.ref("patients/emergency/" + patientId).get();
      const p = snapshot.val();

      // لو القسم المختار أشعة نروح نحفظه في جدول منفصل radiology_requests
      if (dept === "radiology") {
        await db.ref("radiology_requests").push({
          patientId,
          patientName: p.name || "غير معروف",
          age: p.age || "",
          doctor: p.doctor || "",
          department: p.department || "",
          type: type || "غير محدد",
          notes: notes || "",
          timestamp: Date.now(),
          status: "بانتظار التنفيذ"
        });
      }

      // نسجل التحويل العام في جدول التحويلات
      await db.ref(`transfers/${patientId}`).push({
        department: dept,
        type,
        notes,
        time: new Date().toLocaleString()
      });

      Swal.fire("تم التحويل", "تم تحويل المريض بنجاح", "success");
      loadTransfers();
    }

    async function loadTransfers() {
      const snapshot = await db.ref(`transfers/${patientId}`).get();
      let html = "<h3 class='font-bold mb-2'>سجل التحويلات:</h3>";
      snapshot.forEach(child => {
        const t = child.val();
        html += `<div class="mb-1">📤 <strong>${t.department}</strong> - ${t.type} (${t.notes}) - <span class="text-gray-500">${t.time}</span></div>`;
      });
      document.getElementById("transfersList").innerHTML = html;
    }

    function toggleTransferFields() {
      const dept = document.getElementById("transferDept").value;
      const extra = document.getElementById("extraFields");
      extra.classList.toggle("hidden", dept === "");
    }

    loadPatientData();
    loadVisits();
    loadTransfers();
  </script>

</body>
</html>
