<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>

<body class="bg-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-center">ملف المريض</h1>

    <div id="patientInfo" class="bg-white rounded-xl p-4 shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">المعلومات الأساسية</h2>
      <table class="table-auto w-full text-right">
        <tbody>
          <tr><td class="font-bold">الاسم:</td><td id="name"></td></tr>
          <tr><td class="font-bold">العمر:</td><td id="age"></td></tr>
          <tr><td class="font-bold">الرقم القومي:</td><td id="nationalId"></td></tr>
          <tr><td class="font-bold">ID:</td><td id="patientId"></td></tr>
          <tr><td class="font-bold">تاريخ الدخول:</td><td id="admissionDate"></td></tr>
          <tr><td class="font-bold">القسم الحالي:</td><td id="currentDepartment"></td></tr>
          <tr><td class="font-bold">الطبيب المعالج:</td><td id="doctor"></td></tr>
        </tbody>
      </table>
    </div>

    <div class="bg-white rounded-xl p-4 shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">طلب تحويل إلى قسم الأشعة</h2>
      <form id="radiologyForm" class="space-y-4">
        <div>
          <label class="block font-medium mb-1">نوع الأشعة</label>
          <select id="radiologyType" class="w-full border rounded p-2">
            <option value="">-- اختر نوع الأشعة --</option>
            <option>أشعة سينية (X-ray)</option>
            <option>أشعة مقطعية (CT Scan)</option>
            <option>أشعة رنين مغناطيسي (MRI)</option>
            <option>موجات فوق صوتية (Ultrasound)</option>
            <option>أشعة الصبغة</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">ملاحظات الطبيب</label>
          <textarea id="radiologyNotes" class="w-full border rounded p-2" rows="3"></textarea>
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">تحويل للأشعة</button>
      </form>
    </div>

    <div id="qrcode" class="text-center mt-10"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqX9aVnfw7m...",
      authDomain: "smart-hospital-life.firebaseapp.com",
      databaseURL: "https://smart-hospital-life-default-rtdb.firebaseio.com",
      projectId: "smart-hospital-life",
      storageBucket: "smart-hospital-life.appspot.com",
      messagingSenderId: "868064361595",
      appId: "1:868064361595:web:..."
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");
    if (patientId) {
      document.getElementById("patientId").innerText = patientId;
      QRCode.toCanvas(document.getElementById("qrcode"), patientId, err => {});

      db.ref("patients/" + patientId).once("value", snapshot => {
        const data = snapshot.val();
        if (data) {
          document.getElementById("name").innerText = data.name || "";
          document.getElementById("age").innerText = data.age || "";
          document.getElementById("nationalId").innerText = data.nationalId || "";
          document.getElementById("admissionDate").innerText = data.admissionDate || "";
          document.getElementById("currentDepartment").innerText = data.department || "";
          document.getElementById("doctor").innerText = data.doctor || "";
        }
      });
    }

    document.getElementById("radiologyForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const type = document.getElementById("radiologyType").value;
      const notes = document.getElementById("radiologyNotes").value;
      const now = new Date().toLocaleString();

      if (!type) {
        Swal.fire("تنبيه", "يرجى اختيار نوع الأشعة", "warning");
        return;
      }

      const request = {
        patientId: patientId,
        type: type,
        notes: notes,
        date: now,
        status: "بانتظار التأكيد",
        fromDoctor: document.getElementById("doctor").innerText || "--"
      };

      db.ref("radiologyRequests/").push(request).then(() => {
        Swal.fire("تم التحويل", "تم إرسال طلب الأشعة بنجاح", "success");
        document.getElementById("radiologyForm").reset();
      });
    });
  </script>
</body>

</html>
