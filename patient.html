<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام ملف المريض - مستشفى الحياة الذكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        body { 
            background-color: #f8fafc;
            color: #334155;
        }
        
        /* Professional Medical Theme Colors */
        :root {
            --primary: #0c4a6e;
            --primary-light: #0891b2;
            --secondary: #4f46e5;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --light: #f1f5f9;
            --dark: #0f172a;
            --accent: #667eea;
            --accent-light: #a78bfa;
        }
        
        /* Modern Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Status Badge Styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-critical {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }
        
        .status-stable {
            background-color: rgba(5, 150, 105, 0.1);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .status-improving {
            background-color: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        
        .status-deteriorating {
            background-color: rgba(217, 119, 6, 0.1);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }
        
        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0a3855;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
        }
        
        /* Form Styles */
        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Enhanced Checkup Form Styles */
        .checkup-form-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .checkup-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .checkup-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }
        
        .form-section {
            padding: 2.5rem;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--accent-light);
        }
        
        .section-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .section-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-group {
            margin-bottom: 2rem;
        }
        
        .form-label {
            display: block;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        
        .form-textarea, .form-select {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            background: white;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        /* Enhanced Medication Item Styles */
        .medication-item {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
        }
        
        .medication-item:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.1);
        }
        
        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .medication-title {
            font-weight: 800;
            color: var(--accent);
            font-size: 1.3rem;
        }
        
        .remove-medication {
            background: var(--danger);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .remove-medication:hover {
            background: #c53030;
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(229, 62, 62, 0.3);
        }
        
        .medication-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        /* Enhanced Medications Container */
        .medications-container {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            border-radius: 20px;
            padding: 2.5rem;
            border: 3px dashed #e2e8f0;
            margin-top: 2rem;
        }
        
        .medications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .medications-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        /* Enhanced Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #718096;
            background: white;
            border-radius: 15px;
            border: 2px dashed #e2e8f0;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--accent-light);
            margin-bottom: 1.5rem;
        }
        
        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        /* Enhanced Save Section */
        .save-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 3rem;
            border-radius: 0 0 16px 16px;
            margin-top: 0;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .save-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .save-info {
            color: white;
            flex: 1;
        }
        
        .save-info h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .save-info p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* Enhanced Save Button */
        .save-btn {
            background: linear-gradient(135deg, var(--success) 0%, #48bb78 100%);
            color: white;
            padding: 1.5rem 4rem;
            border-radius: 20px;
            font-weight: 900;
            font-size: 1.3rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 12px 24px rgba(56, 161, 105, 0.4);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .save-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.8s;
        }
        
        .save-btn:hover::before {
            left: 100%;
        }
        
        .save-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(56, 161, 105, 0.5);
        }
        
        .save-btn:active {
            transform: translateY(-2px);
        }
        
        .save-btn i {
            font-size: 2rem;
        }
        
        /* Enhanced Add Medication Button */
        .add-medication-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .add-medication-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
        }
        
        .add-medication-btn i {
            font-size: 1.2rem;
        }
        
        /* Template Selector */
        .template-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .template-option {
            padding: 0.5rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .template-option:hover {
            border-color: var(--primary-light);
        }
        
        .template-option.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Report Preview Styles */
        .medical-report {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .report-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .report-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        
        .report-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .report-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .report-section {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .report-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            color: #334155;
            font-size: 1rem;
        }
        
        .doctor-signature {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 2rem;
        }
        
        .signature-box {
            text-align: center;
            width: 200px;
        }
        
        .signature-line {
            border-bottom: 1px solid #334155;
            height: 40px;
            margin-bottom: 0.5rem;
        }
        
        .signature-text {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .qr-code {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .qr-label {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8rem;
            color: rgba(0, 0, 0, 0.05);
            font-weight: 800;
            z-index: 0;
            pointer-events: none;
        }
        
        .preview-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Success Animation */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        
        /* Required field indicator */
        .required::after {
            content: " *";
            color: var(--danger);
            font-weight: bold;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .modal-content {
                width: 98%;
                margin: 1rem;
                max-height: 98vh;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .section-header {
                margin-bottom: 1.5rem;
            }
            
            .section-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
            
            .save-section {
                padding: 2rem;
            }
            
            .save-content {
                flex-direction: column;
                text-align: center;
            }
            
            .save-btn {
                padding: 1.2rem 3rem;
                font-size: 1.1rem;
                width: 100%;
                justify-content: center;
            }
            
            .medication-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <div class="bg-white p-2 rounded-xl shadow-md">
                <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" class="w-14 h-14 rounded-full" alt="شعار مستشفى الحياة الذكية">
            </div>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">مستشفى الحياة الذكية</h1>
                <p class="text-gray-600">نظام إدارة ملفات المرضى</p>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> طباعة الملف
            </button>
            <button onclick="window.location.href='emergency.html'" class="btn btn-secondary">
                <i class="fas fa-ambulance"></i> الطوارئ
            </button>
            <button onclick="window.location.href='index.html'" class="btn btn-success">
                <i class="fas fa-home"></i> الرئيسية
            </button>
        </div>
    </div>
    <!-- Patient Info Card -->
    <div class="card mb-6">
        <div class="header flex justify-between items-center">
            <div>
                <h2 class="text-xl md:text-2xl font-bold">ملف المريض</h2>
                <p class="opacity-90">تفاصيل المريض وسجلاته الطبية</p>
            </div>
            <div id="patientStatus" class="status-badge"></div>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-user-circle text-blue-600"></i> المعلومات الأساسية
                    </h3>
                    <div class="bg-gray-50 p-5 rounded-lg">
                        <table class="table-auto w-full" id="infoTable"></table>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mt-5">
                        <button onclick="changePatientStatus()" class="btn btn-secondary">
                            <i class="fas fa-exchange-alt"></i> تغيير الحالة
                        </button>
                        <button onclick="openCheckupModal()" class="btn btn-primary">
                            <i class="fas fa-stethoscope"></i> كشف طبي جديد
                        </button>
                        <a href="#" id="monitorBtn" class="btn btn-success">
                            <i class="fas fa-heartbeat"></i> عرض المونيتور
                        </a>
                    </div>
                </div>
                
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-qrcode text-blue-600"></i> رمز الاستجابة السريع
                    </h3>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                        <canvas id="qrCode" class="w-40 h-40"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Enhanced Medical Checkup Modal -->
<div id="checkupModal" class="modal checkup-form-container">
    <div class="modal-content">
        <!-- Modal Header -->
        <div class="checkup-header">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-6 mb-4">
                            <div class="bg-white/20 p-4 rounded-2xl backdrop-blur-sm">
                                <i class="fas fa-stethoscope text-4xl"></i>
                            </div>
                            <div>
                                <h1 class="text-4xl font-black mb-2">كشف طبي جديد</h1>
                                <p class="text-purple-100 text-xl">تسجيل بيانات الكشف الطبي للمريض</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 text-purple-100 text-lg">
                            <i class="fas fa-user-md text-2xl"></i>
                            <span class="font-semibold">د. أحمد محمد</span>
                            <span class="text-2xl">•</span>
                            <span id="currentDate" class="font-medium"></span>
                        </div>
                    </div>
                    <button onclick="closeCheckupModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Template Selector -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-file-medical"></i>
                </div>
                <h2 class="section-title">اختر قالب الكشف</h2>
            </div>
            <div class="template-selector">
                <div class="template-option active" onclick="selectTemplate('general')">كشف عام</div>
                <div class="template-option" onclick="selectTemplate('pediatric')">كشف أطفال</div>
                <div class="template-option" onclick="selectTemplate('cardiac')">كشف قلب</div>
                <div class="template-option" onclick="selectTemplate('orthopedic')">كشف عظام</div>
                <div class="template-option" onclick="selectTemplate('dental')">كشف أسنان</div>
                <div class="template-option" onclick="selectTemplate('eye')">كشف عيون</div>
            </div>
        </div>
        
        <!-- Patient Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-user-circle"></i>
                </div>
                <h2 class="section-title">بيانات المريض</h2>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <label class="info-label">اسم المريض</label>
                    <input type="text" id="patientName" class="form-input" placeholder="أدخل اسم المريض">
                </div>
                <div class="info-item">
                    <label class="info-label">العمر</label>
                    <input type="text" id="patientAge" class="form-input" placeholder="أدخل العمر">
                </div>
                <div class="info-item">
                    <label class="info-label">الجنس</label>
                    <select id="patientGender" class="form-input">
                        <option value="">اختر</option>
                        <option value="ذكر">ذكر</option>
                        <option value="أنثى">أنثى</option>
                    </select>
                </div>
                <div class="info-item">
                    <label class="info-label">تاريخ الميلاد</label>
                    <input type="date" id="patientDOB" class="form-input">
                </div>
                <div class="info-item">
                    <label class="info-label">رقم الهاتف</label>
                    <input type="tel" id="patientPhone" class="form-input" placeholder="أدخل رقم الهاتف">
                </div>
                <div class="info-item">
                    <label class="info-label">الرقم القومي</label>
                    <input type="text" id="patientNID" class="form-input" placeholder="أدخل الرقم القومي">
                </div>
            </div>
        </div>
        
        <!-- Checkup Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <h2 class="section-title">بيانات الكشف</h2>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <label class="info-label">تاريخ الكشف</label>
                    <input type="date" id="checkupDate" class="form-input">
                </div>
                <div class="info-item">
                    <label class="info-label">نوع الكشف</label>
                    <select id="checkupType" class="form-input">
                        <option value="">اختر</option>
                        <option value="كشف أولي">كشف أولي</option>
                        <option value="متابعة">متابعة</option>
                        <option value="استشارة">استشارة</option>
                        <option value="كشف دوري">كشف دوري</option>
                        <option value="طوارئ">طوارئ</option>
                    </select>
                </div>
                <div class="info-item">
                    <label class="info-label">الطبيب المعالج</label>
                    <input type="text" id="doctorName" class="form-input" placeholder="أدخل اسم الطبيب">
                </div>
            </div>
        </div>
        
        <!-- Symptoms Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-notes-medical"></i>
                </div>
                <h2 class="section-title">الأعراض</h2>
            </div>
            <div class="form-group">
                <label class="form-label required">الأعراض التي يشتكي منها المريض</label>
                <textarea id="symptoms" class="form-textarea" placeholder="اكتب الأعراض التي يشتكي منها المريض بالتفصيل..." required></textarea>
            </div>
        </div>
        
        <!-- Diagnosis Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-diagnoses"></i>
                </div>
                <h2 class="section-title">التشخيص</h2>
            </div>
            <div class="form-group">
                <label class="form-label required">التشخيص الطبي</label>
                <textarea id="diagnosis" class="form-textarea" placeholder="اكتب التشخيص الطبي للحالة..." required></textarea>
            </div>
        </div>
        
        <!-- Treatment Plan Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h2 class="section-title">الخطة العلاجية</h2>
            </div>
            <div class="form-group">
                <label class="form-label">الخطة العلاجية العامة</label>
                <textarea id="treatmentPlan" class="form-textarea" placeholder="الخطة العلاجية العامة والتوصيات..." rows="4"></textarea>
            </div>
            
            <!-- Enhanced Medications Section -->
            <div class="medications-container">
                <div class="medications-header">
                    <h3 class="medications-title">
                        <i class="fas fa-prescription-bottle text-green-600"></i>
                        الأدوية الموصوفة
                    </h3>
                    <button type="button" onclick="addMedication()" class="add-medication-btn">
                        <i class="fas fa-plus-circle"></i>
                        إضافة دواء
                    </button>
                </div>
                
                <div id="medicationsList">
                    <!-- Medications will be added dynamically -->
                </div>
                
                <div id="noMedications" class="empty-state">
                    <i class="fas fa-pills"></i>
                    <p class="font-semibold text-lg">لا توجد أدوية مضافة</p>
                    <p class="text-base">اضغط على زر "إضافة دواء" لبدء إضافة الأدوية</p>
                </div>
            </div>
        </div>
        
        <!-- Additional Notes Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-clipboard"></i>
                </div>
                <h2 class="section-title">ملاحظات إضافية</h2>
            </div>
            <div class="form-group">
                <label class="form-label">ملاحظات إضافية</label>
                <textarea id="additionalNotes" class="form-textarea" placeholder="أدخل أي ملاحظات إضافية"></textarea>
            </div>
        </div>
        
        <!-- Report Preview Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-eye"></i>
                </div>
                <h2 class="section-title">معاينة التقرير</h2>
            </div>
            <div class="preview-actions mb-4">
                <button onclick="generateReport()" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> تحديث المعاينة
                </button>
                <button onclick="downloadPDF()" class="btn btn-success">
                    <i class="fas fa-download"></i> تحميل PDF
                </button>
                <button onclick="window.print()" class="btn btn-secondary">
                    <i class="fas fa-print"></i> طباعة
                </button>
            </div>
            
            <div id="reportPreview" class="medical-report print-break">
                <!-- Watermark -->
                <div class="watermark">مستشفى الحياة الذكية</div>
                
                <!-- Report Header -->
                <div class="report-header">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="report-title">تقرير كشف طبي</h1>
                            <p class="report-subtitle">مستشفى الحياة الذكية</p>
                        </div>
                        <div class="qr-code-container">
                            <div id="qrCodeReport" class="qr-code"></div>
                            <div class="qr-label">رمز المريض</div>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Information -->
                <div class="report-section">
                    <h2 class="section-title">
                        <i class="fas fa-user-circle"></i> بيانات المريض
                    </h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">الاسم</div>
                            <div class="info-value" id="previewPatientName">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">العمر</div>
                            <div class="info-value" id="previewPatientAge">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">الجنس</div>
                            <div class="info-value" id="previewPatientGender">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">تاريخ الميلاد</div>
                            <div class="info-value" id="previewPatientDOB">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">رقم الهاتف</div>
                            <div class="info-value" id="previewPatientPhone">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">الرقم القومي</div>
                            <div class="info-value" id="previewPatientNID">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Checkup Information -->
                <div class="report-section">
                    <h2 class="section-title">
                        <i class="fas fa-stethoscope"></i> بيانات الكشف
                    </h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">تاريخ الكشف</div>
                            <div class="info-value" id="previewCheckupDate">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">نوع الكشف</div>
                            <div class="info-value" id="previewCheckupType">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">الطبيب المعالج</div>
                            <div class="info-value" id="previewDoctorName">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Symptoms -->
                <div class="report-section">
                    <h2 class="section-title">
                        <i class="fas fa-notes-medical"></i> الأعراض
                    </h2>
                    <div id="previewSymptoms" class="info-value">-</div>
                </div>
                
                <!-- Diagnosis -->
                <div class="report-section">
                    <h2 class="section-title">
                        <i class="fas fa-diagnoses"></i> التشخيص
                    </h2>
                    <div id="previewDiagnosis" class="info-value">-</div>
                </div>
                
                <!-- Treatment Plan -->
                <div class="report-section">
                    <h2 class="section-title">
                        <i class="fas fa-heartbeat"></i> الخطة العلاجية
                    </h2>
                    <div id="previewTreatmentPlan" class="info-value">-</div>
                </div>
                
                <!-- Medications -->
                <div class="report-section">
                    <h2 class="section-title">
                        <i class="fas fa-pills"></i> الأدوية الموصوفة
                    </h2>
                    <div id="previewMedications">
                        <div class="info-value">لا توجد أدوية موصوفة</div>
                    </div>
                </div>
                
                <!-- Additional Notes -->
                <div class="report-section">
                    <h2 class="section-title">
                        <i class="fas fa-clipboard"></i> ملاحظات إضافية
                    </h2>
                    <div id="previewAdditionalNotes" class="info-value">-</div>
                </div>
                
                <!-- Doctor Signature -->
                <div class="report-section">
                    <div class="doctor-signature">
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-text">توقيع الطبيب</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-text">توقيع المريض</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-text">التاريخ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Save Section -->
        <div class="save-section">
            <div class="save-content">
                <div class="save-info">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        تأكد من ملء جميع الحقول المطلوبة
                    </h3>
                    <p>سيتم حفظ الكشف الطبي في ملف المريض بعد التأكد من صحة البيانات</p>
                </div>
                <button onclick="saveVisit()" class="save-btn">
                    <i class="fas fa-save"></i>
                    <span>حفظ الكشف الطبي</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Get patient ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");
    
    // Set current date in modal
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Set current date as default for checkup
    document.getElementById('checkupDate').valueAsDate = new Date();
    
    // Medication counter
    let medicationCounter = 0;
    
    // Helper function to validate patient ID
    function validatePatientId() {
        if (!patientId) {
            Swal.fire("خطأ", "معرف المريض غير موجود في الرابط", "error");
            return false;
        }
        return true;
    }
    
    // Helper function to show loading message
    function showLoading(message = "جاري التحميل...") {
        Swal.fire({
            title: message,
            didOpen: () => { Swal.showLoading(); }
        });
    }
    
    // Helper function to show result message
    function showResult(title, message, icon = "success") {
        Swal.fire({
            title,
            text: message,
            icon,
            timer: 1500,
            showConfirmButton: false
        });
    }
    
    // Function to update patient status UI
    function updateStatusUI(status) {
        const statusEl = document.getElementById("patientStatus");
        
        const statusConfig = {
            critical: { 
                text: 'حرجة',
                class: 'status-critical',
                icon: 'fa-exclamation-triangle'
            },
            stable: { 
                text: 'مستقرة',
                class: 'status-stable',
                icon: 'fa-check-circle'
            },
            improving: { 
                text: 'في تحسن',
                class: 'status-improving',
                icon: 'fa-arrow-up'
            },
            deteriorating: { 
                text: 'في تدهور',
                class: 'status-deteriorating',
                icon: 'fa-arrow-down'
            }
        };
        
        if (statusConfig[status]) {
            statusEl.className = `status-badge ${statusConfig[status].class}`;
            statusEl.innerHTML = `<i class="fas ${statusConfig[status].icon} ml-2"></i>${statusConfig[status].text}`;
        }
    }
    
    // Function to change patient status
    window.changePatientStatus = async function() {
        if (!validatePatientId()) return;
        
        const { value: newStatus } = await Swal.fire({
            title: 'تغيير حالة المريض',
            input: 'select',
            inputOptions: {
                'critical': 'حرجة',
                'stable': 'مستقرة',
                'improving': 'في تحسن',
                'deteriorating': 'في تدهور'
            },
            inputPlaceholder: 'اختر الحالة الجديدة',
            showCancelButton: true,
            confirmButtonText: 'حفظ',
            cancelButtonText: 'إلغاء',
            inputValidator: (value) => {
                if (!value) return 'يرجى اختيار الحالة';
            }
        });
        
        if (newStatus) {
            try {
                showLoading("جاري تحديث الحالة...");
                // In a real application, you would update the database here
                // await update(ref(db, `patients/emergency/${patientId}`), { status: newStatus });
                updateStatusUI(newStatus);
                showResult("تم!", "تم تغيير حالة المريض بنجاح");
            } catch (error) {
                Swal.fire("خطأ", "فشل تحديث الحالة: " + error.message, "error");
            }
        }
    };
    
    // Load patient data
    async function loadPatientData() {
        if (!validatePatientId()) return;
        
        const infoTable = document.getElementById("infoTable");
        const qrCanvas = document.getElementById("qrCode");
        
        try {
            // In a real application, you would fetch data from Firebase
            // const snapshot = await get(ref(db, `patients/emergency/${patientId}`));
            
            // Mock data for demonstration
            const patient = {
                name: "أحمد محمد علي",
                age: "35 سنة",
                nid: "29501011234567",
                timestamp: new Date().toISOString(),
                department: "القلب",
                doctors: "د. محمد أحمد",
                serviceType: "متابعة",
                status: "stable"
            };
            
            infoTable.innerHTML = `
                <tr><td class="py-2 px-3 font-semibold text-gray-700 w-1/3">الاسم:</td><td class="py-2 px-3">${patient.name || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">العمر:</td><td class="py-2 px-3">${patient.age || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الرقم القومي:</td><td class="py-2 px-3">${patient.nid || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">ID:</td><td class="py-2 px-3 font-mono">${patientId}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">تاريخ الدخول:</td><td class="py-2 px-3">${patient.timestamp ? new Date(patient.timestamp).toLocaleString('ar-EG') : '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">القسم الحالي:</td><td class="py-2 px-3">${patient.department || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الطبيب المعالج:</td><td class="py-2 px-3">${patient.doctors || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">نوع الخدمة:</td><td class="py-2 px-3" id="serviceType">${patient.serviceType || 'غير محدد'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الحالة:</td><td class="py-2 px-3" id="patientStatusInTable">${patient.status || 'غير محدد'}</td></tr>
            `;
            
            updateStatusUI(patient.status || "stable");
            
            // Generate QR code
            QRCode.toCanvas(qrCanvas, patientId, function (error) {
                if (error) console.error(error);
            });
            
            // Pre-fill patient data in the checkup modal
            document.getElementById('patientName').value = patient.name || '';
            document.getElementById('patientAge').value = patient.age || '';
            document.getElementById('patientNID').value = patient.nid || '';
        } catch (error) {
            Swal.fire("خطأ", "فشل تحميل بيانات المريض: " + error.message, "error");
        }
    }
    
    // Open medical checkup modal
    window.openCheckupModal = function() {
        if (!validatePatientId()) return;
        
        // Show modal with animation
        const modal = document.getElementById('checkupModal');
        modal.classList.add('active');
        
        // Add entrance animations
        const sections = modal.querySelectorAll('.form-section');
        sections.forEach((section, index) => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(30px)';
            
            setTimeout(() => {
                section.style.transition = 'all 0.6s ease';
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, index * 150);
        });
        
        // Generate initial report preview
        generateReport();
    };
    
    // Close medical checkup modal
    window.closeCheckupModal = function() {
        const modal = document.getElementById('checkupModal');
        modal.classList.remove('active');
    };
    
    // Select template
    window.selectTemplate = function(templateType) {
        // Update active template
        document.querySelectorAll('.template-option').forEach(option => {
            option.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update form based on template type
        switch(templateType) {
            case 'pediatric':
                document.getElementById('checkupType').value = 'كشف أطفال';
                break;
            case 'cardiac':
                document.getElementById('checkupType').value = 'كشف قلب';
                break;
            case 'orthopedic':
                document.getElementById('checkupType').value = 'كشف عظام';
                break;
            case 'dental':
                document.getElementById('checkupType').value = 'كشف أسنان';
                break;
            case 'eye':
                document.getElementById('checkupType').value = 'كشف عيون';
                break;
            default:
                document.getElementById('checkupType').value = 'كشف عام';
        }
        
        // Update report preview
        generateReport();
    };
    
    // Function to add a new medication
    window.addMedication = function() {
        const medicationsList = document.getElementById("medicationsList");
        const noMedications = document.getElementById("noMedications");
        
        // Hide "no medications" message
        noMedications.style.display = 'none';
        
        medicationCounter++;
        const medicationId = `medication-${medicationCounter}`;
        
        const medicationItem = document.createElement('div');
        medicationItem.className = 'medication-item';
        medicationItem.id = medicationId;
        
        medicationItem.innerHTML = `
            <div class="medication-header">
                <h4 class="medication-title">الدواء #${medicationsList.children.length + 1}</h4>
                <button type="button" onclick="removeMedication('${medicationId}')" class="remove-medication">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="medication-grid">
                <div class="form-group">
                    <label class="form-label required">اسم الدواء</label>
                    <input type="text" class="medication-name form-input" placeholder="اسم الدواء" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">الجرعة</label>
                    <input type="text" class="medication-dosage form-input" placeholder="مثال: 500 مجم" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">المدة</label>
                    <input type="text" class="medication-duration form-input" placeholder="مثال: 7 أيام" required>
                </div>
                <div class="form-group">
                    <label class="form-label">نوع التأمين</label>
                    <select class="medication-insurance form-select">
                        <option value="">اختر نوع التأمين</option>
                        <option value="تأمين أساسي">تأمين أساسي</option>
                        <option value="تأمين تكميلي">تأمين تكميلي</option>
                        <option value="خاص">خاص</option>
                        <option value="غير مؤمن">غير مؤمن</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">عدد الجرعات</label>
                    <input type="number" class="medication-doses form-input" placeholder="مثال: 3" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">تعليمات الإعطاء</label>
                    <input type="text" class="medication-instructions form-input" placeholder="مثال: بعد الأكل">
                </div>
            </div>
        `;
        
        medicationsList.appendChild(medicationItem);
        
        // Add animation
        medicationItem.style.opacity = '0';
        medicationItem.style.transform = 'translateY(30px)';
        setTimeout(() => {
            medicationItem.style.transition = 'all 0.5s ease';
            medicationItem.style.opacity = '1';
            medicationItem.style.transform = 'translateY(0)';
        }, 10);
        
        // Add event listeners to update preview on change
        const inputs = medicationItem.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', generateReport);
            input.addEventListener('change', generateReport);
        });
    };
    
    // Function to remove a medication
    window.removeMedication = function(medicationId) {
        const medicationItem = document.getElementById(`medication-${medicationId}`);
        if (medicationItem) {
            medicationItem.style.transition = 'all 0.3s ease';
            medicationItem.style.opacity = '0';
            medicationItem.style.transform = 'translateX(-30px)';
            
            setTimeout(() => {
                medicationItem.remove();
                
                // Check if no medications left
                const medicationsList = document.getElementById('medicationsList');
                if (medicationsList.children.length === 0) {
                    document.getElementById('noMedications').style.display = 'block';
                }
                
                // Update preview
                generateReport();
            }, 300);
        }
    };
    
    // Generate report preview
    window.generateReport = function() {
        // Get form values
        const patientName = document.getElementById('patientName').value || '-';
        const patientAge = document.getElementById('patientAge').value || '-';
        const patientGender = document.getElementById('patientGender').value || '-';
        const patientDOB = document.getElementById('patientDOB').value || '-';
        const patientPhone = document.getElementById('patientPhone').value || '-';
        const patientNID = document.getElementById('patientNID').value || '-';
        
        const checkupDate = document.getElementById('checkupDate').value || '-';
        const checkupType = document.getElementById('checkupType').value || '-';
        const doctorName = document.getElementById('doctorName').value || 'د. أحمد محمد';
        
        const symptoms = document.getElementById('symptoms').value || '-';
        const diagnosis = document.getElementById('diagnosis').value || '-';
        const treatmentPlan = document.getElementById('treatmentPlan').value || '-';
        const additionalNotes = document.getElementById('additionalNotes').value || '-';
        
        // Update preview
        document.getElementById('previewPatientName').textContent = patientName;
        document.getElementById('previewPatientAge').textContent = patientAge;
        document.getElementById('previewPatientGender').textContent = patientGender;
        document.getElementById('previewPatientDOB').textContent = patientDOB;
        document.getElementById('previewPatientPhone').textContent = patientPhone;
        document.getElementById('previewPatientNID').textContent = patientNID;
        
        document.getElementById('previewCheckupDate').textContent = checkupDate;
        document.getElementById('previewCheckupType').textContent = checkupType;
        document.getElementById('previewDoctorName').textContent = doctorName;
        
        document.getElementById('previewSymptoms').textContent = symptoms;
        document.getElementById('previewDiagnosis').textContent = diagnosis;
        document.getElementById('previewTreatmentPlan').textContent = treatmentPlan;
        document.getElementById('previewAdditionalNotes').textContent = additionalNotes;
        
        // Update medications
        const medicationsList = document.getElementById('medicationsList');
        const medications = medicationsList.querySelectorAll('.medication-item');
        const previewMedications = document.getElementById('previewMedications');
        
        if (medications.length > 0) {
            let medicationsHTML = '';
            medications.forEach((medication, index) => {
                const medicationId = medication.id;
                const name = medication.querySelector('.medication-name').value || '-';
                const dosage = medication.querySelector('.medication-dosage').value || '-';
                const duration = medication.querySelector('.medication-duration').value || '-';
                const instructions = medication.querySelector('.medication-instructions').value || '-';
                
                medicationsHTML += `
                    <div class="medication-item">
                        <div class="medication-header">
                            <div class="medication-name">${index + 1}. ${name}</div>
                        </div>
                        <div class="medication-details">
                            <div class="info-item">
                                <div class="info-label">الجرعة</div>
                                <div class="info-value">${dosage}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">المدة</div>
                                <div class="info-value">${duration}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">التعليمات</div>
                                <div class="info-value">${instructions}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            previewMedications.innerHTML = medicationsHTML;
        } else {
            previewMedications.innerHTML = '<div class="info-value">لا توجد أدوية موصوفة</div>';
        }
        
        // Generate QR code
        const qrCodeContainer = document.getElementById('qrCodeReport');
        qrCodeContainer.innerHTML = '';
        QRCode.toCanvas(qrCodeContainer, patientNID, function (error) {
            if (error) console.error(error);
        });
    };
    
    // Download PDF
    window.downloadPDF = function() {
        const element = document.getElementById('reportPreview');
        const opt = {
            margin: 10,
            filename: `تقرير_كشف_طبي_${document.getElementById('patientName').value || 'غير_محدد'}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        html2pdf().set(opt).from(element).save();
    };
    
    // Save medical checkup data
    window.saveVisit = async function() {
        if (!validatePatientId()) return;
        
        // Collect form data
        const patientName = document.getElementById('patientName').value;
        const patientAge = document.getElementById('patientAge').value;
        const patientGender = document.getElementById('patientGender').value;
        const patientDOB = document.getElementById('patientDOB').value;
        const patientPhone = document.getElementById('patientPhone').value;
        const patientNID = document.getElementById('patientNID').value;
        
        const checkupDate = document.getElementById('checkupDate').value;
        const checkupType = document.getElementById('checkupType').value;
        const doctorName = document.getElementById('doctorName').value || 'د. أحمد محمد';
        
        const symptoms = document.getElementById('symptoms').value;
        const diagnosis = document.getElementById('diagnosis').value;
        const treatmentPlan = document.getElementById('treatmentPlan').value;
        const additionalNotes = document.getElementById('additionalNotes').value;
        
        // Validate required fields
        if (!symptoms || !diagnosis) {
            Swal.fire({
                title: 'حقول مطلوبة',
                text: 'يرجى ملء الحقول المطلوبة (الأعراض، التشخيص)',
                icon: 'warning',
                confirmButtonText: 'موافق'
            });
            return;
        }
        
        // Collect medications data
        const medications = [];
        const medicationItems = document.querySelectorAll('#medicationsList > div');
        
        medicationItems.forEach(item => {
            const name = item.querySelector('.medication-name').value.trim();
            const dosage = item.querySelector('.medication-dosage').value.trim();
            const duration = item.querySelector('.medication-duration').value.trim();
            const insurance = item.querySelector('.medication-insurance').value;
            const doses = item.querySelector('.medication-doses').value;
            const instructions = item.querySelector('.medication-instructions').value.trim();
            
            if (name && dosage && duration) {
                medications.push({
                    name,
                    dosage,
                    duration,
                    insurance: insurance || "غير محدد",
                    doses: doses || null,
                    instructions: instructions || "حسب إرشادات الطبيب"
                });
            }
        });
        
        try {
            // Show loading with custom styling
            Swal.fire({
                title: 'جاري حفظ الكشف الطبي...',
                html: '<div class="loading"></div>',
                didOpen: () => { Swal.showLoading(); },
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            
            // Prepare checkup data
            const checkupData = {
                patientName,
                patientAge,
                patientGender,
                patientDOB,
                patientPhone,
                patientNID,
                checkupDate,
                checkupType,
                doctorName,
                symptoms,
                diagnosis,
                treatmentPlan,
                additionalNotes,
                medications,
                doctorId: "د. أحمد محمد",
                date: new Date().toISOString(),
                status: "مكتمل"
            };
            
            // In a real application, you would save data to Firebase
            // const newCheckupRef = await push(ref(db, `patients/emergency/${patientId}/checkups`), checkupData);
            // checkupData.id = newCheckupRef.key;
            
            // Update patient status
            // await update(ref(db, `patients/emergency/${patientId}`), {
            //     lastCheckup: new Date().toISOString(),
            //     serviceType: checkupType,
            //     lastCheckupBy: "د. أحمد محمد"
            // });
            
            // Show success message
            Swal.fire({
                title: 'تم الحفظ بنجاح!',
                text: 'تم حفظ الكشف الطبي في ملف المريض',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            // Add success animation to save button
            const saveBtn = document.querySelector('.save-btn');
            saveBtn.classList.add('success-animation');
            
            // Close modal
            setTimeout(() => {
                closeCheckupModal();
            }, 1500);
            
        } catch (error) {
            console.error('Error saving checkup:', error);
            Swal.fire("خطأ", "فشل حفظ الكشف: " + error.message, "error");
        }
    };
    
    // Add event listeners to update preview on change
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners to all form inputs to update preview
        const formInputs = document.querySelectorAll('#checkupModal input, #checkupModal select, #checkupModal textarea');
        formInputs.forEach(input => {
            input.addEventListener('input', generateReport);
            input.addEventListener('change', generateReport);
        });
    });
    
    // Load data when page opens
    if (patientId) {
        console.log("Page loaded with patient ID:", patientId);
        loadPatientData();
    } else {
        console.error("No patient ID found in URL");
        Swal.fire("خطأ", "معرف المريض غير موجود في الرابط", "error");
    }
    
    // Link monitor button
    const monitorBtn = document.getElementById('monitorBtn');
    if (monitorBtn && patientId) {
        monitorBtn.href = `monitor.html?id=${patientId}`;
    }
</script>
</body>
</html>
