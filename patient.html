<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <!-- Fonts and Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Tajawal', 'sans-serif'],
          },
          colors: {
            primary: '#1e40af',
            secondary: '#7c3aed',
            accent: '#10b981',
            danger: '#dc2626',
          },
        },
      },
    };
  </script>
</head>
<body class="bg-gradient-to-b from-blue-50 to-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- معلومات المريض -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
      <div class="bg-gradient-to-r from-primary to-blue-700 p-6 text-white">
        <h2 class="text-2xl font-bold">ملف المريض</h2>
      </div>
      <div class="p-6">
        <table id="infoTable" class="table-auto w-full text-right"></table>
      </div>
    </div>

    <!-- قسم الأشعة -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
      <div class="bg-gradient-to-r from-secondary to-purple-700 p-6 text-white">
        <h2 class="text-2xl font-bold">الأشعة</h2>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block mb-1">نوع الأشعة:</label>
          <select id="radiologyType" class="w-full border rounded p-2">
            <option>أشعة سينية (X-Ray)</option>
            <option>أشعة مقطعية (CT)</option>
            <option>رنين مغناطيسي (MRI)</option>
            <option>موجات فوق صوتية (Ultrasound)</option>
            <option>تصوير الثدي (Mammography)</option>
            <option>أشعة أخرى</option>
          </select>
        </div>
        <div>
          <label class="block mb-1">ملاحظات الطبيب:</label>
          <textarea id="radiologyNotes" class="w-full border rounded p-2" rows="3"></textarea>
        </div>
        <button onclick="addRadiologyRequest()" class="bg-secondary hover:bg-purple-700 text-white px-4 py-2 rounded-lg w-full">
          <i class="fas fa-radiation mr-2"></i> تحويل لقسم الأشعة
        </button>

        <div class="pt-6">
          <h3 class="text-xl font-semibold mb-2 text-primary">الطلبات السابقة</h3>
          <ul id="radiologyList" class="space-y-3"></ul>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
      authDomain: "hospital-project-e4b59.firebaseapp.com",
      databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hospital-project-e4b59",
      storageBucket: "hospital-project-e4b59.appspot.com",
      messagingSenderId: "974610606258",
      appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const patientId = new URLSearchParams(window.location.search).get("id");

    const infoTable = document.getElementById("infoTable");
    const radiologyList = document.getElementById("radiologyList");

    async function loadPatientInfo() {
      const refInfo = ref(db, patients/emergency/${patientId});
      const snap = await get(refInfo);
      if (!snap.exists()) {
        infoTable.innerHTML = '<tr><td>لم يتم العثور على بيانات</td></tr>';
        return;
      }
      const p = snap.val();
      infoTable.innerHTML = 
        <tr><td class="py-1">الاسم:</td><td class="py-1">${p.name}</td></tr>
        <tr><td class="py-1">العمر:</td><td class="py-1">${p.age}</td></tr>
        <tr><td class="py-1">القسم الحالي:</td><td class="py-1">${p.department}</td></tr>
        <tr><td class="py-1">الطبيب:</td><td class="py-1">${p.doctor}</td></tr>
      ;
    }

    async function loadRadiologyRequests() {
      const refRad = ref(db, radiology_requests/${patientId});
      const snap = await get(refRad);
      if (!snap.exists()) return;
      const data = snap.val();
      radiologyList.innerHTML = Object.values(data).map(item => 
        <li class="bg-gray-100 rounded p-3">
          <div><strong>النوع:</strong> ${item.type}</div>
          <div><strong>ملاحظات:</strong> ${item.notes}</div>
          <div class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString('ar-EG')}</div>
        </li>
      ).join('');
    }

    window.addRadiologyRequest = async () => {
      const type = document.getElementById("radiologyType").value;
      const notes = document.getElementById("radiologyNotes").value;
      const refRad = ref(db, radiology_requests/${patientId});
      await push(refRad, {
        type,
        notes,
        timestamp: Date.now(),
        status: "بانتظار التنفيذ"
      });
      alert("تم تحويل المريض للأشعة بنجاح.");
      loadRadiologyRequests();
    };

    document.addEventListener("DOMContentLoaded", () => {
      loadPatientInfo();
      loadRadiologyRequests();
    });
  </script>
</body>
</html>
