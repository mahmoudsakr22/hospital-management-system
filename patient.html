<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    .header-image {
      max-height: 120px;
      object-fit: cover;
      border-radius: 1rem;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
      authDomain: "hospital-project-e4b59.firebaseapp.com",
      databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hospital-project-e4b59",
      storageBucket: "hospital-project-e4b59.appspot.com",
      messagingSenderId: "974610606258",
      appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('id');
    const baseRef = ref(db, 'patients/emergency/' + patientId);

    document.addEventListener("DOMContentLoaded", async () => {
      const infoTable = document.getElementById("infoTable");
      const visitsList = document.getElementById("visitsList");
      const transfersList = document.getElementById("transfersList");
      const statusDiv = document.getElementById("status");
      const medsList = document.getElementById("medications");

      const snapshot = await get(baseRef);
      if (snapshot.exists()) {
        const patient = snapshot.val();
        infoTable.innerHTML = `
          <tr><td>الاسم:</td><td>${patient.name}</td></tr>
          <tr><td>العمر:</td><td>${patient.age}</td></tr>
          <tr><td>الرقم القومي:</td><td>${patient.nid}</td></tr>
          <tr><td>ID:</td><td>${patientId}</td></tr>
          <tr><td>تاريخ الدخول:</td><td>${new Date(patient.timestamp).toLocaleString('ar-EG')}</td></tr>
          <tr><td>القسم الحالي:</td><td>${patient.department}</td></tr>
          <tr><td>الطبيب المعالج:</td><td>${patient.doctor || 'غير محدد'}</td></tr>
        `;
        statusDiv.textContent = patient.status || "غير متوفر";
        QRCode.toCanvas(document.getElementById('qrCode'), patientId);
      } else {
        infoTable.innerHTML = "<tr><td colspan='2'>لم يتم العثور على المريض.</td></tr>";
      }

      onValue(ref(db, `patients/emergency/${patientId}/visits`), (snap) => {
        visitsList.innerHTML = "";
        snap.forEach((child) => {
          const visit = child.val();
          visitsList.innerHTML += `<li><strong>${visit.type}</strong> - ${visit.notes} (${new Date(visit.timestamp).toLocaleString('ar-EG')})</li>`;
        });
      });

      onValue(ref(db, `patients/emergency/${patientId}/transfers`), (snap) => {
        transfersList.innerHTML = "";
        snap.forEach((child) => {
          const t = child.val();
          transfersList.innerHTML += `<li>${t.department} - ${t.notes} (${new Date(t.timestamp).toLocaleString('ar-EG')})</li>`;
        });
      });

      onValue(ref(db, `patients/emergency/${patientId}/medications`), (snap) => {
        medsList.innerHTML = "";
        snap.forEach((child) => {
          const med = child.val();
          medsList.innerHTML += `<li>${med.name} - ${med.dose}</li>`;
        });
      });
    });

    window.addVisit = async () => {
      const type = document.getElementById("visitType").value;
      const notes = document.getElementById("visitNotes").value;
      await push(ref(db, `patients/emergency/${patientId}/visits`), {
        type,
        notes,
        timestamp: Date.now()
      });
      document.getElementById("visitNotes").value = "";
    };

    window.addTransfer = async () => {
      const dept = document.getElementById("transferDept").value;
      const notes = document.getElementById("transferNotes").value;
      await push(ref(db, `patients/emergency/${patientId}/transfers`), {
        department: dept,
        notes,
        timestamp: Date.now()
      });
      document.getElementById("transferNotes").value = "";
    };

    window.downloadPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("تقرير المريض - مستشفى الحياة الذكية", 10, 10);
      doc.text("ID: " + patientId, 10, 20);
      doc.save("تقرير_المريض.pdf");
    };

    window.goBack = () => {
      window.location.href = "emergency.html";
    };
  </script>
</head>

<body class="bg-gray-100 p-6">
  <!-- رأس الصفحة -->
  <div class="max-w-5xl mx-auto bg-white p-4 rounded shadow mb-6">
    <div class="flex flex-col items-center text-center">
      <img src="https://img.freepik.com/free-vector/hospital-building-concept-illustration_114360-8946.jpg?w=740&t=st=1710663063~exp=1710663663~hmac=b9121ec3989f3c4589c16be557c5dfb5fd8e51bdbbc3d585ef29e6d3a38e00df" alt="صورة المستشفى" class="header-image mb-4">
      <h1 class="text-3xl font-bold text-blue-700">مستشفى الحياة الذكية</h1>
      <p class="text-gray-600 mt-2">نظام متكامل لإدارة ملفات المرضى وحالتهم الطبية لحظة بلحظة</p>
    </div>
  </div>

  <!-- محتوى الملف -->
  <div class="max-w-5xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold text-center mb-4">ملف المريض</h2>

    <h3 class="text-xl font-semibold mt-6 mb-2">المعلومات الأساسية</h3>
    <table class="table-auto w-full border mb-4" id="infoTable"></table>

    <h3 class="text-xl font-semibold mt-6 mb-2">سجل الزيارات</h3>
    <ul class="list-disc pl-6 mb-4" id="visitsList"></ul>
    <div class="mb-4">
      <select id="visitType" class="border p-2 rounded">
        <option>كشف طبي</option>
        <option>متابعة</option>
        <option>استشارة</option>
      </select>
      <input type="text" id="visitNotes" placeholder="ملاحظات" class="border p-2 rounded w-1/2">
      <button onclick="addVisit()" class="bg-blue-600 text-white px-4 py-2 rounded">تسجيل الزيارة</button>
    </div>

    <h3 class="text-xl font-semibold mt-6 mb-2">التحويلات</h3>
    <ul class="list-disc pl-6 mb-4" id="transfersList"></ul>
    <div class="mb-4">
      <select id="transferDept" class="border p-2 rounded">
        <option>الأشعة</option>
        <option>التحاليل</option>
        <option>العناية المركزة</option>
        <option>العمليات</option>
      </select>
      <input type="text" id="transferNotes" placeholder="ملاحظات" class="border p-2 rounded w-1/2">
      <button onclick="addTransfer()" class="bg-purple-600 text-white px-4 py-2 rounded">تسجيل التحويل</button>
    </div>

    <h3 class="text-xl font-semibold mt-6 mb-2">الأدوية والعلاج</h3>
    <ul class="list-disc pl-6 mb-4" id="medications"></ul>

    <h3 class="text-xl font-semibold mt-6 mb-2">الحالة الحالية</h3>
    <div id="status" class="p-2 border rounded bg-gray-50"></div>

    <h3 class="text-xl font-semibold mt-6 mb-2">رمز الاستجابة السريع</h3>
    <canvas id="qrCode" class="mb-4"></canvas>

    <div class="flex gap-4 mt-6">
      <button onclick="downloadPDF()" class="bg-green-700 text-white px-6 py-2 rounded">تحميل تقرير PDF</button>
      <button onclick="goBack()" class="bg-gray-600 text-white px-6 py-2 rounded">رجوع إلى قسم الطوارئ</button>
    </div>
  </div>
</body>
</html>
