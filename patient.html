<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
      authDomain: "hospital-project-e4b59.firebaseapp.com",
      databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hospital-project-e4b59",
      storageBucket: "hospital-project-e4b59.appspot.com",
      messagingSenderId: "974610606258",
      appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getPatientIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function displayPatientData(patient) {
      document.getElementById("patientName").textContent = patient.name;
      document.getElementById("patientInfo").innerHTML = `
        <tr><td class="font-semibold">العمر:</td><td>${patient.age}</td></tr>
        <tr><td class="font-semibold">الرقم القومي:</td><td>${patient.nid}</td></tr>
        <tr><td class="font-semibold">القسم:</td><td>${patient.department}</td></tr>
        <tr><td class="font-semibold">تاريخ الدخول:</td><td>${new Date(patient.timestamp).toLocaleString("ar-EG")}</td></tr>
        <tr><td class="font-semibold">ID:</td><td>${patient.id}</td></tr>
      `;
    }

    function loadPatientData() {
      const id = getPatientIdFromURL();
      if (!id) {
        alert("لم يتم تمرير رقم المريض في الرابط.");
        return;
      }

      const patientRef = ref(db, `patients/emergency/${id}`);
      onValue(patientRef, (snapshot) => {
        if (snapshot.exists()) {
          const patient = snapshot.val();
          displayPatientData(patient);
        } else {
          document.getElementById("patientName").textContent = "المريض غير موجود";
          document.getElementById("patientInfo").innerHTML = "<tr><td colspan='2'>لم يتم العثور على بيانات للمريض.</td></tr>";
        }
      });
    }

    window.addEventListener("DOMContentLoaded", loadPatientData);

    window.goBack = function () {
      window.location.href = "emergency.html";
    };

    window.downloadPDF = function () {
      window.print(); // مؤقتًا نفس زر الطباعة
    };
  </script>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-3xl font-bold text-center text-blue-800 mb-6" id="patientName">تحميل البيانات...</h1>

    <table class="table-auto w-full text-right border border-gray-300 mb-6">
      <tbody id="patientInfo" class="divide-y divide-gray-200">
        <tr><td colspan="2" class="text-center py-4">جاري تحميل البيانات...</td></tr>
      </tbody>
    </table>

    <div class="flex flex-wrap gap-4 mt-6">
      <button onclick="downloadPDF()" class="bg-green-700 text-white px-6 py-2 rounded">تحميل تقرير PDF</button>
      <button onclick="window.print()" class="bg-yellow-600 text-white px-6 py-2 rounded">طباعة الصفحة</button>
      <button onclick="goBack()" class="bg-gray-600 text-white px-6 py-2 rounded">رجوع إلى قسم الطوارئ</button>
    </div>
  </div>
</body>
</html>
