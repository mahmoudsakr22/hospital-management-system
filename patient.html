<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نظام تحويلات المرضى - مستشفى الحياة الذكية</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: 'Tajawal', sans-serif; }
.status-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-weight: 500;
}
.patient-card {
  transition: all 0.3s ease;
}
.patient-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}
.loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
</style>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Loading Overlay -->
<div id="loading" class="loading hidden">
  <div class="text-center">
    <i class="fas fa-spinner fa-spin text-blue-600 text-4xl mb-3"></i>
    <p class="text-blue-800 font-medium">جاري تحميل البيانات...</p>
  </div>
</div>
<!-- Header -->
<div class="flex justify-between items-center p-4 bg-white mb-6 border-b border-gray-200">
  <div class="flex items-center gap-3">
    <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" class="w-12 h-12 rounded-full bg-white border-2 border-blue-700 p-1" alt="شعار مستشفى الحياة الذكية">
    <div>
      <h1 class="text-xl font-bold text-gray-800">مستشفى الحياة الذكية</h1>
      <div class="text-blue-900 text-xs font-semibold">SMART HAYAT HOSPITAL</div>
    </div>
  </div>
  <div id="currentDate" class="text-sm"></div>
</div>
<div class="container mx-auto px-4 py-8 max-w-5xl">
  <!-- معلومات المريض -->
  <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-blue-800 to-blue-700 p-6 text-white flex justify-between items-center">
      <div>
        <h2 class="text-2xl font-bold">تفاصيل المريض</h2>
        <p class="opacity-90">بيانات المريض الأساسية وتاريخ التحويلات</p>
      </div>
      <div id="patientStatus" class="status-badge bg-white text-blue-800">غير محدد</div>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
        <div class="md:col-span-2">
          <h3 class="text-xl font-semibold mb-4 text-blue-800">المعلومات الأساسية</h3>
          <div class="bg-gray-50 p-4 rounded-lg">
            <table class="table-auto w-full" id="infoTable"></table>
          </div>
        </div>
        <div class="text-center">
          <h3 class="text-xl font-semibold mb-2 text-blue-800">رمز الاستجابة السريع</h3>
          <canvas id="qrCode" class="w-40 h-40 mx-auto"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- نموذج تسجيل تحويل جديد -->
  <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
    <h2 class="text-xl font-semibold mb-4 text-blue-800 flex items-center">
      <i class="fas fa-exchange-alt mr-2"></i> تسجيل تحويل جديد
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">القسم المستهدف</label>
        <select id="transferDepartment" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">اختر القسم</option>
          <option value="radiology">الأشعة</option>
          <option value="lab">التحاليل</option>
          <option value="icu">العناية المركزة</option>
          <option value="surgery">العمليات</option>
        </select>
      </div>
      
      <!-- اختيار الجهاز يظهر فقط عند اختيار الأشعة -->
      <div id="radiologyDeviceContainer" class="hidden">
        <label class="block text-sm font-medium text-gray-700 mb-1">جهاز الأشعة</label>
        <select id="radiologyDevice" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">اختر الجهاز</option>
          <option value="xray">أشعة عادية</option>
          <option value="ct">أشعة مقطعية</option>
          <option value="mri">رنين مغناطيسي</option>
          <option value="ultrasound">موجات صوتية</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">نوع الإجراء</label>
        <input type="text" id="transferType" placeholder="مثال: أشعة صدر - تحليل دم" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">طبيب المتابعة</label>
        <input type="text" id="doctor" placeholder="اسم الطبيب" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات</label>
        <textarea id="transferNotes" rows="2" placeholder="ملاحظات التحويل أو بيانات المريض المهمة" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
      </div>
      
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">ارفاق ملفات (اختياري)</label>
        <input type="file" id="transferFiles" class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" multiple>
      </div>
      
      <div class="md:col-span-2">
        <button onclick="addTransfer()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors flex items-center">
          <i class="fas fa-plus-circle mr-2"></i> تسجيل التحويل
        </button>
      </div>
    </div>
  </div>
  <!-- سجل التحويلات -->
  <div class="bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-blue-800 flex items-center">
        <i class="fas fa-history mr-2"></i> سجل التحويلات
      </h2>
      <div class="flex items-center">
        <div class="relative">
          <input type="text" id="searchTransfer" placeholder="بحث في التحويلات..." class="border border-gray-300 rounded-md pl-8 pr-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <i class="fas fa-search absolute left-2 top-2.5 text-gray-400"></i>
        </div>
        <select id="filterStatus" class="border border-gray-300 rounded-md px-2 py-1 ml-2">
          <option value="all">كل الحالات</option>
          <option value="pending">قيد الانتظار</option>
          <option value="in-progress">جاري العمل</option>
          <option value="completed">مكتمل</option>
        </select>
      </div>
    </div>
    
    <div id="transfersContainer" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
      <div class="text-center py-8 text-gray-500">
        <i class="fas fa-hourglass-half text-4xl mb-3"></i>
        <p>جاري تحميل سجل التحويلات...</p>
      </div>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, get, remove, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);
// تحميل بيانات المريض
async function loadPatientData() {
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get("id");
  
  if (!patientId) {
    Swal.fire({
      icon: 'warning',
      title: 'خطأ',
      text: 'معرف المريض غير موجود في الرابط',
      confirmButtonText: 'حسناً'
    });
    return;
  }
  
  const infoTable = document.getElementById("infoTable");
  const patientStatus = document.getElementById("patientStatus");
  const qrCanvas = document.getElementById("qrCode");
  
  try {
    showLoading();
    const patientRef = ref(db, `patients/emergency/${patientId}`);
    const snapshot = await get(patientRef);
    
    if (snapshot.exists()) {
      const patient = snapshot.val();
      
      // تعبئة معلومات المريض
      infoTable.innerHTML = `
        <tr><td class="font-semibold py-1">الاسم:</td><td class="py-1">${patient.name || '-'}</td></tr>
        <tr><td class="font-semibold py-1">العمر:</td><td class="py-1">${patient.age || '-'}</td></tr>
        <tr><td class="font-semibold py-1">الرقم القومي:</td><td class="py-1">${patient.nid || '-'}</td></tr>
        <tr><td class="font-semibold py-1">ID:</td><td class="py-1">${patientId}</td></tr>
        <tr><td class="font-semibold py-1">تاريخ الدخول:</td><td class="py-1">${patient.timestamp ? new Date(patient.timestamp).toLocaleString("ar-EG") : '-'}</td></tr>
        <tr><td class="font-semibold py-1">القسم الحالي:</td><td class="py-1">${patient.department || '-'}</td></tr>
        <tr><td class="font-semibold py-1">فصيلة الدم:</td><td class="py-1">${patient.bloodType || '-'}</td></tr>
        <tr><td class="font-semibold py-1">الطبيب المعالج:</td><td class="py-1">${patient.doctor || '-'}</td></tr>
      `;
      
      // تعيين الحالة
      patientStatus.textContent = patient.status || "غير محدد";
      
      // إنشاء رمز الاستجابة السريع
      QRCode.toCanvas(qrCanvas, patientId, function (error) {
        if (error) console.error(error);
      });
      
      // تحميل سجل التحويلات
      loadTransfers(patientId);
      
    } else {
      infoTable.innerHTML = "<tr><td colspan='2' class='text-center py-4'>لم يتم العثور على بيانات المريض</td></tr>";
      patientStatus.textContent = "";
    }
  } catch (error) {
    console.error("Error loading patient data:", error);
    Swal.fire({
      icon: 'error',
      title: 'خطأ',
      text: 'حدث خطأ أثناء تحميل بيانات المريض'
    });
  } finally {
    hideLoading();
  }
}
// إظهار اختيار الجهاز عند اختيار الأشعة
document.getElementById("transferDepartment").addEventListener("change", function() {
  const deviceContainer = document.getElementById("radiologyDeviceContainer");
  if (this.value === "radiology") {
    deviceContainer.classList.remove("hidden");
  } else {
    deviceContainer.classList.add("hidden");
  }
});
// إضافة تحويل جديد
window.addTransfer = async function() {
  const department = document.getElementById("transferDepartment").value;
  const type = document.getElementById("transferType").value.trim();
  const notes = document.getElementById("transferNotes").value.trim();
  const doctor = document.getElementById("doctor").value.trim();
  const device = document.getElementById("radiologyDevice").value;
  const files = document.getElementById("transferFiles").files;
  
  if (!department || !type) {
    Swal.fire({
      icon: 'warning',
      title: 'بيانات ناقصة',
      text: 'يرجى ملء الحقول الإلزامية',
      confirmButtonText: 'حسناً'
    });
    return;
  }
  
  if (department === "radiology" && !device) {
    Swal.fire({
      icon: 'warning',
      title: 'بيانات ناقصة',
      text: 'يرجى اختيار جهاز الأشعة',
      confirmButtonText: 'حسناً'
    });
    return;
  }
  
  showLoading();
  
  try {
    const patientId = new URLSearchParams(window.location.search).get("id");
    const transferRef = ref(db, `patients/emergency/${patientId}/transfers`);
    
    // تحميل الملفات إن وجدت
    let fileUrls = [];
    if (files.length > 0) {
      const uploadPromises = Array.from(files).map(async (file) => {
        const fileRef = storageRef(storage, `transfers/${patientId}/${Date.now()}_${file.name}`);
        await uploadBytes(fileRef, file);
        const downloadURL = await getDownloadURL(fileRef);
        return { name: file.name, url: downloadURL };
      });
      
      fileUrls = await Promise.all(uploadPromises);
    }
    
    // إنشاء سجل التحويل
    const newTransfer = {
      department,
      type,
      notes,
      doctor,
      device: department === "radiology" ? device : "",
      date: new Date().toLocaleString('ar-EG'),
      status: "قيد الانتظار",
      files: fileUrls,
      timestamp: new Date().toISOString()
    };
    
    await push(transferRef, newTransfer);
    
    Swal.fire({
      icon: 'success',
      title: 'تم',
      text: 'تم تسجيل التحويل بنجاح',
      timer: 1500,
      showConfirmButton: false,
      position: 'top-end',
      toast: true
    });
    
    // مسح الحقول
    document.getElementById("transferType").value = "";
    document.getElementById("transferNotes").value = "";
    document.getElementById("doctor").value = "";
    document.getElementById("transferFiles").value = "";
    
  } catch (error) {
    console.error("Error adding transfer:", error);
    Swal.fire({
      icon: 'error',
      title: 'خطأ',
      text: 'حدث خطأ أثناء تسجيل التحويل'
    });
  } finally {
    hideLoading();
  }
}
// تحميل سجل التحويلات
window.loadTransfers = function(patientId) {
  const transfersContainer = document.getElementById("transfersContainer");
  const searchInput = document.getElementById("searchTransfer");
  const statusFilter = document.getElementById("filterStatus");
  
  // ربط البحث والفلترة بالتحديث
  searchInput.addEventListener("input", () => renderTransfers());
  statusFilter.addEventListener("change", () => renderTransfers());
  
  function renderTransfers() {
    showLoading();
    
    const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
    onValue(transfersRef, (snapshot) => {
      transfersContainer.innerHTML = "";
      
      const transfers = snapshot.val() || {};
      const searchTerm = searchInput.value.toLowerCase();
      const statusValue = statusFilter.value;
      
      let filteredTransfers = Object.entries(transfers);
      
      // تطبيق فلترة الحالة
      if (statusValue !== "all") {
        filteredTransfers = filteredTransfers.filter(([_, transfer]) => {
          if (statusValue === "pending") return transfer.status === "قيد الانتظار";
          if (statusValue === "in-progress") return transfer.status === "جاري العمل";
          if (statusValue === "completed") return transfer.status === "مكتمل";
          return true;
        });
      }
      
      // تطبيق البحث
      if (searchTerm) {
        filteredTransfers = filteredTransfers.filter(([_, transfer]) => {
          return transfer.type.toLowerCase().includes(searchTerm) ||
                 transfer.department.toLowerCase().includes(searchTerm) ||
                 (transfer.notes && transfer.notes.toLowerCase().includes(searchTerm));
        });
      }
      
      if (filteredTransfers.length === 0) {
        transfersContainer.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-search text-4xl mb-3"></i>
            <p>لا يوجد تحويلات تطابق البحث</p>
          </div>
        `;
        hideLoading();
        return;
      }
      
      filteredTransfers.forEach(([transferId, transfer]) => {
        const card = document.createElement("div");
        card.className = "bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow";
        
        // تحديد أيقونة القسم
        let deptIcon, deptColor;
        switch (transfer.department) {
          case "radiology":
            deptIcon = "fa-x-ray";
            deptColor = "text-teal-600";
            break;
          case "lab":
            deptIcon = "fa-flask";
            deptColor = "text-purple-600";
            break;
          case "icu":
            deptIcon = "fa-procedures";
            deptColor = "text-red-600";
            break;
          case "surgery":
            deptIcon = "fa-user-md";
            deptColor = "text-blue-600";
            break;
          default:
            deptIcon = "fa-hospital";
            deptColor = "text-gray-600";
        }
        
        // تحديد لون الحالة
        let statusColor, statusBg;
        switch (transfer.status) {
          case "قيد الانتظار":
            statusColor = "text-yellow-600";
            statusBg = "bg-yellow-100";
            break;
          case "جاري العمل":
            statusColor = "text-blue-600";
            statusBg = "bg-blue-100";
            break;
          case "مكتمل":
            statusColor = "text-green-600";
            statusBg = "bg-green-100";
            break;
          default:
            statusColor = "text-gray-600";
            statusBg = "bg-gray-100";
        }
        
        // عرض الملفات إن وجدت
        let filesHtml = "";
        if (transfer.files && transfer.files.length > 0) {
          filesHtml = `
            <div class="mt-2 pt-2 border-t border-gray-100">
              <p class="text-sm font-medium text-gray-700 mb-1">الملفات المرفقة:</p>
              <div class="flex flex-wrap gap-2">
                ${transfer.files.map(file => `
                  <a href="${file.url}" target="_blank" class="flex items-center bg-gray-100 text-blue-700 px-2 py-1 rounded text-xs">
                    <i class="fas fa-file-alt mr-1"></i> ${file.name}
                  </a>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        // إضافة الأزرار المناسبة حسب الحالة
        let actionButtons = "";
        
        // زر تعديل للتحويلات قيد الانتظار
        if (transfer.status === "قيد الانتظار") {
          actionButtons += `
            <button onclick="updateTransferStatus('${transferId}', 'in-progress')" class="bg-blue-600 text-white p-1.5 rounded hover:bg-blue-700 mr-1" title="تعديل الحالة">
              <i class="fas fa-edit"></i>
            </button>
          `;
        }
        
        // زر حذف لجميع الحالات
        actionButtons += `
          <button onclick="deleteTransfer('${transferId}')" class="bg-red-600 text-white p-1.5 rounded hover:bg-red-700" title="حذف التحويل">
            <i class="fas fa-trash"></i>
          </button>
        `;
        
        // زر عرض التقرير للتحويلات المكتملة
        if (transfer.status === "مكتمل") {
          actionButtons += `
            <button onclick="viewTransferReport('${transferId}')" class="bg-purple-600 text-white p-1.5 rounded hover:bg-purple-700 ml-1" title="عرض التقرير">
              <i class="fas fa-file-medical-alt"></i>
            </button>
          `;
        }
        
        card.innerHTML = `
          <div class="flex justify-between">
            <div>
              <div class="flex items-center mb-2">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-800 mr-2">
                  <i class="fas ${deptIcon}"></i>
                </span>
                <h3 class="font-bold text-lg">${transfer.type}</h3>
              </div>
              <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                <div class="flex items-center">
                  <i class="fas fa-hospital-alt text-gray-500 mr-1"></i>
                  <span>${getDepartmentName(transfer.department)}</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-calendar-alt text-gray-500 mr-1"></i>
                  <span>${transfer.date}</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-user-md text-gray-500 mr-1"></i>
                  <span>${transfer.doctor || '-'}</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-clipboard-check text-gray-500 mr-1"></i>
                  <span class="${statusColor} font-medium">${transfer.status}</span>
                </div>
              </div>
              ${transfer.notes ? `
                <div class="mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                  <i class="fas fa-sticky-note text-gray-500 mr-1"></i>
                  <span>${transfer.notes}</span>
                </div>
              ` : ''}
              ${filesHtml}
            </div>
            <div class="flex flex-col space-y-2">
              ${actionButtons}
            </div>
          </div>
        `;
        
        transfersContainer.appendChild(card);
      });
      
      hideLoading();
    });
  }
  
  renderTransfers();
}
// عرض التقرير الكامل
window.viewTransferReport = function(transferId) {
  const patientId = new URLSearchParams(window.location.search).get("id");
  const transferRef = ref(db, `patients/emergency/${patientId}/transfers/${transferId}`);
  
  get(transferRef).then((snapshot) => {
    if (snapshot.exists()) {
      const transfer = snapshot.val();
      
      // إنشاء محتوى النافذة
      let reportContent = "";
      let fileHtml = "";
      
      // عرض التقرير إن وجد
      if (transfer.report) {
        reportContent = `
          <div class="mb-4">
            <h4 class="font-semibold mb-2">تفاصيل التقرير:</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-gray-700">${transfer.report}</p>
            </div>
          </div>
        `;
      }
      
      // عرض الملفات إن وجدت
      if (transfer.files && transfer.files.length > 0) {
        fileHtml = `
          <div class="mb-4">
            <h4 class="font-semibold mb-2">الملفات المرفقة:</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              ${transfer.files.map(file => `
                <div class="border rounded-lg overflow-hidden">
                  <div class="bg-gray-100 p-2 text-center">
                    <i class="fas fa-file-alt text-blue-600 mr-1"></i>
                    <span class="text-sm font-medium">${file.name}</span>
                  </div>
                  <div class="p-2 flex justify-center">
                    <a href="${file.url}" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">
                      <i class="fas fa-download mr-1"></i> تحميل
                    </a>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      // إنشاء النافذة المنبثقة
      Swal.fire({
        title: 'تفاصيل التحويل',
        html: `
          <div class="rtl">
            <div class="mb-4">
              <h4 class="font-semibold mb-2">بيانات التحويل:</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                <div class="flex items-center">
                  <span class="font-medium mr-2">القسم:</span>
                  <span>${getDepartmentName(transfer.department)}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-medium mr-2">نوع الإجراء:</span>
                  <span>${transfer.type}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-medium mr-2">الطبيب:</span>
                  <span>${transfer.doctor || '-'}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-medium mr-2">التاريخ:</span>
                  <span>${transfer.date}</span>
                </div>
              </div>
            </div>
            
            ${reportContent}
            
            <div class="mb-4">
              <h4 class="font-semibold mb-2">بيانات المريض:</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                <div class="flex items-center">
                  <span class="font-medium mr-2">الاسم:</span>
                  <span>${transfer.patientName || '-'}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-medium mr-2">العمر:</span>
                  <span>${transfer.patientAge || '-'}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-medium mr-2">الرقم القومي:</span>
                  <span>${transfer.patientId || '-'}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-medium mr-2">فصيلة الدم:</span>
                  <span>${transfer.bloodType || '-'}</span>
                </div>
              </div>
            </div>
            
            ${fileHtml}
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'إغلاق',
        width: '60vw'
      });
    }
  });
}
// تعديل حالة التحويل
window.updateTransferStatus = function(transferId, newStatus) {
  Swal.fire({
    title: 'تعديل الحالة',
    text: `هل تريد تغيير حالة التحويل إلى "${getStatusText(newStatus)}"؟`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'نعم',
    cancelButtonText: 'لا'
  }).then(async (result) => {
    if (result.isConfirmed) {
      const patientId = new URLSearchParams(window.location.search).get("id");
      const transferRef = ref(db, `patients/emergency/${patientId}/transfers/${transferId}`);
      
      await update(transferRef, {
        status: getStatusText(newStatus)
      });
      
      Swal.fire({
        icon: 'success',
        title: 'تم',
        text: 'تم تعديل الحالة بنجاح',
        timer: 1500,
        showConfirmButton: false,
        position: 'top-end',
        toast: true
      });
    }
  });
}
// حذف تحويل
window.deleteTransfer = function(transferId) {
  Swal.fire({
    title: 'تأكيد الحذف',
    text: 'هل أنت متأكد من حذف هذا التحويل؟',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'نعم، احذف',
    cancelButtonText: 'إلغاء'
  }).then(async (result) => {
    if (result.isConfirmed) {
      const patientId = new URLSearchParams(window.location.search).get("id");
      const transferRef = ref(db, `patients/emergency/${patientId}/transfers/${transferId}`);
      
      await remove(transferRef);
      
      Swal.fire({
        icon: 'success',
        title: 'تم الحذف',
        text: 'تم حذف التحويل بنجاح',
        timer: 1500,
        showConfirmButton: false,
        position: 'top-end',
        toast: true
      });
    }
  });
}
// الحصول على اسم القسم بالعربي
function getDepartmentName(dept) {
  const departments = {
    radiology: "الأشعة",
    lab: "التحاليل",
    icu: "العناية المركزة",
    surgery: "العمليات"
  };
  return departments[dept] || dept;
}
// الحصول على نص الحالة بالعربي
function getStatusText(status) {
  const statuses = {
    "pending": "قيد الانتظار",
    "in-progress": "جاري العمل",
    "completed": "مكتمل"
  };
  return statuses[status] || status;
}
// الحصول على لقب الحالة
function getStatusLabel(status) {
  const labels = {
    "pending": "قيد الانتظار",
    "in-progress": "جاري العمل",
    "completed": "مكتمل"
  };
  return labels[status] || status;
}
// عرض التاريخ الحالي
document.getElementById("currentDate").textContent = new Date().toLocaleDateString("ar-EG", {
  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
});
// دالة عرض التحميل
function showLoading() {
  document.getElementById("loading").classList.remove("hidden");
}
function hideLoading() {
  document.getElementById("loading").classList.add("hidden");
}
// تحميل بيانات المريض عند فتح الصفحة
document.addEventListener("DOMContentLoaded", loadPatientData);
</script>
</body>
</html>
