<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام ملف المريض - مستشفى الحياة الذكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        
        /* Professional Medical Theme Colors */
        :root {
            --primary: #0c4a6e;
            --primary-light: #0891b2;
            --secondary: #4f46e5;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --light: #f1f5f9;
            --dark: #0f172a;
        }
        
        /* Modern Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Status Badge Styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-critical {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }
        
        .status-stable {
            background-color: rgba(5, 150, 105, 0.1);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .status-improving {
            background-color: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        
        .status-deteriorating {
            background-color: rgba(217, 119, 6, 0.1);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }
        
        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0a3855;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
        }
        
        /* Form Styles */
        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }
        
        /* Medical Record Item Styles */
        .medical-record-item {
            border-right: 4px solid var(--primary-light);
            background: linear-gradient(to left, rgba(8, 145, 178, 0.05), transparent);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .medical-record-item:hover {
            transform: translateX(-4px);
        }
        
        /* Vital Sign Styles */
        .vital-sign {
            background-color: var(--light);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .vital-sign:focus-within {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.2);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Tab Styles */
        .tab {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
<div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <div class="bg-white p-2 rounded-xl shadow-md">
                <img src="https://t90121098672.p.clickup-attachments.com/t90121098672/aab7a4bd-0c9c-438c-8bfa-b5b1ec339843/generated-image-05102b72-8a2a-485a-9362-1371947b2a5a.png?view=open" class="w-14 h-14 rounded-full" alt="شعار مستشفى الحياة الذكية">
            </div>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">مستشفى الحياة الذكية</h1>
                <p class="text-gray-600">نظام إدارة ملفات المرضى</p>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> طباعة الملف
            </button>
            <button onclick="window.location.href='emergency.html'" class="btn btn-secondary">
                <i class="fas fa-ambulance"></i> الطوارئ
            </button>
            <button onclick="window.location.href='index.html'" class="btn btn-success">
                <i class="fas fa-home"></i> الرئيسية
            </button>
        </div>
    </div>

    <!-- Patient Info Card -->
    <div class="card mb-6">
        <div class="header flex justify-between items-center">
            <div>
                <h2 class="text-xl md:text-2xl font-bold">ملف المريض</h2>
                <p class="opacity-90">تفاصيل المريض وسجلاته الطبية</p>
            </div>
            <div id="patientStatus" class="status-badge"></div>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-user-circle text-blue-600"></i> المعلومات الأساسية
                    </h3>
                    <div class="bg-gray-50 p-5 rounded-lg">
                        <table class="table-auto w-full" id="infoTable"></table>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mt-5">
                        <button onclick="changePatientStatus()" class="btn btn-secondary">
                            <i class="fas fa-exchange-alt"></i> تغيير الحالة
                        </button>
                        <button onclick="doctorCheckup()" class="btn btn-primary">
                            <i class="fas fa-stethoscope"></i> كشف الطبيب
                        </button>
                        <a href="#" id="monitorBtn" class="btn btn-success">
                            <i class="fas fa-heartbeat"></i> عرض المونيتور
                        </a>
                    </div>
                </div>
                
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center gap-2">
                        <i class="fas fa-qrcode text-blue-600"></i> رمز الاستجابة السريع
                    </h3>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                        <canvas id="qrCode" class="w-40 h-40"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex border-b border-gray-200 mb-6">
        <div class="tab active" onclick="showTab('transfers')">
            <i class="fas fa-exchange-alt ml-2"></i> التحويلات
        </div>
        <div class="tab" onclick="showTab('checkups')">
            <i class="fas fa-file-medical ml-2"></i> الكشوفات الطبية
        </div>
    </div>

    <!-- Transfers Tab -->
    <div id="transfersTab" class="tab-content">
        <!-- New Transfer Form -->
        <div class="card mb-6">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-600"></i> تسجيل تحويل جديد
                </h2>
            </div>
            
            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">القسم</label>
                        <select id="transferDepartment" class="form-input">
                            <option value="">اختر القسم</option>
                            <option value="radiology">الأشعة</option>
                            <option value="التحاليل">التحاليل</option>
                            <option value="العناية المركزة">العناية المركزة</option>
                            <option value="العمليات">العمليات</option>
                            <option value="الصيدلية">الصيدلية</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">نوع الإجراء</label>
                        <input type="text" id="transferType" placeholder="نوع الإجراء (أشعة/تحاليل)" class="form-input" />
                    </div>
                    
                    <div id="radiologyDeviceDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">جهاز الأشعة</label>
                        <select id="radiologyDevice" class="form-input">
                            <option value="">اختر جهاز الأشعة</option>
                            <option value="أشعة عادية">أشعة عادية</option>
                            <option value="أشعة مقطعية">أشعة مقطعية</option>
                            <option value="رنين مغناطيسي">رنين مغناطيسي</option>
                            <option value="موجات صوتية">موجات صوتية</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات إضافية</label>
                        <textarea id="transferNotes" placeholder="ملاحظات إضافية" class="form-input" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Pharmacy Fields (Hidden by default) -->
                <div id="pharmacyFields" class="hidden mt-5 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-pills"></i>
                        تفاصيل طلب الدواء
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">اسم الدواء <span class="text-red-500">*</span></label>
                            <input type="text" id="medicationName" class="form-input" placeholder="اكتب اسم الدواء">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">الجرعة <span class="text-red-500">*</span></label>
                            <input type="text" id="dosage" class="form-input" placeholder="مثال: 500 مجم">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">المدة <span class="text-red-500">*</span></label>
                            <input type="text" id="duration" class="form-input" placeholder="مثال: 7 أيام">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نوع التأمين</label>
                            <select id="insuranceType" class="form-input">
                                <option value="">اختر نوع التأمين</option>
                                <option value="تأمين أساسي">تأمين أساسي</option>
                                <option value="تأمين تكميلي">تأمين تكميلي</option>
                                <option value="خاص">خاص</option>
                                <option value="غير مؤمن">غير مؤمن</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">عدد الجرعات</label>
                            <input type="number" id="dosesCount" class="form-input" placeholder="مثال: 3" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تعليمات الإعطاء</label>
                            <input type="text" id="administration" class="form-input" placeholder="مثال: بعد الأكل">
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 flex justify-end">
                    <button onclick="addTransfer()" class="btn btn-primary">
                        <i class="fas fa-save"></i> تسجيل التحويل
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Transfers History -->
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-history text-blue-600"></i> سجل التحويلات
                </h2>
            </div>
            <div class="p-5">
                <ul id="transferList" class="space-y-4"></ul>
            </div>
        </div>
    </div>

    <!-- Checkups Tab -->
    <div id="checkupsTab" class="tab-content hidden">
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-file-medical-alt text-blue-600"></i> سجل الكشوفات الطبية
                </h2>
            </div>
            <div class="p-5">
                <div id="checkupsList" class="space-y-4"></div>
            </div>
        </div>
    </div>
</div>

<!-- Medical Checkup Modal -->
<div id="checkupModal" class="modal">
    <div class="modal-content">
        <div class="bg-gradient-to-r from-blue-700 to-cyan-600 p-6 text-white">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-white/20 p-3 rounded-xl">
                        <i class="fas fa-stethoscope text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">كشف طبي جديد</h2>
                        <p class="text-blue-100">تسجيل بيانات الكشف الطبي للمريض</p>
                    </div>
                </div>
                <button onclick="closeCheckupModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-xl p-5">
                        <label class="block mb-3 font-semibold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-clipboard-list text-blue-600"></i>
                            نوع الكشف
                        </label>
                        <select id="visitType" class="form-input">
                            <option value="">اختر نوع الكشف</option>
                            <option value="كشف أولي">كشف أولي</option>
                            <option value="متابعة">متابعة</option>
                            <option value="استشارة">استشارة</option>
                        </select>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-5">
                        <label class="block mb-3 font-semibold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-notes-medical text-red-600"></i>
                            الأعراض
                        </label>
                        <textarea id="symptoms" rows="4" class="form-input" placeholder="اكتب الأعراض التي يشتكي منها المريض..."></textarea>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-5">
                        <label class="block mb-3 font-semibold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-diagnoses text-purple-600"></i>
                            التشخيص
                        </label>
                        <textarea id="diagnosis" rows="4" class="form-input" placeholder="اكتب التشخيص الطبي للحالة..."></textarea>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-5">
                        <h3 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-heartbeat text-red-500"></i>
                            العلامات الحيوية
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">ضغط الدم</label>
                                <div class="relative">
                                    <input type="text" id="bp" class="vital-sign w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pl-10" placeholder="120/80">
                                    <i class="fas fa-tint absolute left-3 top-3.5 text-red-500"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">معدل النبض</label>
                                <div class="relative">
                                    <input type="number" id="pulse" class="vital-sign w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pl-10" placeholder="75">
                                    <i class="fas fa-heart absolute left-3 top-3.5 text-pink-500"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">درجة الحرارة</label>
                                <div class="relative">
                                    <input type="number" id="temp" class="vital-sign w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pl-10" placeholder="37.5">
                                    <i class="fas fa-thermometer-half absolute left-3 top-3.5 text-orange-500"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">نسبة الأكسجين</label>
                                <div class="relative">
                                    <input type="number" id="oxygen" class="vital-sign w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pl-10" placeholder="98">
                                    <i class="fas fa-lungs absolute left-3 top-3.5 text-blue-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-5">
                        <label class="block mb-3 font-semibold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-pills text-green-600"></i>
                            الخطة العلاجية والوصفات الطبية
                        </label>
                        <textarea id="treatmentPlan" rows="3" class="form-input mb-4" placeholder="الخطة العلاجية العامة..."></textarea>
                        
                        <!-- Medications Section -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-prescription-bottle text-green-600"></i>
                                    الأدوية الموصوفة
                                </h4>
                                <button type="button" onclick="addMedication()" class="btn btn-success text-sm">
                                    <i class="fas fa-plus"></i> إضافة دواء
                                </button>
                            </div>
                            
                            <div id="medicationsList" class="space-y-4">
                                <!-- Medications will be added dynamically -->
                            </div>
                            
                            <div id="noMedications" class="text-center py-8 text-gray-500">
                                <i class="fas fa-pills text-4xl mb-2"></i>
                                <p>لا توجد أدوية مضافة</p>
                                <p class="text-sm">اضغط على زر "إضافة دواء" لبدء إضافة الأدوية</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-5">
                        <label class="block mb-3 font-semibold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-paperclip text-indigo-600"></i>
                            مرفقات (تحاليل / أشعة)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center file-drop-area">
                            <input type="file" id="attachments" class="hidden" multiple>
                            <label for="attachments" class="cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600">اسحب الملفات هنا أو انقر للاختيار</p>
                                <p class="text-sm text-gray-500">PDF, JPG, PNG (حتى 10MB)</p>
                            </label>
                        </div>
                        <div id="filePreview" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end gap-3 p-6 bg-gray-50">
            <button onclick="closeCheckupModal()" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">
                إلغاء
            </button>
            <button onclick="saveVisit()" class="btn btn-primary">
                <i class="fas fa-save"></i> تسجيل الكشف
            </button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, onValue, get, remove, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCww7pM0clGr_Nk7Xe3pCnBUJtSaw6nS-k",
  authDomain: "smart-life-hospital.firebaseapp.com",
  databaseURL: "https://smart-life-hospital-default-rtdb.firebaseio.com",
  projectId: "smart-life-hospital",
  storageBucket: "smart-life-hospital.firebasestorage.app",
  messagingSenderId: "988240466536",
  appId: "1:988240466536:web:93e9f945b255cd164361dd",
  measurementId: "G-GEJF0F0ZJ7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

// Get patient ID from URL
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

// Helper function to validate patient ID
function validatePatientId() {
    if (!patientId) {
        Swal.fire("خطأ", "معرف المريض غير موجود في الرابط", "error");
        return false;
    }
    return true;
}

// Helper function to show loading message
function showLoading(message = "جاري التحميل...") {
    Swal.fire({
        title: message,
        didOpen: () => { Swal.showLoading(); }
    });
}

// Helper function to show result message
function showResult(title, message, icon = "success") {
    Swal.fire({
        title,
        text: message,
        icon,
        timer: 1500,
        showConfirmButton: false
    });
}

// Function to update patient status UI
function updateStatusUI(status) {
    const statusEl = document.getElementById("patientStatus");
    
    const statusConfig = {
        critical: { 
            text: 'حرجة',
            class: 'status-critical',
            icon: 'fa-exclamation-triangle'
        },
        stable: { 
            text: 'مستقرة',
            class: 'status-stable',
            icon: 'fa-check-circle'
        },
        improving: { 
            text: 'في تحسن',
            class: 'status-improving',
            icon: 'fa-arrow-up'
        },
        deteriorating: { 
            text: 'في تدهور',
            class: 'status-deteriorating',
            icon: 'fa-arrow-down'
        }
    };
    
    if (statusConfig[status]) {
        statusEl.className = `status-badge ${statusConfig[status].class}`;
        statusEl.innerHTML = `<i class="fas ${statusConfig[status].icon} ml-2"></i>${statusConfig[status].text}`;
    }
}

// Function to change patient status
window.changePatientStatus = async function() {
    if (!validatePatientId()) return;
    
    const { value: newStatus } = await Swal.fire({
        title: 'تغيير حالة المريض',
        input: 'select',
        inputOptions: {
            'critical': 'حرجة',
            'stable': 'مستقرة',
            'improving': 'في تحسن',
            'deteriorating': 'في تدهور'
        },
        inputPlaceholder: 'اختر الحالة الجديدة',
        showCancelButton: true,
        confirmButtonText: 'حفظ',
        cancelButtonText: 'إلغاء',
        inputValidator: (value) => {
            if (!value) return 'يرجى اختيار الحالة';
        }
    });
    
    if (newStatus) {
        try {
            showLoading("جاري تحديث الحالة...");
            await update(ref(db, `patients/emergency/${patientId}`), { status: newStatus });
            updateStatusUI(newStatus);
            showResult("تم!", "تم تغيير حالة المريض بنجاح");
        } catch (error) {
            Swal.fire("خطأ", "فشل تحديث الحالة: " + error.message, "error");
        }
    }
};

// Load patient data
async function loadPatientData() {
    if (!validatePatientId()) return;
    
    const infoTable = document.getElementById("infoTable");
    const qrCanvas = document.getElementById("qrCode");
    
    try {
        const snapshot = await get(ref(db, `patients/emergency/${patientId}`));
        
        if (snapshot.exists()) {
            const patient = snapshot.val();
            infoTable.innerHTML = `
                <tr><td class="py-2 px-3 font-semibold text-gray-700 w-1/3">الاسم:</td><td class="py-2 px-3">${patient.name || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">العمر:</td><td class="py-2 px-3">${patient.age || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الرقم القومي:</td><td class="py-2 px-3">${patient.nid || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">ID:</td><td class="py-2 px-3 font-mono">${patientId}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">تاريخ الدخول:</td><td class="py-2 px-3">${patient.timestamp ? new Date(patient.timestamp).toLocaleString('ar-EG') : '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">القسم الحالي:</td><td class="py-2 px-3">${patient.department || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الطبيب المعالج:</td><td class="py-2 px-3">${patient.doctors || '-'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">نوع الخدمة:</td><td class="py-2 px-3" id="serviceType">${patient.serviceType || 'غير محدد'}</td></tr>
                <tr><td class="py-2 px-3 font-semibold text-gray-700">الحالة:</td><td class="py-2 px-3" id="patientStatusInTable">${patient.status || 'غير محدد'}</td></tr>
            `;
            
            updateStatusUI(patient.status || "stable");
            
            // Generate QR code
            QRCode.toCanvas(qrCanvas, patientId, function (error) {
                if (error) console.error(error);
            });
        } else {
            infoTable.innerHTML = "<tr><td colspan='2' class='py-2 px-3 text-center text-gray-500'>لم يتم العثور على بيانات المريض.</td></tr>";
        }
    } catch (error) {
        Swal.fire("خطأ", "فشل تحميل بيانات المريض: " + error.message, "error");
    }
}

// Open medical checkup modal
window.doctorCheckup = function() {
    if (!validatePatientId()) return;
    
    // Reset form
    document.getElementById('visitType').value = '';
    document.getElementById('symptoms').value = '';
    document.getElementById('bp').value = '';
    document.getElementById('pulse').value = '';
    document.getElementById('temp').value = '';
    document.getElementById('oxygen').value = '';
    document.getElementById('diagnosis').value = '';
    document.getElementById('treatmentPlan').value = '';
    document.getElementById('attachments').value = '';
    document.getElementById('filePreview').innerHTML = '';
    
    // Reset medications list
    document.getElementById('medicationsList').innerHTML = '';
    document.getElementById('noMedications').style.display = 'block';
    
    // Show modal
    document.getElementById('checkupModal').classList.add('active');
};

// Close medical checkup modal
window.closeCheckupModal = function() {
    document.getElementById('checkupModal').classList.remove('active');
};

// Preview uploaded files
document.getElementById('attachments').addEventListener('change', function() {
    const files = this.files;
    const preview = document.getElementById('filePreview');
    preview.innerHTML = '';
    
    if (files.length > 0) {
        preview.innerHTML = '<p class="font-semibold mb-2">الملفات المحددة:</p>';
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center gap-2 mb-1 p-2 bg-gray-50 rounded';
            
            // Determine icon based on file type
            let icon = 'fa-file';
            if (file.type.startsWith('image/')) icon = 'fa-file-image';
            else if (file.type === 'application/pdf') icon = 'fa-file-pdf';
            else if (file.type.includes('word')) icon = 'fa-file-word';
            
            fileItem.innerHTML = `
                <i class="fas ${icon} text-blue-600"></i>
                <span>${file.name}</span>
                <span class="text-sm text-gray-500">(${(file.size / 1024).toFixed(1)} KB)</span>
            `;
            
            preview.appendChild(fileItem);
        }
    }
});

// Function to add a new medication
window.addMedication = function() {
    const medicationsList = document.getElementById('medicationsList');
    const noMedications = document.getElementById('noMedications');
    
    // Hide "no medications" message
    noMedications.style.display = 'none';
    
    const medicationId = Date.now();
    const medicationItem = document.createElement('div');
    medicationItem.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
    medicationItem.id = `medication-${medicationId}`;
    
    medicationItem.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <h5 class="font-semibold text-gray-700">الدواء #${medicationsList.children.length + 1}</h5>
            <button type="button" onclick="removeMedication(${medicationId})" class="text-red-600 hover:text-red-800 transition-colors">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">اسم الدواء <span class="text-red-500">*</span></label>
                <input type="text" class="medication-name w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="اسم الدواء">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">الجرعة <span class="text-red-500">*</span></label>
                <input type="text" class="medication-dosage w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="مثال: 500 مجم">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">المدة <span class="text-red-500">*</span></label>
                <input type="text" class="medication-duration w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="مثال: 7 أيام">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">نوع التأمين</label>
                <select class="medication-insurance w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">اختر نوع التأمين</option>
                    <option value="تأمين أساسي">تأمين أساسي</option>
                    <option value="تأمين تكميلي">تأمين تكميلي</option>
                    <option value="خاص">خاص</option>
                    <option value="غير مؤمن">غير مؤمن</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">عدد الجرعات</label>
                <input type="number" class="medication-doses w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="مثال: 3" min="1">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">تعليمات الإعطاء</label>
                <input type="text" class="medication-instructions w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="مثال: بعد الأكل">
            </div>
        </div>
    `;
    
    medicationsList.appendChild(medicationItem);
};

// Function to remove a medication
window.removeMedication = function(medicationId) {
    const medicationItem = document.getElementById(`medication-${medicationId}`);
    if (medicationItem) {
        medicationItem.remove();
        
        // Check if no medications left
        const medicationsList = document.getElementById('medicationsList');
        if (medicationsList.children.length === 0) {
            document.getElementById('noMedications').style.display = 'block';
        }
    }
};

// Save medical checkup data
window.saveVisit = async function() {
    if (!validatePatientId()) return;
    
    // Collect form data
    const visitType = document.getElementById('visitType').value;
    const symptoms = document.getElementById('symptoms').value;
    const bp = document.getElementById('bp').value;
    const pulse = document.getElementById('pulse').value;
    const temp = document.getElementById('temp').value;
    const oxygen = document.getElementById('oxygen').value;
    const diagnosis = document.getElementById('diagnosis').value;
    const treatmentPlan = document.getElementById('treatmentPlan').value;
    const attachments = document.getElementById('attachments').files;
    
    // Collect medications data
    const medications = [];
    const medicationItems = document.querySelectorAll('#medicationsList > div');
    
    medicationItems.forEach(item => {
        const name = item.querySelector('.medication-name').value.trim();
        const dosage = item.querySelector('.medication-dosage').value.trim();
        const duration = item.querySelector('.medication-duration').value.trim();
        const insurance = item.querySelector('.medication-insurance').value;
        const doses = item.querySelector('.medication-doses').value;
        const instructions = item.querySelector('.medication-instructions').value.trim();
        
        if (name && dosage && duration) {
            medications.push({
                name,
                dosage,
                duration,
                insurance: insurance || "غير محدد",
                doses: doses || null,
                instructions: instructions || "حسب إرشادات الطبيب"
            });
        }
    });
    
    // Validate required fields
    if (!visitType || !symptoms || !diagnosis) {
        Swal.fire("تنبيه", "يرجى ملء الحقول المطلوبة (نوع الكشف، الأعراض، التشخيص)", "warning");
        return;
    }
    
    try {
        showLoading("جاري حفظ الكشف...");
        
        // Prepare checkup data
        const checkupData = {
            visitType,
            symptoms,
            vitalSigns: {
                bp,
                pulse,
                temp,
                oxygen
            },
            diagnosis,
            treatmentPlan,
            medications,
            doctorId: "currentDoctorId",
            date: new Date().toISOString(),
            status: "مكتمل",
            attachments: []
        };
        
        // Upload files if any
        if (attachments.length > 0) {
            for (let i = 0; i < attachments.length; i++) {
                const file = attachments[i];
                const fileRef = storageRef(storage, `patients/${patientId}/checkups/${Date.now()}_${file.name}`);
                
                await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(fileRef);
                
                checkupData.attachments.push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    url: downloadURL
                });
            }
        }
        
        // Save data to Firebase
        const newCheckupRef = await push(ref(db, `patients/emergency/${patientId}/checkups`), checkupData);
        checkupData.id = newCheckupRef.key;
        
        // Update patient status
        await update(ref(db, `patients/emergency/${patientId}`), {
            lastCheckup: new Date().toISOString(),
            serviceType: visitType
        });
        
        // Close modal
        closeCheckupModal();
        
        showResult("تم!", "تم حفظ الكشف بنجاح");
    } catch (error) {
        Swal.fire("خطأ", "فشل حفظ الكشف: " + error.message, "error");
    }
};

// Show/hide fields based on selected department
document.getElementById("transferDepartment").addEventListener("change", function() {
    const department = this.value;
    const deviceSelect = document.getElementById("radiologyDevice");
    const deviceDiv = document.getElementById("radiologyDeviceDiv");
    const pharmacyFields = document.getElementById("pharmacyFields");
    const transferTypeInput = document.getElementById("transferType");
    
    // Hide all specialized fields first
    deviceDiv.classList.add("hidden");
    pharmacyFields.classList.add("hidden");
    
    // Show appropriate fields based on department
    if (department === "radiology") {
        deviceDiv.classList.remove("hidden");
        transferTypeInput.placeholder = "نوع الأشعة";
    } else if (department === "الصيدلية") {
        pharmacyFields.classList.remove("hidden");
        transferTypeInput.placeholder = "طلب دواء";
        transferTypeInput.value = "طلب صرف دواء"; // Default value
    } else if (department === "التحاليل") {
        transferTypeInput.placeholder = "نوع التحليل";
    } else {
        transferTypeInput.placeholder = "نوع الإجراء";
    }
});

// Register a new transfer
window.addTransfer = async function() {
    if (!validatePatientId()) return;
    
    const department = document.getElementById("transferDepartment").value;
    const type = document.getElementById("transferType").value.trim();
    const notes = document.getElementById("transferNotes").value.trim();
    const device = document.getElementById("radiologyDevice").value;
    
    // Pharmacy data
    const medicationName = document.getElementById("medicationName").value.trim();
    const dosage = document.getElementById("dosage").value.trim();
    const duration = document.getElementById("duration").value.trim();
    const insuranceType = document.getElementById("insuranceType").value;
    const dosesCount = document.getElementById("dosesCount").value;
    const administration = document.getElementById("administration").value.trim();
    
    // Validate required fields
    if (!department || !type) {
        Swal.fire("تنبيه", "يرجى ملء جميع الحقول", "warning");
        return;
    }
    
    // Pharmacy-specific validation
    if (department === "الصيدلية") {
        if (!medicationName || !dosage || !duration) {
            Swal.fire("تنبيه", "يرجى ملء حقول الدواء الأساسية (الاسم، الجرعة، المدة)", "warning");
            return;
        }
    }
    
    // Radiology-specific validation
    if (department === "radiology" && !device) {
        Swal.fire("تنبيه", "يرجى اختيار جهاز الأشعة", "warning");
        return;
    }
    
    const newTransfer = {
        department,
        type,
        notes,
        device: department === "radiology" ? device : "",
        // Pharmacy data
        medication: department === "الصيدلية" ? {
            name: medicationName,
            dosage: dosage,
            duration: duration,
            insuranceType: insuranceType || "غير محدد",
            dosesCount: dosesCount || null,
            administration: administration || "حسب إرشادات الطبيب"
        } : null,
        date: new Date().toLocaleString('ar-EG'),
        status: "قيد الانتظار",
        requestedBy: "د. أحمد محمد" // In real system: use doctor name from authentication
    };
    
    try {
        showLoading("جاري تسجيل التحويل...");
        await push(ref(db, `patients/emergency/${patientId}/transfers`), newTransfer);
        
        // Reset form
        document.getElementById("transferDepartment").value = "";
        document.getElementById("transferType").value = "";
        document.getElementById("transferNotes").value = "";
        document.getElementById("radiologyDevice").value = "";
        document.getElementById("pharmacyFields").classList.add("hidden");
        
        // Reset pharmacy fields
        document.getElementById("medicationName").value = "";
        document.getElementById("dosage").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("insuranceType").value = "";
        document.getElementById("dosesCount").value = "";
        document.getElementById("administration").value = "";
        
        showResult("تم", "تم تسجيل التحويل بنجاح");
    } catch (error) {
        Swal.fire("خطأ", "حدث خطأ أثناء التسجيل: " + error.message, "error");
    }
};

// Delete a transfer record
window.deleteTransfer = function(transferKey) {
    Swal.fire({
        title: 'تأكيد الحذف',
        text: "هل أنت متأكد أنك تريد حذف هذا السجل؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            remove(ref(db, `patients/emergency/${patientId}/transfers/${transferKey}`))
            .then(() => {
                showResult("تم الحذف!", "تم حذف السجل بنجاح");
            })
            .catch((error) => {
                Swal.fire("خطأ", "حدث خطأ أثناء الحذف: " + error.message, "error");
            });
        }
    });
};

// Load transfers data
function loadTransfers() {
    if (!validatePatientId()) return;
    
    const list = document.getElementById("transferList");
    const transfersRef = ref(db, `patients/emergency/${patientId}/transfers`);
    
    onValue(transfersRef, (snapshot) => {
        list.innerHTML = "";
        
        if (!snapshot.exists()) {
            list.innerHTML = "<p class='text-gray-500 text-center py-4'>لا توجد تحويلات مسجلة</p>";
            return;
        }
        
        snapshot.forEach((child) => {
            const t = child.val();
            const key = child.key;
            let resultText = "";
            
            // Display medication details if transfer is to pharmacy
            if (t.department === "الصيدلية" && t.medication) {
                const med = t.medication;
                resultText += `
                    <div class="bg-green-50 p-3 rounded-lg mt-2 border border-green-200">
                        <div class="font-semibold text-green-800 mb-2">تفاصيل الدواء:</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <div><span class="font-medium">الدواء:</span> ${med.name}</div>
                            <div><span class="font-medium">الجرعة:</span> ${med.dosage}</div>
                            <div><span class="font-medium">المدة:</span> ${med.duration}</div>
                            <div><span class="font-medium">التأمين:</span> ${med.insuranceType}</div>
                            ${med.dosesCount ? `<div><span class="font-medium">عدد الجرعات:</span> ${med.dosesCount}</div>` : ''}
                            <div class="md:col-span-2"><span class="font-medium">طريقة الإعطاء:</span> ${med.administration}</div>
                        </div>
                    </div>
                `;
            }
            
            if (t.report) {
                resultText += ` | <span class="text-green-700">النتيجة: ${t.report}</span>`;
            }
            if (t.technician) {
                resultText += ` | <span class="text-blue-700">منفذ الأشعة: ${t.technician}</span>`;
            }
            if (t.device) {
                resultText += ` | <span class="text-purple-700">الجهاز: ${t.device}</span>`;
            }
            
            let actionBtns = "";
            if (t.department === "radiology") {
                if (t.status === "قيد الانتظار") {
                    actionBtns += `<button onclick='editRadiology("${key}", ${JSON.stringify(t)})' class="btn btn-primary text-sm ml-2">تعديل</button>`;
                }
                if (t.status === "تم التنفيذ") {
                    actionBtns += `<button onclick='showRadiologyReport(${JSON.stringify(t)})' class="btn btn-success text-sm ml-2">عرض النتيجة</button>`;
                }
                actionBtns += `<button onclick='deleteTransfer("${key}")' class="btn btn-danger text-sm ml-2">حذف</button>`;
            } else if (t.department === "الصيدلية") {
                // Pharmacy-specific buttons
                if (t.status === "قيد الانتظار") {
                    actionBtns += `
                        <button onclick='updateMedicationStatus("${key}", "تم الصرف")' class="btn btn-success text-sm ml-2">
                            <i class="fas fa-check"></i>تأكيد الصرف
                        </button>
                        <button onclick='updateMedicationStatus("${key}", "مرفوض")' class="btn btn-danger text-sm ml-2">
                            <i class="fas fa-times"></i>رفض
                        </button>
                    `;
                } else if (t.status === "تم الصرف") {
                    actionBtns += `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">تم الصرف</span>`;
                } else if (t.status === "مرفوض") {
                    actionBtns += `<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">مرفوض</span>`;
                }
                actionBtns += `<button onclick='deleteTransfer("${key}")' class="btn btn-danger text-sm ml-2">
                    <i class="fas fa-trash"></i>
                </button>`;
            }
            
            const statusColor = {
                "قيد الانتظار": "text-yellow-600 bg-yellow-50",
                "تم التنفيذ": "text-green-600 bg-green-50",
                "تم الصرف": "text-green-600 bg-green-50",
                "مرفوض": "text-red-600 bg-red-50"
            };
            
            const item = document.createElement("div");
            item.className = "medical-record-item";
            item.innerHTML = `
                <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-2">
                    <div class="mb-2 md:mb-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-lg">${getDepartmentIcon(t.department)} ${t.department}</span>
                            <span class="mx-1">•</span>
                            <span>${t.type}</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            ${t.date}
                        </div>
                    </div>
                    <div class="px-3 py-1 rounded-full text-sm font-medium ${statusColor[t.status] || 'text-gray-600 bg-gray-50'}">
                        ${t.status}
                    </div>
                </div>
                ${resultText}
                <div class="mt-3 flex flex-wrap gap-2">
                    ${actionBtns}
                </div>
            `;
            list.appendChild(item);
        });
    });
}

// Helper function to get department icon
function getDepartmentIcon(department) {
    const icons = {
        "radiology": "📡",
        "التحاليل": "🔬",
        "العناية المركزة": "🏥",
        "العمليات": "🔪",
        "الصيدلية": "💊"
    };
    return icons[department] || "📋";
}

// Function to update medication status
window.updateMedicationStatus = async function(transferKey, newStatus) {
    try {
        showLoading("جاري تحديث الحالة...");
        await update(ref(db, `patients/emergency/${patientId}/transfers/${transferKey}`), {
            status: newStatus,
            updatedAt: new Date().toISOString(),
            processedBy: "موظف الصيدلية" // In real system: use username from authentication
        });
        showResult("تم!", `تم تحديث حالة الطلب إلى: ${newStatus}`);
    } catch (error) {
        Swal.fire("خطأ", "فشل تحديث الحالة: " + error.message, "error");
    }
};

// Show radiology report
window.showRadiologyReport = function(transfer) {
    let fileHtml = '';
    if (transfer.fileUrl) {
        const ext = transfer.fileUrl.split('.').pop().toLowerCase();
        if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
            fileHtml = `<img src="${transfer.fileUrl}" alt="صورة الأشعة" style="max-width:100%;max-height:40vh;display:block;margin:10px auto;">`;
        } else if (ext === "pdf") {
            fileHtml = `<iframe src="${transfer.fileUrl}" style="width:100%;height:40vh;" frameborder="0"></iframe>`;
        } else {
            fileHtml = `<a href="${transfer.fileUrl}" target="_blank" class="text-blue-700 underline">تحميل الملف</a>`;
        }
    } else {
        fileHtml = `<span class="text-gray-500">لا يوجد ملف مرفق</span>`;
    }
    
    Swal.fire({
        title: "نتيجة الأشعة",
        html: `
            <div class="text-right">
                <p><b>نوع الأشعة:</b> ${transfer.type || "-"}</p>
                <p><b>الجهاز:</b> ${transfer.device || "-"}</p>
                <p><b>منفذ الأشعة:</b> ${transfer.technician || "-"}</p>
                <p><b>تقرير الفني:</b> ${transfer.report || "لا يوجد تقرير"}</p>
                <p><b>تاريخ التنفيذ:</b> ${transfer.executionDate || "-"}</p>
                <div class="mt-4">
                    ${fileHtml}
                </div>
            </div>
        `,
        width: "60vw",
        showCloseButton: true,
        confirmButtonText: "إغلاق"
    });
};

// Load medical checkups
function loadCheckups() {
    if (!validatePatientId()) return;
    
    const checkupsList = document.getElementById("checkupsList");
    const checkupsRef = ref(db, `patients/emergency/${patientId}/checkups`);
    
    onValue(checkupsRef, (snapshot) => {
        checkupsList.innerHTML = "";
        
        if (!snapshot.exists()) {
            checkupsList.innerHTML = "<p class='text-gray-500 text-center py-4'>لا توجد كشوفات مسجلة</p>";
            return;
        }
        
        snapshot.forEach((child) => {
            const checkup = child.val();
            const checkupEl = document.createElement("div");
            checkupEl.className = "medical-record-item";
            
            // Display vital signs
            let vitalSignsHtml = '';
            if (checkup.vitalSigns) {
                const { bp, pulse, temp, oxygen } = checkup.vitalSigns;
                vitalSignsHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 my-3">
                        ${bp ? `<div class="bg-blue-50 p-3 rounded-lg border border-blue-100"><div class="text-xs text-blue-600 mb-1">ضغط الدم</div><div class="font-medium">${bp}</div></div>` : ''}
                        ${pulse ? `<div class="bg-green-50 p-3 rounded-lg border border-green-100"><div class="text-xs text-green-600 mb-1">النبض</div><div class="font-medium">${pulse}</div></div>` : ''}
                        ${temp ? `<div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100"><div class="text-xs text-yellow-600 mb-1">الحرارة</div><div class="font-medium">${temp}°C</div></div>` : ''}
                        ${oxygen ? `<div class="bg-purple-50 p-3 rounded-lg border border-purple-100"><div class="text-xs text-purple-600 mb-1">الأكسجين</div><div class="font-medium">${oxygen}%</div></div>` : ''}
                    </div>
                `;
            }
            
            // Display medications
            let medicationsHtml = '';
            if (checkup.medications && checkup.medications.length > 0) {
                medicationsHtml = `
                    <div class="mt-3 bg-green-50 p-4 rounded-lg border border-green-200">
                        <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-pills"></i>
                            الأدوية الموصوفة:
                        </h5>
                        <div class="space-y-3">
                            ${checkup.medications.map((med, index) => `
                                <div class="bg-white p-3 rounded-lg border border-green-100 shadow-sm">
                                    <div class="font-medium text-green-700 mb-2">${index + 1}. ${med.name}</div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                        <div><span class="font-medium text-gray-600">الجرعة:</span> ${med.dosage}</div>
                                        <div><span class="font-medium text-gray-600">المدة:</span> ${med.duration}</div>
                                        <div><span class="font-medium text-gray-600">التأمين:</span> ${med.insurance}</div>
                                        ${med.doses ? `<div><span class="font-medium text-gray-600">الجرعات:</span> ${med.doses}</div>` : ''}
                                        <div class="md:col-span-2"><span class="font-medium text-gray-600">التعليمات:</span> ${med.instructions}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Display attachments
            let attachmentsHtml = '';
            if (checkup.attachments && checkup.attachments.length > 0) {
                attachmentsHtml = `
                    <div class="mt-3">
                        <p class="font-medium text-sm text-gray-700 mb-2">المرفقات:</p>
                        <div class="flex flex-wrap gap-2">
                            ${checkup.attachments.map(att => `
                                <a href="${att.url}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-sm hover:bg-blue-100 transition-colors">
                                    <i class="fas ${att.type.includes('image') ? 'fa-image' : 'fa-file'}"></i>
                                    ${att.name}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            checkupEl.innerHTML = `
                <div class="flex flex-col md:flex-row md:justify-between md:items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full">
                                ${checkup.visitType || 'كشف'}
                            </span>
                            <span class="text-sm text-gray-500">
                                ${new Date(checkup.date).toLocaleDateString('ar-EG')}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <p class="text-sm text-gray-700 mb-1">
                                <span class="font-medium text-gray-900">الأعراض:</span> ${checkup.symptoms || '-'}
                            </p>
                        </div>
                        
                        ${vitalSignsHtml}
                        
                        <div class="mb-3">
                            <p class="text-sm text-gray-700 mb-1">
                                <span class="font-medium text-gray-900">التشخيص:</span> ${checkup.diagnosis || '-'}
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <p class="text-sm text-gray-700">
                                <span class="font-medium text-gray-900">الخطة العلاجية:</span> ${checkup.treatmentPlan || '-'}
                            </p>
                        </div>
                        
                        ${medicationsHtml}
                        
                        ${attachmentsHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-3 md:mt-0 md:text-right">
                        <i class="fas fa-user-md"></i> ${checkup.doctorId || 'طبيب'}
                    </div>
                </div>
            `;
            
            checkupsList.appendChild(checkupEl);
        });
    });
}

// Tab switching functionality
function showTab(tabName) {
    // Hide all tabs
    document.getElementById('transfersTab').classList.add('hidden');
    document.getElementById('checkupsTab').classList.add('hidden');
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').classList.remove('hidden');
    
    // Add active class to clicked tab
    event.target.classList.add('active');
}

// Load data when page opens
if (patientId) {
    loadPatientData();
    loadTransfers();
    loadCheckups();
}

// Link monitor button
const monitorBtn = document.getElementById('monitorBtn');
if (monitorBtn && patientId) {
    monitorBtn.href = `monitor.html?id=${patientId}`;
}
</script>
</body>
</html>
