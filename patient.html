<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ملف المريض - مستشفى الحياة الذكية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, push, update
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
      authDomain: "hospital-project-e4b59.firebaseapp.com",
      databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hospital-project-e4b59",
      storageBucket: "hospital-project-e4b59.appspot.com",
      messagingSenderId: "974610606258",
      appId: "1:974610606258:web:71ce7d5d447bca4b4441ab",
      measurementId: "G-0GV30LL28T"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");

    const patientRef = ref(db, "patients/emergency");
    const visitRef = ref(db, `visits/${patientId}`);
    const transferRef = ref(db, `transfers/${patientId}`);
    const medRef = ref(db, `medications/${patientId}`);

    onValue(patientRef, (snapshot) => {
      let found = false;
      snapshot.forEach(child => {
        const data = child.val();
        if (data.timestamp && data.timestamp.includes(patientId)) {
          found = true;
          document.getElementById("basic-info").innerHTML = `
            <tr><td>الاسم</td><td>${data.name}</td></tr>
            <tr><td>العمر</td><td>${data.age}</td></tr>
            <tr><td>الرقم القومي</td><td>${data.nid}</td></tr>
            <tr><td>ID</td><td>${data.timestamp}</td></tr>
            <tr><td>تاريخ الدخول</td><td>${new Date(data.timestamp).toLocaleString()}</td></tr>
            <tr><td>القسم الحالي</td><td>${data.department}</td></tr>
            <tr><td>الطبيب</td><td>غير محدد</td></tr>
          `;
          const qr = new QRCodeStyling({
            width: 100,
            height: 100,
            data: window.location.href,
            dotsOptions: { color: "#000", type: "rounded" },
            backgroundOptions: { color: "#ffffff" }
          });
          qr.append(document.getElementById("qr-code"));
        }
      });
      if (!found) {
        document.getElementById("basic-info").innerHTML = `<tr><td colspan="2">لم يتم العثور على المريض</td></tr>`;
      }
    });

    // زيارات
    onValue(visitRef, (snap) => {
      const list = document.getElementById("visit-list");
      list.innerHTML = "";
      snap.forEach(child => {
        const v = child.val();
        const row = document.createElement("tr");
        row.innerHTML = `<td>${v.type}</td><td>${v.notes}</td><td>${new Date(v.timestamp).toLocaleString()}</td>`;
        list.appendChild(row);
      });
    });

    // تحويلات
    onValue(transferRef, (snap) => {
      const list = document.getElementById("transfer-list");
      list.innerHTML = "";
      snap.forEach(child => {
        const t = child.val();
        const row = document.createElement("tr");
        row.innerHTML = `<td>${t.to}</td><td>${t.details}</td><td>${new Date(t.timestamp).toLocaleString()}</td>`;
        list.appendChild(row);
      });
    });

    // أدوية
    onValue(medRef, (snap) => {
      const list = document.getElementById("med-list");
      list.innerHTML = "";
      snap.forEach(child => {
        const m = child.val();
        const row = document.createElement("tr");
        row.innerHTML = `<td>${m.name}</td><td>${m.notes}</td><td>${new Date(m.timestamp).toLocaleString()}</td>`;
        list.appendChild(row);
      });
    });

    // تسجيل زيارة
    window.addVisit = async () => {
      const type = document.getElementById("visit-type").value;
      const notes = document.getElementById("visit-notes").value;
      if (!type || !notes) return alert("املأ جميع الحقول");
      await push(visitRef, { type, notes, timestamp: new Date().toISOString() });
      document.getElementById("visit-notes").value = "";
    };

    // تحويل
    window.addTransfer = async () => {
      const to = document.getElementById("transfer-to").value;
      const details = document.getElementById("transfer-details").value;
      if (!to || !details) return alert("املأ جميع الحقول");
      await push(transferRef, { to, details, timestamp: new Date().toISOString() });
      document.getElementById("transfer-details").value = "";
    };

    // حفظ PDF
    window.downloadPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("تقرير المريض", 10, 10);
      doc.text("ID: " + patientId, 10, 20);
      doc.save("patient-report.pdf");
    };
  </script>
</head>
<body class="bg-gray-100 p-6 space-y-6">
  <div class="bg-white p-4 rounded shadow">
    <h1 class="text-xl font-bold text-blue-800 mb-4">المعلومات الأساسية</h1>
    <div id="qr-code" class="mb-4"></div>
    <table class="w-full text-right border" id="info-table">
      <tbody id="basic-info" class="divide-y"></tbody>
    </table>
  </div>

  <div class="bg-white p-4 rounded shadow space-y-4">
    <h2 class="text-lg font-bold text-green-700">تسجيل زيارة جديدة</h2>
    <select id="visit-type" class="border rounded p-2 w-full">
      <option value="">-- اختر نوع الزيارة --</option>
      <option value="كشف طبي">كشف طبي</option>
      <option value="متابعة">متابعة</option>
      <option value="استشارة">استشارة</option>
    </select>
    <textarea id="visit-notes" placeholder="ملاحظات الطبيب" class="w-full border p-2 rounded"></textarea>
    <button onclick="addVisit()" class="bg-green-600 text-white px-4 py-2 rounded">تسجيل الزيارة</button>
    <table class="w-full text-right border">
      <thead><tr><th>النوع</th><th>الملاحظات</th><th>الوقت</th></tr></thead>
      <tbody id="visit-list"></tbody>
    </table>
  </div>

  <div class="bg-white p-4 rounded shadow space-y-4">
    <h2 class="text-lg font-bold text-yellow-700">تحويل إلى قسم آخر</h2>
    <select id="transfer-to" class="border rounded p-2 w-full">
      <option value="">-- اختر القسم --</option>
      <option value="العناية المركزة">العناية المركزة</option>
      <option value="العمليات">العمليات</option>
      <option value="الرعاية">الرعاية</option>
      <option value="الإدارة">الإدارة</option>
    </select>
    <textarea id="transfer-details" placeholder="تفاصيل التحويل" class="w-full border p-2 rounded"></textarea>
    <button onclick="addTransfer()" class="bg-yellow-600 text-white px-4 py-2 rounded">تسجيل التحويل</button>
    <table class="w-full text-right border">
      <thead><tr><th>القسم</th><th>تفاصيل</th><th>الوقت</th></tr></thead>
      <tbody id="transfer-list"></tbody>
    </table>
  </div>

  <div class="bg-white p-4 rounded shadow space-y-4">
    <h2 class="text-lg font-bold text-purple-700">سجل الأدوية والعلاج</h2>
    <table class="w-full text-right border">
      <thead><tr><th>الدواء</th><th>ملاحظات</th><th>الوقت</th></tr></thead>
      <tbody id="med-list"></tbody>
    </table>
  </div>

  <div class="flex justify-between mt-6">
    <button onclick="downloadPDF()" class="bg-blue-700 text-white px-4 py-2 rounded">تحميل تقرير PDF</button>
    <a href="emergency.html" class="bg-gray-700 text-white px-4 py-2 rounded">رجوع إلى قسم الطوارئ</a>
  </div>
</body>
</html>
