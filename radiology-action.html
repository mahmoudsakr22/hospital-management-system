<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تنفيذ طلب الأشعة - مستشفى الحياة الذكية</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: 'Tajawal', sans-serif; }

/* تبويبات */
.tab-active {
  border-bottom: 3px solid #2563eb;
  color: #2563eb;
  font-weight: bold;
  transition: all 0.3s ease;
}
.tab-btn:hover {
  color: #1e40af;
  transform: scale(1.05);
}

/* البادجات */
.status-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-weight: 500;
}

/* اللودر */
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #2563eb;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 80px auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* نجوم التقييم */
.star {
  font-size: 2rem;
  cursor: pointer;
  color: #d1d5db;
  transition: color 0.2s, transform 0.2s;
}
.star:hover {
  color: gold;
  transform: scale(1.2);
}
.star.selected {
  color: gold;
}

/* معاينة الملفات */
.thumbnail {
  width: 90px;
  height: 90px;
  object-fit: cover;
  border: 1px solid #ccc;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.thumbnail:hover {
  transform: scale(1.05);
}
</style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-gray-100 min-h-screen">
<div class="container mx-auto px-4 py-8">

<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-gradient-to-r from-blue-900 to-blue-600 p-4 rounded-lg shadow">
  <div class="flex items-center gap-3">
    <div class="bg-white p-3 rounded-lg shadow-md">
      <i class="fas fa-x-ray text-blue-800 text-3xl"></i>
    </div>
    <h1 class="text-3xl font-bold text-white">تنفيذ طلب الأشعة</h1>
  </div>
  <button onclick="window.location.href='radiology.html'" class="bg-gray-100 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-200 transition">
    رجوع لقسم الأشعة
  </button>
</div>

<!-- Loader -->
<div id="loader" class="text-center">
  <div class="loader"></div>
  <p class="text-gray-600 mt-2">جارِ التحميل...</p>
</div>

<!-- Tabs -->
<div id="tabsContainer" class="hidden">
  <div class="flex justify-around mb-6 border-b">
    <button class="tab-btn py-2" data-tab="detailsTab">تفاصيل</button>
    <button class="tab-btn py-2" data-tab="reportTab">التقرير والملفات</button>
    <button class="tab-btn py-2" data-tab="commentsTab">التعليقات</button>
    <button class="tab-btn py-2" data-tab="ratingTab">التقييم</button>
  </div>

  <!-- تفاصيل -->
  <div id="detailsTab" class="tab-content">
    <div id="patientDetails"></div>
    <div id="transferDetails"></div>
    <div id="timelineSection"></div>
  </div>

  <!-- تقرير -->
  <div id="reportTab" class="tab-content hidden">
    <div id="reportSection"></div>
  </div>

  <!-- تعليقات -->
  <div id="commentsTab" class="tab-content hidden">
    <div id="commentsSection"></div>
  </div>

  <!-- تقييم -->
  <div id="ratingTab" class="tab-content hidden">
    <div id="ratingSection"></div>
  </div>
</div>

</div>

<!-- JavaScript -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("patient");
const transferId = urlParams.get("transfer");

function statusColor(status) {
  if (status === "تم التنفيذ") return "bg-green-100 text-green-800";
  if (status === "مرفوض") return "bg-red-100 text-red-800";
  if (status === "قيد الانتظار") return "bg-yellow-100 text-yellow-800";
  return "bg-gray-200 text-gray-800";
}

// ** تحميل البيانات Real-time **
async function initRealtime() {
  const loader = document.getElementById("loader");
  const tabs = document.getElementById("tabsContainer");

  loader.classList.remove("hidden");
  tabs.classList.add("hidden");

  onValue(ref(db, `patients/emergency/${patientId}/transfers/${transferId}`), async (snapshot) => {
    if (!snapshot.exists()) {
      Swal.fire("خطأ", "لم يتم العثور على طلب الأشعة", "error");
      return;
    }
    const t = snapshot.val();
    const patientSnap = await get(ref(db, `patients/emergency/${patientId}`));
    const patient = patientSnap.exists() ? patientSnap.val() : {};

    loader.classList.add("hidden");
    tabs.classList.remove("hidden");

    // بيانات المريض
    document.getElementById("patientDetails").innerHTML = `
      <div class="bg-white p-4 rounded shadow mb-4">
        <h3 class="text-lg font-bold text-blue-800 mb-2">بيانات المريض</h3>
        <div><b>الاسم:</b> ${patient.name || "-"} | <b>العمر:</b> ${patient.age || "-"} | <b>القسم:</b> ${patient.department || "-"}</div>
        <div><b>الرقم القومي:</b> ${patient.nid || "-"}</div>
        <canvas id="qrCode" class="w-32 h-32 mt-4"></canvas>
      </div>
    `;

    // تفاصيل التحويل
    document.getElementById("transferDetails").innerHTML = `
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-lg font-bold text-blue-800 mb-2">بيانات التحويل</h3>
        <div><b>نوع الأشعة:</b> ${t.type || "-"} | <b>الجهاز:</b> ${t.device || "-"}</div>
        <div><b>ملاحظات:</b> ${t.notes || "-"}</div>
        <div><b>الحالة:</b> <span class="status-badge ${statusColor(t.status)}">${t.status || "قيد الانتظار"}</span></div>
        <div><b>تاريخ الطلب:</b> ${t.date || "-"}</div>
      </div>
    `;

    // Timeline
    document.getElementById("timelineSection").innerHTML = `
      <div class="bg-white p-4 rounded shadow mt-4">
        <h3 class="text-lg font-bold text-blue-800 mb-2">الخط الزمني</h3>
        <ul class="text-sm text-gray-600">
          <li>📅 طلب: ${t.date || "-"}</li>
          <li>✅ تنفيذ: ${t.executionDate || "-"}</li>
          <li>🖋 آخر تعديل: ${t.lastEditDate || "-"}</li>
        </ul>
      </div>
    `;

    QRCode.toCanvas(document.getElementById("qrCode"), patientId);

    renderReportTab(t);
    renderCommentsTab(t);
    renderRatingTab(t);
  });
}

// Tabs Switcher
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("tab-btn")) {
    document.querySelectorAll(".tab-content").forEach(tab => tab.classList.add("hidden"));
    document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("tab-active"));
    document.getElementById(e.target.dataset.tab).classList.remove("hidden");
    e.target.classList.add("tab-active");
  }
});

// ** باقي الدوال زي رفع ملفات، حفظ التقييم، PDF **
// نفس اللي في نسختك السابقة بدون تغيير

initRealtime();
</script>
</body>
</html>
