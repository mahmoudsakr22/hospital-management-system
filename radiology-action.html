<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø·Ù„Ø¨ Ø§Ù„Ø£Ø´Ø¹Ø© - Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: 'Tajawal', sans-serif; transition: background 0.3s, color 0.3s; }
.dark { background-color: #1a202c; color: #f7fafc; }
.dark .card { background-color: #2d3748; color: #e2e8f0; }
.loader {
  border: 4px solid #f3f3f3; border-top: 4px solid #2563eb;
  border-radius: 50%; width: 40px; height: 40px;
  animation: spin 1s linear infinite; margin: 60px auto;
}
@keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
.star { font-size: 1.5rem; cursor: pointer; color: gray; }
.star.active { color: gold; }
</style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-gray-100 min-h-screen">

<!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
<header class="flex justify-between items-center p-4 bg-white shadow dark:bg-gray-800">
  <div class="flex items-center gap-2">
    <i class="fas fa-x-ray text-2xl text-blue-700"></i>
    <h1 class="text-xl font-bold">ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨ Ø§Ù„Ø£Ø´Ø¹Ø©</h1>
  </div>
  <div class="flex gap-3">
    <button onclick="window.location.href='radiology.html'" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">Ø¹ÙˆØ¯Ø©</button>
    <button id="themeBtn" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300 dark:bg-gray-700">
      <i id="themeIcon" class="fas fa-moon text-gray-700"></i>
    </button>
  </div>
</header>

<!-- Ù„ÙˆØ¯Ø± -->
<div id="loader" class="loader"></div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
<main id="content" class="hidden max-w-5xl mx-auto p-4">

  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ -->
  <section class="grid md:grid-cols-2 gap-4 mb-6">
    <div id="patientCard" class="card bg-white p-4 rounded shadow"></div>
    <div id="transferCard" class="card bg-white p-4 rounded shadow"></div>
  </section>

  <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <nav class="flex border-b mb-4">
    <button class="tab-btn px-4 py-2" data-tab="reportTab">Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</button>
    <button class="tab-btn px-4 py-2" data-tab="commentsTab">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
    <button class="tab-btn px-4 py-2" data-tab="ratingTab">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
  </nav>

  <!-- ØªÙ‚Ø±ÙŠØ± -->
  <div id="reportTab" class="tab-content">
    <div id="reportSection" class="card bg-white p-4 rounded shadow"></div>
  </div>

  <!-- ØªØ¹Ù„ÙŠÙ‚Ø§Øª -->
  <div id="commentsTab" class="tab-content hidden">
    <div id="commentsSection" class="card bg-white p-4 rounded shadow"></div>
  </div>

  <!-- ØªÙ‚ÙŠÙŠÙ… -->
  <div id="ratingTab" class="tab-content hidden">
    <div id="ratingSection" class="card bg-white p-4 rounded shadow"></div>
  </div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyArPFi04c_vDP5Gi8bM4pem_LuvMx_eJG0",
  authDomain: "hospital-project-e4b59.firebaseapp.com",
  databaseURL: "https://hospital-project-e4b59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hospital-project-e4b59",
  storageBucket: "hospital-project-e4b59.appspot.com",
  messagingSenderId: "974610606258",
  appId: "1:974610606258:web:71ce7d5d447bca4b4441ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const patientId = new URLSearchParams(window.location.search).get("patient");
const transferId = new URLSearchParams(window.location.search).get("transfer");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
onValue(ref(db, `patients/emergency/${patientId}/transfers/${transferId}`), async (snap) => {
  if (!snap.exists()) {
    Swal.fire("Ø®Ø·Ø£", "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
    return;
  }
  const transfer = snap.val();
  const patientSnap = await get(ref(db, `patients/emergency/${patientId}`));
  const patient = patientSnap.exists() ? patientSnap.val() : {};

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø±
  document.getElementById("loader").classList.add("hidden");
  document.getElementById("content").classList.remove("hidden");

  // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
  document.getElementById("patientCard").innerHTML = `
    <h2 class="font-bold text-lg mb-2 text-blue-700">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
    <p><b>Ø§Ù„Ø§Ø³Ù…:</b> ${patient.name || "-"}</p>
    <p><b>Ø§Ù„Ø¹Ù…Ø±:</b> ${patient.age || "-"}</p>
    <p><b>Ø§Ù„Ù‚Ø³Ù…:</b> ${patient.department || "-"}</p>
    <p><b>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</b> ${patient.nid || "-"}</p>
    <canvas id="qrCanvas" class="mt-3"></canvas>
  `;
  QRCode.toCanvas(document.getElementById("qrCanvas"), patientId);

  // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„
  document.getElementById("transferCard").innerHTML = `
    <h2 class="font-bold text-lg mb-2 text-blue-700">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</h2>
    <p><b>Ù†ÙˆØ¹ Ø§Ù„Ø£Ø´Ø¹Ø©:</b> ${transfer.type || "-"}</p>
    <p><b>Ø§Ù„Ø¬Ù‡Ø§Ø²:</b> ${transfer.device || "-"}</p>
    <p><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${transfer.status || "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"}</p>
    <p><b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</b> ${transfer.date || "-"}</p>
  `;

  renderReportTab(transfer);
  renderCommentsTab(transfer);
  renderRatingTab(transfer);
});

// ØªØ¨ÙˆÙŠØ¨Ø§Øª
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-content").forEach(tab => tab.classList.add("hidden"));
    document.getElementById(btn.dataset.tab).classList.remove("hidden");
  });
});

// Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function renderReportTab(t) {
  const filesHtml = (t.files || []).map(f => `<a href="${f}" target="_blank"><img src="${f}" class="w-20 h-20 rounded border"></a>`).join("");
  document.getElementById("reportSection").innerHTML = `
    <label>Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</label>
    <textarea id="reportText" class="border rounded p-2 w-full mb-2">${t.report || ""}</textarea>
    <input type="file" id="fileInput" multiple class="mb-2">
    <button onclick="uploadFiles()" class="bg-gray-700 text-white px-3 py-1 rounded">Ø±ÙØ¹</button>
    <div class="flex gap-2 mt-2">${filesHtml}</div>
    <button onclick="saveReport()" class="bg-blue-700 text-white px-3 py-1 mt-3 rounded">Ø­ÙØ¸</button>
    <button onclick="downloadPDF()" class="bg-green-700 text-white px-3 py-1 mt-3 rounded">ØªØ­Ù…ÙŠÙ„ PDF</button>
  `;
}

// Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
function renderCommentsTab(t) {
  const comments = t.comments || [];
  document.getElementById("commentsSection").innerHTML = `
    <ul class="mb-2">
      ${comments.map(c => `<li>ğŸ—¨ï¸ ${c.text} <span class="text-xs text-gray-400">(${c.date})</span></li>`).join("")}
    </ul>
    <input type="text" id="commentInput" class="border rounded p-2 w-2/3" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚...">
    <button onclick="addComment()" class="bg-gray-700 text-white px-2 py-1 rounded">Ø¥Ø¶Ø§ÙØ©</button>
  `;
}

// Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
function renderRatingTab(t) {
  const stars = Array.from({length:5},(_,i)=>`<i class="fas fa-star star ${t.qualityRating>i?'active':''}" data-val="${i+1}"></i>`).join("");
  document.getElementById("ratingSection").innerHTML = `
    <h3 class="font-bold mb-2">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬ÙˆØ¯Ø©</h3>
    <div id="stars" class="flex gap-1 mb-2">${stars}</div>
    <textarea id="notes" class="border rounded p-2 w-full" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">${t.qualityNotes||''}</textarea>
    <button onclick="saveRating()" class="bg-blue-700 text-white px-3 py-1 mt-2 rounded">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
  `;
  document.querySelectorAll(".star").forEach(star=>{
    star.addEventListener("click",()=>{
      const val = parseInt(star.dataset.val);
      document.querySelectorAll(".star").forEach(s=>s.classList.remove("active"));
      for(let i=0;i<val;i++) document.querySelectorAll(".star")[i].classList.add("active");
      document.getElementById("stars").dataset.value=val;
    });
  });
}

// Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
window.uploadFiles = async function() {
  const files = document.getElementById("fileInput").files;
  const urls = [];
  for (const file of files) {
    const storageRef = sRef(storage, `radiology/${patientId}/${transferId}/${file.name}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    urls.push(url);
  }
  await update(ref(db, `patients/emergency/${patientId}/transfers/${transferId}`), { files: urls });
  Swal.fire("ØªÙ…", "ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª", "success");
}

// Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
window.saveReport = async function() {
  const report = document.getElementById("reportText").value;
  await update(ref(db, `patients/emergency/${patientId}/transfers/${transferId}`), { report });
  Swal.fire("ØªÙ…", "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", "success");
}

// Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
window.addComment = async function() {
  const input = document.getElementById("commentInput");
  const comment = input.value.trim();
  if(!comment) return;
  const snap = await get(ref(db, `patients/emergency/${patientId}/transfers/${transferId}`));
  const comments = snap.val().comments || [];
  comments.push({text:comment,date:new Date().toLocaleString('ar-EG')});
  await update(ref(db, `patients/emergency/${patientId}/transfers/${transferId}`), { comments });
  input.value="";
}

// Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
window.saveRating = async function() {
  const rating = parseInt(document.getElementById("stars").dataset.value||0);
  const notes = document.getElementById("notes").value;
  await update(ref(db, `patients/emergency/${patientId}/transfers/${transferId}`), {
    qualityRating:rating,
    qualityNotes:notes
  });
  Swal.fire("ØªÙ…", "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…", "success");
}

// PDF
window.downloadPDF = function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø´Ø¹Ø©",10,20);
  doc.text(`ID: ${patientId}`,10,30);
  doc.save(`Radiology_${patientId}.pdf`);
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
const themeBtn=document.getElementById("themeBtn");
const themeIcon=document.getElementById("themeIcon");
themeBtn.addEventListener("click",()=>{
  document.body.classList.toggle("dark");
  themeIcon.classList.toggle("fa-moon");
  themeIcon.classList.toggle("fa-sun");
});
</script>
</body>
</html>
